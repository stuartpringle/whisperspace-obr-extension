import{r as lt,b as Pe,s as fe,c as pt,F as kt,a as Ke,o as vt,l as Re,T as ot,d as jt,e as wt,f as Ct,g as St,h as ct,i as et,j as Ne,k as Ge,m as Ce,n as It,u as Mt,p as Dt,q as Tt,t as Be,v as _e,w as tt,x as we,y as at,z as At}from"./statusEffects-B3WZjcJ1.js";import{r as j,j as e,d as je,e as Rt}from"./vendor_react-XzhcIodj.js";import{O as F,i as Et}from"./vendor_obr-DQQhYa7f.js";import{S as U,B as z,T as D,a as ze,b as ae,c as y,d as ge,I as le,C as Se,R as Nt,A as Ie,e as Me,E as De,f as Te,g as ue,h as dt,i as pe,P as Pt,D as We,L as nt,j as zt,M as de,k as ut,l as Wt,m as Lt,n as Ft,o as Bt,p as _t,q as Ot,r as qt,s as Ut,t as $t,u as Ht,v as mt,w as Gt,x as Yt,y as Kt}from"./vendor_mui-C1cVQ6D4.js";import"./vendor_zod-CxP395f9.js";import"./vendor-CPvQcOsy.js";import"./vendor_emotion-pcfylbOS.js";async function Jt(){const t=await F.player.getSelection();return Array.isArray(t)?t:[]}async function Vt(){const t=await Jt();return t.length>0?t[0]:null}async function Oe(t){return(await F.scene.items.getItems([t])).length>0}function Qt(t){var o;const n=t.sheet,[x,f]=j.useState(0),S=j.useMemo(()=>n.attributes??{phys:0,ref:0,soc:0,ment:0},[n.attributes]);async function b(r,v){const B=Number(S[r]??0),$=Pe({netDice:x,modifier:B,label:v});await lt({diceNotation:$,showResults:!0,rollTarget:"everyone"})}return e.jsxs(U,{spacing:2,children:[e.jsxs(z,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",gap:2,flexWrap:"wrap"},children:[e.jsx(D,{variant:"h6",sx:{m:0},children:"Core"}),e.jsxs(z,{sx:{display:"flex",alignItems:"center",gap:1,flexWrap:"wrap"},children:[e.jsx(D,{variant:"subtitle2",sx:{opacity:.8},children:"Attribute Roll:"}),e.jsxs(ze,{size:"small",exclusive:!0,value:x,onChange:(r,v)=>{v!==null&&f(v)},children:[e.jsx(ae,{value:-2,children:"−2"}),e.jsx(ae,{value:-1,children:"−1"}),e.jsx(ae,{value:0,children:"0"}),e.jsx(ae,{value:1,children:"+1"}),e.jsx(ae,{value:2,children:"+2"})]})]})]}),e.jsx(y,{label:"Name",size:"small",value:n.name??"",onChange:r=>t.onChange({name:r.target.value}),fullWidth:!0}),e.jsxs(z,{sx:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:1},children:[e.jsx(Ee,{label:"PHYS",value:S.phys,onRoll:()=>b("phys","PHYS Check")}),e.jsx(Ee,{label:"REF",value:S.ref,onRoll:()=>b("ref","REF Check")}),e.jsx(Ee,{label:"SOC",value:S.soc,onRoll:()=>b("soc","SOC Check")}),e.jsx(Ee,{label:"MENT",value:S.ment,onRoll:()=>b("ment","MENT Check")})]}),e.jsxs(z,{sx:{display:"grid",gridTemplateColumns:"repeat(3, 1fr)",gap:2},children:[e.jsx(y,{label:"Cool Under Fire",size:"small",value:((o=t.sheet.stress)==null?void 0:o.cuf)??0,inputProps:{readOnly:!0},fullWidth:!0}),e.jsx(y,{label:"Speed",size:"small",value:30+(S.phys??0)*5,inputProps:{readOnly:!0},fullWidth:!0}),e.jsx(y,{label:"Carrying Capacity",size:"small",value:5+(S.phys??0)*5,inputProps:{readOnly:!0},fullWidth:!0})]}),e.jsx(D,{variant:"body2",sx:{opacity:.75},children:"Attributes are derived automatically from skill ranks (¼ of total ranks under each attribute, rounded up)."})]})}function Ee(t){return e.jsxs(z,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(y,{label:t.label,size:"small",value:t.value,inputProps:{readOnly:!0},fullWidth:!0}),e.jsx(ge,{title:"Roll with Dice+",children:e.jsx(le,{onClick:t.onRoll,"aria-label":`Roll ${t.label}`,children:e.jsx(Se,{})})})]})}function Je(){const t=new Map;return Object.keys(fe.learned).forEach(n=>{(fe.learned[n]??[]).forEach(x=>t.set(x.id,{focus:n}))}),t}function ht(t){var r,v;const n=String(t.skillId??""),x=((r=t.sheet.skills)==null?void 0:r[n])??0,f=((v=t.skillMods)==null?void 0:v[n])??0;if(x>0)return x+f;const S=t.sheet.learningFocus??"combat",b=t.learnedInfoById.get(n);return(b&&b.focus===S?0:-1)+f}const Xt=["phys","ref","soc","ment"],qe={phys:"PHYSIQUE",ref:"REFLEX",soc:"SOCIAL",ment:"MENTAL"},Ue={combat:"Combat",education:"Education",vehicles:"Vehicles"},st={combat:"Combat Focus",education:"Education Focus",vehicles:"Vehicles Focus"};function $e(t){const n=ft(t,0,5);return n*(n+1)/2}function Zt(t){const[n,x]=j.useState(""),[f,S]=j.useState(0),[b,o]=j.useState(!0),[r,v]=j.useState(!1),[B,$]=j.useState(""),p=t.sheet.skills??{},W=t.sheet.learningFocus??"combat",K=Number(t.sheet.skillPoints??0);j.useEffect(()=>{let i=!1;return(async()=>{const g=await pt();i||(o(g),v(!0))})().catch(()=>{i||(o(!1),v(!0))}),()=>{i=!0}},[]);const ne=j.useMemo(()=>Je(),[]);function se(i){const g=ne.get(i.id);return g?g.focus===W?5:2:5}function Y(i){var Q;const g=p[i.id]??0,_=((Q=t.skillMods)==null?void 0:Q[i.id])??0;if(g>0)return g+_;const H=ne.get(i.id);return H&&H.focus===W?0+_:-1+_}const u=j.useMemo(()=>{let i=0;for(const g of Object.values(p))i+=$e(g??0);return i},[p]),a=Math.max(0,K-u),s=i=>{const g=Math.max(0,Math.trunc(Number(B)));if(!g)return;const _=K+i*g,H=Math.max(u,_);t.onMetaChange({skillPoints:H}),$("")};function T(i){t.onChange(i)}function R(i,g){const _=p[i.id]??0,H=se(i),Q=ft(g,0,H);if(Q===_||$e(Q)-$e(_)>a)return;const xe={...p};Q===0?delete xe[i.id]:xe[i.id]=Q,T(xe)}async function A(i){const g=Pe({netDice:f,modifier:Y(i),label:i.label});try{await lt({diceNotation:g,showResults:!0,rollTarget:"everyone"})}catch(_){console.error("Dice+ roll request failed:",_)}}const h=j.useMemo(()=>{const i=Object.values(fe.learned).flat();return[...fe.inherent,...i]},[]),E=j.useMemo(()=>{const i=n.trim().toLowerCase();return i?h.filter(g=>g.label.toLowerCase().includes(i)||g.id.toLowerCase().includes(i)):h},[h,n]),V=j.useMemo(()=>ea(fe.inherent),[]),J=j.useMemo(()=>fe.learned,[]),ie=n.trim().length>0,te=e.jsxs(z,{sx:{display:"flex",alignItems:"center",gap:2,flexWrap:"wrap"},children:[e.jsx(D,{variant:"subtitle2",sx:{opacity:.8},children:"Learning Focus:"}),Object.keys(st).map(i=>e.jsxs(z,{sx:{display:"flex",alignItems:"center",gap:.5,cursor:"pointer"},onClick:()=>t.onMetaChange({learningFocus:i}),children:[e.jsx(Nt,{checked:W===i,value:i,size:"small"}),e.jsx(D,{variant:"body2",children:Ue[i]})]},i))]}),w=e.jsx(z,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",gap:2,flexWrap:"wrap"},children:e.jsxs(z,{sx:{display:"flex",alignItems:"center",gap:1,flexWrap:"wrap"},children:[e.jsxs(D,{variant:"subtitle2",sx:{minWidth:170},children:["Skill Points: ",a," ",e.jsxs("span",{style:{opacity:.75},children:["(Total: ",K,")"]})]}),e.jsx(ue,{size:"small",variant:"outlined",onClick:()=>s(1),disabled:!Number.isFinite(Number(B))||Math.trunc(Number(B))<=0,children:"+"}),e.jsx(y,{label:"SP",size:"small",type:"number",value:B,onChange:i=>$(i.target.value),sx:{width:110}}),e.jsx(ue,{size:"small",variant:"outlined",onClick:()=>s(-1),disabled:!Number.isFinite(Number(B))||Math.trunc(Number(B))<=0,children:"-"}),e.jsx(D,{variant:"subtitle2",sx:{opacity:.8},children:"Roll"}),e.jsxs(ze,{size:"small",exclusive:!0,value:f,onChange:(i,g)=>{g!==null&&S(g)},"aria-label":"Bonus / Penalty dice",children:[e.jsx(ae,{value:-2,children:"−2"}),e.jsx(ae,{value:-1,children:"−1"}),e.jsx(ae,{value:0,children:"0"}),e.jsx(ae,{value:1,children:"+1"}),e.jsx(ae,{value:2,children:"+2"})]}),r&&!b&&e.jsx(D,{variant:"caption",sx:{opacity:.8},children:"(Dice+ not detected)"})]})});return e.jsxs(U,{spacing:2,children:[te,e.jsx(y,{label:"Search skills",value:n,onChange:i=>x(i.target.value),placeholder:"stealth, weapons, navigation…",fullWidth:!0}),w,ie?e.jsx(U,{spacing:1,children:E.map(i=>{const g=ne.get(i.id),_=g?Ue[g.focus]:qe[i.attribute];return e.jsx(He,{skill:i,rank:p[i.id]??0,modifier:Y(i),maxRank:se(i),onRank:H=>R(i,H),rightTag:_,canRoll:b,onRoll:()=>A(i)},i.id)})}):e.jsxs(e.Fragment,{children:[e.jsx(D,{variant:"subtitle1",children:"Inherent Skills"}),Xt.map(i=>e.jsxs(Ie,{defaultExpanded:!0,children:[e.jsx(Me,{expandIcon:e.jsx(De,{}),children:e.jsx(D,{fontWeight:700,children:qe[i]})}),e.jsx(Te,{children:e.jsx(U,{spacing:1,children:(V[i]??[]).map(g=>e.jsx(He,{skill:g,rank:p[g.id]??0,modifier:Y(g),maxRank:se(g),onRank:_=>R(g,_),rightTag:qe[g.attribute],canRoll:b,onRoll:()=>A(g)},g.id))})})]},i)),e.jsx(D,{variant:"subtitle1",sx:{mt:1},children:"Learned Skills"}),Object.keys(J).map(i=>e.jsxs(Ie,{defaultExpanded:!0,children:[e.jsx(Me,{expandIcon:e.jsx(De,{}),children:e.jsx(D,{fontWeight:700,children:st[i]})}),e.jsx(Te,{children:e.jsx(U,{spacing:1,children:(J[i]??[]).map(g=>e.jsx(He,{skill:g,rank:p[g.id]??0,modifier:Y(g),maxRank:se(g),onRank:_=>R(g,_),rightTag:Ue[i],canRoll:b,onRoll:()=>A(g)},g.id))})})]},i))]})]})}function He(t){const n=t.rank<t.maxRank,x=t.rank>0;return e.jsxs(z,{sx:{display:"grid",gridTemplateColumns:"1fr auto auto auto",gap:1,alignItems:"center",border:"1px solid",borderColor:"divider",borderRadius:2,px:1.25,py:1},children:[e.jsxs(z,{sx:{minWidth:0},children:[e.jsx(D,{fontWeight:600,noWrap:!0,children:t.skill.label}),e.jsx(D,{variant:"caption",sx:{opacity:.7},noWrap:!0,children:t.rightTag??""})]}),e.jsxs(z,{sx:{width:46,textAlign:"center"},children:[e.jsx(D,{variant:"caption",sx:{opacity:.7,lineHeight:1},children:"Mod"}),e.jsx(D,{sx:{fontWeight:700,lineHeight:1.2},children:t.modifier>=0?`+${t.modifier}`:`${t.modifier}`})]}),e.jsxs(z,{sx:{width:40,textAlign:"center"},children:[e.jsx(D,{variant:"caption",sx:{opacity:.7,lineHeight:1},children:"Rank"}),e.jsx(D,{sx:{fontWeight:700,lineHeight:1.2},children:t.rank})]}),e.jsxs(z,{sx:{display:"flex",gap:.5,alignItems:"center",justifyContent:"flex-end"},children:[e.jsx(le,{size:"small",onClick:()=>t.onRank(t.rank-1),"aria-label":"Decrease rank",disabled:!x,children:e.jsx(dt,{fontSize:"small"})}),e.jsx(le,{size:"small",onClick:()=>t.onRank(t.rank+1),"aria-label":"Increase rank",disabled:!n,children:e.jsx(pe,{fontSize:"small"})}),e.jsx(z,{sx:{width:6}}),e.jsx(ge,{title:t.canRoll?"Roll with Dice+":"Dice+ not detected",children:e.jsx("span",{children:e.jsx(le,{size:"small",onClick:t.onRoll,"aria-label":`Roll ${t.skill.label}`,disabled:!t.canRoll,children:e.jsx(Se,{fontSize:"small"})})})})]})]})}function ea(t){return t.reduce((n,x)=>{var f;return(n[f=x.attribute]??(n[f]=[])).push(x),n},{})}function ft(t,n,x){const f=Number.isFinite(t)?Math.trunc(t):n;return Math.max(n,Math.min(x,f))}function ta(t){const n=t.sheet.feats??[];function x(){t.onChange([...n,{name:"New Feat",description:"",statusEffects:""}])}function f(b,o){const r=[...n];r[b]={...r[b],...o},kt.safeParse(r[b]),t.onChange(r)}function S(b){const o=[...n];o.splice(b,1),t.onChange(o)}return e.jsxs(U,{spacing:2,children:[e.jsxs(U,{direction:"row",justifyContent:"space-between",alignItems:"center",children:[e.jsx(D,{variant:"h6",children:"Feats"}),e.jsx(ue,{variant:"contained",startIcon:e.jsx(pe,{}),onClick:x,children:"Add Feat"})]}),n.length===0?e.jsx(D,{variant:"body2",sx:{opacity:.75},children:"No feats yet."}):e.jsx(U,{spacing:2,children:n.map((b,o)=>e.jsx(Pt,{sx:{p:2},children:e.jsxs(U,{spacing:1.5,children:[e.jsxs(U,{direction:"row",spacing:1,alignItems:"center",children:[e.jsx(y,{label:"Feat Name",fullWidth:!0,value:b.name,onChange:r=>f(o,{name:r.target.value})}),e.jsx(le,{"aria-label":"Remove feat",onClick:()=>S(o),children:e.jsx(We,{})})]}),e.jsx(y,{label:"Description",fullWidth:!0,multiline:!0,minRows:4,value:b.description,onChange:r=>f(o,{description:r.target.value})}),e.jsx(y,{label:"Status Effects",fullWidth:!0,helperText:'Comma-separated, e.g. "carrying_capacity+5"',value:b.statusEffects??"",onChange:r=>f(o,{statusEffects:r.target.value})})]})},`${b.name}-${o}`))})]})}const aa=[{id:"pistol",name:"Pistol",skillId:"weapons_light",useDC:7,damage:2,range:"Med",ammo:10,bulk:1,cost:500},{id:"smart_pistol",name:"SMART Pistol",skillId:"weapons_light",useDC:9,damage:4,range:"Med",ammo:6,bulk:1,keywords:["Smart-Linked"],cost:900},{id:"toxic_spike",name:"Toxic Spike",skillId:"weapons_light",useDC:10,damage:3,range:"Short",ammo:1,bulk:1,keywords:["Toxin (Prax)","Concealable"],cost:750},{id:"smg",name:"SMG",skillId:"weapons_medium",useDC:6,damage:3,range:"Med",ammo:8,bulk:2,keywords:["Bullet Spray"],cost:600},{id:"photon_rifle",name:"Photon Rifle",skillId:"weapons_medium",useDC:8,damage:6,range:"Long",ammo:6,bulk:3,keywords:["Two-Handed"],cost:5e3},{id:"rifle",name:"Rifle",skillId:"weapons_medium",useDC:8,damage:4,range:"Long",ammo:8,bulk:2,keywords:["Two-Handed","Piercing 1"],cost:1e3},{id:"shotgun",name:"Shotgun",skillId:"weapons_medium",useDC:8,damage:4,range:"Short",ammo:4,bulk:3,req:"PHYS 1",keywords:["Point Blank","Shredding 1"],cost:800},{id:"gauss_cannon",name:"Gauss Cannon",skillId:"weapons_heavy",useDC:7,damage:4,range:"Med",ammo:20,bulk:4,req:"PHYS 3",keywords:["Bullet Spray"],cost:900},{id:"grenade_launcher",name:"Grenade Launcher",skillId:"weapons_heavy",useDC:8,damage:3,range:"Med",ammo:1,bulk:3,req:"PHYS 2",keywords:["Area (near)","Two-Handed","Slow Load","Grenade"],cost:2e3},{id:"magneton_cannon",name:"Magneton Cannon",skillId:"weapons_exotic",useDC:5,damage:2,range:"Short",ammo:5,bulk:2,req:"PHYS 1",keywords:["Area (melee)","Slow Load","Shredding 3"],cost:8e3},{id:"tesla_rifle",name:"Tesla Rifle",skillId:"weapons_exotic",useDC:8,damage:5,range:"Med",ammo:6,bulk:2,keywords:["Two-Handed","Stun 2"],cost:6e3},{id:"stun_baton",name:"Stun Baton",skillId:"melee_weapons",useDC:6,damage:0,range:"Melee",bulk:1,keywords:["Stun 1"],cost:450},{id:"switchblade",name:"Switchblade",skillId:"melee_weapons",useDC:9,damage:2,range:"Melee",bulk:1,keywords:["Concealable","Thrown"],cost:150},{id:"fusion_blade",name:"Fusion Blade",skillId:"melee_weapons",useDC:8,damage:3,range:"Melee",bulk:2,req:"REF 2",keywords:["Piercing 2"],cost:1200},{id:"rocket_maul",name:"Rocket Maul",skillId:"melee_weapons",useDC:10,damage:6,range:"Melee",ammo:2,bulk:3,req:"PHYS 3",keywords:["Two-Handed"],cost:2500}],na={weapons:aa},rt=na.weapons??[],sa=[{id:"scrap_armour",name:"Scrap Armour",protection:1,durability:2,bulk:2,special:"Cannot be repaired",cost:500},{id:"flak_jacket",name:"Flak Jacket",protection:1,durability:4,bulk:1,cost:1250},{id:"kevlar_clothing",name:"Kevlar Clothing",protection:1,durability:3,bulk:1,special:"Appears to be normal clothing",cost:1500},{id:"streetweave_jacket",name:"Streetweave Jacket",protection:1,durability:5,bulk:1,special:"+1 to Stealth",cost:2500},{id:"milsec_bodyplate",name:"MilSec Bodyplate",protection:2,durability:6,bulk:2,cost:5e3},{id:"breaching_plate",name:"Breaching plate",protection:2,durability:4,bulk:3,req:"PHYS 2",special:"Frontal Shielding 1",cost:8500},{id:"heavy_bodyplate",name:"Heavy Bodyplate",protection:3,durability:8,bulk:4,req:"PHYS 3",special:"+1 penalty die to Stealth",cost:1e4},{id:"basic_power_armour",name:"Basic Power Armour",protection:4,durability:14,bulk:10,req:"Power Armour 1",special:`Requires Power Armour (DC5) check to activate. Failure: become Immobile; gain +1 penalty die to all PHYS and REF based checks. When activated, reduces its own bulk to 1 and grants +1 bonus die to all PHYS based checks.
`,cost:4e4}],ra={armor:sa},it=ra.armor??[],Ye="whisperspace.obr.sheet/combat-log";function ia(t){return t>=9?4:t>=7?3:t>=4?2:0}async function la(t){const n=Number.isFinite(t.useDC)?Math.trunc(t.useDC):Math.trunc(t.weapon.useDC),x=t.weapon.name||"Attack",f=Pe({netDice:t.netDice,modifier:t.modifier,label:x}),S=await Ke({diceNotation:f,rollTarget:t.rollTarget??"everyone",showResults:t.showResults??!0}),b=S-n,o=S>=n,r=o?ia(b):0,v=o&&r>0,B=Math.trunc(t.weapon.damage??0),$=o?B+r:0,p=v?1:0;let W;o?v?W=`Extreme success - crit! ${x} rolled ${S} vs DC ${n}. Damage: ${B}+${r}=${$}. (+1 Stress)`:W=`Hit. ${x} rolled ${S} vs DC ${n}. Damage: ${B}.`:W=`Miss. ${x} rolled ${S} vs DC ${n}.`,t.prefix&&(W=`${t.prefix} ${W}`);const K={text:W,ts:Date.now(),kind:"attack",attackerName:t.attackerName,weaponName:x,outcome:{total:S,useDC:n,hit:o,isCrit:v,baseDamage:B,totalDamage:$,stressDelta:p}};return F.broadcast.sendMessage(Ye,K,{destination:"ALL"}),{total:S,useDC:n,margin:b,hit:o,isCrit:v,critExtra:r,baseDamage:B,totalDamage:$,stressDelta:p,message:W}}const xt=la;function gt(t){var V,J;const n=Number.isFinite(t.incomingDamage)?Math.max(0,Math.trunc(t.incomingDamage)):0;if(n<=0&&!(t.stressDelta&&t.stressDelta>0))return{sheet:t.sheet,stressDelta:0};const x=!!t.unmitigated,f=t.sheet.armor,S=(((V=f==null?void 0:f.durability)==null?void 0:V.current)??0)<=0,b=x||S?0:(f==null?void 0:f.protection)??0,o=Math.max(0,n-b),r=t.sheet.wounds??{light:0,moderate:0,heavy:0};let v=r.light??0,B=r.moderate??0,$=r.heavy??0,p=o,W=0,K=0,ne=0;const Y=Math.min(p,Math.max(0,4-v));v+=Y,p-=Y,W=Y;const a=Math.min(p,Math.max(0,2-B));B+=a,p-=a,K=a;const T=Math.min(p,Math.max(0,1-$));$+=T,p-=T,ne=T;const R={light:v,moderate:B,heavy:$};let A=0;ne>0?A=4:K>0?A=2:W>0&&(A=1),t.stressDelta&&t.stressDelta>0&&(A+=Math.trunc(t.stressDelta));let h=f;!x&&!S&&o>0&&(f!=null&&f.durability)&&(h={...f,durability:{...f.durability,current:Math.max(0,Math.trunc((f.durability.current??0)-1))}});const E=Math.max(0,Math.trunc((((J=t.sheet.stress)==null?void 0:J.current)??0)+A));return{sheet:{...t.sheet,wounds:R,armor:h,stress:{...t.sheet.stress??{current:0,cuf:0,cufLoss:0},current:E}},stressDelta:A}}function be(t){var f;if(!t)return 0;const n=(f=t.keywordParams)==null?void 0:f.ammoMax,x=typeof n=="number"?n:typeof n=="string"?Number(n):void 0;return Number.isFinite(x)?Number(x):0}function oa(t){const n="#e55353",x="#8b5cf6",f="#5b6bff",S="#26a269",b="#d64040";return e.jsxs(z,{sx:{border:"1px solid",borderColor:"divider",borderRadius:2,p:1.25},children:[e.jsx(D,{variant:"subtitle2",sx:{opacity:.8,mb:.5},children:"Combat Log"}),t.entries.length===0?e.jsx(D,{variant:"body2",sx:{opacity:.7},children:"No recent rolls."}):e.jsx(U,{spacing:.75,children:t.entries.map(o=>{var Y,u,a,s,T;const r=!!((Y=o.outcome)!=null&&Y.hit)&&((((u=o.outcome)==null?void 0:u.totalDamage)??0)>0||(((a=o.outcome)==null?void 0:a.stressDelta)??0)>0)&&!!t.onApply,v=r&&(((s=o.outcome)==null?void 0:s.totalDamage)??0)>0,B=r&&(((T=o.outcome)==null?void 0:T.stressDelta)??0)>0,$=v&&B,p=o.outcome,W=p!=null&&p.hit?"Hit":"Miss",K=p!=null&&p.hit?S:b,ne=o.attackerName??"Unknown",se=o.weaponName??"Attack";return e.jsxs(z,{sx:{display:"flex",alignItems:"center",gap:1,flexWrap:"wrap"},children:[e.jsx(D,{variant:"body2",sx:{flex:"1 1 260px"},children:o.kind==="effect"?e.jsxs(e.Fragment,{children:[e.jsx("strong",{children:o.targetName??"Target"})," ",(o.damageApplied??0)>0&&e.jsxs(e.Fragment,{children:["took"," ",e.jsx("strong",{style:{color:n},children:o.damageApplied})," ","damage"]}),(o.damageApplied??0)>0&&(o.stressApplied??0)>0&&" and ",(o.damageApplied??0)<=0&&(o.stressApplied??0)>0&&"took ",(o.stressApplied??0)>0&&e.jsxs(e.Fragment,{children:[e.jsx("strong",{style:{color:x},children:o.stressApplied})," ","stress"]}),"."]}):e.jsxs(e.Fragment,{children:[e.jsx("strong",{children:ne}),": ",e.jsx("strong",{children:se})," rolled"," ",(p==null?void 0:p.total)??0," vs DC ",(p==null?void 0:p.useDC)??0,"."," ",p!=null&&p.isCrit?e.jsxs(e.Fragment,{children:[e.jsx("strong",{style:{color:S},children:"Extreme success - "}),e.jsx("strong",{style:{color:f},children:"crit!"})]}):e.jsx("strong",{style:{color:K},children:W}),(p==null?void 0:p.hit)&&e.jsxs(e.Fragment,{children:[". Damage:"," ",e.jsx("strong",{style:{color:n},children:(p==null?void 0:p.totalDamage)??0}),p!=null&&p.stressDelta?e.jsxs(e.Fragment,{children:[" "," (+"," ",e.jsx("strong",{style:{color:x},children:p.stressDelta})," ","Stress)"]}):null]}),"."]})}),v&&e.jsx(ue,{size:"small",variant:"outlined",startIcon:e.jsx(nt,{fontSize:"small"}),onClick:()=>{var R,A;return(A=t.onApply)==null?void 0:A.call(t,{...o,kind:"attack",damageApplied:((R=o.outcome)==null?void 0:R.totalDamage)??0,stressApplied:0})},children:"Apply Damage"}),B&&e.jsx(ue,{size:"small",variant:"outlined",startIcon:e.jsx(zt,{fontSize:"small"}),onClick:()=>{var R,A;return(A=t.onApply)==null?void 0:A.call(t,{...o,kind:"attack",damageApplied:0,stressApplied:((R=o.outcome)==null?void 0:R.stressDelta)??0})},children:"Apply Stress"}),$&&e.jsx(ue,{size:"small",variant:"outlined",startIcon:e.jsx(nt,{fontSize:"small"}),onClick:()=>{var R,A,h;return(h=t.onApply)==null?void 0:h.call(t,{...o,kind:"attack",damageApplied:((R=o.outcome)==null?void 0:R.totalDamage)??0,stressApplied:((A=o.outcome)==null?void 0:A.stressDelta)??0})},children:"Apply Both"})]},o.ts)})})]})}function ca(t){var te,w,i,g,_,H,Q,O,xe,ye,Le,Ae;const n=t.sheet,[x,f]=j.useState(0),[S,b]=j.useState(null),[o,r]=j.useState(""),[v,B]=j.useState(!1),$=(t.combatLog??[]).slice(-3).reverse(),p=j.useMemo(()=>Je(),[]),W=j.useMemo(()=>{const d=Object.values(fe.learned).flat();return[...fe.inherent,...d]},[]),K=new Set(["melee_weapons","melee_unarmed","weapons_light","weapons_medium","weapons_heavy","weapons_exotic","explosives"]),ne=W.filter(d=>K.has(d.id));j.useMemo(()=>[...W].sort((d,m)=>d.label.localeCompare(m.label)),[W]);function se(){var X;const d=Number(o),m=Number.isFinite(d)?Math.max(0,Math.trunc(d)):0;if(m<=0)return;const k=gt({sheet:t.sheet,incomingDamage:m,unmitigated:v});t.onChange({wounds:k.sheet.wounds,armor:k.sheet.armor,stress:k.sheet.stress}),k.stressDelta>0&&t.onApplyStress&&t.onApplyStress(((X=k.sheet.stress)==null?void 0:X.current)??0),r("")}function Y(d){return ht({learnedInfoById:p,sheet:n,skillId:d,skillMods:t.skillMods})}function u(d,m){const k=[...n.weapons??[]],X=k[d];if(m.ammo!==void 0&&!be(X)&&m.ammo>0){const Fe={...X.keywordParams??{},ammoMax:m.ammo};k[d]={...X,...m,keywordParams:Fe},t.onChange({weapons:k});return}k[d]={...X,...m},t.onChange({weapons:k})}function a(d,m){if(d===null||d===m)return;const k=t.sheet.weapons??[];if(d<0||d>=k.length||m<0||m>=k.length)return;const X=[...k],[ke]=X.splice(d,1);X.splice(m,0,ke),t.onChange({weapons:X}),b(m)}function s(d){const m=rt.find(X=>X.id===d);if(!m)return;const k=[...n.weapons??[]];k.push({name:m.name,skillId:m.skillId,useDC:m.useDC,damage:m.damage,range:m.range,ammo:m.ammo,bulk:m.bulk,req:m.req,cost:m.cost,keywords:[...m.keywords??[]],keywordParams:{ammoMax:m.ammo??0,...m.keywordParams??{}}}),t.onChange({weapons:k})}function T(){const d=[...n.weapons??[]];d.push({name:"New Weapon",skillId:"weapons_medium",useDC:8,damage:3,range:"Med",ammo:0,bulk:1,req:"",cost:0,keywords:[],keywordParams:{ammoMax:0}}),t.onChange({weapons:d})}function R(d){const m=[...n.weapons??[]];m.splice(d,1),t.onChange({weapons:m})}async function A(d,m){const k=be(m),X=Number.isFinite(m.ammo)?Number(m.ammo):0;if(k>0&&X<=0){F.notification.show("Out of ammo. Reload first.","WARNING");return}const ke=Y(m.skillId);await xt({weapon:m,useDC:Number.isFinite(m.useDC)?Number(m.useDC):0,netDice:x,modifier:ke,attackerName:t.sheet.name,rollTarget:"everyone",showResults:!0}),k>0&&u(d,{ammo:Math.max(0,X-1)})}const[h,E]=j.useState(""),[V,J]=j.useState("");function ie(d){const m=it.find(k=>k.id===d);m&&t.onChange({armor:{name:m.name,keywords:[...m.keywords??[]],keywordParams:{...m.keywordParams??{}},protection:m.protection,durability:{current:m.durability,max:m.durability},bulk:m.bulk,req:m.req,cost:m.cost,special:m.special}})}return e.jsxs(U,{spacing:2,children:[e.jsx(z,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",gap:2,flexWrap:"wrap"},children:e.jsx(D,{variant:"h6",sx:{m:0},children:"Combat"})}),e.jsxs(z,{sx:{display:"flex",alignItems:"center",gap:1,flexWrap:"wrap"},children:[e.jsx(D,{variant:"subtitle2",sx:{opacity:.8},children:"Take Damage:"}),e.jsx(y,{size:"small",type:"number",inputProps:{min:0},value:o,onChange:d=>r(d.target.value),sx:{width:90}}),e.jsx(ae,{size:"small",value:"unmitigated",selected:v,onChange:()=>B(d=>!d),children:"Unmitigated"}),e.jsx(ue,{size:"small",variant:"outlined",onClick:se,children:"Apply"})]}),e.jsxs(z,{sx:{display:"flex",alignItems:"center",gap:1,flexWrap:"wrap"},children:[e.jsx(D,{variant:"subtitle2",sx:{opacity:.8},children:"Attack Roll:"}),e.jsxs(ze,{size:"small",exclusive:!0,value:x,onChange:(d,m)=>{m!==null&&f(m)},children:[e.jsx(ae,{value:-2,children:"−2"}),e.jsx(ae,{value:-1,children:"−1"}),e.jsx(ae,{value:0,children:"0"}),e.jsx(ae,{value:1,children:"+1"}),e.jsx(ae,{value:2,children:"+2"})]})]}),e.jsx(oa,{entries:$,onApply:t.onApplyCombatLog}),e.jsxs(Ie,{defaultExpanded:!0,children:[e.jsx(Me,{expandIcon:e.jsx(De,{}),children:e.jsx(D,{fontWeight:700,children:"Weapons"})}),e.jsx(Te,{children:e.jsxs(U,{spacing:1.5,children:[e.jsxs(z,{sx:{display:"flex",gap:1,alignItems:"center",flexWrap:"wrap"},children:[e.jsxs(y,{label:"Add prefab weapon",size:"small",select:!0,value:h,onChange:d=>E(d.target.value),sx:{minWidth:240},children:[e.jsx(de,{value:"",children:"— choose —"}),rt.map(d=>e.jsx(de,{value:d.id,children:d.name},d.id))]}),e.jsx(le,{color:"primary",onClick:()=>s(h),"aria-label":"Add prefab weapon",disabled:!h,children:e.jsx(pe,{})}),e.jsx(z,{sx:{flex:1}}),e.jsx(le,{color:"primary",onClick:T,"aria-label":"Add custom weapon",children:e.jsx(pe,{})}),e.jsx(D,{variant:"body2",sx:{opacity:.75},children:"Add custom weapon"})]}),(n.weapons??[]).length===0?e.jsx(D,{sx:{opacity:.75},children:"No weapons yet."}):(n.weapons??[]).map((d,m)=>e.jsxs(z,{draggable:!0,onDragStart:()=>b(m),onDragEnd:()=>b(null),onDragOver:k=>{k.preventDefault()},onDrop:k=>{k.preventDefault(),a(S,m)},sx:{border:"1px solid",borderColor:"divider",borderRadius:2,p:1.25,cursor:"grab",opacity:S===m?.85:1,display:"grid",gap:1.25},children:[e.jsxs(z,{sx:{display:"flex",gap:1,alignItems:"center"},children:[e.jsx(y,{label:"Name",size:"small",value:d.name,onChange:k=>u(m,{name:k.target.value}),fullWidth:!0}),e.jsx(ge,{title:"Roll attack with Dice+",children:e.jsx(le,{onClick:()=>A(m,d),"aria-label":`Roll attack for ${d.name}`,children:e.jsx(Se,{})})}),e.jsx(le,{onClick:()=>R(m),"aria-label":"Remove weapon",children:e.jsx(We,{})})]}),e.jsxs(z,{sx:{display:"grid",gridTemplateColumns:"1fr 1fr 1fr 1fr",gap:1},children:[e.jsx(y,{label:"Skill",size:"small",select:!0,value:d.skillId,onChange:k=>u(m,{skillId:k.target.value}),children:ne.map(k=>e.jsx(de,{value:k.id,children:k.label},k.id))}),e.jsx(y,{label:"Use DC",size:"small",type:"number",value:d.useDC,onChange:k=>u(m,{useDC:Number(k.target.value)})}),e.jsx(y,{label:"Damage",size:"small",type:"number",value:d.damage,onChange:k=>u(m,{damage:Number(k.target.value)})}),e.jsx(y,{label:"Range",size:"small",value:d.range??"",onChange:k=>u(m,{range:k.target.value}),placeholder:"Melee / Short / Med / Long"}),e.jsxs(z,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(y,{label:"Ammo",size:"small",type:"number",value:d.ammo??0,onChange:k=>u(m,{ammo:Number(k.target.value)}),sx:{width:110}}),e.jsxs(D,{variant:"body2",sx:{opacity:.8},children:["/ ",be(d)||0]}),e.jsx(ge,{title:"Reload",children:e.jsx("span",{children:e.jsx(le,{size:"small",onClick:()=>u(m,{ammo:be(d)||0}),disabled:(be(d)||0)<=0,children:e.jsx(ut,{fontSize:"small"})})})})]}),e.jsx(y,{label:"Bulk",size:"small",type:"number",value:d.bulk??0,onChange:k=>u(m,{bulk:Number(k.target.value)})}),e.jsx(y,{label:"Req.",size:"small",value:d.req??"",onChange:k=>u(m,{req:k.target.value}),placeholder:"PHYS 1 / REF 2 / etc"}),e.jsx(y,{label:"Keywords (comma)",size:"small",value:(d.keywords??[]).join(", "),onChange:k=>u(m,{keywords:k.target.value.split(",").map(X=>X.trim()).filter(Boolean)}),placeholder:"Two-Handed, Piercing 1",sx:{gridColumn:"1 / -1"}})]})]},d.id??`${d.name}-${m}`))]})})]}),e.jsxs(Ie,{defaultExpanded:!0,children:[e.jsx(Me,{expandIcon:e.jsx(De,{}),children:e.jsx(D,{fontWeight:700,children:"Armor"})}),e.jsx(Te,{children:e.jsxs(U,{spacing:1.5,children:[e.jsxs(z,{sx:{display:"flex",gap:1,alignItems:"center",flexWrap:"wrap"},children:[e.jsxs(y,{label:"Set prefab armor",size:"small",select:!0,value:V,onChange:d=>J(d.target.value),sx:{minWidth:240},children:[e.jsx(de,{value:"",children:"— choose —"}),it.map(d=>e.jsx(de,{value:d.id,children:d.name},d.id))]}),e.jsx(le,{color:"primary",onClick:()=>ie(V),"aria-label":"Set prefab armor",disabled:!V,children:e.jsx(pe,{})})]}),e.jsxs(z,{sx:{border:"1px solid",borderColor:"divider",borderRadius:2,p:1.25},children:[e.jsxs(z,{sx:{display:"grid",gridTemplateColumns:"2fr 1fr 1fr 1fr",gap:1},children:[e.jsx(y,{label:"Name",size:"small",value:((te=n.armor)==null?void 0:te.name)??"",onChange:d=>t.onChange({armor:{...n.armor??{durability:{current:0,max:0},protection:0,keywords:[],keywordParams:{ammoMax:0}},name:d.target.value}})}),e.jsx(y,{label:"Protection",size:"small",type:"number",value:((w=n.armor)==null?void 0:w.protection)??0,onChange:d=>t.onChange({armor:{...n.armor??{name:"",durability:{current:0,max:0},keywords:[],keywordParams:{}},protection:Number(d.target.value)}})}),e.jsx(y,{label:"Durability (cur)",size:"small",type:"number",value:((i=n.armor)==null?void 0:i.durability.current)??0,onChange:d=>{var m;return t.onChange({armor:{...n.armor??{name:"",durability:{current:0,max:0},protection:0,keywords:[],keywordParams:{}},durability:{...((m=n.armor)==null?void 0:m.durability)??{current:0,max:0},current:Number(d.target.value)}}})}}),e.jsx(y,{label:"Durability (max)",size:"small",type:"number",value:((g=n.armor)==null?void 0:g.durability.max)??0,onChange:d=>{var m;return t.onChange({armor:{...n.armor??{name:"",durability:{current:0,max:0},protection:0,keywords:[],keywordParams:{}},durability:{...((m=n.armor)==null?void 0:m.durability)??{current:0,max:0},max:Number(d.target.value)}}})}})]}),(((H=(_=n.armor)==null?void 0:_.durability)==null?void 0:H.max)??0)>0&&(((O=(Q=n.armor)==null?void 0:Q.durability)==null?void 0:O.current)??0)<=0&&e.jsx(D,{sx:{mt:1},color:"error",variant:"body2",children:"Broken: armor provides no Protection until repaired."}),e.jsxs(z,{sx:{display:"grid",gridTemplateColumns:"1fr 1fr 1fr 2fr",gap:1,mt:1},children:[e.jsx(y,{label:"Bulk",size:"small",type:"number",value:((xe=n.armor)==null?void 0:xe.bulk)??0,onChange:d=>t.onChange({armor:{...n.armor??{name:"",durability:{current:0,max:0},protection:0,keywords:[],keywordParams:{}},bulk:Number(d.target.value)}})}),e.jsx(y,{label:"Req.",size:"small",value:((ye=n.armor)==null?void 0:ye.req)??"",onChange:d=>t.onChange({armor:{...n.armor??{name:"",durability:{current:0,max:0},protection:0,keywords:[],keywordParams:{}},req:d.target.value}})}),e.jsx(y,{label:"Special",size:"small",value:((Le=n.armor)==null?void 0:Le.special)??"",onChange:d=>t.onChange({armor:{...n.armor??{name:"",durability:{current:0,max:0},protection:0,keywords:[],keywordParams:{}},special:d.target.value}})})]}),e.jsx(z,{sx:{mt:1},children:e.jsx(y,{label:"Keywords (comma)",size:"small",fullWidth:!0,value:(((Ae=n.armor)==null?void 0:Ae.keywords)??[]).join(", "),onChange:d=>t.onChange({armor:{...n.armor??{name:"",durability:{current:0,max:0},protection:0,keywords:[],keywordParams:{}},keywords:d.target.value.split(",").map(m=>m.trim()).filter(Boolean)}}),placeholder:"Frontal Shielding 1"})})]})]})})]})]})}const da=[{name:"Flashbang Grenade",effect:"Applies Stun 1 to everyone within near range, Thrown",uses:"1 use",bulk:1,cost:200},{name:"Frag Grenade",effect:"Deals 2 area (near range) damage (DC8 to Evade half), Thrown",uses:"1 use",bulk:1,cost:250},{name:"EMP Grenade",effect:"Applies EMP 2 to everything within range, Thrown",uses:"1 use",bulk:1,cost:300},{name:"Combat Stim Injector",effect:"Gain +1 action & -1 Stress; take 1 wound after effect ends",uses:"1 use",bulk:1,cost:200},{name:"Basic Medkit",effect:"Right tool for the job: First Aid checks",uses:"3 uses",bulk:1,cost:350},{name:"Multitool",effect:"Allows engineering checks to repair, bypass, scrap, etc.",uses:"Permanent",bulk:1,cost:750},{name:"Repair Kit",effect:"Provides materials and tools for repairs",uses:"10 uses",bulk:1,cost:500},{name:"Tracker",effect:"While within 10km, always know location of this device",uses:"1 use",bulk:1,cost:250},{name:"Portable Scanner",effect:"Right tool for the job: Observe (tech, lifeforms)",uses:"Permanent",bulk:1,cost:400},{name:"Weapon Scope",effect:"Simple Modification. Grants +1 bonus die to called shots at medium range and farther; inflicts +1 penalty die to attacks at close range or nearer",uses:"Permanent",bulk:1,cost:750},{name:"Weapon Silencer",effect:"Simple Modification. Weapon makes reduced sound when fired; deals -1 damage",uses:"Permanent",bulk:1,cost:500},{name:"Compact Backpack",effect:"+5 Inventory Slots when worn",uses:"Permanent",bulk:0,cost:150,statusEffects:"carrying_capacity+5"},{name:"Ammo (Flechette)",effect:"Deals +2 damage to unarmoured targets.",uses:"10 rounds",bulk:1,cost:500},{name:"Ammo (SMART)",effect:"Required for Smart-Linked weapons.",uses:"10",bulk:1,cost:1250},{name:"Ammo (Armour Piercing)",effect:"Adds Piercing 1 to attacks.",uses:"10",bulk:1,cost:750},{name:"Ammo (Explosive)",effect:"Adds Shredding 1 to attacks.",uses:"10",bulk:1,cost:750}],ua={items:da},ma=ua.items,ha=[{name:"Reflex Booster",tier:1,effect:"Once per round, gain +1 bonus die to an Evade check.",installationDifficulty:2,requirements:"REF 1",physicalImpact:"Low; spine",bulk:1,cost:3e3},{name:"Targeting Link",tier:1,effect:"Once per round, ignore 1 level of cover when attacking an enemy you can see.",installationDifficulty:2,requirements:"-",physicalImpact:"Medium; eyes",bulk:1,cost:4e3},{name:"Low-Light Optics",tier:1,effect:"Ignore penalty dice caused by darkness within medium range.",installationDifficulty:1,requirements:"-",physicalImpact:"Medium; eyes",bulk:1,cost:2e3},{name:"EMP Shielding",tier:1,effect:"Ignore the effects of EMP once per day.",installationDifficulty:2,requirements:"MENT 1",physicalImpact:"None; torso",bulk:1,cost:3500},{name:"Metabolic Filter",tier:1,effect:"Gain +1 bonus die on checks to resist toxins or narcotics.",installationDifficulty:1,requirements:"PHYS 1",physicalImpact:"Minor; liver",bulk:1,cost:1500},{name:"Compact Databank",tier:2,effect:"Internal information storage device; store/access info at will.",installationDifficulty:2,requirements:"MENT 1",physicalImpact:"Medium; cranium",bulk:1,cost:5e3}],fa={cyberware:ha},xa=fa.cyberware,ga=[{name:"Space Dust",effect:"Grants +1 bonus die to Observe and Piloting checks for 6 hours",uses:5,addictionScore:1,legality:"Legal",bulk:1,cost:500},{name:"Tranquility",effect:"Reduces stress by 1; penalty die to all REF checks for 6 hours.",uses:2,addictionScore:5,legality:"Legal",bulk:1,cost:5e3},{name:"Smoothe",effect:"Reduces stress by 1d4; increases Cool Under Fire by 2 and grants +1 bonus die to all Mental skill checks for 1 hour",uses:1,addictionScore:8,legality:"Illegal",bulk:1,cost:2e4},{name:"Chemical Strength",effect:"+1 bonus die to all PHYS checks for 1 hour; +1 movement bonus for 1 hour. After 1 hour, +1 penalty die to all PHYS checks and +1 movement penalty until sleep.",uses:1,addictionScore:3,legality:"Illegal",bulk:1,cost:8e3}],ya={narcotics:ga},ba=ya.narcotics;function pa(){return`inv_${Date.now()}_${Math.random().toString(36).slice(2,9)}`}function ka(t){const n=t.sheet.inventory??[],x=a=>{t.onChange({inventory:a})},[f,S]=j.useState("item"),[b,o]=j.useState(null),[r,v]=j.useState({}),[B,$]=j.useState(null),[p,W]=j.useState(null),K=j.useMemo(()=>f==="item"?ma.map(a=>({type:"item",...a})):f==="cyberware"?xa.map(a=>({type:"cyberware",...a})):ba.map(a=>({type:"narcotics",...a})),[f]);function ne(a){o(a);const s=K.find(T=>T.name===a);if(!s){v({type:f,name:"",quantity:1,bulk:f==="item"?0:1,effect:"",cost:0,statusEffects:""});return}v(f==="item"?{type:"item",name:s.name,quantity:1,uses:s.uses??"",bulk:s.bulk??0,effect:s.effect??"",cost:s.cost??0,statusEffects:s.statusEffects??""}:f==="cyberware"?{type:"cyberware",name:s.name,quantity:1,bulk:s.bulk??1,tier:s.tier??1,installationDifficulty:s.installationDifficulty??0,requirements:s.requirements??"",physicalImpact:s.physicalImpact??"",effect:s.effect??"",cost:s.cost??0,statusEffects:s.statusEffects??""}:{type:"narcotics",name:s.name,quantity:1,bulk:s.bulk??1,uses:s.uses??1,addictionScore:s.addictionScore??0,legality:s.legality??"",effect:s.effect??"",cost:s.cost??0,statusEffects:s.statusEffects??""})}function se(){const a=[...n,{id:pa(),...r}];t.onChange({inventory:a}),o(null),v({type:f,name:"",quantity:1,bulk:f==="item"?0:1,effect:"",cost:0,statusEffects:""})}function Y(a){t.onChange({inventory:n.filter(s=>s.id!==a)})}function u(a,s){t.onChange({inventory:n.map(T=>T.id===a?{...T,...s}:T)})}return e.jsxs(U,{spacing:2,children:[e.jsx(y,{label:"Credits",type:"number",value:t.sheet.credits??0,onChange:a=>t.onChange({credits:Number(a.target.value)}),size:"small"}),e.jsxs(z,{children:[e.jsx(D,{variant:"subtitle2",sx:{mb:1},children:"Add Inventory"}),e.jsxs(U,{direction:{xs:"column",sm:"row"},spacing:1,alignItems:"center",children:[e.jsxs(y,{select:!0,size:"small",label:"Type",value:f,onChange:a=>{const s=a.target.value;S(s),o(null),v(s==="item"?{type:s,name:"",quantity:1,bulk:0,uses:"",effect:"",cost:0,statusEffects:""}:s==="cyberware"?{type:s,name:"",quantity:1,bulk:1,tier:1,installationDifficulty:0,requirements:"",physicalImpact:"",effect:"",cost:0,statusEffects:""}:{type:s,name:"",quantity:1,bulk:1,uses:1,addictionScore:0,legality:"",effect:"",cost:0,statusEffects:""})},sx:{minWidth:160},children:[e.jsx(de,{value:"item",children:"Item"}),e.jsx(de,{value:"cyberware",children:"Cyberware"}),e.jsx(de,{value:"narcotics",children:"Narcotics"})]}),e.jsx(Wt,{size:"small",sx:{flex:1,minWidth:220},options:K.map(a=>a.name),value:b,onChange:(a,s)=>ne(s),renderInput:a=>e.jsx(y,{...a,label:"Template (optional)"})}),e.jsx(ue,{variant:"contained",startIcon:e.jsx(pe,{}),onClick:se,disabled:!(r!=null&&r.name),children:"Add"})]}),e.jsx(z,{sx:{mt:1},children:e.jsxs(U,{spacing:1,children:[e.jsxs(U,{direction:{xs:"column",sm:"row"},spacing:1,children:[e.jsx(y,{size:"small",label:"Name",value:(r==null?void 0:r.name)??"",onChange:a=>v(s=>({...s,name:a.target.value})),sx:{flex:1}}),e.jsx(y,{size:"small",type:"number",label:"Bulk",value:(r==null?void 0:r.bulk)??0,onChange:a=>v(s=>({...s,bulk:Number(a.target.value)})),sx:{width:120}}),e.jsx(y,{size:"small",type:"number",label:"Quantity",value:(r==null?void 0:r.quantity)??1,onChange:a=>{const s=Number(a.target.value);Number.isFinite(s)&&v(T=>({...T,quantity:s}))},sx:{width:120}}),e.jsx(y,{size:"small",type:"number",label:"Cost",value:(r==null?void 0:r.cost)??0,onChange:a=>v(s=>({...s,cost:Number(a.target.value)})),sx:{width:140}})]}),f==="item"&&e.jsx(y,{size:"small",label:"Uses",value:(r==null?void 0:r.uses)??"",onChange:a=>v(s=>({...s,uses:a.target.value}))}),f==="cyberware"&&e.jsxs(U,{direction:{xs:"column",sm:"row"},spacing:1,children:[e.jsx(y,{size:"small",type:"number",label:"Tier",value:(r==null?void 0:r.tier)??1,onChange:a=>v(s=>({...s,tier:Number(a.target.value)})),sx:{width:120}}),e.jsx(y,{size:"small",type:"number",label:"Installation Difficulty",value:(r==null?void 0:r.installationDifficulty)??0,onChange:a=>v(s=>({...s,installationDifficulty:Number(a.target.value)})),sx:{width:220}}),e.jsx(y,{size:"small",label:"Requirements",value:(r==null?void 0:r.requirements)??"",onChange:a=>v(s=>({...s,requirements:a.target.value})),sx:{flex:1}})]}),f==="cyberware"&&e.jsx(y,{size:"small",label:"Physical Impact",value:(r==null?void 0:r.physicalImpact)??"",onChange:a=>v(s=>({...s,physicalImpact:a.target.value}))}),f==="narcotics"&&e.jsxs(U,{direction:{xs:"column",sm:"row"},spacing:1,children:[e.jsx(y,{size:"small",type:"number",label:"Uses",value:(r==null?void 0:r.uses)??1,onChange:a=>v(s=>({...s,uses:Number(a.target.value)})),sx:{width:120}}),e.jsx(y,{size:"small",type:"number",label:"Addiction Score",value:(r==null?void 0:r.addictionScore)??0,onChange:a=>v(s=>({...s,addictionScore:Number(a.target.value)})),sx:{width:160}}),e.jsx(y,{size:"small",label:"Legality",value:(r==null?void 0:r.legality)??"",onChange:a=>v(s=>({...s,legality:a.target.value})),sx:{flex:1}})]}),e.jsx(y,{size:"small",label:"Effect",value:(r==null?void 0:r.effect)??"",onChange:a=>v(s=>({...s,effect:a.target.value})),multiline:!0,minRows:2}),e.jsx(y,{size:"small",label:"Status Effects (comma-separated)",value:(r==null?void 0:r.statusEffects)??"",onChange:a=>v(s=>({...s,statusEffects:a.target.value})),placeholder:'e.g. "carrying_capacity+5"'})]})})]}),e.jsxs(z,{children:[e.jsx(D,{variant:"subtitle2",sx:{mb:1},children:"Inventory"}),n.length===0&&e.jsx(D,{variant:"body2",children:"No inventory items yet."}),n.map(a=>{const s=a.quantity??1,R=(a.bulk??0)*s,A=`${a.name} (${a.type}) • bulk ${R}`;return e.jsxs(Ie,{disableGutters:!0,children:[e.jsx(Me,{expandIcon:e.jsx(De,{}),draggable:!0,onDragStart:h=>{$(a.id??null);try{h.dataTransfer.effectAllowed="move",h.dataTransfer.setData("text/plain",a.id??"")}catch{}},onDragOver:h=>{h.preventDefault(),W(a.id??null)},onDragLeave:()=>W(null),onDrop:h=>{h.preventDefault();const E=B??h.dataTransfer.getData("text/plain"),V=a.id;if(E&&V&&E!==V){const J=t.sheet.inventory??[],ie=J.findIndex(w=>w.id===E),te=J.findIndex(w=>w.id===V);if(ie>=0&&te>=0){const w=[...J],[i]=w.splice(ie,1);w.splice(te,0,i),x(w)}}$(null),W(null)},sx:p===a.id?{outline:"2px dashed rgba(255,255,255,0.35)",borderRadius:1}:void 0,children:e.jsxs(U,{direction:"row",spacing:1,alignItems:"center",sx:{width:"100%"},children:[e.jsx(Lt,{fontSize:"small",sx:{opacity:.5}}),e.jsx(D,{variant:"body2",sx:{flex:1},children:A}),e.jsxs(U,{direction:"row",spacing:.5,alignItems:"center",children:[e.jsx(le,{size:"small",onClick:h=>{h.stopPropagation();const E=(a.quantity??1)-1;E<=0?Y(a.id):u(a.id,{quantity:E})},children:e.jsx(dt,{fontSize:"small"})}),e.jsx(D,{variant:"caption",sx:{minWidth:18,textAlign:"center"},children:a.quantity??1}),e.jsx(le,{size:"small",onClick:h=>{h.stopPropagation(),u(a.id,{quantity:(a.quantity??1)+1})},children:e.jsx(pe,{fontSize:"small"})})]}),e.jsx(ge,{title:"Remove",children:e.jsx(le,{size:"small",onClick:h=>(h.stopPropagation(),Y(a.id)),children:e.jsx(We,{fontSize:"small"})})})]})}),e.jsx(Te,{children:e.jsxs(U,{spacing:1,children:[e.jsxs(U,{direction:{xs:"column",sm:"row"},spacing:1,children:[e.jsx(y,{size:"small",label:"Name",value:a.name??"",onChange:h=>u(a.id,{name:h.target.value}),sx:{flex:1}}),e.jsxs(y,{select:!0,size:"small",label:"Type",value:a.type,onChange:h=>u(a.id,{type:h.target.value}),sx:{width:160},children:[e.jsx(de,{value:"item",children:"Item"}),e.jsx(de,{value:"cyberware",children:"Cyberware"}),e.jsx(de,{value:"narcotics",children:"Narcotics"})]}),e.jsx(y,{size:"small",type:"number",label:"Bulk",value:a.bulk??0,onChange:h=>u(a.id,{bulk:Number(h.target.value)}),sx:{width:120}}),e.jsx(y,{size:"small",type:"number",label:"Quantity",value:a.quantity??1,onChange:h=>{const E=Number(h.target.value);Number.isFinite(E)&&(E<=0?Y(a.id):u(a.id,{quantity:E}))},sx:{width:120}}),e.jsx(y,{size:"small",type:"number",label:"Cost",value:a.cost??0,onChange:h=>u(a.id,{cost:Number(h.target.value)}),sx:{width:140}})]}),a.type==="item"&&e.jsx(y,{size:"small",label:"Uses",value:a.uses??"",onChange:h=>u(a.id,{uses:h.target.value})}),a.type==="cyberware"&&e.jsxs(U,{direction:{xs:"column",sm:"row"},spacing:1,children:[e.jsx(y,{size:"small",type:"number",label:"Tier",value:a.tier??1,onChange:h=>u(a.id,{tier:Number(h.target.value)}),sx:{width:120}}),e.jsx(y,{size:"small",type:"number",label:"Installation Difficulty",value:a.installationDifficulty??0,onChange:h=>u(a.id,{installationDifficulty:Number(h.target.value)}),sx:{width:220}}),e.jsx(y,{size:"small",label:"Requirements",value:a.requirements??"",onChange:h=>u(a.id,{requirements:h.target.value}),sx:{flex:1}})]}),a.type==="cyberware"&&e.jsx(y,{size:"small",label:"Physical Impact",value:a.physicalImpact??"",onChange:h=>u(a.id,{physicalImpact:h.target.value})}),a.type==="narcotics"&&e.jsxs(U,{direction:{xs:"column",sm:"row"},spacing:1,children:[e.jsx(y,{size:"small",type:"number",label:"Uses",value:a.uses??1,onChange:h=>u(a.id,{uses:Number(h.target.value)}),sx:{width:120}}),e.jsx(y,{size:"small",type:"number",label:"Addiction Score",value:a.addictionScore??0,onChange:h=>u(a.id,{addictionScore:Number(h.target.value)}),sx:{width:160}}),e.jsx(y,{size:"small",label:"Legality",value:a.legality??"",onChange:h=>u(a.id,{legality:h.target.value}),sx:{flex:1}})]}),e.jsx(y,{size:"small",label:"Effect",value:a.effect??"",onChange:h=>u(a.id,{effect:h.target.value}),multiline:!0,minRows:2}),e.jsx(y,{size:"small",label:"Status Effects (comma-separated)",value:a.statusEffects??"",onChange:h=>u(a.id,{statusEffects:h.target.value}),placeholder:'e.g. "carrying_capacity+5"'})]})})]},a.id)})]})]})}function va(){const[t,n]=j.useState({entries:[],activeTokenId:void 0,updatedAt:Date.now()}),[x,f]=j.useState({}),[S,b]=j.useState(""),[o,r]=j.useState(!1),[v,B]=j.useState(0),$=u=>Math.max(-3,Math.min(3,u)),p=j.useMemo(()=>Je(),[]);j.useEffect(()=>{const u=vt(a=>n(a));return()=>u==null?void 0:u()},[]),j.useEffect(()=>{let u=!0;return(async()=>{var a,s,T,R;try{const[A,h]=await Promise.all([((s=(a=F.player).getId)==null?void 0:s.call(a))??Promise.resolve(""),((R=(T=F.player).getRole)==null?void 0:R.call(T))??Promise.resolve("")]);if(!u)return;b(String(A??"")),r(String(h).toUpperCase()==="GM")}catch{}})(),()=>{u=!1}},[]);const W=j.useMemo(()=>{const u=[...t.entries??[]];return u.sort((a,s)=>(s.initiative??0)-(a.initiative??0)),u},[t.entries]);j.useEffect(()=>{let u=!0;return(async()=>{var a,s,T,R,A,h,E;try{const V=W.map(te=>te.tokenId);if(!V.length){u&&f({});return}const J=await F.scene.items.getItems(V),ie={};for(const te of J){const w=te.id,i=await Re(w),g=i==null?void 0:i.armor,_=((a=g==null?void 0:g.durability)==null?void 0:a.current)??0,H=!!g&&_<=0,Q=H?0:(g==null?void 0:g.protection)??0,O=(s=i==null?void 0:i.weapons)==null?void 0:s[0],xe=be(O),ye=Number.isFinite(O==null?void 0:O.ammo)?Number(O==null?void 0:O.ammo):0;ie[w]={tokenId:w,name:((A=(R=(T=te.text)==null?void 0:T.plainText)==null?void 0:R.trim)==null?void 0:A.call(R))||(i==null?void 0:i.name)||"(Unnamed)",thumbUrl:(h=te.image)==null?void 0:h.url,ownerPlayerId:String(((E=te.metadata)==null?void 0:E[ot])??""),prot:Q,armorBroken:H,topWeaponName:O==null?void 0:O.name,topWeaponUseDC:O==null?void 0:O.useDC,topWeaponDamage:O==null?void 0:O.damage,topWeaponSkillId:O==null?void 0:O.skillId,topWeaponAmmo:ye,topWeaponAmmoMax:xe}}u&&f(ie)}catch{}})(),()=>{u=!1}},[W]);async function K(u){var i,g,_,H,Q;const[a]=await F.scene.items.getItems([u]);if(!a)return;const s=await Re(u);if(!s)return;const T=et([...(s.feats??[]).map(O=>O.statusEffects??"").filter(Boolean),...(s.inventory??[]).map(O=>O.statusEffects??"").filter(Boolean)]).deltas,R=Ce(s.skills??{}),A=((i=s.stress)==null?void 0:i.current)??0,h=Math.max(0,(Ne(s.skills??{})||0)-(((g=s.stress)==null?void 0:g.cufLoss)??0)),E=It({attributes:R,stress:{current:A,cuf:h}},T),V=E.stress.cuf??h,J=E.attributes.ref??R.ref??0,ie=A>V,te=Pe({netDice:ie?-1:0,modifier:J,label:`${((_=a.text)==null?void 0:_.plainText)??s.name??"Token"} Initiative`}),w=await Ke({diceNotation:te,rollTarget:"everyone",showResults:!0});await Mt({tokenId:u,initiative:w,name:((H=a.text)==null?void 0:H.plainText)??s.name??"Token",thumbUrl:(Q=a.image)==null?void 0:Q.url})}async function ne(){var R,A;const u=await((A=(R=F.player).getSelection)==null?void 0:A.call(R))??[],a=u==null?void 0:u[0],s=await ct()??void 0,T=a||s;if(!T){F.notification.show("Select a token (or set your character) to roll initiative.","WARNING");return}await K(T)}async function se(u){var i,g,_;const a=await Re(u);if(!a)return;const s=(i=a.weapons)==null?void 0:i[0];if(!s){F.notification.show("No weapon in the top slot.","WARNING");return}const T=et([...(a.feats??[]).map(H=>H.statusEffects??"").filter(Boolean),...(a.inventory??[]).map(H=>H.statusEffects??"").filter(Boolean)]).deltas,A=(Ne(a.skills??{})-(((g=a.stress)==null?void 0:g.cufLoss)??0)||0)+(T.cool_under_fire??0),E=(((_=a.stress)==null?void 0:_.current)??0)>A,V=String(s.skillId??""),J=ht({learnedInfoById:p,sheet:a,skillId:V,skillMods:T}),ie=be(s),te=Number.isFinite(s==null?void 0:s.ammo)?Number(s==null?void 0:s.ammo):0;if(ie>0&&te<=0){F.notification.show("Out of ammo. Reload first.","WARNING");return}const w=$(v-(E?1:0));if(await xt({weapon:s,netDice:w,modifier:J,attackerName:a.name,rollTarget:"everyone",showResults:!0}),ie>0){const H=Math.max(0,te-1),Q=[...a.weapons??[]];Q[0]={...Q[0],ammo:H},await Ge(u,{...a,weapons:Q})}}async function Y(u){var A;const a=await Re(u);if(!a)return;const s=(A=a.weapons)==null?void 0:A[0];if(!s)return;const T=be(s);if(T<=0)return;const R=[...a.weapons??[]];R[0]={...R[0],ammo:T},await Ge(u,{...a,weapons:R})}return e.jsxs(U,{spacing:2,children:[e.jsxs(z,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",gap:1,flexWrap:"wrap"},children:[e.jsx(D,{variant:"h6",sx:{m:0},children:"Initiative"}),e.jsxs(U,{direction:"row",spacing:1,alignItems:"center",children:[e.jsx(ue,{size:"small",variant:"contained",onClick:()=>void ne(),startIcon:e.jsx(Se,{}),children:"Roll Initiative"}),e.jsxs(z,{sx:{display:"flex",alignItems:"center",gap:1,flexWrap:"wrap",pl:1},children:[e.jsx(D,{variant:"body2",sx:{opacity:.8},children:"Attack Roll:"}),e.jsxs(ze,{size:"small",exclusive:!0,value:v,onChange:(u,a)=>{a!==null&&B(a)},children:[e.jsx(ae,{value:-2,children:"−2"}),e.jsx(ae,{value:-1,children:"−1"}),e.jsx(ae,{value:0,children:"0"}),e.jsx(ae,{value:1,children:"+1"}),e.jsx(ae,{value:2,children:"+2"})]})]}),o&&e.jsxs(e.Fragment,{children:[e.jsx(ue,{size:"small",variant:"outlined",onClick:()=>jt(),children:"Clear"}),e.jsx(ue,{size:"small",variant:"outlined",onClick:()=>wt(),children:"Advance"})]})]})]}),e.jsx(Ft,{}),W.length===0?e.jsx(D,{variant:"body2",sx:{opacity:.75},children:"No initiative rolls yet."}):e.jsx(Bt,{dense:!0,disablePadding:!0,children:W.map(u=>{const a=x[u.tokenId],s=a==null?void 0:a.ownerPlayerId,T=o||!!s&&s===S,R=t.activeTokenId===u.tokenId,A=R&&T&&!o,h=!!u.surprised,E=(a==null?void 0:a.topWeaponAmmoMax)??0,V=(a==null?void 0:a.topWeaponAmmo)??0,J=E>0&&V<=0;return e.jsxs(_t,{sx:{borderRadius:1,mb:.5,bgcolor:R?"rgba(255,255,255,0.06)":"transparent",opacity:h?.55:1},secondaryAction:e.jsxs(U,{direction:"row",spacing:.5,alignItems:"center",children:[e.jsx(ge,{title:a!=null&&a.armorBroken?"Armor broken":"Protection",children:e.jsxs(z,{sx:{display:"inline-flex",alignItems:"center",gap:.5,px:1,py:.5,borderRadius:1,bgcolor:"rgba(0,0,0,0.25)"},children:[e.jsx(Ht,{fontSize:"small",sx:{color:a!=null&&a.armorBroken?"error.main":"inherit"}}),e.jsx(D,{variant:"caption",children:(a==null?void 0:a.prot)??0})]})}),(o||T)&&e.jsx(ge,{title:a!=null&&a.topWeaponName?J?`Out of ammo: ${a.topWeaponName}`:`Attack: ${a.topWeaponName}`:"No top weapon",children:e.jsx("span",{children:e.jsx(le,{size:"small",disabled:!(a!=null&&a.topWeaponName)||J,onClick:()=>void se(u.tokenId),children:e.jsx(Se,{fontSize:"small"})})})}),(o||T)&&e.jsx(ge,{title:a!=null&&a.topWeaponName?E<=0?"No ammo to reload":`Reload: ${a.topWeaponName}`:"No top weapon",children:e.jsx("span",{children:e.jsx(le,{size:"small",disabled:!(a!=null&&a.topWeaponName)||E<=0,onClick:()=>void Y(u.tokenId),children:e.jsx(ut,{fontSize:"small"})})})}),e.jsx(ge,{title:T||o?"Remove":"Only the owner or GM can remove",children:e.jsx("span",{children:e.jsx(le,{size:"small",disabled:!T&&!o,onClick:()=>St(u.tokenId),children:e.jsx(We,{fontSize:"small"})})})})]}),children:[e.jsx(Ot,{children:e.jsx(qt,{src:a==null?void 0:a.thumbUrl,variant:"rounded",sx:{width:32,height:32,mr:1,cursor:"pointer"}})}),e.jsx(Ut,{primary:e.jsxs(z,{sx:{display:"flex",alignItems:"center",gap:1,flexWrap:"wrap"},children:[e.jsx(D,{variant:"body2",sx:{fontWeight:600},children:(a==null?void 0:a.name)??u.name??"Token"}),e.jsx(D,{variant:"caption",sx:{opacity:.75},children:u.initiative}),A&&e.jsx(D,{variant:"caption",sx:{px:1,py:.25,borderRadius:1,bgcolor:"rgba(0,128,255,0.2)"},children:"Your Turn"})]}),secondary:e.jsxs(z,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx($t,{size:"small",checked:h,disabled:!o,onChange:ie=>Ct(u.tokenId,ie.target.checked)}),e.jsx(D,{variant:"caption",sx:{opacity:.75},children:"Surprised"})]})})]},u.tokenId)})})]})}function ja(t){return e.jsxs("div",{style:{display:"flex",alignItems:"flex-start",gap:12,justifyContent:"space-between",marginBottom:10},children:[e.jsxs("div",{style:{display:"flex",gap:10,alignItems:"flex-start"},children:[t.thumbUrl?e.jsx("img",{src:t.thumbUrl,alt:"Token thumbnail",style:{width:44,height:44,borderRadius:10,objectFit:"cover",border:"1px solid rgba(0,0,0,0.2)"}}):e.jsx("div",{style:{width:44,height:44,borderRadius:10,border:"1px solid rgba(0,0,0,0.2)",opacity:.4}}),e.jsxs("div",{children:[e.jsxs("div",{style:{fontSize:18,fontWeight:700},children:[t.title," ",e.jsxs("span",{style:{fontSize:12,opacity:.75},children:["(",t.ownerLabel,")"]})]}),e.jsxs("div",{style:{fontSize:12,opacity:.8},children:["Token: ",e.jsx("code",{style:{fontSize:11},children:t.tokenId})]})]})]}),e.jsxs("div",{style:{display:"flex",gap:8},children:[t.showBackButton&&e.jsx("button",{style:{padding:"8px 10px",borderRadius:8,border:"1px solid #999",cursor:"pointer",opacity:.9},onClick:t.onBack,children:"Back to My Sheet"}),t.showUnsetButton&&e.jsx("button",{style:{padding:"8px 10px",borderRadius:8,border:"1px solid #999",cursor:"pointer",opacity:.9},onClick:t.onUnset,children:"Unset “My Character”"})]})]})}function wa(t){var n,x,f;return e.jsxs("div",{style:re.statusBar,children:[e.jsxs("div",{style:re.statusLeft,children:[e.jsxs("div",{style:re.statusGroup,children:[e.jsx("div",{style:re.statusLabel,children:"Stress"}),e.jsx("input",{type:"number",min:0,value:((n=t.sheet.stress)==null?void 0:n.current)??0,onChange:S=>t.applyStress(Number(S.target.value)),style:re.statusNumber})]}),e.jsxs("div",{style:re.statusGroup,children:[e.jsx("div",{style:re.statusLabel,children:"Wounds"}),e.jsxs("div",{style:re.woundsRow,children:[e.jsx("span",{style:re.woundsKind,children:"L"}),Array.from({length:4}).map((S,b)=>{var o;return e.jsx("input",{type:"checkbox",checked:(((o=t.sheet.wounds)==null?void 0:o.light)??0)>b,onChange:()=>t.toggleWound("light",b)},`wl_${b}`)}),e.jsx("span",{style:{width:8}}),e.jsx("span",{style:re.woundsKind,children:"M"}),Array.from({length:2}).map((S,b)=>{var o;return e.jsx("input",{type:"checkbox",checked:(((o=t.sheet.wounds)==null?void 0:o.moderate)??0)>b,onChange:()=>t.toggleWound("moderate",b)},`wm_${b}`)}),e.jsx("span",{style:{width:8}}),e.jsx("span",{style:re.woundsKind,children:"H"}),Array.from({length:1}).map((S,b)=>{var o;return e.jsx("input",{type:"checkbox",checked:(((o=t.sheet.wounds)==null?void 0:o.heavy)??0)>b,onChange:()=>t.toggleWound("heavy",b)},`wh_${b}`)})]})]}),e.jsxs("label",{style:{display:"flex",alignItems:"center",gap:6},children:[e.jsx("input",{type:"checkbox",checked:!!t.sheet.indomitable,onChange:S=>t.setIndomitable(S.target.checked)}),e.jsx("span",{style:{fontSize:12,opacity:.9},children:"Indomitable"})]}),(((x=t.sheet.stress)==null?void 0:x.current)??0)>(((f=t.sheetForView.stress)==null?void 0:f.cuf)??0)&&e.jsx("div",{style:re.warning,children:"Stress > CUF: make all rolls with +1 Penalty Die"}),e.jsxs("div",{style:{fontSize:12,opacity:.85},children:["Bulk: ",t.totalBulk," / ",t.effectiveCarryingCapacity]}),t.encumbranceLabel&&e.jsx("div",{style:re.warning,children:t.encumbranceLabel})]}),e.jsxs("div",{style:re.statusRight,children:[t.crucible&&t.crucible.status==="pending"&&e.jsxs("div",{style:re.crucibleBox,children:[e.jsx("div",{style:{fontWeight:700},children:"Crucible Test!"}),e.jsxs("div",{style:{fontSize:12,opacity:.85},children:["Incoming stress: ",t.crucible.incoming," • DC ",t.crucible.dc," • Roll CUF (no bonus/penalty dice)"]}),e.jsx("button",{style:re.buttonSecondary,onClick:()=>t.rollCrucibleTest(t.crucible.incoming),children:"Roll Crucible"})]}),t.crucible&&t.crucible.status==="success"&&e.jsxs("div",{style:re.crucibleBox,children:[e.jsx("div",{style:{fontWeight:700},children:"Crucible succeeded!"}),e.jsx("div",{style:{fontSize:12,opacity:.85},children:"Choose an Indomitable effect. (Indomitable checked automatically.)"})]}),t.crucible&&t.crucible.status==="fail"&&e.jsxs("div",{style:re.crucibleBox,children:[e.jsx("div",{style:{fontWeight:700},children:"Crucible failed"}),e.jsx("div",{style:{fontSize:12,opacity:.85},children:"You’ve entered PTSD range (6–8 stress)."}),e.jsx("button",{style:re.buttonSecondary,onClick:t.burnCufToPass,children:"Spend 1 CUF to pass"})]})]})]})}const re={statusBar:{display:"flex",alignItems:"flex-start",justifyContent:"space-between",gap:12,padding:"10px 12px",borderRadius:12,border:"1px solid rgba(255,255,255,0.15)",marginBottom:10},statusLeft:{display:"flex",alignItems:"center",gap:16,flexWrap:"wrap"},statusRight:{display:"flex",alignItems:"center",gap:12},statusGroup:{display:"flex",flexDirection:"column",gap:4},statusLabel:{fontSize:11,opacity:.75,letterSpacing:.2},statusNumber:{width:64,fontSize:16},woundsRow:{display:"flex",alignItems:"center",gap:8,flexWrap:"wrap"},woundsKind:{fontSize:11,opacity:.75,width:14,textAlign:"center"},warning:{marginTop:8,fontSize:12,opacity:.9},crucibleBox:{border:"1px solid rgba(255,255,255,0.18)",borderRadius:12,padding:10,maxWidth:240},buttonSecondary:{padding:"6px 10px",borderRadius:8,border:"1px solid #999",cursor:"pointer",opacity:.9,background:"transparent"}};function Ca(t){const x=mt().palette.text.primary;return e.jsxs("div",{style:{display:"flex",gap:8,alignItems:"center",marginBottom:10},children:[e.jsx(ve,{label:"Core",active:t.activeTab==="core",onClick:()=>t.onTab("core"),color:x}),e.jsx(ve,{label:"Skills",active:t.activeTab==="skills",onClick:()=>t.onTab("skills"),color:x}),e.jsx(ve,{label:"Combat",active:t.activeTab==="combat",onClick:()=>t.onTab("combat"),color:x}),e.jsx(ve,{label:"Initiative",active:t.activeTab==="initiative",onClick:()=>t.onTab("initiative"),color:x}),e.jsx(ve,{label:"Inventory",active:t.activeTab==="inventory",onClick:()=>t.onTab("inventory"),color:x}),e.jsx(ve,{label:"Feats",active:t.activeTab==="feats",onClick:()=>t.onTab("feats"),color:x}),e.jsx("div",{style:{marginLeft:"auto",opacity:.8},children:t.isSaving?"Saving…":"Synced"})]})}function ve(t){const n=mt(),[x,f]=je.useState(!1),b=n.palette.mode==="dark"?{background:"rgba(255,255,255,0.08)",borderColor:"rgba(255,255,255,0.45)"}:{};return e.jsx("button",{onClick:t.onClick,onMouseEnter:()=>f(!0),onMouseLeave:()=>f(!1),style:{padding:"6px 10px",borderRadius:999,border:"1px solid #777",cursor:"pointer",background:"transparent",fontWeight:t.active?700:400,color:t.color,...x?b:{}},children:t.label})}function Sa(){var Ve,Qe,Xe,Ze;const[t,n]=j.useState({kind:"loading"}),[x,f]=j.useState("core"),[S,b]=j.useState(!1),[o,r]=j.useState(null),[v,B]=j.useState(!1),[$,p]=j.useState([]),W=j.useRef(!1);async function K(c){var l,I,C,M,P,L;try{const q=await F.scene.items.getItems([c]),N=q==null?void 0:q[0];if(!N)return{ownerLabel:"unowned",thumbUrl:null};const Z=((l=N==null?void 0:N.image)==null?void 0:l.url)??((I=N==null?void 0:N.image)==null?void 0:I.href)??(N==null?void 0:N.imageUrl)??(N==null?void 0:N.image)??((C=N==null?void 0:N.thumbnail)==null?void 0:C.url)??null,ee=(M=N==null?void 0:N.metadata)==null?void 0:M[ot];if(typeof ee!="string"||ee.length===0)return{ownerLabel:"unowned",thumbUrl:Z,ownerPlayerId:null,isOwnedByMe:!1};const ce=await F.player.getId();if(ee===ce)return{ownerLabel:"owned by you",thumbUrl:Z,ownerPlayerId:ee,isOwnedByMe:!0};try{const G=(await((L=(P=F.party).getPlayers)==null?void 0:L.call(P))??[]).find(he=>(he==null?void 0:he.id)===ee);return{ownerLabel:`owned by ${typeof(G==null?void 0:G.name)=="string"&&G.name.length>0?G.name:ee}`,thumbUrl:Z,ownerPlayerId:ee,isOwnedByMe:!1}}catch{return{ownerLabel:`owned by ${ee}`,thumbUrl:Z,ownerPlayerId:ee,isOwnedByMe:!1}}}catch{return{ownerLabel:"unowned",thumbUrl:null,ownerPlayerId:null,isOwnedByMe:!1}}}async function ne(c){const l=c!=null&&c.ignoreOpenOverride?null:await Tt();if(l)if(await Oe(l)){const ee=await Be(l);if(!ee)throw new Error("Could not load sheet from token.");const ce=Ce(ee.skills??{}),me={...ee,attributes:ce},G=await K(l);n({kind:"ready",tokenId:l,sheet:me,mode:"view",suppressUnset:!0,...G});return}else await _e(null);let C=await ct();if(C||(C=await tt(),C&&await we(C)),!C){n({kind:"need-token"});return}let M=await Oe(C);if(!M){const Z=await tt();Z&&(C=Z,await we(C),M=await Oe(C))}if(!M){await we(null),n({kind:"need-token"});return}const P=await Be(C);if(!P)throw new Error("Could not load sheet from token.");try{await at(C)}catch{}const L=Ce(P.skills??{}),q={...P,attributes:L},N=await K(C);W.current=!1,n({kind:"ready",tokenId:C,sheet:q,mode:"my",suppressUnset:!!(c!=null&&c.suppressUnset),...N})}j.useEffect(()=>{let c=!1;return F.onReady(async()=>{try{const l=await F.player.getRole();c||B(String(l).toUpperCase()==="GM"),await ne()}catch(l){c||n({kind:"error",message:l.message??"Unknown error"})}}),()=>{c=!0}},[]);const se=t.kind==="ready"?t.tokenId:null,Y=t.kind==="ready"?t.mode:null;j.useEffect(()=>{if(t.kind!=="ready"||Y!=="my"||W.current)return;let c=!1;return F.onReady(async()=>{var l,I,C,M;if(!c)try{const[P]=await F.scene.items.getItems([se]);if(!P)return;let L=1,q=1;Et(P)&&(L=(((l=P.image)==null?void 0:l.width)??1)*(((I=P.scale)==null?void 0:I.x)??1),q=(((C=P.image)==null?void 0:C.height)??1)*(((M=P.scale)==null?void 0:M.y)??1));const N=P.position??{x:0,y:0},Z={min:{x:N.x-L/2,y:N.y-q/2},max:{x:N.x+L/2,y:N.y+q/2},width:L,height:q,center:N};await F.viewport.animateToBounds(Z);const ee=await F.viewport.getScale();await F.viewport.setScale(ee*.7),W.current=!0}catch{}}),()=>{c=!0}},[t.kind,Y,se]),j.useEffect(()=>{let c=null,l=!1;return F.onReady(()=>{l||(c=F.broadcast.onMessage(Ye,I=>{const C=I.data;C!=null&&C.text&&p(M=>[...M,C].slice(-3))}))}),()=>{if(l=!0,typeof c=="function")try{c()}catch{}}},[]),j.useEffect(()=>{let c=null,l=null,I=!1;const C="whisperspace.combatLogLeader",M=2e3,P=6e3,L=`${Date.now()}-${Math.random().toString(36).slice(2,10)}`,q=()=>{try{const G=localStorage.getItem(C);return G?JSON.parse(G):null}catch{return null}},N=G=>{try{localStorage.setItem(C,JSON.stringify({id:L,ts:G??Date.now()}))}catch{}},Z=()=>{const G=q();return G&&G.id===L},ee=()=>{const G=Date.now(),oe=q();(!oe||G-(oe.ts??0)>P||oe.id===L)&&N(G)},ce=()=>{const G=Z();if(G&&!c)c=F.broadcast.onMessage(Ye,oe=>{const he=oe.data;he!=null&&he.text&&F.notification.show(String(he.text),"INFO")});else if(!G&&c){try{c()}catch{}c=null}},me=G=>{G.key===C&&ce()};return F.onReady(()=>{if(!I){try{window.addEventListener("storage",me)}catch{}ee(),ce(),l=window.setInterval(()=>{I||(ee(),ce())},M)}}),()=>{I=!0;try{window.removeEventListener("storage",me)}catch{}if(l!==null&&clearInterval(l),Z())try{localStorage.removeItem(C)}catch{}if(typeof c=="function")try{c()}catch{}}},[]);function u(c,l,I){const C={text:`${c} took ${l} damage${I?` and +${I} stress`:""}.`,ts:Date.now(),kind:"effect",targetName:c,damageApplied:l,stressApplied:I};p(M=>[...M,C].slice(-3))}function a(c){if(t.kind!=="ready"||t.mode!=="my")return;const l=Math.max(0,Math.trunc(c.damageApplied??0)),I=Math.max(0,Math.trunc(c.stressApplied??0));l<=0&&I<=0||E(C=>{var P;const M=gt({sheet:C,incomingDamage:l,stressDelta:I});return M.stressDelta>0&&J(((P=M.sheet.stress)==null?void 0:P.current)??0),u(t.sheet.name||"Target",l,I),M.sheet})}j.useEffect(()=>{var M,P,L,q;if(t.kind!=="ready")return;const c=t.tokenId;let l=!1;const I=async()=>{var N,Z;try{const ee=await F.scene.items.getItems([c]),ce=ee==null?void 0:ee[0],me=String(((N=ce==null?void 0:ce.text)==null?void 0:N.plainText)??"").trim(),G=(Z=ce==null?void 0:ce.image)==null?void 0:Z.url;if(l||!me&&!G)return;n(oe=>{if(oe.kind!=="ready"||oe.tokenId!==c)return oe;const he=me&&oe.sheet.name!==me?{...oe.sheet,name:me}:oe.sheet;return{...oe,sheet:he,thumbUrl:G??oe.thumbUrl}})}catch{}};I();const C=(q=(L=(P=(M=F)==null?void 0:M.scene)==null?void 0:P.items)==null?void 0:L.onChange)==null?void 0:q.call(L,N=>{Array.isArray(N)&&N.some(Z=>(Z==null?void 0:Z.id)===c)&&I()});return()=>{l=!0,typeof C=="function"&&C()}},[t.kind,t.kind==="ready"?t.tokenId:null]);const s=j.useMemo(()=>t.kind==="ready"&&t.sheet.name||"Whisperspace Sheet",[t]);async function T(){const c=await Vt();if(!c){n({kind:"error",message:"No token selected. Select a token on the map first."});return}const l=await Be(c);if(!l){n({kind:"error",message:"Could not attach a sheet to the selected token."});return}const I=Ce(l.skills??{}),C={...l,attributes:I};await we(c);try{await at(c)}catch{}await _e(null);const M=await K(c);W.current=!1,n({kind:"ready",tokenId:c,sheet:C,mode:"my",suppressUnset:!1,...M})}async function R(){await we(null);try{await At()}catch{}n({kind:"need-token"})}async function A(){await _e(null),n({kind:"loading"});try{await ne({ignoreOpenOverride:!0,suppressUnset:!0})}catch(c){n({kind:"error",message:c.message??"Unknown error"})}}async function h(c,l){b(!0);try{await Ge(c,l)}finally{b(!1)}}function E(c){n(l=>{if(l.kind!=="ready")return l;let I=c(l.sheet);try{const C=Ce(I.skills??{});I={...I,attributes:{...I.attributes,...C},stress:{...I.stress??{current:0,cuf:0,cufLoss:0},cuf:Ne(I.skills??{})}}}catch{}return h(l.tokenId,I),{...l,sheet:I}})}async function V(c){var q;if(t.kind!=="ready")return;const l=8+c,I=Math.max(0,Math.trunc(((q=t.sheet.stress)==null?void 0:q.cuf)??0)),C=`Crucible Test (DC ${l})`,M=I===0?"":` +${I}`,P=`1d12 # ${C}${M}`;let L;try{L=await Ke({diceNotation:P,rollTarget:"everyone",showResults:!0,timeoutMs:6e3})}catch{F.notification.show("Dice+ roll failed or timed out.","WARNING");return}L>=l?(E(N=>({...N,stress:{...N.stress??{current:0,cuf:0,cufLoss:0},current:5},indomitable:!0})),r({incoming:c,dc:l,status:"success",total:L})):r({incoming:c,dc:l,status:"fail",total:L})}function J(c){var C;if(t.kind!=="ready")return;const l=Math.max(0,Math.trunc(((C=t.sheet.stress)==null?void 0:C.current)??0)),I=Math.max(0,Math.trunc(c));if(l<=5&&I>5){const M=I-l;r({incoming:M,dc:8+M,status:"pending"})}else r(null);E(M=>({...M,stress:{...M.stress??{current:0,cuf:0,cufLoss:0},current:I}}))}function ie(c,l){var L;if(t.kind!=="ready")return;const C={light:4,moderate:2,heavy:1}[c],M=Math.max(0,Math.trunc(((L=t.sheet.wounds)==null?void 0:L[c])??0)),P=l<M?l:l+1;E(q=>({...q,wounds:{...q.wounds,[c]:Math.min(C,Math.max(0,P))}}))}function te(){var l;if(t.kind!=="ready"||!o||o.status!=="fail")return;const c=Math.max(0,Math.trunc(((l=t.sheet.stress)==null?void 0:l.cufLoss)??0));E(I=>({...I,stress:{...I.stress??{current:0,cuf:0,cufLoss:0},cufLoss:c+1,current:5},indomitable:!0})),r({...o,status:"success"})}const w=t.kind==="ready"?t.sheet:null,i=je.useMemo(()=>{if(!w)return{};const c=[];return(w.feats??[]).forEach(l=>{typeof(l==null?void 0:l.statusEffects)=="string"&&l.statusEffects.trim()&&c.push(l.statusEffects)}),(w.inventory??[]).forEach(l=>{typeof(l==null?void 0:l.statusEffects)=="string"&&l.statusEffects.trim()&&c.push(l.statusEffects)}),Dt(c)},[w]),g=je.useMemo(()=>{const c={},l=new Map,I=M=>{const P=String(M.id),L=String(M.name??M.label??"").toLowerCase().replace(/\s+/g,"_").replace(/[^a-z0-9_\-()]/g,"");P&&(l.set(P.toLowerCase(),P),L&&l.set(L,P))};(fe.inherent??[]).forEach(I),Object.values(fe.learned??{}).forEach(M=>{(M??[]).forEach(I)});const C=new Set(["phys","ref","soc","ment","carrying_capacity","cool_under_fire","speed","cuf","carry","capacity","spd"]);return Object.entries(i??{}).forEach(([M,P])=>{const L=String(M).toLowerCase();if(C.has(L))return;const q=l.get(L);q&&(c[q]=(c[q]??0)+(Number.isFinite(P)?P:0))}),c},[i]),_=Math.max(0,(((Ve=w==null?void 0:w.attributes)==null?void 0:Ve.phys)??0)+(i.phys??0)),H=Math.max(0,(((Qe=w==null?void 0:w.attributes)==null?void 0:Qe.ref)??0)+(i.ref??0)),Q=Math.max(0,(((Xe=w==null?void 0:w.attributes)==null?void 0:Xe.soc)??0)+(i.soc??0)),O=Math.max(0,(((Ze=w==null?void 0:w.attributes)==null?void 0:Ze.ment)??0)+(i.ment??0)),ye=5+_*5+(i.carrying_capacity??0);30+_*5+(i.speed??0);const Ae=w?Ne(w.skills??{}):0,d=Math.max(0,Ae+(i.cool_under_fire??0)),k=je.useMemo(()=>w?{...w,attributes:{...w.attributes,phys:_,ref:H,soc:Q,ment:O},stress:{...w.stress??{current:0,cuf:0,cufLoss:0},cuf:d}}:null,[w,_,H,Q,O,d])??w,X=je.useMemo(()=>{var C;if(!w)return 0;const c=(w.weapons??[]).reduce((M,P)=>M+(P.bulk??0),0),l=((C=w.armor)==null?void 0:C.bulk)??0,I=(w.inventory??[]).reduce((M,P)=>{const L=P.quantity??1,q=P.bulk??0,N=Number.isFinite(q)?q:0,Z=Number.isFinite(L)?L:1;return M+N*Z},0);return c+l+I},[w]),ke=w&&X>ye*2?"Heavily Encumbered":w&&X>ye?"Encumbered":"";if(t.kind==="loading")return e.jsx("div",{style:{padding:12},children:"Loading…"});if(t.kind==="need-token")return e.jsxs("div",{style:{padding:12},children:[e.jsx("h2",{style:{margin:"0 0 8px 0"},children:"My Sheet"}),e.jsx("p",{style:{margin:"0 0 10px 0",lineHeight:1.35},children:"Select your character token on the map, then click:"}),e.jsx("button",{style:{padding:"8px 10px",borderRadius:8,border:"1px solid #666",cursor:"pointer"},onClick:T,children:"Set Selected Token as My Character"})]});if(t.kind==="error")return e.jsxs("div",{style:{padding:12},children:[e.jsx("h2",{style:{margin:"0 0 8px 0"},children:"Error"}),e.jsx("p",{style:{margin:"0 0 10px 0",lineHeight:1.35},children:t.message}),e.jsx("button",{style:{padding:"8px 10px",borderRadius:8,border:"1px solid #666",cursor:"pointer"},onClick:()=>n({kind:"need-token"}),children:"Back"})]});const Fe=t.ownerLabel??(t.mode==="view"?"Viewing token":"My Character"),yt=t.mode==="view"&&!t.isOwnedByMe,bt=t.mode==="my"&&!t.suppressUnset;return e.jsxs("div",{style:{padding:12},children:[e.jsx(ja,{title:s,ownerLabel:Fe,tokenId:t.tokenId,thumbUrl:t.thumbUrl??null,showBackButton:yt,onBack:A,showUnsetButton:bt,onUnset:R}),e.jsxs(e.Fragment,{children:[e.jsx(wa,{sheet:t.sheet,sheetForView:k,totalBulk:X,effectiveCarryingCapacity:ye,encumbranceLabel:ke,crucible:o,applyStress:J,toggleWound:ie,setIndomitable:c=>E(l=>({...l,indomitable:c})),rollCrucibleTest:V,burnCufToPass:te}),e.jsx(Ca,{activeTab:x,onTab:f,isSaving:S}),e.jsxs("div",{style:{border:"1px solid #888",borderRadius:12,padding:10},children:[x==="core"&&e.jsx(Qt,{sheet:k,onChange:c=>E(l=>({...l,...c}))}),x==="skills"&&e.jsx(Zt,{sheet:k,skillMods:g,onChange:c=>E(l=>({...l,skills:c})),onMetaChange:c=>E(l=>({...l,...c}))}),x==="combat"&&e.jsx(ca,{sheet:k,tokenId:t.tokenId,skillMods:g,onChange:c=>E(l=>({...l,...c})),onApplyStress:J,combatLog:$,onApplyCombatLog:t.mode==="my"?a:void 0,isGM:v}),x==="initiative"&&e.jsx(va,{}),x==="inventory"&&e.jsx(ka,{sheet:k,onChange:c=>E(l=>({...l,...c}))}),x==="feats"&&e.jsx(ta,{sheet:k,onChange:c=>E(l=>({...l,feats:c}))})]})]})]})}function Ia(t){var $,p,W,K,ne,se,Y,u;const n=((t==null?void 0:t.mode)??"LIGHT")==="DARK"?"dark":"light",x=(($=t==null?void 0:t.background)==null?void 0:$.default)??(n==="dark"?"#121212":"#ffffff"),f=((p=t==null?void 0:t.background)==null?void 0:p.paper)??(n==="dark"?"#1e1e1e":"#f7f7f7"),S=((W=t==null?void 0:t.text)==null?void 0:W.primary)??(n==="dark"?"#ffffff":"#111111"),b=((K=t==null?void 0:t.text)==null?void 0:K.secondary)??(n==="dark"?"#bdbdbd":"#444444"),o=((ne=t==null?void 0:t.primary)==null?void 0:ne.main)??"#2f6fed",r=((se=t==null?void 0:t.primary)==null?void 0:se.contrastText)??"#ffffff",v=((Y=t==null?void 0:t.secondary)==null?void 0:Y.main)??"#7c3aed",B=((u=t==null?void 0:t.secondary)==null?void 0:u.contrastText)??"#ffffff";return Kt({palette:{mode:n,background:{default:x,paper:f},text:{primary:S,secondary:b},primary:{main:o,contrastText:r},secondary:{main:v,contrastText:B}},shape:{borderRadius:12},typography:{fontFamily:"system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif"},components:{MuiPaper:{defaultProps:{elevation:0}},MuiButton:{styleOverrides:{root:{color:S,...n==="dark"?{borderColor:"rgba(255,255,255,0.25)","&:hover":{backgroundColor:"rgba(255,255,255,0.08)",borderColor:"rgba(255,255,255,0.45)"}}:{}},containedPrimary:{color:r},containedSecondary:{color:B}}},MuiButtonBase:{styleOverrides:{root:n==="dark"?{"&:hover":{backgroundColor:"rgba(255,255,255,0.06)"}}:{}}}}})}function Ma(t){const[n,x]=j.useState(null);j.useEffect(()=>{let S=null,b=!1;return F.onReady(async()=>{if(!b)try{const o=await F.theme.getTheme();b||x(o),S=F.theme.onChange(r=>x(r))}catch{}}),()=>{b=!0,S&&S()}},[]);const f=j.useMemo(()=>Ia(n),[n]);return e.jsxs(Gt,{theme:f,children:[e.jsx(Yt,{}),t.children]})}async function Da(){await F.onReady(async()=>{}),Rt.createRoot(document.getElementById("root")).render(e.jsx(je.StrictMode,{children:e.jsx(Ma,{children:e.jsx(Sa,{})})}))}Da();
