import"./config-BSaTKKvG.js";import{O as n}from"./vendor_obr-BLY5dk8V.js";import{x,C,D as T,M as _,E as M,n as O,t as S,p as b,c as A,b as N,u as $,s as H}from"./initiative-BDeRVN6i.js";import"./vendor-CPvQcOsy.js";import"./vendor_zod-CxP395f9.js";const f="com.whisperspace.sheet",L=`${f}/context/open-sheet`,P=`${f}/popover/open-sheet`,U=`${f}/context/roll-initiative`;async function W(){await n.onReady(async()=>{await n.contextMenu.create({id:L,icons:[{icon:"/icon.svg",label:"Open Whisperspace Sheet",filter:{min:1,max:1,every:[{key:"layer",value:"CHARACTER"}]}}],onClick:async(c,i)=>{var a;const s=(a=c.items)==null?void 0:a[0],r=s==null?void 0:s.id;r&&(await x(r),await n.popover.open({id:P,url:"/",height:720,width:520,anchorElementId:i,anchorReference:"ELEMENT"}))}}),await n.contextMenu.create({id:U,icons:[{icon:"/icon.svg",label:"Roll Initiative",filter:{min:1,max:1,every:[{key:"layer",value:"CHARACTER"}]}}],onClick:async c=>{var u,m,E,p;const i=(u=c.items)==null?void 0:u[0],s=i==null?void 0:i.id;if(!s)return;if(((await C()).entries??[]).some(e=>e.tokenId===s)){await T(s);return}const[a]=await n.scene.items.getItems([s]),v=(m=a==null?void 0:a.metadata)==null?void 0:m[_],t=M(v);if(!t)return;const o=[];(t.inventory??[]).forEach(e=>{typeof(e==null?void 0:e.statusEffects)=="string"&&e.statusEffects.trim()&&o.push(e.statusEffects)}),(t.feats??[]).forEach(e=>{typeof(e==null?void 0:e.statusEffects)=="string"&&e.statusEffects.trim()&&o.push(e.statusEffects)}),typeof(t==null?void 0:t.statusEffects)=="string"&&t.statusEffects.trim()&&o.push(t.statusEffects);const l=await O({statuses:o}),h=await S({skills:t.skills??{},inherentSkills:H.inherent??[]}),d=(l.deltas.ref??0)+(l.deltas.reflex??0),w=Math.max(0,h.ref+d),I=(await b({skills:t.skills??{}})).cuf,y=Math.max(0,I+(l.deltas.cool_under_fire??0)),R=(((E=t.stress)==null?void 0:E.current)??0)>y,g=(await A({modifier:w,label:`${t.name} Initiative`,netDice:R?-1:0})).notation,k=await N({diceNotation:g,rollTarget:"everyone",showResults:!0}),D=(p=a==null?void 0:a.image)==null?void 0:p.url;await $({tokenId:s,name:t.name,thumbUrl:D,initiative:k})}})})}W();
