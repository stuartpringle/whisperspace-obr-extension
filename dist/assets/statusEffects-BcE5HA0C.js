import{O as c}from"./vendor_obr-BLY5dk8V.js";import{o as m,s as r,n as o,r as N,u as U,b as x,a as y,d as B,l as w,e as V}from"./vendor_zod-CxP395f9.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const i of n)if(i.type==="childList")for(const u of i.addedNodes)u.tagName==="LINK"&&u.rel==="modulepreload"&&s(u)}).observe(document,{childList:!0,subtree:!0});function a(n){const i={};return n.integrity&&(i.integrity=n.integrity),n.referrerPolicy&&(i.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?i.credentials="include":n.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function s(n){if(n.ep)return;n.ep=!0;const i=a(n);fetch(n.href,i)}})();const D="whisperspace.sheet.v1",H=m({name:r().default(""),description:r().default(""),statusEffects:r().default("")}),z=m({name:r().default(""),keywords:y(r()).default([]),keywordParams:N(U([r(),o(),x()])).default({}),protection:o().int().nonnegative().default(0),durability:m({current:o().int().nonnegative().default(0),max:o().int().nonnegative().default(0)}).default({current:0,max:0}),bulk:o().int().nonnegative().optional(),req:r().optional(),cost:o().int().nonnegative().optional(),special:r().optional()}),G=m({id:r().optional(),name:r().default(""),skillId:r().default(""),useDC:o().int().default(8),damage:o().int().default(0),keywords:y(r()).default([]),keywordParams:N(U([r(),o(),x()])).default({}),range:r().optional(),ammo:o().int().nonnegative().optional(),bulk:o().int().nonnegative().optional(),req:r().optional(),cost:o().int().nonnegative().optional()}),F=m({schemaVersion:w(1).default(1),name:r().default(""),attributes:m({phys:o().int().nonnegative().default(0),ref:o().int().nonnegative().default(0),soc:o().int().nonnegative().default(0),ment:o().int().nonnegative().default(0)}).default({phys:0,ref:0,soc:0,ment:0}),stress:m({current:o().int().nonnegative().default(0),cuf:o().int().nonnegative().default(0),cufLoss:o().int().nonnegative().default(0)}).default({current:0,cuf:0,cufLoss:0}),wounds:m({light:o().int().nonnegative().default(0),moderate:o().int().nonnegative().default(0),heavy:o().int().nonnegative().default(0)}).default({light:0,moderate:0,heavy:0}),skills:N(o().int()).default({}),learningFocus:V(["combat","education","vehicles"]).optional(),skillPoints:o().int().nonnegative().optional(),weapons:y(G).default([]),armor:z.optional(),credits:o().int().nonnegative().default(0),inventory:y(B("type",[m({id:r().optional(),type:w("item"),name:r().default(""),quantity:o().int().default(1),uses:r().default(""),bulk:o().int().default(0),effect:r().default(""),cost:o().int().default(0),statusEffects:r().default("")}),m({id:r().optional(),type:w("cyberware"),name:r().default(""),quantity:o().int().default(1),bulk:o().int().default(1),tier:o().int().default(1),installationDifficulty:o().int().default(0),requirements:r().default(""),physicalImpact:r().default(""),effect:r().default(""),cost:o().int().default(0),statusEffects:r().default("")}),m({id:r().optional(),type:w("narcotics"),name:r().default(""),bulk:o().int().default(1),quantity:o().int().default(1),uses:o().int().default(1),addictionScore:o().int().default(0),legality:r().default(""),effect:r().default(""),cost:o().int().default(0),statusEffects:r().default("")})])).default([]),indomitable:x().default(!1),feats:y(H).default([]),notes:r().optional()}),C=F;function $(e){const t=F.parse({});return typeof e=="string"&&e.trim().length>0?{...t,name:e.trim()}:t}function K(e){const t=C.safeParse(e);if(t.success)return t.data;const a=$(typeof(e==null?void 0:e.name)=="string"?e.name:void 0),s=e==null?void 0:e.skills,n=Q(X(s)?s:{}),i={...a,...k(e,["name","archetype","background","motivation","notes"]),attributes:{...a.attributes,...k(e==null?void 0:e.attributes,["phys","ref","soc","ment"])},stress:{...a.stress,...k(e==null?void 0:e.stress,["current","cuf"])},wounds:{...a.wounds,...k(e==null?void 0:e.wounds,["light","moderate","heavy"])},skills:n,feats:Array.isArray(e==null?void 0:e.feats)?e.feats:a.feats,weapons:Array.isArray(e==null?void 0:e.weapons)?e.weapons:a.weapons,armor:(e==null?void 0:e.armor)??a.armor,schemaVersion:1},u=C.safeParse(i);return u.success?u.data:a}const me=K,J={powerlifting:"powerlift",light_weapons:"weapons_light",medium_weapons:"weapons_medium",heavy_weapons:"weapons_heavy",exotic_weapons:"weapons_exotic",melee_blunt:"melee_weapons",melee_sharp:"melee_weapons"};function Q(e){const t={};for(const[a,s]of Object.entries(e??{})){const n=J[a]??a,i=typeof s=="number"?s:0;t[n]=Math.max(t[n]??0,i)}for(const[a,s]of Object.entries(t))s||delete t[a];return t}function k(e,t){const a={};if(!e||typeof e!="object")return a;for(const s of t)e[s]!==void 0&&(a[s]=e[s]);return a}function X(e){if(!e||typeof e!="object")return!1;for(const t of Object.values(e))if(typeof t!="number")return!1;return!0}const O="com.whisperspace.sheet",S=`${O}/myCharacterTokenId`,A=`${O}/openTokenId`,M=`${O}/ownerPlayerId`;function q(e){return typeof e=="string"&&e.length>0}async function pe(){const t=(await c.player.getMetadata())[S];return q(t)?t:null}async function be(e){const a={...await c.player.getMetadata()};e?a[S]=e:delete a[S],await c.player.setMetadata(a)}async function ye(){const t=(await c.player.getMetadata())[A];return q(t)?t:null}async function he(e){const a={...await c.player.getMetadata()};e?a[A]=e:delete a[A],await c.player.setMetadata(a)}async function Z(e){var d,v;const a=(await c.scene.items.getItems([e]))[0];if(!a)return null;const s=(d=a==null?void 0:a.text)==null?void 0:d.plainText,n=s&&s.trim().length>0?s:a.name??"Unnamed",i=(v=a.metadata)==null?void 0:v[D];if(!i)return $(n);const u=K(i);return!u.name||u.name==="Unnamed"?{...u,name:n}:u}async function ee(e,t){await c.scene.items.updateItems([e],a=>{const s=a[0];if(s){s.metadata[D]=t;try{const n=s.text??{};s.text={...n,plainText:t.name}}catch{}}})}async function te(e){var s;const a=(await c.scene.items.getItems([e]))[0];return a?!!((s=a.metadata)!=null&&s[D]):!1}async function ge(e){const t=await Z(e);return t?(await te(e)||await ee(e,t),t):null}async function ve(e){const t=await c.player.getId();(await c.scene.items.getItems([e]))[0]&&await c.scene.items.updateItems([e],s=>{const n=s[0];n&&(n.metadata[M]=t)})}async function Ie(){const e=await c.player.getId(),a=(await c.scene.items.getItems()).find(s=>{var n;return((n=s.metadata)==null?void 0:n[M])===e});return(a==null?void 0:a.id)??null}async function we(){const e=await c.player.getId(),a=(await c.scene.items.getItems()).filter(n=>{var i;return((i=n.metadata)==null?void 0:i[M])===e});if(a.length===0)return;const s=a.map(n=>n.id);await c.scene.items.updateItems(s,n=>{n.forEach(i=>{i&&delete i.metadata[M]})})}const R="dice-plus/isReady",Y="dice-plus/roll-request",T="whisperspace.obr.sheet";async function ne(e=1e3){const t=crypto.randomUUID();return new Promise(a=>{const s=c.broadcast.onMessage(R,n=>{const i=n.data;(i==null?void 0:i.requestId)===t&&i.ready===!0&&(s(),a(!0))});c.broadcast.sendMessage(R,{requestId:t,timestamp:Date.now()},{destination:"ALL"}),setTimeout(()=>{s(),a(!1)},e)})}function ke(e){const t=Math.max(-2,Math.min(2,Math.trunc(e.netDice))),a=1+Math.abs(t);let s="1d12";t>0&&(s=`${a}d12kh1`),t<0&&(s=`${a}d12kl1`);const n=Number.isFinite(e.modifier)?Math.trunc(e.modifier):0,i=n===0?"":n>0?` +${n}`:` ${n}`;return`${s} # ${e.label}${i}`}async function Te(e){const t=crypto.randomUUID();return await c.broadcast.sendMessage(Y,{rollId:t,playerId:await c.player.getId(),playerName:await c.player.getName(),rollTarget:e.rollTarget??"everyone",diceNotation:e.diceNotation,showResults:e.showResults??!0,timestamp:Date.now(),source:T},{destination:"ALL"}),t}async function Me(e){if(!await ne())throw new Error("Dice+ is not available");const a=crypto.randomUUID(),s=e.timeoutMs??5e3;return new Promise(async(n,i)=>{const u=l=>{var b,P;const f=[l==null?void 0:l.total,l==null?void 0:l.value,(b=l==null?void 0:l.result)==null?void 0:b.total,(P=l==null?void 0:l.result)==null?void 0:P.totalValue];for(const I of f){const L=typeof I=="number"?I:typeof I=="string"?Number(I):NaN;if(Number.isFinite(L))return Math.trunc(L)}return NaN},d=c.broadcast.onMessage(`${T}/roll-result`,l=>{const f=l.data;if((f==null?void 0:f.rollId)===a){const b=u(f);if(!Number.isFinite(b))return;E(),n(b)}}),v=c.broadcast.onMessage(`${T}/roll-error`,l=>{const f=l.data;(f==null?void 0:f.rollId)===a&&(E(),i(new Error((f==null?void 0:f.error)||"Dice+ roll failed")))}),E=()=>{d(),v()};await c.broadcast.sendMessage(Y,{rollId:a,playerId:await c.player.getId(),playerName:await c.player.getName(),rollTarget:e.rollTarget??"everyone",diceNotation:e.diceNotation,showResults:e.showResults??!0,timestamp:Date.now(),source:T},{destination:"ALL"}),setTimeout(()=>{E(),i(new Error("Dice+ roll timed out (no roll-result received)"))},s)})}const ae=[{id:"athletics",label:"Athletics",attribute:"phys"},{id:"cybernetics",label:"Cybernetics",attribute:"phys"},{id:"powerlift",label:"Powerlift",attribute:"phys"},{id:"endurance",label:"Endurance",attribute:"phys"},{id:"toughness",label:"Toughness",attribute:"phys"},{id:"balance",label:"Balance",attribute:"ref"},{id:"evade",label:"Evade",attribute:"ref"},{id:"finesse",label:"Finesse",attribute:"ref"},{id:"instinct",label:"Instinct",attribute:"ref"},{id:"stealth",label:"Stealth",attribute:"ref"},{id:"subterfuge",label:"Subterfuge",attribute:"soc"},{id:"bearing",label:"Bearing",attribute:"soc"},{id:"negotiate",label:"Negotiate",attribute:"soc"},{id:"persuade",label:"Persuade",attribute:"soc"},{id:"streetwise",label:"Streetwise",attribute:"soc"},{id:"composure",label:"Composure",attribute:"ment"},{id:"psychology",label:"Psychology",attribute:"ment"},{id:"observe",label:"Observe",attribute:"ment"},{id:"recall",label:"Recall",attribute:"ment"},{id:"willpower",label:"Willpower",attribute:"ment"}],ie={combat:[{id:"melee_weapons",label:"Melee (weapons)",attribute:"phys"},{id:"melee_unarmed",label:"Melee (unarmed)",attribute:"phys"},{id:"weapons_light",label:"Weapons (light)",attribute:"ref"},{id:"weapons_medium",label:"Weapons (medium)",attribute:"ref"},{id:"weapons_heavy",label:"Weapons (heavy)",attribute:"phys"},{id:"weapons_exotic",label:"Weapons (exotic)",attribute:"ment"},{id:"power_armour",label:"Power Armour",attribute:"phys"},{id:"explosives",label:"Explosives",attribute:"ment"},{id:"tactics",label:"Tactics",attribute:"ment"}],education:[{id:"material_sciences",label:"Material Sciences",attribute:"ment"},{id:"computers",label:"Computers",attribute:"ment"},{id:"cryptology",label:"Cryptology",attribute:"ment"},{id:"electronics",label:"Electronics",attribute:"ment"},{id:"engineering",label:"Engineering",attribute:"ment"},{id:"first_aid",label:"First Aid",attribute:"ment"},{id:"forgery",label:"Forgery",attribute:"soc"},{id:"history",label:"History",attribute:"ment"},{id:"linguistics",label:"Linguistics",attribute:"ment"},{id:"research",label:"Research",attribute:"ment"},{id:"natural_sciences",label:"Natural Sciences",attribute:"ment"}],vehicles:[{id:"gunnery",label:"Gunnery",attribute:"ref"},{id:"navigation",label:"Navigation",attribute:"ment"},{id:"piloting",label:"Piloting",attribute:"ref"},{id:"remote_operation",label:"Remote Operation",attribute:"ment"},{id:"sensors",label:"Sensors",attribute:"ment"},{id:"systems_interface",label:"Systems Interface",attribute:"ment"}]},se={inherent:ae,learned:ie},oe=se,W="whisperspace.obr.sheet/initiativeTracker",re="whisperspace.obr.sheet/initActive",j=()=>({entries:[],updatedAt:Date.now()});function h(e){return[...e].sort((t,a)=>a.initiative!==t.initiative?a.initiative-t.initiative:(a.updatedAt??0)-(t.updatedAt??0))}async function p(){const e=await c.scene.getMetadata(),t=e==null?void 0:e[W];if(!t||typeof t!="object")return j();const s=(Array.isArray(t.entries)?t.entries:[]).filter(i=>i&&typeof i.tokenId=="string").map(i=>({tokenId:String(i.tokenId),name:typeof i.name=="string"?i.name:"Unnamed",thumbUrl:typeof i.thumbUrl=="string"?i.thumbUrl:void 0,initiative:Number.isFinite(i.initiative)?Math.trunc(i.initiative):0,surprised:typeof i.surprised=="boolean"?i.surprised:!1,updatedAt:Number.isFinite(i.updatedAt)?Math.trunc(i.updatedAt):0})),n={entries:h(s),activeTokenId:typeof t.activeTokenId=="string"?t.activeTokenId:void 0,updatedAt:Number.isFinite(t.updatedAt)?Math.trunc(t.updatedAt):Date.now()};return n.entries.length>0&&(!n.activeTokenId||!n.entries.some(i=>i.tokenId===n.activeTokenId))&&(n.activeTokenId=n.entries[0].tokenId),n}async function g(e){await c.scene.setMetadata({[W]:e})}async function _(e,t=[]){if(!t.length)return;const a=Array.from(new Set(t));try{await c.scene.items.updateItems(a,s=>{for(const n of s){const i={...n.metadata??{}};i[re]=e?n.id===e:!1,n.metadata=i}})}catch{}}async function _e(e){const t=await p(),a=e.updatedAt??Date.now(),s=t.entries.filter(u=>u.tokenId!==e.tokenId);s.push({tokenId:e.tokenId,name:e.name,thumbUrl:e.thumbUrl,initiative:Math.trunc(e.initiative),updatedAt:a});const n=h(s),i={entries:n,activeTokenId:t.activeTokenId,updatedAt:Date.now()};return n.length>0&&(!i.activeTokenId||!n.some(u=>u.tokenId===i.activeTokenId))&&(i.activeTokenId=n[0].tokenId),await g(i),await _(i.activeTokenId,n.map(u=>u.tokenId)),i}async function Ee(){const e=j();await g(e)}async function ce(e){const t=await p(),a=(t.entries??[]).filter(i=>i.tokenId!==e);let s=t.activeTokenId;if(s===e){const i=h(a);s=i.length?i[0].tokenId:void 0}const n={entries:a,activeTokenId:s,updatedAt:Date.now()};return await g(n),await _(n.activeTokenId,a.map(i=>i.tokenId)),n}const Se=ce;async function Ae(e,t){const a=await p(),s=(a.entries??[]).map(i=>i.tokenId===e?{...i,surprised:!!t}:i),n={entries:h(s),activeTokenId:a.activeTokenId,updatedAt:Date.now()};return await g(n),await _(n.activeTokenId,s.map(i=>i.tokenId)),n}async function Ne(){const e=await p(),t=h(e.entries);if(t.length===0)return e;const a=e.activeTokenId?t.findIndex(d=>d.tokenId===e.activeTokenId):-1,s=a>=0?(a+1)%t.length:0,i=a>=0&&s===0?t.map(d=>({...d,surprised:!1})):t,u={entries:i,activeTokenId:i[s].tokenId,updatedAt:Date.now()};return await g(u),await _(u.activeTokenId,i.map(d=>d.tokenId)),u}function xe(e){const t=c.scene.onMetadataChange(()=>{p().then(e)});return p().then(e),t}function De(e){const t=oe.inherent??[],a={phys:0,ref:0,soc:0,ment:0};for(const s of t){const n=Number((e==null?void 0:e[s.id])??0),i=s.attribute;i&&i in a&&(a[i]+=Math.max(0,n))}return{phys:Math.max(0,Math.ceil(a.phys/4)),ref:Math.max(0,Math.ceil(a.ref/4)),soc:Math.max(0,Math.ceil(a.soc/4)),ment:Math.max(0,Math.ceil(a.ment/4))}}function Oe(e){const a=["instinct","willpower","bearing","toughness","tactics"].reduce((s,n)=>s+Math.max(0,Math.trunc(Number(e[n]??0))),0);return 1+Math.ceil(a/5)}function ue(e){const t={};if(!e)return t;const a=e.split(",").map(s=>s.trim()).filter(Boolean);for(const s of a){const n=s.match(/^([a-zA-Z0-9_\-]+)\s*[:]?\s*([+\-])\s*(\d+)$/);if(!n)continue;const i=String(n[1]).toLowerCase().replace(/\s+/g,"_"),u=n[2]==="-"?-1:1,d=Math.trunc(Number(n[3]));Number.isFinite(d)&&(t[i]=(t[i]??0)+u*d)}return t}function le(e){const t={};for(const a of e){const s=ue(a??"");for(const[n,i]of Object.entries(s))t[n]=(t[n]??0)+i}return t}function Pe(e){return{deltas:le(e)}}function Le(e,t){const a={...e},s=(n,i)=>{!Number.isFinite(i)||i===0||(a[n]=(Number(a[n])||0)+i)};s("phys",t.phys??0),s("ref",t.ref??0),s("soc",t.soc??0),s("ment",t.ment??0),s("coolUnderFire",t.cool_under_fire??0),s("speed",t.speed??0),s("carryingCapacity",t.carrying_capacity??0);for(const[n,i]of Object.entries(t))n==="phys"||n==="ref"||n==="soc"||n==="ment"||n==="cool_under_fire"||n==="speed"||n==="carrying_capacity"||typeof a[n]=="number"&&(a[n]=a[n]+i);return a}export{p as A,ce as B,me as C,T as D,H as F,D as M,M as T,Me as a,ke as b,ne as c,Ee as d,Ne as e,Ae as f,Se as g,pe as h,Pe as i,Oe as j,ee as k,Z as l,De as m,Le as n,xe as o,le as p,ye as q,Te as r,oe as s,ge as t,_e as u,he as v,Ie as w,be as x,ve as y,we as z};
