import"./modulepreload-polyfill-B5Qt9EMX.js";import{r as S,j as e,d as Ce,e as gt}from"./vendor_react-XzhcIodj.js";import{O as $}from"./vendor_obr-BLY5dk8V.js";import{r as rt,b as ze,s as fe,c as yt,F as bt,a as Ke,o as pt,l as Ee,T as lt,d as kt,e as vt,f as jt,g as wt,h as ot,i as Ze,j as Pe,k as Ge,m as Se,n as Ct,u as St,p as It,q as Mt,t as Be,v as _e,w as et,x as we,y as tt,z as Dt}from"./statusEffects-FykivXLK.js";import{S as _,B as E,T as D,a as We,b as Z,c as g,d as ye,I as ie,C as Ie,R as Tt,A as Me,e as De,E as Te,f as Ae,g as ue,h as ct,i as ke,P as At,D as Le,L as at,j as Rt,M as de,k as dt,l as Et,m as Nt,n as Pt,o as zt,p as Wt,q as Lt,r as Ft,s as Bt,t as _t,u as Ot,v as ut}from"./vendor_mui-C1cVQ6D4.js";import{O as qt}from"./ObrMuiThemeProvider-FxuTIav9.js";import"./vendor-CPvQcOsy.js";import"./vendor_zod-CxP395f9.js";import"./vendor_emotion-pcfylbOS.js";async function Ut(){const t=await $.player.getSelection();return Array.isArray(t)?t:[]}async function $t(){const t=await Ut();return t.length>0?t[0]:null}async function Oe(t){return(await $.scene.items.getItems([t])).length>0}function Ht(t){var o;const s=t.sheet,[y,x]=S.useState(0),C=S.useMemo(()=>s.attributes??{phys:0,ref:0,soc:0,ment:0},[s.attributes]);async function b(i,p){const B=Number(C[i]??0),K=ze({netDice:y,modifier:B,label:p});await rt({diceNotation:K,showResults:!0,rollTarget:"everyone"})}return e.jsxs(_,{spacing:2,children:[e.jsxs(E,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",gap:2,flexWrap:"wrap"},children:[e.jsx(D,{variant:"h6",sx:{m:0},children:"Core"}),e.jsxs(E,{sx:{display:"flex",alignItems:"center",gap:1,flexWrap:"wrap"},children:[e.jsx(D,{variant:"subtitle2",sx:{opacity:.8},children:"Attribute Roll:"}),e.jsxs(We,{size:"small",exclusive:!0,value:y,onChange:(i,p)=>{p!==null&&x(p)},children:[e.jsx(Z,{value:-2,children:"−2"}),e.jsx(Z,{value:-1,children:"−1"}),e.jsx(Z,{value:0,children:"0"}),e.jsx(Z,{value:1,children:"+1"}),e.jsx(Z,{value:2,children:"+2"})]})]})]}),e.jsx(g,{label:"Name",size:"small",value:s.name??"",onChange:i=>t.onChange({name:i.target.value}),fullWidth:!0}),e.jsxs(E,{sx:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:1},children:[e.jsx(Ne,{label:"PHYS",value:C.phys,onRoll:()=>b("phys","PHYS Check")}),e.jsx(Ne,{label:"REF",value:C.ref,onRoll:()=>b("ref","REF Check")}),e.jsx(Ne,{label:"SOC",value:C.soc,onRoll:()=>b("soc","SOC Check")}),e.jsx(Ne,{label:"MENT",value:C.ment,onRoll:()=>b("ment","MENT Check")})]}),e.jsxs(E,{sx:{display:"grid",gridTemplateColumns:"repeat(3, 1fr)",gap:2},children:[e.jsx(g,{label:"Cool Under Fire",size:"small",value:((o=t.sheet.stress)==null?void 0:o.cuf)??0,inputProps:{readOnly:!0},fullWidth:!0}),e.jsx(g,{label:"Speed",size:"small",value:30+(C.phys??0)*5,inputProps:{readOnly:!0},fullWidth:!0}),e.jsx(g,{label:"Carrying Capacity",size:"small",value:5+(C.phys??0)*5,inputProps:{readOnly:!0},fullWidth:!0})]}),e.jsx(D,{variant:"body2",sx:{opacity:.75},children:"Attributes are derived automatically from skill ranks (¼ of total ranks under each attribute, rounded up)."})]})}function Ne(t){return e.jsxs(E,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(g,{label:t.label,size:"small",value:t.value,inputProps:{readOnly:!0},fullWidth:!0}),e.jsx(ye,{title:"Roll with Dice+",children:e.jsx(ie,{onClick:t.onRoll,"aria-label":`Roll ${t.label}`,children:e.jsx(Ie,{})})})]})}function Je(){const t=new Map;return Object.keys(fe.learned).forEach(s=>{(fe.learned[s]??[]).forEach(y=>t.set(y.id,{focus:s}))}),t}function mt(t){var i,p;const s=String(t.skillId??""),y=((i=t.sheet.skills)==null?void 0:i[s])??0,x=((p=t.skillMods)==null?void 0:p[s])??0;if(y>0)return y+x;const C=t.sheet.learningFocus??"combat",b=t.learnedInfoById.get(s);return(b&&b.focus===C?0:-1)+x}const Gt=["phys","ref","soc","ment"],qe={phys:"PHYSIQUE",ref:"REFLEX",soc:"SOCIAL",ment:"MENTAL"},Ue={combat:"Combat",education:"Education",vehicles:"Vehicles"},nt={combat:"Combat Focus",education:"Education Focus",vehicles:"Vehicles Focus"};function $e(t){const s=ht(t,0,5);return s*(s+1)/2}function Yt(t){const[s,y]=S.useState(""),[x,C]=S.useState(0),[b,o]=S.useState(!0),[i,p]=S.useState(!1),[B,K]=S.useState(""),k=t.sheet.skills??{},P=t.sheet.learningFocus??"combat",ee=Number(t.sheet.skillPoints??0);S.useEffect(()=>{let c=!1;return(async()=>{const f=await yt();c||(o(f),p(!0))})().catch(()=>{c||(o(!1),p(!0))}),()=>{c=!0}},[]);const re=S.useMemo(()=>Je(),[]);function le(c){const f=re.get(c.id);return f?f.focus===P?5:2:5}function X(c){var V;const f=k[c.id]??0,L=((V=t.skillMods)==null?void 0:V[c.id])??0;if(f>0)return f+L;const G=re.get(c.id);return G&&G.focus===P?0+L:-1+L}const m=S.useMemo(()=>{let c=0;for(const f of Object.values(k))c+=$e(f??0);return c},[k]),a=Math.max(0,ee-m),n=c=>{const f=Math.max(0,Math.trunc(Number(B)));if(!f)return;const L=ee+c*f,G=Math.max(m,L);t.onMetaChange({skillPoints:G}),K("")};function T(c){t.onChange(c)}function v(c,f){const L=k[c.id]??0,G=le(c),V=ht(f,0,G);if(V===L||$e(V)-$e(L)>a)return;const me={...k};V===0?delete me[c.id]:me[c.id]=V,T(me)}async function A(c){const f=ze({netDice:x,modifier:X(c),label:c.label});try{await rt({diceNotation:f,showResults:!0,rollTarget:"everyone"})}catch(L){console.error("Dice+ roll request failed:",L)}}const h=S.useMemo(()=>{const c=Object.values(fe.learned).flat();return[...fe.inherent,...c]},[]),W=S.useMemo(()=>{const c=s.trim().toLowerCase();return c?h.filter(f=>f.label.toLowerCase().includes(c)||f.id.toLowerCase().includes(c)):h},[h,s]),J=S.useMemo(()=>Kt(fe.inherent),[]),j=S.useMemo(()=>fe.learned,[]),q=s.trim().length>0,Q=e.jsxs(E,{sx:{display:"flex",alignItems:"center",gap:2,flexWrap:"wrap"},children:[e.jsx(D,{variant:"subtitle2",sx:{opacity:.8},children:"Learning Focus:"}),Object.keys(nt).map(c=>e.jsxs(E,{sx:{display:"flex",alignItems:"center",gap:.5,cursor:"pointer"},onClick:()=>t.onMetaChange({learningFocus:c}),children:[e.jsx(Tt,{checked:P===c,value:c,size:"small"}),e.jsx(D,{variant:"body2",children:Ue[c]})]},c))]}),H=e.jsx(E,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",gap:2,flexWrap:"wrap"},children:e.jsxs(E,{sx:{display:"flex",alignItems:"center",gap:1,flexWrap:"wrap"},children:[e.jsxs(D,{variant:"subtitle2",sx:{minWidth:170},children:["Skill Points: ",a," ",e.jsxs("span",{style:{opacity:.75},children:["(Total: ",ee,")"]})]}),e.jsx(ue,{size:"small",variant:"outlined",onClick:()=>n(1),disabled:!Number.isFinite(Number(B))||Math.trunc(Number(B))<=0,children:"+"}),e.jsx(g,{label:"SP",size:"small",type:"number",value:B,onChange:c=>K(c.target.value),sx:{width:110}}),e.jsx(ue,{size:"small",variant:"outlined",onClick:()=>n(-1),disabled:!Number.isFinite(Number(B))||Math.trunc(Number(B))<=0,children:"-"}),e.jsx(D,{variant:"subtitle2",sx:{opacity:.8},children:"Roll"}),e.jsxs(We,{size:"small",exclusive:!0,value:x,onChange:(c,f)=>{f!==null&&C(f)},"aria-label":"Bonus / Penalty dice",children:[e.jsx(Z,{value:-2,children:"−2"}),e.jsx(Z,{value:-1,children:"−1"}),e.jsx(Z,{value:0,children:"0"}),e.jsx(Z,{value:1,children:"+1"}),e.jsx(Z,{value:2,children:"+2"})]}),i&&!b&&e.jsx(D,{variant:"caption",sx:{opacity:.8},children:"(Dice+ not detected)"})]})});return e.jsxs(_,{spacing:2,children:[Q,e.jsx(g,{label:"Search skills",value:s,onChange:c=>y(c.target.value),placeholder:"stealth, weapons, navigation…",fullWidth:!0}),H,q?e.jsx(_,{spacing:1,children:W.map(c=>{const f=re.get(c.id),L=f?Ue[f.focus]:qe[c.attribute];return e.jsx(He,{skill:c,rank:k[c.id]??0,modifier:X(c),maxRank:le(c),onRank:G=>v(c,G),rightTag:L,canRoll:b,onRoll:()=>A(c)},c.id)})}):e.jsxs(e.Fragment,{children:[e.jsx(D,{variant:"subtitle1",children:"Inherent Skills"}),Gt.map(c=>e.jsxs(Me,{defaultExpanded:!0,children:[e.jsx(De,{expandIcon:e.jsx(Te,{}),children:e.jsx(D,{fontWeight:700,children:qe[c]})}),e.jsx(Ae,{children:e.jsx(_,{spacing:1,children:(J[c]??[]).map(f=>e.jsx(He,{skill:f,rank:k[f.id]??0,modifier:X(f),maxRank:le(f),onRank:L=>v(f,L),rightTag:qe[f.attribute],canRoll:b,onRoll:()=>A(f)},f.id))})})]},c)),e.jsx(D,{variant:"subtitle1",sx:{mt:1},children:"Learned Skills"}),Object.keys(j).map(c=>e.jsxs(Me,{defaultExpanded:!0,children:[e.jsx(De,{expandIcon:e.jsx(Te,{}),children:e.jsx(D,{fontWeight:700,children:nt[c]})}),e.jsx(Ae,{children:e.jsx(_,{spacing:1,children:(j[c]??[]).map(f=>e.jsx(He,{skill:f,rank:k[f.id]??0,modifier:X(f),maxRank:le(f),onRank:L=>v(f,L),rightTag:Ue[c],canRoll:b,onRoll:()=>A(f)},f.id))})})]},c))]})]})}function He(t){const s=t.rank<t.maxRank,y=t.rank>0;return e.jsxs(E,{sx:{display:"grid",gridTemplateColumns:"1fr auto auto auto",gap:1,alignItems:"center",border:"1px solid",borderColor:"divider",borderRadius:2,px:1.25,py:1},children:[e.jsxs(E,{sx:{minWidth:0},children:[e.jsx(D,{fontWeight:600,noWrap:!0,children:t.skill.label}),e.jsx(D,{variant:"caption",sx:{opacity:.7},noWrap:!0,children:t.rightTag??""})]}),e.jsxs(E,{sx:{width:46,textAlign:"center"},children:[e.jsx(D,{variant:"caption",sx:{opacity:.7,lineHeight:1},children:"Mod"}),e.jsx(D,{sx:{fontWeight:700,lineHeight:1.2},children:t.modifier>=0?`+${t.modifier}`:`${t.modifier}`})]}),e.jsxs(E,{sx:{width:40,textAlign:"center"},children:[e.jsx(D,{variant:"caption",sx:{opacity:.7,lineHeight:1},children:"Rank"}),e.jsx(D,{sx:{fontWeight:700,lineHeight:1.2},children:t.rank})]}),e.jsxs(E,{sx:{display:"flex",gap:.5,alignItems:"center",justifyContent:"flex-end"},children:[e.jsx(ie,{size:"small",onClick:()=>t.onRank(t.rank-1),"aria-label":"Decrease rank",disabled:!y,children:e.jsx(ct,{fontSize:"small"})}),e.jsx(ie,{size:"small",onClick:()=>t.onRank(t.rank+1),"aria-label":"Increase rank",disabled:!s,children:e.jsx(ke,{fontSize:"small"})}),e.jsx(E,{sx:{width:6}}),e.jsx(ye,{title:t.canRoll?"Roll with Dice+":"Dice+ not detected",children:e.jsx("span",{children:e.jsx(ie,{size:"small",onClick:t.onRoll,"aria-label":`Roll ${t.skill.label}`,disabled:!t.canRoll,children:e.jsx(Ie,{fontSize:"small"})})})})]})]})}function Kt(t){return t.reduce((s,y)=>{var x;return(s[x=y.attribute]??(s[x]=[])).push(y),s},{})}function ht(t,s,y){const x=Number.isFinite(t)?Math.trunc(t):s;return Math.max(s,Math.min(y,x))}function Jt(t){const s=t.sheet.feats??[];function y(){t.onChange([...s,{name:"New Feat",description:"",statusEffects:""}])}function x(b,o){const i=[...s];i[b]={...i[b],...o},bt.safeParse(i[b]),t.onChange(i)}function C(b){const o=[...s];o.splice(b,1),t.onChange(o)}return e.jsxs(_,{spacing:2,children:[e.jsxs(_,{direction:"row",justifyContent:"space-between",alignItems:"center",children:[e.jsx(D,{variant:"h6",children:"Feats"}),e.jsx(ue,{variant:"contained",startIcon:e.jsx(ke,{}),onClick:y,children:"Add Feat"})]}),s.length===0?e.jsx(D,{variant:"body2",sx:{opacity:.75},children:"No feats yet."}):e.jsx(_,{spacing:2,children:s.map((b,o)=>e.jsx(At,{sx:{p:2},children:e.jsxs(_,{spacing:1.5,children:[e.jsxs(_,{direction:"row",spacing:1,alignItems:"center",children:[e.jsx(g,{label:"Feat Name",fullWidth:!0,value:b.name,onChange:i=>x(o,{name:i.target.value})}),e.jsx(ie,{"aria-label":"Remove feat",onClick:()=>C(o),children:e.jsx(Le,{})})]}),e.jsx(g,{label:"Description",fullWidth:!0,multiline:!0,minRows:4,value:b.description,onChange:i=>x(o,{description:i.target.value})}),e.jsx(g,{label:"Status Effects",fullWidth:!0,helperText:'Comma-separated, e.g. "carrying_capacity+5"',value:b.statusEffects??"",onChange:i=>x(o,{statusEffects:i.target.value})})]})},`${b.name}-${o}`))})]})}const Vt=[{id:"pistol",name:"Pistol",skillId:"weapons_light",useDC:7,damage:2,range:"Med",ammo:10,bulk:1,cost:500},{id:"smart_pistol",name:"SMART Pistol",skillId:"weapons_light",useDC:9,damage:4,range:"Med",ammo:6,bulk:1,keywords:["Smart-Linked"],cost:900},{id:"toxic_spike",name:"Toxic Spike",skillId:"weapons_light",useDC:10,damage:3,range:"Short",ammo:1,bulk:1,keywords:["Toxin (Prax)","Concealable"],cost:750},{id:"smg",name:"SMG",skillId:"weapons_medium",useDC:6,damage:3,range:"Med",ammo:8,bulk:2,keywords:["Bullet Spray"],cost:600},{id:"photon_rifle",name:"Photon Rifle",skillId:"weapons_medium",useDC:8,damage:6,range:"Long",ammo:6,bulk:3,keywords:["Two-Handed"],cost:5e3},{id:"rifle",name:"Rifle",skillId:"weapons_medium",useDC:8,damage:4,range:"Long",ammo:8,bulk:2,keywords:["Two-Handed","Piercing 1"],cost:1e3},{id:"shotgun",name:"Shotgun",skillId:"weapons_medium",useDC:8,damage:4,range:"Short",ammo:4,bulk:3,req:"PHYS 1",keywords:["Point Blank","Shredding 1"],cost:800},{id:"gauss_cannon",name:"Gauss Cannon",skillId:"weapons_heavy",useDC:7,damage:4,range:"Med",ammo:20,bulk:4,req:"PHYS 3",keywords:["Bullet Spray"],cost:900},{id:"grenade_launcher",name:"Grenade Launcher",skillId:"weapons_heavy",useDC:8,damage:3,range:"Med",ammo:1,bulk:3,req:"PHYS 2",keywords:["Area (near)","Two-Handed","Slow Load","Grenade"],cost:2e3},{id:"magneton_cannon",name:"Magneton Cannon",skillId:"weapons_exotic",useDC:5,damage:2,range:"Short",ammo:5,bulk:2,req:"PHYS 1",keywords:["Area (melee)","Slow Load","Shredding 3"],cost:8e3},{id:"tesla_rifle",name:"Tesla Rifle",skillId:"weapons_exotic",useDC:8,damage:5,range:"Med",ammo:6,bulk:2,keywords:["Two-Handed","Stun 2"],cost:6e3},{id:"stun_baton",name:"Stun Baton",skillId:"melee_weapons",useDC:6,damage:0,range:"Melee",bulk:1,keywords:["Stun 1"],cost:450},{id:"switchblade",name:"Switchblade",skillId:"melee_weapons",useDC:9,damage:2,range:"Melee",bulk:1,keywords:["Concealable","Thrown"],cost:150},{id:"fusion_blade",name:"Fusion Blade",skillId:"melee_weapons",useDC:8,damage:3,range:"Melee",bulk:2,req:"REF 2",keywords:["Piercing 2"],cost:1200},{id:"rocket_maul",name:"Rocket Maul",skillId:"melee_weapons",useDC:10,damage:6,range:"Melee",ammo:2,bulk:3,req:"PHYS 3",keywords:["Two-Handed"],cost:2500}],Qt={weapons:Vt},st=Qt.weapons??[],Xt=[{id:"scrap_armour",name:"Scrap Armour",protection:1,durability:2,bulk:2,special:"Cannot be repaired",cost:500},{id:"flak_jacket",name:"Flak Jacket",protection:1,durability:4,bulk:1,cost:1250},{id:"kevlar_clothing",name:"Kevlar Clothing",protection:1,durability:3,bulk:1,special:"Appears to be normal clothing",cost:1500},{id:"streetweave_jacket",name:"Streetweave Jacket",protection:1,durability:5,bulk:1,special:"+1 to Stealth",cost:2500},{id:"milsec_bodyplate",name:"MilSec Bodyplate",protection:2,durability:6,bulk:2,cost:5e3},{id:"breaching_plate",name:"Breaching plate",protection:2,durability:4,bulk:3,req:"PHYS 2",special:"Frontal Shielding 1",cost:8500},{id:"heavy_bodyplate",name:"Heavy Bodyplate",protection:3,durability:8,bulk:4,req:"PHYS 3",special:"+1 penalty die to Stealth",cost:1e4},{id:"basic_power_armour",name:"Basic Power Armour",protection:4,durability:14,bulk:10,req:"Power Armour 1",special:`Requires Power Armour (DC5) check to activate. Failure: become Immobile; gain +1 penalty die to all PHYS and REF based checks. When activated, reduces its own bulk to 1 and grants +1 bonus die to all PHYS based checks.
`,cost:4e4}],Zt={armor:Xt},it=Zt.armor??[],Ye="whisperspace.obr.sheet/combat-log";function ea(t){return t>=9?4:t>=7?3:t>=4?2:0}async function ta(t){const s=Number.isFinite(t.useDC)?Math.trunc(t.useDC):Math.trunc(t.weapon.useDC),y=t.weapon.name||"Attack",x=ze({netDice:t.netDice,modifier:t.modifier,label:y}),C=await Ke({diceNotation:x,rollTarget:t.rollTarget??"everyone",showResults:t.showResults??!0}),b=C-s,o=C>=s,i=o?ea(b):0,p=o&&i>0,B=Math.trunc(t.weapon.damage??0),K=o?B+i:0,k=p?1:0;let P;o?p?P=`Extreme success - crit! ${y} rolled ${C} vs DC ${s}. Damage: ${B}+${i}=${K}. (+1 Stress)`:P=`Hit. ${y} rolled ${C} vs DC ${s}. Damage: ${B}.`:P=`Miss. ${y} rolled ${C} vs DC ${s}.`,t.prefix&&(P=`${t.prefix} ${P}`);const ee={text:P,ts:Date.now(),kind:"attack",attackerName:t.attackerName,weaponName:y,outcome:{total:C,useDC:s,hit:o,isCrit:p,baseDamage:B,totalDamage:K,stressDelta:k}};return $.broadcast.sendMessage(Ye,ee,{destination:"ALL"}),{total:C,useDC:s,margin:b,hit:o,isCrit:p,critExtra:i,baseDamage:B,totalDamage:K,stressDelta:k,message:P}}const xt=ta;function ft(t){var J,j;const s=Number.isFinite(t.incomingDamage)?Math.max(0,Math.trunc(t.incomingDamage)):0;if(s<=0&&!(t.stressDelta&&t.stressDelta>0))return{sheet:t.sheet,stressDelta:0};const y=!!t.unmitigated,x=t.sheet.armor,C=(((J=x==null?void 0:x.durability)==null?void 0:J.current)??0)<=0,b=y||C?0:(x==null?void 0:x.protection)??0,o=Math.max(0,s-b),i=t.sheet.wounds??{light:0,moderate:0,heavy:0};let p=i.light??0,B=i.moderate??0,K=i.heavy??0,k=o,P=0,ee=0,re=0;const X=Math.min(k,Math.max(0,4-p));p+=X,k-=X,P=X;const a=Math.min(k,Math.max(0,2-B));B+=a,k-=a,ee=a;const T=Math.min(k,Math.max(0,1-K));K+=T,k-=T,re=T;const v={light:p,moderate:B,heavy:K};let A=0;re>0?A=4:ee>0?A=2:P>0&&(A=1),t.stressDelta&&t.stressDelta>0&&(A+=Math.trunc(t.stressDelta));let h=x;!y&&!C&&o>0&&(x!=null&&x.durability)&&(h={...x,durability:{...x.durability,current:Math.max(0,Math.trunc((x.durability.current??0)-1))}});const W=Math.max(0,Math.trunc((((j=t.sheet.stress)==null?void 0:j.current)??0)+A));return{sheet:{...t.sheet,wounds:v,armor:h,stress:{...t.sheet.stress??{current:0,cuf:0,cufLoss:0},current:W}},stressDelta:A}}function be(t){var x;if(!t)return 0;const s=(x=t.keywordParams)==null?void 0:x.ammoMax,y=typeof s=="number"?s:typeof s=="string"?Number(s):void 0;return Number.isFinite(y)?Number(y):0}function aa(t){const s="#e55353",y="#8b5cf6",x="#5b6bff",C="#26a269",b="#d64040";return e.jsxs(E,{sx:{border:"1px solid",borderColor:"divider",borderRadius:2,p:1.25},children:[e.jsx(D,{variant:"subtitle2",sx:{opacity:.8,mb:.5},children:"Combat Log"}),t.entries.length===0?e.jsx(D,{variant:"body2",sx:{opacity:.7},children:"No recent rolls."}):e.jsx(_,{spacing:.75,children:t.entries.map(o=>{var X,m,a,n,T;const i=!!((X=o.outcome)!=null&&X.hit)&&((((m=o.outcome)==null?void 0:m.totalDamage)??0)>0||(((a=o.outcome)==null?void 0:a.stressDelta)??0)>0)&&!!t.onApply,p=i&&(((n=o.outcome)==null?void 0:n.totalDamage)??0)>0,B=i&&(((T=o.outcome)==null?void 0:T.stressDelta)??0)>0,K=p&&B,k=o.outcome,P=k!=null&&k.hit?"Hit":"Miss",ee=k!=null&&k.hit?C:b,re=o.attackerName??"Unknown",le=o.weaponName??"Attack";return e.jsxs(E,{sx:{display:"flex",alignItems:"center",gap:1,flexWrap:"wrap"},children:[e.jsx(D,{variant:"body2",sx:{flex:"1 1 260px"},children:o.kind==="effect"?e.jsxs(e.Fragment,{children:[e.jsx("strong",{children:o.targetName??"Target"})," ",(o.damageApplied??0)>0&&e.jsxs(e.Fragment,{children:["took"," ",e.jsx("strong",{style:{color:s},children:o.damageApplied})," ","damage"]}),(o.damageApplied??0)>0&&(o.stressApplied??0)>0&&" and ",(o.damageApplied??0)<=0&&(o.stressApplied??0)>0&&"took ",(o.stressApplied??0)>0&&e.jsxs(e.Fragment,{children:[e.jsx("strong",{style:{color:y},children:o.stressApplied})," ","stress"]}),"."]}):e.jsxs(e.Fragment,{children:[e.jsx("strong",{children:re}),": ",e.jsx("strong",{children:le})," rolled"," ",(k==null?void 0:k.total)??0," vs DC ",(k==null?void 0:k.useDC)??0,"."," ",k!=null&&k.isCrit?e.jsxs(e.Fragment,{children:[e.jsx("strong",{style:{color:C},children:"Extreme success - "}),e.jsx("strong",{style:{color:x},children:"crit!"})]}):e.jsx("strong",{style:{color:ee},children:P}),(k==null?void 0:k.hit)&&e.jsxs(e.Fragment,{children:[". Damage:"," ",e.jsx("strong",{style:{color:s},children:(k==null?void 0:k.totalDamage)??0}),k!=null&&k.stressDelta?e.jsxs(e.Fragment,{children:[" "," (+"," ",e.jsx("strong",{style:{color:y},children:k.stressDelta})," ","Stress)"]}):null]}),"."]})}),p&&e.jsx(ue,{size:"small",variant:"outlined",startIcon:e.jsx(at,{fontSize:"small"}),onClick:()=>{var v,A;return(A=t.onApply)==null?void 0:A.call(t,{...o,kind:"attack",damageApplied:((v=o.outcome)==null?void 0:v.totalDamage)??0,stressApplied:0})},children:"Apply Damage"}),B&&e.jsx(ue,{size:"small",variant:"outlined",startIcon:e.jsx(Rt,{fontSize:"small"}),onClick:()=>{var v,A;return(A=t.onApply)==null?void 0:A.call(t,{...o,kind:"attack",damageApplied:0,stressApplied:((v=o.outcome)==null?void 0:v.stressDelta)??0})},children:"Apply Stress"}),K&&e.jsx(ue,{size:"small",variant:"outlined",startIcon:e.jsx(at,{fontSize:"small"}),onClick:()=>{var v,A,h;return(h=t.onApply)==null?void 0:h.call(t,{...o,kind:"attack",damageApplied:((v=o.outcome)==null?void 0:v.totalDamage)??0,stressApplied:((A=o.outcome)==null?void 0:A.stressDelta)??0})},children:"Apply Both"})]},o.ts)})})]})}function na(t){var Q,H,c,f,L,G,V,O,me,pe,Fe,ge;const s=t.sheet,[y,x]=S.useState(0),[C,b]=S.useState(null),[o,i]=S.useState(""),[p,B]=S.useState(!1),K=(t.combatLog??[]).slice(-3).reverse(),k=S.useMemo(()=>Je(),[]),P=S.useMemo(()=>{const l=Object.values(fe.learned).flat();return[...fe.inherent,...l]},[]),ee=new Set(["melee_weapons","melee_unarmed","weapons_light","weapons_medium","weapons_heavy","weapons_exotic","explosives"]),re=P.filter(l=>ee.has(l.id));S.useMemo(()=>[...P].sort((l,d)=>l.label.localeCompare(d.label)),[P]);function le(){var te;const l=Number(o),d=Number.isFinite(l)?Math.max(0,Math.trunc(l)):0;if(d<=0)return;const w=ft({sheet:t.sheet,incomingDamage:d,unmitigated:p});t.onChange({wounds:w.sheet.wounds,armor:w.sheet.armor,stress:w.sheet.stress}),w.stressDelta>0&&t.onApplyStress&&t.onApplyStress(((te=w.sheet.stress)==null?void 0:te.current)??0),i("")}function X(l){return mt({learnedInfoById:k,sheet:s,skillId:l,skillMods:t.skillMods})}function m(l,d){const w=[...s.weapons??[]],te=w[l];if(d.ammo!==void 0&&!be(te)&&d.ammo>0){const Re={...te.keywordParams??{},ammoMax:d.ammo};w[l]={...te,...d,keywordParams:Re},t.onChange({weapons:w});return}w[l]={...te,...d},t.onChange({weapons:w})}function a(l,d){if(l===null||l===d)return;const w=t.sheet.weapons??[];if(l<0||l>=w.length||d<0||d>=w.length)return;const te=[...w],[ve]=te.splice(l,1);te.splice(d,0,ve),t.onChange({weapons:te}),b(d)}function n(l){const d=st.find(te=>te.id===l);if(!d)return;const w=[...s.weapons??[]];w.push({name:d.name,skillId:d.skillId,useDC:d.useDC,damage:d.damage,range:d.range,ammo:d.ammo,bulk:d.bulk,req:d.req,cost:d.cost,keywords:[...d.keywords??[]],keywordParams:{ammoMax:d.ammo??0,...d.keywordParams??{}}}),t.onChange({weapons:w})}function T(){const l=[...s.weapons??[]];l.push({name:"New Weapon",skillId:"weapons_medium",useDC:8,damage:3,range:"Med",ammo:0,bulk:1,req:"",cost:0,keywords:[],keywordParams:{ammoMax:0}}),t.onChange({weapons:l})}function v(l){const d=[...s.weapons??[]];d.splice(l,1),t.onChange({weapons:d})}async function A(l,d){const w=be(d),te=Number.isFinite(d.ammo)?Number(d.ammo):0;if(w>0&&te<=0){$.notification.show("Out of ammo. Reload first.","WARNING");return}const ve=X(d.skillId);await xt({weapon:d,useDC:Number.isFinite(d.useDC)?Number(d.useDC):0,netDice:y,modifier:ve,attackerName:t.sheet.name,rollTarget:"everyone",showResults:!0}),w>0&&m(l,{ammo:Math.max(0,te-1)})}const[h,W]=S.useState(""),[J,j]=S.useState("");function q(l){const d=it.find(w=>w.id===l);d&&t.onChange({armor:{name:d.name,keywords:[...d.keywords??[]],keywordParams:{...d.keywordParams??{}},protection:d.protection,durability:{current:d.durability,max:d.durability},bulk:d.bulk,req:d.req,cost:d.cost,special:d.special}})}return e.jsxs(_,{spacing:2,children:[e.jsx(E,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",gap:2,flexWrap:"wrap"},children:e.jsx(D,{variant:"h6",sx:{m:0},children:"Combat"})}),e.jsxs(E,{sx:{display:"flex",alignItems:"center",gap:1,flexWrap:"wrap"},children:[e.jsx(D,{variant:"subtitle2",sx:{opacity:.8},children:"Take Damage:"}),e.jsx(g,{size:"small",type:"number",inputProps:{min:0},value:o,onChange:l=>i(l.target.value),sx:{width:90}}),e.jsx(Z,{size:"small",value:"unmitigated",selected:p,onChange:()=>B(l=>!l),children:"Unmitigated"}),e.jsx(ue,{size:"small",variant:"outlined",onClick:le,children:"Apply"})]}),e.jsxs(E,{sx:{display:"flex",alignItems:"center",gap:1,flexWrap:"wrap"},children:[e.jsx(D,{variant:"subtitle2",sx:{opacity:.8},children:"Attack Roll:"}),e.jsxs(We,{size:"small",exclusive:!0,value:y,onChange:(l,d)=>{d!==null&&x(d)},children:[e.jsx(Z,{value:-2,children:"−2"}),e.jsx(Z,{value:-1,children:"−1"}),e.jsx(Z,{value:0,children:"0"}),e.jsx(Z,{value:1,children:"+1"}),e.jsx(Z,{value:2,children:"+2"})]})]}),e.jsx(aa,{entries:K,onApply:t.onApplyCombatLog}),e.jsxs(Me,{defaultExpanded:!0,children:[e.jsx(De,{expandIcon:e.jsx(Te,{}),children:e.jsx(D,{fontWeight:700,children:"Weapons"})}),e.jsx(Ae,{children:e.jsxs(_,{spacing:1.5,children:[e.jsxs(E,{sx:{display:"flex",gap:1,alignItems:"center",flexWrap:"wrap"},children:[e.jsxs(g,{label:"Add prefab weapon",size:"small",select:!0,value:h,onChange:l=>W(l.target.value),sx:{minWidth:240},children:[e.jsx(de,{value:"",children:"— choose —"}),st.map(l=>e.jsx(de,{value:l.id,children:l.name},l.id))]}),e.jsx(ie,{color:"primary",onClick:()=>n(h),"aria-label":"Add prefab weapon",disabled:!h,children:e.jsx(ke,{})}),e.jsx(E,{sx:{flex:1}}),e.jsx(ie,{color:"primary",onClick:T,"aria-label":"Add custom weapon",children:e.jsx(ke,{})}),e.jsx(D,{variant:"body2",sx:{opacity:.75},children:"Add custom weapon"})]}),(s.weapons??[]).length===0?e.jsx(D,{sx:{opacity:.75},children:"No weapons yet."}):(s.weapons??[]).map((l,d)=>e.jsxs(E,{draggable:!0,onDragStart:()=>b(d),onDragEnd:()=>b(null),onDragOver:w=>{w.preventDefault()},onDrop:w=>{w.preventDefault(),a(C,d)},sx:{border:"1px solid",borderColor:"divider",borderRadius:2,p:1.25,cursor:"grab",opacity:C===d?.85:1,display:"grid",gap:1.25},children:[e.jsxs(E,{sx:{display:"flex",gap:1,alignItems:"center"},children:[e.jsx(g,{label:"Name",size:"small",value:l.name,onChange:w=>m(d,{name:w.target.value}),fullWidth:!0}),e.jsx(ye,{title:"Roll attack with Dice+",children:e.jsx(ie,{onClick:()=>A(d,l),"aria-label":`Roll attack for ${l.name}`,children:e.jsx(Ie,{})})}),e.jsx(ie,{onClick:()=>v(d),"aria-label":"Remove weapon",children:e.jsx(Le,{})})]}),e.jsxs(E,{sx:{display:"grid",gridTemplateColumns:"1fr 1fr 1fr 1fr",gap:1},children:[e.jsx(g,{label:"Skill",size:"small",select:!0,value:l.skillId,onChange:w=>m(d,{skillId:w.target.value}),children:re.map(w=>e.jsx(de,{value:w.id,children:w.label},w.id))}),e.jsx(g,{label:"Use DC",size:"small",type:"number",value:l.useDC,onChange:w=>m(d,{useDC:Number(w.target.value)})}),e.jsx(g,{label:"Damage",size:"small",type:"number",value:l.damage,onChange:w=>m(d,{damage:Number(w.target.value)})}),e.jsx(g,{label:"Range",size:"small",value:l.range??"",onChange:w=>m(d,{range:w.target.value}),placeholder:"Melee / Short / Med / Long"}),e.jsxs(E,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(g,{label:"Ammo",size:"small",type:"number",value:l.ammo??0,onChange:w=>m(d,{ammo:Number(w.target.value)}),sx:{width:110}}),e.jsxs(D,{variant:"body2",sx:{opacity:.8},children:["/ ",be(l)||0]}),e.jsx(ye,{title:"Reload",children:e.jsx("span",{children:e.jsx(ie,{size:"small",onClick:()=>m(d,{ammo:be(l)||0}),disabled:(be(l)||0)<=0,children:e.jsx(dt,{fontSize:"small"})})})})]}),e.jsx(g,{label:"Bulk",size:"small",type:"number",value:l.bulk??0,onChange:w=>m(d,{bulk:Number(w.target.value)})}),e.jsx(g,{label:"Req.",size:"small",value:l.req??"",onChange:w=>m(d,{req:w.target.value}),placeholder:"PHYS 1 / REF 2 / etc"}),e.jsx(g,{label:"Keywords (comma)",size:"small",value:(l.keywords??[]).join(", "),onChange:w=>m(d,{keywords:w.target.value.split(",").map(te=>te.trim()).filter(Boolean)}),placeholder:"Two-Handed, Piercing 1",sx:{gridColumn:"1 / -1"}})]})]},l.id??`${l.name}-${d}`))]})})]}),e.jsxs(Me,{defaultExpanded:!0,children:[e.jsx(De,{expandIcon:e.jsx(Te,{}),children:e.jsx(D,{fontWeight:700,children:"Armor"})}),e.jsx(Ae,{children:e.jsxs(_,{spacing:1.5,children:[e.jsxs(E,{sx:{display:"flex",gap:1,alignItems:"center",flexWrap:"wrap"},children:[e.jsxs(g,{label:"Set prefab armor",size:"small",select:!0,value:J,onChange:l=>j(l.target.value),sx:{minWidth:240},children:[e.jsx(de,{value:"",children:"— choose —"}),it.map(l=>e.jsx(de,{value:l.id,children:l.name},l.id))]}),e.jsx(ie,{color:"primary",onClick:()=>q(J),"aria-label":"Set prefab armor",disabled:!J,children:e.jsx(ke,{})})]}),e.jsxs(E,{sx:{border:"1px solid",borderColor:"divider",borderRadius:2,p:1.25},children:[e.jsxs(E,{sx:{display:"grid",gridTemplateColumns:"2fr 1fr 1fr 1fr",gap:1},children:[e.jsx(g,{label:"Name",size:"small",value:((Q=s.armor)==null?void 0:Q.name)??"",onChange:l=>t.onChange({armor:{...s.armor??{durability:{current:0,max:0},protection:0,keywords:[],keywordParams:{ammoMax:0}},name:l.target.value}})}),e.jsx(g,{label:"Protection",size:"small",type:"number",value:((H=s.armor)==null?void 0:H.protection)??0,onChange:l=>t.onChange({armor:{...s.armor??{name:"",durability:{current:0,max:0},keywords:[],keywordParams:{}},protection:Number(l.target.value)}})}),e.jsx(g,{label:"Durability (cur)",size:"small",type:"number",value:((c=s.armor)==null?void 0:c.durability.current)??0,onChange:l=>{var d;return t.onChange({armor:{...s.armor??{name:"",durability:{current:0,max:0},protection:0,keywords:[],keywordParams:{}},durability:{...((d=s.armor)==null?void 0:d.durability)??{current:0,max:0},current:Number(l.target.value)}}})}}),e.jsx(g,{label:"Durability (max)",size:"small",type:"number",value:((f=s.armor)==null?void 0:f.durability.max)??0,onChange:l=>{var d;return t.onChange({armor:{...s.armor??{name:"",durability:{current:0,max:0},protection:0,keywords:[],keywordParams:{}},durability:{...((d=s.armor)==null?void 0:d.durability)??{current:0,max:0},max:Number(l.target.value)}}})}})]}),(((G=(L=s.armor)==null?void 0:L.durability)==null?void 0:G.max)??0)>0&&(((O=(V=s.armor)==null?void 0:V.durability)==null?void 0:O.current)??0)<=0&&e.jsx(D,{sx:{mt:1},color:"error",variant:"body2",children:"Broken: armor provides no Protection until repaired."}),e.jsxs(E,{sx:{display:"grid",gridTemplateColumns:"1fr 1fr 1fr 2fr",gap:1,mt:1},children:[e.jsx(g,{label:"Bulk",size:"small",type:"number",value:((me=s.armor)==null?void 0:me.bulk)??0,onChange:l=>t.onChange({armor:{...s.armor??{name:"",durability:{current:0,max:0},protection:0,keywords:[],keywordParams:{}},bulk:Number(l.target.value)}})}),e.jsx(g,{label:"Req.",size:"small",value:((pe=s.armor)==null?void 0:pe.req)??"",onChange:l=>t.onChange({armor:{...s.armor??{name:"",durability:{current:0,max:0},protection:0,keywords:[],keywordParams:{}},req:l.target.value}})}),e.jsx(g,{label:"Special",size:"small",value:((Fe=s.armor)==null?void 0:Fe.special)??"",onChange:l=>t.onChange({armor:{...s.armor??{name:"",durability:{current:0,max:0},protection:0,keywords:[],keywordParams:{}},special:l.target.value}})})]}),e.jsx(E,{sx:{mt:1},children:e.jsx(g,{label:"Keywords (comma)",size:"small",fullWidth:!0,value:(((ge=s.armor)==null?void 0:ge.keywords)??[]).join(", "),onChange:l=>t.onChange({armor:{...s.armor??{name:"",durability:{current:0,max:0},protection:0,keywords:[],keywordParams:{}},keywords:l.target.value.split(",").map(d=>d.trim()).filter(Boolean)}}),placeholder:"Frontal Shielding 1"})})]})]})})]})]})}const sa=[{name:"Flashbang Grenade",effect:"Applies Stun 1 to everyone within near range, Thrown",uses:"1 use",bulk:1,cost:200},{name:"Frag Grenade",effect:"Deals 2 area (near range) damage (DC8 to Evade half), Thrown",uses:"1 use",bulk:1,cost:250},{name:"EMP Grenade",effect:"Applies EMP 2 to everything within range, Thrown",uses:"1 use",bulk:1,cost:300},{name:"Combat Stim Injector",effect:"Gain +1 action & -1 Stress; take 1 wound after effect ends",uses:"1 use",bulk:1,cost:200},{name:"Basic Medkit",effect:"Right tool for the job: First Aid checks",uses:"3 uses",bulk:1,cost:350},{name:"Multitool",effect:"Allows engineering checks to repair, bypass, scrap, etc.",uses:"Permanent",bulk:1,cost:750},{name:"Repair Kit",effect:"Provides materials and tools for repairs",uses:"10 uses",bulk:1,cost:500},{name:"Tracker",effect:"While within 10km, always know location of this device",uses:"1 use",bulk:1,cost:250},{name:"Portable Scanner",effect:"Right tool for the job: Observe (tech, lifeforms)",uses:"Permanent",bulk:1,cost:400},{name:"Weapon Scope",effect:"Simple Modification. Grants +1 bonus die to called shots at medium range and farther; inflicts +1 penalty die to attacks at close range or nearer",uses:"Permanent",bulk:1,cost:750},{name:"Weapon Silencer",effect:"Simple Modification. Weapon makes reduced sound when fired; deals -1 damage",uses:"Permanent",bulk:1,cost:500},{name:"Compact Backpack",effect:"+5 Inventory Slots when worn",uses:"Permanent",bulk:0,cost:150,statusEffects:"carrying_capacity+5"},{name:"Ammo (Flechette)",effect:"Deals +2 damage to unarmoured targets.",uses:"10 rounds",bulk:1,cost:500},{name:"Ammo (SMART)",effect:"Required for Smart-Linked weapons.",uses:"10",bulk:1,cost:1250},{name:"Ammo (Armour Piercing)",effect:"Adds Piercing 1 to attacks.",uses:"10",bulk:1,cost:750},{name:"Ammo (Explosive)",effect:"Adds Shredding 1 to attacks.",uses:"10",bulk:1,cost:750}],ia={items:sa},ra=ia.items,la=[{name:"Reflex Booster",tier:1,effect:"Once per round, gain +1 bonus die to an Evade check.",installationDifficulty:2,requirements:"REF 1",physicalImpact:"Low; spine",bulk:1,cost:3e3},{name:"Targeting Link",tier:1,effect:"Once per round, ignore 1 level of cover when attacking an enemy you can see.",installationDifficulty:2,requirements:"-",physicalImpact:"Medium; eyes",bulk:1,cost:4e3},{name:"Low-Light Optics",tier:1,effect:"Ignore penalty dice caused by darkness within medium range.",installationDifficulty:1,requirements:"-",physicalImpact:"Medium; eyes",bulk:1,cost:2e3},{name:"EMP Shielding",tier:1,effect:"Ignore the effects of EMP once per day.",installationDifficulty:2,requirements:"MENT 1",physicalImpact:"None; torso",bulk:1,cost:3500},{name:"Metabolic Filter",tier:1,effect:"Gain +1 bonus die on checks to resist toxins or narcotics.",installationDifficulty:1,requirements:"PHYS 1",physicalImpact:"Minor; liver",bulk:1,cost:1500},{name:"Compact Databank",tier:2,effect:"Internal information storage device; store/access info at will.",installationDifficulty:2,requirements:"MENT 1",physicalImpact:"Medium; cranium",bulk:1,cost:5e3}],oa={cyberware:la},ca=oa.cyberware,da=[{name:"Space Dust",effect:"Grants +1 bonus die to Observe and Piloting checks for 6 hours",uses:5,addictionScore:1,legality:"Legal",bulk:1,cost:500},{name:"Tranquility",effect:"Reduces stress by 1; penalty die to all REF checks for 6 hours.",uses:2,addictionScore:5,legality:"Legal",bulk:1,cost:5e3},{name:"Smoothe",effect:"Reduces stress by 1d4; increases Cool Under Fire by 2 and grants +1 bonus die to all Mental skill checks for 1 hour",uses:1,addictionScore:8,legality:"Illegal",bulk:1,cost:2e4},{name:"Chemical Strength",effect:"+1 bonus die to all PHYS checks for 1 hour; +1 movement bonus for 1 hour. After 1 hour, +1 penalty die to all PHYS checks and +1 movement penalty until sleep.",uses:1,addictionScore:3,legality:"Illegal",bulk:1,cost:8e3}],ua={narcotics:da},ma=ua.narcotics;function ha(){return`inv_${Date.now()}_${Math.random().toString(36).slice(2,9)}`}function xa(t){const s=t.sheet.inventory??[],y=a=>{t.onChange({inventory:a})},[x,C]=S.useState("item"),[b,o]=S.useState(null),[i,p]=S.useState({}),[B,K]=S.useState(null),[k,P]=S.useState(null),ee=S.useMemo(()=>x==="item"?ra.map(a=>({type:"item",...a})):x==="cyberware"?ca.map(a=>({type:"cyberware",...a})):ma.map(a=>({type:"narcotics",...a})),[x]);function re(a){o(a);const n=ee.find(T=>T.name===a);if(!n){p({type:x,name:"",quantity:1,bulk:x==="item"?0:1,effect:"",cost:0,statusEffects:""});return}p(x==="item"?{type:"item",name:n.name,quantity:1,uses:n.uses??"",bulk:n.bulk??0,effect:n.effect??"",cost:n.cost??0,statusEffects:n.statusEffects??""}:x==="cyberware"?{type:"cyberware",name:n.name,quantity:1,bulk:n.bulk??1,tier:n.tier??1,installationDifficulty:n.installationDifficulty??0,requirements:n.requirements??"",physicalImpact:n.physicalImpact??"",effect:n.effect??"",cost:n.cost??0,statusEffects:n.statusEffects??""}:{type:"narcotics",name:n.name,quantity:1,bulk:n.bulk??1,uses:n.uses??1,addictionScore:n.addictionScore??0,legality:n.legality??"",effect:n.effect??"",cost:n.cost??0,statusEffects:n.statusEffects??""})}function le(){const a=[...s,{id:ha(),...i}];t.onChange({inventory:a}),o(null),p({type:x,name:"",quantity:1,bulk:x==="item"?0:1,effect:"",cost:0,statusEffects:""})}function X(a){t.onChange({inventory:s.filter(n=>n.id!==a)})}function m(a,n){t.onChange({inventory:s.map(T=>T.id===a?{...T,...n}:T)})}return e.jsxs(_,{spacing:2,children:[e.jsx(g,{label:"Credits",type:"number",value:t.sheet.credits??0,onChange:a=>t.onChange({credits:Number(a.target.value)}),size:"small"}),e.jsxs(E,{children:[e.jsx(D,{variant:"subtitle2",sx:{mb:1},children:"Add Inventory"}),e.jsxs(_,{direction:{xs:"column",sm:"row"},spacing:1,alignItems:"center",children:[e.jsxs(g,{select:!0,size:"small",label:"Type",value:x,onChange:a=>{const n=a.target.value;C(n),o(null),p(n==="item"?{type:n,name:"",quantity:1,bulk:0,uses:"",effect:"",cost:0,statusEffects:""}:n==="cyberware"?{type:n,name:"",quantity:1,bulk:1,tier:1,installationDifficulty:0,requirements:"",physicalImpact:"",effect:"",cost:0,statusEffects:""}:{type:n,name:"",quantity:1,bulk:1,uses:1,addictionScore:0,legality:"",effect:"",cost:0,statusEffects:""})},sx:{minWidth:160},children:[e.jsx(de,{value:"item",children:"Item"}),e.jsx(de,{value:"cyberware",children:"Cyberware"}),e.jsx(de,{value:"narcotics",children:"Narcotics"})]}),e.jsx(Et,{size:"small",sx:{flex:1,minWidth:220},options:ee.map(a=>a.name),value:b,onChange:(a,n)=>re(n),renderInput:a=>e.jsx(g,{...a,label:"Template (optional)"})}),e.jsx(ue,{variant:"contained",startIcon:e.jsx(ke,{}),onClick:le,disabled:!(i!=null&&i.name),children:"Add"})]}),e.jsx(E,{sx:{mt:1},children:e.jsxs(_,{spacing:1,children:[e.jsxs(_,{direction:{xs:"column",sm:"row"},spacing:1,children:[e.jsx(g,{size:"small",label:"Name",value:(i==null?void 0:i.name)??"",onChange:a=>p(n=>({...n,name:a.target.value})),sx:{flex:1}}),e.jsx(g,{size:"small",type:"number",label:"Bulk",value:(i==null?void 0:i.bulk)??0,onChange:a=>p(n=>({...n,bulk:Number(a.target.value)})),sx:{width:120}}),e.jsx(g,{size:"small",type:"number",label:"Quantity",value:(i==null?void 0:i.quantity)??1,onChange:a=>{const n=Number(a.target.value);Number.isFinite(n)&&p(T=>({...T,quantity:n}))},sx:{width:120}}),e.jsx(g,{size:"small",type:"number",label:"Cost",value:(i==null?void 0:i.cost)??0,onChange:a=>p(n=>({...n,cost:Number(a.target.value)})),sx:{width:140}})]}),x==="item"&&e.jsx(g,{size:"small",label:"Uses",value:(i==null?void 0:i.uses)??"",onChange:a=>p(n=>({...n,uses:a.target.value}))}),x==="cyberware"&&e.jsxs(_,{direction:{xs:"column",sm:"row"},spacing:1,children:[e.jsx(g,{size:"small",type:"number",label:"Tier",value:(i==null?void 0:i.tier)??1,onChange:a=>p(n=>({...n,tier:Number(a.target.value)})),sx:{width:120}}),e.jsx(g,{size:"small",type:"number",label:"Installation Difficulty",value:(i==null?void 0:i.installationDifficulty)??0,onChange:a=>p(n=>({...n,installationDifficulty:Number(a.target.value)})),sx:{width:220}}),e.jsx(g,{size:"small",label:"Requirements",value:(i==null?void 0:i.requirements)??"",onChange:a=>p(n=>({...n,requirements:a.target.value})),sx:{flex:1}})]}),x==="cyberware"&&e.jsx(g,{size:"small",label:"Physical Impact",value:(i==null?void 0:i.physicalImpact)??"",onChange:a=>p(n=>({...n,physicalImpact:a.target.value}))}),x==="narcotics"&&e.jsxs(_,{direction:{xs:"column",sm:"row"},spacing:1,children:[e.jsx(g,{size:"small",type:"number",label:"Uses",value:(i==null?void 0:i.uses)??1,onChange:a=>p(n=>({...n,uses:Number(a.target.value)})),sx:{width:120}}),e.jsx(g,{size:"small",type:"number",label:"Addiction Score",value:(i==null?void 0:i.addictionScore)??0,onChange:a=>p(n=>({...n,addictionScore:Number(a.target.value)})),sx:{width:160}}),e.jsx(g,{size:"small",label:"Legality",value:(i==null?void 0:i.legality)??"",onChange:a=>p(n=>({...n,legality:a.target.value})),sx:{flex:1}})]}),e.jsx(g,{size:"small",label:"Effect",value:(i==null?void 0:i.effect)??"",onChange:a=>p(n=>({...n,effect:a.target.value})),multiline:!0,minRows:2}),e.jsx(g,{size:"small",label:"Status Effects (comma-separated)",value:(i==null?void 0:i.statusEffects)??"",onChange:a=>p(n=>({...n,statusEffects:a.target.value})),placeholder:'e.g. "carrying_capacity+5"'})]})})]}),e.jsxs(E,{children:[e.jsx(D,{variant:"subtitle2",sx:{mb:1},children:"Inventory"}),s.length===0&&e.jsx(D,{variant:"body2",children:"No inventory items yet."}),s.map(a=>{const n=a.quantity??1,v=(a.bulk??0)*n,A=`${a.name} (${a.type}) • bulk ${v}`;return e.jsxs(Me,{disableGutters:!0,children:[e.jsx(De,{expandIcon:e.jsx(Te,{}),draggable:!0,onDragStart:h=>{K(a.id??null);try{h.dataTransfer.effectAllowed="move",h.dataTransfer.setData("text/plain",a.id??"")}catch{}},onDragOver:h=>{h.preventDefault(),P(a.id??null)},onDragLeave:()=>P(null),onDrop:h=>{h.preventDefault();const W=B??h.dataTransfer.getData("text/plain"),J=a.id;if(W&&J&&W!==J){const j=t.sheet.inventory??[],q=j.findIndex(H=>H.id===W),Q=j.findIndex(H=>H.id===J);if(q>=0&&Q>=0){const H=[...j],[c]=H.splice(q,1);H.splice(Q,0,c),y(H)}}K(null),P(null)},sx:k===a.id?{outline:"2px dashed rgba(255,255,255,0.35)",borderRadius:1}:void 0,children:e.jsxs(_,{direction:"row",spacing:1,alignItems:"center",sx:{width:"100%"},children:[e.jsx(Nt,{fontSize:"small",sx:{opacity:.5}}),e.jsx(D,{variant:"body2",sx:{flex:1},children:A}),e.jsxs(_,{direction:"row",spacing:.5,alignItems:"center",children:[e.jsx(ie,{size:"small",onClick:h=>{h.stopPropagation();const W=(a.quantity??1)-1;W<=0?X(a.id):m(a.id,{quantity:W})},children:e.jsx(ct,{fontSize:"small"})}),e.jsx(D,{variant:"caption",sx:{minWidth:18,textAlign:"center"},children:a.quantity??1}),e.jsx(ie,{size:"small",onClick:h=>{h.stopPropagation(),m(a.id,{quantity:(a.quantity??1)+1})},children:e.jsx(ke,{fontSize:"small"})})]}),e.jsx(ye,{title:"Remove",children:e.jsx(ie,{size:"small",onClick:h=>(h.stopPropagation(),X(a.id)),children:e.jsx(Le,{fontSize:"small"})})})]})}),e.jsx(Ae,{children:e.jsxs(_,{spacing:1,children:[e.jsxs(_,{direction:{xs:"column",sm:"row"},spacing:1,children:[e.jsx(g,{size:"small",label:"Name",value:a.name??"",onChange:h=>m(a.id,{name:h.target.value}),sx:{flex:1}}),e.jsxs(g,{select:!0,size:"small",label:"Type",value:a.type,onChange:h=>m(a.id,{type:h.target.value}),sx:{width:160},children:[e.jsx(de,{value:"item",children:"Item"}),e.jsx(de,{value:"cyberware",children:"Cyberware"}),e.jsx(de,{value:"narcotics",children:"Narcotics"})]}),e.jsx(g,{size:"small",type:"number",label:"Bulk",value:a.bulk??0,onChange:h=>m(a.id,{bulk:Number(h.target.value)}),sx:{width:120}}),e.jsx(g,{size:"small",type:"number",label:"Quantity",value:a.quantity??1,onChange:h=>{const W=Number(h.target.value);Number.isFinite(W)&&(W<=0?X(a.id):m(a.id,{quantity:W}))},sx:{width:120}}),e.jsx(g,{size:"small",type:"number",label:"Cost",value:a.cost??0,onChange:h=>m(a.id,{cost:Number(h.target.value)}),sx:{width:140}})]}),a.type==="item"&&e.jsx(g,{size:"small",label:"Uses",value:a.uses??"",onChange:h=>m(a.id,{uses:h.target.value})}),a.type==="cyberware"&&e.jsxs(_,{direction:{xs:"column",sm:"row"},spacing:1,children:[e.jsx(g,{size:"small",type:"number",label:"Tier",value:a.tier??1,onChange:h=>m(a.id,{tier:Number(h.target.value)}),sx:{width:120}}),e.jsx(g,{size:"small",type:"number",label:"Installation Difficulty",value:a.installationDifficulty??0,onChange:h=>m(a.id,{installationDifficulty:Number(h.target.value)}),sx:{width:220}}),e.jsx(g,{size:"small",label:"Requirements",value:a.requirements??"",onChange:h=>m(a.id,{requirements:h.target.value}),sx:{flex:1}})]}),a.type==="cyberware"&&e.jsx(g,{size:"small",label:"Physical Impact",value:a.physicalImpact??"",onChange:h=>m(a.id,{physicalImpact:h.target.value})}),a.type==="narcotics"&&e.jsxs(_,{direction:{xs:"column",sm:"row"},spacing:1,children:[e.jsx(g,{size:"small",type:"number",label:"Uses",value:a.uses??1,onChange:h=>m(a.id,{uses:Number(h.target.value)}),sx:{width:120}}),e.jsx(g,{size:"small",type:"number",label:"Addiction Score",value:a.addictionScore??0,onChange:h=>m(a.id,{addictionScore:Number(h.target.value)}),sx:{width:160}}),e.jsx(g,{size:"small",label:"Legality",value:a.legality??"",onChange:h=>m(a.id,{legality:h.target.value}),sx:{flex:1}})]}),e.jsx(g,{size:"small",label:"Effect",value:a.effect??"",onChange:h=>m(a.id,{effect:h.target.value}),multiline:!0,minRows:2}),e.jsx(g,{size:"small",label:"Status Effects (comma-separated)",value:a.statusEffects??"",onChange:h=>m(a.id,{statusEffects:h.target.value}),placeholder:'e.g. "carrying_capacity+5"'})]})})]},a.id)})]})]})}function fa(){const[t,s]=S.useState({entries:[],activeTokenId:void 0,updatedAt:Date.now()}),[y,x]=S.useState({}),[C,b]=S.useState(""),[o,i]=S.useState(!1),[p,B]=S.useState(0),K=m=>Math.max(-3,Math.min(3,m)),k=S.useMemo(()=>Je(),[]);S.useEffect(()=>{const m=pt(a=>s(a));return()=>m==null?void 0:m()},[]),S.useEffect(()=>{let m=!0;return(async()=>{var a,n,T,v;try{const[A,h]=await Promise.all([((n=(a=$.player).getId)==null?void 0:n.call(a))??Promise.resolve(""),((v=(T=$.player).getRole)==null?void 0:v.call(T))??Promise.resolve("")]);if(!m)return;b(String(A??"")),i(String(h).toUpperCase()==="GM")}catch{}})(),()=>{m=!1}},[]);const P=S.useMemo(()=>{const m=[...t.entries??[]];return m.sort((a,n)=>(n.initiative??0)-(a.initiative??0)),m},[t.entries]);S.useEffect(()=>{let m=!0;return(async()=>{var a,n,T,v,A,h,W;try{const J=P.map(Q=>Q.tokenId);if(!J.length){m&&x({});return}const j=await $.scene.items.getItems(J),q={};for(const Q of j){const H=Q.id,c=await Ee(H),f=c==null?void 0:c.armor,L=((a=f==null?void 0:f.durability)==null?void 0:a.current)??0,G=!!f&&L<=0,V=G?0:(f==null?void 0:f.protection)??0,O=(n=c==null?void 0:c.weapons)==null?void 0:n[0],me=be(O),pe=Number.isFinite(O==null?void 0:O.ammo)?Number(O==null?void 0:O.ammo):0;q[H]={tokenId:H,name:((A=(v=(T=Q.text)==null?void 0:T.plainText)==null?void 0:v.trim)==null?void 0:A.call(v))||(c==null?void 0:c.name)||"(Unnamed)",thumbUrl:(h=Q.image)==null?void 0:h.url,ownerPlayerId:String(((W=Q.metadata)==null?void 0:W[lt])??""),prot:V,armorBroken:G,topWeaponName:O==null?void 0:O.name,topWeaponUseDC:O==null?void 0:O.useDC,topWeaponDamage:O==null?void 0:O.damage,topWeaponSkillId:O==null?void 0:O.skillId,topWeaponAmmo:pe,topWeaponAmmoMax:me}}m&&x(q)}catch{}})(),()=>{m=!1}},[P]);async function ee(m){var c,f,L,G,V;const[a]=await $.scene.items.getItems([m]);if(!a)return;const n=await Ee(m);if(!n)return;const T=Ze([...(n.feats??[]).map(O=>O.statusEffects??"").filter(Boolean),...(n.inventory??[]).map(O=>O.statusEffects??"").filter(Boolean)]).deltas,v=Se(n.skills??{}),A=((c=n.stress)==null?void 0:c.current)??0,h=Math.max(0,(Pe(n.skills??{})||0)-(((f=n.stress)==null?void 0:f.cufLoss)??0)),W=Ct({attributes:v,stress:{current:A,cuf:h}},T),J=W.stress.cuf??h,j=W.attributes.ref??v.ref??0,q=A>J,Q=ze({netDice:q?-1:0,modifier:j,label:`${((L=a.text)==null?void 0:L.plainText)??n.name??"Token"} Initiative`}),H=await Ke({diceNotation:Q,rollTarget:"everyone",showResults:!0});await St({tokenId:m,initiative:H,name:((G=a.text)==null?void 0:G.plainText)??n.name??"Token",thumbUrl:(V=a.image)==null?void 0:V.url})}async function re(){var v,A;const m=await((A=(v=$.player).getSelection)==null?void 0:A.call(v))??[],a=m==null?void 0:m[0],n=await ot()??void 0,T=a||n;if(!T){$.notification.show("Select a token (or set your character) to roll initiative.","WARNING");return}await ee(T)}async function le(m){var c,f,L;const a=await Ee(m);if(!a)return;const n=(c=a.weapons)==null?void 0:c[0];if(!n){$.notification.show("No weapon in the top slot.","WARNING");return}const T=Ze([...(a.feats??[]).map(G=>G.statusEffects??"").filter(Boolean),...(a.inventory??[]).map(G=>G.statusEffects??"").filter(Boolean)]).deltas,A=(Pe(a.skills??{})-(((f=a.stress)==null?void 0:f.cufLoss)??0)||0)+(T.cool_under_fire??0),W=(((L=a.stress)==null?void 0:L.current)??0)>A,J=String(n.skillId??""),j=mt({learnedInfoById:k,sheet:a,skillId:J,skillMods:T}),q=be(n),Q=Number.isFinite(n==null?void 0:n.ammo)?Number(n==null?void 0:n.ammo):0;if(q>0&&Q<=0){$.notification.show("Out of ammo. Reload first.","WARNING");return}const H=K(p-(W?1:0));if(await xt({weapon:n,netDice:H,modifier:j,attackerName:a.name,rollTarget:"everyone",showResults:!0}),q>0){const G=Math.max(0,Q-1),V=[...a.weapons??[]];V[0]={...V[0],ammo:G},await Ge(m,{...a,weapons:V})}}async function X(m){var A;const a=await Ee(m);if(!a)return;const n=(A=a.weapons)==null?void 0:A[0];if(!n)return;const T=be(n);if(T<=0)return;const v=[...a.weapons??[]];v[0]={...v[0],ammo:T},await Ge(m,{...a,weapons:v})}return e.jsxs(_,{spacing:2,children:[e.jsxs(E,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",gap:1,flexWrap:"wrap"},children:[e.jsx(D,{variant:"h6",sx:{m:0},children:"Initiative"}),e.jsxs(_,{direction:"row",spacing:1,alignItems:"center",children:[e.jsx(ue,{size:"small",variant:"contained",onClick:()=>void re(),startIcon:e.jsx(Ie,{}),children:"Roll Initiative"}),e.jsxs(E,{sx:{display:"flex",alignItems:"center",gap:1,flexWrap:"wrap",pl:1},children:[e.jsx(D,{variant:"body2",sx:{opacity:.8},children:"Attack Roll:"}),e.jsxs(We,{size:"small",exclusive:!0,value:p,onChange:(m,a)=>{a!==null&&B(a)},children:[e.jsx(Z,{value:-2,children:"−2"}),e.jsx(Z,{value:-1,children:"−1"}),e.jsx(Z,{value:0,children:"0"}),e.jsx(Z,{value:1,children:"+1"}),e.jsx(Z,{value:2,children:"+2"})]})]}),o&&e.jsxs(e.Fragment,{children:[e.jsx(ue,{size:"small",variant:"outlined",onClick:()=>kt(),children:"Clear"}),e.jsx(ue,{size:"small",variant:"outlined",onClick:()=>vt(),children:"Advance"})]})]})]}),e.jsx(Pt,{}),P.length===0?e.jsx(D,{variant:"body2",sx:{opacity:.75},children:"No initiative rolls yet."}):e.jsx(zt,{dense:!0,disablePadding:!0,children:P.map(m=>{const a=y[m.tokenId],n=a==null?void 0:a.ownerPlayerId,T=o||!!n&&n===C,v=t.activeTokenId===m.tokenId,A=v&&T&&!o,h=!!m.surprised,W=(a==null?void 0:a.topWeaponAmmoMax)??0,J=(a==null?void 0:a.topWeaponAmmo)??0,j=W>0&&J<=0;return e.jsxs(Wt,{sx:{borderRadius:1,mb:.5,bgcolor:v?"rgba(255,255,255,0.06)":"transparent",opacity:h?.55:1},secondaryAction:e.jsxs(_,{direction:"row",spacing:.5,alignItems:"center",children:[e.jsx(ye,{title:a!=null&&a.armorBroken?"Armor broken":"Protection",children:e.jsxs(E,{sx:{display:"inline-flex",alignItems:"center",gap:.5,px:1,py:.5,borderRadius:1,bgcolor:"rgba(0,0,0,0.25)"},children:[e.jsx(Ot,{fontSize:"small",sx:{color:a!=null&&a.armorBroken?"error.main":"inherit"}}),e.jsx(D,{variant:"caption",children:(a==null?void 0:a.prot)??0})]})}),(o||T)&&e.jsx(ye,{title:a!=null&&a.topWeaponName?j?`Out of ammo: ${a.topWeaponName}`:`Attack: ${a.topWeaponName}`:"No top weapon",children:e.jsx("span",{children:e.jsx(ie,{size:"small",disabled:!(a!=null&&a.topWeaponName)||j,onClick:()=>void le(m.tokenId),children:e.jsx(Ie,{fontSize:"small"})})})}),(o||T)&&e.jsx(ye,{title:a!=null&&a.topWeaponName?W<=0?"No ammo to reload":`Reload: ${a.topWeaponName}`:"No top weapon",children:e.jsx("span",{children:e.jsx(ie,{size:"small",disabled:!(a!=null&&a.topWeaponName)||W<=0,onClick:()=>void X(m.tokenId),children:e.jsx(dt,{fontSize:"small"})})})}),e.jsx(ye,{title:T||o?"Remove":"Only the owner or GM can remove",children:e.jsx("span",{children:e.jsx(ie,{size:"small",disabled:!T&&!o,onClick:()=>wt(m.tokenId),children:e.jsx(Le,{fontSize:"small"})})})})]}),children:[e.jsx(Lt,{children:e.jsx(Ft,{src:a==null?void 0:a.thumbUrl,variant:"rounded",sx:{width:32,height:32,mr:1,cursor:"pointer"}})}),e.jsx(Bt,{primary:e.jsxs(E,{sx:{display:"flex",alignItems:"center",gap:1,flexWrap:"wrap"},children:[e.jsx(D,{variant:"body2",sx:{fontWeight:600},children:(a==null?void 0:a.name)??m.name??"Token"}),e.jsx(D,{variant:"caption",sx:{opacity:.75},children:m.initiative}),A&&e.jsx(D,{variant:"caption",sx:{px:1,py:.25,borderRadius:1,bgcolor:"rgba(0,128,255,0.2)"},children:"Your Turn"})]}),secondary:e.jsxs(E,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(_t,{size:"small",checked:h,disabled:!o,onChange:q=>jt(m.tokenId,q.target.checked)}),e.jsx(D,{variant:"caption",sx:{opacity:.75},children:"Surprised"})]})})]},m.tokenId)})})]})}function ga(t){return e.jsxs("div",{style:{display:"flex",alignItems:"flex-start",gap:12,justifyContent:"space-between",marginBottom:10},children:[e.jsxs("div",{style:{display:"flex",gap:10,alignItems:"flex-start"},children:[t.thumbUrl?e.jsx("img",{src:t.thumbUrl,alt:"Token thumbnail",style:{width:44,height:44,borderRadius:10,objectFit:"cover",border:"1px solid rgba(0,0,0,0.2)"}}):e.jsx("div",{style:{width:44,height:44,borderRadius:10,border:"1px solid rgba(0,0,0,0.2)",opacity:.4}}),e.jsxs("div",{children:[e.jsxs("div",{style:{fontSize:18,fontWeight:700},children:[t.title," ",e.jsxs("span",{style:{fontSize:12,opacity:.75},children:["(",t.ownerLabel,")"]})]}),e.jsxs("div",{style:{fontSize:12,opacity:.8},children:["Token: ",e.jsx("code",{style:{fontSize:11},children:t.tokenId})]})]})]}),e.jsxs("div",{style:{display:"flex",gap:8},children:[t.showBackButton&&e.jsx("button",{style:{padding:"8px 10px",borderRadius:8,border:"1px solid #999",cursor:"pointer",opacity:.9},onClick:t.onBack,children:"Back to My Sheet"}),t.showUnsetButton&&e.jsx("button",{style:{padding:"8px 10px",borderRadius:8,border:"1px solid #999",cursor:"pointer",opacity:.9},onClick:t.onUnset,children:"Unset “My Character”"})]})]})}function ya(t){var s,y,x;return e.jsxs("div",{style:se.statusBar,children:[e.jsxs("div",{style:se.statusLeft,children:[e.jsxs("div",{style:se.statusGroup,children:[e.jsx("div",{style:se.statusLabel,children:"Stress"}),e.jsx("input",{type:"number",min:0,value:((s=t.sheet.stress)==null?void 0:s.current)??0,onChange:C=>t.applyStress(Number(C.target.value)),style:se.statusNumber})]}),e.jsxs("div",{style:se.statusGroup,children:[e.jsx("div",{style:se.statusLabel,children:"Wounds"}),e.jsxs("div",{style:se.woundsRow,children:[e.jsx("span",{style:se.woundsKind,children:"L"}),Array.from({length:4}).map((C,b)=>{var o;return e.jsx("input",{type:"checkbox",checked:(((o=t.sheet.wounds)==null?void 0:o.light)??0)>b,onChange:()=>t.toggleWound("light",b)},`wl_${b}`)}),e.jsx("span",{style:{width:8}}),e.jsx("span",{style:se.woundsKind,children:"M"}),Array.from({length:2}).map((C,b)=>{var o;return e.jsx("input",{type:"checkbox",checked:(((o=t.sheet.wounds)==null?void 0:o.moderate)??0)>b,onChange:()=>t.toggleWound("moderate",b)},`wm_${b}`)}),e.jsx("span",{style:{width:8}}),e.jsx("span",{style:se.woundsKind,children:"H"}),Array.from({length:1}).map((C,b)=>{var o;return e.jsx("input",{type:"checkbox",checked:(((o=t.sheet.wounds)==null?void 0:o.heavy)??0)>b,onChange:()=>t.toggleWound("heavy",b)},`wh_${b}`)})]})]}),e.jsxs("label",{style:{display:"flex",alignItems:"center",gap:6},children:[e.jsx("input",{type:"checkbox",checked:!!t.sheet.indomitable,onChange:C=>t.setIndomitable(C.target.checked)}),e.jsx("span",{style:{fontSize:12,opacity:.9},children:"Indomitable"})]}),(((y=t.sheet.stress)==null?void 0:y.current)??0)>(((x=t.sheetForView.stress)==null?void 0:x.cuf)??0)&&e.jsx("div",{style:se.warning,children:"Stress > CUF: make all rolls with +1 Penalty Die"}),e.jsxs("div",{style:{fontSize:12,opacity:.85},children:["Bulk: ",t.totalBulk," / ",t.effectiveCarryingCapacity]}),t.encumbranceLabel&&e.jsx("div",{style:se.warning,children:t.encumbranceLabel})]}),e.jsxs("div",{style:se.statusRight,children:[t.crucible&&t.crucible.status==="pending"&&e.jsxs("div",{style:se.crucibleBox,children:[e.jsx("div",{style:{fontWeight:700},children:"Crucible Test!"}),e.jsxs("div",{style:{fontSize:12,opacity:.85},children:["Incoming stress: ",t.crucible.incoming," • DC ",t.crucible.dc," • Roll CUF (no bonus/penalty dice)"]}),e.jsx("button",{style:se.buttonSecondary,onClick:()=>t.rollCrucibleTest(t.crucible.incoming),children:"Roll Crucible"})]}),t.crucible&&t.crucible.status==="success"&&e.jsxs("div",{style:se.crucibleBox,children:[e.jsx("div",{style:{fontWeight:700},children:"Crucible succeeded!"}),e.jsx("div",{style:{fontSize:12,opacity:.85},children:"Choose an Indomitable effect. (Indomitable checked automatically.)"})]}),t.crucible&&t.crucible.status==="fail"&&e.jsxs("div",{style:se.crucibleBox,children:[e.jsx("div",{style:{fontWeight:700},children:"Crucible failed"}),e.jsx("div",{style:{fontSize:12,opacity:.85},children:"You’ve entered PTSD range (6–8 stress)."}),e.jsx("button",{style:se.buttonSecondary,onClick:t.burnCufToPass,children:"Spend 1 CUF to pass"})]})]})]})}const se={statusBar:{display:"flex",alignItems:"flex-start",justifyContent:"space-between",gap:12,padding:"10px 12px",borderRadius:12,border:"1px solid rgba(255,255,255,0.15)",marginBottom:10},statusLeft:{display:"flex",alignItems:"center",gap:16,flexWrap:"wrap"},statusRight:{display:"flex",alignItems:"center",gap:12},statusGroup:{display:"flex",flexDirection:"column",gap:4},statusLabel:{fontSize:11,opacity:.75,letterSpacing:.2},statusNumber:{width:64,fontSize:16},woundsRow:{display:"flex",alignItems:"center",gap:8,flexWrap:"wrap"},woundsKind:{fontSize:11,opacity:.75,width:14,textAlign:"center"},warning:{marginTop:8,fontSize:12,opacity:.9},crucibleBox:{border:"1px solid rgba(255,255,255,0.18)",borderRadius:12,padding:10,maxWidth:240},buttonSecondary:{padding:"6px 10px",borderRadius:8,border:"1px solid #999",cursor:"pointer",opacity:.9,background:"transparent"}};function ba(t){const s=ut(),y=s.palette.text.primary,x=s.palette.mode==="dark"?"rgba(255,255,255,0.25)":"#777",C=s.palette.mode==="dark"?"rgba(255,255,255,0.12)":"transparent";return e.jsxs("div",{style:{display:"flex",gap:8,alignItems:"center",marginBottom:10},children:[e.jsx(je,{label:"Core",active:t.activeTab==="core",onClick:()=>t.onTab("core"),color:y,borderColor:x,activeBg:C}),e.jsx(je,{label:"Skills",active:t.activeTab==="skills",onClick:()=>t.onTab("skills"),color:y,borderColor:x,activeBg:C}),e.jsx(je,{label:"Combat",active:t.activeTab==="combat",onClick:()=>t.onTab("combat"),color:y,borderColor:x,activeBg:C}),e.jsx(je,{label:"Initiative",active:t.activeTab==="initiative",onClick:()=>t.onTab("initiative"),color:y,borderColor:x,activeBg:C}),e.jsx(je,{label:"Inventory",active:t.activeTab==="inventory",onClick:()=>t.onTab("inventory"),color:y,borderColor:x,activeBg:C}),e.jsx(je,{label:"Feats",active:t.activeTab==="feats",onClick:()=>t.onTab("feats"),color:y,borderColor:x,activeBg:C}),e.jsx("div",{style:{marginLeft:"auto",opacity:.8},children:t.isSaving?"Saving…":"Synced"})]})}function je(t){return ut().palette.mode,e.jsx("button",{onClick:t.onClick,style:{padding:"6px 10px",borderRadius:999,border:`1px solid ${t.borderColor}`,cursor:"pointer",background:t.active?t.activeBg:"transparent",fontWeight:t.active?700:400,color:t.color,outline:"none",boxShadow:"none",appearance:"none"},children:t.label})}function pa(){var Re,Ve,Qe,Xe;const[t,s]=S.useState({kind:"loading"}),[y,x]=S.useState("core"),[C,b]=S.useState(!1),[o,i]=S.useState(null),[p,B]=S.useState(!1),[K,k]=S.useState([]);async function P(u){var r,M,I,R,z,F;try{const Y=await $.scene.items.getItems([u]),N=Y==null?void 0:Y[0];if(!N)return{ownerLabel:"unowned",thumbUrl:null};const ae=((r=N==null?void 0:N.image)==null?void 0:r.url)??((M=N==null?void 0:N.image)==null?void 0:M.href)??(N==null?void 0:N.imageUrl)??(N==null?void 0:N.image)??((I=N==null?void 0:N.thumbnail)==null?void 0:I.url)??null,ne=(R=N==null?void 0:N.metadata)==null?void 0:R[lt];if(typeof ne!="string"||ne.length===0)return{ownerLabel:"unowned",thumbUrl:ae,ownerPlayerId:null,isOwnedByMe:!1};const ce=await $.player.getId();if(ne===ce)return{ownerLabel:"owned by you",thumbUrl:ae,ownerPlayerId:ne,isOwnedByMe:!0};try{const U=(await((F=(z=$.party).getPlayers)==null?void 0:F.call(z))??[]).find(xe=>(xe==null?void 0:xe.id)===ne);return{ownerLabel:`owned by ${typeof(U==null?void 0:U.name)=="string"&&U.name.length>0?U.name:ne}`,thumbUrl:ae,ownerPlayerId:ne,isOwnedByMe:!1}}catch{return{ownerLabel:`owned by ${ne}`,thumbUrl:ae,ownerPlayerId:ne,isOwnedByMe:!1}}}catch{return{ownerLabel:"unowned",thumbUrl:null,ownerPlayerId:null,isOwnedByMe:!1}}}async function ee(u){const r=u!=null&&u.ignoreOpenOverride?null:await Mt();if(r)if(await Oe(r)){const ne=await Be(r);if(!ne)throw new Error("Could not load sheet from token.");const ce=Se(ne.skills??{}),he={...ne,attributes:ce},U=await P(r);s({kind:"ready",tokenId:r,sheet:he,mode:"view",suppressUnset:!0,...U});return}else await _e(null);let I=await ot();if(I||(I=await et(),I&&await we(I)),!I){s({kind:"need-token"});return}let R=await Oe(I);if(!R){const ae=await et();ae&&(I=ae,await we(I),R=await Oe(I))}if(!R){await we(null),s({kind:"need-token"});return}const z=await Be(I);if(!z)throw new Error("Could not load sheet from token.");try{await tt(I)}catch{}const F=Se(z.skills??{}),Y={...z,attributes:F},N=await P(I);s({kind:"ready",tokenId:I,sheet:Y,mode:"my",suppressUnset:!!(u!=null&&u.suppressUnset),...N})}S.useEffect(()=>{let u=!1;return $.onReady(async()=>{try{const r=await $.player.getRole();u||B(String(r).toUpperCase()==="GM"),await ee()}catch(r){u||s({kind:"error",message:r.message??"Unknown error"})}}),()=>{u=!0}},[]),S.useEffect(()=>{let u=null,r=!1;return $.onReady(()=>{r||(u=$.broadcast.onMessage(Ye,M=>{const I=M.data;I!=null&&I.text&&k(R=>[...R,I].slice(-3))}))}),()=>{if(r=!0,typeof u=="function")try{u()}catch{}}},[]),S.useEffect(()=>{let u=null,r=null,M=!1;const I="whisperspace.combatLogLeader",R=2e3,z=6e3,F=`${Date.now()}-${Math.random().toString(36).slice(2,10)}`,Y=()=>{try{const U=localStorage.getItem(I);return U?JSON.parse(U):null}catch{return null}},N=U=>{try{localStorage.setItem(I,JSON.stringify({id:F,ts:U??Date.now()}))}catch{}},ae=()=>{const U=Y();return U&&U.id===F},ne=()=>{const U=Date.now(),oe=Y();(!oe||U-(oe.ts??0)>z||oe.id===F)&&N(U)},ce=()=>{const U=ae();if(U&&!u)u=$.broadcast.onMessage(Ye,oe=>{const xe=oe.data;xe!=null&&xe.text&&$.notification.show(String(xe.text),"INFO")});else if(!U&&u){try{u()}catch{}u=null}},he=U=>{U.key===I&&ce()};return $.onReady(()=>{if(!M){try{window.addEventListener("storage",he)}catch{}ne(),ce(),r=window.setInterval(()=>{M||(ne(),ce())},R)}}),()=>{M=!0;try{window.removeEventListener("storage",he)}catch{}if(r!==null&&clearInterval(r),ae())try{localStorage.removeItem(I)}catch{}if(typeof u=="function")try{u()}catch{}}},[]);function re(u,r,M){const I={text:`${u} took ${r} damage${M?` and +${M} stress`:""}.`,ts:Date.now(),kind:"effect",targetName:u,damageApplied:r,stressApplied:M};k(R=>[...R,I].slice(-3))}function le(u){if(t.kind!=="ready"||t.mode!=="my")return;const r=Math.max(0,Math.trunc(u.damageApplied??0)),M=Math.max(0,Math.trunc(u.stressApplied??0));r<=0&&M<=0||v(I=>{var z;const R=ft({sheet:I,incomingDamage:r,stressDelta:M});return R.stressDelta>0&&h(((z=R.sheet.stress)==null?void 0:z.current)??0),re(t.sheet.name||"Target",r,M),R.sheet})}S.useEffect(()=>{var R,z,F,Y;if(t.kind!=="ready")return;const u=t.tokenId;let r=!1;const M=async()=>{var N,ae;try{const ne=await $.scene.items.getItems([u]),ce=ne==null?void 0:ne[0],he=String(((N=ce==null?void 0:ce.text)==null?void 0:N.plainText)??"").trim(),U=(ae=ce==null?void 0:ce.image)==null?void 0:ae.url;if(r||!he&&!U)return;s(oe=>{if(oe.kind!=="ready"||oe.tokenId!==u)return oe;const xe=he&&oe.sheet.name!==he?{...oe.sheet,name:he}:oe.sheet;return{...oe,sheet:xe,thumbUrl:U??oe.thumbUrl}})}catch{}};M();const I=(Y=(F=(z=(R=$)==null?void 0:R.scene)==null?void 0:z.items)==null?void 0:F.onChange)==null?void 0:Y.call(F,N=>{Array.isArray(N)&&N.some(ae=>(ae==null?void 0:ae.id)===u)&&M()});return()=>{r=!0,typeof I=="function"&&I()}},[t.kind,t.kind==="ready"?t.tokenId:null]);const X=S.useMemo(()=>t.kind==="ready"&&t.sheet.name||"Whisperspace Character Sheet",[t]);async function m(){const u=await $t();if(!u){s({kind:"error",message:"No token selected. Select a token on the map first."});return}const r=await Be(u);if(!r){s({kind:"error",message:"Could not attach a sheet to the selected token."});return}const M=Se(r.skills??{}),I={...r,attributes:M};await we(u);try{await tt(u)}catch{}await _e(null);const R=await P(u);s({kind:"ready",tokenId:u,sheet:I,mode:"my",suppressUnset:!1,...R})}async function a(){await we(null);try{await Dt()}catch{}s({kind:"need-token"})}async function n(){await _e(null),s({kind:"loading"});try{await ee({ignoreOpenOverride:!0,suppressUnset:!0})}catch(u){s({kind:"error",message:u.message??"Unknown error"})}}async function T(u,r){b(!0);try{await Ge(u,r)}finally{b(!1)}}function v(u){s(r=>{if(r.kind!=="ready")return r;let M=u(r.sheet);try{const I=Se(M.skills??{});M={...M,attributes:{...M.attributes,...I},stress:{...M.stress??{current:0,cuf:0,cufLoss:0},cuf:Pe(M.skills??{})}}}catch{}return T(r.tokenId,M),{...r,sheet:M}})}async function A(u){var Y;if(t.kind!=="ready")return;const r=8+u,M=Math.max(0,Math.trunc(((Y=t.sheet.stress)==null?void 0:Y.cuf)??0)),I=`Crucible Test (DC ${r})`,R=M===0?"":` +${M}`,z=`1d12 # ${I}${R}`;let F;try{F=await Ke({diceNotation:z,rollTarget:"everyone",showResults:!0,timeoutMs:6e3})}catch{$.notification.show("Dice+ roll failed or timed out.","WARNING");return}F>=r?(v(N=>({...N,stress:{...N.stress??{current:0,cuf:0,cufLoss:0},current:5},indomitable:!0})),i({incoming:u,dc:r,status:"success",total:F})):i({incoming:u,dc:r,status:"fail",total:F})}function h(u){var I;if(t.kind!=="ready")return;const r=Math.max(0,Math.trunc(((I=t.sheet.stress)==null?void 0:I.current)??0)),M=Math.max(0,Math.trunc(u));if(r<=5&&M>5){const R=M-r;i({incoming:R,dc:8+R,status:"pending"})}else i(null);v(R=>({...R,stress:{...R.stress??{current:0,cuf:0,cufLoss:0},current:M}}))}function W(u,r){var F;if(t.kind!=="ready")return;const I={light:4,moderate:2,heavy:1}[u],R=Math.max(0,Math.trunc(((F=t.sheet.wounds)==null?void 0:F[u])??0)),z=r<R?r:r+1;v(Y=>({...Y,wounds:{...Y.wounds,[u]:Math.min(I,Math.max(0,z))}}))}function J(){var r;if(t.kind!=="ready"||!o||o.status!=="fail")return;const u=Math.max(0,Math.trunc(((r=t.sheet.stress)==null?void 0:r.cufLoss)??0));v(M=>({...M,stress:{...M.stress??{current:0,cuf:0,cufLoss:0},cufLoss:u+1,current:5},indomitable:!0})),i({...o,status:"success"})}const j=t.kind==="ready"?t.sheet:null,q=Ce.useMemo(()=>{if(!j)return{};const u=[];return(j.feats??[]).forEach(r=>{typeof(r==null?void 0:r.statusEffects)=="string"&&r.statusEffects.trim()&&u.push(r.statusEffects)}),(j.inventory??[]).forEach(r=>{typeof(r==null?void 0:r.statusEffects)=="string"&&r.statusEffects.trim()&&u.push(r.statusEffects)}),It(u)},[j]),Q=Ce.useMemo(()=>{const u={},r=new Map,M=R=>{const z=String(R.id),F=String(R.name??R.label??"").toLowerCase().replace(/\s+/g,"_").replace(/[^a-z0-9_\-()]/g,"");z&&(r.set(z.toLowerCase(),z),F&&r.set(F,z))};(fe.inherent??[]).forEach(M),Object.values(fe.learned??{}).forEach(R=>{(R??[]).forEach(M)});const I=new Set(["phys","ref","soc","ment","carrying_capacity","cool_under_fire","speed","cuf","carry","capacity","spd"]);return Object.entries(q??{}).forEach(([R,z])=>{const F=String(R).toLowerCase();if(I.has(F))return;const Y=r.get(F);Y&&(u[Y]=(u[Y]??0)+(Number.isFinite(z)?z:0))}),u},[q]),H=Math.max(0,(((Re=j==null?void 0:j.attributes)==null?void 0:Re.phys)??0)+(q.phys??0)),c=Math.max(0,(((Ve=j==null?void 0:j.attributes)==null?void 0:Ve.ref)??0)+(q.ref??0)),f=Math.max(0,(((Qe=j==null?void 0:j.attributes)==null?void 0:Qe.soc)??0)+(q.soc??0)),L=Math.max(0,(((Xe=j==null?void 0:j.attributes)==null?void 0:Xe.ment)??0)+(q.ment??0)),V=5+H*5+(q.carrying_capacity??0);30+H*5+(q.speed??0);const me=j?Pe(j.skills??{}):0,pe=Math.max(0,me+(q.cool_under_fire??0)),ge=Ce.useMemo(()=>j?{...j,attributes:{...j.attributes,phys:H,ref:c,soc:f,ment:L},stress:{...j.stress??{current:0,cuf:0,cufLoss:0},cuf:pe}}:null,[j,H,c,f,L,pe])??j,l=Ce.useMemo(()=>{var I;if(!j)return 0;const u=(j.weapons??[]).reduce((R,z)=>R+(z.bulk??0),0),r=((I=j.armor)==null?void 0:I.bulk)??0,M=(j.inventory??[]).reduce((R,z)=>{const F=z.quantity??1,Y=z.bulk??0,N=Number.isFinite(Y)?Y:0,ae=Number.isFinite(F)?F:1;return R+N*ae},0);return u+r+M},[j]),d=j&&l>V*2?"Heavily Encumbered":j&&l>V?"Encumbered":"";if(t.kind==="loading")return e.jsx("div",{style:{padding:12},children:"Loading…"});if(t.kind==="need-token")return e.jsxs("div",{style:{padding:12},children:[e.jsx("h2",{style:{margin:"0 0 8px 0"},children:"Whisperspace Character Sheet"}),e.jsx("p",{style:{margin:"0 0 10px 0",lineHeight:1.35},children:"Select your character token on the map, then click:"}),e.jsx("button",{style:{padding:"8px 10px",borderRadius:8,border:"1px solid #666",cursor:"pointer"},onClick:m,children:"Set Selected Token as My Character"})]});if(t.kind==="error")return e.jsxs("div",{style:{padding:12},children:[e.jsx("h2",{style:{margin:"0 0 8px 0"},children:"Error"}),e.jsx("p",{style:{margin:"0 0 10px 0",lineHeight:1.35},children:t.message}),e.jsx("button",{style:{padding:"8px 10px",borderRadius:8,border:"1px solid #666",cursor:"pointer"},onClick:()=>s({kind:"need-token"}),children:"Back"})]});const w=t.ownerLabel??(t.mode==="view"?"Viewing token":"My Character"),te=t.mode==="view"&&!t.isOwnedByMe,ve=t.mode==="my"&&!t.suppressUnset;return e.jsxs("div",{style:{padding:12},children:[e.jsx(ga,{title:X,ownerLabel:w,tokenId:t.tokenId,thumbUrl:t.thumbUrl??null,showBackButton:te,onBack:n,showUnsetButton:ve,onUnset:a}),e.jsxs(e.Fragment,{children:[e.jsx(ya,{sheet:t.sheet,sheetForView:ge,totalBulk:l,effectiveCarryingCapacity:V,encumbranceLabel:d,crucible:o,applyStress:h,toggleWound:W,setIndomitable:u=>v(r=>({...r,indomitable:u})),rollCrucibleTest:A,burnCufToPass:J}),e.jsx(ba,{activeTab:y,onTab:x,isSaving:C}),e.jsxs("div",{style:{border:"1px solid #888",borderRadius:12,padding:10},children:[y==="core"&&e.jsx(Ht,{sheet:ge,onChange:u=>v(r=>({...r,...u}))}),y==="skills"&&e.jsx(Yt,{sheet:ge,skillMods:Q,onChange:u=>v(r=>({...r,skills:u})),onMetaChange:u=>v(r=>({...r,...u}))}),y==="combat"&&e.jsx(na,{sheet:ge,tokenId:t.tokenId,skillMods:Q,onChange:u=>v(r=>({...r,...u})),onApplyStress:h,combatLog:K,onApplyCombatLog:t.mode==="my"?le:void 0,isGM:p}),y==="initiative"&&e.jsx(fa,{}),y==="inventory"&&e.jsx(xa,{sheet:ge,onChange:u=>v(r=>({...r,...u}))}),y==="feats"&&e.jsx(Jt,{sheet:ge,onChange:u=>v(r=>({...r,feats:u}))})]})]})]})}async function ka(){await $.onReady(async()=>{}),gt.createRoot(document.getElementById("root")).render(e.jsx(Ce.StrictMode,{children:e.jsx(qt,{children:e.jsx(pa,{})})}))}ka();
