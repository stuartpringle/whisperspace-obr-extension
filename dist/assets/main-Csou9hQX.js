import"./config-BSaTKKvG.js";import{r as w,j as e,d as Ce,e as Ct}from"./vendor_react-XzhcIodj.js";import{O}from"./vendor_obr-BLY5dk8V.js";import{c as Pe,r as dt,a as St,s as ie,F as It,b as Je,d as Mt,g as ut,e as Dt,f as mt,o as At,l as Re,T as ht,h as Tt,i as Rt,j as Nt,k as Et,m as ft,n as tt,p as Ge,q as Ye,t as gt,u as Pt,v as zt,w as Le,x as Be,y as at,z as we,A as nt,B as Ft}from"./initiative-BDeRVN6i.js";import{S as L,B as R,T as M,a as ze,b as V,c as b,d as ue,I as xt,e as se,C as Se,R as Wt,A as Ie,f as Me,E as De,g as Ae,h as fe,i as yt,j as pe,P as Lt,D as Fe,L as st,k as Bt,M as he,l as bt,m as it,n as _t,o as qt,p as Ot,q as Ut,r as Ht,s as $t,t as Gt,u as Yt,v as Kt,w as Jt,x as pt}from"./vendor_mui-CPCl1AAX.js";import{g as Ne,a as Vt,r as Qt,O as Xt}from"./ObrMuiThemeProvider-D1OJ2jnZ.js";import"./vendor-CPvQcOsy.js";import"./vendor_zod-CxP395f9.js";import"./vendor_emotion-pcfylbOS.js";async function Zt(){const t=await O.player.getSelection();return Array.isArray(t)?t:[]}async function ea(){const t=await Zt();return t.length>0?t[0]:null}async function _e(t){return(await O.scene.items.getItems([t])).length>0}function ta(t){var u;const n=t.sheet,[g,f]=w.useState(0),v=w.useMemo(()=>n.attributes??{phys:0,ref:0,soc:0,ment:0},[n.attributes]);async function h(o,D){const X=Number(v[o]??0),re=(await Pe({netDice:g,modifier:X,label:D})).notation;await dt({diceNotation:re,showResults:!0,rollTarget:"everyone"})}return e.jsxs(L,{spacing:2,children:[e.jsxs(R,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",gap:2,flexWrap:"wrap"},children:[e.jsx(M,{variant:"h6",sx:{m:0},children:"Core"}),e.jsxs(R,{sx:{display:"flex",alignItems:"center",gap:1,flexWrap:"wrap"},children:[e.jsx(M,{variant:"subtitle2",sx:{opacity:.8},children:"Attribute Roll:"}),e.jsxs(ze,{size:"small",exclusive:!0,value:g,onChange:(o,D)=>{D!==null&&f(D)},children:[e.jsx(V,{value:-2,children:"−2"}),e.jsx(V,{value:-1,children:"−1"}),e.jsx(V,{value:0,children:"0"}),e.jsx(V,{value:1,children:"+1"}),e.jsx(V,{value:2,children:"+2"})]})]})]}),e.jsx(b,{label:"Name",size:"small",value:n.name??"",onChange:o=>t.onChange({name:o.target.value}),fullWidth:!0}),e.jsxs(R,{sx:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:1},children:[e.jsx(Ee,{label:"PHYS",tooltip:Ne("PHYS"),value:v.phys,onRoll:()=>h("phys","PHYS Check")}),e.jsx(Ee,{label:"REF",tooltip:Ne("REF"),value:v.ref,onRoll:()=>h("ref","REF Check")}),e.jsx(Ee,{label:"SOC",tooltip:Ne("SOC"),value:v.soc,onRoll:()=>h("soc","SOC Check")}),e.jsx(Ee,{label:"MENT",tooltip:Ne("MENT"),value:v.ment,onRoll:()=>h("ment","MENT Check")})]}),e.jsxs(R,{sx:{display:"grid",gridTemplateColumns:"repeat(3, 1fr)",gap:2},children:[e.jsx(b,{label:"Cool Under Fire",size:"small",value:((u=t.sheet.stress)==null?void 0:u.cuf)??0,inputProps:{readOnly:!0},fullWidth:!0}),e.jsx(b,{label:"Speed",size:"small",value:30+(v.phys??0)*5,inputProps:{readOnly:!0},fullWidth:!0}),e.jsx(b,{label:"Carrying Capacity",size:"small",value:5+(v.phys??0)*5,inputProps:{readOnly:!0},fullWidth:!0})]}),e.jsx(M,{variant:"body2",sx:{opacity:.75},children:"Attributes are derived automatically from skill ranks (¼ of total ranks under each attribute, rounded up)."})]})}function Ee(t){return e.jsxs(R,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsxs(R,{sx:{flex:1,display:"flex",alignItems:"center",gap:.5},children:[e.jsx(b,{label:t.label,size:"small",value:t.value,inputProps:{readOnly:!0},fullWidth:!0}),t.tooltip?e.jsx(ue,{title:t.tooltip,children:e.jsx(xt,{fontSize:"small",sx:{opacity:.7}})}):null]}),e.jsx(ue,{title:"Roll with Dice+",children:e.jsx(se,{onClick:t.onRoll,"aria-label":`Roll ${t.label}`,children:e.jsx(Se,{})})})]})}function Ve(t){const n=new Map;return Object.keys(t??{}).forEach(g=>{(t[g]??[]).forEach(f=>n.set(f.id,{focus:g}))}),n}function kt(t){var o,D;const n=String(t.skillId??""),g=((o=t.ranks)==null?void 0:o[n])??0,f=((D=t.skillMods)==null?void 0:D[n])??0;if(g>0)return g+f;const v=t.learningFocus??"combat",h=t.learnedInfoById.get(n);return(h&&h.focus===v?0:-1)+f}const aa=["phys","ref","soc","ment"],qe={phys:"PHYSIQUE",ref:"REFLEX",soc:"SOCIAL",ment:"MENTAL"},Oe={combat:"Combat",education:"Education",vehicles:"Vehicles"},rt={combat:"Combat Focus",education:"Education Focus",vehicles:"Vehicles Focus"};function Ue(t){const n=vt(t,0,5);return n*(n+1)/2}function na(t){const[n,g]=w.useState(""),[f,v]=w.useState(0),[h,u]=w.useState(!0),[o,D]=w.useState(!1),[X,re]=w.useState(""),A=t.sheet.skills??{},Y=t.sheet.learningFocus??"combat",ae=Number(t.sheet.skillPoints??0);w.useEffect(()=>{let c=!1;return(async()=>{const y=await St();c||(u(y),D(!0))})().catch(()=>{c||(u(!1),D(!0))}),()=>{c=!0}},[]);const oe=w.useMemo(()=>Ve(ie.learned),[]);function ce(c){const y=oe.get(c.id);return y?y.focus===Y?5:2:5}function ne(c){var J;const y=A[c.id]??0,P=((J=t.skillMods)==null?void 0:J[c.id])??0;if(y>0)return y+P;const _=oe.get(c.id);return _&&_.focus===Y?0+P:-1+P}const m=w.useMemo(()=>{let c=0;for(const y of Object.values(A))c+=Ue(y??0);return c},[A]),a=Math.max(0,ae-m),s=c=>{const y=Math.max(0,Math.trunc(Number(X)));if(!y)return;const P=ae+c*y,_=Math.max(m,P);t.onMetaChange({skillPoints:_}),re("")};function T(c){t.onChange(c)}function N(c,y){const P=A[c.id]??0,_=ce(c),J=vt(y,0,_);if(J===P||Ue(J)-Ue(P)>a)return;const xe={...A};J===0?delete xe[c.id]:xe[c.id]=J,T(xe)}async function S(c){const y=(await Pe({netDice:f,modifier:ne(c),label:c.label})).notation;try{await dt({diceNotation:y,showResults:!0,rollTarget:"everyone"})}catch(P){console.error("Dice+ roll request failed:",P)}}const x=w.useMemo(()=>{const c=Object.values(ie.learned).flat();return[...ie.inherent,...c]},[]),F=w.useMemo(()=>{const c=n.trim().toLowerCase();return c?x.filter(y=>y.label.toLowerCase().includes(c)||y.id.toLowerCase().includes(c)):x},[x,n]),K=w.useMemo(()=>sa(ie.inherent),[]),Q=w.useMemo(()=>ie.learned,[]),C=n.trim().length>0,W=e.jsxs(R,{sx:{display:"flex",alignItems:"center",gap:2,flexWrap:"wrap"},children:[e.jsx(M,{variant:"subtitle2",sx:{opacity:.8},children:"Learning Focus:"}),Object.keys(rt).map(c=>e.jsxs(R,{sx:{display:"flex",alignItems:"center",gap:.5,cursor:"pointer"},onClick:()=>t.onMetaChange({learningFocus:c}),children:[e.jsx(Wt,{checked:Y===c,value:c,size:"small"}),e.jsx(M,{variant:"body2",children:Oe[c]})]},c))]}),U=e.jsx(R,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",gap:2,flexWrap:"wrap"},children:e.jsxs(R,{sx:{display:"flex",alignItems:"center",gap:1,flexWrap:"wrap"},children:[e.jsxs(M,{variant:"subtitle2",sx:{minWidth:170},children:["Skill Points: ",a," ",e.jsxs("span",{style:{opacity:.75},children:["(Total: ",ae,")"]})]}),e.jsx(fe,{size:"small",variant:"outlined",onClick:()=>s(1),disabled:!Number.isFinite(Number(X))||Math.trunc(Number(X))<=0,children:"+"}),e.jsx(b,{label:"SP",size:"small",type:"number",value:X,onChange:c=>re(c.target.value),sx:{width:110}}),e.jsx(fe,{size:"small",variant:"outlined",onClick:()=>s(-1),disabled:!Number.isFinite(Number(X))||Math.trunc(Number(X))<=0,children:"-"}),e.jsx(M,{variant:"subtitle2",sx:{opacity:.8},children:"Roll"}),e.jsxs(ze,{size:"small",exclusive:!0,value:f,onChange:(c,y)=>{y!==null&&v(y)},"aria-label":"Bonus / Penalty dice",children:[e.jsx(V,{value:-2,children:"−2"}),e.jsx(V,{value:-1,children:"−1"}),e.jsx(V,{value:0,children:"0"}),e.jsx(V,{value:1,children:"+1"}),e.jsx(V,{value:2,children:"+2"})]}),o&&!h&&e.jsx(M,{variant:"caption",sx:{opacity:.8},children:"(Dice+ not detected)"})]})});return e.jsxs(L,{spacing:2,children:[W,e.jsx(b,{label:"Search skills",value:n,onChange:c=>g(c.target.value),placeholder:"stealth, weapons, navigation…",fullWidth:!0}),U,C?e.jsx(L,{spacing:1,children:F.map(c=>{const y=oe.get(c.id),P=y?Oe[y.focus]:qe[c.attribute];return e.jsx(He,{skill:c,rank:A[c.id]??0,modifier:ne(c),maxRank:ce(c),onRank:_=>N(c,_),rightTag:P,canRoll:h,onRoll:()=>S(c)},c.id)})}):e.jsxs(e.Fragment,{children:[e.jsx(M,{variant:"subtitle1",children:"Inherent Skills"}),aa.map(c=>e.jsxs(Ie,{defaultExpanded:!0,children:[e.jsx(Me,{expandIcon:e.jsx(De,{}),children:e.jsx(M,{fontWeight:700,children:qe[c]})}),e.jsx(Ae,{children:e.jsx(L,{spacing:1,children:(K[c]??[]).map(y=>e.jsx(He,{skill:y,rank:A[y.id]??0,modifier:ne(y),maxRank:ce(y),onRank:P=>N(y,P),rightTag:qe[y.attribute],canRoll:h,onRoll:()=>S(y)},y.id))})})]},c)),e.jsx(M,{variant:"subtitle1",sx:{mt:1},children:"Learned Skills"}),Object.keys(Q).map(c=>e.jsxs(Ie,{defaultExpanded:!0,children:[e.jsx(Me,{expandIcon:e.jsx(De,{}),children:e.jsx(M,{fontWeight:700,children:rt[c]})}),e.jsx(Ae,{children:e.jsx(L,{spacing:1,children:(Q[c]??[]).map(y=>e.jsx(He,{skill:y,rank:A[y.id]??0,modifier:ne(y),maxRank:ce(y),onRank:P=>N(y,P),rightTag:Oe[c],canRoll:h,onRoll:()=>S(y)},y.id))})})]},c))]})]})}function He(t){const n=t.rank<t.maxRank,g=t.rank>0,f=Vt(t.skill.label);return e.jsxs(R,{sx:{display:"grid",gridTemplateColumns:"1fr auto auto auto",gap:1,alignItems:"center",border:"1px solid",borderColor:"divider",borderRadius:2,px:1.25,py:1},children:[e.jsxs(R,{sx:{minWidth:0},children:[e.jsxs(R,{sx:{display:"flex",alignItems:"center",gap:.5,minWidth:0},children:[e.jsx(M,{fontWeight:600,noWrap:!0,children:t.skill.label}),f?e.jsx(ue,{title:f,children:e.jsx(xt,{fontSize:"small",sx:{opacity:.7,flexShrink:0}})}):null]}),e.jsx(M,{variant:"caption",sx:{opacity:.7},noWrap:!0,children:t.rightTag??""})]}),e.jsxs(R,{sx:{width:46,textAlign:"center"},children:[e.jsx(M,{variant:"caption",sx:{opacity:.7,lineHeight:1},children:"Mod"}),e.jsx(M,{sx:{fontWeight:700,lineHeight:1.2},children:t.modifier>=0?`+${t.modifier}`:`${t.modifier}`})]}),e.jsxs(R,{sx:{width:40,textAlign:"center"},children:[e.jsx(M,{variant:"caption",sx:{opacity:.7,lineHeight:1},children:"Rank"}),e.jsx(M,{sx:{fontWeight:700,lineHeight:1.2},children:t.rank})]}),e.jsxs(R,{sx:{display:"flex",gap:.5,alignItems:"center",justifyContent:"flex-end"},children:[e.jsx(se,{size:"small",onClick:()=>t.onRank(t.rank-1),"aria-label":"Decrease rank",disabled:!g,children:e.jsx(yt,{fontSize:"small"})}),e.jsx(se,{size:"small",onClick:()=>t.onRank(t.rank+1),"aria-label":"Increase rank",disabled:!n,children:e.jsx(pe,{fontSize:"small"})}),e.jsx(R,{sx:{width:6}}),e.jsx(ue,{title:t.canRoll?"Roll with Dice+":"Dice+ not detected",children:e.jsx("span",{children:e.jsx(se,{size:"small",onClick:t.onRoll,"aria-label":`Roll ${t.skill.label}`,disabled:!t.canRoll,children:e.jsx(Se,{fontSize:"small"})})})})]})]})}function sa(t){return t.reduce((n,g)=>{var f;return(n[f=g.attribute]??(n[f]=[])).push(g),n},{})}function vt(t,n,g){const f=Number.isFinite(t)?Math.trunc(t):n;return Math.max(n,Math.min(g,f))}function ia(t){const n=t.sheet.feats??[];function g(){t.onChange([...n,{name:"New Feat",description:"",statusEffects:""}])}function f(h,u){const o=[...n];o[h]={...o[h],...u},It.safeParse(o[h]),t.onChange(o)}function v(h){const u=[...n];u.splice(h,1),t.onChange(u)}return e.jsxs(L,{spacing:2,children:[e.jsxs(L,{direction:"row",justifyContent:"space-between",alignItems:"center",children:[e.jsx(M,{variant:"h6",children:"Feats"}),e.jsx(fe,{variant:"contained",startIcon:e.jsx(pe,{}),onClick:g,children:"Add Feat"})]}),n.length===0?e.jsx(M,{variant:"body2",sx:{opacity:.75},children:"No feats yet."}):e.jsx(L,{spacing:2,children:n.map((h,u)=>e.jsx(Lt,{sx:{p:2},children:e.jsxs(L,{spacing:1.5,children:[e.jsxs(L,{direction:"row",spacing:1,alignItems:"center",children:[e.jsx(b,{label:"Feat Name",fullWidth:!0,value:h.name,onChange:o=>f(u,{name:o.target.value})}),e.jsx(se,{"aria-label":"Remove feat",onClick:()=>v(u),children:e.jsx(Fe,{})})]}),e.jsx(b,{label:"Description",fullWidth:!0,multiline:!0,minRows:4,value:h.description,onChange:o=>f(u,{description:o.target.value})}),e.jsx(b,{label:"Status Effects",fullWidth:!0,helperText:'Comma-separated, e.g. "carrying_capacity+5"',value:h.statusEffects??"",onChange:o=>f(u,{statusEffects:o.target.value})})]})},`${h.name}-${u}`))})]})}const ra=[{id:"pistol",name:"Pistol",skillId:"weapons_light",useDC:7,damage:2,range:"Med",ammo:10,bulk:1,cost:500},{id:"smart_pistol",name:"SMART Pistol",skillId:"weapons_light",useDC:9,damage:4,range:"Med",ammo:6,bulk:1,cost:900,keywords:["Smart-Linked"]},{id:"toxic_spike",name:"Toxic Spike",skillId:"weapons_light",useDC:10,damage:3,range:"Near",ammo:1,bulk:1,cost:750,keywords:["Toxin (Prax)","Concealable"]},{id:"smg",name:"SMG",skillId:"weapons_medium",useDC:6,damage:3,range:"Med",ammo:8,bulk:2,cost:600,keywords:["Bullet Spray"]},{id:"photon_rifle",name:"Photon Rifle",skillId:"weapons_medium",useDC:8,damage:6,range:"Long",ammo:6,bulk:3,cost:5e3,keywords:["Two-Handed"]},{id:"rifle",name:"Rifle",skillId:"weapons_medium",useDC:8,damage:4,range:"Long",ammo:8,bulk:2,cost:1e3,keywords:["Two-Handed","Piercing 1"]},{id:"shotgun",name:"Shotgun",skillId:"weapons_medium",useDC:8,damage:4,range:"Near",ammo:4,bulk:3,cost:800,req:"PHYS 1",keywords:["Point Blank","Shredding 1"]},{id:"gauss_cannon",name:"Gauss Cannon",skillId:"weapons_heavy",useDC:7,damage:4,range:"Med",ammo:20,bulk:4,cost:900,req:"PHYS 3",keywords:["Bullet Spray"]},{id:"grenade_launcher",name:"Grenade Launcher",skillId:"weapons_heavy",useDC:8,damage:3,range:"Med",ammo:1,bulk:3,cost:2e3,req:"PHYS 2",keywords:["Area (Very Near)","Two-Handed","Slow Load","Grenade"]},{id:"magneton_cannon",name:"Magneton Cannon",skillId:"weapons_exotic",useDC:5,damage:2,range:"Near",ammo:5,bulk:2,cost:8e3,req:"PHYS 1",keywords:["Area (melee)","Slow Load","Shredding 3"]},{id:"tesla_rifle",name:"Tesla Rifle",skillId:"weapons_exotic",useDC:8,damage:5,range:"Med",ammo:6,bulk:2,cost:6e3,keywords:["Two-Handed","Stun 2"]},{id:"stun_baton",name:"Stun Baton",skillId:"melee_weapons",useDC:6,damage:0,range:"Melee",ammo:0,bulk:1,cost:450,keywords:["Stun 1"]},{id:"switchblade",name:"Switchblade",skillId:"melee_weapons",useDC:9,damage:2,range:"Melee",ammo:0,bulk:1,cost:150,keywords:["Concealable","Thrown"]},{id:"fusion_blade",name:"Fusion Blade",skillId:"melee_weapons",useDC:8,damage:3,range:"Melee",ammo:0,bulk:2,cost:1200,req:"REF 2",keywords:["Piercing 2"]},{id:"rocket_maul",name:"Rocket Maul",skillId:"melee_weapons",useDC:10,damage:6,range:"Melee",ammo:2,bulk:3,cost:2500,req:"PHYS 3",keywords:["Two-Handed"]}],la={weapons:ra},lt=la.weapons??[],oa=[{id:"scrap_armour",name:"Scrap Armour",protection:1,durability:2,bulk:2,cost:500,special:"Cannot be repaired"},{id:"flak_jacket",name:"Flak Jacket",protection:1,durability:4,bulk:1,cost:1250},{id:"kevlar_clothing",name:"Kevlar Clothing",protection:1,durability:3,bulk:1,cost:1500,special:"Appears to be normal clothing"},{id:"streetweave_jacket",name:"Streetweave Jacket",protection:1,durability:5,bulk:1,cost:2500,special:"+1 to Stealth"},{id:"milsec_bodyplate",name:"MilSec Bodyplate",protection:2,durability:6,bulk:2,cost:5e3},{id:"breaching_plate",name:"Breaching plate",protection:2,durability:4,bulk:3,cost:8500,req:"PHYS 2",special:"Frontal Shielding 1"},{id:"heavy_bodyplate",name:"Heavy Bodyplate",protection:3,durability:8,bulk:4,cost:1e4,req:"PHYS 3",special:"+1 penalty die to Stealth"},{id:"basic_power_armour",name:"Basic Power Armour",protection:4,durability:14,bulk:10,cost:4e4,req:"Power Armour 1",special:"Requires Power Armour (DC5) check to activate. Failure: become Immobile; gain +1 penalty die to all PHYS and REF based checks. When activated, reduces its own bulk to 1 and grants +1 bonus die to all PHYS based checks."}],ca={armor:oa},ot=ca.armor??[],Ke="whisperspace.obr.sheet/combat-log";async function da(t){const n=Number.isFinite(t.useDC)?Math.trunc(t.useDC):Math.trunc(t.weapon.useDC),g=t.weapon.name||"Attack",f=(await Pe({netDice:t.netDice,modifier:t.modifier,label:g})).notation,v=await Je({diceNotation:f,rollTarget:t.rollTarget??"everyone",showResults:t.showResults??!0}),h=await Mt({total:v,useDC:n,weaponDamage:Math.trunc(t.weapon.damage??0),label:g});ut().emit("attack:resolved",{total:h.total,useDC:h.useDC,hit:h.hit,isCrit:h.isCrit,baseDamage:h.baseDamage,totalDamage:h.totalDamage,stressDelta:h.stressDelta,label:g});let u=h.message;t.prefix&&(u=`${t.prefix} ${u}`);const o={text:u,ts:Date.now(),kind:"attack",attackerName:t.attackerName,weaponName:g,outcome:{total:h.total,useDC:h.useDC,hit:h.hit,isCrit:h.isCrit,baseDamage:h.baseDamage,totalDamage:h.totalDamage,stressDelta:h.stressDelta}};return O.broadcast.sendMessage(Ke,o,{destination:"ALL"}),{...h,message:u}}const jt=da;async function wt(t){const n=await Dt({incomingDamage:t.incomingDamage,stressDelta:t.stressDelta,unmitigated:t.unmitigated,armour:t.sheet.armor,wounds:t.sheet.wounds,stress:t.sheet.stress});return ut().emit("damage:applied",{incomingDamage:Math.max(0,Math.trunc(t.incomingDamage)),unmitigated:t.unmitigated,stressDelta:t.stressDelta,resultingStress:n.stress.current}),{sheet:{...t.sheet,wounds:n.wounds,armor:n.armour,stress:n.stress},stressDelta:n.stressDelta}}function be(t){var f;if(!t)return 0;const n=(f=t.keywordParams)==null?void 0:f.ammoMax,g=typeof n=="number"?n:typeof n=="string"?Number(n):void 0;return Number.isFinite(g)?Number(g):0}function ua(t){const n="#e55353",g="#8b5cf6",f="#5b6bff",v="#26a269",h="#d64040";return e.jsxs(R,{sx:{border:"1px solid",borderColor:"divider",borderRadius:2,p:1.25},children:[e.jsx(M,{variant:"subtitle2",sx:{opacity:.8,mb:.5},children:"Combat Log"}),t.entries.length===0?e.jsx(M,{variant:"body2",sx:{opacity:.7},children:"No recent rolls."}):e.jsx(L,{spacing:.75,children:t.entries.map(u=>{var ne,m,a,s,T;const o=!!((ne=u.outcome)!=null&&ne.hit)&&((((m=u.outcome)==null?void 0:m.totalDamage)??0)>0||(((a=u.outcome)==null?void 0:a.stressDelta)??0)>0)&&!!t.onApply,D=o&&(((s=u.outcome)==null?void 0:s.totalDamage)??0)>0,X=o&&(((T=u.outcome)==null?void 0:T.stressDelta)??0)>0,re=D&&X,A=u.outcome,Y=A!=null&&A.hit?"Hit":"Miss",ae=A!=null&&A.hit?v:h,oe=u.attackerName??"Unknown",ce=u.weaponName??"Attack";return e.jsxs(R,{sx:{display:"flex",alignItems:"center",gap:1,flexWrap:"wrap"},children:[e.jsx(M,{variant:"body2",sx:{flex:"1 1 260px"},children:u.kind==="effect"?e.jsxs(e.Fragment,{children:[e.jsx("strong",{children:u.targetName??"Target"})," ",(u.damageApplied??0)>0&&e.jsxs(e.Fragment,{children:["took"," ",e.jsx("strong",{style:{color:n},children:u.damageApplied})," ","damage"]}),(u.damageApplied??0)>0&&(u.stressApplied??0)>0&&" and ",(u.damageApplied??0)<=0&&(u.stressApplied??0)>0&&"took ",(u.stressApplied??0)>0&&e.jsxs(e.Fragment,{children:[e.jsx("strong",{style:{color:g},children:u.stressApplied})," ","stress"]}),"."]}):e.jsxs(e.Fragment,{children:[e.jsx("strong",{children:oe}),": ",e.jsx("strong",{children:ce})," rolled"," ",(A==null?void 0:A.total)??0," vs DC ",(A==null?void 0:A.useDC)??0,"."," ",A!=null&&A.isCrit?e.jsxs(e.Fragment,{children:[e.jsx("strong",{style:{color:v},children:"Extreme success - "}),e.jsx("strong",{style:{color:f},children:"crit!"})]}):e.jsx("strong",{style:{color:ae},children:Y}),(A==null?void 0:A.hit)&&e.jsxs(e.Fragment,{children:[". Damage:"," ",e.jsx("strong",{style:{color:n},children:(A==null?void 0:A.totalDamage)??0}),A!=null&&A.stressDelta?e.jsxs(e.Fragment,{children:[" "," (+"," ",e.jsx("strong",{style:{color:g},children:A.stressDelta})," ","Stress)"]}):null]}),"."]})}),D&&e.jsx(fe,{size:"small",variant:"outlined",startIcon:e.jsx(st,{fontSize:"small"}),onClick:()=>{var N,S;return(S=t.onApply)==null?void 0:S.call(t,{...u,kind:"attack",damageApplied:((N=u.outcome)==null?void 0:N.totalDamage)??0,stressApplied:0})},children:"Apply Damage"}),X&&e.jsx(fe,{size:"small",variant:"outlined",startIcon:e.jsx(Bt,{fontSize:"small"}),onClick:()=>{var N,S;return(S=t.onApply)==null?void 0:S.call(t,{...u,kind:"attack",damageApplied:0,stressApplied:((N=u.outcome)==null?void 0:N.stressDelta)??0})},children:"Apply Stress"}),re&&e.jsx(fe,{size:"small",variant:"outlined",startIcon:e.jsx(st,{fontSize:"small"}),onClick:()=>{var N,S,x;return(x=t.onApply)==null?void 0:x.call(t,{...u,kind:"attack",damageApplied:((N=u.outcome)==null?void 0:N.totalDamage)??0,stressApplied:((S=u.outcome)==null?void 0:S.stressDelta)??0})},children:"Apply Both"})]},u.ts)})})]})}function ma(t){var W,U,c,y,P,_,J,q,xe,ke,je,We;const n=t.sheet,[g,f]=w.useState(0),[v,h]=w.useState(null),[u,o]=w.useState(""),[D,X]=w.useState(!1),re=(t.combatLog??[]).slice(-3).reverse(),A=w.useMemo(()=>Ve(ie.learned),[]),Y=w.useMemo(()=>{const l=Object.values(ie.learned).flat();return[...ie.inherent,...l]},[]),ae=new Set(["melee_weapons","melee_unarmed","weapons_light","weapons_medium","weapons_heavy","weapons_exotic","explosives"]),oe=Y.filter(l=>ae.has(l.id));w.useMemo(()=>[...Y].sort((l,d)=>l.label.localeCompare(d.label)),[Y]);async function ce(){var G;const l=Number(u),d=Number.isFinite(l)?Math.max(0,Math.trunc(l)):0;if(d<=0)return;const p=await wt({sheet:t.sheet,incomingDamage:d,unmitigated:D});t.onChange({wounds:p.sheet.wounds,armor:p.sheet.armor,stress:p.sheet.stress}),p.stressDelta>0&&t.onApplyStress&&t.onApplyStress(((G=p.sheet.stress)==null?void 0:G.current)??0),o("")}function ne(l){return kt({learnedInfoById:A,skillId:l,ranks:n.skills??{},learningFocus:n.learningFocus,skillMods:t.skillMods})}function m(l,d){const p=[...n.weapons??[]],G=p[l];if(d.ammo!==void 0&&!be(G)&&d.ammo>0){const Te={...G.keywordParams??{},ammoMax:d.ammo};p[l]={...G,...d,keywordParams:Te},t.onChange({weapons:p});return}p[l]={...G,...d},t.onChange({weapons:p})}function a(l,d){if(l===null||l===d)return;const p=t.sheet.weapons??[];if(l<0||l>=p.length||d<0||d>=p.length)return;const G=[...p],[me]=G.splice(l,1);G.splice(d,0,me),t.onChange({weapons:G}),h(d)}function s(l){const d=lt.find(G=>G.id===l);if(!d)return;const p=[...n.weapons??[]];p.push({name:d.name,skillId:d.skillId,useDC:d.useDC,damage:d.damage,range:d.range,ammo:d.ammo,bulk:d.bulk,req:d.req,cost:d.cost,keywords:[...d.keywords??[]],keywordParams:{ammoMax:d.ammo??0,...d.keywordParams??{}}}),t.onChange({weapons:p})}function T(){const l=[...n.weapons??[]];l.push({name:"New Weapon",skillId:"weapons_medium",useDC:8,damage:3,range:"Med",ammo:0,bulk:1,req:"",cost:0,keywords:[],keywordParams:{ammoMax:0}}),t.onChange({weapons:l})}function N(l){const d=[...n.weapons??[]];d.splice(l,1),t.onChange({weapons:d})}async function S(l,d){const p=be(d),G=Number.isFinite(d.ammo)?Number(d.ammo):0;if(p>0&&G<=0){O.notification.show("Out of ammo. Reload first.","WARNING");return}let me=ne(d.skillId);try{me=(await mt({learnedByFocus:ie.learned,skillId:d.skillId,ranks:t.sheet.skills??{},learningFocus:t.sheet.learningFocus,skillMods:t.skillMods})).modifier}catch{}await jt({weapon:d,useDC:Number.isFinite(d.useDC)?Number(d.useDC):0,netDice:g,modifier:me,attackerName:t.sheet.name,rollTarget:"everyone",showResults:!0}),p>0&&m(l,{ammo:Math.max(0,G-1)})}const[x,F]=w.useState(""),[K,Q]=w.useState("");function C(l){const d=ot.find(p=>p.id===l);d&&t.onChange({armor:{name:d.name,keywords:[...d.keywords??[]],keywordParams:{...d.keywordParams??{}},protection:d.protection,durability:{current:d.durability,max:d.durability},bulk:d.bulk,req:d.req,cost:d.cost,special:d.special}})}return e.jsxs(L,{spacing:2,children:[e.jsx(R,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",gap:2,flexWrap:"wrap"},children:e.jsx(M,{variant:"h6",sx:{m:0},children:"Combat"})}),e.jsxs(R,{sx:{display:"flex",alignItems:"center",gap:1,flexWrap:"wrap"},children:[e.jsx(M,{variant:"subtitle2",sx:{opacity:.8},children:"Take Damage:"}),e.jsx(b,{size:"small",type:"number",inputProps:{min:0},value:u,onChange:l=>o(l.target.value),sx:{width:90}}),e.jsx(V,{size:"small",value:"unmitigated",selected:D,onChange:()=>X(l=>!l),children:"Unmitigated"}),e.jsx(fe,{size:"small",variant:"outlined",onClick:ce,children:"Apply"})]}),e.jsxs(R,{sx:{display:"flex",alignItems:"center",gap:1,flexWrap:"wrap"},children:[e.jsx(M,{variant:"subtitle2",sx:{opacity:.8},children:"Attack Roll:"}),e.jsxs(ze,{size:"small",exclusive:!0,value:g,onChange:(l,d)=>{d!==null&&f(d)},children:[e.jsx(V,{value:-2,children:"−2"}),e.jsx(V,{value:-1,children:"−1"}),e.jsx(V,{value:0,children:"0"}),e.jsx(V,{value:1,children:"+1"}),e.jsx(V,{value:2,children:"+2"})]})]}),e.jsx(ua,{entries:re,onApply:t.onApplyCombatLog}),e.jsxs(Ie,{defaultExpanded:!0,children:[e.jsx(Me,{expandIcon:e.jsx(De,{}),children:e.jsx(M,{fontWeight:700,children:"Weapons"})}),e.jsx(Ae,{children:e.jsxs(L,{spacing:1.5,children:[e.jsxs(R,{sx:{display:"flex",gap:1,alignItems:"center",flexWrap:"wrap"},children:[e.jsxs(b,{label:"Add prefab weapon",size:"small",select:!0,value:x,onChange:l=>F(l.target.value),sx:{minWidth:240},children:[e.jsx(he,{value:"",children:"— choose —"}),lt.map(l=>e.jsx(he,{value:l.id,children:l.name},l.id))]}),e.jsx(se,{color:"primary",onClick:()=>s(x),"aria-label":"Add prefab weapon",disabled:!x,children:e.jsx(pe,{})}),e.jsx(R,{sx:{flex:1}}),e.jsx(se,{color:"primary",onClick:T,"aria-label":"Add custom weapon",children:e.jsx(pe,{})}),e.jsx(M,{variant:"body2",sx:{opacity:.75},children:"Add custom weapon"})]}),(n.weapons??[]).length===0?e.jsx(M,{sx:{opacity:.75},children:"No weapons yet."}):(n.weapons??[]).map((l,d)=>e.jsxs(R,{draggable:!0,onDragStart:()=>h(d),onDragEnd:()=>h(null),onDragOver:p=>{p.preventDefault()},onDrop:p=>{p.preventDefault(),a(v,d)},sx:{border:"1px solid",borderColor:"divider",borderRadius:2,p:1.25,cursor:"grab",opacity:v===d?.85:1,display:"grid",gap:1.25},children:[e.jsxs(R,{sx:{display:"flex",gap:1,alignItems:"center"},children:[e.jsx(b,{label:"Name",size:"small",value:l.name,onChange:p=>m(d,{name:p.target.value}),fullWidth:!0}),e.jsx(ue,{title:"Roll attack with Dice+",children:e.jsx(se,{onClick:()=>S(d,l),"aria-label":`Roll attack for ${l.name}`,children:e.jsx(Se,{})})}),e.jsx(se,{onClick:()=>N(d),"aria-label":"Remove weapon",children:e.jsx(Fe,{})})]}),e.jsxs(R,{sx:{display:"grid",gridTemplateColumns:"1fr 1fr 1fr 1fr",gap:1},children:[e.jsx(b,{label:"Skill",size:"small",select:!0,value:l.skillId,onChange:p=>m(d,{skillId:p.target.value}),children:oe.map(p=>e.jsx(he,{value:p.id,children:p.label},p.id))}),e.jsx(b,{label:"Use DC",size:"small",type:"number",value:l.useDC,onChange:p=>m(d,{useDC:Number(p.target.value)})}),e.jsx(b,{label:"Damage",size:"small",type:"number",value:l.damage,onChange:p=>m(d,{damage:Number(p.target.value)})}),e.jsx(b,{label:"Range",size:"small",value:l.range??"",onChange:p=>m(d,{range:p.target.value}),placeholder:"Melee / Short / Med / Long"}),e.jsxs(R,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(b,{label:"Ammo",size:"small",type:"number",value:l.ammo??0,onChange:p=>m(d,{ammo:Number(p.target.value)}),sx:{width:110}}),e.jsxs(M,{variant:"body2",sx:{opacity:.8},children:["/ ",be(l)||0]}),e.jsx(ue,{title:"Reload",children:e.jsx("span",{children:e.jsx(se,{size:"small",onClick:()=>m(d,{ammo:be(l)||0}),disabled:(be(l)||0)<=0,children:e.jsx(bt,{fontSize:"small"})})})})]}),e.jsx(b,{label:"Bulk",size:"small",type:"number",value:l.bulk??0,onChange:p=>m(d,{bulk:Number(p.target.value)})}),e.jsx(b,{label:"Req.",size:"small",value:l.req??"",onChange:p=>m(d,{req:p.target.value}),placeholder:"PHYS 1 / REF 2 / etc"}),e.jsx(b,{label:"Keywords (comma)",size:"small",value:(l.keywords??[]).join(", "),onChange:p=>m(d,{keywords:p.target.value.split(",").map(G=>G.trim()).filter(Boolean)}),placeholder:"Two-Handed, Piercing 1",sx:{gridColumn:"1 / -1"}}),(l.keywords??[]).length>0&&e.jsx(R,{sx:{gridColumn:"1 / -1",display:"flex",flexWrap:"wrap",gap:.5},children:(l.keywords??[]).map((p,G)=>{const me=Qt(p);return me?e.jsx(ue,{title:me.description,children:e.jsx("span",{children:e.jsx(it,{label:p,size:"small",variant:"outlined",component:"a",href:`/rules.html#${me.anchor}`,target:"_blank",clickable:!0,sx:{textDecoration:"none"}})})},`${p}-${G}`):e.jsx(it,{label:p,size:"small",variant:"outlined"},`${p}-${G}`)})})]})]},l.id??`${l.name}-${d}`))]})})]}),e.jsxs(Ie,{defaultExpanded:!0,children:[e.jsx(Me,{expandIcon:e.jsx(De,{}),children:e.jsx(M,{fontWeight:700,children:"Armor"})}),e.jsx(Ae,{children:e.jsxs(L,{spacing:1.5,children:[e.jsxs(R,{sx:{display:"flex",gap:1,alignItems:"center",flexWrap:"wrap"},children:[e.jsxs(b,{label:"Set prefab armor",size:"small",select:!0,value:K,onChange:l=>Q(l.target.value),sx:{minWidth:240},children:[e.jsx(he,{value:"",children:"— choose —"}),ot.map(l=>e.jsx(he,{value:l.id,children:l.name},l.id))]}),e.jsx(se,{color:"primary",onClick:()=>C(K),"aria-label":"Set prefab armor",disabled:!K,children:e.jsx(pe,{})})]}),e.jsxs(R,{sx:{border:"1px solid",borderColor:"divider",borderRadius:2,p:1.25},children:[e.jsxs(R,{sx:{display:"grid",gridTemplateColumns:"2fr 1fr 1fr 1fr",gap:1},children:[e.jsx(b,{label:"Name",size:"small",value:((W=n.armor)==null?void 0:W.name)??"",onChange:l=>t.onChange({armor:{...n.armor??{durability:{current:0,max:0},protection:0,keywords:[],keywordParams:{ammoMax:0}},name:l.target.value}})}),e.jsx(b,{label:"Protection",size:"small",type:"number",value:((U=n.armor)==null?void 0:U.protection)??0,onChange:l=>t.onChange({armor:{...n.armor??{name:"",durability:{current:0,max:0},keywords:[],keywordParams:{}},protection:Number(l.target.value)}})}),e.jsx(b,{label:"Durability (cur)",size:"small",type:"number",value:((c=n.armor)==null?void 0:c.durability.current)??0,onChange:l=>{var d;return t.onChange({armor:{...n.armor??{name:"",durability:{current:0,max:0},protection:0,keywords:[],keywordParams:{}},durability:{...((d=n.armor)==null?void 0:d.durability)??{current:0,max:0},current:Number(l.target.value)}}})}}),e.jsx(b,{label:"Durability (max)",size:"small",type:"number",value:((y=n.armor)==null?void 0:y.durability.max)??0,onChange:l=>{var d;return t.onChange({armor:{...n.armor??{name:"",durability:{current:0,max:0},protection:0,keywords:[],keywordParams:{}},durability:{...((d=n.armor)==null?void 0:d.durability)??{current:0,max:0},max:Number(l.target.value)}}})}})]}),(((_=(P=n.armor)==null?void 0:P.durability)==null?void 0:_.max)??0)>0&&(((q=(J=n.armor)==null?void 0:J.durability)==null?void 0:q.current)??0)<=0&&e.jsx(M,{sx:{mt:1},color:"error",variant:"body2",children:"Broken: armor provides no Protection until repaired."}),e.jsxs(R,{sx:{display:"grid",gridTemplateColumns:"1fr 1fr 1fr 2fr",gap:1,mt:1},children:[e.jsx(b,{label:"Bulk",size:"small",type:"number",value:((xe=n.armor)==null?void 0:xe.bulk)??0,onChange:l=>t.onChange({armor:{...n.armor??{name:"",durability:{current:0,max:0},protection:0,keywords:[],keywordParams:{}},bulk:Number(l.target.value)}})}),e.jsx(b,{label:"Req.",size:"small",value:((ke=n.armor)==null?void 0:ke.req)??"",onChange:l=>t.onChange({armor:{...n.armor??{name:"",durability:{current:0,max:0},protection:0,keywords:[],keywordParams:{}},req:l.target.value}})}),e.jsx(b,{label:"Special",size:"small",value:((je=n.armor)==null?void 0:je.special)??"",onChange:l=>t.onChange({armor:{...n.armor??{name:"",durability:{current:0,max:0},protection:0,keywords:[],keywordParams:{}},special:l.target.value}})})]}),e.jsx(R,{sx:{mt:1},children:e.jsx(b,{label:"Keywords (comma)",size:"small",fullWidth:!0,value:(((We=n.armor)==null?void 0:We.keywords)??[]).join(", "),onChange:l=>t.onChange({armor:{...n.armor??{name:"",durability:{current:0,max:0},protection:0,keywords:[],keywordParams:{}},keywords:l.target.value.split(",").map(d=>d.trim()).filter(Boolean)}}),placeholder:"Frontal Shielding 1"})})]})]})})]})]})}const ha=[{name:"Flashbang Grenade",effect:"Applies Stun 1 to everyone within Very Near range, Thrown",uses:"1 use",bulk:1,cost:200},{name:"Frag Grenade",effect:"Deals 2 area (Very Near range) damage (DC8 to Evade half), Thrown",uses:"1 use",bulk:1,cost:250},{name:"EMP Grenade",effect:"Applies EMP 2 to everything within range, Thrown",uses:"1 use",bulk:1,cost:300},{name:"Combat Stim Injector",effect:"Gain +1 action & -1 Stress; take 1 wound after effect ends",uses:"1 use",bulk:1,cost:200},{name:"Basic Medkit",effect:"Right tool for the job: First Aid checks",uses:"3 uses",bulk:1,cost:350},{name:"Multitool",effect:"Allows engineering checks to repair, bypass, scrap, etc.",uses:"Permanent",bulk:1,cost:750},{name:"Repair Kit",effect:"Provides materials and tools for repairs",uses:"10 uses",bulk:1,cost:500},{name:"Tracker",effect:"While within 10km, always know location of this device",uses:"1 use",bulk:1,cost:250},{name:"Portable Scanner",effect:"Right tool for the job: Observe (tech, lifeforms)",uses:"Permanent",bulk:1,cost:400},{name:"Weapon Scope",effect:"Simple Modification. Grants +1 bonus die to called shots at medium range and farther; inflicts +1 penalty die to attacks at Near range or nearer",uses:"Permanent",bulk:1,cost:750},{name:"Weapon Silencer",effect:"Simple Modification. Weapon makes reduced sound when fired; deals -1 damage",uses:"Permanent",bulk:1,cost:500},{name:"Compact Backpack",effect:"+5 Inventory Slots when worn",uses:"Permanent",bulk:0,cost:150},{name:"Ammo (Flechette)",effect:"Deals +2 damage to unarmoured targets.",uses:"10 rounds",bulk:1,cost:500},{name:"Ammo (SMART)",effect:"Required for Smart-Linked weapons.",uses:"10",bulk:1,cost:1250},{name:"Ammo (Armour Piercing)",effect:"Adds Piercing 1 to attacks.",uses:"10",bulk:1,cost:750},{name:"Ammo (Explosive)",effect:"Adds Shredding 1 to attacks.",uses:"10",bulk:1,cost:750}],fa={items:ha},ga=fa.items,xa=[{name:"Reflex Booster",tier:1,effect:"Once per round, gain +1 bonus die to an Evade check.",installationDifficulty:2,requirements:"REF 1",physicalImpact:"Low; spine",bulk:1,cost:4e3},{name:"Targeting Link",tier:1,effect:"Once per round, ignore 1 level of cover when attacking an enemy you can see.",installationDifficulty:2,requirements:"-",physicalImpact:"Medium; eyes",bulk:1,cost:6e3},{name:"Low-Light Optics",tier:1,effect:"Ignore penalty dice caused by darkness within medium range.",installationDifficulty:1,requirements:"-",physicalImpact:"Medium; eyes",bulk:1,cost:4e3},{name:"EMP Shielding",tier:1,effect:"Ignore the effects of EMP once per day.",installationDifficulty:2,requirements:"MENT 1",physicalImpact:"None; torso",bulk:1,cost:5500},{name:"Metabolic Filter",tier:1,effect:"Gain +1 bonus die on checks to resist toxins or narcotics.",installationDifficulty:1,requirements:"PHYS 1",physicalImpact:"Minor; liver",bulk:1,cost:2e3},{name:"Internal Communicator",tier:1,effect:"Gain the ability to send and receive messages mentally just as if you were using a regular comms device.",installationDifficulty:0,requirements:"-",physicalImpact:"Medium; jaw, ear",bulk:1,cost:2500},{name:"Skull Popper",tier:1,effect:"Highly illegal; when installed, is given a mandate such as “don’t go to the police”. If the host violates this mandate, the Skull Popper explodes, killing the host. The more specific the mandate, the better the implant functions.",installationDifficulty:2,requirements:"-",physicalImpact:"None; brain",bulk:1,cost:12e3},{name:"Databank",tier:2,effect:"You gain an internal information storage device. You may store information upon it (thinking you want to record what you see, for example), and access information from it at will. You may also load external information onto it, though the GM determines how long that takes and how much may be stored on it.",installationDifficulty:2,requirements:"MENT 1",physicalImpact:"Medium; cranium",bulk:1,cost:7500},{name:"Invisible Databank",tier:2,effect:"You gain an internal information storage device. You may store information upon it (thinking you want to record what you see, for example), and access information from it at will. This device cannot be seen or accessed externally without removing it and is shielded to avoid electronic detection.",installationDifficulty:3,requirements:"-",physicalImpact:"None; cranium",bulk:1,cost:15e3},{name:"Neural Accelerator",tier:2,effect:"Once per day, activate to gain 2 additional actions on your turn. At the end of your turn, gain +2 stress.",installationDifficulty:4,requirements:"Ment 2",physicalImpact:"Obvious; spine",bulk:1,cost:1e4},{name:"Reaction Governor Matrix",tier:2,effect:"Gain +1 reaction per round.",installationDifficulty:2,requirements:"REF 2",physicalImpact:"None; brain",bulk:1,cost:8e3},{name:"Threat Awareness Suite",tier:2,effect:"Gain +1 bonus die to Observe or Instinct checks to detect ambushes or imminent danger. Additionally, you may not be Surprised.",installationDifficulty:2,requirements:"-",physicalImpact:"None; brain",bulk:1,cost:5500},{name:"Synthetic Musculature",tier:2,effect:"Gain +1 bonus die on Powerlifting or Athletics checks involving lifting, pushing, or breaking objects. Unarmed attacks deal damage equal to your full PHYS.",installationDifficulty:4,requirements:"PHYS 3",physicalImpact:"Obvious; arms, legs, torso",bulk:1,cost:1e4},{name:"Stability Gyros",tier:2,effect:"Ignore penalty dice from unstable environments (moving vehicles, zero-G, poor footing)",installationDifficulty:2,requirements:"REF 2",physicalImpact:"Minor; ear",bulk:1,cost:6e3},{name:"Adrenal Boost",tier:2,effect:"Activate to ignore stress penalties for 1 round. At the end of this round, take 1 damage.",installationDifficulty:2,requirements:"PHYS 1",physicalImpact:"None; adrenal glands",bulk:1,cost:5e3},{name:"Mantis Claws (retractable)",tier:3,effect:"Your unarmed attacks deal damage equal to your REF and have Piercing 3. Additionally, gain +1 bonus die to climbing related checks.",installationDifficulty:3,requirements:"REF 2 or PHYS 2",physicalImpact:"Obvious; forearms and hands",bulk:1,cost:1e4},{name:"Neuro Regulator",tier:3,effect:"Ignore up to 3 stress per day from up to 3 sources of stress. Make all SOC based rolls with +1 penalty die.",installationDifficulty:3,requirements:"MENT 2",physicalImpact:"None; brain",bulk:1,cost:12e3},{name:"Synthetic Antibodies",tier:3,effect:"Become immune to nanites targeting your body (including positive effects). Does not stop things from being thrown at you with nanites.",installationDifficulty:4,requirements:"PHYS 1 and MENT 1",physicalImpact:"Minor; nervous system",bulk:1,cost:17500},{name:"Bio-Stabilizer",tier:3,effect:`When you would take a Medium or Heavy wound, roll Cybernetics (DC8).- Extreme success: ignore the wound.
- Success: ignore the wound; this cyberware effect cannot be used for 1 day.
- Failure: suffer the wound as normal; this cyberware effect cannot be used for 1 day.
This effect may only trigger once per instance of damage.`,installationDifficulty:4,requirements:"-",physicalImpact:"Medium; chest and back",bulk:1,cost:15e3}],ya={cyberware:xa},ba=ya.cyberware,pa=[{name:"Space Dust",effect:"Grants +1 bonus die to Observe and Piloting checks for 6 hours",uses:5,addictionScore:1,legality:"Legal",bulk:1,cost:500},{name:"Tranquility",effect:"Reduces stress by 1; penalty die to all REF checks for 6 hours.",uses:2,addictionScore:5,legality:"Legal",bulk:1,cost:5e3},{name:"Smoothe",effect:"Reduces stress by 1d4; increases Cool Under Fire by 2 and grants +1 bonus die to all Mental skill checks for 1 hour",uses:1,addictionScore:8,legality:"Illegal",bulk:1,cost:2e4},{name:"Chemical Strength",effect:"+1 bonus die to all PHYS checks for 1 hour; +1 movement bonus for 1 hour. After 1 hour, gain +1 penalty die to all PHYS checks and gain +1 movement penalty until sleep.",uses:1,addictionScore:3,legality:"Illegal",bulk:1,cost:8e3}],ka={narcotics:pa},va=ka.narcotics;function ja(){return`inv_${Date.now()}_${Math.random().toString(36).slice(2,9)}`}function wa(t){const n=t.sheet.inventory??[],g=a=>{t.onChange({inventory:a})},[f,v]=w.useState("item"),[h,u]=w.useState(null),[o,D]=w.useState({}),[X,re]=w.useState(null),[A,Y]=w.useState(null),ae=w.useMemo(()=>f==="item"?ga.map(a=>({type:"item",...a})):f==="cyberware"?ba.map(a=>({type:"cyberware",...a})):va.map(a=>({type:"narcotics",...a})),[f]);function oe(a){u(a);const s=ae.find(T=>T.name===a);if(!s){D({type:f,name:"",quantity:1,bulk:f==="item"?0:1,effect:"",cost:0,statusEffects:""});return}D(f==="item"?{type:"item",name:s.name,quantity:1,uses:s.uses??"",bulk:s.bulk??0,effect:s.effect??"",cost:s.cost??0,statusEffects:s.statusEffects??""}:f==="cyberware"?{type:"cyberware",name:s.name,quantity:1,bulk:s.bulk??1,tier:s.tier??1,installationDifficulty:s.installationDifficulty??0,requirements:s.requirements??"",physicalImpact:s.physicalImpact??"",effect:s.effect??"",cost:s.cost??0,statusEffects:s.statusEffects??""}:{type:"narcotics",name:s.name,quantity:1,bulk:s.bulk??1,uses:s.uses??1,addictionScore:s.addictionScore??0,legality:s.legality??"",effect:s.effect??"",cost:s.cost??0,statusEffects:s.statusEffects??""})}function ce(){const a=[...n,{id:ja(),...o}];t.onChange({inventory:a}),u(null),D({type:f,name:"",quantity:1,bulk:f==="item"?0:1,effect:"",cost:0,statusEffects:""})}function ne(a){t.onChange({inventory:n.filter(s=>s.id!==a)})}function m(a,s){t.onChange({inventory:n.map(T=>T.id===a?{...T,...s}:T)})}return e.jsxs(L,{spacing:2,children:[e.jsx(b,{label:"Credits",type:"number",value:t.sheet.credits??0,onChange:a=>t.onChange({credits:Number(a.target.value)}),size:"small"}),e.jsxs(R,{children:[e.jsx(M,{variant:"subtitle2",sx:{mb:1},children:"Add Inventory"}),e.jsxs(L,{direction:{xs:"column",sm:"row"},spacing:1,alignItems:"center",children:[e.jsxs(b,{select:!0,size:"small",label:"Type",value:f,onChange:a=>{const s=a.target.value;v(s),u(null),D(s==="item"?{type:s,name:"",quantity:1,bulk:0,uses:"",effect:"",cost:0,statusEffects:""}:s==="cyberware"?{type:s,name:"",quantity:1,bulk:1,tier:1,installationDifficulty:0,requirements:"",physicalImpact:"",effect:"",cost:0,statusEffects:""}:{type:s,name:"",quantity:1,bulk:1,uses:1,addictionScore:0,legality:"",effect:"",cost:0,statusEffects:""})},sx:{minWidth:160},children:[e.jsx(he,{value:"item",children:"Item"}),e.jsx(he,{value:"cyberware",children:"Cyberware"}),e.jsx(he,{value:"narcotics",children:"Narcotics"})]}),e.jsx(_t,{size:"small",sx:{flex:1,minWidth:220},options:ae.map(a=>a.name),value:h,onChange:(a,s)=>oe(s),renderInput:a=>e.jsx(b,{...a,label:"Template (optional)"})}),e.jsx(fe,{variant:"contained",startIcon:e.jsx(pe,{}),onClick:ce,disabled:!(o!=null&&o.name),children:"Add"})]}),e.jsx(R,{sx:{mt:1},children:e.jsxs(L,{spacing:1,children:[e.jsxs(L,{direction:{xs:"column",sm:"row"},spacing:1,children:[e.jsx(b,{size:"small",label:"Name",value:(o==null?void 0:o.name)??"",onChange:a=>D(s=>({...s,name:a.target.value})),sx:{flex:1}}),e.jsx(b,{size:"small",type:"number",label:"Bulk",value:(o==null?void 0:o.bulk)??0,onChange:a=>D(s=>({...s,bulk:Number(a.target.value)})),sx:{width:120}}),e.jsx(b,{size:"small",type:"number",label:"Quantity",value:(o==null?void 0:o.quantity)??1,onChange:a=>{const s=Number(a.target.value);Number.isFinite(s)&&D(T=>({...T,quantity:s}))},sx:{width:120}}),e.jsx(b,{size:"small",type:"number",label:"Cost",value:(o==null?void 0:o.cost)??0,onChange:a=>D(s=>({...s,cost:Number(a.target.value)})),sx:{width:140}})]}),f==="item"&&e.jsx(b,{size:"small",label:"Uses",value:(o==null?void 0:o.uses)??"",onChange:a=>D(s=>({...s,uses:a.target.value}))}),f==="cyberware"&&e.jsxs(L,{direction:{xs:"column",sm:"row"},spacing:1,children:[e.jsx(b,{size:"small",type:"number",label:"Tier",value:(o==null?void 0:o.tier)??1,onChange:a=>D(s=>({...s,tier:Number(a.target.value)})),sx:{width:120}}),e.jsx(b,{size:"small",type:"number",label:"Installation Difficulty",value:(o==null?void 0:o.installationDifficulty)??0,onChange:a=>D(s=>({...s,installationDifficulty:Number(a.target.value)})),sx:{width:220}}),e.jsx(b,{size:"small",label:"Requirements",value:(o==null?void 0:o.requirements)??"",onChange:a=>D(s=>({...s,requirements:a.target.value})),sx:{flex:1}})]}),f==="cyberware"&&e.jsx(b,{size:"small",label:"Physical Impact",value:(o==null?void 0:o.physicalImpact)??"",onChange:a=>D(s=>({...s,physicalImpact:a.target.value}))}),f==="narcotics"&&e.jsxs(L,{direction:{xs:"column",sm:"row"},spacing:1,children:[e.jsx(b,{size:"small",type:"number",label:"Uses",value:(o==null?void 0:o.uses)??1,onChange:a=>D(s=>({...s,uses:Number(a.target.value)})),sx:{width:120}}),e.jsx(b,{size:"small",type:"number",label:"Addiction Score",value:(o==null?void 0:o.addictionScore)??0,onChange:a=>D(s=>({...s,addictionScore:Number(a.target.value)})),sx:{width:160}}),e.jsx(b,{size:"small",label:"Legality",value:(o==null?void 0:o.legality)??"",onChange:a=>D(s=>({...s,legality:a.target.value})),sx:{flex:1}})]}),e.jsx(b,{size:"small",label:"Effect",value:(o==null?void 0:o.effect)??"",onChange:a=>D(s=>({...s,effect:a.target.value})),multiline:!0,minRows:2}),e.jsx(b,{size:"small",label:"Status Effects (comma-separated)",value:(o==null?void 0:o.statusEffects)??"",onChange:a=>D(s=>({...s,statusEffects:a.target.value})),placeholder:'e.g. "carrying_capacity+5"'})]})})]}),e.jsxs(R,{children:[e.jsx(M,{variant:"subtitle2",sx:{mb:1},children:"Inventory"}),n.length===0&&e.jsx(M,{variant:"body2",children:"No inventory items yet."}),n.map(a=>{const s=a.quantity??1,N=(a.bulk??0)*s,S=`${a.name} (${a.type}) • bulk ${N}`;return e.jsxs(Ie,{disableGutters:!0,children:[e.jsx(Me,{expandIcon:e.jsx(De,{}),draggable:!0,onDragStart:x=>{re(a.id??null);try{x.dataTransfer.effectAllowed="move",x.dataTransfer.setData("text/plain",a.id??"")}catch{}},onDragOver:x=>{x.preventDefault(),Y(a.id??null)},onDragLeave:()=>Y(null),onDrop:x=>{x.preventDefault();const F=X??x.dataTransfer.getData("text/plain"),K=a.id;if(F&&K&&F!==K){const Q=t.sheet.inventory??[],C=Q.findIndex(U=>U.id===F),W=Q.findIndex(U=>U.id===K);if(C>=0&&W>=0){const U=[...Q],[c]=U.splice(C,1);U.splice(W,0,c),g(U)}}re(null),Y(null)},sx:A===a.id?{outline:"2px dashed rgba(255,255,255,0.35)",borderRadius:1}:void 0,children:e.jsxs(L,{direction:"row",spacing:1,alignItems:"center",sx:{width:"100%"},children:[e.jsx(qt,{fontSize:"small",sx:{opacity:.5}}),e.jsx(M,{variant:"body2",sx:{flex:1},children:S}),e.jsxs(L,{direction:"row",spacing:.5,alignItems:"center",children:[e.jsx(se,{size:"small",onClick:x=>{x.stopPropagation();const F=(a.quantity??1)-1;F<=0?ne(a.id):m(a.id,{quantity:F})},children:e.jsx(yt,{fontSize:"small"})}),e.jsx(M,{variant:"caption",sx:{minWidth:18,textAlign:"center"},children:a.quantity??1}),e.jsx(se,{size:"small",onClick:x=>{x.stopPropagation(),m(a.id,{quantity:(a.quantity??1)+1})},children:e.jsx(pe,{fontSize:"small"})})]}),e.jsx(ue,{title:"Remove",children:e.jsx(se,{size:"small",onClick:x=>(x.stopPropagation(),ne(a.id)),children:e.jsx(Fe,{fontSize:"small"})})})]})}),e.jsx(Ae,{children:e.jsxs(L,{spacing:1,children:[e.jsxs(L,{direction:{xs:"column",sm:"row"},spacing:1,children:[e.jsx(b,{size:"small",label:"Name",value:a.name??"",onChange:x=>m(a.id,{name:x.target.value}),sx:{flex:1}}),e.jsxs(b,{select:!0,size:"small",label:"Type",value:a.type,onChange:x=>m(a.id,{type:x.target.value}),sx:{width:160},children:[e.jsx(he,{value:"item",children:"Item"}),e.jsx(he,{value:"cyberware",children:"Cyberware"}),e.jsx(he,{value:"narcotics",children:"Narcotics"})]}),e.jsx(b,{size:"small",type:"number",label:"Bulk",value:a.bulk??0,onChange:x=>m(a.id,{bulk:Number(x.target.value)}),sx:{width:120}}),e.jsx(b,{size:"small",type:"number",label:"Quantity",value:a.quantity??1,onChange:x=>{const F=Number(x.target.value);Number.isFinite(F)&&(F<=0?ne(a.id):m(a.id,{quantity:F}))},sx:{width:120}}),e.jsx(b,{size:"small",type:"number",label:"Cost",value:a.cost??0,onChange:x=>m(a.id,{cost:Number(x.target.value)}),sx:{width:140}})]}),a.type==="item"&&e.jsx(b,{size:"small",label:"Uses",value:a.uses??"",onChange:x=>m(a.id,{uses:x.target.value})}),a.type==="cyberware"&&e.jsxs(L,{direction:{xs:"column",sm:"row"},spacing:1,children:[e.jsx(b,{size:"small",type:"number",label:"Tier",value:a.tier??1,onChange:x=>m(a.id,{tier:Number(x.target.value)}),sx:{width:120}}),e.jsx(b,{size:"small",type:"number",label:"Installation Difficulty",value:a.installationDifficulty??0,onChange:x=>m(a.id,{installationDifficulty:Number(x.target.value)}),sx:{width:220}}),e.jsx(b,{size:"small",label:"Requirements",value:a.requirements??"",onChange:x=>m(a.id,{requirements:x.target.value}),sx:{flex:1}})]}),a.type==="cyberware"&&e.jsx(b,{size:"small",label:"Physical Impact",value:a.physicalImpact??"",onChange:x=>m(a.id,{physicalImpact:x.target.value})}),a.type==="narcotics"&&e.jsxs(L,{direction:{xs:"column",sm:"row"},spacing:1,children:[e.jsx(b,{size:"small",type:"number",label:"Uses",value:a.uses??1,onChange:x=>m(a.id,{uses:Number(x.target.value)}),sx:{width:120}}),e.jsx(b,{size:"small",type:"number",label:"Addiction Score",value:a.addictionScore??0,onChange:x=>m(a.id,{addictionScore:Number(x.target.value)}),sx:{width:160}}),e.jsx(b,{size:"small",label:"Legality",value:a.legality??"",onChange:x=>m(a.id,{legality:x.target.value}),sx:{flex:1}})]}),e.jsx(b,{size:"small",label:"Effect",value:a.effect??"",onChange:x=>m(a.id,{effect:x.target.value}),multiline:!0,minRows:2}),e.jsx(b,{size:"small",label:"Status Effects (comma-separated)",value:a.statusEffects??"",onChange:x=>m(a.id,{statusEffects:x.target.value}),placeholder:'e.g. "carrying_capacity+5"'})]})})]},a.id)})]})]})}function Ca(){const[t,n]=w.useState({entries:[],activeTokenId:void 0,updatedAt:Date.now()}),[g,f]=w.useState({}),[v,h]=w.useState(""),[u,o]=w.useState(!1),[D,X]=w.useState(0),re=m=>Math.max(-3,Math.min(3,m)),A=w.useMemo(()=>Ve(ie.learned),[]);w.useEffect(()=>{const m=At(a=>n(a));return()=>m==null?void 0:m()},[]),w.useEffect(()=>{let m=!0;return(async()=>{var a,s,T,N;try{const[S,x]=await Promise.all([((s=(a=O.player).getId)==null?void 0:s.call(a))??Promise.resolve(""),((N=(T=O.player).getRole)==null?void 0:N.call(T))??Promise.resolve("")]);if(!m)return;h(String(S??"")),o(String(x).toUpperCase()==="GM")}catch{}})(),()=>{m=!1}},[]);const Y=w.useMemo(()=>{const m=[...t.entries??[]];return m.sort((a,s)=>(s.initiative??0)-(a.initiative??0)),m},[t.entries]);w.useEffect(()=>{let m=!0;return(async()=>{var a,s,T,N,S,x,F;try{const K=Y.map(W=>W.tokenId);if(!K.length){m&&f({});return}const Q=await O.scene.items.getItems(K),C={};for(const W of Q){const U=W.id,c=await Re(U),y=c==null?void 0:c.armor,P=((a=y==null?void 0:y.durability)==null?void 0:a.current)??0,_=!!y&&P<=0,J=_?0:(y==null?void 0:y.protection)??0,q=(s=c==null?void 0:c.weapons)==null?void 0:s[0],xe=be(q),ke=Number.isFinite(q==null?void 0:q.ammo)?Number(q==null?void 0:q.ammo):0;C[U]={tokenId:U,name:((S=(N=(T=W.text)==null?void 0:T.plainText)==null?void 0:N.trim)==null?void 0:S.call(N))||(c==null?void 0:c.name)||"(Unnamed)",thumbUrl:(x=W.image)==null?void 0:x.url,ownerPlayerId:String(((F=W.metadata)==null?void 0:F[ht])??""),prot:J,armorBroken:_,topWeaponName:q==null?void 0:q.name,topWeaponUseDC:q==null?void 0:q.useDC,topWeaponDamage:q==null?void 0:q.damage,topWeaponSkillId:q==null?void 0:q.skillId,topWeaponAmmo:ke,topWeaponAmmoMax:xe}}m&&f(C)}catch{}})(),()=>{m=!1}},[Y]);async function ae(m){var U,c,y,P,_;const[a]=await O.scene.items.getItems([m]);if(!a)return;const s=await Re(m);if(!s)return;const T=(await tt({statuses:[...(s.feats??[]).map(J=>J.statusEffects??"").filter(Boolean),...(s.inventory??[]).map(J=>J.statusEffects??"").filter(Boolean)]})).deltas,N=await gt({skills:s.skills??{},inherentSkills:ie.inherent??[]}),S=((U=s.stress)==null?void 0:U.current)??0,F=Math.max(0,(await Ge({skills:s.skills??{}})).cuf-(((c=s.stress)==null?void 0:c.cufLoss)??0))+(T.cool_under_fire??0),K=N.ref+(T.ref??0)+(T.reflex??0),Q=S>F,C=(await Pe({netDice:Q?-1:0,modifier:K,label:`${((y=a.text)==null?void 0:y.plainText)??s.name??"Token"} Initiative`})).notation,W=await Je({diceNotation:C,rollTarget:"everyone",showResults:!0});await Pt({tokenId:m,initiative:W,name:((P=a.text)==null?void 0:P.plainText)??s.name??"Token",thumbUrl:(_=a.image)==null?void 0:_.url})}async function oe(){var N,S;const m=await((S=(N=O.player).getSelection)==null?void 0:S.call(N))??[],a=m==null?void 0:m[0],s=await ft()??void 0,T=a||s;if(!T){O.notification.show("Select a token (or set your character) to roll initiative.","WARNING");return}await ae(T)}async function ce(m){var c,y,P;const a=await Re(m);if(!a)return;const s=(c=a.weapons)==null?void 0:c[0];if(!s){O.notification.show("No weapon in the top slot.","WARNING");return}const T=(await tt({statuses:[...(a.feats??[]).map(_=>_.statusEffects??"").filter(Boolean),...(a.inventory??[]).map(_=>_.statusEffects??"").filter(Boolean)]})).deltas,S=(await Ge({skills:a.skills??{}})).cuf-(((y=a.stress)==null?void 0:y.cufLoss)??0)+(T.cool_under_fire??0),F=(((P=a.stress)==null?void 0:P.current)??0)>S,K=String(s.skillId??"");let Q=kt({learnedInfoById:A,skillId:K,ranks:a.skills??{},learningFocus:a.learningFocus,skillMods:T});try{Q=(await mt({learnedByFocus:ie.learned,skillId:K,ranks:a.skills??{},learningFocus:a.learningFocus,skillMods:T})).modifier}catch{}const C=be(s),W=Number.isFinite(s==null?void 0:s.ammo)?Number(s==null?void 0:s.ammo):0;if(C>0&&W<=0){O.notification.show("Out of ammo. Reload first.","WARNING");return}const U=re(D-(F?1:0));if(await jt({weapon:s,netDice:U,modifier:Q,attackerName:a.name,rollTarget:"everyone",showResults:!0}),C>0){const _=Math.max(0,W-1),J=[...a.weapons??[]];J[0]={...J[0],ammo:_},await Ye(m,{...a,weapons:J})}}async function ne(m){var S;const a=await Re(m);if(!a)return;const s=(S=a.weapons)==null?void 0:S[0];if(!s)return;const T=be(s);if(T<=0)return;const N=[...a.weapons??[]];N[0]={...N[0],ammo:T},await Ye(m,{...a,weapons:N})}return e.jsxs(L,{spacing:2,children:[e.jsxs(R,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",gap:1,flexWrap:"wrap"},children:[e.jsx(M,{variant:"h6",sx:{m:0},children:"Initiative"}),e.jsxs(L,{direction:"row",spacing:1,alignItems:"center",children:[e.jsx(fe,{size:"small",variant:"contained",onClick:()=>void oe(),startIcon:e.jsx(Se,{}),children:"Roll Initiative"}),e.jsxs(R,{sx:{display:"flex",alignItems:"center",gap:1,flexWrap:"wrap",pl:1},children:[e.jsx(M,{variant:"body2",sx:{opacity:.8},children:"Attack Roll:"}),e.jsxs(ze,{size:"small",exclusive:!0,value:D,onChange:(m,a)=>{a!==null&&X(a)},children:[e.jsx(V,{value:-2,children:"−2"}),e.jsx(V,{value:-1,children:"−1"}),e.jsx(V,{value:0,children:"0"}),e.jsx(V,{value:1,children:"+1"}),e.jsx(V,{value:2,children:"+2"})]})]}),u&&e.jsxs(e.Fragment,{children:[e.jsx(fe,{size:"small",variant:"outlined",onClick:()=>Tt(),children:"Clear"}),e.jsx(fe,{size:"small",variant:"outlined",onClick:()=>Rt(),children:"Advance"})]})]})]}),e.jsx(Ot,{}),Y.length===0?e.jsx(M,{variant:"body2",sx:{opacity:.75},children:"No initiative rolls yet."}):e.jsx(Ut,{dense:!0,disablePadding:!0,children:Y.map(m=>{const a=g[m.tokenId],s=a==null?void 0:a.ownerPlayerId,T=u||!!s&&s===v,N=t.activeTokenId===m.tokenId,S=N&&T&&!u,x=!!m.surprised,F=(a==null?void 0:a.topWeaponAmmoMax)??0,K=(a==null?void 0:a.topWeaponAmmo)??0,Q=F>0&&K<=0;return e.jsxs(Ht,{sx:{borderRadius:1,mb:.5,bgcolor:N?"rgba(255,255,255,0.06)":"transparent",opacity:x?.55:1},secondaryAction:e.jsxs(L,{direction:"row",spacing:.5,alignItems:"center",children:[e.jsx(ue,{title:a!=null&&a.armorBroken?"Armor broken":"Protection",children:e.jsxs(R,{sx:{display:"inline-flex",alignItems:"center",gap:.5,px:1,py:.5,borderRadius:1,bgcolor:"rgba(0,0,0,0.25)"},children:[e.jsx(Jt,{fontSize:"small",sx:{color:a!=null&&a.armorBroken?"error.main":"inherit"}}),e.jsx(M,{variant:"caption",children:(a==null?void 0:a.prot)??0})]})}),(u||T)&&e.jsx(ue,{title:a!=null&&a.topWeaponName?Q?`Out of ammo: ${a.topWeaponName}`:`Attack: ${a.topWeaponName}`:"No top weapon",children:e.jsx("span",{children:e.jsx(se,{size:"small",disabled:!(a!=null&&a.topWeaponName)||Q,onClick:()=>void ce(m.tokenId),children:e.jsx(Se,{fontSize:"small"})})})}),(u||T)&&e.jsx(ue,{title:a!=null&&a.topWeaponName?F<=0?"No ammo to reload":`Reload: ${a.topWeaponName}`:"No top weapon",children:e.jsx("span",{children:e.jsx(se,{size:"small",disabled:!(a!=null&&a.topWeaponName)||F<=0,onClick:()=>void ne(m.tokenId),children:e.jsx(bt,{fontSize:"small"})})})}),e.jsx(ue,{title:T||u?"Remove":"Only the owner or GM can remove",children:e.jsx("span",{children:e.jsx(se,{size:"small",disabled:!T&&!u,onClick:()=>Et(m.tokenId),children:e.jsx(Fe,{fontSize:"small"})})})})]}),children:[e.jsx($t,{children:e.jsx(Gt,{src:a==null?void 0:a.thumbUrl,variant:"rounded",sx:{width:32,height:32,mr:1,cursor:"pointer"}})}),e.jsx(Yt,{primary:e.jsxs(R,{sx:{display:"flex",alignItems:"center",gap:1,flexWrap:"wrap"},children:[e.jsx(M,{variant:"body2",sx:{fontWeight:600},children:(a==null?void 0:a.name)??m.name??"Token"}),e.jsx(M,{variant:"caption",sx:{opacity:.75},children:m.initiative}),S&&e.jsx(M,{variant:"caption",sx:{px:1,py:.25,borderRadius:1,bgcolor:"rgba(0,128,255,0.2)"},children:"Your Turn"})]}),secondary:e.jsxs(R,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(Kt,{size:"small",checked:x,disabled:!u,onChange:C=>Nt(m.tokenId,C.target.checked)}),e.jsx(M,{variant:"caption",sx:{opacity:.75},children:"Surprised"})]})})]},m.tokenId)})})]})}function Sa(t){return e.jsxs("div",{style:{display:"flex",alignItems:"flex-start",gap:12,justifyContent:"space-between",marginBottom:10},children:[e.jsxs("div",{style:{display:"flex",gap:10,alignItems:"flex-start"},children:[t.thumbUrl?e.jsx("img",{src:t.thumbUrl,alt:"Token thumbnail",style:{width:44,height:44,borderRadius:10,objectFit:"cover",border:"1px solid rgba(0,0,0,0.2)"}}):e.jsx("div",{style:{width:44,height:44,borderRadius:10,border:"1px solid rgba(0,0,0,0.2)",opacity:.4}}),e.jsxs("div",{children:[e.jsxs("div",{style:{fontSize:18,fontWeight:700},children:[t.title," ",e.jsxs("span",{style:{fontSize:12,opacity:.75},children:["(",t.ownerLabel,")"]})]}),e.jsxs("div",{style:{fontSize:12,opacity:.8},children:["Token: ",e.jsx("code",{style:{fontSize:11},children:t.tokenId})]})]})]}),e.jsxs("div",{style:{display:"flex",gap:8},children:[t.showBackButton&&e.jsx("button",{style:{padding:"8px 10px",borderRadius:8,border:"1px solid #999",cursor:"pointer",opacity:.9},onClick:t.onBack,children:"Back to My Sheet"}),t.showUnsetButton&&e.jsx("button",{style:{padding:"8px 10px",borderRadius:8,border:"1px solid #999",cursor:"pointer",opacity:.9},onClick:t.onUnset,children:"Unset “My Character”"})]})]})}function Ia(t){var n,g,f;return e.jsxs("div",{style:ee.statusBar,children:[e.jsxs("div",{style:ee.statusLeft,children:[e.jsxs("div",{style:ee.statusGroup,children:[e.jsx("div",{style:ee.statusLabel,children:"Stress"}),e.jsx("input",{type:"number",min:0,value:((n=t.sheet.stress)==null?void 0:n.current)??0,onChange:v=>t.applyStress(Number(v.target.value)),style:ee.statusNumber})]}),e.jsxs("div",{style:ee.statusGroup,children:[e.jsx("div",{style:ee.statusLabel,children:"Wounds"}),e.jsxs("div",{style:ee.woundsRow,children:[e.jsx("span",{style:ee.woundsKind,children:"L"}),Array.from({length:4}).map((v,h)=>{var u;return e.jsx("input",{type:"checkbox",checked:(((u=t.sheet.wounds)==null?void 0:u.light)??0)>h,onChange:()=>t.toggleWound("light",h)},`wl_${h}`)}),e.jsx("span",{style:{width:8}}),e.jsx("span",{style:ee.woundsKind,children:"M"}),Array.from({length:2}).map((v,h)=>{var u;return e.jsx("input",{type:"checkbox",checked:(((u=t.sheet.wounds)==null?void 0:u.moderate)??0)>h,onChange:()=>t.toggleWound("moderate",h)},`wm_${h}`)}),e.jsx("span",{style:{width:8}}),e.jsx("span",{style:ee.woundsKind,children:"H"}),Array.from({length:1}).map((v,h)=>{var u;return e.jsx("input",{type:"checkbox",checked:(((u=t.sheet.wounds)==null?void 0:u.heavy)??0)>h,onChange:()=>t.toggleWound("heavy",h)},`wh_${h}`)})]})]}),e.jsxs("label",{style:{display:"flex",alignItems:"center",gap:6},children:[e.jsx("input",{type:"checkbox",checked:!!t.sheet.indomitable,onChange:v=>t.setIndomitable(v.target.checked)}),e.jsx("span",{style:{fontSize:12,opacity:.9},children:"Indomitable"})]}),(((g=t.sheet.stress)==null?void 0:g.current)??0)>(((f=t.sheetForView.stress)==null?void 0:f.cuf)??0)&&e.jsx("div",{style:ee.warning,children:"Stress > CUF: make all rolls with +1 Penalty Die"}),e.jsxs("div",{style:{fontSize:12,opacity:.85},children:["Bulk: ",t.totalBulk," / ",t.effectiveCarryingCapacity]}),t.encumbranceLabel&&e.jsx("div",{style:ee.warning,children:t.encumbranceLabel})]}),e.jsxs("div",{style:ee.statusRight,children:[t.crucible&&t.crucible.status==="pending"&&e.jsxs("div",{style:ee.crucibleBox,children:[e.jsx("div",{style:{fontWeight:700},children:"Crucible Test!"}),e.jsxs("div",{style:{fontSize:12,opacity:.85},children:["Incoming stress: ",t.crucible.incoming," • DC ",t.crucible.dc," • Roll CUF (no bonus/penalty dice)"]}),e.jsx("button",{style:ee.buttonSecondary,onClick:()=>t.rollCrucibleTest(t.crucible.incoming),children:"Roll Crucible"})]}),t.crucible&&t.crucible.status==="success"&&e.jsxs("div",{style:ee.crucibleBox,children:[e.jsx("div",{style:{fontWeight:700},children:"Crucible succeeded!"}),e.jsx("div",{style:{fontSize:12,opacity:.85},children:"Choose an Indomitable effect. (Indomitable checked automatically.)"})]}),t.crucible&&t.crucible.status==="fail"&&e.jsxs("div",{style:ee.crucibleBox,children:[e.jsx("div",{style:{fontWeight:700},children:"Crucible failed"}),e.jsx("div",{style:{fontSize:12,opacity:.85},children:"You’ve entered PTSD range (6–8 stress)."}),e.jsx("button",{style:ee.buttonSecondary,onClick:t.burnCufToPass,children:"Spend 1 CUF to pass"})]})]})]})}const ee={statusBar:{display:"flex",alignItems:"flex-start",justifyContent:"space-between",gap:12,padding:"10px 12px",borderRadius:12,border:"1px solid rgba(255,255,255,0.15)",marginBottom:10},statusLeft:{display:"flex",alignItems:"center",gap:16,flexWrap:"wrap"},statusRight:{display:"flex",alignItems:"center",gap:12},statusGroup:{display:"flex",flexDirection:"column",gap:4},statusLabel:{fontSize:11,opacity:.75,letterSpacing:.2},statusNumber:{width:64,fontSize:16},woundsRow:{display:"flex",alignItems:"center",gap:8,flexWrap:"wrap"},woundsKind:{fontSize:11,opacity:.75,width:14,textAlign:"center"},warning:{marginTop:8,fontSize:12,opacity:.9},crucibleBox:{border:"1px solid rgba(255,255,255,0.18)",borderRadius:12,padding:10,maxWidth:240},buttonSecondary:{padding:"6px 10px",borderRadius:8,border:"1px solid #999",cursor:"pointer",opacity:.9,background:"transparent"}};function Ma(t){const n=pt(),g=n.palette.text.primary,f=n.palette.mode==="dark"?"rgba(255,255,255,0.25)":"#777",v=n.palette.mode==="dark"?"rgba(255,255,255,0.12)":"transparent";return e.jsxs("div",{style:{display:"flex",gap:8,alignItems:"center",marginBottom:10},children:[e.jsx(ve,{label:"Core",active:t.activeTab==="core",onClick:()=>t.onTab("core"),color:g,borderColor:f,activeBg:v}),e.jsx(ve,{label:"Skills",active:t.activeTab==="skills",onClick:()=>t.onTab("skills"),color:g,borderColor:f,activeBg:v}),e.jsx(ve,{label:"Combat",active:t.activeTab==="combat",onClick:()=>t.onTab("combat"),color:g,borderColor:f,activeBg:v}),e.jsx(ve,{label:"Initiative",active:t.activeTab==="initiative",onClick:()=>t.onTab("initiative"),color:g,borderColor:f,activeBg:v}),e.jsx(ve,{label:"Inventory",active:t.activeTab==="inventory",onClick:()=>t.onTab("inventory"),color:g,borderColor:f,activeBg:v}),e.jsx(ve,{label:"Feats",active:t.activeTab==="feats",onClick:()=>t.onTab("feats"),color:g,borderColor:f,activeBg:v}),e.jsx("div",{style:{marginLeft:"auto",opacity:.8},children:t.isSaving?"Saving…":"Synced"})]})}function ve(t){return pt().palette.mode,e.jsx("button",{onClick:t.onClick,style:{padding:"6px 10px",borderRadius:999,border:`1px solid ${t.borderColor}`,cursor:"pointer",background:t.active?t.activeBg:"transparent",fontWeight:t.active?700:400,color:t.color,outline:"none",boxShadow:"none",appearance:"none"},children:t.label})}function ct(t,n){const g={phys:0,ref:0,soc:0,ment:0};for(const f of n){const v=Number((t==null?void 0:t[f.id])??0),h=f.attribute;h&&h in g&&(g[h]+=Math.max(0,v))}return{phys:Math.max(0,Math.ceil(g.phys/4)),ref:Math.max(0,Math.ceil(g.ref/4)),soc:Math.max(0,Math.ceil(g.soc/4)),ment:Math.max(0,Math.ceil(g.ment/4))}}function $e(t){const g=["instinct","willpower","bearing","toughness","tactics"].reduce((f,v)=>f+Math.max(0,Math.trunc(Number(t[v]??0))),0);return 1+Math.ceil(g/5)}function Da(t){const n={};if(!t)return n;const g=t.split(",").map(f=>f.trim()).filter(Boolean);for(const f of g){const v=f.match(/^([a-zA-Z0-9_\-]+)\s*[:]?\s*([+\-])\s*(\d+)$/);if(!v)continue;const h=String(v[1]).toLowerCase().replace(/\s+/g,"_"),u=v[2]==="-"?-1:1,o=Math.trunc(Number(v[3]));Number.isFinite(o)&&(n[h]=(n[h]??0)+u*o)}return n}function Aa(t){const n={};for(const g of t){const f=Da(g??"");for(const[v,h]of Object.entries(f))n[v]=(n[v]??0)+h}return n}function Ta(){var Qe,Xe,Ze,et;const[t,n]=w.useState({kind:"loading"}),[g,f]=w.useState("core"),[v,h]=w.useState(!1),[u,o]=w.useState(null),[D,X]=w.useState(!1),[re,A]=w.useState([]);async function Y(i){var r,j,k,I,B,z;try{const H=await O.scene.items.getItems([i]),E=H==null?void 0:H[0];if(!E)return{ownerLabel:"unowned",thumbUrl:null};const Z=((r=E==null?void 0:E.image)==null?void 0:r.url)??((j=E==null?void 0:E.image)==null?void 0:j.href)??(E==null?void 0:E.imageUrl)??(E==null?void 0:E.image)??((k=E==null?void 0:E.thumbnail)==null?void 0:k.url)??null,te=(I=E==null?void 0:E.metadata)==null?void 0:I[ht];if(typeof te!="string"||te.length===0)return{ownerLabel:"unowned",thumbUrl:Z,ownerPlayerId:null,isOwnedByMe:!1};const de=await O.player.getId();if(te===de)return{ownerLabel:"owned by you",thumbUrl:Z,ownerPlayerId:te,isOwnedByMe:!0};try{const $=(await((z=(B=O.party).getPlayers)==null?void 0:z.call(B))??[]).find(ge=>(ge==null?void 0:ge.id)===te);return{ownerLabel:`owned by ${typeof($==null?void 0:$.name)=="string"&&$.name.length>0?$.name:te}`,thumbUrl:Z,ownerPlayerId:te,isOwnedByMe:!1}}catch{return{ownerLabel:`owned by ${te}`,thumbUrl:Z,ownerPlayerId:te,isOwnedByMe:!1}}}catch{return{ownerLabel:"unowned",thumbUrl:null,ownerPlayerId:null,isOwnedByMe:!1}}}async function ae(i){try{const[r,j]=await Promise.all([gt({skills:i.skills??{},inherentSkills:ie.inherent??[]}),Ge({skills:i.skills??{}})]);return{...i,attributes:{...i.attributes,...r},stress:{...i.stress??{current:0,cuf:0,cufLoss:0},cuf:j.cuf}}}catch{const r=ct(i.skills??{},ie.inherent??[]);return{...i,attributes:{...i.attributes,...r},stress:{...i.stress??{current:0,cuf:0,cufLoss:0},cuf:$e(i.skills??{})}}}}async function oe(i){const r=i!=null&&i.ignoreOpenOverride?null:await zt();if(r)if(await _e(r)){const Z=await Le(r);if(!Z)throw new Error("Could not load sheet from token.");const te=await ae(Z),de=await Y(r);n({kind:"ready",tokenId:r,sheet:te,mode:"view",suppressUnset:!0,...de});return}else await Be(null);let k=await ft();if(k||(k=await at(),k&&await we(k)),!k){n({kind:"need-token"});return}let I=await _e(k);if(!I){const E=await at();E&&(k=E,await we(k),I=await _e(k))}if(!I){await we(null),n({kind:"need-token"});return}const B=await Le(k);if(!B)throw new Error("Could not load sheet from token.");try{await nt(k)}catch{}const z=await ae(B),H=await Y(k);n({kind:"ready",tokenId:k,sheet:z,mode:"my",suppressUnset:!!(i!=null&&i.suppressUnset),...H})}w.useEffect(()=>{let i=!1;return O.onReady(async()=>{try{const r=await O.player.getRole();i||X(String(r).toUpperCase()==="GM"),await oe()}catch(r){i||n({kind:"error",message:r.message??"Unknown error"})}}),()=>{i=!0}},[]),w.useEffect(()=>{let i=null,r=!1;return O.onReady(()=>{r||(i=O.broadcast.onMessage(Ke,j=>{const k=j.data;k!=null&&k.text&&A(I=>[...I,k].slice(-3))}))}),()=>{if(r=!0,typeof i=="function")try{i()}catch{}}},[]),w.useEffect(()=>{let i=null,r=null,j=!1;const k="whisperspace.combatLogLeader",I=2e3,B=6e3,z=`${Date.now()}-${Math.random().toString(36).slice(2,10)}`,H=()=>{try{const $=localStorage.getItem(k);return $?JSON.parse($):null}catch{return null}},E=$=>{try{localStorage.setItem(k,JSON.stringify({id:z,ts:$??Date.now()}))}catch{}},Z=()=>{const $=H();return $&&$.id===z},te=()=>{const $=Date.now(),le=H();(!le||$-(le.ts??0)>B||le.id===z)&&E($)},de=()=>{const $=Z();if($&&!i)i=O.broadcast.onMessage(Ke,le=>{const ge=le.data;ge!=null&&ge.text&&O.notification.show(String(ge.text),"INFO")});else if(!$&&i){try{i()}catch{}i=null}},ye=$=>{$.key===k&&de()};return O.onReady(()=>{if(!j){try{window.addEventListener("storage",ye)}catch{}te(),de(),r=window.setInterval(()=>{j||(te(),de())},I)}}),()=>{j=!0;try{window.removeEventListener("storage",ye)}catch{}if(r!==null&&clearInterval(r),Z())try{localStorage.removeItem(k)}catch{}if(typeof i=="function")try{i()}catch{}}},[]);function ce(i,r,j){const k={text:`${i} took ${r} damage${j?` and +${j} stress`:""}.`,ts:Date.now(),kind:"effect",targetName:i,damageApplied:r,stressApplied:j};A(I=>[...I,k].slice(-3))}async function ne(i){var I;if(t.kind!=="ready"||t.mode!=="my")return;const r=Math.max(0,Math.trunc(i.damageApplied??0)),j=Math.max(0,Math.trunc(i.stressApplied??0));if(r<=0&&j<=0)return;const k=await wt({sheet:t.sheet,incomingDamage:r,stressDelta:j});k.stressDelta>0&&F(((I=k.sheet.stress)==null?void 0:I.current)??0),ce(t.sheet.name||"Target",r,j),S(()=>k.sheet)}w.useEffect(()=>{var I,B,z,H;if(t.kind!=="ready")return;const i=t.tokenId;let r=!1;const j=async()=>{var E,Z;try{const te=await O.scene.items.getItems([i]),de=te==null?void 0:te[0],ye=String(((E=de==null?void 0:de.text)==null?void 0:E.plainText)??"").trim(),$=(Z=de==null?void 0:de.image)==null?void 0:Z.url;if(r||!ye&&!$)return;n(le=>{if(le.kind!=="ready"||le.tokenId!==i)return le;const ge=ye&&le.sheet.name!==ye?{...le.sheet,name:ye}:le.sheet;return{...le,sheet:ge,thumbUrl:$??le.thumbUrl}})}catch{}};j();const k=(H=(z=(B=(I=O)==null?void 0:I.scene)==null?void 0:B.items)==null?void 0:z.onChange)==null?void 0:H.call(z,E=>{Array.isArray(E)&&E.some(Z=>(Z==null?void 0:Z.id)===i)&&j()});return()=>{r=!0,typeof k=="function"&&k()}},[t.kind,t.kind==="ready"?t.tokenId:null]);const m=w.useMemo(()=>t.kind==="ready"&&t.sheet.name||"Whisperspace Character Sheet",[t]);async function a(){const i=await ea();if(!i){n({kind:"error",message:"No token selected. Select a token on the map first."});return}const r=await Le(i);if(!r){n({kind:"error",message:"Could not attach a sheet to the selected token."});return}const j=await ae(r);await we(i);try{await nt(i)}catch{}await Be(null);const k=await Y(i);n({kind:"ready",tokenId:i,sheet:j,mode:"my",suppressUnset:!1,...k})}async function s(){await we(null);try{await Ft()}catch{}n({kind:"need-token"})}async function T(){await Be(null),n({kind:"loading"});try{await oe({ignoreOpenOverride:!0,suppressUnset:!0})}catch(i){n({kind:"error",message:i.message??"Unknown error"})}}async function N(i,r){h(!0);try{await Ye(i,r)}finally{h(!1)}}function S(i){n(r=>{if(r.kind!=="ready")return r;let j=i(r.sheet);try{const k=ct(j.skills??{},ie.inherent??[]);j={...j,attributes:{...j.attributes,...k},stress:{...j.stress??{current:0,cuf:0,cufLoss:0},cuf:$e(j.skills??{})}}}catch{}return N(r.tokenId,j),(async()=>{try{const k=await ae(j);n(I=>I.kind!=="ready"||I.tokenId!==r.tokenId?I:{...I,sheet:k}),await N(r.tokenId,k)}catch{}})(),{...r,sheet:j}})}async function x(i){var H;if(t.kind!=="ready")return;const r=8+i,j=Math.max(0,Math.trunc(((H=t.sheet.stress)==null?void 0:H.cuf)??0)),k=`Crucible Test (DC ${r})`,I=j===0?"":` +${j}`,B=`1d12 # ${k}${I}`;let z;try{z=await Je({diceNotation:B,rollTarget:"everyone",showResults:!0,timeoutMs:6e3})}catch{O.notification.show("Dice+ roll failed or timed out.","WARNING");return}z>=r?(S(E=>({...E,stress:{...E.stress??{current:0,cuf:0,cufLoss:0},current:5},indomitable:!0})),o({incoming:i,dc:r,status:"success",total:z})):o({incoming:i,dc:r,status:"fail",total:z})}function F(i){var k;if(t.kind!=="ready")return;const r=Math.max(0,Math.trunc(((k=t.sheet.stress)==null?void 0:k.current)??0)),j=Math.max(0,Math.trunc(i));if(r<=5&&j>5){const I=j-r;o({incoming:I,dc:8+I,status:"pending"})}else o(null);S(I=>({...I,stress:{...I.stress??{current:0,cuf:0,cufLoss:0},current:j}}))}function K(i,r){var z;if(t.kind!=="ready")return;const k={light:4,moderate:2,heavy:1}[i],I=Math.max(0,Math.trunc(((z=t.sheet.wounds)==null?void 0:z[i])??0)),B=r<I?r:r+1;S(H=>({...H,wounds:{...H.wounds,[i]:Math.min(k,Math.max(0,B))}}))}function Q(){var r;if(t.kind!=="ready"||!u||u.status!=="fail")return;const i=Math.max(0,Math.trunc(((r=t.sheet.stress)==null?void 0:r.cufLoss)??0));S(j=>({...j,stress:{...j.stress??{current:0,cuf:0,cufLoss:0},cufLoss:i+1,current:5},indomitable:!0})),o({...u,status:"success"})}const C=t.kind==="ready"?t.sheet:null,W=Ce.useMemo(()=>{if(!C)return{};const i=[];return(C.feats??[]).forEach(r=>{typeof(r==null?void 0:r.statusEffects)=="string"&&r.statusEffects.trim()&&i.push(r.statusEffects)}),(C.inventory??[]).forEach(r=>{typeof(r==null?void 0:r.statusEffects)=="string"&&r.statusEffects.trim()&&i.push(r.statusEffects)}),Aa(i)},[C]),U=Ce.useMemo(()=>{const i={},r=new Map,j=I=>{const B=String(I.id),z=String(I.name??I.label??"").toLowerCase().replace(/\s+/g,"_").replace(/[^a-z0-9_\-()]/g,"");B&&(r.set(B.toLowerCase(),B),z&&r.set(z,B))};(ie.inherent??[]).forEach(j),Object.values(ie.learned??{}).forEach(I=>{(I??[]).forEach(j)});const k=new Set(["phys","ref","soc","ment","carrying_capacity","cool_under_fire","speed","cuf","carry","capacity","spd"]);return Object.entries(W??{}).forEach(([I,B])=>{const z=String(I).toLowerCase();if(k.has(z))return;const H=r.get(z);H&&(i[H]=(i[H]??0)+(Number.isFinite(B)?B:0))}),i},[W]),c=Math.max(0,(((Qe=C==null?void 0:C.attributes)==null?void 0:Qe.phys)??0)+(W.phys??0)),y=Math.max(0,(((Xe=C==null?void 0:C.attributes)==null?void 0:Xe.ref)??0)+(W.ref??0)),P=Math.max(0,(((Ze=C==null?void 0:C.attributes)==null?void 0:Ze.soc)??0)+(W.soc??0)),_=Math.max(0,(((et=C==null?void 0:C.attributes)==null?void 0:et.ment)??0)+(W.ment??0)),q=5+c*5+(W.carrying_capacity??0);30+c*5+(W.speed??0);const ke=C?$e(C.skills??{}):0,je=Math.max(0,ke+(W.cool_under_fire??0)),l=Ce.useMemo(()=>C?{...C,attributes:{...C.attributes,phys:c,ref:y,soc:P,ment:_},stress:{...C.stress??{current:0,cuf:0,cufLoss:0},cuf:je}}:null,[C,c,y,P,_,je])??C,d=Ce.useMemo(()=>{var k;if(!C)return 0;const i=(C.weapons??[]).reduce((I,B)=>I+(B.bulk??0),0),r=((k=C.armor)==null?void 0:k.bulk)??0,j=(C.inventory??[]).reduce((I,B)=>{const z=B.quantity??1,H=B.bulk??0,E=Number.isFinite(H)?H:0,Z=Number.isFinite(z)?z:1;return I+E*Z},0);return i+r+j},[C]),p=C&&d>q*2?"Heavily Encumbered":C&&d>q?"Encumbered":"";if(t.kind==="loading")return e.jsx("div",{style:{padding:12},children:"Loading…"});if(t.kind==="need-token")return e.jsxs("div",{style:{padding:12},children:[e.jsx("h2",{style:{margin:"0 0 8px 0"},children:"Whisperspace Character Sheet"}),e.jsx("p",{style:{margin:"0 0 10px 0",lineHeight:1.35},children:"Select your character token on the map, then click:"}),e.jsx("button",{style:{padding:"8px 10px",borderRadius:8,border:"1px solid #666",cursor:"pointer"},onClick:a,children:"Set Selected Token as My Character"})]});if(t.kind==="error")return e.jsxs("div",{style:{padding:12},children:[e.jsx("h2",{style:{margin:"0 0 8px 0"},children:"Error"}),e.jsx("p",{style:{margin:"0 0 10px 0",lineHeight:1.35},children:t.message}),e.jsx("button",{style:{padding:"8px 10px",borderRadius:8,border:"1px solid #666",cursor:"pointer"},onClick:()=>n({kind:"need-token"}),children:"Back"})]});const G=t.ownerLabel??(t.mode==="view"?"Viewing token":"My Character"),me=t.mode==="view"&&!t.isOwnedByMe,Te=t.mode==="my"&&!t.suppressUnset;return e.jsxs("div",{style:{padding:12},children:[e.jsx(Sa,{title:m,ownerLabel:G,tokenId:t.tokenId,thumbUrl:t.thumbUrl??null,showBackButton:me,onBack:T,showUnsetButton:Te,onUnset:s}),e.jsxs(e.Fragment,{children:[e.jsx(Ia,{sheet:t.sheet,sheetForView:l,totalBulk:d,effectiveCarryingCapacity:q,encumbranceLabel:p,crucible:u,applyStress:F,toggleWound:K,setIndomitable:i=>S(r=>({...r,indomitable:i})),rollCrucibleTest:x,burnCufToPass:Q}),e.jsx(Ma,{activeTab:g,onTab:f,isSaving:v}),e.jsxs("div",{style:{border:"1px solid #888",borderRadius:12,padding:10},children:[g==="core"&&e.jsx(ta,{sheet:l,onChange:i=>S(r=>({...r,...i}))}),g==="skills"&&e.jsx(na,{sheet:l,skillMods:U,onChange:i=>S(r=>({...r,skills:i})),onMetaChange:i=>S(r=>({...r,...i}))}),g==="combat"&&e.jsx(ma,{sheet:l,tokenId:t.tokenId,skillMods:U,onChange:i=>S(r=>({...r,...i})),onApplyStress:F,combatLog:re,onApplyCombatLog:t.mode==="my"?ne:void 0,isGM:D}),g==="initiative"&&e.jsx(Ca,{}),g==="inventory"&&e.jsx(wa,{sheet:l,onChange:i=>S(r=>({...r,...i}))}),g==="feats"&&e.jsx(ia,{sheet:l,onChange:i=>S(r=>({...r,feats:i}))})]})]})]})}async function Ra(){await O.onReady(async()=>{}),Ct.createRoot(document.getElementById("root")).render(e.jsx(Ce.StrictMode,{children:e.jsx(Xt,{children:e.jsx(Ta,{})})}))}Ra();
