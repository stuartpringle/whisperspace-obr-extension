import"./config-BSaTKKvG.js";import{r as C,j as e,d as je,e as jt}from"./vendor_react-XzhcIodj.js";import{O as $}from"./vendor_obr-BLY5dk8V.js";import{c as Re,r as lt,a as wt,s as oe,F as Ct,b as Ye,d as St,g as rt,e as It,f as ot,o as Dt,l as Me,T as ct,h as Mt,i as At,j as Tt,k as Rt,m as dt,n as Ue,p as He,q as $e,t as ut,u as Nt,v as Pt,w as We,x as Fe,y as Ze,z as ve,A as et,B as Et}from"./initiative-Cuk8c7rh.js";import{S as B,B as M,T as D,a as Ne,b as V,c as g,d as me,I as mt,e as ne,C as we,R as zt,A as Ce,f as Se,E as Ie,g as De,h as fe,i as ht,j as be,P as Wt,D as Pe,L as tt,k as Ft,M as he,l as ft,m as at,n as Lt,o as Bt,p as _t,q as qt,r as Ot,s as Ut,t as Ht,u as $t,v as Gt,w as Yt,x as gt}from"./vendor_mui-CPCl1AAX.js";import{g as Ae,a as Kt,r as Jt,O as Vt}from"./ObrMuiThemeProvider-D1OJ2jnZ.js";import"./vendor-CPvQcOsy.js";import"./vendor_zod-CxP395f9.js";import"./vendor_emotion-pcfylbOS.js";async function Qt(){const t=await $.player.getSelection();return Array.isArray(t)?t:[]}async function Xt(){const t=await Qt();return t.length>0?t[0]:null}async function Le(t){return(await $.scene.items.getItems([t])).length>0}function Zt(t){var m;const n=t.sheet,[v,b]=C.useState(0),T=C.useMemo(()=>n.attributes??{phys:0,ref:0,soc:0,ment:0},[n.attributes]);async function f(u,A){const Q=Number(T[u]??0),ie=(await Re({netDice:v,modifier:Q,label:A})).notation;await lt({diceNotation:ie,showResults:!0,rollTarget:"everyone"})}return e.jsxs(B,{spacing:2,children:[e.jsxs(M,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",gap:2,flexWrap:"wrap"},children:[e.jsx(D,{variant:"h6",sx:{m:0},children:"Core"}),e.jsxs(M,{sx:{display:"flex",alignItems:"center",gap:1,flexWrap:"wrap"},children:[e.jsx(D,{variant:"subtitle2",sx:{opacity:.8},children:"Attribute Roll:"}),e.jsxs(Ne,{size:"small",exclusive:!0,value:v,onChange:(u,A)=>{A!==null&&b(A)},children:[e.jsx(V,{value:-2,children:"−2"}),e.jsx(V,{value:-1,children:"−1"}),e.jsx(V,{value:0,children:"0"}),e.jsx(V,{value:1,children:"+1"}),e.jsx(V,{value:2,children:"+2"})]})]})]}),e.jsx(g,{label:"Name",size:"small",value:n.name??"",onChange:u=>t.onChange({name:u.target.value}),fullWidth:!0}),e.jsxs(M,{sx:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:1},children:[e.jsx(Te,{label:"PHYS",tooltip:Ae("PHYS"),value:T.phys,onRoll:()=>f("phys","PHYS Check")}),e.jsx(Te,{label:"REF",tooltip:Ae("REF"),value:T.ref,onRoll:()=>f("ref","REF Check")}),e.jsx(Te,{label:"SOC",tooltip:Ae("SOC"),value:T.soc,onRoll:()=>f("soc","SOC Check")}),e.jsx(Te,{label:"MENT",tooltip:Ae("MENT"),value:T.ment,onRoll:()=>f("ment","MENT Check")})]}),e.jsxs(M,{sx:{display:"grid",gridTemplateColumns:"repeat(3, 1fr)",gap:2},children:[e.jsx(g,{label:"Cool Under Fire",size:"small",value:((m=t.sheet.stress)==null?void 0:m.cuf)??0,inputProps:{readOnly:!0},fullWidth:!0}),e.jsx(g,{label:"Speed",size:"small",value:30+(T.phys??0)*5,inputProps:{readOnly:!0},fullWidth:!0}),e.jsx(g,{label:"Carrying Capacity",size:"small",value:5+(T.phys??0)*5,inputProps:{readOnly:!0},fullWidth:!0})]}),e.jsx(D,{variant:"body2",sx:{opacity:.75},children:"Attributes are derived automatically from skill ranks (¼ of total ranks under each attribute, rounded up)."})]})}function Te(t){return e.jsxs(M,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsxs(M,{sx:{flex:1,display:"flex",alignItems:"center",gap:.5},children:[e.jsx(g,{label:t.label,size:"small",value:t.value,inputProps:{readOnly:!0},fullWidth:!0}),t.tooltip?e.jsx(me,{title:t.tooltip,children:e.jsx(mt,{fontSize:"small",sx:{opacity:.7}})}):null]}),e.jsx(me,{title:"Roll with Dice+",children:e.jsx(ne,{onClick:t.onRoll,"aria-label":`Roll ${t.label}`,children:e.jsx(we,{})})})]})}function ea(t){const n=new Map;return Object.keys(t??{}).forEach(v=>{(t[v]??[]).forEach(b=>n.set(b.id,{focus:v}))}),n}const ta=["phys","ref","soc","ment"],Be={phys:"PHYSIQUE",ref:"REFLEX",soc:"SOCIAL",ment:"MENTAL"},_e={combat:"Combat",education:"Education",vehicles:"Vehicles"},nt={combat:"Combat Focus",education:"Education Focus",vehicles:"Vehicles Focus"};function qe(t){const n=xt(t,0,5);return n*(n+1)/2}function aa(t){const[n,v]=C.useState(""),[b,T]=C.useState(0),[f,m]=C.useState(!0),[u,A]=C.useState(!1),[Q,ie]=C.useState(""),S=t.sheet.skills??{},te=t.sheet.learningFocus??"combat",ae=Number(t.sheet.skillPoints??0);C.useEffect(()=>{let d=!1;return(async()=>{const x=await wt();d||(m(x),A(!0))})().catch(()=>{d||(m(!1),A(!0))}),()=>{d=!0}},[]);const re=C.useMemo(()=>ea(oe.learned),[]);function G(d){const x=re.get(d.id);return x?x.focus===te?5:2:5}function p(d){var F;const x=S[d.id]??0,W=((F=t.skillMods)==null?void 0:F[d.id])??0;if(x>0)return x+W;const Y=re.get(d.id);return Y&&Y.focus===te?0+W:-1+W}const s=C.useMemo(()=>{let d=0;for(const x of Object.values(S))d+=qe(x??0);return d},[S]),a=Math.max(0,ae-s),i=d=>{const x=Math.max(0,Math.trunc(Number(Q)));if(!x)return;const W=ae+d*x,Y=Math.max(s,W);t.onMetaChange({skillPoints:Y}),ie("")};function N(d){t.onChange(d)}function P(d,x){const W=S[d.id]??0,Y=G(d),F=xt(x,0,Y);if(F===W||qe(F)-qe(W)>a)return;const ce={...S};F===0?delete ce[d.id]:ce[d.id]=F,N(ce)}async function R(d){const x=(await Re({netDice:b,modifier:p(d),label:d.label})).notation;try{await lt({diceNotation:x,showResults:!0,rollTarget:"everyone"})}catch(W){console.error("Dice+ roll request failed:",W)}}const h=C.useMemo(()=>{const d=Object.values(oe.learned).flat();return[...oe.inherent,...d]},[]),O=C.useMemo(()=>{const d=n.trim().toLowerCase();return d?h.filter(x=>x.label.toLowerCase().includes(d)||x.id.toLowerCase().includes(d)):h},[h,n]),Z=C.useMemo(()=>na(oe.inherent),[]),J=C.useMemo(()=>oe.learned,[]),j=n.trim().length>0,H=e.jsxs(M,{sx:{display:"flex",alignItems:"center",gap:2,flexWrap:"wrap"},children:[e.jsx(D,{variant:"subtitle2",sx:{opacity:.8},children:"Learning Focus:"}),Object.keys(nt).map(d=>e.jsxs(M,{sx:{display:"flex",alignItems:"center",gap:.5,cursor:"pointer"},onClick:()=>t.onMetaChange({learningFocus:d}),children:[e.jsx(zt,{checked:te===d,value:d,size:"small"}),e.jsx(D,{variant:"body2",children:_e[d]})]},d))]}),L=e.jsx(M,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",gap:2,flexWrap:"wrap"},children:e.jsxs(M,{sx:{display:"flex",alignItems:"center",gap:1,flexWrap:"wrap"},children:[e.jsxs(D,{variant:"subtitle2",sx:{minWidth:170},children:["Skill Points: ",a," ",e.jsxs("span",{style:{opacity:.75},children:["(Total: ",ae,")"]})]}),e.jsx(fe,{size:"small",variant:"outlined",onClick:()=>i(1),disabled:!Number.isFinite(Number(Q))||Math.trunc(Number(Q))<=0,children:"+"}),e.jsx(g,{label:"SP",size:"small",type:"number",value:Q,onChange:d=>ie(d.target.value),sx:{width:110}}),e.jsx(fe,{size:"small",variant:"outlined",onClick:()=>i(-1),disabled:!Number.isFinite(Number(Q))||Math.trunc(Number(Q))<=0,children:"-"}),e.jsx(D,{variant:"subtitle2",sx:{opacity:.8},children:"Roll"}),e.jsxs(Ne,{size:"small",exclusive:!0,value:b,onChange:(d,x)=>{x!==null&&T(x)},"aria-label":"Bonus / Penalty dice",children:[e.jsx(V,{value:-2,children:"−2"}),e.jsx(V,{value:-1,children:"−1"}),e.jsx(V,{value:0,children:"0"}),e.jsx(V,{value:1,children:"+1"}),e.jsx(V,{value:2,children:"+2"})]}),u&&!f&&e.jsx(D,{variant:"caption",sx:{opacity:.8},children:"(Dice+ not detected)"})]})});return e.jsxs(B,{spacing:2,children:[H,e.jsx(g,{label:"Search skills",value:n,onChange:d=>v(d.target.value),placeholder:"stealth, weapons, navigation…",fullWidth:!0}),L,j?e.jsx(B,{spacing:1,children:O.map(d=>{const x=re.get(d.id),W=x?_e[x.focus]:Be[d.attribute];return e.jsx(Oe,{skill:d,rank:S[d.id]??0,modifier:p(d),maxRank:G(d),onRank:Y=>P(d,Y),rightTag:W,canRoll:f,onRoll:()=>R(d)},d.id)})}):e.jsxs(e.Fragment,{children:[e.jsx(D,{variant:"subtitle1",children:"Inherent Skills"}),ta.map(d=>e.jsxs(Ce,{defaultExpanded:!0,children:[e.jsx(Se,{expandIcon:e.jsx(Ie,{}),children:e.jsx(D,{fontWeight:700,children:Be[d]})}),e.jsx(De,{children:e.jsx(B,{spacing:1,children:(Z[d]??[]).map(x=>e.jsx(Oe,{skill:x,rank:S[x.id]??0,modifier:p(x),maxRank:G(x),onRank:W=>P(x,W),rightTag:Be[x.attribute],canRoll:f,onRoll:()=>R(x)},x.id))})})]},d)),e.jsx(D,{variant:"subtitle1",sx:{mt:1},children:"Learned Skills"}),Object.keys(J).map(d=>e.jsxs(Ce,{defaultExpanded:!0,children:[e.jsx(Se,{expandIcon:e.jsx(Ie,{}),children:e.jsx(D,{fontWeight:700,children:nt[d]})}),e.jsx(De,{children:e.jsx(B,{spacing:1,children:(J[d]??[]).map(x=>e.jsx(Oe,{skill:x,rank:S[x.id]??0,modifier:p(x),maxRank:G(x),onRank:W=>P(x,W),rightTag:_e[d],canRoll:f,onRoll:()=>R(x)},x.id))})})]},d))]})]})}function Oe(t){const n=t.rank<t.maxRank,v=t.rank>0,b=Kt(t.skill.label);return e.jsxs(M,{sx:{display:"grid",gridTemplateColumns:"1fr auto auto auto",gap:1,alignItems:"center",border:"1px solid",borderColor:"divider",borderRadius:2,px:1.25,py:1},children:[e.jsxs(M,{sx:{minWidth:0},children:[e.jsxs(M,{sx:{display:"flex",alignItems:"center",gap:.5,minWidth:0},children:[e.jsx(D,{fontWeight:600,noWrap:!0,children:t.skill.label}),b?e.jsx(me,{title:b,children:e.jsx(mt,{fontSize:"small",sx:{opacity:.7,flexShrink:0}})}):null]}),e.jsx(D,{variant:"caption",sx:{opacity:.7},noWrap:!0,children:t.rightTag??""})]}),e.jsxs(M,{sx:{width:46,textAlign:"center"},children:[e.jsx(D,{variant:"caption",sx:{opacity:.7,lineHeight:1},children:"Mod"}),e.jsx(D,{sx:{fontWeight:700,lineHeight:1.2},children:t.modifier>=0?`+${t.modifier}`:`${t.modifier}`})]}),e.jsxs(M,{sx:{width:40,textAlign:"center"},children:[e.jsx(D,{variant:"caption",sx:{opacity:.7,lineHeight:1},children:"Rank"}),e.jsx(D,{sx:{fontWeight:700,lineHeight:1.2},children:t.rank})]}),e.jsxs(M,{sx:{display:"flex",gap:.5,alignItems:"center",justifyContent:"flex-end"},children:[e.jsx(ne,{size:"small",onClick:()=>t.onRank(t.rank-1),"aria-label":"Decrease rank",disabled:!v,children:e.jsx(ht,{fontSize:"small"})}),e.jsx(ne,{size:"small",onClick:()=>t.onRank(t.rank+1),"aria-label":"Increase rank",disabled:!n,children:e.jsx(be,{fontSize:"small"})}),e.jsx(M,{sx:{width:6}}),e.jsx(me,{title:t.canRoll?"Roll with Dice+":"Dice+ not detected",children:e.jsx("span",{children:e.jsx(ne,{size:"small",onClick:t.onRoll,"aria-label":`Roll ${t.skill.label}`,disabled:!t.canRoll,children:e.jsx(we,{fontSize:"small"})})})})]})]})}function na(t){return t.reduce((n,v)=>{var b;return(n[b=v.attribute]??(n[b]=[])).push(v),n},{})}function xt(t,n,v){const b=Number.isFinite(t)?Math.trunc(t):n;return Math.max(n,Math.min(v,b))}function sa(t){const n=t.sheet.feats??[];function v(){t.onChange([...n,{name:"New Feat",description:"",statusEffects:""}])}function b(f,m){const u=[...n];u[f]={...u[f],...m},Ct.safeParse(u[f]),t.onChange(u)}function T(f){const m=[...n];m.splice(f,1),t.onChange(m)}return e.jsxs(B,{spacing:2,children:[e.jsxs(B,{direction:"row",justifyContent:"space-between",alignItems:"center",children:[e.jsx(D,{variant:"h6",children:"Feats"}),e.jsx(fe,{variant:"contained",startIcon:e.jsx(be,{}),onClick:v,children:"Add Feat"})]}),n.length===0?e.jsx(D,{variant:"body2",sx:{opacity:.75},children:"No feats yet."}):e.jsx(B,{spacing:2,children:n.map((f,m)=>e.jsx(Wt,{sx:{p:2},children:e.jsxs(B,{spacing:1.5,children:[e.jsxs(B,{direction:"row",spacing:1,alignItems:"center",children:[e.jsx(g,{label:"Feat Name",fullWidth:!0,value:f.name,onChange:u=>b(m,{name:u.target.value})}),e.jsx(ne,{"aria-label":"Remove feat",onClick:()=>T(m),children:e.jsx(Pe,{})})]}),e.jsx(g,{label:"Description",fullWidth:!0,multiline:!0,minRows:4,value:f.description,onChange:u=>b(m,{description:u.target.value})}),e.jsx(g,{label:"Status Effects",fullWidth:!0,helperText:'Comma-separated, e.g. "carrying_capacity+5"',value:f.statusEffects??"",onChange:u=>b(m,{statusEffects:u.target.value})})]})},`${f.name}-${m}`))})]})}const ia=[{id:"pistol",name:"Pistol",skillId:"weapons_light",useDC:7,damage:2,range:"Med",ammo:10,bulk:1,cost:500},{id:"smart_pistol",name:"SMART Pistol",skillId:"weapons_light",useDC:9,damage:4,range:"Med",ammo:6,bulk:1,cost:900,keywords:["Smart-Linked"]},{id:"toxic_spike",name:"Toxic Spike",skillId:"weapons_light",useDC:10,damage:3,range:"Near",ammo:1,bulk:1,cost:750,keywords:["Toxin (Prax)","Concealable"]},{id:"smg",name:"SMG",skillId:"weapons_medium",useDC:6,damage:3,range:"Med",ammo:8,bulk:2,cost:600,keywords:["Bullet Spray"]},{id:"photon_rifle",name:"Photon Rifle",skillId:"weapons_medium",useDC:8,damage:6,range:"Long",ammo:6,bulk:3,cost:5e3,keywords:["Two-Handed"]},{id:"rifle",name:"Rifle",skillId:"weapons_medium",useDC:8,damage:4,range:"Long",ammo:8,bulk:2,cost:1e3,keywords:["Two-Handed","Piercing 1"]},{id:"shotgun",name:"Shotgun",skillId:"weapons_medium",useDC:8,damage:4,range:"Near",ammo:4,bulk:3,cost:800,req:"PHYS 1",keywords:["Point Blank","Shredding 1"]},{id:"gauss_cannon",name:"Gauss Cannon",skillId:"weapons_heavy",useDC:7,damage:4,range:"Med",ammo:20,bulk:4,cost:900,req:"PHYS 3",keywords:["Bullet Spray"]},{id:"grenade_launcher",name:"Grenade Launcher",skillId:"weapons_heavy",useDC:8,damage:3,range:"Med",ammo:1,bulk:3,cost:2e3,req:"PHYS 2",keywords:["Area (Very Near)","Two-Handed","Slow Load","Grenade"]},{id:"magneton_cannon",name:"Magneton Cannon",skillId:"weapons_exotic",useDC:5,damage:2,range:"Near",ammo:5,bulk:2,cost:8e3,req:"PHYS 1",keywords:["Area (melee)","Slow Load","Shredding 3"]},{id:"tesla_rifle",name:"Tesla Rifle",skillId:"weapons_exotic",useDC:8,damage:5,range:"Med",ammo:6,bulk:2,cost:6e3,keywords:["Two-Handed","Stun 2"]},{id:"stun_baton",name:"Stun Baton",skillId:"melee_weapons",useDC:6,damage:0,range:"Melee",ammo:0,bulk:1,cost:450,keywords:["Stun 1"]},{id:"switchblade",name:"Switchblade",skillId:"melee_weapons",useDC:9,damage:2,range:"Melee",ammo:0,bulk:1,cost:150,keywords:["Concealable","Thrown"]},{id:"fusion_blade",name:"Fusion Blade",skillId:"melee_weapons",useDC:8,damage:3,range:"Melee",ammo:0,bulk:2,cost:1200,req:"REF 2",keywords:["Piercing 2"]},{id:"rocket_maul",name:"Rocket Maul",skillId:"melee_weapons",useDC:10,damage:6,range:"Melee",ammo:2,bulk:3,cost:2500,req:"PHYS 3",keywords:["Two-Handed"]}],la={weapons:ia},st=la.weapons??[],ra=[{id:"scrap_armour",name:"Scrap Armour",protection:1,durability:2,bulk:2,cost:500,special:"Cannot be repaired"},{id:"flak_jacket",name:"Flak Jacket",protection:1,durability:4,bulk:1,cost:1250},{id:"kevlar_clothing",name:"Kevlar Clothing",protection:1,durability:3,bulk:1,cost:1500,special:"Appears to be normal clothing"},{id:"streetweave_jacket",name:"Streetweave Jacket",protection:1,durability:5,bulk:1,cost:2500,special:"+1 to Stealth"},{id:"milsec_bodyplate",name:"MilSec Bodyplate",protection:2,durability:6,bulk:2,cost:5e3},{id:"breaching_plate",name:"Breaching plate",protection:2,durability:4,bulk:3,cost:8500,req:"PHYS 2",special:"Frontal Shielding 1"},{id:"heavy_bodyplate",name:"Heavy Bodyplate",protection:3,durability:8,bulk:4,cost:1e4,req:"PHYS 3",special:"+1 penalty die to Stealth"},{id:"basic_power_armour",name:"Basic Power Armour",protection:4,durability:14,bulk:10,cost:4e4,req:"Power Armour 1",special:"Requires Power Armour (DC5) check to activate. Failure: become Immobile; gain +1 penalty die to all PHYS and REF based checks. When activated, reduces its own bulk to 1 and grants +1 bonus die to all PHYS based checks."}],oa={armor:ra},it=oa.armor??[],Ge="whisperspace.obr.sheet/combat-log";async function ca(t){const n=Number.isFinite(t.useDC)?Math.trunc(t.useDC):Math.trunc(t.weapon.useDC),v=t.weapon.name||"Attack",b=(await Re({netDice:t.netDice,modifier:t.modifier,label:v})).notation,T=await Ye({diceNotation:b,rollTarget:t.rollTarget??"everyone",showResults:t.showResults??!0}),f=await St({total:T,useDC:n,weaponDamage:Math.trunc(t.weapon.damage??0),label:v});rt().emit("attack:resolved",{total:f.total,useDC:f.useDC,hit:f.hit,isCrit:f.isCrit,baseDamage:f.baseDamage,totalDamage:f.totalDamage,stressDelta:f.stressDelta,label:v});let m=f.message;t.prefix&&(m=`${t.prefix} ${m}`);const u={text:m,ts:Date.now(),kind:"attack",attackerName:t.attackerName,weaponName:v,outcome:{total:f.total,useDC:f.useDC,hit:f.hit,isCrit:f.isCrit,baseDamage:f.baseDamage,totalDamage:f.totalDamage,stressDelta:f.stressDelta}};return $.broadcast.sendMessage(Ge,u,{destination:"ALL"}),{...f,message:m}}const yt=ca;async function bt(t){const n=await It({incomingDamage:t.incomingDamage,stressDelta:t.stressDelta,unmitigated:t.unmitigated,armour:t.sheet.armor,wounds:t.sheet.wounds,stress:t.sheet.stress});return rt().emit("damage:applied",{incomingDamage:Math.max(0,Math.trunc(t.incomingDamage)),unmitigated:t.unmitigated,stressDelta:t.stressDelta,resultingStress:n.stress.current}),{sheet:{...t.sheet,wounds:n.wounds,armor:n.armour,stress:n.stress},stressDelta:n.stressDelta}}function ye(t){var b;if(!t)return 0;const n=(b=t.keywordParams)==null?void 0:b.ammoMax,v=typeof n=="number"?n:typeof n=="string"?Number(n):void 0;return Number.isFinite(v)?Number(v):0}function da(t){const n="#e55353",v="#8b5cf6",b="#5b6bff",T="#26a269",f="#d64040";return e.jsxs(M,{sx:{border:"1px solid",borderColor:"divider",borderRadius:2,p:1.25},children:[e.jsx(D,{variant:"subtitle2",sx:{opacity:.8,mb:.5},children:"Combat Log"}),t.entries.length===0?e.jsx(D,{variant:"body2",sx:{opacity:.7},children:"No recent rolls."}):e.jsx(B,{spacing:.75,children:t.entries.map(m=>{var p,s,a,i,N;const u=!!((p=m.outcome)!=null&&p.hit)&&((((s=m.outcome)==null?void 0:s.totalDamage)??0)>0||(((a=m.outcome)==null?void 0:a.stressDelta)??0)>0)&&!!t.onApply,A=u&&(((i=m.outcome)==null?void 0:i.totalDamage)??0)>0,Q=u&&(((N=m.outcome)==null?void 0:N.stressDelta)??0)>0,ie=A&&Q,S=m.outcome,te=S!=null&&S.hit?"Hit":"Miss",ae=S!=null&&S.hit?T:f,re=m.attackerName??"Unknown",G=m.weaponName??"Attack";return e.jsxs(M,{sx:{display:"flex",alignItems:"center",gap:1,flexWrap:"wrap"},children:[e.jsx(D,{variant:"body2",sx:{flex:"1 1 260px"},children:m.kind==="effect"?e.jsxs(e.Fragment,{children:[e.jsx("strong",{children:m.targetName??"Target"})," ",(m.damageApplied??0)>0&&e.jsxs(e.Fragment,{children:["took"," ",e.jsx("strong",{style:{color:n},children:m.damageApplied})," ","damage"]}),(m.damageApplied??0)>0&&(m.stressApplied??0)>0&&" and ",(m.damageApplied??0)<=0&&(m.stressApplied??0)>0&&"took ",(m.stressApplied??0)>0&&e.jsxs(e.Fragment,{children:[e.jsx("strong",{style:{color:v},children:m.stressApplied})," ","stress"]}),"."]}):e.jsxs(e.Fragment,{children:[e.jsx("strong",{children:re}),": ",e.jsx("strong",{children:G})," rolled"," ",(S==null?void 0:S.total)??0," vs DC ",(S==null?void 0:S.useDC)??0,"."," ",S!=null&&S.isCrit?e.jsxs(e.Fragment,{children:[e.jsx("strong",{style:{color:T},children:"Extreme success - "}),e.jsx("strong",{style:{color:b},children:"crit!"})]}):e.jsx("strong",{style:{color:ae},children:te}),(S==null?void 0:S.hit)&&e.jsxs(e.Fragment,{children:[". Damage:"," ",e.jsx("strong",{style:{color:n},children:(S==null?void 0:S.totalDamage)??0}),S!=null&&S.stressDelta?e.jsxs(e.Fragment,{children:[" "," (+"," ",e.jsx("strong",{style:{color:v},children:S.stressDelta})," ","Stress)"]}):null]}),"."]})}),A&&e.jsx(fe,{size:"small",variant:"outlined",startIcon:e.jsx(tt,{fontSize:"small"}),onClick:()=>{var P,R;return(R=t.onApply)==null?void 0:R.call(t,{...m,kind:"attack",damageApplied:((P=m.outcome)==null?void 0:P.totalDamage)??0,stressApplied:0})},children:"Apply Damage"}),Q&&e.jsx(fe,{size:"small",variant:"outlined",startIcon:e.jsx(Ft,{fontSize:"small"}),onClick:()=>{var P,R;return(R=t.onApply)==null?void 0:R.call(t,{...m,kind:"attack",damageApplied:0,stressApplied:((P=m.outcome)==null?void 0:P.stressDelta)??0})},children:"Apply Stress"}),ie&&e.jsx(fe,{size:"small",variant:"outlined",startIcon:e.jsx(tt,{fontSize:"small"}),onClick:()=>{var P,R,h;return(h=t.onApply)==null?void 0:h.call(t,{...m,kind:"attack",damageApplied:((P=m.outcome)==null?void 0:P.totalDamage)??0,stressApplied:((R=m.outcome)==null?void 0:R.stressDelta)??0})},children:"Apply Both"})]},m.ts)})})]})}function ua(t){var J,j,H,L,d,x,W,Y,F,pe,ce,Ee;const n=t.sheet,[v,b]=C.useState(0),[T,f]=C.useState(null),[m,u]=C.useState(""),[A,Q]=C.useState(!1),ie=(t.combatLog??[]).slice(-3).reverse(),S=C.useMemo(()=>{const o=Object.values(oe.learned).flat();return[...oe.inherent,...o]},[]),te=new Set(["melee_weapons","melee_unarmed","weapons_light","weapons_medium","weapons_heavy","weapons_exotic","explosives"]),ae=S.filter(o=>te.has(o.id));C.useMemo(()=>[...S].sort((o,r)=>o.label.localeCompare(r.label)),[S]);async function re(){var _;const o=Number(m),r=Number.isFinite(o)?Math.max(0,Math.trunc(o)):0;if(r<=0)return;const k=await bt({sheet:t.sheet,incomingDamage:r,unmitigated:A});t.onChange({wounds:k.sheet.wounds,armor:k.sheet.armor,stress:k.sheet.stress}),k.stressDelta>0&&t.onApplyStress&&t.onApplyStress(((_=k.sheet.stress)==null?void 0:_.current)??0),u("")}function G(o,r){const k=[...n.weapons??[]],_=k[o];if(r.ammo!==void 0&&!ye(_)&&r.ammo>0){const ze={..._.keywordParams??{},ammoMax:r.ammo};k[o]={..._,...r,keywordParams:ze},t.onChange({weapons:k});return}k[o]={..._,...r},t.onChange({weapons:k})}function p(o,r){if(o===null||o===r)return;const k=t.sheet.weapons??[];if(o<0||o>=k.length||r<0||r>=k.length)return;const _=[...k],[de]=_.splice(o,1);_.splice(r,0,de),t.onChange({weapons:_}),f(r)}function s(o){const r=st.find(_=>_.id===o);if(!r)return;const k=[...n.weapons??[]];k.push({name:r.name,skillId:r.skillId,useDC:r.useDC,damage:r.damage,range:r.range,ammo:r.ammo,bulk:r.bulk,req:r.req,cost:r.cost,keywords:[...r.keywords??[]],keywordParams:{ammoMax:r.ammo??0,...r.keywordParams??{}}}),t.onChange({weapons:k})}function a(){const o=[...n.weapons??[]];o.push({name:"New Weapon",skillId:"weapons_medium",useDC:8,damage:3,range:"Med",ammo:0,bulk:1,req:"",cost:0,keywords:[],keywordParams:{ammoMax:0}}),t.onChange({weapons:o})}function i(o){const r=[...n.weapons??[]];r.splice(o,1),t.onChange({weapons:r})}async function N(o,r){const k=ye(r),_=Number.isFinite(r.ammo)?Number(r.ammo):0;if(k>0&&_<=0){$.notification.show("Out of ammo. Reload first.","WARNING");return}const de=(await ot({learnedByFocus:oe.learned,skillId:r.skillId,ranks:t.sheet.skills??{},learningFocus:t.sheet.learningFocus,skillMods:t.skillMods})).modifier;await yt({weapon:r,useDC:Number.isFinite(r.useDC)?Number(r.useDC):0,netDice:v,modifier:de,attackerName:t.sheet.name,rollTarget:"everyone",showResults:!0}),k>0&&G(o,{ammo:Math.max(0,_-1)})}const[P,R]=C.useState(""),[h,O]=C.useState("");function Z(o){const r=it.find(k=>k.id===o);r&&t.onChange({armor:{name:r.name,keywords:[...r.keywords??[]],keywordParams:{...r.keywordParams??{}},protection:r.protection,durability:{current:r.durability,max:r.durability},bulk:r.bulk,req:r.req,cost:r.cost,special:r.special}})}return e.jsxs(B,{spacing:2,children:[e.jsx(M,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",gap:2,flexWrap:"wrap"},children:e.jsx(D,{variant:"h6",sx:{m:0},children:"Combat"})}),e.jsxs(M,{sx:{display:"flex",alignItems:"center",gap:1,flexWrap:"wrap"},children:[e.jsx(D,{variant:"subtitle2",sx:{opacity:.8},children:"Take Damage:"}),e.jsx(g,{size:"small",type:"number",inputProps:{min:0},value:m,onChange:o=>u(o.target.value),sx:{width:90}}),e.jsx(V,{size:"small",value:"unmitigated",selected:A,onChange:()=>Q(o=>!o),children:"Unmitigated"}),e.jsx(fe,{size:"small",variant:"outlined",onClick:re,children:"Apply"})]}),e.jsxs(M,{sx:{display:"flex",alignItems:"center",gap:1,flexWrap:"wrap"},children:[e.jsx(D,{variant:"subtitle2",sx:{opacity:.8},children:"Attack Roll:"}),e.jsxs(Ne,{size:"small",exclusive:!0,value:v,onChange:(o,r)=>{r!==null&&b(r)},children:[e.jsx(V,{value:-2,children:"−2"}),e.jsx(V,{value:-1,children:"−1"}),e.jsx(V,{value:0,children:"0"}),e.jsx(V,{value:1,children:"+1"}),e.jsx(V,{value:2,children:"+2"})]})]}),e.jsx(da,{entries:ie,onApply:t.onApplyCombatLog}),e.jsxs(Ce,{defaultExpanded:!0,children:[e.jsx(Se,{expandIcon:e.jsx(Ie,{}),children:e.jsx(D,{fontWeight:700,children:"Weapons"})}),e.jsx(De,{children:e.jsxs(B,{spacing:1.5,children:[e.jsxs(M,{sx:{display:"flex",gap:1,alignItems:"center",flexWrap:"wrap"},children:[e.jsxs(g,{label:"Add prefab weapon",size:"small",select:!0,value:P,onChange:o=>R(o.target.value),sx:{minWidth:240},children:[e.jsx(he,{value:"",children:"— choose —"}),st.map(o=>e.jsx(he,{value:o.id,children:o.name},o.id))]}),e.jsx(ne,{color:"primary",onClick:()=>s(P),"aria-label":"Add prefab weapon",disabled:!P,children:e.jsx(be,{})}),e.jsx(M,{sx:{flex:1}}),e.jsx(ne,{color:"primary",onClick:a,"aria-label":"Add custom weapon",children:e.jsx(be,{})}),e.jsx(D,{variant:"body2",sx:{opacity:.75},children:"Add custom weapon"})]}),(n.weapons??[]).length===0?e.jsx(D,{sx:{opacity:.75},children:"No weapons yet."}):(n.weapons??[]).map((o,r)=>e.jsxs(M,{draggable:!0,onDragStart:()=>f(r),onDragEnd:()=>f(null),onDragOver:k=>{k.preventDefault()},onDrop:k=>{k.preventDefault(),p(T,r)},sx:{border:"1px solid",borderColor:"divider",borderRadius:2,p:1.25,cursor:"grab",opacity:T===r?.85:1,display:"grid",gap:1.25},children:[e.jsxs(M,{sx:{display:"flex",gap:1,alignItems:"center"},children:[e.jsx(g,{label:"Name",size:"small",value:o.name,onChange:k=>G(r,{name:k.target.value}),fullWidth:!0}),e.jsx(me,{title:"Roll attack with Dice+",children:e.jsx(ne,{onClick:()=>N(r,o),"aria-label":`Roll attack for ${o.name}`,children:e.jsx(we,{})})}),e.jsx(ne,{onClick:()=>i(r),"aria-label":"Remove weapon",children:e.jsx(Pe,{})})]}),e.jsxs(M,{sx:{display:"grid",gridTemplateColumns:"1fr 1fr 1fr 1fr",gap:1},children:[e.jsx(g,{label:"Skill",size:"small",select:!0,value:o.skillId,onChange:k=>G(r,{skillId:k.target.value}),children:ae.map(k=>e.jsx(he,{value:k.id,children:k.label},k.id))}),e.jsx(g,{label:"Use DC",size:"small",type:"number",value:o.useDC,onChange:k=>G(r,{useDC:Number(k.target.value)})}),e.jsx(g,{label:"Damage",size:"small",type:"number",value:o.damage,onChange:k=>G(r,{damage:Number(k.target.value)})}),e.jsx(g,{label:"Range",size:"small",value:o.range??"",onChange:k=>G(r,{range:k.target.value}),placeholder:"Melee / Short / Med / Long"}),e.jsxs(M,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(g,{label:"Ammo",size:"small",type:"number",value:o.ammo??0,onChange:k=>G(r,{ammo:Number(k.target.value)}),sx:{width:110}}),e.jsxs(D,{variant:"body2",sx:{opacity:.8},children:["/ ",ye(o)||0]}),e.jsx(me,{title:"Reload",children:e.jsx("span",{children:e.jsx(ne,{size:"small",onClick:()=>G(r,{ammo:ye(o)||0}),disabled:(ye(o)||0)<=0,children:e.jsx(ft,{fontSize:"small"})})})})]}),e.jsx(g,{label:"Bulk",size:"small",type:"number",value:o.bulk??0,onChange:k=>G(r,{bulk:Number(k.target.value)})}),e.jsx(g,{label:"Req.",size:"small",value:o.req??"",onChange:k=>G(r,{req:k.target.value}),placeholder:"PHYS 1 / REF 2 / etc"}),e.jsx(g,{label:"Keywords (comma)",size:"small",value:(o.keywords??[]).join(", "),onChange:k=>G(r,{keywords:k.target.value.split(",").map(_=>_.trim()).filter(Boolean)}),placeholder:"Two-Handed, Piercing 1",sx:{gridColumn:"1 / -1"}}),(o.keywords??[]).length>0&&e.jsx(M,{sx:{gridColumn:"1 / -1",display:"flex",flexWrap:"wrap",gap:.5},children:(o.keywords??[]).map((k,_)=>{const de=Jt(k);return de?e.jsx(me,{title:de.description,children:e.jsx("span",{children:e.jsx(at,{label:k,size:"small",variant:"outlined",component:"a",href:`/rules.html#${de.anchor}`,target:"_blank",clickable:!0,sx:{textDecoration:"none"}})})},`${k}-${_}`):e.jsx(at,{label:k,size:"small",variant:"outlined"},`${k}-${_}`)})})]})]},o.id??`${o.name}-${r}`))]})})]}),e.jsxs(Ce,{defaultExpanded:!0,children:[e.jsx(Se,{expandIcon:e.jsx(Ie,{}),children:e.jsx(D,{fontWeight:700,children:"Armor"})}),e.jsx(De,{children:e.jsxs(B,{spacing:1.5,children:[e.jsxs(M,{sx:{display:"flex",gap:1,alignItems:"center",flexWrap:"wrap"},children:[e.jsxs(g,{label:"Set prefab armor",size:"small",select:!0,value:h,onChange:o=>O(o.target.value),sx:{minWidth:240},children:[e.jsx(he,{value:"",children:"— choose —"}),it.map(o=>e.jsx(he,{value:o.id,children:o.name},o.id))]}),e.jsx(ne,{color:"primary",onClick:()=>Z(h),"aria-label":"Set prefab armor",disabled:!h,children:e.jsx(be,{})})]}),e.jsxs(M,{sx:{border:"1px solid",borderColor:"divider",borderRadius:2,p:1.25},children:[e.jsxs(M,{sx:{display:"grid",gridTemplateColumns:"2fr 1fr 1fr 1fr",gap:1},children:[e.jsx(g,{label:"Name",size:"small",value:((J=n.armor)==null?void 0:J.name)??"",onChange:o=>t.onChange({armor:{...n.armor??{durability:{current:0,max:0},protection:0,keywords:[],keywordParams:{ammoMax:0}},name:o.target.value}})}),e.jsx(g,{label:"Protection",size:"small",type:"number",value:((j=n.armor)==null?void 0:j.protection)??0,onChange:o=>t.onChange({armor:{...n.armor??{name:"",durability:{current:0,max:0},keywords:[],keywordParams:{}},protection:Number(o.target.value)}})}),e.jsx(g,{label:"Durability (cur)",size:"small",type:"number",value:((H=n.armor)==null?void 0:H.durability.current)??0,onChange:o=>{var r;return t.onChange({armor:{...n.armor??{name:"",durability:{current:0,max:0},protection:0,keywords:[],keywordParams:{}},durability:{...((r=n.armor)==null?void 0:r.durability)??{current:0,max:0},current:Number(o.target.value)}}})}}),e.jsx(g,{label:"Durability (max)",size:"small",type:"number",value:((L=n.armor)==null?void 0:L.durability.max)??0,onChange:o=>{var r;return t.onChange({armor:{...n.armor??{name:"",durability:{current:0,max:0},protection:0,keywords:[],keywordParams:{}},durability:{...((r=n.armor)==null?void 0:r.durability)??{current:0,max:0},max:Number(o.target.value)}}})}})]}),(((x=(d=n.armor)==null?void 0:d.durability)==null?void 0:x.max)??0)>0&&(((Y=(W=n.armor)==null?void 0:W.durability)==null?void 0:Y.current)??0)<=0&&e.jsx(D,{sx:{mt:1},color:"error",variant:"body2",children:"Broken: armor provides no Protection until repaired."}),e.jsxs(M,{sx:{display:"grid",gridTemplateColumns:"1fr 1fr 1fr 2fr",gap:1,mt:1},children:[e.jsx(g,{label:"Bulk",size:"small",type:"number",value:((F=n.armor)==null?void 0:F.bulk)??0,onChange:o=>t.onChange({armor:{...n.armor??{name:"",durability:{current:0,max:0},protection:0,keywords:[],keywordParams:{}},bulk:Number(o.target.value)}})}),e.jsx(g,{label:"Req.",size:"small",value:((pe=n.armor)==null?void 0:pe.req)??"",onChange:o=>t.onChange({armor:{...n.armor??{name:"",durability:{current:0,max:0},protection:0,keywords:[],keywordParams:{}},req:o.target.value}})}),e.jsx(g,{label:"Special",size:"small",value:((ce=n.armor)==null?void 0:ce.special)??"",onChange:o=>t.onChange({armor:{...n.armor??{name:"",durability:{current:0,max:0},protection:0,keywords:[],keywordParams:{}},special:o.target.value}})})]}),e.jsx(M,{sx:{mt:1},children:e.jsx(g,{label:"Keywords (comma)",size:"small",fullWidth:!0,value:(((Ee=n.armor)==null?void 0:Ee.keywords)??[]).join(", "),onChange:o=>t.onChange({armor:{...n.armor??{name:"",durability:{current:0,max:0},protection:0,keywords:[],keywordParams:{}},keywords:o.target.value.split(",").map(r=>r.trim()).filter(Boolean)}}),placeholder:"Frontal Shielding 1"})})]})]})})]})]})}const ma=[{name:"Flashbang Grenade",effect:"Applies Stun 1 to everyone within Very Near range, Thrown",uses:"1 use",bulk:1,cost:200},{name:"Frag Grenade",effect:"Deals 2 area (Very Near range) damage (DC8 to Evade half), Thrown",uses:"1 use",bulk:1,cost:250},{name:"EMP Grenade",effect:"Applies EMP 2 to everything within range, Thrown",uses:"1 use",bulk:1,cost:300},{name:"Combat Stim Injector",effect:"Gain +1 action & -1 Stress; take 1 wound after effect ends",uses:"1 use",bulk:1,cost:200},{name:"Basic Medkit",effect:"Right tool for the job: First Aid checks",uses:"3 uses",bulk:1,cost:350},{name:"Multitool",effect:"Allows engineering checks to repair, bypass, scrap, etc.",uses:"Permanent",bulk:1,cost:750},{name:"Repair Kit",effect:"Provides materials and tools for repairs",uses:"10 uses",bulk:1,cost:500},{name:"Tracker",effect:"While within 10km, always know location of this device",uses:"1 use",bulk:1,cost:250},{name:"Portable Scanner",effect:"Right tool for the job: Observe (tech, lifeforms)",uses:"Permanent",bulk:1,cost:400},{name:"Weapon Scope",effect:"Simple Modification. Grants +1 bonus die to called shots at medium range and farther; inflicts +1 penalty die to attacks at Near range or nearer",uses:"Permanent",bulk:1,cost:750},{name:"Weapon Silencer",effect:"Simple Modification. Weapon makes reduced sound when fired; deals -1 damage",uses:"Permanent",bulk:1,cost:500},{name:"Compact Backpack",effect:"+5 Inventory Slots when worn",uses:"Permanent",bulk:0,cost:150},{name:"Ammo (Flechette)",effect:"Deals +2 damage to unarmoured targets.",uses:"10 rounds",bulk:1,cost:500},{name:"Ammo (SMART)",effect:"Required for Smart-Linked weapons.",uses:"10",bulk:1,cost:1250},{name:"Ammo (Armour Piercing)",effect:"Adds Piercing 1 to attacks.",uses:"10",bulk:1,cost:750},{name:"Ammo (Explosive)",effect:"Adds Shredding 1 to attacks.",uses:"10",bulk:1,cost:750}],ha={items:ma},fa=ha.items,ga=[{name:"Reflex Booster",tier:1,effect:"Once per round, gain +1 bonus die to an Evade check.",installationDifficulty:2,requirements:"REF 1",physicalImpact:"Low; spine",bulk:1,cost:4e3},{name:"Targeting Link",tier:1,effect:"Once per round, ignore 1 level of cover when attacking an enemy you can see.",installationDifficulty:2,requirements:"-",physicalImpact:"Medium; eyes",bulk:1,cost:6e3},{name:"Low-Light Optics",tier:1,effect:"Ignore penalty dice caused by darkness within medium range.",installationDifficulty:1,requirements:"-",physicalImpact:"Medium; eyes",bulk:1,cost:4e3},{name:"EMP Shielding",tier:1,effect:"Ignore the effects of EMP once per day.",installationDifficulty:2,requirements:"MENT 1",physicalImpact:"None; torso",bulk:1,cost:5500},{name:"Metabolic Filter",tier:1,effect:"Gain +1 bonus die on checks to resist toxins or narcotics.",installationDifficulty:1,requirements:"PHYS 1",physicalImpact:"Minor; liver",bulk:1,cost:2e3},{name:"Internal Communicator",tier:1,effect:"Gain the ability to send and receive messages mentally just as if you were using a regular comms device.",installationDifficulty:0,requirements:"-",physicalImpact:"Medium; jaw, ear",bulk:1,cost:2500},{name:"Skull Popper",tier:1,effect:"Highly illegal; when installed, is given a mandate such as “don’t go to the police”. If the host violates this mandate, the Skull Popper explodes, killing the host. The more specific the mandate, the better the implant functions.",installationDifficulty:2,requirements:"-",physicalImpact:"None; brain",bulk:1,cost:12e3},{name:"Databank",tier:2,effect:"You gain an internal information storage device. You may store information upon it (thinking you want to record what you see, for example), and access information from it at will. You may also load external information onto it, though the GM determines how long that takes and how much may be stored on it.",installationDifficulty:2,requirements:"MENT 1",physicalImpact:"Medium; cranium",bulk:1,cost:7500},{name:"Invisible Databank",tier:2,effect:"You gain an internal information storage device. You may store information upon it (thinking you want to record what you see, for example), and access information from it at will. This device cannot be seen or accessed externally without removing it and is shielded to avoid electronic detection.",installationDifficulty:3,requirements:"-",physicalImpact:"None; cranium",bulk:1,cost:15e3},{name:"Neural Accelerator",tier:2,effect:"Once per day, activate to gain 2 additional actions on your turn. At the end of your turn, gain +2 stress.",installationDifficulty:4,requirements:"Ment 2",physicalImpact:"Obvious; spine",bulk:1,cost:1e4},{name:"Reaction Governor Matrix",tier:2,effect:"Gain +1 reaction per round.",installationDifficulty:2,requirements:"REF 2",physicalImpact:"None; brain",bulk:1,cost:8e3},{name:"Threat Awareness Suite",tier:2,effect:"Gain +1 bonus die to Observe or Instinct checks to detect ambushes or imminent danger. Additionally, you may not be Surprised.",installationDifficulty:2,requirements:"-",physicalImpact:"None; brain",bulk:1,cost:5500},{name:"Synthetic Musculature",tier:2,effect:"Gain +1 bonus die on Powerlifting or Athletics checks involving lifting, pushing, or breaking objects. Unarmed attacks deal damage equal to your full PHYS.",installationDifficulty:4,requirements:"PHYS 3",physicalImpact:"Obvious; arms, legs, torso",bulk:1,cost:1e4},{name:"Stability Gyros",tier:2,effect:"Ignore penalty dice from unstable environments (moving vehicles, zero-G, poor footing)",installationDifficulty:2,requirements:"REF 2",physicalImpact:"Minor; ear",bulk:1,cost:6e3},{name:"Adrenal Boost",tier:2,effect:"Activate to ignore stress penalties for 1 round. At the end of this round, take 1 damage.",installationDifficulty:2,requirements:"PHYS 1",physicalImpact:"None; adrenal glands",bulk:1,cost:5e3},{name:"Mantis Claws (retractable)",tier:3,effect:"Your unarmed attacks deal damage equal to your REF and have Piercing 3. Additionally, gain +1 bonus die to climbing related checks.",installationDifficulty:3,requirements:"REF 2 or PHYS 2",physicalImpact:"Obvious; forearms and hands",bulk:1,cost:1e4},{name:"Neuro Regulator",tier:3,effect:"Ignore up to 3 stress per day from up to 3 sources of stress. Make all SOC based rolls with +1 penalty die.",installationDifficulty:3,requirements:"MENT 2",physicalImpact:"None; brain",bulk:1,cost:12e3},{name:"Synthetic Antibodies",tier:3,effect:"Become immune to nanites targeting your body (including positive effects). Does not stop things from being thrown at you with nanites.",installationDifficulty:4,requirements:"PHYS 1 and MENT 1",physicalImpact:"Minor; nervous system",bulk:1,cost:17500},{name:"Bio-Stabilizer",tier:3,effect:`When you would take a Medium or Heavy wound, roll Cybernetics (DC8).- Extreme success: ignore the wound.
- Success: ignore the wound; this cyberware effect cannot be used for 1 day.
- Failure: suffer the wound as normal; this cyberware effect cannot be used for 1 day.
This effect may only trigger once per instance of damage.`,installationDifficulty:4,requirements:"-",physicalImpact:"Medium; chest and back",bulk:1,cost:15e3}],xa={cyberware:ga},ya=xa.cyberware,ba=[{name:"Space Dust",effect:"Grants +1 bonus die to Observe and Piloting checks for 6 hours",uses:5,addictionScore:1,legality:"Legal",bulk:1,cost:500},{name:"Tranquility",effect:"Reduces stress by 1; penalty die to all REF checks for 6 hours.",uses:2,addictionScore:5,legality:"Legal",bulk:1,cost:5e3},{name:"Smoothe",effect:"Reduces stress by 1d4; increases Cool Under Fire by 2 and grants +1 bonus die to all Mental skill checks for 1 hour",uses:1,addictionScore:8,legality:"Illegal",bulk:1,cost:2e4},{name:"Chemical Strength",effect:"+1 bonus die to all PHYS checks for 1 hour; +1 movement bonus for 1 hour. After 1 hour, gain +1 penalty die to all PHYS checks and gain +1 movement penalty until sleep.",uses:1,addictionScore:3,legality:"Illegal",bulk:1,cost:8e3}],pa={narcotics:ba},ka=pa.narcotics;function va(){return`inv_${Date.now()}_${Math.random().toString(36).slice(2,9)}`}function ja(t){const n=t.sheet.inventory??[],v=a=>{t.onChange({inventory:a})},[b,T]=C.useState("item"),[f,m]=C.useState(null),[u,A]=C.useState({}),[Q,ie]=C.useState(null),[S,te]=C.useState(null),ae=C.useMemo(()=>b==="item"?fa.map(a=>({type:"item",...a})):b==="cyberware"?ya.map(a=>({type:"cyberware",...a})):ka.map(a=>({type:"narcotics",...a})),[b]);function re(a){m(a);const i=ae.find(N=>N.name===a);if(!i){A({type:b,name:"",quantity:1,bulk:b==="item"?0:1,effect:"",cost:0,statusEffects:""});return}A(b==="item"?{type:"item",name:i.name,quantity:1,uses:i.uses??"",bulk:i.bulk??0,effect:i.effect??"",cost:i.cost??0,statusEffects:i.statusEffects??""}:b==="cyberware"?{type:"cyberware",name:i.name,quantity:1,bulk:i.bulk??1,tier:i.tier??1,installationDifficulty:i.installationDifficulty??0,requirements:i.requirements??"",physicalImpact:i.physicalImpact??"",effect:i.effect??"",cost:i.cost??0,statusEffects:i.statusEffects??""}:{type:"narcotics",name:i.name,quantity:1,bulk:i.bulk??1,uses:i.uses??1,addictionScore:i.addictionScore??0,legality:i.legality??"",effect:i.effect??"",cost:i.cost??0,statusEffects:i.statusEffects??""})}function G(){const a=[...n,{id:va(),...u}];t.onChange({inventory:a}),m(null),A({type:b,name:"",quantity:1,bulk:b==="item"?0:1,effect:"",cost:0,statusEffects:""})}function p(a){t.onChange({inventory:n.filter(i=>i.id!==a)})}function s(a,i){t.onChange({inventory:n.map(N=>N.id===a?{...N,...i}:N)})}return e.jsxs(B,{spacing:2,children:[e.jsx(g,{label:"Credits",type:"number",value:t.sheet.credits??0,onChange:a=>t.onChange({credits:Number(a.target.value)}),size:"small"}),e.jsxs(M,{children:[e.jsx(D,{variant:"subtitle2",sx:{mb:1},children:"Add Inventory"}),e.jsxs(B,{direction:{xs:"column",sm:"row"},spacing:1,alignItems:"center",children:[e.jsxs(g,{select:!0,size:"small",label:"Type",value:b,onChange:a=>{const i=a.target.value;T(i),m(null),A(i==="item"?{type:i,name:"",quantity:1,bulk:0,uses:"",effect:"",cost:0,statusEffects:""}:i==="cyberware"?{type:i,name:"",quantity:1,bulk:1,tier:1,installationDifficulty:0,requirements:"",physicalImpact:"",effect:"",cost:0,statusEffects:""}:{type:i,name:"",quantity:1,bulk:1,uses:1,addictionScore:0,legality:"",effect:"",cost:0,statusEffects:""})},sx:{minWidth:160},children:[e.jsx(he,{value:"item",children:"Item"}),e.jsx(he,{value:"cyberware",children:"Cyberware"}),e.jsx(he,{value:"narcotics",children:"Narcotics"})]}),e.jsx(Lt,{size:"small",sx:{flex:1,minWidth:220},options:ae.map(a=>a.name),value:f,onChange:(a,i)=>re(i),renderInput:a=>e.jsx(g,{...a,label:"Template (optional)"})}),e.jsx(fe,{variant:"contained",startIcon:e.jsx(be,{}),onClick:G,disabled:!(u!=null&&u.name),children:"Add"})]}),e.jsx(M,{sx:{mt:1},children:e.jsxs(B,{spacing:1,children:[e.jsxs(B,{direction:{xs:"column",sm:"row"},spacing:1,children:[e.jsx(g,{size:"small",label:"Name",value:(u==null?void 0:u.name)??"",onChange:a=>A(i=>({...i,name:a.target.value})),sx:{flex:1}}),e.jsx(g,{size:"small",type:"number",label:"Bulk",value:(u==null?void 0:u.bulk)??0,onChange:a=>A(i=>({...i,bulk:Number(a.target.value)})),sx:{width:120}}),e.jsx(g,{size:"small",type:"number",label:"Quantity",value:(u==null?void 0:u.quantity)??1,onChange:a=>{const i=Number(a.target.value);Number.isFinite(i)&&A(N=>({...N,quantity:i}))},sx:{width:120}}),e.jsx(g,{size:"small",type:"number",label:"Cost",value:(u==null?void 0:u.cost)??0,onChange:a=>A(i=>({...i,cost:Number(a.target.value)})),sx:{width:140}})]}),b==="item"&&e.jsx(g,{size:"small",label:"Uses",value:(u==null?void 0:u.uses)??"",onChange:a=>A(i=>({...i,uses:a.target.value}))}),b==="cyberware"&&e.jsxs(B,{direction:{xs:"column",sm:"row"},spacing:1,children:[e.jsx(g,{size:"small",type:"number",label:"Tier",value:(u==null?void 0:u.tier)??1,onChange:a=>A(i=>({...i,tier:Number(a.target.value)})),sx:{width:120}}),e.jsx(g,{size:"small",type:"number",label:"Installation Difficulty",value:(u==null?void 0:u.installationDifficulty)??0,onChange:a=>A(i=>({...i,installationDifficulty:Number(a.target.value)})),sx:{width:220}}),e.jsx(g,{size:"small",label:"Requirements",value:(u==null?void 0:u.requirements)??"",onChange:a=>A(i=>({...i,requirements:a.target.value})),sx:{flex:1}})]}),b==="cyberware"&&e.jsx(g,{size:"small",label:"Physical Impact",value:(u==null?void 0:u.physicalImpact)??"",onChange:a=>A(i=>({...i,physicalImpact:a.target.value}))}),b==="narcotics"&&e.jsxs(B,{direction:{xs:"column",sm:"row"},spacing:1,children:[e.jsx(g,{size:"small",type:"number",label:"Uses",value:(u==null?void 0:u.uses)??1,onChange:a=>A(i=>({...i,uses:Number(a.target.value)})),sx:{width:120}}),e.jsx(g,{size:"small",type:"number",label:"Addiction Score",value:(u==null?void 0:u.addictionScore)??0,onChange:a=>A(i=>({...i,addictionScore:Number(a.target.value)})),sx:{width:160}}),e.jsx(g,{size:"small",label:"Legality",value:(u==null?void 0:u.legality)??"",onChange:a=>A(i=>({...i,legality:a.target.value})),sx:{flex:1}})]}),e.jsx(g,{size:"small",label:"Effect",value:(u==null?void 0:u.effect)??"",onChange:a=>A(i=>({...i,effect:a.target.value})),multiline:!0,minRows:2}),e.jsx(g,{size:"small",label:"Status Effects (comma-separated)",value:(u==null?void 0:u.statusEffects)??"",onChange:a=>A(i=>({...i,statusEffects:a.target.value})),placeholder:'e.g. "carrying_capacity+5"'})]})})]}),e.jsxs(M,{children:[e.jsx(D,{variant:"subtitle2",sx:{mb:1},children:"Inventory"}),n.length===0&&e.jsx(D,{variant:"body2",children:"No inventory items yet."}),n.map(a=>{const i=a.quantity??1,P=(a.bulk??0)*i,R=`${a.name} (${a.type}) • bulk ${P}`;return e.jsxs(Ce,{disableGutters:!0,children:[e.jsx(Se,{expandIcon:e.jsx(Ie,{}),draggable:!0,onDragStart:h=>{ie(a.id??null);try{h.dataTransfer.effectAllowed="move",h.dataTransfer.setData("text/plain",a.id??"")}catch{}},onDragOver:h=>{h.preventDefault(),te(a.id??null)},onDragLeave:()=>te(null),onDrop:h=>{h.preventDefault();const O=Q??h.dataTransfer.getData("text/plain"),Z=a.id;if(O&&Z&&O!==Z){const J=t.sheet.inventory??[],j=J.findIndex(L=>L.id===O),H=J.findIndex(L=>L.id===Z);if(j>=0&&H>=0){const L=[...J],[d]=L.splice(j,1);L.splice(H,0,d),v(L)}}ie(null),te(null)},sx:S===a.id?{outline:"2px dashed rgba(255,255,255,0.35)",borderRadius:1}:void 0,children:e.jsxs(B,{direction:"row",spacing:1,alignItems:"center",sx:{width:"100%"},children:[e.jsx(Bt,{fontSize:"small",sx:{opacity:.5}}),e.jsx(D,{variant:"body2",sx:{flex:1},children:R}),e.jsxs(B,{direction:"row",spacing:.5,alignItems:"center",children:[e.jsx(ne,{size:"small",onClick:h=>{h.stopPropagation();const O=(a.quantity??1)-1;O<=0?p(a.id):s(a.id,{quantity:O})},children:e.jsx(ht,{fontSize:"small"})}),e.jsx(D,{variant:"caption",sx:{minWidth:18,textAlign:"center"},children:a.quantity??1}),e.jsx(ne,{size:"small",onClick:h=>{h.stopPropagation(),s(a.id,{quantity:(a.quantity??1)+1})},children:e.jsx(be,{fontSize:"small"})})]}),e.jsx(me,{title:"Remove",children:e.jsx(ne,{size:"small",onClick:h=>(h.stopPropagation(),p(a.id)),children:e.jsx(Pe,{fontSize:"small"})})})]})}),e.jsx(De,{children:e.jsxs(B,{spacing:1,children:[e.jsxs(B,{direction:{xs:"column",sm:"row"},spacing:1,children:[e.jsx(g,{size:"small",label:"Name",value:a.name??"",onChange:h=>s(a.id,{name:h.target.value}),sx:{flex:1}}),e.jsxs(g,{select:!0,size:"small",label:"Type",value:a.type,onChange:h=>s(a.id,{type:h.target.value}),sx:{width:160},children:[e.jsx(he,{value:"item",children:"Item"}),e.jsx(he,{value:"cyberware",children:"Cyberware"}),e.jsx(he,{value:"narcotics",children:"Narcotics"})]}),e.jsx(g,{size:"small",type:"number",label:"Bulk",value:a.bulk??0,onChange:h=>s(a.id,{bulk:Number(h.target.value)}),sx:{width:120}}),e.jsx(g,{size:"small",type:"number",label:"Quantity",value:a.quantity??1,onChange:h=>{const O=Number(h.target.value);Number.isFinite(O)&&(O<=0?p(a.id):s(a.id,{quantity:O}))},sx:{width:120}}),e.jsx(g,{size:"small",type:"number",label:"Cost",value:a.cost??0,onChange:h=>s(a.id,{cost:Number(h.target.value)}),sx:{width:140}})]}),a.type==="item"&&e.jsx(g,{size:"small",label:"Uses",value:a.uses??"",onChange:h=>s(a.id,{uses:h.target.value})}),a.type==="cyberware"&&e.jsxs(B,{direction:{xs:"column",sm:"row"},spacing:1,children:[e.jsx(g,{size:"small",type:"number",label:"Tier",value:a.tier??1,onChange:h=>s(a.id,{tier:Number(h.target.value)}),sx:{width:120}}),e.jsx(g,{size:"small",type:"number",label:"Installation Difficulty",value:a.installationDifficulty??0,onChange:h=>s(a.id,{installationDifficulty:Number(h.target.value)}),sx:{width:220}}),e.jsx(g,{size:"small",label:"Requirements",value:a.requirements??"",onChange:h=>s(a.id,{requirements:h.target.value}),sx:{flex:1}})]}),a.type==="cyberware"&&e.jsx(g,{size:"small",label:"Physical Impact",value:a.physicalImpact??"",onChange:h=>s(a.id,{physicalImpact:h.target.value})}),a.type==="narcotics"&&e.jsxs(B,{direction:{xs:"column",sm:"row"},spacing:1,children:[e.jsx(g,{size:"small",type:"number",label:"Uses",value:a.uses??1,onChange:h=>s(a.id,{uses:Number(h.target.value)}),sx:{width:120}}),e.jsx(g,{size:"small",type:"number",label:"Addiction Score",value:a.addictionScore??0,onChange:h=>s(a.id,{addictionScore:Number(h.target.value)}),sx:{width:160}}),e.jsx(g,{size:"small",label:"Legality",value:a.legality??"",onChange:h=>s(a.id,{legality:h.target.value}),sx:{flex:1}})]}),e.jsx(g,{size:"small",label:"Effect",value:a.effect??"",onChange:h=>s(a.id,{effect:h.target.value}),multiline:!0,minRows:2}),e.jsx(g,{size:"small",label:"Status Effects (comma-separated)",value:a.statusEffects??"",onChange:h=>s(a.id,{statusEffects:h.target.value}),placeholder:'e.g. "carrying_capacity+5"'})]})})]},a.id)})]})]})}function wa(){const[t,n]=C.useState({entries:[],activeTokenId:void 0,updatedAt:Date.now()}),[v,b]=C.useState({}),[T,f]=C.useState(""),[m,u]=C.useState(!1),[A,Q]=C.useState(0),ie=p=>Math.max(-3,Math.min(3,p));C.useEffect(()=>{const p=Dt(s=>n(s));return()=>p==null?void 0:p()},[]),C.useEffect(()=>{let p=!0;return(async()=>{var s,a,i,N;try{const[P,R]=await Promise.all([((a=(s=$.player).getId)==null?void 0:a.call(s))??Promise.resolve(""),((N=(i=$.player).getRole)==null?void 0:N.call(i))??Promise.resolve("")]);if(!p)return;f(String(P??"")),u(String(R).toUpperCase()==="GM")}catch{}})(),()=>{p=!1}},[]);const S=C.useMemo(()=>{const p=[...t.entries??[]];return p.sort((s,a)=>(a.initiative??0)-(s.initiative??0)),p},[t.entries]);C.useEffect(()=>{let p=!0;return(async()=>{var s,a,i,N,P,R,h;try{const O=S.map(j=>j.tokenId);if(!O.length){p&&b({});return}const Z=await $.scene.items.getItems(O),J={};for(const j of Z){const H=j.id,L=await Me(H),d=L==null?void 0:L.armor,x=((s=d==null?void 0:d.durability)==null?void 0:s.current)??0,W=!!d&&x<=0,Y=W?0:(d==null?void 0:d.protection)??0,F=(a=L==null?void 0:L.weapons)==null?void 0:a[0],pe=ye(F),ce=Number.isFinite(F==null?void 0:F.ammo)?Number(F==null?void 0:F.ammo):0;J[H]={tokenId:H,name:((P=(N=(i=j.text)==null?void 0:i.plainText)==null?void 0:N.trim)==null?void 0:P.call(N))||(L==null?void 0:L.name)||"(Unnamed)",thumbUrl:(R=j.image)==null?void 0:R.url,ownerPlayerId:String(((h=j.metadata)==null?void 0:h[ct])??""),prot:Y,armorBroken:W,topWeaponName:F==null?void 0:F.name,topWeaponUseDC:F==null?void 0:F.useDC,topWeaponDamage:F==null?void 0:F.damage,topWeaponSkillId:F==null?void 0:F.skillId,topWeaponAmmo:ce,topWeaponAmmoMax:pe}}p&&b(J)}catch{}})(),()=>{p=!1}},[S]);async function te(p){var H,L,d,x,W;const[s]=await $.scene.items.getItems([p]);if(!s)return;const a=await Me(p);if(!a)return;const i=(await Ue({statuses:[...(a.feats??[]).map(Y=>Y.statusEffects??"").filter(Boolean),...(a.inventory??[]).map(Y=>Y.statusEffects??"").filter(Boolean)]})).deltas,N=await ut({skills:a.skills??{},inherentSkills:oe.inherent??[]}),P=((H=a.stress)==null?void 0:H.current)??0,h=Math.max(0,(await He({skills:a.skills??{}})).cuf-(((L=a.stress)==null?void 0:L.cufLoss)??0))+(i.cool_under_fire??0),O=N.ref+(i.ref??0)+(i.reflex??0),Z=P>h,J=(await Re({netDice:Z?-1:0,modifier:O,label:`${((d=s.text)==null?void 0:d.plainText)??a.name??"Token"} Initiative`})).notation,j=await Ye({diceNotation:J,rollTarget:"everyone",showResults:!0});await Nt({tokenId:p,initiative:j,name:((x=s.text)==null?void 0:x.plainText)??a.name??"Token",thumbUrl:(W=s.image)==null?void 0:W.url})}async function ae(){var N,P;const p=await((P=(N=$.player).getSelection)==null?void 0:P.call(N))??[],s=p==null?void 0:p[0],a=await dt()??void 0,i=s||a;if(!i){$.notification.show("Select a token (or set your character) to roll initiative.","WARNING");return}await te(i)}async function re(p){var L,d,x;const s=await Me(p);if(!s)return;const a=(L=s.weapons)==null?void 0:L[0];if(!a){$.notification.show("No weapon in the top slot.","WARNING");return}const i=(await Ue({statuses:[...(s.feats??[]).map(W=>W.statusEffects??"").filter(Boolean),...(s.inventory??[]).map(W=>W.statusEffects??"").filter(Boolean)]})).deltas,P=(await He({skills:s.skills??{}})).cuf-(((d=s.stress)==null?void 0:d.cufLoss)??0)+(i.cool_under_fire??0),h=(((x=s.stress)==null?void 0:x.current)??0)>P,O=String(a.skillId??""),Z=(await ot({learnedByFocus:oe.learned,skillId:O,ranks:s.skills??{},learningFocus:s.learningFocus,skillMods:i})).modifier,J=ye(a),j=Number.isFinite(a==null?void 0:a.ammo)?Number(a==null?void 0:a.ammo):0;if(J>0&&j<=0){$.notification.show("Out of ammo. Reload first.","WARNING");return}const H=ie(A-(h?1:0));if(await yt({weapon:a,netDice:H,modifier:Z,attackerName:s.name,rollTarget:"everyone",showResults:!0}),J>0){const W=Math.max(0,j-1),Y=[...s.weapons??[]];Y[0]={...Y[0],ammo:W},await $e(p,{...s,weapons:Y})}}async function G(p){var P;const s=await Me(p);if(!s)return;const a=(P=s.weapons)==null?void 0:P[0];if(!a)return;const i=ye(a);if(i<=0)return;const N=[...s.weapons??[]];N[0]={...N[0],ammo:i},await $e(p,{...s,weapons:N})}return e.jsxs(B,{spacing:2,children:[e.jsxs(M,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",gap:1,flexWrap:"wrap"},children:[e.jsx(D,{variant:"h6",sx:{m:0},children:"Initiative"}),e.jsxs(B,{direction:"row",spacing:1,alignItems:"center",children:[e.jsx(fe,{size:"small",variant:"contained",onClick:()=>void ae(),startIcon:e.jsx(we,{}),children:"Roll Initiative"}),e.jsxs(M,{sx:{display:"flex",alignItems:"center",gap:1,flexWrap:"wrap",pl:1},children:[e.jsx(D,{variant:"body2",sx:{opacity:.8},children:"Attack Roll:"}),e.jsxs(Ne,{size:"small",exclusive:!0,value:A,onChange:(p,s)=>{s!==null&&Q(s)},children:[e.jsx(V,{value:-2,children:"−2"}),e.jsx(V,{value:-1,children:"−1"}),e.jsx(V,{value:0,children:"0"}),e.jsx(V,{value:1,children:"+1"}),e.jsx(V,{value:2,children:"+2"})]})]}),m&&e.jsxs(e.Fragment,{children:[e.jsx(fe,{size:"small",variant:"outlined",onClick:()=>Mt(),children:"Clear"}),e.jsx(fe,{size:"small",variant:"outlined",onClick:()=>At(),children:"Advance"})]})]})]}),e.jsx(_t,{}),S.length===0?e.jsx(D,{variant:"body2",sx:{opacity:.75},children:"No initiative rolls yet."}):e.jsx(qt,{dense:!0,disablePadding:!0,children:S.map(p=>{const s=v[p.tokenId],a=s==null?void 0:s.ownerPlayerId,i=m||!!a&&a===T,N=t.activeTokenId===p.tokenId,P=N&&i&&!m,R=!!p.surprised,h=(s==null?void 0:s.topWeaponAmmoMax)??0,O=(s==null?void 0:s.topWeaponAmmo)??0,Z=h>0&&O<=0;return e.jsxs(Ot,{sx:{borderRadius:1,mb:.5,bgcolor:N?"rgba(255,255,255,0.06)":"transparent",opacity:R?.55:1},secondaryAction:e.jsxs(B,{direction:"row",spacing:.5,alignItems:"center",children:[e.jsx(me,{title:s!=null&&s.armorBroken?"Armor broken":"Protection",children:e.jsxs(M,{sx:{display:"inline-flex",alignItems:"center",gap:.5,px:1,py:.5,borderRadius:1,bgcolor:"rgba(0,0,0,0.25)"},children:[e.jsx(Yt,{fontSize:"small",sx:{color:s!=null&&s.armorBroken?"error.main":"inherit"}}),e.jsx(D,{variant:"caption",children:(s==null?void 0:s.prot)??0})]})}),(m||i)&&e.jsx(me,{title:s!=null&&s.topWeaponName?Z?`Out of ammo: ${s.topWeaponName}`:`Attack: ${s.topWeaponName}`:"No top weapon",children:e.jsx("span",{children:e.jsx(ne,{size:"small",disabled:!(s!=null&&s.topWeaponName)||Z,onClick:()=>void re(p.tokenId),children:e.jsx(we,{fontSize:"small"})})})}),(m||i)&&e.jsx(me,{title:s!=null&&s.topWeaponName?h<=0?"No ammo to reload":`Reload: ${s.topWeaponName}`:"No top weapon",children:e.jsx("span",{children:e.jsx(ne,{size:"small",disabled:!(s!=null&&s.topWeaponName)||h<=0,onClick:()=>void G(p.tokenId),children:e.jsx(ft,{fontSize:"small"})})})}),e.jsx(me,{title:i||m?"Remove":"Only the owner or GM can remove",children:e.jsx("span",{children:e.jsx(ne,{size:"small",disabled:!i&&!m,onClick:()=>Rt(p.tokenId),children:e.jsx(Pe,{fontSize:"small"})})})})]}),children:[e.jsx(Ut,{children:e.jsx(Ht,{src:s==null?void 0:s.thumbUrl,variant:"rounded",sx:{width:32,height:32,mr:1,cursor:"pointer"}})}),e.jsx($t,{primary:e.jsxs(M,{sx:{display:"flex",alignItems:"center",gap:1,flexWrap:"wrap"},children:[e.jsx(D,{variant:"body2",sx:{fontWeight:600},children:(s==null?void 0:s.name)??p.name??"Token"}),e.jsx(D,{variant:"caption",sx:{opacity:.75},children:p.initiative}),P&&e.jsx(D,{variant:"caption",sx:{px:1,py:.25,borderRadius:1,bgcolor:"rgba(0,128,255,0.2)"},children:"Your Turn"})]}),secondary:e.jsxs(M,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(Gt,{size:"small",checked:R,disabled:!m,onChange:J=>Tt(p.tokenId,J.target.checked)}),e.jsx(D,{variant:"caption",sx:{opacity:.75},children:"Surprised"})]})})]},p.tokenId)})})]})}function Ca(t){return e.jsxs("div",{style:{display:"flex",alignItems:"flex-start",gap:12,justifyContent:"space-between",marginBottom:10},children:[e.jsxs("div",{style:{display:"flex",gap:10,alignItems:"flex-start"},children:[t.thumbUrl?e.jsx("img",{src:t.thumbUrl,alt:"Token thumbnail",style:{width:44,height:44,borderRadius:10,objectFit:"cover",border:"1px solid rgba(0,0,0,0.2)"}}):e.jsx("div",{style:{width:44,height:44,borderRadius:10,border:"1px solid rgba(0,0,0,0.2)",opacity:.4}}),e.jsxs("div",{children:[e.jsxs("div",{style:{fontSize:18,fontWeight:700},children:[t.title," ",e.jsxs("span",{style:{fontSize:12,opacity:.75},children:["(",t.ownerLabel,")"]})]}),e.jsxs("div",{style:{fontSize:12,opacity:.8},children:["Token: ",e.jsx("code",{style:{fontSize:11},children:t.tokenId})]})]})]}),e.jsxs("div",{style:{display:"flex",gap:8},children:[t.showBackButton&&e.jsx("button",{style:{padding:"8px 10px",borderRadius:8,border:"1px solid #999",cursor:"pointer",opacity:.9},onClick:t.onBack,children:"Back to My Sheet"}),t.showUnsetButton&&e.jsx("button",{style:{padding:"8px 10px",borderRadius:8,border:"1px solid #999",cursor:"pointer",opacity:.9},onClick:t.onUnset,children:"Unset “My Character”"})]})]})}function Sa(t){var n,v,b;return e.jsxs("div",{style:X.statusBar,children:[e.jsxs("div",{style:X.statusLeft,children:[e.jsxs("div",{style:X.statusGroup,children:[e.jsx("div",{style:X.statusLabel,children:"Stress"}),e.jsx("input",{type:"number",min:0,value:((n=t.sheet.stress)==null?void 0:n.current)??0,onChange:T=>t.applyStress(Number(T.target.value)),style:X.statusNumber})]}),e.jsxs("div",{style:X.statusGroup,children:[e.jsx("div",{style:X.statusLabel,children:"Wounds"}),e.jsxs("div",{style:X.woundsRow,children:[e.jsx("span",{style:X.woundsKind,children:"L"}),Array.from({length:4}).map((T,f)=>{var m;return e.jsx("input",{type:"checkbox",checked:(((m=t.sheet.wounds)==null?void 0:m.light)??0)>f,onChange:()=>t.toggleWound("light",f)},`wl_${f}`)}),e.jsx("span",{style:{width:8}}),e.jsx("span",{style:X.woundsKind,children:"M"}),Array.from({length:2}).map((T,f)=>{var m;return e.jsx("input",{type:"checkbox",checked:(((m=t.sheet.wounds)==null?void 0:m.moderate)??0)>f,onChange:()=>t.toggleWound("moderate",f)},`wm_${f}`)}),e.jsx("span",{style:{width:8}}),e.jsx("span",{style:X.woundsKind,children:"H"}),Array.from({length:1}).map((T,f)=>{var m;return e.jsx("input",{type:"checkbox",checked:(((m=t.sheet.wounds)==null?void 0:m.heavy)??0)>f,onChange:()=>t.toggleWound("heavy",f)},`wh_${f}`)})]})]}),e.jsxs("label",{style:{display:"flex",alignItems:"center",gap:6},children:[e.jsx("input",{type:"checkbox",checked:!!t.sheet.indomitable,onChange:T=>t.setIndomitable(T.target.checked)}),e.jsx("span",{style:{fontSize:12,opacity:.9},children:"Indomitable"})]}),(((v=t.sheet.stress)==null?void 0:v.current)??0)>(((b=t.sheetForView.stress)==null?void 0:b.cuf)??0)&&e.jsx("div",{style:X.warning,children:"Stress > CUF: make all rolls with +1 Penalty Die"}),e.jsxs("div",{style:{fontSize:12,opacity:.85},children:["Bulk: ",t.totalBulk," / ",t.effectiveCarryingCapacity]}),t.encumbranceLabel&&e.jsx("div",{style:X.warning,children:t.encumbranceLabel})]}),e.jsxs("div",{style:X.statusRight,children:[t.crucible&&t.crucible.status==="pending"&&e.jsxs("div",{style:X.crucibleBox,children:[e.jsx("div",{style:{fontWeight:700},children:"Crucible Test!"}),e.jsxs("div",{style:{fontSize:12,opacity:.85},children:["Incoming stress: ",t.crucible.incoming," • DC ",t.crucible.dc," • Roll CUF (no bonus/penalty dice)"]}),e.jsx("button",{style:X.buttonSecondary,onClick:()=>t.rollCrucibleTest(t.crucible.incoming),children:"Roll Crucible"})]}),t.crucible&&t.crucible.status==="success"&&e.jsxs("div",{style:X.crucibleBox,children:[e.jsx("div",{style:{fontWeight:700},children:"Crucible succeeded!"}),e.jsx("div",{style:{fontSize:12,opacity:.85},children:"Choose an Indomitable effect. (Indomitable checked automatically.)"})]}),t.crucible&&t.crucible.status==="fail"&&e.jsxs("div",{style:X.crucibleBox,children:[e.jsx("div",{style:{fontWeight:700},children:"Crucible failed"}),e.jsx("div",{style:{fontSize:12,opacity:.85},children:"You’ve entered PTSD range (6–8 stress)."}),e.jsx("button",{style:X.buttonSecondary,onClick:t.burnCufToPass,children:"Spend 1 CUF to pass"})]})]})]})}const X={statusBar:{display:"flex",alignItems:"flex-start",justifyContent:"space-between",gap:12,padding:"10px 12px",borderRadius:12,border:"1px solid rgba(255,255,255,0.15)",marginBottom:10},statusLeft:{display:"flex",alignItems:"center",gap:16,flexWrap:"wrap"},statusRight:{display:"flex",alignItems:"center",gap:12},statusGroup:{display:"flex",flexDirection:"column",gap:4},statusLabel:{fontSize:11,opacity:.75,letterSpacing:.2},statusNumber:{width:64,fontSize:16},woundsRow:{display:"flex",alignItems:"center",gap:8,flexWrap:"wrap"},woundsKind:{fontSize:11,opacity:.75,width:14,textAlign:"center"},warning:{marginTop:8,fontSize:12,opacity:.9},crucibleBox:{border:"1px solid rgba(255,255,255,0.18)",borderRadius:12,padding:10,maxWidth:240},buttonSecondary:{padding:"6px 10px",borderRadius:8,border:"1px solid #999",cursor:"pointer",opacity:.9,background:"transparent"}};function Ia(t){const n=gt(),v=n.palette.text.primary,b=n.palette.mode==="dark"?"rgba(255,255,255,0.25)":"#777",T=n.palette.mode==="dark"?"rgba(255,255,255,0.12)":"transparent";return e.jsxs("div",{style:{display:"flex",gap:8,alignItems:"center",marginBottom:10},children:[e.jsx(ke,{label:"Core",active:t.activeTab==="core",onClick:()=>t.onTab("core"),color:v,borderColor:b,activeBg:T}),e.jsx(ke,{label:"Skills",active:t.activeTab==="skills",onClick:()=>t.onTab("skills"),color:v,borderColor:b,activeBg:T}),e.jsx(ke,{label:"Combat",active:t.activeTab==="combat",onClick:()=>t.onTab("combat"),color:v,borderColor:b,activeBg:T}),e.jsx(ke,{label:"Initiative",active:t.activeTab==="initiative",onClick:()=>t.onTab("initiative"),color:v,borderColor:b,activeBg:T}),e.jsx(ke,{label:"Inventory",active:t.activeTab==="inventory",onClick:()=>t.onTab("inventory"),color:v,borderColor:b,activeBg:T}),e.jsx(ke,{label:"Feats",active:t.activeTab==="feats",onClick:()=>t.onTab("feats"),color:v,borderColor:b,activeBg:T}),e.jsx("div",{style:{marginLeft:"auto",opacity:.8},children:t.isSaving?"Saving…":"Synced"})]})}function ke(t){return gt().palette.mode,e.jsx("button",{onClick:t.onClick,style:{padding:"6px 10px",borderRadius:999,border:`1px solid ${t.borderColor}`,cursor:"pointer",background:t.active?t.activeBg:"transparent",fontWeight:t.active?700:400,color:t.color,outline:"none",boxShadow:"none",appearance:"none"},children:t.label})}function Da(){var Ke,Je,Ve,Qe,Xe;const[t,n]=C.useState({kind:"loading"}),[v,b]=C.useState("core"),[T,f]=C.useState(!1),[m,u]=C.useState(null),[A,Q]=C.useState(!1),[ie,S]=C.useState([]);async function te(l){var c,y,w,I,q,z;try{const U=await $.scene.items.getItems([l]),E=U==null?void 0:U[0];if(!E)return{ownerLabel:"unowned",thumbUrl:null};const ee=((c=E==null?void 0:E.image)==null?void 0:c.url)??((y=E==null?void 0:E.image)==null?void 0:y.href)??(E==null?void 0:E.imageUrl)??(E==null?void 0:E.image)??((w=E==null?void 0:E.thumbnail)==null?void 0:w.url)??null,se=(I=E==null?void 0:E.metadata)==null?void 0:I[ct];if(typeof se!="string"||se.length===0)return{ownerLabel:"unowned",thumbUrl:ee,ownerPlayerId:null,isOwnedByMe:!1};const ue=await $.player.getId();if(se===ue)return{ownerLabel:"owned by you",thumbUrl:ee,ownerPlayerId:se,isOwnedByMe:!0};try{const K=(await((z=(q=$.party).getPlayers)==null?void 0:z.call(q))??[]).find(ge=>(ge==null?void 0:ge.id)===se);return{ownerLabel:`owned by ${typeof(K==null?void 0:K.name)=="string"&&K.name.length>0?K.name:se}`,thumbUrl:ee,ownerPlayerId:se,isOwnedByMe:!1}}catch{return{ownerLabel:`owned by ${se}`,thumbUrl:ee,ownerPlayerId:se,isOwnedByMe:!1}}}catch{return{ownerLabel:"unowned",thumbUrl:null,ownerPlayerId:null,isOwnedByMe:!1}}}async function ae(l){const[c,y]=await Promise.all([ut({skills:l.skills??{},inherentSkills:oe.inherent??[]}),He({skills:l.skills??{}})]);return{...l,attributes:{...l.attributes,...c},stress:{...l.stress??{current:0,cuf:0,cufLoss:0},cuf:y.cuf}}}async function re(l){const c=l!=null&&l.ignoreOpenOverride?null:await Pt();if(c)if(await Le(c)){const U=await We(c);if(!U)throw new Error("Could not load sheet from token.");try{const E=await ae(U),ee=await te(c);n({kind:"ready",tokenId:c,sheet:E,mode:"view",suppressUnset:!0,...ee})}catch{n({kind:"error",message:"Rules calc API unavailable. Please retry."})}return}else await Fe(null);let w=await dt();if(w||(w=await Ze(),w&&await ve(w)),!w){n({kind:"need-token"});return}let I=await Le(w);if(!I){const z=await Ze();z&&(w=z,await ve(w),I=await Le(w))}if(!I){await ve(null),n({kind:"need-token"});return}const q=await We(w);if(!q)throw new Error("Could not load sheet from token.");try{await et(w)}catch{}try{const z=await ae(q),U=await te(w);n({kind:"ready",tokenId:w,sheet:z,mode:"my",suppressUnset:!!(l!=null&&l.suppressUnset),...U})}catch{n({kind:"error",message:"Rules calc API unavailable. Please retry."})}}C.useEffect(()=>{let l=!1;return $.onReady(async()=>{try{const c=await $.player.getRole();l||Q(String(c).toUpperCase()==="GM"),await re()}catch(c){l||n({kind:"error",message:c.message??"Unknown error"})}}),()=>{l=!0}},[]),C.useEffect(()=>{let l=null,c=!1;return $.onReady(()=>{c||(l=$.broadcast.onMessage(Ge,y=>{const w=y.data;w!=null&&w.text&&S(I=>[...I,w].slice(-3))}))}),()=>{if(c=!0,typeof l=="function")try{l()}catch{}}},[]),C.useEffect(()=>{let l=null,c=null,y=!1;const w="whisperspace.combatLogLeader",I=2e3,q=6e3,z=`${Date.now()}-${Math.random().toString(36).slice(2,10)}`,U=()=>{try{const K=localStorage.getItem(w);return K?JSON.parse(K):null}catch{return null}},E=K=>{try{localStorage.setItem(w,JSON.stringify({id:z,ts:K??Date.now()}))}catch{}},ee=()=>{const K=U();return K&&K.id===z},se=()=>{const K=Date.now(),le=U();(!le||K-(le.ts??0)>q||le.id===z)&&E(K)},ue=()=>{const K=ee();if(K&&!l)l=$.broadcast.onMessage(Ge,le=>{const ge=le.data;ge!=null&&ge.text&&$.notification.show(String(ge.text),"INFO")});else if(!K&&l){try{l()}catch{}l=null}},xe=K=>{K.key===w&&ue()};return $.onReady(()=>{if(!y){try{window.addEventListener("storage",xe)}catch{}se(),ue(),c=window.setInterval(()=>{y||(se(),ue())},I)}}),()=>{y=!0;try{window.removeEventListener("storage",xe)}catch{}if(c!==null&&clearInterval(c),ee())try{localStorage.removeItem(w)}catch{}if(typeof l=="function")try{l()}catch{}}},[]);function G(l,c,y){const w={text:`${l} took ${c} damage${y?` and +${y} stress`:""}.`,ts:Date.now(),kind:"effect",targetName:l,damageApplied:c,stressApplied:y};S(I=>[...I,w].slice(-3))}async function p(l){var I;if(t.kind!=="ready"||t.mode!=="my")return;const c=Math.max(0,Math.trunc(l.damageApplied??0)),y=Math.max(0,Math.trunc(l.stressApplied??0));if(c<=0&&y<=0)return;const w=await bt({sheet:t.sheet,incomingDamage:c,stressDelta:y});w.stressDelta>0&&O(((I=w.sheet.stress)==null?void 0:I.current)??0),G(t.sheet.name||"Target",c,y),R(()=>w.sheet)}C.useEffect(()=>{var I,q,z,U;if(t.kind!=="ready")return;const l=t.tokenId;let c=!1;const y=async()=>{var E,ee;try{const se=await $.scene.items.getItems([l]),ue=se==null?void 0:se[0],xe=String(((E=ue==null?void 0:ue.text)==null?void 0:E.plainText)??"").trim(),K=(ee=ue==null?void 0:ue.image)==null?void 0:ee.url;if(c||!xe&&!K)return;n(le=>{if(le.kind!=="ready"||le.tokenId!==l)return le;const ge=xe&&le.sheet.name!==xe?{...le.sheet,name:xe}:le.sheet;return{...le,sheet:ge,thumbUrl:K??le.thumbUrl}})}catch{}};y();const w=(U=(z=(q=(I=$)==null?void 0:I.scene)==null?void 0:q.items)==null?void 0:z.onChange)==null?void 0:U.call(z,E=>{Array.isArray(E)&&E.some(ee=>(ee==null?void 0:ee.id)===l)&&y()});return()=>{c=!0,typeof w=="function"&&w()}},[t.kind,t.kind==="ready"?t.tokenId:null]);const s=C.useMemo(()=>t.kind==="ready"&&t.sheet.name||"Whisperspace Character Sheet",[t]);async function a(){const l=await Xt();if(!l){n({kind:"error",message:"No token selected. Select a token on the map first."});return}const c=await We(l);if(!c){n({kind:"error",message:"Could not attach a sheet to the selected token."});return}const y=await ae(c);await ve(l);try{await et(l)}catch{}await Fe(null);const w=await te(l);n({kind:"ready",tokenId:l,sheet:y,mode:"my",suppressUnset:!1,...w})}async function i(){await ve(null);try{await Et()}catch{}n({kind:"need-token"})}async function N(){await Fe(null),n({kind:"loading"});try{await re({ignoreOpenOverride:!0,suppressUnset:!0})}catch(l){n({kind:"error",message:l.message??"Unknown error"})}}async function P(l,c){f(!0);try{await $e(l,c)}finally{f(!1)}}function R(l){n(c=>{if(c.kind!=="ready")return c;let y=l(c.sheet);return P(c.tokenId,y),(async()=>{try{const w=await ae(y);n(I=>I.kind!=="ready"||I.tokenId!==c.tokenId?I:{...I,sheet:w}),await P(c.tokenId,w)}catch{}})(),{...c,sheet:y}})}async function h(l){var U;if(t.kind!=="ready")return;const c=8+l,y=Math.max(0,Math.trunc(((U=t.sheet.stress)==null?void 0:U.cuf)??0)),w=`Crucible Test (DC ${c})`,I=y===0?"":` +${y}`,q=`1d12 # ${w}${I}`;let z;try{z=await Ye({diceNotation:q,rollTarget:"everyone",showResults:!0,timeoutMs:6e3})}catch{$.notification.show("Dice+ roll failed or timed out.","WARNING");return}z>=c?(R(E=>({...E,stress:{...E.stress??{current:0,cuf:0,cufLoss:0},current:5},indomitable:!0})),u({incoming:l,dc:c,status:"success",total:z})):u({incoming:l,dc:c,status:"fail",total:z})}function O(l){var w;if(t.kind!=="ready")return;const c=Math.max(0,Math.trunc(((w=t.sheet.stress)==null?void 0:w.current)??0)),y=Math.max(0,Math.trunc(l));if(c<=5&&y>5){const I=y-c;u({incoming:I,dc:8+I,status:"pending"})}else u(null);R(I=>({...I,stress:{...I.stress??{current:0,cuf:0,cufLoss:0},current:y}}))}function Z(l,c){var z;if(t.kind!=="ready")return;const w={light:4,moderate:2,heavy:1}[l],I=Math.max(0,Math.trunc(((z=t.sheet.wounds)==null?void 0:z[l])??0)),q=c<I?c:c+1;R(U=>({...U,wounds:{...U.wounds,[l]:Math.min(w,Math.max(0,q))}}))}function J(){var c;if(t.kind!=="ready"||!m||m.status!=="fail")return;const l=Math.max(0,Math.trunc(((c=t.sheet.stress)==null?void 0:c.cufLoss)??0));R(y=>({...y,stress:{...y.stress??{current:0,cuf:0,cufLoss:0},cufLoss:l+1,current:5},indomitable:!0})),u({...m,status:"success"})}const j=t.kind==="ready"?t.sheet:null,[H,L]=je.useState({});C.useEffect(()=>{let l=!0;return(async()=>{if(!j){l&&L({});return}const c=[];(j.feats??[]).forEach(y=>{typeof(y==null?void 0:y.statusEffects)=="string"&&y.statusEffects.trim()&&c.push(y.statusEffects)}),(j.inventory??[]).forEach(y=>{typeof(y==null?void 0:y.statusEffects)=="string"&&y.statusEffects.trim()&&c.push(y.statusEffects)});try{const y=await Ue({statuses:c});l&&L(y.deltas??{})}catch{l&&L({})}})(),()=>{l=!1}},[j]);const d=je.useMemo(()=>{const l={},c=new Map,y=I=>{const q=String(I.id),z=String(I.name??I.label??"").toLowerCase().replace(/\s+/g,"_").replace(/[^a-z0-9_\-()]/g,"");q&&(c.set(q.toLowerCase(),q),z&&c.set(z,q))};(oe.inherent??[]).forEach(y),Object.values(oe.learned??{}).forEach(I=>{(I??[]).forEach(y)});const w=new Set(["phys","ref","soc","ment","carrying_capacity","cool_under_fire","speed","cuf","carry","capacity","spd"]);return Object.entries(H??{}).forEach(([I,q])=>{const z=String(I).toLowerCase();if(w.has(z))return;const U=c.get(z);U&&(l[U]=(l[U]??0)+(Number.isFinite(q)?q:0))}),l},[H]),x=Math.max(0,(((Ke=j==null?void 0:j.attributes)==null?void 0:Ke.phys)??0)+(H.phys??0)),W=Math.max(0,(((Je=j==null?void 0:j.attributes)==null?void 0:Je.ref)??0)+(H.ref??0)),Y=Math.max(0,(((Ve=j==null?void 0:j.attributes)==null?void 0:Ve.soc)??0)+(H.soc??0)),F=Math.max(0,(((Qe=j==null?void 0:j.attributes)==null?void 0:Qe.ment)??0)+(H.ment??0)),ce=5+x*5+(H.carrying_capacity??0);30+x*5+(H.speed??0);const o=((Xe=j==null?void 0:j.stress)==null?void 0:Xe.cuf)??0,r=Math.max(0,o+(H.cool_under_fire??0)),_=je.useMemo(()=>j?{...j,attributes:{...j.attributes,phys:x,ref:W,soc:Y,ment:F},stress:{...j.stress??{current:0,cuf:0,cufLoss:0},cuf:r}}:null,[j,x,W,Y,F,r])??j,de=je.useMemo(()=>{var w;if(!j)return 0;const l=(j.weapons??[]).reduce((I,q)=>I+(q.bulk??0),0),c=((w=j.armor)==null?void 0:w.bulk)??0,y=(j.inventory??[]).reduce((I,q)=>{const z=q.quantity??1,U=q.bulk??0,E=Number.isFinite(U)?U:0,ee=Number.isFinite(z)?z:1;return I+E*ee},0);return l+c+y},[j]),ze=j&&de>ce*2?"Heavily Encumbered":j&&de>ce?"Encumbered":"";if(t.kind==="loading")return e.jsx("div",{style:{padding:12},children:"Loading…"});if(t.kind==="need-token")return e.jsxs("div",{style:{padding:12},children:[e.jsx("h2",{style:{margin:"0 0 8px 0"},children:"Whisperspace Character Sheet"}),e.jsx("p",{style:{margin:"0 0 10px 0",lineHeight:1.35},children:"Select your character token on the map, then click:"}),e.jsx("button",{style:{padding:"8px 10px",borderRadius:8,border:"1px solid #666",cursor:"pointer"},onClick:a,children:"Set Selected Token as My Character"})]});if(t.kind==="error")return e.jsxs("div",{style:{padding:12},children:[e.jsx("h2",{style:{margin:"0 0 8px 0"},children:"Error"}),e.jsx("p",{style:{margin:"0 0 10px 0",lineHeight:1.35},children:t.message}),e.jsx("button",{style:{padding:"8px 10px",borderRadius:8,border:"1px solid #666",cursor:"pointer"},onClick:()=>n({kind:"need-token"}),children:"Back"})]});const pt=t.ownerLabel??(t.mode==="view"?"Viewing token":"My Character"),kt=t.mode==="view"&&!t.isOwnedByMe,vt=t.mode==="my"&&!t.suppressUnset;return e.jsxs("div",{style:{padding:12},children:[e.jsx(Ca,{title:s,ownerLabel:pt,tokenId:t.tokenId,thumbUrl:t.thumbUrl??null,showBackButton:kt,onBack:N,showUnsetButton:vt,onUnset:i}),e.jsxs(e.Fragment,{children:[e.jsx(Sa,{sheet:t.sheet,sheetForView:_,totalBulk:de,effectiveCarryingCapacity:ce,encumbranceLabel:ze,crucible:m,applyStress:O,toggleWound:Z,setIndomitable:l=>R(c=>({...c,indomitable:l})),rollCrucibleTest:h,burnCufToPass:J}),e.jsx(Ia,{activeTab:v,onTab:b,isSaving:T}),e.jsxs("div",{style:{border:"1px solid #888",borderRadius:12,padding:10},children:[v==="core"&&e.jsx(Zt,{sheet:_,onChange:l=>R(c=>({...c,...l}))}),v==="skills"&&e.jsx(aa,{sheet:_,skillMods:d,onChange:l=>R(c=>({...c,skills:l})),onMetaChange:l=>R(c=>({...c,...l}))}),v==="combat"&&e.jsx(ua,{sheet:_,tokenId:t.tokenId,skillMods:d,onChange:l=>R(c=>({...c,...l})),onApplyStress:O,combatLog:ie,onApplyCombatLog:t.mode==="my"?p:void 0,isGM:A}),v==="initiative"&&e.jsx(wa,{}),v==="inventory"&&e.jsx(ja,{sheet:_,onChange:l=>R(c=>({...c,...l}))}),v==="feats"&&e.jsx(sa,{sheet:_,onChange:l=>R(c=>({...c,feats:l}))})]})]})]})}async function Ma(){await $.onReady(async()=>{}),jt.createRoot(document.getElementById("root")).render(e.jsx(je.StrictMode,{children:e.jsx(Vt,{children:e.jsx(Da,{})})}))}Ma();
