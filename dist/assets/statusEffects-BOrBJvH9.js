import{O as c}from"./vendor_obr-BLY5dk8V.js";import{o as m,s as r,n as o,r as N,u as U,b as x,a as y,d as B,l as k,e as V}from"./vendor_zod-CxP395f9.js";const D="whisperspace.sheet.v1",H=m({name:r().default(""),description:r().default(""),statusEffects:r().default("")}),z=m({name:r().default(""),keywords:y(r()).default([]),keywordParams:N(U([r(),o(),x()])).default({}),protection:o().int().nonnegative().default(0),durability:m({current:o().int().nonnegative().default(0),max:o().int().nonnegative().default(0)}).default({current:0,max:0}),bulk:o().int().nonnegative().optional(),req:r().optional(),cost:o().int().nonnegative().optional(),special:r().optional()}),G=m({id:r().optional(),name:r().default(""),skillId:r().default(""),useDC:o().int().default(8),damage:o().int().default(0),keywords:y(r()).default([]),keywordParams:N(U([r(),o(),x()])).default({}),range:r().optional(),ammo:o().int().nonnegative().optional(),bulk:o().int().nonnegative().optional(),req:r().optional(),cost:o().int().nonnegative().optional()}),F=m({schemaVersion:k(1).default(1),name:r().default(""),attributes:m({phys:o().int().nonnegative().default(0),ref:o().int().nonnegative().default(0),soc:o().int().nonnegative().default(0),ment:o().int().nonnegative().default(0)}).default({phys:0,ref:0,soc:0,ment:0}),stress:m({current:o().int().nonnegative().default(0),cuf:o().int().nonnegative().default(0),cufLoss:o().int().nonnegative().default(0)}).default({current:0,cuf:0,cufLoss:0}),wounds:m({light:o().int().nonnegative().default(0),moderate:o().int().nonnegative().default(0),heavy:o().int().nonnegative().default(0)}).default({light:0,moderate:0,heavy:0}),skills:N(o().int()).default({}),learningFocus:V(["combat","education","vehicles"]).optional(),skillPoints:o().int().nonnegative().optional(),weapons:y(G).default([]),armor:z.optional(),credits:o().int().nonnegative().default(0),inventory:y(B("type",[m({id:r().optional(),type:k("item"),name:r().default(""),quantity:o().int().default(1),uses:r().default(""),bulk:o().int().default(0),effect:r().default(""),cost:o().int().default(0),statusEffects:r().default("")}),m({id:r().optional(),type:k("cyberware"),name:r().default(""),quantity:o().int().default(1),bulk:o().int().default(1),tier:o().int().default(1),installationDifficulty:o().int().default(0),requirements:r().default(""),physicalImpact:r().default(""),effect:r().default(""),cost:o().int().default(0),statusEffects:r().default("")}),m({id:r().optional(),type:k("narcotics"),name:r().default(""),bulk:o().int().default(1),quantity:o().int().default(1),uses:o().int().default(1),addictionScore:o().int().default(0),legality:r().default(""),effect:r().default(""),cost:o().int().default(0),statusEffects:r().default("")})])).default([]),indomitable:x().default(!1),feats:y(H).default([]),notes:r().optional()}),O=F;function $(t){const e=F.parse({});return typeof t=="string"&&t.trim().length>0?{...e,name:t.trim()}:e}function K(t){const e=O.safeParse(t);if(e.success)return e.data;const n=$(typeof(t==null?void 0:t.name)=="string"?t.name:void 0),s=t==null?void 0:t.skills,a=Q(X(s)?s:{}),i={...n,...w(t,["name","archetype","background","motivation","notes"]),attributes:{...n.attributes,...w(t==null?void 0:t.attributes,["phys","ref","soc","ment"])},stress:{...n.stress,...w(t==null?void 0:t.stress,["current","cuf"])},wounds:{...n.wounds,...w(t==null?void 0:t.wounds,["light","moderate","heavy"])},skills:a,feats:Array.isArray(t==null?void 0:t.feats)?t.feats:n.feats,weapons:Array.isArray(t==null?void 0:t.weapons)?t.weapons:n.weapons,armor:(t==null?void 0:t.armor)??n.armor,schemaVersion:1},u=O.safeParse(i);return u.success?u.data:n}const mt=K,J={powerlifting:"powerlift",light_weapons:"weapons_light",medium_weapons:"weapons_medium",heavy_weapons:"weapons_heavy",exotic_weapons:"weapons_exotic",melee_blunt:"melee_weapons",melee_sharp:"melee_weapons"};function Q(t){const e={};for(const[n,s]of Object.entries(t??{})){const a=J[n]??n,i=typeof s=="number"?s:0;e[a]=Math.max(e[a]??0,i)}for(const[n,s]of Object.entries(e))s||delete e[n];return e}function w(t,e){const n={};if(!t||typeof t!="object")return n;for(const s of e)t[s]!==void 0&&(n[s]=t[s]);return n}function X(t){if(!t||typeof t!="object")return!1;for(const e of Object.values(t))if(typeof e!="number")return!1;return!0}const P="com.whisperspace.sheet",S=`${P}/myCharacterTokenId`,A=`${P}/openTokenId`,_=`${P}/ownerPlayerId`;function Y(t){return typeof t=="string"&&t.length>0}async function pt(){const e=(await c.player.getMetadata())[S];return Y(e)?e:null}async function bt(t){const n={...await c.player.getMetadata()};t?n[S]=t:delete n[S],await c.player.setMetadata(n)}async function yt(){const e=(await c.player.getMetadata())[A];return Y(e)?e:null}async function ht(t){const n={...await c.player.getMetadata()};t?n[A]=t:delete n[A],await c.player.setMetadata(n)}async function Z(t){var d,v;const n=(await c.scene.items.getItems([t]))[0];if(!n)return null;const s=(d=n==null?void 0:n.text)==null?void 0:d.plainText,a=s&&s.trim().length>0?s:n.name??"Unnamed",i=(v=n.metadata)==null?void 0:v[D];if(!i)return $(a);const u=K(i);return!u.name||u.name==="Unnamed"?{...u,name:a}:u}async function tt(t,e){await c.scene.items.updateItems([t],n=>{const s=n[0];if(s){s.metadata[D]=e;try{const a=s.text??{};s.text={...a,plainText:e.name}}catch{}}})}async function et(t){var s;const n=(await c.scene.items.getItems([t]))[0];return n?!!((s=n.metadata)!=null&&s[D]):!1}async function gt(t){const e=await Z(t);return e?(await et(t)||await tt(t,e),e):null}async function vt(t){const e=await c.player.getId();(await c.scene.items.getItems([t]))[0]&&await c.scene.items.updateItems([t],s=>{const a=s[0];a&&(a.metadata[_]=e)})}async function It(){const t=await c.player.getId(),n=(await c.scene.items.getItems()).find(s=>{var a;return((a=s.metadata)==null?void 0:a[_])===t});return(n==null?void 0:n.id)??null}async function kt(){const t=await c.player.getId(),n=(await c.scene.items.getItems()).filter(a=>{var i;return((i=a.metadata)==null?void 0:i[_])===t});if(n.length===0)return;const s=n.map(a=>a.id);await c.scene.items.updateItems(s,a=>{a.forEach(i=>{i&&delete i.metadata[_]})})}const L="dice-plus/isReady",q="dice-plus/roll-request",T="whisperspace.obr.sheet";async function nt(t=1e3){const e=crypto.randomUUID();return new Promise(n=>{const s=c.broadcast.onMessage(L,a=>{const i=a.data;(i==null?void 0:i.requestId)===e&&i.ready===!0&&(s(),n(!0))});c.broadcast.sendMessage(L,{requestId:e,timestamp:Date.now()},{destination:"ALL"}),setTimeout(()=>{s(),n(!1)},t)})}function wt(t){const e=Math.max(-2,Math.min(2,Math.trunc(t.netDice))),n=1+Math.abs(e);let s="1d12";e>0&&(s=`${n}d12kh1`),e<0&&(s=`${n}d12kl1`);const a=Number.isFinite(t.modifier)?Math.trunc(t.modifier):0,i=a===0?"":a>0?` +${a}`:` ${a}`;return`${s} # ${t.label}${i}`}async function Tt(t){const e=crypto.randomUUID();return await c.broadcast.sendMessage(q,{rollId:e,playerId:await c.player.getId(),playerName:await c.player.getName(),rollTarget:t.rollTarget??"everyone",diceNotation:t.diceNotation,showResults:t.showResults??!0,timestamp:Date.now(),source:T},{destination:"ALL"}),e}async function _t(t){if(!await nt())throw new Error("Dice+ is not available");const n=crypto.randomUUID(),s=t.timeoutMs??5e3;return new Promise(async(a,i)=>{const u=l=>{var b,C;const f=[l==null?void 0:l.total,l==null?void 0:l.value,(b=l==null?void 0:l.result)==null?void 0:b.total,(C=l==null?void 0:l.result)==null?void 0:C.totalValue];for(const I of f){const R=typeof I=="number"?I:typeof I=="string"?Number(I):NaN;if(Number.isFinite(R))return Math.trunc(R)}return NaN},d=c.broadcast.onMessage(`${T}/roll-result`,l=>{const f=l.data;if((f==null?void 0:f.rollId)===n){const b=u(f);if(!Number.isFinite(b))return;E(),a(b)}}),v=c.broadcast.onMessage(`${T}/roll-error`,l=>{const f=l.data;(f==null?void 0:f.rollId)===n&&(E(),i(new Error((f==null?void 0:f.error)||"Dice+ roll failed")))}),E=()=>{d(),v()};await c.broadcast.sendMessage(q,{rollId:n,playerId:await c.player.getId(),playerName:await c.player.getName(),rollTarget:t.rollTarget??"everyone",diceNotation:t.diceNotation,showResults:t.showResults??!0,timestamp:Date.now(),source:T},{destination:"ALL"}),setTimeout(()=>{E(),i(new Error("Dice+ roll timed out (no roll-result received)"))},s)})}const at=2,it=[{id:"athletics",label:"Athletics",attribute:"phys"},{id:"cybernetics",label:"Cybernetics",attribute:"phys"},{id:"powerlift",label:"Powerlift",attribute:"phys"},{id:"endurance",label:"Endurance",attribute:"phys"},{id:"toughness",label:"Toughness",attribute:"phys"},{id:"balance",label:"Balance",attribute:"ref"},{id:"evade",label:"Evade",attribute:"ref"},{id:"finesse",label:"Finesse",attribute:"ref"},{id:"instinct",label:"Instinct",attribute:"ref"},{id:"stealth",label:"Stealth",attribute:"ref"},{id:"subterfuge",label:"Subterfuge",attribute:"soc"},{id:"bearing",label:"Bearing",attribute:"soc"},{id:"negotiate",label:"Negotiate",attribute:"soc"},{id:"persuade",label:"Persuade",attribute:"soc"},{id:"streetwise",label:"Streetwise",attribute:"soc"},{id:"composure",label:"Composure",attribute:"ment"},{id:"psychology",label:"Psychology",attribute:"ment"},{id:"observe",label:"Observe",attribute:"ment"},{id:"recall",label:"Recall",attribute:"ment"},{id:"willpower",label:"Willpower",attribute:"ment"}],st={combat:[{id:"melee_weapons",label:"Melee (weapons)",attribute:"phys"},{id:"melee_unarmed",label:"Melee (unarmed)",attribute:"phys"},{id:"weapons_light",label:"Weapons (light)",attribute:"ref"},{id:"weapons_medium",label:"Weapons (medium)",attribute:"ref"},{id:"weapons_heavy",label:"Weapons (heavy)",attribute:"phys"},{id:"weapons_exotic",label:"Weapons (exotic)",attribute:"ment"},{id:"power_armour",label:"Power Armour",attribute:"phys"},{id:"explosives",label:"Explosives",attribute:"ment"},{id:"tactics",label:"Tactics",attribute:"ment"}],education:[{id:"material_sciences",label:"Material Sciences",attribute:"ment"},{id:"computers",label:"Computers",attribute:"ment"},{id:"cryptology",label:"Cryptology",attribute:"ment"},{id:"electronics",label:"Electronics",attribute:"ment"},{id:"engineering",label:"Engineering",attribute:"ment"},{id:"first_aid",label:"First Aid",attribute:"ment"},{id:"forgery",label:"Forgery",attribute:"soc"},{id:"history",label:"History",attribute:"ment"},{id:"linguistics",label:"Linguistics",attribute:"ment"},{id:"research",label:"Research",attribute:"ment"},{id:"natural_sciences",label:"Natural Sciences",attribute:"ment"}],vehicles:[{id:"gunnery",label:"Gunnery",attribute:"ref"},{id:"navigation",label:"Navigation",attribute:"ment"},{id:"piloting",label:"Piloting",attribute:"ref"},{id:"remote_operation",label:"Remote Operation",attribute:"ment"},{id:"sensors",label:"Sensors",attribute:"ment"},{id:"systems_interface",label:"Systems Interface",attribute:"ment"}]},ot={version:at,inherent:it,learned:st},Mt=ot,W="whisperspace.obr.sheet/initiativeTracker",rt="whisperspace.obr.sheet/initActive",j=()=>({entries:[],updatedAt:Date.now()});function h(t){return[...t].sort((e,n)=>n.initiative!==e.initiative?n.initiative-e.initiative:(n.updatedAt??0)-(e.updatedAt??0))}async function p(){const t=await c.scene.getMetadata(),e=t==null?void 0:t[W];if(!e||typeof e!="object")return j();const s=(Array.isArray(e.entries)?e.entries:[]).filter(i=>i&&typeof i.tokenId=="string").map(i=>({tokenId:String(i.tokenId),name:typeof i.name=="string"?i.name:"Unnamed",thumbUrl:typeof i.thumbUrl=="string"?i.thumbUrl:void 0,initiative:Number.isFinite(i.initiative)?Math.trunc(i.initiative):0,surprised:typeof i.surprised=="boolean"?i.surprised:!1,updatedAt:Number.isFinite(i.updatedAt)?Math.trunc(i.updatedAt):0})),a={entries:h(s),activeTokenId:typeof e.activeTokenId=="string"?e.activeTokenId:void 0,updatedAt:Number.isFinite(e.updatedAt)?Math.trunc(e.updatedAt):Date.now()};return a.entries.length>0&&(!a.activeTokenId||!a.entries.some(i=>i.tokenId===a.activeTokenId))&&(a.activeTokenId=a.entries[0].tokenId),a}async function g(t){await c.scene.setMetadata({[W]:t})}async function M(t,e=[]){if(!e.length)return;const n=Array.from(new Set(e));try{await c.scene.items.updateItems(n,s=>{for(const a of s){const i={...a.metadata??{}};i[rt]=t?a.id===t:!1,a.metadata=i}})}catch{}}async function Et(t){const e=await p(),n=t.updatedAt??Date.now(),s=e.entries.filter(u=>u.tokenId!==t.tokenId);s.push({tokenId:t.tokenId,name:t.name,thumbUrl:t.thumbUrl,initiative:Math.trunc(t.initiative),updatedAt:n});const a=h(s),i={entries:a,activeTokenId:e.activeTokenId,updatedAt:Date.now()};return a.length>0&&(!i.activeTokenId||!a.some(u=>u.tokenId===i.activeTokenId))&&(i.activeTokenId=a[0].tokenId),await g(i),await M(i.activeTokenId,a.map(u=>u.tokenId)),i}async function St(){const t=j();await g(t)}async function ct(t){const e=await p(),n=(e.entries??[]).filter(i=>i.tokenId!==t);let s=e.activeTokenId;if(s===t){const i=h(n);s=i.length?i[0].tokenId:void 0}const a={entries:n,activeTokenId:s,updatedAt:Date.now()};return await g(a),await M(a.activeTokenId,n.map(i=>i.tokenId)),a}const At=ct;async function Nt(t,e){const n=await p(),s=(n.entries??[]).map(i=>i.tokenId===t?{...i,surprised:!!e}:i),a={entries:h(s),activeTokenId:n.activeTokenId,updatedAt:Date.now()};return await g(a),await M(a.activeTokenId,s.map(i=>i.tokenId)),a}async function xt(){const t=await p(),e=h(t.entries);if(e.length===0)return t;const n=t.activeTokenId?e.findIndex(d=>d.tokenId===t.activeTokenId):-1,s=n>=0?(n+1)%e.length:0,i=n>=0&&s===0?e.map(d=>({...d,surprised:!1})):e,u={entries:i,activeTokenId:i[s].tokenId,updatedAt:Date.now()};return await g(u),await M(u.activeTokenId,i.map(d=>d.tokenId)),u}function Dt(t){const e=c.scene.onMetadataChange(()=>{p().then(t)});return p().then(t),e}function Pt(t,e){const n={phys:0,ref:0,soc:0,ment:0};for(const s of e){const a=Number((t==null?void 0:t[s.id])??0),i=s.attribute;i&&i in n&&(n[i]+=Math.max(0,a))}return{phys:Math.max(0,Math.ceil(n.phys/4)),ref:Math.max(0,Math.ceil(n.ref/4)),soc:Math.max(0,Math.ceil(n.soc/4)),ment:Math.max(0,Math.ceil(n.ment/4))}}function Ct(t){const n=["instinct","willpower","bearing","toughness","tactics"].reduce((s,a)=>s+Math.max(0,Math.trunc(Number(t[a]??0))),0);return 1+Math.ceil(n/5)}function ut(t){const e={};if(!t)return e;const n=t.split(",").map(s=>s.trim()).filter(Boolean);for(const s of n){const a=s.match(/^([a-zA-Z0-9_\-]+)\s*[:]?\s*([+\-])\s*(\d+)$/);if(!a)continue;const i=String(a[1]).toLowerCase().replace(/\s+/g,"_"),u=a[2]==="-"?-1:1,d=Math.trunc(Number(a[3]));Number.isFinite(d)&&(e[i]=(e[i]??0)+u*d)}return e}function lt(t){const e={};for(const n of t){const s=ut(n??"");for(const[a,i]of Object.entries(s))e[a]=(e[a]??0)+i}return e}function Rt(t){return{deltas:lt(t)}}function Ot(t,e){const n={...t},s=(a,i)=>{!Number.isFinite(i)||i===0||(n[a]=(Number(n[a])||0)+i)};s("phys",e.phys??0),s("ref",e.ref??0),s("soc",e.soc??0),s("ment",e.ment??0),s("coolUnderFire",e.cool_under_fire??0),s("speed",e.speed??0),s("carryingCapacity",e.carrying_capacity??0);for(const[a,i]of Object.entries(e))a==="phys"||a==="ref"||a==="soc"||a==="ment"||a==="cool_under_fire"||a==="speed"||a==="carrying_capacity"||typeof n[a]=="number"&&(n[a]=n[a]+i);return n}export{p as A,ct as B,mt as C,H as F,D as M,_ as T,_t as a,wt as b,nt as c,St as d,xt as e,Nt as f,At as g,pt as h,Rt as i,Ct as j,tt as k,Z as l,Pt as m,Ot as n,Dt as o,lt as p,yt as q,Tt as r,Mt as s,gt as t,Et as u,ht as v,It as w,bt as x,vt as y,kt as z};
