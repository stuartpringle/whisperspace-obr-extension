import"./modulepreload-polyfill-B5Qt9EMX.js";import{r as C,j as e,d as Ce,e as pt}from"./vendor_react-XzhcIodj.js";import{O as U}from"./vendor_obr-BLY5dk8V.js";import{r as ot,b as We,c as kt,s as le,F as vt,a as Je,o as jt,l as Ne,T as ct,d as wt,e as Ct,f as St,g as It,h as dt,i as et,j as ze,k as Ye,m as Se,n as Mt,u as Dt,p as At,q as Tt,t as _e,v as qe,w as tt,x as we,y as at,z as Rt}from"./statusEffects-DyppbTlk.js";import{S as L,B as N,T as D,a as Fe,b as ee,c as b,d as ue,I as ut,e as ie,C as Ie,R as Nt,A as Me,f as De,E as Ae,g as Te,h as he,i as mt,j as ve,P as Et,D as Le,L as nt,k as Pt,M as me,l as ht,m as st,n as zt,o as Wt,p as Ft,q as Lt,r as Bt,s as _t,t as qt,u as Ot,v as Ut,w as $t,x as ft}from"./vendor_mui-CPCl1AAX.js";import{g as Ee,a as Ht,r as Gt,O as Yt}from"./ObrMuiThemeProvider-D1OJ2jnZ.js";import"./vendor-CPvQcOsy.js";import"./vendor_zod-CxP395f9.js";import"./vendor_emotion-pcfylbOS.js";async function Kt(){const t=await U.player.getSelection();return Array.isArray(t)?t:[]}async function Jt(){const t=await Kt();return t.length>0?t[0]:null}async function Oe(t){return(await U.scene.items.getItems([t])).length>0}function Vt(t){var r;const n=t.sheet,[g,h]=C.useState(0),I=C.useMemo(()=>n.attributes??{phys:0,ref:0,soc:0,ment:0},[n.attributes]);async function x(i,j){const _=Number(I[i]??0),X=We({netDice:g,modifier:_,label:j});await ot({diceNotation:X,showResults:!0,rollTarget:"everyone"})}return e.jsxs(L,{spacing:2,children:[e.jsxs(N,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",gap:2,flexWrap:"wrap"},children:[e.jsx(D,{variant:"h6",sx:{m:0},children:"Core"}),e.jsxs(N,{sx:{display:"flex",alignItems:"center",gap:1,flexWrap:"wrap"},children:[e.jsx(D,{variant:"subtitle2",sx:{opacity:.8},children:"Attribute Roll:"}),e.jsxs(Fe,{size:"small",exclusive:!0,value:g,onChange:(i,j)=>{j!==null&&h(j)},children:[e.jsx(ee,{value:-2,children:"−2"}),e.jsx(ee,{value:-1,children:"−1"}),e.jsx(ee,{value:0,children:"0"}),e.jsx(ee,{value:1,children:"+1"}),e.jsx(ee,{value:2,children:"+2"})]})]})]}),e.jsx(b,{label:"Name",size:"small",value:n.name??"",onChange:i=>t.onChange({name:i.target.value}),fullWidth:!0}),e.jsxs(N,{sx:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:1},children:[e.jsx(Pe,{label:"PHYS",tooltip:Ee("PHYS"),value:I.phys,onRoll:()=>x("phys","PHYS Check")}),e.jsx(Pe,{label:"REF",tooltip:Ee("REF"),value:I.ref,onRoll:()=>x("ref","REF Check")}),e.jsx(Pe,{label:"SOC",tooltip:Ee("SOC"),value:I.soc,onRoll:()=>x("soc","SOC Check")}),e.jsx(Pe,{label:"MENT",tooltip:Ee("MENT"),value:I.ment,onRoll:()=>x("ment","MENT Check")})]}),e.jsxs(N,{sx:{display:"grid",gridTemplateColumns:"repeat(3, 1fr)",gap:2},children:[e.jsx(b,{label:"Cool Under Fire",size:"small",value:((r=t.sheet.stress)==null?void 0:r.cuf)??0,inputProps:{readOnly:!0},fullWidth:!0}),e.jsx(b,{label:"Speed",size:"small",value:30+(I.phys??0)*5,inputProps:{readOnly:!0},fullWidth:!0}),e.jsx(b,{label:"Carrying Capacity",size:"small",value:5+(I.phys??0)*5,inputProps:{readOnly:!0},fullWidth:!0})]}),e.jsx(D,{variant:"body2",sx:{opacity:.75},children:"Attributes are derived automatically from skill ranks (¼ of total ranks under each attribute, rounded up)."})]})}function Pe(t){return e.jsxs(N,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsxs(N,{sx:{flex:1,display:"flex",alignItems:"center",gap:.5},children:[e.jsx(b,{label:t.label,size:"small",value:t.value,inputProps:{readOnly:!0},fullWidth:!0}),t.tooltip?e.jsx(ue,{title:t.tooltip,children:e.jsx(ut,{fontSize:"small",sx:{opacity:.7}})}):null]}),e.jsx(ue,{title:"Roll with Dice+",children:e.jsx(ie,{onClick:t.onRoll,"aria-label":`Roll ${t.label}`,children:e.jsx(Ie,{})})})]})}function Ve(t){const n=new Map;return Object.keys(t??{}).forEach(g=>{(t[g]??[]).forEach(h=>n.set(h.id,{focus:g}))}),n}function gt(t){var i,j;const n=String(t.skillId??""),g=((i=t.ranks)==null?void 0:i[n])??0,h=((j=t.skillMods)==null?void 0:j[n])??0;if(g>0)return g+h;const I=t.learningFocus??"combat",x=t.learnedInfoById.get(n);return(x&&x.focus===I?0:-1)+h}const Qt=["phys","ref","soc","ment"],Ue={phys:"PHYSIQUE",ref:"REFLEX",soc:"SOCIAL",ment:"MENTAL"},$e={combat:"Combat",education:"Education",vehicles:"Vehicles"},it={combat:"Combat Focus",education:"Education Focus",vehicles:"Vehicles Focus"};function He(t){const n=xt(t,0,5);return n*(n+1)/2}function Xt(t){const[n,g]=C.useState(""),[h,I]=C.useState(0),[x,r]=C.useState(!0),[i,j]=C.useState(!1),[_,X]=C.useState(""),k=t.sheet.skills??{},$=t.sheet.learningFocus??"combat",se=Number(t.sheet.skillPoints??0);C.useEffect(()=>{let c=!1;return(async()=>{const y=await kt();c||(r(y),j(!0))})().catch(()=>{c||(r(!1),j(!0))}),()=>{c=!0}},[]);const re=C.useMemo(()=>Ve(le.learned),[]);function oe(c){const y=re.get(c.id);return y?y.focus===$?5:2:5}function Z(c){var J;const y=k[c.id]??0,W=((J=t.skillMods)==null?void 0:J[c.id])??0;if(y>0)return y+W;const G=re.get(c.id);return G&&G.focus===$?0+W:-1+W}const m=C.useMemo(()=>{let c=0;for(const y of Object.values(k))c+=He(y??0);return c},[k]),a=Math.max(0,se-m),s=c=>{const y=Math.max(0,Math.trunc(Number(_)));if(!y)return;const W=se+c*y,G=Math.max(m,W);t.onMetaChange({skillPoints:G}),X("")};function A(c){t.onChange(c)}function v(c,y){const W=k[c.id]??0,G=oe(c),J=xt(y,0,G);if(J===W||He(J)-He(W)>a)return;const fe={...k};J===0?delete fe[c.id]:fe[c.id]=J,A(fe)}async function T(c){const y=We({netDice:h,modifier:Z(c),label:c.label});try{await ot({diceNotation:y,showResults:!0,rollTarget:"everyone"})}catch(W){console.error("Dice+ roll request failed:",W)}}const f=C.useMemo(()=>{const c=Object.values(le.learned).flat();return[...le.inherent,...c]},[]),z=C.useMemo(()=>{const c=n.trim().toLowerCase();return c?f.filter(y=>y.label.toLowerCase().includes(c)||y.id.toLowerCase().includes(c)):f},[f,n]),K=C.useMemo(()=>Zt(le.inherent),[]),w=C.useMemo(()=>le.learned,[]),q=n.trim().length>0,Q=e.jsxs(N,{sx:{display:"flex",alignItems:"center",gap:2,flexWrap:"wrap"},children:[e.jsx(D,{variant:"subtitle2",sx:{opacity:.8},children:"Learning Focus:"}),Object.keys(it).map(c=>e.jsxs(N,{sx:{display:"flex",alignItems:"center",gap:.5,cursor:"pointer"},onClick:()=>t.onMetaChange({learningFocus:c}),children:[e.jsx(Nt,{checked:$===c,value:c,size:"small"}),e.jsx(D,{variant:"body2",children:$e[c]})]},c))]}),H=e.jsx(N,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",gap:2,flexWrap:"wrap"},children:e.jsxs(N,{sx:{display:"flex",alignItems:"center",gap:1,flexWrap:"wrap"},children:[e.jsxs(D,{variant:"subtitle2",sx:{minWidth:170},children:["Skill Points: ",a," ",e.jsxs("span",{style:{opacity:.75},children:["(Total: ",se,")"]})]}),e.jsx(he,{size:"small",variant:"outlined",onClick:()=>s(1),disabled:!Number.isFinite(Number(_))||Math.trunc(Number(_))<=0,children:"+"}),e.jsx(b,{label:"SP",size:"small",type:"number",value:_,onChange:c=>X(c.target.value),sx:{width:110}}),e.jsx(he,{size:"small",variant:"outlined",onClick:()=>s(-1),disabled:!Number.isFinite(Number(_))||Math.trunc(Number(_))<=0,children:"-"}),e.jsx(D,{variant:"subtitle2",sx:{opacity:.8},children:"Roll"}),e.jsxs(Fe,{size:"small",exclusive:!0,value:h,onChange:(c,y)=>{y!==null&&I(y)},"aria-label":"Bonus / Penalty dice",children:[e.jsx(ee,{value:-2,children:"−2"}),e.jsx(ee,{value:-1,children:"−1"}),e.jsx(ee,{value:0,children:"0"}),e.jsx(ee,{value:1,children:"+1"}),e.jsx(ee,{value:2,children:"+2"})]}),i&&!x&&e.jsx(D,{variant:"caption",sx:{opacity:.8},children:"(Dice+ not detected)"})]})});return e.jsxs(L,{spacing:2,children:[Q,e.jsx(b,{label:"Search skills",value:n,onChange:c=>g(c.target.value),placeholder:"stealth, weapons, navigation…",fullWidth:!0}),H,q?e.jsx(L,{spacing:1,children:z.map(c=>{const y=re.get(c.id),W=y?$e[y.focus]:Ue[c.attribute];return e.jsx(Ge,{skill:c,rank:k[c.id]??0,modifier:Z(c),maxRank:oe(c),onRank:G=>v(c,G),rightTag:W,canRoll:x,onRoll:()=>T(c)},c.id)})}):e.jsxs(e.Fragment,{children:[e.jsx(D,{variant:"subtitle1",children:"Inherent Skills"}),Qt.map(c=>e.jsxs(Me,{defaultExpanded:!0,children:[e.jsx(De,{expandIcon:e.jsx(Ae,{}),children:e.jsx(D,{fontWeight:700,children:Ue[c]})}),e.jsx(Te,{children:e.jsx(L,{spacing:1,children:(K[c]??[]).map(y=>e.jsx(Ge,{skill:y,rank:k[y.id]??0,modifier:Z(y),maxRank:oe(y),onRank:W=>v(y,W),rightTag:Ue[y.attribute],canRoll:x,onRoll:()=>T(y)},y.id))})})]},c)),e.jsx(D,{variant:"subtitle1",sx:{mt:1},children:"Learned Skills"}),Object.keys(w).map(c=>e.jsxs(Me,{defaultExpanded:!0,children:[e.jsx(De,{expandIcon:e.jsx(Ae,{}),children:e.jsx(D,{fontWeight:700,children:it[c]})}),e.jsx(Te,{children:e.jsx(L,{spacing:1,children:(w[c]??[]).map(y=>e.jsx(Ge,{skill:y,rank:k[y.id]??0,modifier:Z(y),maxRank:oe(y),onRank:W=>v(y,W),rightTag:$e[c],canRoll:x,onRoll:()=>T(y)},y.id))})})]},c))]})]})}function Ge(t){const n=t.rank<t.maxRank,g=t.rank>0,h=Ht(t.skill.label);return e.jsxs(N,{sx:{display:"grid",gridTemplateColumns:"1fr auto auto auto",gap:1,alignItems:"center",border:"1px solid",borderColor:"divider",borderRadius:2,px:1.25,py:1},children:[e.jsxs(N,{sx:{minWidth:0},children:[e.jsxs(N,{sx:{display:"flex",alignItems:"center",gap:.5,minWidth:0},children:[e.jsx(D,{fontWeight:600,noWrap:!0,children:t.skill.label}),h?e.jsx(ue,{title:h,children:e.jsx(ut,{fontSize:"small",sx:{opacity:.7,flexShrink:0}})}):null]}),e.jsx(D,{variant:"caption",sx:{opacity:.7},noWrap:!0,children:t.rightTag??""})]}),e.jsxs(N,{sx:{width:46,textAlign:"center"},children:[e.jsx(D,{variant:"caption",sx:{opacity:.7,lineHeight:1},children:"Mod"}),e.jsx(D,{sx:{fontWeight:700,lineHeight:1.2},children:t.modifier>=0?`+${t.modifier}`:`${t.modifier}`})]}),e.jsxs(N,{sx:{width:40,textAlign:"center"},children:[e.jsx(D,{variant:"caption",sx:{opacity:.7,lineHeight:1},children:"Rank"}),e.jsx(D,{sx:{fontWeight:700,lineHeight:1.2},children:t.rank})]}),e.jsxs(N,{sx:{display:"flex",gap:.5,alignItems:"center",justifyContent:"flex-end"},children:[e.jsx(ie,{size:"small",onClick:()=>t.onRank(t.rank-1),"aria-label":"Decrease rank",disabled:!g,children:e.jsx(mt,{fontSize:"small"})}),e.jsx(ie,{size:"small",onClick:()=>t.onRank(t.rank+1),"aria-label":"Increase rank",disabled:!n,children:e.jsx(ve,{fontSize:"small"})}),e.jsx(N,{sx:{width:6}}),e.jsx(ue,{title:t.canRoll?"Roll with Dice+":"Dice+ not detected",children:e.jsx("span",{children:e.jsx(ie,{size:"small",onClick:t.onRoll,"aria-label":`Roll ${t.skill.label}`,disabled:!t.canRoll,children:e.jsx(Ie,{fontSize:"small"})})})})]})]})}function Zt(t){return t.reduce((n,g)=>{var h;return(n[h=g.attribute]??(n[h]=[])).push(g),n},{})}function xt(t,n,g){const h=Number.isFinite(t)?Math.trunc(t):n;return Math.max(n,Math.min(g,h))}function ea(t){const n=t.sheet.feats??[];function g(){t.onChange([...n,{name:"New Feat",description:"",statusEffects:""}])}function h(x,r){const i=[...n];i[x]={...i[x],...r},vt.safeParse(i[x]),t.onChange(i)}function I(x){const r=[...n];r.splice(x,1),t.onChange(r)}return e.jsxs(L,{spacing:2,children:[e.jsxs(L,{direction:"row",justifyContent:"space-between",alignItems:"center",children:[e.jsx(D,{variant:"h6",children:"Feats"}),e.jsx(he,{variant:"contained",startIcon:e.jsx(ve,{}),onClick:g,children:"Add Feat"})]}),n.length===0?e.jsx(D,{variant:"body2",sx:{opacity:.75},children:"No feats yet."}):e.jsx(L,{spacing:2,children:n.map((x,r)=>e.jsx(Et,{sx:{p:2},children:e.jsxs(L,{spacing:1.5,children:[e.jsxs(L,{direction:"row",spacing:1,alignItems:"center",children:[e.jsx(b,{label:"Feat Name",fullWidth:!0,value:x.name,onChange:i=>h(r,{name:i.target.value})}),e.jsx(ie,{"aria-label":"Remove feat",onClick:()=>I(r),children:e.jsx(Le,{})})]}),e.jsx(b,{label:"Description",fullWidth:!0,multiline:!0,minRows:4,value:x.description,onChange:i=>h(r,{description:i.target.value})}),e.jsx(b,{label:"Status Effects",fullWidth:!0,helperText:'Comma-separated, e.g. "carrying_capacity+5"',value:x.statusEffects??"",onChange:i=>h(r,{statusEffects:i.target.value})})]})},`${x.name}-${r}`))})]})}const ta=[{id:"pistol",name:"Pistol",skillId:"weapons_light",useDC:7,damage:2,range:"Med",ammo:10,bulk:1,cost:500},{id:"smart_pistol",name:"SMART Pistol",skillId:"weapons_light",useDC:9,damage:4,range:"Med",ammo:6,bulk:1,cost:900,keywords:["Smart-Linked"]},{id:"toxic_spike",name:"Toxic Spike",skillId:"weapons_light",useDC:10,damage:3,range:"Near",ammo:1,bulk:1,cost:750,keywords:["Toxin (Prax)","Concealable"]},{id:"smg",name:"SMG",skillId:"weapons_medium",useDC:6,damage:3,range:"Med",ammo:8,bulk:2,cost:600,keywords:["Bullet Spray"]},{id:"photon_rifle",name:"Photon Rifle",skillId:"weapons_medium",useDC:8,damage:6,range:"Long",ammo:6,bulk:3,cost:5e3,keywords:["Two-Handed"]},{id:"rifle",name:"Rifle",skillId:"weapons_medium",useDC:8,damage:4,range:"Long",ammo:8,bulk:2,cost:1e3,keywords:["Two-Handed","Piercing 1"]},{id:"shotgun",name:"Shotgun",skillId:"weapons_medium",useDC:8,damage:4,range:"Near",ammo:4,bulk:3,cost:800,req:"PHYS 1",keywords:["Point Blank","Shredding 1"]},{id:"gauss_cannon",name:"Gauss Cannon",skillId:"weapons_heavy",useDC:7,damage:4,range:"Med",ammo:20,bulk:4,cost:900,req:"PHYS 3",keywords:["Bullet Spray"]},{id:"grenade_launcher",name:"Grenade Launcher",skillId:"weapons_heavy",useDC:8,damage:3,range:"Med",ammo:1,bulk:3,cost:2e3,req:"PHYS 2",keywords:["Area (Very Near)","Two-Handed","Slow Load","Grenade"]},{id:"magneton_cannon",name:"Magneton Cannon",skillId:"weapons_exotic",useDC:5,damage:2,range:"Near",ammo:5,bulk:2,cost:8e3,req:"PHYS 1",keywords:["Area (melee)","Slow Load","Shredding 3"]},{id:"tesla_rifle",name:"Tesla Rifle",skillId:"weapons_exotic",useDC:8,damage:5,range:"Med",ammo:6,bulk:2,cost:6e3,keywords:["Two-Handed","Stun 2"]},{id:"stun_baton",name:"Stun Baton",skillId:"melee_weapons",useDC:6,damage:0,range:"Melee",ammo:0,bulk:1,cost:450,keywords:["Stun 1"]},{id:"switchblade",name:"Switchblade",skillId:"melee_weapons",useDC:9,damage:2,range:"Melee",ammo:0,bulk:1,cost:150,keywords:["Concealable","Thrown"]},{id:"fusion_blade",name:"Fusion Blade",skillId:"melee_weapons",useDC:8,damage:3,range:"Melee",ammo:0,bulk:2,cost:1200,req:"REF 2",keywords:["Piercing 2"]},{id:"rocket_maul",name:"Rocket Maul",skillId:"melee_weapons",useDC:10,damage:6,range:"Melee",ammo:2,bulk:3,cost:2500,req:"PHYS 3",keywords:["Two-Handed"]}],aa={weapons:ta},rt=aa.weapons??[],na=[{id:"scrap_armour",name:"Scrap Armour",protection:1,durability:2,bulk:2,cost:500,special:"Cannot be repaired"},{id:"flak_jacket",name:"Flak Jacket",protection:1,durability:4,bulk:1,cost:1250},{id:"kevlar_clothing",name:"Kevlar Clothing",protection:1,durability:3,bulk:1,cost:1500,special:"Appears to be normal clothing"},{id:"streetweave_jacket",name:"Streetweave Jacket",protection:1,durability:5,bulk:1,cost:2500,special:"+1 to Stealth"},{id:"milsec_bodyplate",name:"MilSec Bodyplate",protection:2,durability:6,bulk:2,cost:5e3},{id:"breaching_plate",name:"Breaching plate",protection:2,durability:4,bulk:3,cost:8500,req:"PHYS 2",special:"Frontal Shielding 1"},{id:"heavy_bodyplate",name:"Heavy Bodyplate",protection:3,durability:8,bulk:4,cost:1e4,req:"PHYS 3",special:"+1 penalty die to Stealth"},{id:"basic_power_armour",name:"Basic Power Armour",protection:4,durability:14,bulk:10,cost:4e4,req:"Power Armour 1",special:"Requires Power Armour (DC5) check to activate. Failure: become Immobile; gain +1 penalty die to all PHYS and REF based checks. When activated, reduces its own bulk to 1 and grants +1 bonus die to all PHYS based checks."}],sa={armor:na},lt=sa.armor??[];function ia(t){return t>=9?4:t>=7?3:t>=4?2:0}function ra(t){const n=Math.trunc(t.total??0),g=Math.trunc(t.useDC??0),h=Math.trunc(t.weaponDamage??0),I=t.label||"Attack",x=n-g,r=n>=g,i=r?ia(x):0,j=r&&i>0,_=r?h+i:0,X=j?1:0;let k;return r?j?k=`Extreme success - crit! ${I} rolled ${n} vs DC ${g}. Damage: ${h}+${i}=${_}. (+1 Stress)`:k=`Hit. ${I} rolled ${n} vs DC ${g}. Damage: ${h}.`:k=`Miss. ${I} rolled ${n} vs DC ${g}.`,{total:n,useDC:g,margin:x,hit:r,isCrit:j,critExtra:i,baseDamage:h,totalDamage:_,stressDelta:X,message:k}}function la(t){var K,w;const n=Number.isFinite(t.incomingDamage)?Math.max(0,Math.trunc(t.incomingDamage)):0;if(n<=0&&!(t.stressDelta&&t.stressDelta>0))return{wounds:t.wounds??{light:0,moderate:0,heavy:0},armour:t.armour,stress:t.stress??{current:0,cuf:0,cufLoss:0},stressDelta:0};const g=!!t.unmitigated,h=t.armour,I=(((K=h==null?void 0:h.durability)==null?void 0:K.current)??0)<=0,x=g||I?0:(h==null?void 0:h.protection)??0,r=Math.max(0,n-x),i=t.wounds??{light:0,moderate:0,heavy:0};let j=i.light??0,_=i.moderate??0,X=i.heavy??0,k=r,$=0,se=0,re=0;const Z=Math.min(k,Math.max(0,4-j));j+=Z,k-=Z,$=Z;const a=Math.min(k,Math.max(0,2-_));_+=a,k-=a,se=a;const A=Math.min(k,Math.max(0,1-X));X+=A,k-=A,re=A;const v={light:j,moderate:_,heavy:X};let T=0;re>0?T=4:se>0?T=2:$>0&&(T=1),t.stressDelta&&t.stressDelta>0&&(T+=Math.trunc(t.stressDelta));let f=h;!g&&!I&&r>0&&(h!=null&&h.durability)&&(f={...h,durability:{...h.durability,current:Math.max(0,Math.trunc((h.durability.current??0)-1))}});const z=Math.max(0,Math.trunc((((w=t.stress)==null?void 0:w.current)??0)+T));return{wounds:v,armour:f,stress:{...t.stress??{current:0,cuf:0,cufLoss:0},current:z},stressDelta:T}}const Ke="whisperspace.obr.sheet/combat-log";async function oa(t){const n=Number.isFinite(t.useDC)?Math.trunc(t.useDC):Math.trunc(t.weapon.useDC),g=t.weapon.name||"Attack",h=We({netDice:t.netDice,modifier:t.modifier,label:g}),I=await Je({diceNotation:h,rollTarget:t.rollTarget??"everyone",showResults:t.showResults??!0}),x=ra({total:I,useDC:n,weaponDamage:Math.trunc(t.weapon.damage??0),label:g});let r=x.message;t.prefix&&(r=`${t.prefix} ${r}`);const i={text:r,ts:Date.now(),kind:"attack",attackerName:t.attackerName,weaponName:g,outcome:{total:x.total,useDC:x.useDC,hit:x.hit,isCrit:x.isCrit,baseDamage:x.baseDamage,totalDamage:x.totalDamage,stressDelta:x.stressDelta}};return U.broadcast.sendMessage(Ke,i,{destination:"ALL"}),{...x,message:r}}const yt=oa;function bt(t){const n=la({incomingDamage:t.incomingDamage,stressDelta:t.stressDelta,unmitigated:t.unmitigated,armour:t.sheet.armor,wounds:t.sheet.wounds,stress:t.sheet.stress});return{sheet:{...t.sheet,wounds:n.wounds,armor:n.armour,stress:n.stress},stressDelta:n.stressDelta}}function pe(t){var h;if(!t)return 0;const n=(h=t.keywordParams)==null?void 0:h.ammoMax,g=typeof n=="number"?n:typeof n=="string"?Number(n):void 0;return Number.isFinite(g)?Number(g):0}function ca(t){const n="#e55353",g="#8b5cf6",h="#5b6bff",I="#26a269",x="#d64040";return e.jsxs(N,{sx:{border:"1px solid",borderColor:"divider",borderRadius:2,p:1.25},children:[e.jsx(D,{variant:"subtitle2",sx:{opacity:.8,mb:.5},children:"Combat Log"}),t.entries.length===0?e.jsx(D,{variant:"body2",sx:{opacity:.7},children:"No recent rolls."}):e.jsx(L,{spacing:.75,children:t.entries.map(r=>{var Z,m,a,s,A;const i=!!((Z=r.outcome)!=null&&Z.hit)&&((((m=r.outcome)==null?void 0:m.totalDamage)??0)>0||(((a=r.outcome)==null?void 0:a.stressDelta)??0)>0)&&!!t.onApply,j=i&&(((s=r.outcome)==null?void 0:s.totalDamage)??0)>0,_=i&&(((A=r.outcome)==null?void 0:A.stressDelta)??0)>0,X=j&&_,k=r.outcome,$=k!=null&&k.hit?"Hit":"Miss",se=k!=null&&k.hit?I:x,re=r.attackerName??"Unknown",oe=r.weaponName??"Attack";return e.jsxs(N,{sx:{display:"flex",alignItems:"center",gap:1,flexWrap:"wrap"},children:[e.jsx(D,{variant:"body2",sx:{flex:"1 1 260px"},children:r.kind==="effect"?e.jsxs(e.Fragment,{children:[e.jsx("strong",{children:r.targetName??"Target"})," ",(r.damageApplied??0)>0&&e.jsxs(e.Fragment,{children:["took"," ",e.jsx("strong",{style:{color:n},children:r.damageApplied})," ","damage"]}),(r.damageApplied??0)>0&&(r.stressApplied??0)>0&&" and ",(r.damageApplied??0)<=0&&(r.stressApplied??0)>0&&"took ",(r.stressApplied??0)>0&&e.jsxs(e.Fragment,{children:[e.jsx("strong",{style:{color:g},children:r.stressApplied})," ","stress"]}),"."]}):e.jsxs(e.Fragment,{children:[e.jsx("strong",{children:re}),": ",e.jsx("strong",{children:oe})," rolled"," ",(k==null?void 0:k.total)??0," vs DC ",(k==null?void 0:k.useDC)??0,"."," ",k!=null&&k.isCrit?e.jsxs(e.Fragment,{children:[e.jsx("strong",{style:{color:I},children:"Extreme success - "}),e.jsx("strong",{style:{color:h},children:"crit!"})]}):e.jsx("strong",{style:{color:se},children:$}),(k==null?void 0:k.hit)&&e.jsxs(e.Fragment,{children:[". Damage:"," ",e.jsx("strong",{style:{color:n},children:(k==null?void 0:k.totalDamage)??0}),k!=null&&k.stressDelta?e.jsxs(e.Fragment,{children:[" "," (+"," ",e.jsx("strong",{style:{color:g},children:k.stressDelta})," ","Stress)"]}):null]}),"."]})}),j&&e.jsx(he,{size:"small",variant:"outlined",startIcon:e.jsx(nt,{fontSize:"small"}),onClick:()=>{var v,T;return(T=t.onApply)==null?void 0:T.call(t,{...r,kind:"attack",damageApplied:((v=r.outcome)==null?void 0:v.totalDamage)??0,stressApplied:0})},children:"Apply Damage"}),_&&e.jsx(he,{size:"small",variant:"outlined",startIcon:e.jsx(Pt,{fontSize:"small"}),onClick:()=>{var v,T;return(T=t.onApply)==null?void 0:T.call(t,{...r,kind:"attack",damageApplied:0,stressApplied:((v=r.outcome)==null?void 0:v.stressDelta)??0})},children:"Apply Stress"}),X&&e.jsx(he,{size:"small",variant:"outlined",startIcon:e.jsx(nt,{fontSize:"small"}),onClick:()=>{var v,T,f;return(f=t.onApply)==null?void 0:f.call(t,{...r,kind:"attack",damageApplied:((v=r.outcome)==null?void 0:v.totalDamage)??0,stressApplied:((T=r.outcome)==null?void 0:T.stressDelta)??0})},children:"Apply Both"})]},r.ts)})})]})}function da(t){var Q,H,c,y,W,G,J,B,fe,ke,Be,be;const n=t.sheet,[g,h]=C.useState(0),[I,x]=C.useState(null),[r,i]=C.useState(""),[j,_]=C.useState(!1),X=(t.combatLog??[]).slice(-3).reverse(),k=C.useMemo(()=>Ve(le.learned),[]),$=C.useMemo(()=>{const o=Object.values(le.learned).flat();return[...le.inherent,...o]},[]),se=new Set(["melee_weapons","melee_unarmed","weapons_light","weapons_medium","weapons_heavy","weapons_exotic","explosives"]),re=$.filter(o=>se.has(o.id));C.useMemo(()=>[...$].sort((o,d)=>o.label.localeCompare(d.label)),[$]);function oe(){var V;const o=Number(r),d=Number.isFinite(o)?Math.max(0,Math.trunc(o)):0;if(d<=0)return;const p=bt({sheet:t.sheet,incomingDamage:d,unmitigated:j});t.onChange({wounds:p.sheet.wounds,armor:p.sheet.armor,stress:p.sheet.stress}),p.stressDelta>0&&t.onApplyStress&&t.onApplyStress(((V=p.sheet.stress)==null?void 0:V.current)??0),i("")}function Z(o){return gt({learnedInfoById:k,skillId:o,ranks:n.skills??{},learningFocus:n.learningFocus,skillMods:t.skillMods})}function m(o,d){const p=[...n.weapons??[]],V=p[o];if(d.ammo!==void 0&&!pe(V)&&d.ammo>0){const Re={...V.keywordParams??{},ammoMax:d.ammo};p[o]={...V,...d,keywordParams:Re},t.onChange({weapons:p});return}p[o]={...V,...d},t.onChange({weapons:p})}function a(o,d){if(o===null||o===d)return;const p=t.sheet.weapons??[];if(o<0||o>=p.length||d<0||d>=p.length)return;const V=[...p],[ge]=V.splice(o,1);V.splice(d,0,ge),t.onChange({weapons:V}),x(d)}function s(o){const d=rt.find(V=>V.id===o);if(!d)return;const p=[...n.weapons??[]];p.push({name:d.name,skillId:d.skillId,useDC:d.useDC,damage:d.damage,range:d.range,ammo:d.ammo,bulk:d.bulk,req:d.req,cost:d.cost,keywords:[...d.keywords??[]],keywordParams:{ammoMax:d.ammo??0,...d.keywordParams??{}}}),t.onChange({weapons:p})}function A(){const o=[...n.weapons??[]];o.push({name:"New Weapon",skillId:"weapons_medium",useDC:8,damage:3,range:"Med",ammo:0,bulk:1,req:"",cost:0,keywords:[],keywordParams:{ammoMax:0}}),t.onChange({weapons:o})}function v(o){const d=[...n.weapons??[]];d.splice(o,1),t.onChange({weapons:d})}async function T(o,d){const p=pe(d),V=Number.isFinite(d.ammo)?Number(d.ammo):0;if(p>0&&V<=0){U.notification.show("Out of ammo. Reload first.","WARNING");return}const ge=Z(d.skillId);await yt({weapon:d,useDC:Number.isFinite(d.useDC)?Number(d.useDC):0,netDice:g,modifier:ge,attackerName:t.sheet.name,rollTarget:"everyone",showResults:!0}),p>0&&m(o,{ammo:Math.max(0,V-1)})}const[f,z]=C.useState(""),[K,w]=C.useState("");function q(o){const d=lt.find(p=>p.id===o);d&&t.onChange({armor:{name:d.name,keywords:[...d.keywords??[]],keywordParams:{...d.keywordParams??{}},protection:d.protection,durability:{current:d.durability,max:d.durability},bulk:d.bulk,req:d.req,cost:d.cost,special:d.special}})}return e.jsxs(L,{spacing:2,children:[e.jsx(N,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",gap:2,flexWrap:"wrap"},children:e.jsx(D,{variant:"h6",sx:{m:0},children:"Combat"})}),e.jsxs(N,{sx:{display:"flex",alignItems:"center",gap:1,flexWrap:"wrap"},children:[e.jsx(D,{variant:"subtitle2",sx:{opacity:.8},children:"Take Damage:"}),e.jsx(b,{size:"small",type:"number",inputProps:{min:0},value:r,onChange:o=>i(o.target.value),sx:{width:90}}),e.jsx(ee,{size:"small",value:"unmitigated",selected:j,onChange:()=>_(o=>!o),children:"Unmitigated"}),e.jsx(he,{size:"small",variant:"outlined",onClick:oe,children:"Apply"})]}),e.jsxs(N,{sx:{display:"flex",alignItems:"center",gap:1,flexWrap:"wrap"},children:[e.jsx(D,{variant:"subtitle2",sx:{opacity:.8},children:"Attack Roll:"}),e.jsxs(Fe,{size:"small",exclusive:!0,value:g,onChange:(o,d)=>{d!==null&&h(d)},children:[e.jsx(ee,{value:-2,children:"−2"}),e.jsx(ee,{value:-1,children:"−1"}),e.jsx(ee,{value:0,children:"0"}),e.jsx(ee,{value:1,children:"+1"}),e.jsx(ee,{value:2,children:"+2"})]})]}),e.jsx(ca,{entries:X,onApply:t.onApplyCombatLog}),e.jsxs(Me,{defaultExpanded:!0,children:[e.jsx(De,{expandIcon:e.jsx(Ae,{}),children:e.jsx(D,{fontWeight:700,children:"Weapons"})}),e.jsx(Te,{children:e.jsxs(L,{spacing:1.5,children:[e.jsxs(N,{sx:{display:"flex",gap:1,alignItems:"center",flexWrap:"wrap"},children:[e.jsxs(b,{label:"Add prefab weapon",size:"small",select:!0,value:f,onChange:o=>z(o.target.value),sx:{minWidth:240},children:[e.jsx(me,{value:"",children:"— choose —"}),rt.map(o=>e.jsx(me,{value:o.id,children:o.name},o.id))]}),e.jsx(ie,{color:"primary",onClick:()=>s(f),"aria-label":"Add prefab weapon",disabled:!f,children:e.jsx(ve,{})}),e.jsx(N,{sx:{flex:1}}),e.jsx(ie,{color:"primary",onClick:A,"aria-label":"Add custom weapon",children:e.jsx(ve,{})}),e.jsx(D,{variant:"body2",sx:{opacity:.75},children:"Add custom weapon"})]}),(n.weapons??[]).length===0?e.jsx(D,{sx:{opacity:.75},children:"No weapons yet."}):(n.weapons??[]).map((o,d)=>e.jsxs(N,{draggable:!0,onDragStart:()=>x(d),onDragEnd:()=>x(null),onDragOver:p=>{p.preventDefault()},onDrop:p=>{p.preventDefault(),a(I,d)},sx:{border:"1px solid",borderColor:"divider",borderRadius:2,p:1.25,cursor:"grab",opacity:I===d?.85:1,display:"grid",gap:1.25},children:[e.jsxs(N,{sx:{display:"flex",gap:1,alignItems:"center"},children:[e.jsx(b,{label:"Name",size:"small",value:o.name,onChange:p=>m(d,{name:p.target.value}),fullWidth:!0}),e.jsx(ue,{title:"Roll attack with Dice+",children:e.jsx(ie,{onClick:()=>T(d,o),"aria-label":`Roll attack for ${o.name}`,children:e.jsx(Ie,{})})}),e.jsx(ie,{onClick:()=>v(d),"aria-label":"Remove weapon",children:e.jsx(Le,{})})]}),e.jsxs(N,{sx:{display:"grid",gridTemplateColumns:"1fr 1fr 1fr 1fr",gap:1},children:[e.jsx(b,{label:"Skill",size:"small",select:!0,value:o.skillId,onChange:p=>m(d,{skillId:p.target.value}),children:re.map(p=>e.jsx(me,{value:p.id,children:p.label},p.id))}),e.jsx(b,{label:"Use DC",size:"small",type:"number",value:o.useDC,onChange:p=>m(d,{useDC:Number(p.target.value)})}),e.jsx(b,{label:"Damage",size:"small",type:"number",value:o.damage,onChange:p=>m(d,{damage:Number(p.target.value)})}),e.jsx(b,{label:"Range",size:"small",value:o.range??"",onChange:p=>m(d,{range:p.target.value}),placeholder:"Melee / Short / Med / Long"}),e.jsxs(N,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(b,{label:"Ammo",size:"small",type:"number",value:o.ammo??0,onChange:p=>m(d,{ammo:Number(p.target.value)}),sx:{width:110}}),e.jsxs(D,{variant:"body2",sx:{opacity:.8},children:["/ ",pe(o)||0]}),e.jsx(ue,{title:"Reload",children:e.jsx("span",{children:e.jsx(ie,{size:"small",onClick:()=>m(d,{ammo:pe(o)||0}),disabled:(pe(o)||0)<=0,children:e.jsx(ht,{fontSize:"small"})})})})]}),e.jsx(b,{label:"Bulk",size:"small",type:"number",value:o.bulk??0,onChange:p=>m(d,{bulk:Number(p.target.value)})}),e.jsx(b,{label:"Req.",size:"small",value:o.req??"",onChange:p=>m(d,{req:p.target.value}),placeholder:"PHYS 1 / REF 2 / etc"}),e.jsx(b,{label:"Keywords (comma)",size:"small",value:(o.keywords??[]).join(", "),onChange:p=>m(d,{keywords:p.target.value.split(",").map(V=>V.trim()).filter(Boolean)}),placeholder:"Two-Handed, Piercing 1",sx:{gridColumn:"1 / -1"}}),(o.keywords??[]).length>0&&e.jsx(N,{sx:{gridColumn:"1 / -1",display:"flex",flexWrap:"wrap",gap:.5},children:(o.keywords??[]).map((p,V)=>{const ge=Gt(p);return ge?e.jsx(ue,{title:ge.description,children:e.jsx("span",{children:e.jsx(st,{label:p,size:"small",variant:"outlined",component:"a",href:`/rules.html#${ge.anchor}`,target:"_blank",clickable:!0,sx:{textDecoration:"none"}})})},`${p}-${V}`):e.jsx(st,{label:p,size:"small",variant:"outlined"},`${p}-${V}`)})})]})]},o.id??`${o.name}-${d}`))]})})]}),e.jsxs(Me,{defaultExpanded:!0,children:[e.jsx(De,{expandIcon:e.jsx(Ae,{}),children:e.jsx(D,{fontWeight:700,children:"Armor"})}),e.jsx(Te,{children:e.jsxs(L,{spacing:1.5,children:[e.jsxs(N,{sx:{display:"flex",gap:1,alignItems:"center",flexWrap:"wrap"},children:[e.jsxs(b,{label:"Set prefab armor",size:"small",select:!0,value:K,onChange:o=>w(o.target.value),sx:{minWidth:240},children:[e.jsx(me,{value:"",children:"— choose —"}),lt.map(o=>e.jsx(me,{value:o.id,children:o.name},o.id))]}),e.jsx(ie,{color:"primary",onClick:()=>q(K),"aria-label":"Set prefab armor",disabled:!K,children:e.jsx(ve,{})})]}),e.jsxs(N,{sx:{border:"1px solid",borderColor:"divider",borderRadius:2,p:1.25},children:[e.jsxs(N,{sx:{display:"grid",gridTemplateColumns:"2fr 1fr 1fr 1fr",gap:1},children:[e.jsx(b,{label:"Name",size:"small",value:((Q=n.armor)==null?void 0:Q.name)??"",onChange:o=>t.onChange({armor:{...n.armor??{durability:{current:0,max:0},protection:0,keywords:[],keywordParams:{ammoMax:0}},name:o.target.value}})}),e.jsx(b,{label:"Protection",size:"small",type:"number",value:((H=n.armor)==null?void 0:H.protection)??0,onChange:o=>t.onChange({armor:{...n.armor??{name:"",durability:{current:0,max:0},keywords:[],keywordParams:{}},protection:Number(o.target.value)}})}),e.jsx(b,{label:"Durability (cur)",size:"small",type:"number",value:((c=n.armor)==null?void 0:c.durability.current)??0,onChange:o=>{var d;return t.onChange({armor:{...n.armor??{name:"",durability:{current:0,max:0},protection:0,keywords:[],keywordParams:{}},durability:{...((d=n.armor)==null?void 0:d.durability)??{current:0,max:0},current:Number(o.target.value)}}})}}),e.jsx(b,{label:"Durability (max)",size:"small",type:"number",value:((y=n.armor)==null?void 0:y.durability.max)??0,onChange:o=>{var d;return t.onChange({armor:{...n.armor??{name:"",durability:{current:0,max:0},protection:0,keywords:[],keywordParams:{}},durability:{...((d=n.armor)==null?void 0:d.durability)??{current:0,max:0},max:Number(o.target.value)}}})}})]}),(((G=(W=n.armor)==null?void 0:W.durability)==null?void 0:G.max)??0)>0&&(((B=(J=n.armor)==null?void 0:J.durability)==null?void 0:B.current)??0)<=0&&e.jsx(D,{sx:{mt:1},color:"error",variant:"body2",children:"Broken: armor provides no Protection until repaired."}),e.jsxs(N,{sx:{display:"grid",gridTemplateColumns:"1fr 1fr 1fr 2fr",gap:1,mt:1},children:[e.jsx(b,{label:"Bulk",size:"small",type:"number",value:((fe=n.armor)==null?void 0:fe.bulk)??0,onChange:o=>t.onChange({armor:{...n.armor??{name:"",durability:{current:0,max:0},protection:0,keywords:[],keywordParams:{}},bulk:Number(o.target.value)}})}),e.jsx(b,{label:"Req.",size:"small",value:((ke=n.armor)==null?void 0:ke.req)??"",onChange:o=>t.onChange({armor:{...n.armor??{name:"",durability:{current:0,max:0},protection:0,keywords:[],keywordParams:{}},req:o.target.value}})}),e.jsx(b,{label:"Special",size:"small",value:((Be=n.armor)==null?void 0:Be.special)??"",onChange:o=>t.onChange({armor:{...n.armor??{name:"",durability:{current:0,max:0},protection:0,keywords:[],keywordParams:{}},special:o.target.value}})})]}),e.jsx(N,{sx:{mt:1},children:e.jsx(b,{label:"Keywords (comma)",size:"small",fullWidth:!0,value:(((be=n.armor)==null?void 0:be.keywords)??[]).join(", "),onChange:o=>t.onChange({armor:{...n.armor??{name:"",durability:{current:0,max:0},protection:0,keywords:[],keywordParams:{}},keywords:o.target.value.split(",").map(d=>d.trim()).filter(Boolean)}}),placeholder:"Frontal Shielding 1"})})]})]})})]})]})}const ua=[{name:"Flashbang Grenade",effect:"Applies Stun 1 to everyone within Very Near range, Thrown",uses:"1 use",bulk:1,cost:200},{name:"Frag Grenade",effect:"Deals 2 area (Very Near range) damage (DC8 to Evade half), Thrown",uses:"1 use",bulk:1,cost:250},{name:"EMP Grenade",effect:"Applies EMP 2 to everything within range, Thrown",uses:"1 use",bulk:1,cost:300},{name:"Combat Stim Injector",effect:"Gain +1 action & -1 Stress; take 1 wound after effect ends",uses:"1 use",bulk:1,cost:200},{name:"Basic Medkit",effect:"Right tool for the job: First Aid checks",uses:"3 uses",bulk:1,cost:350},{name:"Multitool",effect:"Allows engineering checks to repair, bypass, scrap, etc.",uses:"Permanent",bulk:1,cost:750},{name:"Repair Kit",effect:"Provides materials and tools for repairs",uses:"10 uses",bulk:1,cost:500},{name:"Tracker",effect:"While within 10km, always know location of this device",uses:"1 use",bulk:1,cost:250},{name:"Portable Scanner",effect:"Right tool for the job: Observe (tech, lifeforms)",uses:"Permanent",bulk:1,cost:400},{name:"Weapon Scope",effect:"Simple Modification. Grants +1 bonus die to called shots at medium range and farther; inflicts +1 penalty die to attacks at Near range or nearer",uses:"Permanent",bulk:1,cost:750},{name:"Weapon Silencer",effect:"Simple Modification. Weapon makes reduced sound when fired; deals -1 damage",uses:"Permanent",bulk:1,cost:500},{name:"Compact Backpack",effect:"+5 Inventory Slots when worn",uses:"Permanent",bulk:0,cost:150},{name:"Ammo (Flechette)",effect:"Deals +2 damage to unarmoured targets.",uses:"10 rounds",bulk:1,cost:500},{name:"Ammo (SMART)",effect:"Required for Smart-Linked weapons.",uses:"10",bulk:1,cost:1250},{name:"Ammo (Armour Piercing)",effect:"Adds Piercing 1 to attacks.",uses:"10",bulk:1,cost:750},{name:"Ammo (Explosive)",effect:"Adds Shredding 1 to attacks.",uses:"10",bulk:1,cost:750}],ma={items:ua},ha=ma.items,fa=[{name:"Reflex Booster",tier:1,effect:"Once per round, gain +1 bonus die to an Evade check.",installationDifficulty:2,requirements:"REF 1",physicalImpact:"Low; spine",bulk:1,cost:4e3},{name:"Targeting Link",tier:1,effect:"Once per round, ignore 1 level of cover when attacking an enemy you can see.",installationDifficulty:2,requirements:"-",physicalImpact:"Medium; eyes",bulk:1,cost:6e3},{name:"Low-Light Optics",tier:1,effect:"Ignore penalty dice caused by darkness within medium range.",installationDifficulty:1,requirements:"-",physicalImpact:"Medium; eyes",bulk:1,cost:4e3},{name:"EMP Shielding",tier:1,effect:"Ignore the effects of EMP once per day.",installationDifficulty:2,requirements:"MENT 1",physicalImpact:"None; torso",bulk:1,cost:5500},{name:"Metabolic Filter",tier:1,effect:"Gain +1 bonus die on checks to resist toxins or narcotics.",installationDifficulty:1,requirements:"PHYS 1",physicalImpact:"Minor; liver",bulk:1,cost:2e3},{name:"Internal Communicator",tier:1,effect:"Gain the ability to send and receive messages mentally just as if you were using a regular comms device.",installationDifficulty:0,requirements:"-",physicalImpact:"Medium; jaw, ear",bulk:1,cost:2500},{name:"Skull Popper",tier:1,effect:"Highly illegal; when installed, is given a mandate such as “don’t go to the police”. If the host violates this mandate, the Skull Popper explodes, killing the host. The more specific the mandate, the better the implant functions.",installationDifficulty:2,requirements:"-",physicalImpact:"None; brain",bulk:1,cost:12e3},{name:"Databank",tier:2,effect:"You gain an internal information storage device. You may store information upon it (thinking you want to record what you see, for example), and access information from it at will. You may also load external information onto it, though the GM determines how long that takes and how much may be stored on it.",installationDifficulty:2,requirements:"MENT 1",physicalImpact:"Medium; cranium",bulk:1,cost:7500},{name:"Invisible Databank",tier:2,effect:"You gain an internal information storage device. You may store information upon it (thinking you want to record what you see, for example), and access information from it at will. This device cannot be seen or accessed externally without removing it and is shielded to avoid electronic detection.",installationDifficulty:3,requirements:"-",physicalImpact:"None; cranium",bulk:1,cost:15e3},{name:"Neural Accelerator",tier:2,effect:"Once per day, activate to gain 2 additional actions on your turn. At the end of your turn, gain +2 stress.",installationDifficulty:4,requirements:"Ment 2",physicalImpact:"Obvious; spine",bulk:1,cost:1e4},{name:"Reaction Governor Matrix",tier:2,effect:"Gain +1 reaction per round.",installationDifficulty:2,requirements:"REF 2",physicalImpact:"None; brain",bulk:1,cost:8e3},{name:"Threat Awareness Suite",tier:2,effect:"Gain +1 bonus die to Observe or Instinct checks to detect ambushes or imminent danger. Additionally, you may not be Surprised.",installationDifficulty:2,requirements:"-",physicalImpact:"None; brain",bulk:1,cost:5500},{name:"Synthetic Musculature",tier:2,effect:"Gain +1 bonus die on Powerlifting or Athletics checks involving lifting, pushing, or breaking objects. Unarmed attacks deal damage equal to your full PHYS.",installationDifficulty:4,requirements:"PHYS 3",physicalImpact:"Obvious; arms, legs, torso",bulk:1,cost:1e4},{name:"Stability Gyros",tier:2,effect:"Ignore penalty dice from unstable environments (moving vehicles, zero-G, poor footing)",installationDifficulty:2,requirements:"REF 2",physicalImpact:"Minor; ear",bulk:1,cost:6e3},{name:"Adrenal Boost",tier:2,effect:"Activate to ignore stress penalties for 1 round. At the end of this round, take 1 damage.",installationDifficulty:2,requirements:"PHYS 1",physicalImpact:"None; adrenal glands",bulk:1,cost:5e3},{name:"Mantis Claws (retractable)",tier:3,effect:"Your unarmed attacks deal damage equal to your REF and have Piercing 3. Additionally, gain +1 bonus die to climbing related checks.",installationDifficulty:3,requirements:"REF 2 or PHYS 2",physicalImpact:"Obvious; forearms and hands",bulk:1,cost:1e4},{name:"Neuro Regulator",tier:3,effect:"Ignore up to 3 stress per day from up to 3 sources of stress. Make all SOC based rolls with +1 penalty die.",installationDifficulty:3,requirements:"MENT 2",physicalImpact:"None; brain",bulk:1,cost:12e3},{name:"Synthetic Antibodies",tier:3,effect:"Become immune to nanites targeting your body (including positive effects). Does not stop things from being thrown at you with nanites.",installationDifficulty:4,requirements:"PHYS 1 and MENT 1",physicalImpact:"Minor; nervous system",bulk:1,cost:17500},{name:"Bio-Stabilizer",tier:3,effect:`When you would take a Medium or Heavy wound, roll Cybernetics (DC8).- Extreme success: ignore the wound.
- Success: ignore the wound; this cyberware effect cannot be used for 1 day.
- Failure: suffer the wound as normal; this cyberware effect cannot be used for 1 day.
This effect may only trigger once per instance of damage.`,installationDifficulty:4,requirements:"-",physicalImpact:"Medium; chest and back",bulk:1,cost:15e3}],ga={cyberware:fa},xa=ga.cyberware,ya=[{name:"Space Dust",effect:"Grants +1 bonus die to Observe and Piloting checks for 6 hours",uses:5,addictionScore:1,legality:"Legal",bulk:1,cost:500},{name:"Tranquility",effect:"Reduces stress by 1; penalty die to all REF checks for 6 hours.",uses:2,addictionScore:5,legality:"Legal",bulk:1,cost:5e3},{name:"Smoothe",effect:"Reduces stress by 1d4; increases Cool Under Fire by 2 and grants +1 bonus die to all Mental skill checks for 1 hour",uses:1,addictionScore:8,legality:"Illegal",bulk:1,cost:2e4},{name:"Chemical Strength",effect:"+1 bonus die to all PHYS checks for 1 hour; +1 movement bonus for 1 hour. After 1 hour, gain +1 penalty die to all PHYS checks and gain +1 movement penalty until sleep.",uses:1,addictionScore:3,legality:"Illegal",bulk:1,cost:8e3}],ba={narcotics:ya},pa=ba.narcotics;function ka(){return`inv_${Date.now()}_${Math.random().toString(36).slice(2,9)}`}function va(t){const n=t.sheet.inventory??[],g=a=>{t.onChange({inventory:a})},[h,I]=C.useState("item"),[x,r]=C.useState(null),[i,j]=C.useState({}),[_,X]=C.useState(null),[k,$]=C.useState(null),se=C.useMemo(()=>h==="item"?ha.map(a=>({type:"item",...a})):h==="cyberware"?xa.map(a=>({type:"cyberware",...a})):pa.map(a=>({type:"narcotics",...a})),[h]);function re(a){r(a);const s=se.find(A=>A.name===a);if(!s){j({type:h,name:"",quantity:1,bulk:h==="item"?0:1,effect:"",cost:0,statusEffects:""});return}j(h==="item"?{type:"item",name:s.name,quantity:1,uses:s.uses??"",bulk:s.bulk??0,effect:s.effect??"",cost:s.cost??0,statusEffects:s.statusEffects??""}:h==="cyberware"?{type:"cyberware",name:s.name,quantity:1,bulk:s.bulk??1,tier:s.tier??1,installationDifficulty:s.installationDifficulty??0,requirements:s.requirements??"",physicalImpact:s.physicalImpact??"",effect:s.effect??"",cost:s.cost??0,statusEffects:s.statusEffects??""}:{type:"narcotics",name:s.name,quantity:1,bulk:s.bulk??1,uses:s.uses??1,addictionScore:s.addictionScore??0,legality:s.legality??"",effect:s.effect??"",cost:s.cost??0,statusEffects:s.statusEffects??""})}function oe(){const a=[...n,{id:ka(),...i}];t.onChange({inventory:a}),r(null),j({type:h,name:"",quantity:1,bulk:h==="item"?0:1,effect:"",cost:0,statusEffects:""})}function Z(a){t.onChange({inventory:n.filter(s=>s.id!==a)})}function m(a,s){t.onChange({inventory:n.map(A=>A.id===a?{...A,...s}:A)})}return e.jsxs(L,{spacing:2,children:[e.jsx(b,{label:"Credits",type:"number",value:t.sheet.credits??0,onChange:a=>t.onChange({credits:Number(a.target.value)}),size:"small"}),e.jsxs(N,{children:[e.jsx(D,{variant:"subtitle2",sx:{mb:1},children:"Add Inventory"}),e.jsxs(L,{direction:{xs:"column",sm:"row"},spacing:1,alignItems:"center",children:[e.jsxs(b,{select:!0,size:"small",label:"Type",value:h,onChange:a=>{const s=a.target.value;I(s),r(null),j(s==="item"?{type:s,name:"",quantity:1,bulk:0,uses:"",effect:"",cost:0,statusEffects:""}:s==="cyberware"?{type:s,name:"",quantity:1,bulk:1,tier:1,installationDifficulty:0,requirements:"",physicalImpact:"",effect:"",cost:0,statusEffects:""}:{type:s,name:"",quantity:1,bulk:1,uses:1,addictionScore:0,legality:"",effect:"",cost:0,statusEffects:""})},sx:{minWidth:160},children:[e.jsx(me,{value:"item",children:"Item"}),e.jsx(me,{value:"cyberware",children:"Cyberware"}),e.jsx(me,{value:"narcotics",children:"Narcotics"})]}),e.jsx(zt,{size:"small",sx:{flex:1,minWidth:220},options:se.map(a=>a.name),value:x,onChange:(a,s)=>re(s),renderInput:a=>e.jsx(b,{...a,label:"Template (optional)"})}),e.jsx(he,{variant:"contained",startIcon:e.jsx(ve,{}),onClick:oe,disabled:!(i!=null&&i.name),children:"Add"})]}),e.jsx(N,{sx:{mt:1},children:e.jsxs(L,{spacing:1,children:[e.jsxs(L,{direction:{xs:"column",sm:"row"},spacing:1,children:[e.jsx(b,{size:"small",label:"Name",value:(i==null?void 0:i.name)??"",onChange:a=>j(s=>({...s,name:a.target.value})),sx:{flex:1}}),e.jsx(b,{size:"small",type:"number",label:"Bulk",value:(i==null?void 0:i.bulk)??0,onChange:a=>j(s=>({...s,bulk:Number(a.target.value)})),sx:{width:120}}),e.jsx(b,{size:"small",type:"number",label:"Quantity",value:(i==null?void 0:i.quantity)??1,onChange:a=>{const s=Number(a.target.value);Number.isFinite(s)&&j(A=>({...A,quantity:s}))},sx:{width:120}}),e.jsx(b,{size:"small",type:"number",label:"Cost",value:(i==null?void 0:i.cost)??0,onChange:a=>j(s=>({...s,cost:Number(a.target.value)})),sx:{width:140}})]}),h==="item"&&e.jsx(b,{size:"small",label:"Uses",value:(i==null?void 0:i.uses)??"",onChange:a=>j(s=>({...s,uses:a.target.value}))}),h==="cyberware"&&e.jsxs(L,{direction:{xs:"column",sm:"row"},spacing:1,children:[e.jsx(b,{size:"small",type:"number",label:"Tier",value:(i==null?void 0:i.tier)??1,onChange:a=>j(s=>({...s,tier:Number(a.target.value)})),sx:{width:120}}),e.jsx(b,{size:"small",type:"number",label:"Installation Difficulty",value:(i==null?void 0:i.installationDifficulty)??0,onChange:a=>j(s=>({...s,installationDifficulty:Number(a.target.value)})),sx:{width:220}}),e.jsx(b,{size:"small",label:"Requirements",value:(i==null?void 0:i.requirements)??"",onChange:a=>j(s=>({...s,requirements:a.target.value})),sx:{flex:1}})]}),h==="cyberware"&&e.jsx(b,{size:"small",label:"Physical Impact",value:(i==null?void 0:i.physicalImpact)??"",onChange:a=>j(s=>({...s,physicalImpact:a.target.value}))}),h==="narcotics"&&e.jsxs(L,{direction:{xs:"column",sm:"row"},spacing:1,children:[e.jsx(b,{size:"small",type:"number",label:"Uses",value:(i==null?void 0:i.uses)??1,onChange:a=>j(s=>({...s,uses:Number(a.target.value)})),sx:{width:120}}),e.jsx(b,{size:"small",type:"number",label:"Addiction Score",value:(i==null?void 0:i.addictionScore)??0,onChange:a=>j(s=>({...s,addictionScore:Number(a.target.value)})),sx:{width:160}}),e.jsx(b,{size:"small",label:"Legality",value:(i==null?void 0:i.legality)??"",onChange:a=>j(s=>({...s,legality:a.target.value})),sx:{flex:1}})]}),e.jsx(b,{size:"small",label:"Effect",value:(i==null?void 0:i.effect)??"",onChange:a=>j(s=>({...s,effect:a.target.value})),multiline:!0,minRows:2}),e.jsx(b,{size:"small",label:"Status Effects (comma-separated)",value:(i==null?void 0:i.statusEffects)??"",onChange:a=>j(s=>({...s,statusEffects:a.target.value})),placeholder:'e.g. "carrying_capacity+5"'})]})})]}),e.jsxs(N,{children:[e.jsx(D,{variant:"subtitle2",sx:{mb:1},children:"Inventory"}),n.length===0&&e.jsx(D,{variant:"body2",children:"No inventory items yet."}),n.map(a=>{const s=a.quantity??1,v=(a.bulk??0)*s,T=`${a.name} (${a.type}) • bulk ${v}`;return e.jsxs(Me,{disableGutters:!0,children:[e.jsx(De,{expandIcon:e.jsx(Ae,{}),draggable:!0,onDragStart:f=>{X(a.id??null);try{f.dataTransfer.effectAllowed="move",f.dataTransfer.setData("text/plain",a.id??"")}catch{}},onDragOver:f=>{f.preventDefault(),$(a.id??null)},onDragLeave:()=>$(null),onDrop:f=>{f.preventDefault();const z=_??f.dataTransfer.getData("text/plain"),K=a.id;if(z&&K&&z!==K){const w=t.sheet.inventory??[],q=w.findIndex(H=>H.id===z),Q=w.findIndex(H=>H.id===K);if(q>=0&&Q>=0){const H=[...w],[c]=H.splice(q,1);H.splice(Q,0,c),g(H)}}X(null),$(null)},sx:k===a.id?{outline:"2px dashed rgba(255,255,255,0.35)",borderRadius:1}:void 0,children:e.jsxs(L,{direction:"row",spacing:1,alignItems:"center",sx:{width:"100%"},children:[e.jsx(Wt,{fontSize:"small",sx:{opacity:.5}}),e.jsx(D,{variant:"body2",sx:{flex:1},children:T}),e.jsxs(L,{direction:"row",spacing:.5,alignItems:"center",children:[e.jsx(ie,{size:"small",onClick:f=>{f.stopPropagation();const z=(a.quantity??1)-1;z<=0?Z(a.id):m(a.id,{quantity:z})},children:e.jsx(mt,{fontSize:"small"})}),e.jsx(D,{variant:"caption",sx:{minWidth:18,textAlign:"center"},children:a.quantity??1}),e.jsx(ie,{size:"small",onClick:f=>{f.stopPropagation(),m(a.id,{quantity:(a.quantity??1)+1})},children:e.jsx(ve,{fontSize:"small"})})]}),e.jsx(ue,{title:"Remove",children:e.jsx(ie,{size:"small",onClick:f=>(f.stopPropagation(),Z(a.id)),children:e.jsx(Le,{fontSize:"small"})})})]})}),e.jsx(Te,{children:e.jsxs(L,{spacing:1,children:[e.jsxs(L,{direction:{xs:"column",sm:"row"},spacing:1,children:[e.jsx(b,{size:"small",label:"Name",value:a.name??"",onChange:f=>m(a.id,{name:f.target.value}),sx:{flex:1}}),e.jsxs(b,{select:!0,size:"small",label:"Type",value:a.type,onChange:f=>m(a.id,{type:f.target.value}),sx:{width:160},children:[e.jsx(me,{value:"item",children:"Item"}),e.jsx(me,{value:"cyberware",children:"Cyberware"}),e.jsx(me,{value:"narcotics",children:"Narcotics"})]}),e.jsx(b,{size:"small",type:"number",label:"Bulk",value:a.bulk??0,onChange:f=>m(a.id,{bulk:Number(f.target.value)}),sx:{width:120}}),e.jsx(b,{size:"small",type:"number",label:"Quantity",value:a.quantity??1,onChange:f=>{const z=Number(f.target.value);Number.isFinite(z)&&(z<=0?Z(a.id):m(a.id,{quantity:z}))},sx:{width:120}}),e.jsx(b,{size:"small",type:"number",label:"Cost",value:a.cost??0,onChange:f=>m(a.id,{cost:Number(f.target.value)}),sx:{width:140}})]}),a.type==="item"&&e.jsx(b,{size:"small",label:"Uses",value:a.uses??"",onChange:f=>m(a.id,{uses:f.target.value})}),a.type==="cyberware"&&e.jsxs(L,{direction:{xs:"column",sm:"row"},spacing:1,children:[e.jsx(b,{size:"small",type:"number",label:"Tier",value:a.tier??1,onChange:f=>m(a.id,{tier:Number(f.target.value)}),sx:{width:120}}),e.jsx(b,{size:"small",type:"number",label:"Installation Difficulty",value:a.installationDifficulty??0,onChange:f=>m(a.id,{installationDifficulty:Number(f.target.value)}),sx:{width:220}}),e.jsx(b,{size:"small",label:"Requirements",value:a.requirements??"",onChange:f=>m(a.id,{requirements:f.target.value}),sx:{flex:1}})]}),a.type==="cyberware"&&e.jsx(b,{size:"small",label:"Physical Impact",value:a.physicalImpact??"",onChange:f=>m(a.id,{physicalImpact:f.target.value})}),a.type==="narcotics"&&e.jsxs(L,{direction:{xs:"column",sm:"row"},spacing:1,children:[e.jsx(b,{size:"small",type:"number",label:"Uses",value:a.uses??1,onChange:f=>m(a.id,{uses:Number(f.target.value)}),sx:{width:120}}),e.jsx(b,{size:"small",type:"number",label:"Addiction Score",value:a.addictionScore??0,onChange:f=>m(a.id,{addictionScore:Number(f.target.value)}),sx:{width:160}}),e.jsx(b,{size:"small",label:"Legality",value:a.legality??"",onChange:f=>m(a.id,{legality:f.target.value}),sx:{flex:1}})]}),e.jsx(b,{size:"small",label:"Effect",value:a.effect??"",onChange:f=>m(a.id,{effect:f.target.value}),multiline:!0,minRows:2}),e.jsx(b,{size:"small",label:"Status Effects (comma-separated)",value:a.statusEffects??"",onChange:f=>m(a.id,{statusEffects:f.target.value}),placeholder:'e.g. "carrying_capacity+5"'})]})})]},a.id)})]})]})}function ja(){const[t,n]=C.useState({entries:[],activeTokenId:void 0,updatedAt:Date.now()}),[g,h]=C.useState({}),[I,x]=C.useState(""),[r,i]=C.useState(!1),[j,_]=C.useState(0),X=m=>Math.max(-3,Math.min(3,m)),k=C.useMemo(()=>Ve(le.learned),[]);C.useEffect(()=>{const m=jt(a=>n(a));return()=>m==null?void 0:m()},[]),C.useEffect(()=>{let m=!0;return(async()=>{var a,s,A,v;try{const[T,f]=await Promise.all([((s=(a=U.player).getId)==null?void 0:s.call(a))??Promise.resolve(""),((v=(A=U.player).getRole)==null?void 0:v.call(A))??Promise.resolve("")]);if(!m)return;x(String(T??"")),i(String(f).toUpperCase()==="GM")}catch{}})(),()=>{m=!1}},[]);const $=C.useMemo(()=>{const m=[...t.entries??[]];return m.sort((a,s)=>(s.initiative??0)-(a.initiative??0)),m},[t.entries]);C.useEffect(()=>{let m=!0;return(async()=>{var a,s,A,v,T,f,z;try{const K=$.map(Q=>Q.tokenId);if(!K.length){m&&h({});return}const w=await U.scene.items.getItems(K),q={};for(const Q of w){const H=Q.id,c=await Ne(H),y=c==null?void 0:c.armor,W=((a=y==null?void 0:y.durability)==null?void 0:a.current)??0,G=!!y&&W<=0,J=G?0:(y==null?void 0:y.protection)??0,B=(s=c==null?void 0:c.weapons)==null?void 0:s[0],fe=pe(B),ke=Number.isFinite(B==null?void 0:B.ammo)?Number(B==null?void 0:B.ammo):0;q[H]={tokenId:H,name:((T=(v=(A=Q.text)==null?void 0:A.plainText)==null?void 0:v.trim)==null?void 0:T.call(v))||(c==null?void 0:c.name)||"(Unnamed)",thumbUrl:(f=Q.image)==null?void 0:f.url,ownerPlayerId:String(((z=Q.metadata)==null?void 0:z[ct])??""),prot:J,armorBroken:G,topWeaponName:B==null?void 0:B.name,topWeaponUseDC:B==null?void 0:B.useDC,topWeaponDamage:B==null?void 0:B.damage,topWeaponSkillId:B==null?void 0:B.skillId,topWeaponAmmo:ke,topWeaponAmmoMax:fe}}m&&h(q)}catch{}})(),()=>{m=!1}},[$]);async function se(m){var c,y,W,G,J;const[a]=await U.scene.items.getItems([m]);if(!a)return;const s=await Ne(m);if(!s)return;const A=et([...(s.feats??[]).map(B=>B.statusEffects??"").filter(Boolean),...(s.inventory??[]).map(B=>B.statusEffects??"").filter(Boolean)]).deltas,v=Se(s.skills??{},le.inherent??[]),T=((c=s.stress)==null?void 0:c.current)??0,f=Math.max(0,(ze(s.skills??{})||0)-(((y=s.stress)==null?void 0:y.cufLoss)??0)),z=Mt({attributes:v,stress:{current:T,cuf:f}},A),K=z.stress.cuf??f,w=z.attributes.ref??v.ref??0,q=T>K,Q=We({netDice:q?-1:0,modifier:w,label:`${((W=a.text)==null?void 0:W.plainText)??s.name??"Token"} Initiative`}),H=await Je({diceNotation:Q,rollTarget:"everyone",showResults:!0});await Dt({tokenId:m,initiative:H,name:((G=a.text)==null?void 0:G.plainText)??s.name??"Token",thumbUrl:(J=a.image)==null?void 0:J.url})}async function re(){var v,T;const m=await((T=(v=U.player).getSelection)==null?void 0:T.call(v))??[],a=m==null?void 0:m[0],s=await dt()??void 0,A=a||s;if(!A){U.notification.show("Select a token (or set your character) to roll initiative.","WARNING");return}await se(A)}async function oe(m){var c,y,W;const a=await Ne(m);if(!a)return;const s=(c=a.weapons)==null?void 0:c[0];if(!s){U.notification.show("No weapon in the top slot.","WARNING");return}const A=et([...(a.feats??[]).map(G=>G.statusEffects??"").filter(Boolean),...(a.inventory??[]).map(G=>G.statusEffects??"").filter(Boolean)]).deltas,T=(ze(a.skills??{})-(((y=a.stress)==null?void 0:y.cufLoss)??0)||0)+(A.cool_under_fire??0),z=(((W=a.stress)==null?void 0:W.current)??0)>T,K=String(s.skillId??""),w=gt({learnedInfoById:k,skillId:K,ranks:a.skills??{},learningFocus:a.learningFocus,skillMods:A}),q=pe(s),Q=Number.isFinite(s==null?void 0:s.ammo)?Number(s==null?void 0:s.ammo):0;if(q>0&&Q<=0){U.notification.show("Out of ammo. Reload first.","WARNING");return}const H=X(j-(z?1:0));if(await yt({weapon:s,netDice:H,modifier:w,attackerName:a.name,rollTarget:"everyone",showResults:!0}),q>0){const G=Math.max(0,Q-1),J=[...a.weapons??[]];J[0]={...J[0],ammo:G},await Ye(m,{...a,weapons:J})}}async function Z(m){var T;const a=await Ne(m);if(!a)return;const s=(T=a.weapons)==null?void 0:T[0];if(!s)return;const A=pe(s);if(A<=0)return;const v=[...a.weapons??[]];v[0]={...v[0],ammo:A},await Ye(m,{...a,weapons:v})}return e.jsxs(L,{spacing:2,children:[e.jsxs(N,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",gap:1,flexWrap:"wrap"},children:[e.jsx(D,{variant:"h6",sx:{m:0},children:"Initiative"}),e.jsxs(L,{direction:"row",spacing:1,alignItems:"center",children:[e.jsx(he,{size:"small",variant:"contained",onClick:()=>void re(),startIcon:e.jsx(Ie,{}),children:"Roll Initiative"}),e.jsxs(N,{sx:{display:"flex",alignItems:"center",gap:1,flexWrap:"wrap",pl:1},children:[e.jsx(D,{variant:"body2",sx:{opacity:.8},children:"Attack Roll:"}),e.jsxs(Fe,{size:"small",exclusive:!0,value:j,onChange:(m,a)=>{a!==null&&_(a)},children:[e.jsx(ee,{value:-2,children:"−2"}),e.jsx(ee,{value:-1,children:"−1"}),e.jsx(ee,{value:0,children:"0"}),e.jsx(ee,{value:1,children:"+1"}),e.jsx(ee,{value:2,children:"+2"})]})]}),r&&e.jsxs(e.Fragment,{children:[e.jsx(he,{size:"small",variant:"outlined",onClick:()=>wt(),children:"Clear"}),e.jsx(he,{size:"small",variant:"outlined",onClick:()=>Ct(),children:"Advance"})]})]})]}),e.jsx(Ft,{}),$.length===0?e.jsx(D,{variant:"body2",sx:{opacity:.75},children:"No initiative rolls yet."}):e.jsx(Lt,{dense:!0,disablePadding:!0,children:$.map(m=>{const a=g[m.tokenId],s=a==null?void 0:a.ownerPlayerId,A=r||!!s&&s===I,v=t.activeTokenId===m.tokenId,T=v&&A&&!r,f=!!m.surprised,z=(a==null?void 0:a.topWeaponAmmoMax)??0,K=(a==null?void 0:a.topWeaponAmmo)??0,w=z>0&&K<=0;return e.jsxs(Bt,{sx:{borderRadius:1,mb:.5,bgcolor:v?"rgba(255,255,255,0.06)":"transparent",opacity:f?.55:1},secondaryAction:e.jsxs(L,{direction:"row",spacing:.5,alignItems:"center",children:[e.jsx(ue,{title:a!=null&&a.armorBroken?"Armor broken":"Protection",children:e.jsxs(N,{sx:{display:"inline-flex",alignItems:"center",gap:.5,px:1,py:.5,borderRadius:1,bgcolor:"rgba(0,0,0,0.25)"},children:[e.jsx($t,{fontSize:"small",sx:{color:a!=null&&a.armorBroken?"error.main":"inherit"}}),e.jsx(D,{variant:"caption",children:(a==null?void 0:a.prot)??0})]})}),(r||A)&&e.jsx(ue,{title:a!=null&&a.topWeaponName?w?`Out of ammo: ${a.topWeaponName}`:`Attack: ${a.topWeaponName}`:"No top weapon",children:e.jsx("span",{children:e.jsx(ie,{size:"small",disabled:!(a!=null&&a.topWeaponName)||w,onClick:()=>void oe(m.tokenId),children:e.jsx(Ie,{fontSize:"small"})})})}),(r||A)&&e.jsx(ue,{title:a!=null&&a.topWeaponName?z<=0?"No ammo to reload":`Reload: ${a.topWeaponName}`:"No top weapon",children:e.jsx("span",{children:e.jsx(ie,{size:"small",disabled:!(a!=null&&a.topWeaponName)||z<=0,onClick:()=>void Z(m.tokenId),children:e.jsx(ht,{fontSize:"small"})})})}),e.jsx(ue,{title:A||r?"Remove":"Only the owner or GM can remove",children:e.jsx("span",{children:e.jsx(ie,{size:"small",disabled:!A&&!r,onClick:()=>It(m.tokenId),children:e.jsx(Le,{fontSize:"small"})})})})]}),children:[e.jsx(_t,{children:e.jsx(qt,{src:a==null?void 0:a.thumbUrl,variant:"rounded",sx:{width:32,height:32,mr:1,cursor:"pointer"}})}),e.jsx(Ot,{primary:e.jsxs(N,{sx:{display:"flex",alignItems:"center",gap:1,flexWrap:"wrap"},children:[e.jsx(D,{variant:"body2",sx:{fontWeight:600},children:(a==null?void 0:a.name)??m.name??"Token"}),e.jsx(D,{variant:"caption",sx:{opacity:.75},children:m.initiative}),T&&e.jsx(D,{variant:"caption",sx:{px:1,py:.25,borderRadius:1,bgcolor:"rgba(0,128,255,0.2)"},children:"Your Turn"})]}),secondary:e.jsxs(N,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(Ut,{size:"small",checked:f,disabled:!r,onChange:q=>St(m.tokenId,q.target.checked)}),e.jsx(D,{variant:"caption",sx:{opacity:.75},children:"Surprised"})]})})]},m.tokenId)})})]})}function wa(t){return e.jsxs("div",{style:{display:"flex",alignItems:"flex-start",gap:12,justifyContent:"space-between",marginBottom:10},children:[e.jsxs("div",{style:{display:"flex",gap:10,alignItems:"flex-start"},children:[t.thumbUrl?e.jsx("img",{src:t.thumbUrl,alt:"Token thumbnail",style:{width:44,height:44,borderRadius:10,objectFit:"cover",border:"1px solid rgba(0,0,0,0.2)"}}):e.jsx("div",{style:{width:44,height:44,borderRadius:10,border:"1px solid rgba(0,0,0,0.2)",opacity:.4}}),e.jsxs("div",{children:[e.jsxs("div",{style:{fontSize:18,fontWeight:700},children:[t.title," ",e.jsxs("span",{style:{fontSize:12,opacity:.75},children:["(",t.ownerLabel,")"]})]}),e.jsxs("div",{style:{fontSize:12,opacity:.8},children:["Token: ",e.jsx("code",{style:{fontSize:11},children:t.tokenId})]})]})]}),e.jsxs("div",{style:{display:"flex",gap:8},children:[t.showBackButton&&e.jsx("button",{style:{padding:"8px 10px",borderRadius:8,border:"1px solid #999",cursor:"pointer",opacity:.9},onClick:t.onBack,children:"Back to My Sheet"}),t.showUnsetButton&&e.jsx("button",{style:{padding:"8px 10px",borderRadius:8,border:"1px solid #999",cursor:"pointer",opacity:.9},onClick:t.onUnset,children:"Unset “My Character”"})]})]})}function Ca(t){var n,g,h;return e.jsxs("div",{style:ne.statusBar,children:[e.jsxs("div",{style:ne.statusLeft,children:[e.jsxs("div",{style:ne.statusGroup,children:[e.jsx("div",{style:ne.statusLabel,children:"Stress"}),e.jsx("input",{type:"number",min:0,value:((n=t.sheet.stress)==null?void 0:n.current)??0,onChange:I=>t.applyStress(Number(I.target.value)),style:ne.statusNumber})]}),e.jsxs("div",{style:ne.statusGroup,children:[e.jsx("div",{style:ne.statusLabel,children:"Wounds"}),e.jsxs("div",{style:ne.woundsRow,children:[e.jsx("span",{style:ne.woundsKind,children:"L"}),Array.from({length:4}).map((I,x)=>{var r;return e.jsx("input",{type:"checkbox",checked:(((r=t.sheet.wounds)==null?void 0:r.light)??0)>x,onChange:()=>t.toggleWound("light",x)},`wl_${x}`)}),e.jsx("span",{style:{width:8}}),e.jsx("span",{style:ne.woundsKind,children:"M"}),Array.from({length:2}).map((I,x)=>{var r;return e.jsx("input",{type:"checkbox",checked:(((r=t.sheet.wounds)==null?void 0:r.moderate)??0)>x,onChange:()=>t.toggleWound("moderate",x)},`wm_${x}`)}),e.jsx("span",{style:{width:8}}),e.jsx("span",{style:ne.woundsKind,children:"H"}),Array.from({length:1}).map((I,x)=>{var r;return e.jsx("input",{type:"checkbox",checked:(((r=t.sheet.wounds)==null?void 0:r.heavy)??0)>x,onChange:()=>t.toggleWound("heavy",x)},`wh_${x}`)})]})]}),e.jsxs("label",{style:{display:"flex",alignItems:"center",gap:6},children:[e.jsx("input",{type:"checkbox",checked:!!t.sheet.indomitable,onChange:I=>t.setIndomitable(I.target.checked)}),e.jsx("span",{style:{fontSize:12,opacity:.9},children:"Indomitable"})]}),(((g=t.sheet.stress)==null?void 0:g.current)??0)>(((h=t.sheetForView.stress)==null?void 0:h.cuf)??0)&&e.jsx("div",{style:ne.warning,children:"Stress > CUF: make all rolls with +1 Penalty Die"}),e.jsxs("div",{style:{fontSize:12,opacity:.85},children:["Bulk: ",t.totalBulk," / ",t.effectiveCarryingCapacity]}),t.encumbranceLabel&&e.jsx("div",{style:ne.warning,children:t.encumbranceLabel})]}),e.jsxs("div",{style:ne.statusRight,children:[t.crucible&&t.crucible.status==="pending"&&e.jsxs("div",{style:ne.crucibleBox,children:[e.jsx("div",{style:{fontWeight:700},children:"Crucible Test!"}),e.jsxs("div",{style:{fontSize:12,opacity:.85},children:["Incoming stress: ",t.crucible.incoming," • DC ",t.crucible.dc," • Roll CUF (no bonus/penalty dice)"]}),e.jsx("button",{style:ne.buttonSecondary,onClick:()=>t.rollCrucibleTest(t.crucible.incoming),children:"Roll Crucible"})]}),t.crucible&&t.crucible.status==="success"&&e.jsxs("div",{style:ne.crucibleBox,children:[e.jsx("div",{style:{fontWeight:700},children:"Crucible succeeded!"}),e.jsx("div",{style:{fontSize:12,opacity:.85},children:"Choose an Indomitable effect. (Indomitable checked automatically.)"})]}),t.crucible&&t.crucible.status==="fail"&&e.jsxs("div",{style:ne.crucibleBox,children:[e.jsx("div",{style:{fontWeight:700},children:"Crucible failed"}),e.jsx("div",{style:{fontSize:12,opacity:.85},children:"You’ve entered PTSD range (6–8 stress)."}),e.jsx("button",{style:ne.buttonSecondary,onClick:t.burnCufToPass,children:"Spend 1 CUF to pass"})]})]})]})}const ne={statusBar:{display:"flex",alignItems:"flex-start",justifyContent:"space-between",gap:12,padding:"10px 12px",borderRadius:12,border:"1px solid rgba(255,255,255,0.15)",marginBottom:10},statusLeft:{display:"flex",alignItems:"center",gap:16,flexWrap:"wrap"},statusRight:{display:"flex",alignItems:"center",gap:12},statusGroup:{display:"flex",flexDirection:"column",gap:4},statusLabel:{fontSize:11,opacity:.75,letterSpacing:.2},statusNumber:{width:64,fontSize:16},woundsRow:{display:"flex",alignItems:"center",gap:8,flexWrap:"wrap"},woundsKind:{fontSize:11,opacity:.75,width:14,textAlign:"center"},warning:{marginTop:8,fontSize:12,opacity:.9},crucibleBox:{border:"1px solid rgba(255,255,255,0.18)",borderRadius:12,padding:10,maxWidth:240},buttonSecondary:{padding:"6px 10px",borderRadius:8,border:"1px solid #999",cursor:"pointer",opacity:.9,background:"transparent"}};function Sa(t){const n=ft(),g=n.palette.text.primary,h=n.palette.mode==="dark"?"rgba(255,255,255,0.25)":"#777",I=n.palette.mode==="dark"?"rgba(255,255,255,0.12)":"transparent";return e.jsxs("div",{style:{display:"flex",gap:8,alignItems:"center",marginBottom:10},children:[e.jsx(je,{label:"Core",active:t.activeTab==="core",onClick:()=>t.onTab("core"),color:g,borderColor:h,activeBg:I}),e.jsx(je,{label:"Skills",active:t.activeTab==="skills",onClick:()=>t.onTab("skills"),color:g,borderColor:h,activeBg:I}),e.jsx(je,{label:"Combat",active:t.activeTab==="combat",onClick:()=>t.onTab("combat"),color:g,borderColor:h,activeBg:I}),e.jsx(je,{label:"Initiative",active:t.activeTab==="initiative",onClick:()=>t.onTab("initiative"),color:g,borderColor:h,activeBg:I}),e.jsx(je,{label:"Inventory",active:t.activeTab==="inventory",onClick:()=>t.onTab("inventory"),color:g,borderColor:h,activeBg:I}),e.jsx(je,{label:"Feats",active:t.activeTab==="feats",onClick:()=>t.onTab("feats"),color:g,borderColor:h,activeBg:I}),e.jsx("div",{style:{marginLeft:"auto",opacity:.8},children:t.isSaving?"Saving…":"Synced"})]})}function je(t){return ft().palette.mode,e.jsx("button",{onClick:t.onClick,style:{padding:"6px 10px",borderRadius:999,border:`1px solid ${t.borderColor}`,cursor:"pointer",background:t.active?t.activeBg:"transparent",fontWeight:t.active?700:400,color:t.color,outline:"none",boxShadow:"none",appearance:"none"},children:t.label})}function Ia(){var Re,Qe,Xe,Ze;const[t,n]=C.useState({kind:"loading"}),[g,h]=C.useState("core"),[I,x]=C.useState(!1),[r,i]=C.useState(null),[j,_]=C.useState(!1),[X,k]=C.useState([]);async function $(u){var l,M,S,R,P,F;try{const Y=await U.scene.items.getItems([u]),E=Y==null?void 0:Y[0];if(!E)return{ownerLabel:"unowned",thumbUrl:null};const te=((l=E==null?void 0:E.image)==null?void 0:l.url)??((M=E==null?void 0:E.image)==null?void 0:M.href)??(E==null?void 0:E.imageUrl)??(E==null?void 0:E.image)??((S=E==null?void 0:E.thumbnail)==null?void 0:S.url)??null,ae=(R=E==null?void 0:E.metadata)==null?void 0:R[ct];if(typeof ae!="string"||ae.length===0)return{ownerLabel:"unowned",thumbUrl:te,ownerPlayerId:null,isOwnedByMe:!1};const de=await U.player.getId();if(ae===de)return{ownerLabel:"owned by you",thumbUrl:te,ownerPlayerId:ae,isOwnedByMe:!0};try{const O=(await((F=(P=U.party).getPlayers)==null?void 0:F.call(P))??[]).find(ye=>(ye==null?void 0:ye.id)===ae);return{ownerLabel:`owned by ${typeof(O==null?void 0:O.name)=="string"&&O.name.length>0?O.name:ae}`,thumbUrl:te,ownerPlayerId:ae,isOwnedByMe:!1}}catch{return{ownerLabel:`owned by ${ae}`,thumbUrl:te,ownerPlayerId:ae,isOwnedByMe:!1}}}catch{return{ownerLabel:"unowned",thumbUrl:null,ownerPlayerId:null,isOwnedByMe:!1}}}async function se(u){const l=u!=null&&u.ignoreOpenOverride?null:await Tt();if(l)if(await Oe(l)){const ae=await _e(l);if(!ae)throw new Error("Could not load sheet from token.");const de=Se(ae.skills??{},le.inherent??[]),xe={...ae,attributes:de},O=await $(l);n({kind:"ready",tokenId:l,sheet:xe,mode:"view",suppressUnset:!0,...O});return}else await qe(null);let S=await dt();if(S||(S=await tt(),S&&await we(S)),!S){n({kind:"need-token"});return}let R=await Oe(S);if(!R){const te=await tt();te&&(S=te,await we(S),R=await Oe(S))}if(!R){await we(null),n({kind:"need-token"});return}const P=await _e(S);if(!P)throw new Error("Could not load sheet from token.");try{await at(S)}catch{}const F=Se(P.skills??{},le.inherent??[]),Y={...P,attributes:F},E=await $(S);n({kind:"ready",tokenId:S,sheet:Y,mode:"my",suppressUnset:!!(u!=null&&u.suppressUnset),...E})}C.useEffect(()=>{let u=!1;return U.onReady(async()=>{try{const l=await U.player.getRole();u||_(String(l).toUpperCase()==="GM"),await se()}catch(l){u||n({kind:"error",message:l.message??"Unknown error"})}}),()=>{u=!0}},[]),C.useEffect(()=>{let u=null,l=!1;return U.onReady(()=>{l||(u=U.broadcast.onMessage(Ke,M=>{const S=M.data;S!=null&&S.text&&k(R=>[...R,S].slice(-3))}))}),()=>{if(l=!0,typeof u=="function")try{u()}catch{}}},[]),C.useEffect(()=>{let u=null,l=null,M=!1;const S="whisperspace.combatLogLeader",R=2e3,P=6e3,F=`${Date.now()}-${Math.random().toString(36).slice(2,10)}`,Y=()=>{try{const O=localStorage.getItem(S);return O?JSON.parse(O):null}catch{return null}},E=O=>{try{localStorage.setItem(S,JSON.stringify({id:F,ts:O??Date.now()}))}catch{}},te=()=>{const O=Y();return O&&O.id===F},ae=()=>{const O=Date.now(),ce=Y();(!ce||O-(ce.ts??0)>P||ce.id===F)&&E(O)},de=()=>{const O=te();if(O&&!u)u=U.broadcast.onMessage(Ke,ce=>{const ye=ce.data;ye!=null&&ye.text&&U.notification.show(String(ye.text),"INFO")});else if(!O&&u){try{u()}catch{}u=null}},xe=O=>{O.key===S&&de()};return U.onReady(()=>{if(!M){try{window.addEventListener("storage",xe)}catch{}ae(),de(),l=window.setInterval(()=>{M||(ae(),de())},R)}}),()=>{M=!0;try{window.removeEventListener("storage",xe)}catch{}if(l!==null&&clearInterval(l),te())try{localStorage.removeItem(S)}catch{}if(typeof u=="function")try{u()}catch{}}},[]);function re(u,l,M){const S={text:`${u} took ${l} damage${M?` and +${M} stress`:""}.`,ts:Date.now(),kind:"effect",targetName:u,damageApplied:l,stressApplied:M};k(R=>[...R,S].slice(-3))}function oe(u){if(t.kind!=="ready"||t.mode!=="my")return;const l=Math.max(0,Math.trunc(u.damageApplied??0)),M=Math.max(0,Math.trunc(u.stressApplied??0));l<=0&&M<=0||v(S=>{var P;const R=bt({sheet:S,incomingDamage:l,stressDelta:M});return R.stressDelta>0&&f(((P=R.sheet.stress)==null?void 0:P.current)??0),re(t.sheet.name||"Target",l,M),R.sheet})}C.useEffect(()=>{var R,P,F,Y;if(t.kind!=="ready")return;const u=t.tokenId;let l=!1;const M=async()=>{var E,te;try{const ae=await U.scene.items.getItems([u]),de=ae==null?void 0:ae[0],xe=String(((E=de==null?void 0:de.text)==null?void 0:E.plainText)??"").trim(),O=(te=de==null?void 0:de.image)==null?void 0:te.url;if(l||!xe&&!O)return;n(ce=>{if(ce.kind!=="ready"||ce.tokenId!==u)return ce;const ye=xe&&ce.sheet.name!==xe?{...ce.sheet,name:xe}:ce.sheet;return{...ce,sheet:ye,thumbUrl:O??ce.thumbUrl}})}catch{}};M();const S=(Y=(F=(P=(R=U)==null?void 0:R.scene)==null?void 0:P.items)==null?void 0:F.onChange)==null?void 0:Y.call(F,E=>{Array.isArray(E)&&E.some(te=>(te==null?void 0:te.id)===u)&&M()});return()=>{l=!0,typeof S=="function"&&S()}},[t.kind,t.kind==="ready"?t.tokenId:null]);const Z=C.useMemo(()=>t.kind==="ready"&&t.sheet.name||"Whisperspace Character Sheet",[t]);async function m(){const u=await Jt();if(!u){n({kind:"error",message:"No token selected. Select a token on the map first."});return}const l=await _e(u);if(!l){n({kind:"error",message:"Could not attach a sheet to the selected token."});return}const M=Se(l.skills??{},le.inherent??[]),S={...l,attributes:M};await we(u);try{await at(u)}catch{}await qe(null);const R=await $(u);n({kind:"ready",tokenId:u,sheet:S,mode:"my",suppressUnset:!1,...R})}async function a(){await we(null);try{await Rt()}catch{}n({kind:"need-token"})}async function s(){await qe(null),n({kind:"loading"});try{await se({ignoreOpenOverride:!0,suppressUnset:!0})}catch(u){n({kind:"error",message:u.message??"Unknown error"})}}async function A(u,l){x(!0);try{await Ye(u,l)}finally{x(!1)}}function v(u){n(l=>{if(l.kind!=="ready")return l;let M=u(l.sheet);try{const S=Se(M.skills??{},le.inherent??[]);M={...M,attributes:{...M.attributes,...S},stress:{...M.stress??{current:0,cuf:0,cufLoss:0},cuf:ze(M.skills??{})}}}catch{}return A(l.tokenId,M),{...l,sheet:M}})}async function T(u){var Y;if(t.kind!=="ready")return;const l=8+u,M=Math.max(0,Math.trunc(((Y=t.sheet.stress)==null?void 0:Y.cuf)??0)),S=`Crucible Test (DC ${l})`,R=M===0?"":` +${M}`,P=`1d12 # ${S}${R}`;let F;try{F=await Je({diceNotation:P,rollTarget:"everyone",showResults:!0,timeoutMs:6e3})}catch{U.notification.show("Dice+ roll failed or timed out.","WARNING");return}F>=l?(v(E=>({...E,stress:{...E.stress??{current:0,cuf:0,cufLoss:0},current:5},indomitable:!0})),i({incoming:u,dc:l,status:"success",total:F})):i({incoming:u,dc:l,status:"fail",total:F})}function f(u){var S;if(t.kind!=="ready")return;const l=Math.max(0,Math.trunc(((S=t.sheet.stress)==null?void 0:S.current)??0)),M=Math.max(0,Math.trunc(u));if(l<=5&&M>5){const R=M-l;i({incoming:R,dc:8+R,status:"pending"})}else i(null);v(R=>({...R,stress:{...R.stress??{current:0,cuf:0,cufLoss:0},current:M}}))}function z(u,l){var F;if(t.kind!=="ready")return;const S={light:4,moderate:2,heavy:1}[u],R=Math.max(0,Math.trunc(((F=t.sheet.wounds)==null?void 0:F[u])??0)),P=l<R?l:l+1;v(Y=>({...Y,wounds:{...Y.wounds,[u]:Math.min(S,Math.max(0,P))}}))}function K(){var l;if(t.kind!=="ready"||!r||r.status!=="fail")return;const u=Math.max(0,Math.trunc(((l=t.sheet.stress)==null?void 0:l.cufLoss)??0));v(M=>({...M,stress:{...M.stress??{current:0,cuf:0,cufLoss:0},cufLoss:u+1,current:5},indomitable:!0})),i({...r,status:"success"})}const w=t.kind==="ready"?t.sheet:null,q=Ce.useMemo(()=>{if(!w)return{};const u=[];return(w.feats??[]).forEach(l=>{typeof(l==null?void 0:l.statusEffects)=="string"&&l.statusEffects.trim()&&u.push(l.statusEffects)}),(w.inventory??[]).forEach(l=>{typeof(l==null?void 0:l.statusEffects)=="string"&&l.statusEffects.trim()&&u.push(l.statusEffects)}),At(u)},[w]),Q=Ce.useMemo(()=>{const u={},l=new Map,M=R=>{const P=String(R.id),F=String(R.name??R.label??"").toLowerCase().replace(/\s+/g,"_").replace(/[^a-z0-9_\-()]/g,"");P&&(l.set(P.toLowerCase(),P),F&&l.set(F,P))};(le.inherent??[]).forEach(M),Object.values(le.learned??{}).forEach(R=>{(R??[]).forEach(M)});const S=new Set(["phys","ref","soc","ment","carrying_capacity","cool_under_fire","speed","cuf","carry","capacity","spd"]);return Object.entries(q??{}).forEach(([R,P])=>{const F=String(R).toLowerCase();if(S.has(F))return;const Y=l.get(F);Y&&(u[Y]=(u[Y]??0)+(Number.isFinite(P)?P:0))}),u},[q]),H=Math.max(0,(((Re=w==null?void 0:w.attributes)==null?void 0:Re.phys)??0)+(q.phys??0)),c=Math.max(0,(((Qe=w==null?void 0:w.attributes)==null?void 0:Qe.ref)??0)+(q.ref??0)),y=Math.max(0,(((Xe=w==null?void 0:w.attributes)==null?void 0:Xe.soc)??0)+(q.soc??0)),W=Math.max(0,(((Ze=w==null?void 0:w.attributes)==null?void 0:Ze.ment)??0)+(q.ment??0)),J=5+H*5+(q.carrying_capacity??0);30+H*5+(q.speed??0);const fe=w?ze(w.skills??{}):0,ke=Math.max(0,fe+(q.cool_under_fire??0)),be=Ce.useMemo(()=>w?{...w,attributes:{...w.attributes,phys:H,ref:c,soc:y,ment:W},stress:{...w.stress??{current:0,cuf:0,cufLoss:0},cuf:ke}}:null,[w,H,c,y,W,ke])??w,o=Ce.useMemo(()=>{var S;if(!w)return 0;const u=(w.weapons??[]).reduce((R,P)=>R+(P.bulk??0),0),l=((S=w.armor)==null?void 0:S.bulk)??0,M=(w.inventory??[]).reduce((R,P)=>{const F=P.quantity??1,Y=P.bulk??0,E=Number.isFinite(Y)?Y:0,te=Number.isFinite(F)?F:1;return R+E*te},0);return u+l+M},[w]),d=w&&o>J*2?"Heavily Encumbered":w&&o>J?"Encumbered":"";if(t.kind==="loading")return e.jsx("div",{style:{padding:12},children:"Loading…"});if(t.kind==="need-token")return e.jsxs("div",{style:{padding:12},children:[e.jsx("h2",{style:{margin:"0 0 8px 0"},children:"Whisperspace Character Sheet"}),e.jsx("p",{style:{margin:"0 0 10px 0",lineHeight:1.35},children:"Select your character token on the map, then click:"}),e.jsx("button",{style:{padding:"8px 10px",borderRadius:8,border:"1px solid #666",cursor:"pointer"},onClick:m,children:"Set Selected Token as My Character"})]});if(t.kind==="error")return e.jsxs("div",{style:{padding:12},children:[e.jsx("h2",{style:{margin:"0 0 8px 0"},children:"Error"}),e.jsx("p",{style:{margin:"0 0 10px 0",lineHeight:1.35},children:t.message}),e.jsx("button",{style:{padding:"8px 10px",borderRadius:8,border:"1px solid #666",cursor:"pointer"},onClick:()=>n({kind:"need-token"}),children:"Back"})]});const p=t.ownerLabel??(t.mode==="view"?"Viewing token":"My Character"),V=t.mode==="view"&&!t.isOwnedByMe,ge=t.mode==="my"&&!t.suppressUnset;return e.jsxs("div",{style:{padding:12},children:[e.jsx(wa,{title:Z,ownerLabel:p,tokenId:t.tokenId,thumbUrl:t.thumbUrl??null,showBackButton:V,onBack:s,showUnsetButton:ge,onUnset:a}),e.jsxs(e.Fragment,{children:[e.jsx(Ca,{sheet:t.sheet,sheetForView:be,totalBulk:o,effectiveCarryingCapacity:J,encumbranceLabel:d,crucible:r,applyStress:f,toggleWound:z,setIndomitable:u=>v(l=>({...l,indomitable:u})),rollCrucibleTest:T,burnCufToPass:K}),e.jsx(Sa,{activeTab:g,onTab:h,isSaving:I}),e.jsxs("div",{style:{border:"1px solid #888",borderRadius:12,padding:10},children:[g==="core"&&e.jsx(Vt,{sheet:be,onChange:u=>v(l=>({...l,...u}))}),g==="skills"&&e.jsx(Xt,{sheet:be,skillMods:Q,onChange:u=>v(l=>({...l,skills:u})),onMetaChange:u=>v(l=>({...l,...u}))}),g==="combat"&&e.jsx(da,{sheet:be,tokenId:t.tokenId,skillMods:Q,onChange:u=>v(l=>({...l,...u})),onApplyStress:f,combatLog:X,onApplyCombatLog:t.mode==="my"?oe:void 0,isGM:j}),g==="initiative"&&e.jsx(ja,{}),g==="inventory"&&e.jsx(va,{sheet:be,onChange:u=>v(l=>({...l,...u}))}),g==="feats"&&e.jsx(ea,{sheet:be,onChange:u=>v(l=>({...l,feats:u}))})]})]})]})}async function Ma(){await U.onReady(async()=>{}),pt.createRoot(document.getElementById("root")).render(e.jsx(Ce.StrictMode,{children:e.jsx(Yt,{children:e.jsx(Ia,{})})}))}Ma();
