import{r as He,b as Ae,c as ut,s as de,F as mt,a as nt,o as ht,l as Fe,T as st,d as xt,e as ft,f as gt,g as pt,h as it,i as Qe,j as Pe,k as rt,m as we,n as yt,u as bt,p as kt,q as vt,t as _e,v as Le,w as Xe,x as je,y as Ze,D as jt}from"./statusEffects-HMVDEPlA.js";import{r as y,j as e,d as Ce,e as wt}from"./vendor_react-XzhcIodj.js";import{O as $}from"./vendor_obr-BLY5dk8V.js";import{S as z,B as I,T as j,a as Ge,b as ne,c as g,d as ce,I as J,C as Se,R as Ct,A as Ie,e as Me,E as Te,f as Re,g as ge,h as Ee,i as fe,P as St,D as ze,M as he,j as It,k as Mt,l as Tt,m as Rt,L as Dt,n as Pt,o as Et,p as At,q as zt,r as Nt,s as Wt,t as Ft,u as _t,v as Lt}from"./vendor_mui-TXCeMNq_.js";import"./vendor_zod-CxP395f9.js";import"./vendor-CPvQcOsy.js";import"./vendor_emotion-pcfylbOS.js";async function Bt(){const t=await $.player.getSelection();return Array.isArray(t)?t:[]}async function qt(){const t=await Bt();return t.length>0?t[0]:null}async function Be(t){return(await $.scene.items.getItems([t])).length>0}function Ot(t){var p;const r=t.sheet,[v,b]=y.useState(0),T=y.useMemo(()=>r.attributes??{phys:0,ref:0,soc:0,ment:0},[r.attributes]);async function S(d,k){const L=Number(T[d]??0),Y=Ae({netDice:v,modifier:L,label:k});await He({diceNotation:Y,showResults:!0,rollTarget:"everyone"})}return e.jsxs(z,{spacing:2,children:[e.jsxs(I,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",gap:2,flexWrap:"wrap"},children:[e.jsx(j,{variant:"h6",sx:{m:0},children:"Core"}),e.jsxs(I,{sx:{display:"flex",alignItems:"center",gap:1,flexWrap:"wrap"},children:[e.jsx(j,{variant:"subtitle2",sx:{opacity:.8},children:"Attribute Roll:"}),e.jsxs(Ge,{size:"small",exclusive:!0,value:v,onChange:(d,k)=>{k!==null&&b(k)},children:[e.jsx(ne,{value:-2,children:"−2"}),e.jsx(ne,{value:-1,children:"−1"}),e.jsx(ne,{value:0,children:"0"}),e.jsx(ne,{value:1,children:"+1"}),e.jsx(ne,{value:2,children:"+2"})]})]})]}),e.jsx(g,{label:"Name",size:"small",value:r.name??"",onChange:d=>t.onChange({name:d.target.value}),fullWidth:!0}),e.jsxs(I,{sx:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:1},children:[e.jsx(De,{label:"PHYS",value:T.phys,onRoll:()=>S("phys","PHYS Check")}),e.jsx(De,{label:"REF",value:T.ref,onRoll:()=>S("ref","REF Check")}),e.jsx(De,{label:"SOC",value:T.soc,onRoll:()=>S("soc","SOC Check")}),e.jsx(De,{label:"MENT",value:T.ment,onRoll:()=>S("ment","MENT Check")})]}),e.jsxs(I,{sx:{display:"grid",gridTemplateColumns:"repeat(3, 1fr)",gap:2},children:[e.jsx(g,{label:"Cool Under Fire",size:"small",value:((p=t.sheet.stress)==null?void 0:p.cuf)??0,inputProps:{readOnly:!0},fullWidth:!0}),e.jsx(g,{label:"Speed",size:"small",value:30+(T.phys??0)*5,inputProps:{readOnly:!0},fullWidth:!0}),e.jsx(g,{label:"Carrying Capacity",size:"small",value:5+(T.phys??0)*5,inputProps:{readOnly:!0},fullWidth:!0})]}),e.jsx(j,{variant:"body2",sx:{opacity:.75},children:"Attributes are derived automatically from skill ranks (¼ of total ranks under each attribute, rounded up)."})]})}function De(t){return e.jsxs(I,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(g,{label:t.label,size:"small",value:t.value,inputProps:{readOnly:!0},fullWidth:!0}),e.jsx(ce,{title:"Roll with Dice+",children:e.jsx(J,{onClick:t.onRoll,"aria-label":`Roll ${t.label}`,children:e.jsx(Se,{})})})]})}const Ut=["phys","ref","soc","ment"],qe={phys:"PHYSIQUE",ref:"REFLEX",soc:"SOCIAL",ment:"MENTAL"},Oe={combat:"Combat",education:"Education",vehicles:"Vehicles"},et={combat:"Combat Focus",education:"Education Focus",vehicles:"Vehicles Focus"};function Ue(t){const r=lt(t,0,5);return r*(r+1)/2}function $t(t){const[r,v]=y.useState(""),[b,T]=y.useState(0),[S,p]=y.useState(!0),[d,k]=y.useState(!1),[L,Y]=y.useState(""),D=t.sheet.skills??{},ae=t.sheet.learningFocus??"combat",X=Number(t.sheet.skillPoints??0);y.useEffect(()=>{let c=!1;return(async()=>{const h=await ut();c||(p(h),k(!0))})().catch(()=>{c||(p(!1),k(!0))}),()=>{c=!0}},[]);const ie=y.useMemo(()=>{const c=new Map;return Object.keys(de.learned).forEach(h=>{(de.learned[h]??[]).forEach(P=>c.set(P.id,{focus:h}))}),c},[]);function B(c){const h=ie.get(c.id);return h?h.focus===ae?5:2:5}function te(c){var H;const h=D[c.id]??0,P=((H=t.skillMods)==null?void 0:H[c.id])??0;if(h>0)return h+P;const W=ie.get(c.id);return W&&W.focus===ae?0+P:-1+P}const u=y.useMemo(()=>{let c=0;for(const h of Object.values(D))c+=Ue(h??0);return c},[D]),a=Math.max(0,X-u),s=c=>{const h=Math.max(0,Math.trunc(Number(L)));if(!h)return;const P=X+c*h,W=Math.max(u,P);t.onMetaChange({skillPoints:W}),Y("")};function x(c){t.onChange(c)}function M(c,h){const P=D[c.id]??0,W=B(c),H=lt(h,0,W);if(H===P||Ue(H)-Ue(P)>a)return;const ue={...D};H===0?delete ue[c.id]:ue[c.id]=H,x(ue)}async function q(c){const h=Ae({netDice:b,modifier:te(c),label:c.label});try{await He({diceNotation:h,showResults:!0,rollTarget:"everyone"})}catch(P){console.error("Dice+ roll request failed:",P)}}const m=y.useMemo(()=>{const c=Object.values(de.learned).flat();return[...de.inherent,...c]},[]),E=y.useMemo(()=>{const c=r.trim().toLowerCase();return c?m.filter(h=>h.label.toLowerCase().includes(c)||h.id.toLowerCase().includes(c)):m},[m,r]),Z=y.useMemo(()=>Ht(de.inherent),[]),V=y.useMemo(()=>de.learned,[]),re=r.trim().length>0,G=e.jsxs(I,{sx:{display:"flex",alignItems:"center",gap:2,flexWrap:"wrap"},children:[e.jsx(j,{variant:"subtitle2",sx:{opacity:.8},children:"Learning Focus:"}),Object.keys(et).map(c=>e.jsxs(I,{sx:{display:"flex",alignItems:"center",gap:.5,cursor:"pointer"},onClick:()=>t.onMetaChange({learningFocus:c}),children:[e.jsx(Ct,{checked:ae===c,value:c,size:"small"}),e.jsx(j,{variant:"body2",children:Oe[c]})]},c))]}),K=e.jsx(I,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",gap:2,flexWrap:"wrap"},children:e.jsxs(I,{sx:{display:"flex",alignItems:"center",gap:1,flexWrap:"wrap"},children:[e.jsxs(j,{variant:"subtitle2",sx:{minWidth:170},children:["Skill Points: ",a," ",e.jsxs("span",{style:{opacity:.75},children:["(Total: ",X,")"]})]}),e.jsx(ge,{size:"small",variant:"outlined",onClick:()=>s(1),disabled:!Number.isFinite(Number(L))||Math.trunc(Number(L))<=0,children:"+"}),e.jsx(g,{label:"SP",size:"small",type:"number",value:L,onChange:c=>Y(c.target.value),sx:{width:110}}),e.jsx(ge,{size:"small",variant:"outlined",onClick:()=>s(-1),disabled:!Number.isFinite(Number(L))||Math.trunc(Number(L))<=0,children:"-"}),e.jsx(j,{variant:"subtitle2",sx:{opacity:.8},children:"Roll"}),e.jsxs(Ge,{size:"small",exclusive:!0,value:b,onChange:(c,h)=>{h!==null&&T(h)},"aria-label":"Bonus / Penalty dice",children:[e.jsx(ne,{value:-2,children:"−2"}),e.jsx(ne,{value:-1,children:"−1"}),e.jsx(ne,{value:0,children:"0"}),e.jsx(ne,{value:1,children:"+1"}),e.jsx(ne,{value:2,children:"+2"})]}),d&&!S&&e.jsx(j,{variant:"caption",sx:{opacity:.8},children:"(Dice+ not detected)"})]})});return e.jsxs(z,{spacing:2,children:[G,e.jsx(g,{label:"Search skills",value:r,onChange:c=>v(c.target.value),placeholder:"stealth, weapons, navigation…",fullWidth:!0}),K,re?e.jsx(z,{spacing:1,children:E.map(c=>{const h=ie.get(c.id),P=h?Oe[h.focus]:qe[c.attribute];return e.jsx($e,{skill:c,rank:D[c.id]??0,modifier:te(c),maxRank:B(c),onRank:W=>M(c,W),rightTag:P,canRoll:S,onRoll:()=>q(c)},c.id)})}):e.jsxs(e.Fragment,{children:[e.jsx(j,{variant:"subtitle1",children:"Inherent Skills"}),Ut.map(c=>e.jsxs(Ie,{defaultExpanded:!0,children:[e.jsx(Me,{expandIcon:e.jsx(Te,{}),children:e.jsx(j,{fontWeight:700,children:qe[c]})}),e.jsx(Re,{children:e.jsx(z,{spacing:1,children:(Z[c]??[]).map(h=>e.jsx($e,{skill:h,rank:D[h.id]??0,modifier:te(h),maxRank:B(h),onRank:P=>M(h,P),rightTag:qe[h.attribute],canRoll:S,onRoll:()=>q(h)},h.id))})})]},c)),e.jsx(j,{variant:"subtitle1",sx:{mt:1},children:"Learned Skills"}),Object.keys(V).map(c=>e.jsxs(Ie,{defaultExpanded:!0,children:[e.jsx(Me,{expandIcon:e.jsx(Te,{}),children:e.jsx(j,{fontWeight:700,children:et[c]})}),e.jsx(Re,{children:e.jsx(z,{spacing:1,children:(V[c]??[]).map(h=>e.jsx($e,{skill:h,rank:D[h.id]??0,modifier:te(h),maxRank:B(h),onRank:P=>M(h,P),rightTag:Oe[c],canRoll:S,onRoll:()=>q(h)},h.id))})})]},c))]})]})}function $e(t){const r=t.rank<t.maxRank,v=t.rank>0;return e.jsxs(I,{sx:{display:"grid",gridTemplateColumns:"1fr auto auto auto",gap:1,alignItems:"center",border:"1px solid",borderColor:"divider",borderRadius:2,px:1.25,py:1},children:[e.jsxs(I,{sx:{minWidth:0},children:[e.jsx(j,{fontWeight:600,noWrap:!0,children:t.skill.label}),e.jsx(j,{variant:"caption",sx:{opacity:.7},noWrap:!0,children:t.rightTag??""})]}),e.jsxs(I,{sx:{width:46,textAlign:"center"},children:[e.jsx(j,{variant:"caption",sx:{opacity:.7,lineHeight:1},children:"Mod"}),e.jsx(j,{sx:{fontWeight:700,lineHeight:1.2},children:t.modifier>=0?`+${t.modifier}`:`${t.modifier}`})]}),e.jsxs(I,{sx:{width:40,textAlign:"center"},children:[e.jsx(j,{variant:"caption",sx:{opacity:.7,lineHeight:1},children:"Rank"}),e.jsx(j,{sx:{fontWeight:700,lineHeight:1.2},children:t.rank})]}),e.jsxs(I,{sx:{display:"flex",gap:.5,alignItems:"center",justifyContent:"flex-end"},children:[e.jsx(J,{size:"small",onClick:()=>t.onRank(t.rank-1),"aria-label":"Decrease rank",disabled:!v,children:e.jsx(Ee,{fontSize:"small"})}),e.jsx(J,{size:"small",onClick:()=>t.onRank(t.rank+1),"aria-label":"Increase rank",disabled:!r,children:e.jsx(fe,{fontSize:"small"})}),e.jsx(I,{sx:{width:6}}),e.jsx(ce,{title:t.canRoll?"Roll with Dice+":"Dice+ not detected",children:e.jsx("span",{children:e.jsx(J,{size:"small",onClick:t.onRoll,"aria-label":`Roll ${t.skill.label}`,disabled:!t.canRoll,children:e.jsx(Se,{fontSize:"small"})})})})]})]})}function Ht(t){return t.reduce((r,v)=>{var b;return(r[b=v.attribute]??(r[b]=[])).push(v),r},{})}function lt(t,r,v){const b=Number.isFinite(t)?Math.trunc(t):r;return Math.max(r,Math.min(v,b))}function Gt(t){const r=t.sheet.feats??[];function v(){t.onChange([...r,{name:"New Feat",description:"",statusEffects:""}])}function b(S,p){const d=[...r];d[S]={...d[S],...p},mt.safeParse(d[S]),t.onChange(d)}function T(S){const p=[...r];p.splice(S,1),t.onChange(p)}return e.jsxs(z,{spacing:2,children:[e.jsxs(z,{direction:"row",justifyContent:"space-between",alignItems:"center",children:[e.jsx(j,{variant:"h6",children:"Feats"}),e.jsx(ge,{variant:"contained",startIcon:e.jsx(fe,{}),onClick:v,children:"Add Feat"})]}),r.length===0?e.jsx(j,{variant:"body2",sx:{opacity:.75},children:"No feats yet."}):e.jsx(z,{spacing:2,children:r.map((S,p)=>e.jsx(St,{sx:{p:2},children:e.jsxs(z,{spacing:1.5,children:[e.jsxs(z,{direction:"row",spacing:1,alignItems:"center",children:[e.jsx(g,{label:"Feat Name",fullWidth:!0,value:S.name,onChange:d=>b(p,{name:d.target.value})}),e.jsx(J,{"aria-label":"Remove feat",onClick:()=>T(p),children:e.jsx(ze,{})})]}),e.jsx(g,{label:"Description",fullWidth:!0,multiline:!0,minRows:4,value:S.description,onChange:d=>b(p,{description:d.target.value})}),e.jsx(g,{label:"Status Effects",fullWidth:!0,helperText:'Comma-separated, e.g. "carrying_capacity+5"',value:S.statusEffects??"",onChange:d=>b(p,{statusEffects:d.target.value})})]})},`${S.name}-${p}`))})]})}const Yt=[{id:"pistol",name:"Pistol",skillId:"weapons_light",useDC:7,damage:2,range:"Med",ammo:10,bulk:1,cost:500},{id:"smart_pistol",name:"SMART Pistol",skillId:"weapons_light",useDC:9,damage:4,range:"Med",ammo:6,bulk:1,keywords:["Smart-Linked"],cost:900},{id:"toxic_spike",name:"Toxic Spike",skillId:"weapons_light",useDC:10,damage:3,range:"Short",ammo:1,bulk:1,keywords:["Toxin (Prax)","Concealable"],cost:750},{id:"smg",name:"SMG",skillId:"weapons_medium",useDC:6,damage:3,range:"Med",ammo:8,bulk:2,keywords:["Bullet Spray"],cost:600},{id:"photon_rifle",name:"Photon Rifle",skillId:"weapons_medium",useDC:8,damage:6,range:"Long",ammo:6,bulk:3,keywords:["Two-Handed"],cost:5e3},{id:"rifle",name:"Rifle",skillId:"weapons_medium",useDC:8,damage:4,range:"Long",ammo:8,bulk:2,keywords:["Two-Handed","Piercing 1"],cost:1e3},{id:"shotgun",name:"Shotgun",skillId:"weapons_medium",useDC:8,damage:4,range:"Short",ammo:4,bulk:3,req:"PHYS 1",keywords:["Point Blank","Shredding 1"],cost:800},{id:"gauss_cannon",name:"Gauss Cannon",skillId:"weapons_heavy",useDC:7,damage:4,range:"Med",ammo:20,bulk:4,req:"PHYS 3",keywords:["Bullet Spray"],cost:900},{id:"grenade_launcher",name:"Grenade Launcher",skillId:"weapons_heavy",useDC:8,damage:3,range:"Med",ammo:1,bulk:3,req:"PHYS 2",keywords:["Area (near)","Two-Handed","Slow Load","Grenade"],cost:2e3},{id:"magneton_cannon",name:"Magneton Cannon",skillId:"weapons_exotic",useDC:5,damage:2,range:"Short",ammo:5,bulk:2,req:"PHYS 1",keywords:["Area (melee)","Slow Load","Shredding 3"],cost:8e3},{id:"tesla_rifle",name:"Tesla Rifle",skillId:"weapons_exotic",useDC:8,damage:5,range:"Med",ammo:6,bulk:2,keywords:["Two-Handed","Stun 2"],cost:6e3},{id:"stun_baton",name:"Stun Baton",skillId:"melee_weapons",useDC:6,damage:0,range:"Melee",bulk:1,keywords:["Stun 1"],cost:450},{id:"switchblade",name:"Switchblade",skillId:"melee_weapons",useDC:9,damage:2,range:"Melee",bulk:1,keywords:["Concealable","Thrown"],cost:150},{id:"fusion_blade",name:"Fusion Blade",skillId:"melee_weapons",useDC:8,damage:3,range:"Melee",bulk:2,req:"REF 2",keywords:["Piercing 2"],cost:1200},{id:"rocket_maul",name:"Rocket Maul",skillId:"melee_weapons",useDC:10,damage:6,range:"Melee",ammo:2,bulk:3,req:"PHYS 3",keywords:["Two-Handed"],cost:2500}],Kt={weapons:Yt},tt=Kt.weapons??[],Jt=[{id:"scrap_armour",name:"Scrap Armour",protection:1,durability:2,bulk:2,special:"Cannot be repaired",cost:500},{id:"flak_jacket",name:"Flak Jacket",protection:1,durability:4,bulk:1,cost:1250},{id:"kevlar_clothing",name:"Kevlar Clothing",protection:1,durability:3,bulk:1,special:"Appears to be normal clothing",cost:1500},{id:"streetweave_jacket",name:"Streetweave Jacket",protection:1,durability:5,bulk:1,special:"+1 to Stealth",cost:2500},{id:"milsec_bodyplate",name:"MilSec Bodyplate",protection:2,durability:6,bulk:2,cost:5e3},{id:"breaching_plate",name:"Breaching plate",protection:2,durability:4,bulk:3,req:"PHYS 2",special:"Frontal Shielding 1",cost:8500},{id:"heavy_bodyplate",name:"Heavy Bodyplate",protection:3,durability:8,bulk:4,req:"PHYS 3",special:"+1 penalty die to Stealth",cost:1e4},{id:"basic_power_armour",name:"Basic Power Armour",protection:4,durability:14,bulk:10,req:"Power Armour 1",special:`Requires Power Armour (DC5) check to activate. Failure: become Immobile; gain +1 penalty die to all PHYS and REF based checks. When activated, reduces its own bulk to 1 and grants +1 bonus die to all PHYS based checks.
`,cost:4e4}],Vt={armor:Jt},at=Vt.armor??[],ot="whisperspace.obr.sheet/combat-log";function Qt(t){return t>=9?4:t>=7?3:t>=4?2:0}async function Xt(t){const r=Number.isFinite(t.useDC)?Math.trunc(t.useDC):Math.trunc(t.weapon.useDC),v=t.weapon.name||"Attack",b=Ae({netDice:t.netDice,modifier:t.modifier,label:v}),T=await nt({diceNotation:b,rollTarget:t.rollTarget??"everyone",showResults:t.showResults??!0}),S=T-r,p=T>=r,d=p?Qt(S):0,k=p&&d>0,L=Math.trunc(t.weapon.damage??0),Y=p?L+d:0;let D;return p?k?D=`Extreme success - crit! ${v} rolled ${T} vs DC ${r}. Damage: ${L}+${d}=${Y}. (+1 Stress)`:D=`Hit. ${v} rolled ${T} vs DC ${r}. Damage: ${L}.`:D=`Miss. ${v} rolled ${T} vs DC ${r}.`,t.prefix&&(D=`${t.prefix} ${D}`),$.broadcast.sendMessage(ot,{text:D,ts:Date.now()},{destination:"ALL"}),{total:T,useDC:r,margin:S,hit:p,isCrit:k,critExtra:d,baseDamage:L,totalDamage:Y,message:D}}const ct=Xt;function Zt(){const t=new Map;return Object.keys(de.learned).forEach(r=>{(de.learned[r]??[]).forEach(v=>t.set(v.id,{focus:r}))}),t}function ea(t){var K,c,h,P,W,H,A,ue,xe,ye,be,ke;const r=t.sheet,[v,b]=y.useState(0),[T,S]=y.useState(null),[p,d]=y.useState(""),[k,L]=y.useState(!1);y.useEffect(()=>{const o=$.broadcast.onMessage(ot,l=>{const n=l.data;n!=null&&n.text&&$.notification.show(String(n.text),"INFO")});return()=>{try{o()}catch{}}},[]);const Y=y.useMemo(()=>Zt(),[]),D=y.useMemo(()=>{const o=Object.values(de.learned).flat();return[...de.inherent,...o]},[]),ae=new Set(["melee_weapons","melee_unarmed","weapons_light","weapons_medium","weapons_heavy","weapons_exotic","explosives"]),X=D.filter(o=>ae.has(o.id));y.useMemo(()=>[...D].sort((o,l)=>o.label.localeCompare(l.label)),[D]);const ie=r.learningFocus??"combat";function B(){var Ke,Je;const o=Number(p),l=Number.isFinite(o)?Math.max(0,Math.trunc(o)):0;if(l<=0)return;const n=t.sheet.armor,i=(((Ke=n==null?void 0:n.durability)==null?void 0:Ke.current)??0)<=0,f=k||i?0:(n==null?void 0:n.protection)??0,R=Math.max(0,l-f),C=t.sheet.wounds??{light:0,moderate:0,heavy:0};let N=C.light??0,F=C.moderate??0,_=C.heavy??0,w=R,O=0,ee=0,se=0;const le=Math.min(w,Math.max(0,4-N));N+=le,w-=le,O=le;const oe=Math.min(w,Math.max(0,2-F));F+=oe,w-=oe,ee=oe;const We=Math.min(w,Math.max(0,1-_));_+=We,w-=We,se=We;const dt={light:N,moderate:F,heavy:_};let ve=0;se>0?ve=4:ee>0?ve=2:O>0&&(ve=1);let Ye=n;if(!k&&!i&&R>0&&(n!=null&&n.durability)&&(Ye={...n,durability:{...n.durability,current:Math.max(0,Math.trunc((n.durability.current??0)-1))}}),t.onChange({wounds:dt,armor:Ye}),ve>0){const Ve=(((Je=t.sheet.stress)==null?void 0:Je.current)??0)+ve;t.onApplyStress?t.onApplyStress(Ve):t.onChange({stress:{...t.sheet.stress,current:Ve}})}d("")}function te(o){var R,C;const l=((R=r.skills)==null?void 0:R[o])??0,n=((C=t.skillMods)==null?void 0:C[o])??0;if(l>0)return l+n;const i=Y.get(o);return(i&&i.focus===ie?0:-1)+n}function u(o){var i;const l=(i=o.keywordParams)==null?void 0:i.ammoMax,n=typeof l=="number"?l:typeof l=="string"?Number(l):void 0;return Number.isFinite(n)?Number(n):0}function a(o,l){const n=[...r.weapons??[]],i=n[o];if(l.ammo!==void 0&&!u(i)&&l.ammo>0){const R={...i.keywordParams??{},ammoMax:l.ammo};n[o]={...i,...l,keywordParams:R},t.onChange({weapons:n});return}n[o]={...i,...l},t.onChange({weapons:n})}function s(o,l){if(o===null||o===l)return;const n=t.sheet.weapons??[];if(o<0||o>=n.length||l<0||l>=n.length)return;const i=[...n],[f]=i.splice(o,1);i.splice(l,0,f),t.onChange({weapons:i}),S(l)}function x(o){const l=tt.find(i=>i.id===o);if(!l)return;const n=[...r.weapons??[]];n.push({name:l.name,skillId:l.skillId,useDC:l.useDC,damage:l.damage,range:l.range,ammo:l.ammo,bulk:l.bulk,req:l.req,cost:l.cost,keywords:[...l.keywords??[]],keywordParams:{ammoMax:l.ammo??0,...l.keywordParams??{}}}),t.onChange({weapons:n})}function M(){const o=[...r.weapons??[]];o.push({name:"New Weapon",skillId:"weapons_medium",useDC:8,damage:3,range:"Med",ammo:0,bulk:1,req:"",cost:0,keywords:[],keywordParams:{ammoMax:0}}),t.onChange({weapons:o})}function q(o){const l=[...r.weapons??[]];l.splice(o,1),t.onChange({weapons:l})}async function m(o,l){const n=u(l),i=Number.isFinite(l.ammo)?Number(l.ammo):0;if(n>0&&i<=0){$.notification.show("Out of ammo. Reload first.","WARNING");return}const f=te(l.skillId);await ct({weapon:l,useDC:Number.isFinite(l.useDC)?Number(l.useDC):0,netDice:v,modifier:f,rollTarget:"everyone",showResults:!0}),n>0&&a(o,{ammo:Math.max(0,i-1)})}const[E,Z]=y.useState(""),[V,re]=y.useState("");function G(o){const l=at.find(n=>n.id===o);l&&t.onChange({armor:{name:l.name,keywords:[...l.keywords??[]],keywordParams:{...l.keywordParams??{}},protection:l.protection,durability:{current:l.durability,max:l.durability},bulk:l.bulk,req:l.req,cost:l.cost,special:l.special}})}return e.jsxs(z,{spacing:2,children:[e.jsx(I,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",gap:2,flexWrap:"wrap"},children:e.jsx(j,{variant:"h6",sx:{m:0},children:"Combat"})}),e.jsxs(I,{sx:{display:"flex",alignItems:"center",gap:1,flexWrap:"wrap"},children:[e.jsx(j,{variant:"subtitle2",sx:{opacity:.8},children:"Take Damage:"}),e.jsx(g,{size:"small",type:"number",inputProps:{min:0},value:p,onChange:o=>d(o.target.value),sx:{width:90}}),e.jsx(ne,{size:"small",value:"unmitigated",selected:k,onChange:()=>L(o=>!o),children:"Unmitigated"}),e.jsx(ge,{size:"small",variant:"outlined",onClick:B,children:"Apply"})]}),e.jsxs(I,{sx:{display:"flex",alignItems:"center",gap:1,flexWrap:"wrap"},children:[e.jsx(j,{variant:"subtitle2",sx:{opacity:.8},children:"Attack Roll:"}),e.jsxs(Ge,{size:"small",exclusive:!0,value:v,onChange:(o,l)=>{l!==null&&b(l)},children:[e.jsx(ne,{value:-2,children:"−2"}),e.jsx(ne,{value:-1,children:"−1"}),e.jsx(ne,{value:0,children:"0"}),e.jsx(ne,{value:1,children:"+1"}),e.jsx(ne,{value:2,children:"+2"})]})]}),e.jsxs(Ie,{defaultExpanded:!0,children:[e.jsx(Me,{expandIcon:e.jsx(Te,{}),children:e.jsx(j,{fontWeight:700,children:"Weapons"})}),e.jsx(Re,{children:e.jsxs(z,{spacing:1.5,children:[e.jsxs(I,{sx:{display:"flex",gap:1,alignItems:"center",flexWrap:"wrap"},children:[e.jsxs(g,{label:"Add prefab weapon",size:"small",select:!0,value:E,onChange:o=>Z(o.target.value),sx:{minWidth:240},children:[e.jsx(he,{value:"",children:"— choose —"}),tt.map(o=>e.jsx(he,{value:o.id,children:o.name},o.id))]}),e.jsx(J,{color:"primary",onClick:()=>x(E),"aria-label":"Add prefab weapon",disabled:!E,children:e.jsx(fe,{})}),e.jsx(I,{sx:{flex:1}}),e.jsx(J,{color:"primary",onClick:M,"aria-label":"Add custom weapon",children:e.jsx(fe,{})}),e.jsx(j,{variant:"body2",sx:{opacity:.75},children:"Add custom weapon"})]}),(r.weapons??[]).length===0?e.jsx(j,{sx:{opacity:.75},children:"No weapons yet."}):(r.weapons??[]).map((o,l)=>e.jsxs(I,{draggable:!0,onDragStart:()=>S(l),onDragEnd:()=>S(null),onDragOver:n=>{n.preventDefault()},onDrop:n=>{n.preventDefault(),s(T,l)},sx:{border:"1px solid",borderColor:"divider",borderRadius:2,p:1.25,cursor:"grab",opacity:T===l?.85:1,display:"grid",gap:1.25},children:[e.jsxs(I,{sx:{display:"flex",gap:1,alignItems:"center"},children:[e.jsx(g,{label:"Name",size:"small",value:o.name,onChange:n=>a(l,{name:n.target.value}),fullWidth:!0}),e.jsx(ce,{title:"Roll attack with Dice+",children:e.jsx(J,{onClick:()=>m(l,o),"aria-label":`Roll attack for ${o.name}`,children:e.jsx(Se,{})})}),e.jsx(J,{onClick:()=>q(l),"aria-label":"Remove weapon",children:e.jsx(ze,{})})]}),e.jsxs(I,{sx:{display:"grid",gridTemplateColumns:"1fr 1fr 1fr 1fr",gap:1},children:[e.jsx(g,{label:"Skill",size:"small",select:!0,value:o.skillId,onChange:n=>a(l,{skillId:n.target.value}),children:X.map(n=>e.jsx(he,{value:n.id,children:n.label},n.id))}),e.jsx(g,{label:"Use DC",size:"small",type:"number",value:o.useDC,onChange:n=>a(l,{useDC:Number(n.target.value)})}),e.jsx(g,{label:"Damage",size:"small",type:"number",value:o.damage,onChange:n=>a(l,{damage:Number(n.target.value)})}),e.jsx(g,{label:"Range",size:"small",value:o.range??"",onChange:n=>a(l,{range:n.target.value}),placeholder:"Melee / Short / Med / Long"}),e.jsxs(I,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(g,{label:"Ammo",size:"small",type:"number",value:o.ammo??0,onChange:n=>a(l,{ammo:Number(n.target.value)}),sx:{width:110}}),e.jsxs(j,{variant:"body2",sx:{opacity:.8},children:["/ ",u(o)||0]}),e.jsx(ce,{title:"Reload",children:e.jsx("span",{children:e.jsx(J,{size:"small",onClick:()=>a(l,{ammo:u(o)||0}),disabled:(u(o)||0)<=0,children:e.jsx(It,{fontSize:"small"})})})})]}),e.jsx(g,{label:"Bulk",size:"small",type:"number",value:o.bulk??0,onChange:n=>a(l,{bulk:Number(n.target.value)})}),e.jsx(g,{label:"Req.",size:"small",value:o.req??"",onChange:n=>a(l,{req:n.target.value}),placeholder:"PHYS 1 / REF 2 / etc"}),e.jsx(g,{label:"Keywords (comma)",size:"small",value:(o.keywords??[]).join(", "),onChange:n=>a(l,{keywords:n.target.value.split(",").map(i=>i.trim()).filter(Boolean)}),placeholder:"Two-Handed, Piercing 1",sx:{gridColumn:"1 / -1"}})]})]},o.id??`${o.name}-${l}`))]})})]}),e.jsxs(Ie,{defaultExpanded:!0,children:[e.jsx(Me,{expandIcon:e.jsx(Te,{}),children:e.jsx(j,{fontWeight:700,children:"Armor"})}),e.jsx(Re,{children:e.jsxs(z,{spacing:1.5,children:[e.jsxs(I,{sx:{display:"flex",gap:1,alignItems:"center",flexWrap:"wrap"},children:[e.jsxs(g,{label:"Set prefab armor",size:"small",select:!0,value:V,onChange:o=>re(o.target.value),sx:{minWidth:240},children:[e.jsx(he,{value:"",children:"— choose —"}),at.map(o=>e.jsx(he,{value:o.id,children:o.name},o.id))]}),e.jsx(J,{color:"primary",onClick:()=>G(V),"aria-label":"Set prefab armor",disabled:!V,children:e.jsx(fe,{})})]}),e.jsxs(I,{sx:{border:"1px solid",borderColor:"divider",borderRadius:2,p:1.25},children:[e.jsxs(I,{sx:{display:"grid",gridTemplateColumns:"2fr 1fr 1fr 1fr",gap:1},children:[e.jsx(g,{label:"Name",size:"small",value:((K=r.armor)==null?void 0:K.name)??"",onChange:o=>t.onChange({armor:{...r.armor??{durability:{current:0,max:0},protection:0,keywords:[],keywordParams:{ammoMax:0}},name:o.target.value}})}),e.jsx(g,{label:"Protection",size:"small",type:"number",value:((c=r.armor)==null?void 0:c.protection)??0,onChange:o=>t.onChange({armor:{...r.armor??{name:"",durability:{current:0,max:0},keywords:[],keywordParams:{}},protection:Number(o.target.value)}})}),e.jsx(g,{label:"Durability (cur)",size:"small",type:"number",value:((h=r.armor)==null?void 0:h.durability.current)??0,onChange:o=>{var l;return t.onChange({armor:{...r.armor??{name:"",durability:{current:0,max:0},protection:0,keywords:[],keywordParams:{}},durability:{...((l=r.armor)==null?void 0:l.durability)??{current:0,max:0},current:Number(o.target.value)}}})}}),e.jsx(g,{label:"Durability (max)",size:"small",type:"number",value:((P=r.armor)==null?void 0:P.durability.max)??0,onChange:o=>{var l;return t.onChange({armor:{...r.armor??{name:"",durability:{current:0,max:0},protection:0,keywords:[],keywordParams:{}},durability:{...((l=r.armor)==null?void 0:l.durability)??{current:0,max:0},max:Number(o.target.value)}}})}})]}),(((H=(W=r.armor)==null?void 0:W.durability)==null?void 0:H.max)??0)>0&&(((ue=(A=r.armor)==null?void 0:A.durability)==null?void 0:ue.current)??0)<=0&&e.jsx(j,{sx:{mt:1},color:"error",variant:"body2",children:"Broken: armor provides no Protection until repaired."}),e.jsxs(I,{sx:{display:"grid",gridTemplateColumns:"1fr 1fr 1fr 2fr",gap:1,mt:1},children:[e.jsx(g,{label:"Bulk",size:"small",type:"number",value:((xe=r.armor)==null?void 0:xe.bulk)??0,onChange:o=>t.onChange({armor:{...r.armor??{name:"",durability:{current:0,max:0},protection:0,keywords:[],keywordParams:{}},bulk:Number(o.target.value)}})}),e.jsx(g,{label:"Req.",size:"small",value:((ye=r.armor)==null?void 0:ye.req)??"",onChange:o=>t.onChange({armor:{...r.armor??{name:"",durability:{current:0,max:0},protection:0,keywords:[],keywordParams:{}},req:o.target.value}})}),e.jsx(g,{label:"Special",size:"small",value:((be=r.armor)==null?void 0:be.special)??"",onChange:o=>t.onChange({armor:{...r.armor??{name:"",durability:{current:0,max:0},protection:0,keywords:[],keywordParams:{}},special:o.target.value}})})]}),e.jsx(I,{sx:{mt:1},children:e.jsx(g,{label:"Keywords (comma)",size:"small",fullWidth:!0,value:(((ke=r.armor)==null?void 0:ke.keywords)??[]).join(", "),onChange:o=>t.onChange({armor:{...r.armor??{name:"",durability:{current:0,max:0},protection:0,keywords:[],keywordParams:{}},keywords:o.target.value.split(",").map(l=>l.trim()).filter(Boolean)}}),placeholder:"Frontal Shielding 1"})})]})]})})]})]})}const ta=[{name:"Flashbang Grenade",effect:"Applies Stun 1 to everyone within near range, Thrown",uses:"1 use",bulk:1,cost:200},{name:"Frag Grenade",effect:"Deals 2 area (near range) damage (DC8 to Evade half), Thrown",uses:"1 use",bulk:1,cost:250},{name:"EMP Grenade",effect:"Applies EMP 2 to everything within range, Thrown",uses:"1 use",bulk:1,cost:300},{name:"Combat Stim Injector",effect:"Gain +1 action & -1 Stress; take 1 wound after effect ends",uses:"1 use",bulk:1,cost:200},{name:"Basic Medkit",effect:"Right tool for the job: First Aid checks",uses:"3 uses",bulk:1,cost:350},{name:"Multitool",effect:"Allows engineering checks to repair, bypass, scrap, etc.",uses:"Permanent",bulk:1,cost:750},{name:"Repair Kit",effect:"Provides materials and tools for repairs",uses:"10 uses",bulk:1,cost:500},{name:"Tracker",effect:"While within 10km, always know location of this device",uses:"1 use",bulk:1,cost:250},{name:"Portable Scanner",effect:"Right tool for the job: Observe (tech, lifeforms)",uses:"Permanent",bulk:1,cost:400},{name:"Weapon Scope",effect:"Simple Modification. Grants +1 bonus die to called shots at medium range and farther; inflicts +1 penalty die to attacks at close range or nearer",uses:"Permanent",bulk:1,cost:750},{name:"Weapon Silencer",effect:"Simple Modification. Weapon makes reduced sound when fired; deals -1 damage",uses:"Permanent",bulk:1,cost:500},{name:"Compact Backpack",effect:"+5 Inventory Slots when worn",uses:"Permanent",bulk:0,cost:150,statusEffects:"carrying_capacity+5"},{name:"Ammo (Flechette)",effect:"Deals +2 damage to unarmoured targets.",uses:"10 rounds",bulk:1,cost:500},{name:"Ammo (SMART)",effect:"Required for Smart-Linked weapons.",uses:"10",bulk:1,cost:1250},{name:"Ammo (Armour Piercing)",effect:"Adds Piercing 1 to attacks.",uses:"10",bulk:1,cost:750},{name:"Ammo (Explosive)",effect:"Adds Shredding 1 to attacks.",uses:"10",bulk:1,cost:750}],aa={items:ta},na=aa.items,sa=[{name:"Reflex Booster",tier:1,effect:"Once per round, gain +1 bonus die to an Evade check.",installationDifficulty:2,requirements:"REF 1",physicalImpact:"Low; spine",bulk:1,cost:3e3},{name:"Targeting Link",tier:1,effect:"Once per round, ignore 1 level of cover when attacking an enemy you can see.",installationDifficulty:2,requirements:"-",physicalImpact:"Medium; eyes",bulk:1,cost:4e3},{name:"Low-Light Optics",tier:1,effect:"Ignore penalty dice caused by darkness within medium range.",installationDifficulty:1,requirements:"-",physicalImpact:"Medium; eyes",bulk:1,cost:2e3},{name:"EMP Shielding",tier:1,effect:"Ignore the effects of EMP once per day.",installationDifficulty:2,requirements:"MENT 1",physicalImpact:"None; torso",bulk:1,cost:3500},{name:"Metabolic Filter",tier:1,effect:"Gain +1 bonus die on checks to resist toxins or narcotics.",installationDifficulty:1,requirements:"PHYS 1",physicalImpact:"Minor; liver",bulk:1,cost:1500},{name:"Compact Databank",tier:2,effect:"Internal information storage device; store/access info at will.",installationDifficulty:2,requirements:"MENT 1",physicalImpact:"Medium; cranium",bulk:1,cost:5e3}],ia={cyberware:sa},ra=ia.cyberware,la=[{name:"Space Dust",effect:"Grants +1 bonus die to Observe and Piloting checks for 6 hours",uses:5,addictionScore:1,legality:"Legal",bulk:1,cost:500},{name:"Tranquility",effect:"Reduces stress by 1; penalty die to all REF checks for 6 hours.",uses:2,addictionScore:5,legality:"Legal",bulk:1,cost:5e3},{name:"Smoothe",effect:"Reduces stress by 1d4; increases Cool Under Fire by 2 and grants +1 bonus die to all Mental skill checks for 1 hour",uses:1,addictionScore:8,legality:"Illegal",bulk:1,cost:2e4},{name:"Chemical Strength",effect:"+1 bonus die to all PHYS checks for 1 hour; +1 movement bonus for 1 hour. After 1 hour, +1 penalty die to all PHYS checks and +1 movement penalty until sleep.",uses:1,addictionScore:3,legality:"Illegal",bulk:1,cost:8e3}],oa={narcotics:la},ca=oa.narcotics;function da(){return`inv_${Date.now()}_${Math.random().toString(36).slice(2,9)}`}function ua(t){const r=t.sheet.inventory??[],v=a=>{t.onChange({inventory:a})},[b,T]=y.useState("item"),[S,p]=y.useState(null),[d,k]=y.useState({}),[L,Y]=y.useState(null),[D,ae]=y.useState(null),X=y.useMemo(()=>b==="item"?na.map(a=>({type:"item",...a})):b==="cyberware"?ra.map(a=>({type:"cyberware",...a})):ca.map(a=>({type:"narcotics",...a})),[b]);function ie(a){p(a);const s=X.find(x=>x.name===a);if(!s){k({type:b,name:"",quantity:1,bulk:b==="item"?0:1,effect:"",cost:0,statusEffects:""});return}k(b==="item"?{type:"item",name:s.name,quantity:1,uses:s.uses??"",bulk:s.bulk??0,effect:s.effect??"",cost:s.cost??0,statusEffects:s.statusEffects??""}:b==="cyberware"?{type:"cyberware",name:s.name,quantity:1,bulk:s.bulk??1,tier:s.tier??1,installationDifficulty:s.installationDifficulty??0,requirements:s.requirements??"",physicalImpact:s.physicalImpact??"",effect:s.effect??"",cost:s.cost??0,statusEffects:s.statusEffects??""}:{type:"narcotics",name:s.name,quantity:1,bulk:s.bulk??1,uses:s.uses??1,addictionScore:s.addictionScore??0,legality:s.legality??"",effect:s.effect??"",cost:s.cost??0,statusEffects:s.statusEffects??""})}function B(){const a=[...r,{id:da(),...d}];t.onChange({inventory:a}),p(null),k({type:b,name:"",quantity:1,bulk:b==="item"?0:1,effect:"",cost:0,statusEffects:""})}function te(a){t.onChange({inventory:r.filter(s=>s.id!==a)})}function u(a,s){t.onChange({inventory:r.map(x=>x.id===a?{...x,...s}:x)})}return e.jsxs(z,{spacing:2,children:[e.jsx(g,{label:"Credits",type:"number",value:t.sheet.credits??0,onChange:a=>t.onChange({credits:Number(a.target.value)}),size:"small"}),e.jsxs(I,{children:[e.jsx(j,{variant:"subtitle2",sx:{mb:1},children:"Add Inventory"}),e.jsxs(z,{direction:{xs:"column",sm:"row"},spacing:1,alignItems:"center",children:[e.jsxs(g,{select:!0,size:"small",label:"Type",value:b,onChange:a=>{const s=a.target.value;T(s),p(null),k(s==="item"?{type:s,name:"",quantity:1,bulk:0,uses:"",effect:"",cost:0,statusEffects:""}:s==="cyberware"?{type:s,name:"",quantity:1,bulk:1,tier:1,installationDifficulty:0,requirements:"",physicalImpact:"",effect:"",cost:0,statusEffects:""}:{type:s,name:"",quantity:1,bulk:1,uses:1,addictionScore:0,legality:"",effect:"",cost:0,statusEffects:""})},sx:{minWidth:160},children:[e.jsx(he,{value:"item",children:"Item"}),e.jsx(he,{value:"cyberware",children:"Cyberware"}),e.jsx(he,{value:"narcotics",children:"Narcotics"})]}),e.jsx(Mt,{size:"small",sx:{flex:1,minWidth:220},options:X.map(a=>a.name),value:S,onChange:(a,s)=>ie(s),renderInput:a=>e.jsx(g,{...a,label:"Template (optional)"})}),e.jsx(ge,{variant:"contained",startIcon:e.jsx(fe,{}),onClick:B,disabled:!(d!=null&&d.name),children:"Add"})]}),e.jsx(I,{sx:{mt:1},children:e.jsxs(z,{spacing:1,children:[e.jsxs(z,{direction:{xs:"column",sm:"row"},spacing:1,children:[e.jsx(g,{size:"small",label:"Name",value:(d==null?void 0:d.name)??"",onChange:a=>k(s=>({...s,name:a.target.value})),sx:{flex:1}}),e.jsx(g,{size:"small",type:"number",label:"Bulk",value:(d==null?void 0:d.bulk)??0,onChange:a=>k(s=>({...s,bulk:Number(a.target.value)})),sx:{width:120}}),e.jsx(g,{size:"small",type:"number",label:"Quantity",value:(d==null?void 0:d.quantity)??1,onChange:a=>{const s=Number(a.target.value);Number.isFinite(s)&&k(x=>({...x,quantity:s}))},sx:{width:120}}),e.jsx(g,{size:"small",type:"number",label:"Cost",value:(d==null?void 0:d.cost)??0,onChange:a=>k(s=>({...s,cost:Number(a.target.value)})),sx:{width:140}})]}),b==="item"&&e.jsx(g,{size:"small",label:"Uses",value:(d==null?void 0:d.uses)??"",onChange:a=>k(s=>({...s,uses:a.target.value}))}),b==="cyberware"&&e.jsxs(z,{direction:{xs:"column",sm:"row"},spacing:1,children:[e.jsx(g,{size:"small",type:"number",label:"Tier",value:(d==null?void 0:d.tier)??1,onChange:a=>k(s=>({...s,tier:Number(a.target.value)})),sx:{width:120}}),e.jsx(g,{size:"small",type:"number",label:"Installation Difficulty",value:(d==null?void 0:d.installationDifficulty)??0,onChange:a=>k(s=>({...s,installationDifficulty:Number(a.target.value)})),sx:{width:220}}),e.jsx(g,{size:"small",label:"Requirements",value:(d==null?void 0:d.requirements)??"",onChange:a=>k(s=>({...s,requirements:a.target.value})),sx:{flex:1}})]}),b==="cyberware"&&e.jsx(g,{size:"small",label:"Physical Impact",value:(d==null?void 0:d.physicalImpact)??"",onChange:a=>k(s=>({...s,physicalImpact:a.target.value}))}),b==="narcotics"&&e.jsxs(z,{direction:{xs:"column",sm:"row"},spacing:1,children:[e.jsx(g,{size:"small",type:"number",label:"Uses",value:(d==null?void 0:d.uses)??1,onChange:a=>k(s=>({...s,uses:Number(a.target.value)})),sx:{width:120}}),e.jsx(g,{size:"small",type:"number",label:"Addiction Score",value:(d==null?void 0:d.addictionScore)??0,onChange:a=>k(s=>({...s,addictionScore:Number(a.target.value)})),sx:{width:160}}),e.jsx(g,{size:"small",label:"Legality",value:(d==null?void 0:d.legality)??"",onChange:a=>k(s=>({...s,legality:a.target.value})),sx:{flex:1}})]}),e.jsx(g,{size:"small",label:"Effect",value:(d==null?void 0:d.effect)??"",onChange:a=>k(s=>({...s,effect:a.target.value})),multiline:!0,minRows:2}),e.jsx(g,{size:"small",label:"Status Effects (comma-separated)",value:(d==null?void 0:d.statusEffects)??"",onChange:a=>k(s=>({...s,statusEffects:a.target.value})),placeholder:'e.g. "carrying_capacity+5"'})]})})]}),e.jsxs(I,{children:[e.jsx(j,{variant:"subtitle2",sx:{mb:1},children:"Inventory"}),r.length===0&&e.jsx(j,{variant:"body2",children:"No inventory items yet."}),r.map(a=>{const s=a.quantity??1,M=(a.bulk??0)*s,q=`${a.name} (${a.type}) • bulk ${M}`;return e.jsxs(Ie,{disableGutters:!0,children:[e.jsx(Me,{expandIcon:e.jsx(Te,{}),draggable:!0,onDragStart:m=>{Y(a.id??null);try{m.dataTransfer.effectAllowed="move",m.dataTransfer.setData("text/plain",a.id??"")}catch{}},onDragOver:m=>{m.preventDefault(),ae(a.id??null)},onDragLeave:()=>ae(null),onDrop:m=>{m.preventDefault();const E=L??m.dataTransfer.getData("text/plain"),Z=a.id;if(E&&Z&&E!==Z){const V=t.sheet.inventory??[],re=V.findIndex(K=>K.id===E),G=V.findIndex(K=>K.id===Z);if(re>=0&&G>=0){const K=[...V],[c]=K.splice(re,1);K.splice(G,0,c),v(K)}}Y(null),ae(null)},sx:D===a.id?{outline:"2px dashed rgba(255,255,255,0.35)",borderRadius:1}:void 0,children:e.jsxs(z,{direction:"row",spacing:1,alignItems:"center",sx:{width:"100%"},children:[e.jsx(Tt,{fontSize:"small",sx:{opacity:.5}}),e.jsx(j,{variant:"body2",sx:{flex:1},children:q}),e.jsxs(z,{direction:"row",spacing:.5,alignItems:"center",children:[e.jsx(J,{size:"small",onClick:m=>{m.stopPropagation();const E=(a.quantity??1)-1;E<=0?te(a.id):u(a.id,{quantity:E})},children:e.jsx(Ee,{fontSize:"small"})}),e.jsx(j,{variant:"caption",sx:{minWidth:18,textAlign:"center"},children:a.quantity??1}),e.jsx(J,{size:"small",onClick:m=>{m.stopPropagation(),u(a.id,{quantity:(a.quantity??1)+1})},children:e.jsx(fe,{fontSize:"small"})})]}),e.jsx(ce,{title:"Remove",children:e.jsx(J,{size:"small",onClick:m=>(m.stopPropagation(),te(a.id)),children:e.jsx(ze,{fontSize:"small"})})})]})}),e.jsx(Re,{children:e.jsxs(z,{spacing:1,children:[e.jsxs(z,{direction:{xs:"column",sm:"row"},spacing:1,children:[e.jsx(g,{size:"small",label:"Name",value:a.name??"",onChange:m=>u(a.id,{name:m.target.value}),sx:{flex:1}}),e.jsxs(g,{select:!0,size:"small",label:"Type",value:a.type,onChange:m=>u(a.id,{type:m.target.value}),sx:{width:160},children:[e.jsx(he,{value:"item",children:"Item"}),e.jsx(he,{value:"cyberware",children:"Cyberware"}),e.jsx(he,{value:"narcotics",children:"Narcotics"})]}),e.jsx(g,{size:"small",type:"number",label:"Bulk",value:a.bulk??0,onChange:m=>u(a.id,{bulk:Number(m.target.value)}),sx:{width:120}}),e.jsx(g,{size:"small",type:"number",label:"Quantity",value:a.quantity??1,onChange:m=>{const E=Number(m.target.value);Number.isFinite(E)&&(E<=0?te(a.id):u(a.id,{quantity:E}))},sx:{width:120}}),e.jsx(g,{size:"small",type:"number",label:"Cost",value:a.cost??0,onChange:m=>u(a.id,{cost:Number(m.target.value)}),sx:{width:140}})]}),a.type==="item"&&e.jsx(g,{size:"small",label:"Uses",value:a.uses??"",onChange:m=>u(a.id,{uses:m.target.value})}),a.type==="cyberware"&&e.jsxs(z,{direction:{xs:"column",sm:"row"},spacing:1,children:[e.jsx(g,{size:"small",type:"number",label:"Tier",value:a.tier??1,onChange:m=>u(a.id,{tier:Number(m.target.value)}),sx:{width:120}}),e.jsx(g,{size:"small",type:"number",label:"Installation Difficulty",value:a.installationDifficulty??0,onChange:m=>u(a.id,{installationDifficulty:Number(m.target.value)}),sx:{width:220}}),e.jsx(g,{size:"small",label:"Requirements",value:a.requirements??"",onChange:m=>u(a.id,{requirements:m.target.value}),sx:{flex:1}})]}),a.type==="cyberware"&&e.jsx(g,{size:"small",label:"Physical Impact",value:a.physicalImpact??"",onChange:m=>u(a.id,{physicalImpact:m.target.value})}),a.type==="narcotics"&&e.jsxs(z,{direction:{xs:"column",sm:"row"},spacing:1,children:[e.jsx(g,{size:"small",type:"number",label:"Uses",value:a.uses??1,onChange:m=>u(a.id,{uses:Number(m.target.value)}),sx:{width:120}}),e.jsx(g,{size:"small",type:"number",label:"Addiction Score",value:a.addictionScore??0,onChange:m=>u(a.id,{addictionScore:Number(m.target.value)}),sx:{width:160}}),e.jsx(g,{size:"small",label:"Legality",value:a.legality??"",onChange:m=>u(a.id,{legality:m.target.value}),sx:{flex:1}})]}),e.jsx(g,{size:"small",label:"Effect",value:a.effect??"",onChange:m=>u(a.id,{effect:m.target.value}),multiline:!0,minRows:2}),e.jsx(g,{size:"small",label:"Status Effects (comma-separated)",value:a.statusEffects??"",onChange:m=>u(a.id,{statusEffects:m.target.value}),placeholder:'e.g. "carrying_capacity+5"'})]})})]},a.id)})]})]})}function ma(t){const r=typeof t=="number"?t:0;return r<=0?-1:r}function ha(){const[t,r]=y.useState({entries:[],activeTokenId:void 0,updatedAt:Date.now()}),[v,b]=y.useState({}),[T,S]=y.useState(""),[p,d]=y.useState(!1),[k,L]=y.useState(0),[Y,D]=y.useState(0),ae=u=>Math.max(-3,Math.min(3,u));y.useEffect(()=>{const u=ht(a=>r(a));return()=>u==null?void 0:u()},[]),y.useEffect(()=>{let u=!0;return(async()=>{var a,s,x,M;try{const[q,m]=await Promise.all([((s=(a=$.player).getId)==null?void 0:s.call(a))??Promise.resolve(""),((M=(x=$.player).getRole)==null?void 0:M.call(x))??Promise.resolve("")]);if(!u)return;S(String(q??"")),d(String(m).toUpperCase()==="GM")}catch{}})(),()=>{u=!1}},[]);const X=y.useMemo(()=>{const u=[...t.entries??[]];return u.sort((a,s)=>(s.initiative??0)-(a.initiative??0)),u},[t.entries]);y.useEffect(()=>{let u=!0;return(async()=>{var a,s,x,M,q,m,E;try{const Z=X.map(G=>G.tokenId);if(!Z.length){u&&b({});return}const V=await $.scene.items.getItems(Z),re={};for(const G of V){const K=G.id,c=await Fe(K),h=c==null?void 0:c.armor,P=((a=h==null?void 0:h.durability)==null?void 0:a.current)??0,W=!!h&&P<=0,H=W?0:(h==null?void 0:h.protection)??0,A=(s=c==null?void 0:c.weapons)==null?void 0:s[0];re[K]={tokenId:K,name:((q=(M=(x=G.text)==null?void 0:x.plainText)==null?void 0:M.trim)==null?void 0:q.call(M))||(c==null?void 0:c.name)||"(Unnamed)",thumbUrl:(m=G.image)==null?void 0:m.url,ownerPlayerId:String(((E=G.metadata)==null?void 0:E[st])??""),prot:H,armorBroken:W,topWeaponName:A==null?void 0:A.name,topWeaponUseDC:A==null?void 0:A.useDC,topWeaponDamage:A==null?void 0:A.damage,topWeaponSkillId:A==null?void 0:A.skillId}}u&&b(re)}catch{}})(),()=>{u=!1}},[X]);async function ie(u){var c,h,P,W,H;const[a]=await $.scene.items.getItems([u]);if(!a)return;const s=await Fe(u);if(!s)return;const x=Qe([...(s.feats??[]).map(A=>A.statusEffects??"").filter(Boolean),...(s.inventory??[]).map(A=>A.statusEffects??"").filter(Boolean)]).deltas,M=we(s.skills??{}),q=((c=s.stress)==null?void 0:c.current)??0,m=Math.max(0,(Pe(s.skills??{})||0)-(((h=s.stress)==null?void 0:h.cufLoss)??0)),E=yt({attributes:M,stress:{current:q,cuf:m}},x),Z=E.stress.cuf??m,V=E.attributes.ref??M.ref??0,re=q>Z,G=Ae({netDice:re?-1:0,modifier:V,label:`${((P=a.text)==null?void 0:P.plainText)??s.name??"Token"} Initiative`}),K=await nt({diceNotation:G,rollTarget:"everyone",showResults:!0});await bt({tokenId:u,initiative:K,name:((W=a.text)==null?void 0:W.plainText)??s.name??"Token",thumbUrl:(H=a.image)==null?void 0:H.url})}async function B(){var M,q;const u=await((q=(M=$.player).getSelection)==null?void 0:q.call(M))??[],a=u==null?void 0:u[0],s=await it()??void 0,x=a||s;if(!x){$.notification.show("Select a token (or set your character) to roll initiative.","WARNING");return}await ie(x)}async function te(u){var c,h,P,W,H;const a=await Fe(u);if(!a)return;const s=(c=a.weapons)==null?void 0:c[0];if(!s){$.notification.show("No weapon in the top slot.","WARNING");return}const x=Qe([...(a.feats??[]).map(A=>A.statusEffects??"").filter(Boolean),...(a.inventory??[]).map(A=>A.statusEffects??"").filter(Boolean)]).deltas,q=(Pe(a.skills??{})-(((h=a.stress)==null?void 0:h.cufLoss)??0)||0)+(x.cool_under_fire??0),E=(((P=a.stress)==null?void 0:P.current)??0)>q,Z=s.skillId,V=((W=a.skills)==null?void 0:W[Z])??0,re=ma(V)+(x[Z]??0),G=ae(k-(Y+(E?1:0)));if(await ct({weapon:s,netDice:G,modifier:re,rollTarget:"everyone",showResults:!0}),Number(((H=s==null?void 0:s.keywordParams)==null?void 0:H.ammoMax)??0)>0){const A=Number((s==null?void 0:s.ammo)??0),ue=Math.max(0,A-1),xe=[...a.weapons??[]];xe[0]={...xe[0],ammo:ue},await rt(u,{...a,weapons:xe})}}return e.jsxs(z,{spacing:2,children:[e.jsxs(I,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",gap:1,flexWrap:"wrap"},children:[e.jsx(j,{variant:"h6",sx:{m:0},children:"Initiative"}),e.jsxs(z,{direction:"row",spacing:1,alignItems:"center",children:[e.jsx(ge,{size:"small",variant:"contained",onClick:()=>void B(),startIcon:e.jsx(Se,{}),children:"Roll Initiative"}),e.jsxs(z,{direction:"row",spacing:.5,alignItems:"center",sx:{pl:1},children:[e.jsx(j,{variant:"body2",sx:{opacity:.8},children:"Attack dice"}),e.jsx(ce,{title:"Bonus dice",children:e.jsx("span",{children:e.jsx(J,{size:"small",onClick:()=>L(u=>Math.min(3,u+1)),children:e.jsx(fe,{fontSize:"inherit"})})})}),e.jsx(j,{variant:"body2",sx:{width:16,textAlign:"center"},children:k}),e.jsx(ce,{title:"Reduce bonus dice",children:e.jsx("span",{children:e.jsx(J,{size:"small",onClick:()=>L(u=>Math.max(0,u-1)),children:e.jsx(Ee,{fontSize:"inherit"})})})}),e.jsx(I,{sx:{width:8}}),e.jsx(ce,{title:"Penalty dice",children:e.jsx("span",{children:e.jsx(J,{size:"small",onClick:()=>D(u=>Math.min(3,u+1)),children:e.jsx(fe,{fontSize:"inherit"})})})}),e.jsx(j,{variant:"body2",sx:{width:16,textAlign:"center"},children:Y}),e.jsx(ce,{title:"Reduce penalty dice",children:e.jsx("span",{children:e.jsx(J,{size:"small",onClick:()=>D(u=>Math.max(0,u-1)),children:e.jsx(Ee,{fontSize:"inherit"})})})})]}),p&&e.jsxs(e.Fragment,{children:[e.jsx(ge,{size:"small",variant:"outlined",onClick:()=>xt(),children:"Clear"}),e.jsx(ge,{size:"small",variant:"outlined",onClick:()=>ft(),children:"Advance"})]})]})]}),e.jsx(Rt,{}),X.length===0?e.jsx(j,{variant:"body2",sx:{opacity:.75},children:"No initiative rolls yet."}):e.jsx(Dt,{dense:!0,disablePadding:!0,children:X.map(u=>{const a=v[u.tokenId],s=a==null?void 0:a.ownerPlayerId,x=p||!!s&&s===T,M=t.activeTokenId===u.tokenId,q=M&&x&&!p,m=!!u.surprised;return e.jsxs(Pt,{sx:{borderRadius:1,mb:.5,bgcolor:M?"rgba(255,255,255,0.06)":"transparent",opacity:m?.55:1},secondaryAction:e.jsxs(z,{direction:"row",spacing:.5,alignItems:"center",children:[e.jsx(ce,{title:a!=null&&a.armorBroken?"Armor broken":"Protection",children:e.jsxs(I,{sx:{display:"inline-flex",alignItems:"center",gap:.5,px:1,py:.5,borderRadius:1,bgcolor:"rgba(0,0,0,0.25)"},children:[e.jsx(Wt,{fontSize:"small"}),e.jsx(j,{variant:"caption",children:(a==null?void 0:a.prot)??0})]})}),(p||x)&&e.jsx(ce,{title:a!=null&&a.topWeaponName?`Attack: ${a.topWeaponName}`:"No top weapon",children:e.jsx("span",{children:e.jsx(J,{size:"small",disabled:!(a!=null&&a.topWeaponName),onClick:()=>void te(u.tokenId),children:e.jsx(Se,{fontSize:"small"})})})}),e.jsx(ce,{title:x||p?"Remove":"Only the owner or GM can remove",children:e.jsx("span",{children:e.jsx(J,{size:"small",disabled:!x&&!p,onClick:()=>pt(u.tokenId),children:e.jsx(ze,{fontSize:"small"})})})})]}),children:[e.jsx(Et,{children:e.jsx(At,{src:a==null?void 0:a.thumbUrl,variant:"rounded",sx:{width:32,height:32,mr:1,cursor:"pointer"}})}),e.jsx(zt,{primary:e.jsxs(I,{sx:{display:"flex",alignItems:"center",gap:1,flexWrap:"wrap"},children:[e.jsx(j,{variant:"body2",sx:{fontWeight:600},children:(a==null?void 0:a.name)??u.name??"Token"}),e.jsx(j,{variant:"caption",sx:{opacity:.75},children:u.initiative}),q&&e.jsx(j,{variant:"caption",sx:{px:1,py:.25,borderRadius:1,bgcolor:"rgba(0,128,255,0.2)"},children:"Your Turn"})]}),secondary:e.jsxs(I,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(Nt,{size:"small",checked:m,disabled:!p,onChange:E=>gt(u.tokenId,E.target.checked)}),e.jsx(j,{variant:"caption",sx:{opacity:.75},children:"Surprised"})]})})]},u.tokenId)})})]})}function xa(){var ue,xe,ye,be,ke,o,l;const[t,r]=y.useState({kind:"loading"}),[v,b]=y.useState("core"),[T,S]=y.useState(!1),[p,d]=y.useState(null);async function k(n){var i,f,R,C,N,F;try{const _=await $.scene.items.getItems([n]),w=_==null?void 0:_[0];if(!w)return{ownerLabel:"unowned",thumbUrl:null};const O=((i=w==null?void 0:w.image)==null?void 0:i.url)??((f=w==null?void 0:w.image)==null?void 0:f.href)??(w==null?void 0:w.imageUrl)??(w==null?void 0:w.image)??((R=w==null?void 0:w.thumbnail)==null?void 0:R.url)??null,ee=(C=w==null?void 0:w.metadata)==null?void 0:C[st];if(typeof ee!="string"||ee.length===0)return{ownerLabel:"unowned",thumbUrl:O};const se=await $.player.getId();if(ee===se)return{ownerLabel:"owned by you",thumbUrl:O};try{const le=(await((F=(N=$.party).getPlayers)==null?void 0:F.call(N))??[]).find(oe=>(oe==null?void 0:oe.id)===ee);return{ownerLabel:`owned by ${typeof(le==null?void 0:le.name)=="string"&&le.name.length>0?le.name:ee}`,thumbUrl:O}}catch{return{ownerLabel:`owned by ${ee}`,thumbUrl:O}}}catch{return{ownerLabel:"unowned",thumbUrl:null}}}async function L(){const n=await vt();if(n)if(await Be(n)){const O=await _e(n);if(!O)throw new Error("Could not load sheet from token.");const ee=we(O.skills??{}),se={...O,attributes:ee},me=await k(n);r({kind:"ready",tokenId:n,sheet:se,mode:"view",...me});return}else await Le(null);let f=await it();if(f||(f=await Xe(),f&&await je(f)),!f){r({kind:"need-token"});return}let R=await Be(f);if(!R){const w=await Xe();w&&(f=w,await je(f),R=await Be(f))}if(!R){await je(null),r({kind:"need-token"});return}const C=await _e(f);if(!C)throw new Error("Could not load sheet from token.");try{await Ze(f)}catch{}const N=we(C.skills??{}),F={...C,attributes:N},_=await k(f);r({kind:"ready",tokenId:f,sheet:F,mode:"my",..._})}y.useEffect(()=>{let n=!1;return $.onReady(async()=>{try{await L()}catch(i){n||r({kind:"error",message:i.message??"Unknown error"})}}),()=>{n=!0}},[]),y.useEffect(()=>{var C,N,F,_;if(t.kind!=="ready")return;const n=t.tokenId;let i=!1;const f=async()=>{var w,O;try{const ee=await $.scene.items.getItems([n]),se=ee==null?void 0:ee[0],me=String(((w=se==null?void 0:se.text)==null?void 0:w.plainText)??"").trim(),le=(O=se==null?void 0:se.image)==null?void 0:O.url;if(i||!me&&!le)return;r(U=>{if(U.kind!=="ready"||U.tokenId!==n)return U;const oe=me&&U.sheet.name!==me?{...U.sheet,name:me}:U.sheet;return{...U,sheet:oe,thumbUrl:le??U.thumbUrl}})}catch{}};f();const R=(_=(F=(N=(C=$)==null?void 0:C.scene)==null?void 0:N.items)==null?void 0:F.onChange)==null?void 0:_.call(F,w=>{Array.isArray(w)&&w.some(O=>(O==null?void 0:O.id)===n)&&f()});return()=>{i=!0,typeof R=="function"&&R()}},[t.kind,t.kind==="ready"?t.tokenId:null]);const Y=y.useMemo(()=>t.kind==="ready"&&t.sheet.name||"Whisperspace Sheet",[t]);async function D(){const n=await qt();if(!n){r({kind:"error",message:"No token selected. Select a token on the map first."});return}const i=await _e(n);if(!i){r({kind:"error",message:"Could not attach a sheet to the selected token."});return}const f=we(i.skills??{}),R={...i,attributes:f};await je(n);try{await Ze(n)}catch{}await Le(null);const C=await k(n);r({kind:"ready",tokenId:n,sheet:R,mode:"my",...C})}async function ae(){await je(null),r({kind:"need-token"})}async function X(){await Le(null),r({kind:"loading"});try{await L()}catch(n){r({kind:"error",message:n.message??"Unknown error"})}}async function ie(n,i){S(!0);try{await rt(n,i)}finally{S(!1)}}function B(n){r(i=>{if(i.kind!=="ready")return i;let f=n(i.sheet);try{const R=we(f.skills??{});f={...f,attributes:{...f.attributes,...R},stress:{...f.stress??{current:0,cuf:0,cufLoss:0},cuf:Pe(f.skills??{})}}}catch{}return ie(i.tokenId,f),{...i,sheet:f}})}async function te(n){var w;if(t.kind!=="ready")return;const i=8+n,f=Math.max(0,Math.trunc(((w=t.sheet.stress)==null?void 0:w.cuf)??0)),R=`Crucible Test (DC ${i})`,C=f===0?"":` +${f}`,N=`1d12 # ${R}${C}`,F=await He({diceNotation:N,rollTarget:"everyone",showResults:!0}),_=await new Promise((O,ee)=>{const se=setTimeout(()=>{me(),ee(new Error("Dice+ roll timed out (no roll-result received)"))},4e3),me=$.broadcast.onMessage(`${jt}/roll-result`,le=>{var Ne;const U=le.data;if(!U||U.rollId!==F)return;clearTimeout(se),me();const oe=typeof U.total=="number"?U.total:typeof((Ne=U==null?void 0:U.result)==null?void 0:Ne.total)=="number"?U.result.total:typeof(U==null?void 0:U.value)=="number"?U.value:NaN;if(!Number.isFinite(oe)){ee(new Error("Dice+ roll-result received, but total was missing/invalid."));return}O(Math.trunc(oe))})});_>=i?(B(O=>({...O,stress:{...O.stress??{current:0,cuf:0,cufLoss:0},current:5},indomitable:!0})),d({incoming:n,dc:i,status:"success",total:_})):d({incoming:n,dc:i,status:"fail",total:_})}function u(n){var R;if(t.kind!=="ready")return;const i=Math.max(0,Math.trunc(((R=t.sheet.stress)==null?void 0:R.current)??0)),f=Math.max(0,Math.trunc(n));if(i<=5&&f>5){const C=f-i;d({incoming:C,dc:8+C,status:"pending"})}else d(null);B(C=>({...C,stress:{...C.stress??{current:0,cuf:0,cufLoss:0},current:f}}))}function a(n,i){var F;if(t.kind!=="ready")return;const R={light:4,moderate:2,heavy:1}[n],C=Math.max(0,Math.trunc(((F=t.sheet.wounds)==null?void 0:F[n])??0)),N=i<C?i:i+1;B(_=>({..._,wounds:{..._.wounds,[n]:Math.min(R,Math.max(0,N))}}))}function s(){var i;if(t.kind!=="ready"||!p||p.status!=="fail")return;const n=Math.max(0,Math.trunc(((i=t.sheet.stress)==null?void 0:i.cufLoss)??0));B(f=>({...f,stress:{...f.stress??{current:0,cuf:0,cufLoss:0},cufLoss:n+1,current:5},indomitable:!0})),d({...p,status:"success"})}const x=t.kind==="ready"?t.sheet:null,M=Ce.useMemo(()=>{if(!x)return{};const n=[];return(x.feats??[]).forEach(i=>{typeof(i==null?void 0:i.statusEffects)=="string"&&i.statusEffects.trim()&&n.push(i.statusEffects)}),(x.inventory??[]).forEach(i=>{typeof(i==null?void 0:i.statusEffects)=="string"&&i.statusEffects.trim()&&n.push(i.statusEffects)}),kt(n)},[x]),q=Ce.useMemo(()=>{const n={},i=new Map,f=C=>{const N=String(C.id),F=String(C.name??C.label??"").toLowerCase().replace(/\s+/g,"_").replace(/[^a-z0-9_\-()]/g,"");N&&(i.set(N.toLowerCase(),N),F&&i.set(F,N))};(de.inherent??[]).forEach(f),Object.values(de.learned??{}).forEach(C=>{(C??[]).forEach(f)});const R=new Set(["phys","ref","soc","ment","carrying_capacity","cool_under_fire","speed","cuf","carry","capacity","spd"]);return Object.entries(M??{}).forEach(([C,N])=>{const F=String(C).toLowerCase();if(R.has(F))return;const _=i.get(F);_&&(n[_]=(n[_]??0)+(Number.isFinite(N)?N:0))}),n},[M]),m=Math.max(0,(((ue=x==null?void 0:x.attributes)==null?void 0:ue.phys)??0)+(M.phys??0)),E=Math.max(0,(((xe=x==null?void 0:x.attributes)==null?void 0:xe.ref)??0)+(M.ref??0)),Z=Math.max(0,(((ye=x==null?void 0:x.attributes)==null?void 0:ye.soc)??0)+(M.soc??0)),V=Math.max(0,(((be=x==null?void 0:x.attributes)==null?void 0:be.ment)??0)+(M.ment??0)),G=5+m*5+(M.carrying_capacity??0);30+m*5+(M.speed??0);const c=x?Pe(x.skills??{}):0,h=Math.max(0,c+(M.cool_under_fire??0)),W=Ce.useMemo(()=>x?{...x,attributes:{...x.attributes,phys:m,ref:E,soc:Z,ment:V},stress:{...x.stress??{current:0,cuf:0,cufLoss:0},cuf:h}}:null,[x,m,E,Z,V,h])??x,H=Ce.useMemo(()=>{var R;if(!x)return 0;const n=(x.weapons??[]).reduce((C,N)=>C+(N.bulk??0),0),i=((R=x.armor)==null?void 0:R.bulk)??0,f=(x.inventory??[]).reduce((C,N)=>{const F=N.quantity??1,_=N.bulk??0,w=Number.isFinite(_)?_:0,O=Number.isFinite(F)?F:1;return C+w*O},0);return n+i+f},[x]),A=x&&H>G*2?"Heavily Encumbered":x&&H>G?"Encumbered":"";return t.kind==="loading"?e.jsx("div",{style:{padding:12},children:"Loading…"}):t.kind==="need-token"?e.jsxs("div",{style:{padding:12},children:[e.jsx("h2",{style:{margin:"0 0 8px 0"},children:"My Sheet"}),e.jsx("p",{style:{margin:"0 0 10px 0",lineHeight:1.35},children:"Select your character token on the map, then click:"}),e.jsx("button",{style:{padding:"8px 10px",borderRadius:8,border:"1px solid #666",cursor:"pointer"},onClick:D,children:"Set Selected Token as My Character"})]}):t.kind==="error"?e.jsxs("div",{style:{padding:12},children:[e.jsx("h2",{style:{margin:"0 0 8px 0"},children:"Error"}),e.jsx("p",{style:{margin:"0 0 10px 0",lineHeight:1.35},children:t.message}),e.jsx("button",{style:{padding:"8px 10px",borderRadius:8,border:"1px solid #666",cursor:"pointer"},onClick:()=>r({kind:"need-token"}),children:"Back"})]}):e.jsxs("div",{style:{padding:12},children:[e.jsxs("div",{style:{display:"flex",alignItems:"flex-start",gap:12,justifyContent:"space-between",marginBottom:10},children:[e.jsxs("div",{style:{display:"flex",gap:10,alignItems:"flex-start"},children:[t.thumbUrl?e.jsx("img",{src:t.thumbUrl,alt:"Token thumbnail",style:{width:44,height:44,borderRadius:10,objectFit:"cover",border:"1px solid rgba(0,0,0,0.2)"}}):e.jsx("div",{style:{width:44,height:44,borderRadius:10,border:"1px solid rgba(0,0,0,0.2)",opacity:.4}}),e.jsxs("div",{children:[e.jsxs("div",{style:{fontSize:18,fontWeight:700},children:[Y," ",e.jsxs("span",{style:{fontSize:12,opacity:.75},children:["(",t.ownerLabel??(t.mode==="view"?"Viewing token":"My Character"),")"]})]}),e.jsxs("div",{style:{fontSize:12,opacity:.8},children:["Token: ",e.jsx("code",{style:{fontSize:11},children:t.tokenId})]})]})]}),e.jsx("div",{style:{display:"flex",gap:8},children:t.mode==="view"?e.jsx("button",{style:{padding:"8px 10px",borderRadius:8,border:"1px solid #999",cursor:"pointer",opacity:.9},onClick:X,children:"Back to My Sheet"}):e.jsx("button",{style:{padding:"8px 10px",borderRadius:8,border:"1px solid #999",cursor:"pointer",opacity:.9},onClick:ae,children:"Unset “My Character”"})})]}),e.jsxs("div",{style:Q.statusBar,children:[e.jsxs("div",{style:Q.statusLeft,children:[e.jsxs("div",{style:Q.statusGroup,children:[e.jsx("div",{style:Q.statusLabel,children:"Stress"}),e.jsx("input",{type:"number",min:0,value:((ke=t.sheet.stress)==null?void 0:ke.current)??0,onChange:n=>u(Number(n.target.value)),style:Q.statusNumber})]}),e.jsxs("div",{style:Q.statusGroup,children:[e.jsx("div",{style:Q.statusLabel,children:"Wounds"}),e.jsxs("div",{style:Q.woundsRow,children:[e.jsx("span",{style:Q.woundsKind,children:"L"}),Array.from({length:4}).map((n,i)=>{var f;return e.jsx("input",{type:"checkbox",checked:(((f=t.sheet.wounds)==null?void 0:f.light)??0)>i,onChange:()=>a("light",i)},`wl_${i}`)}),e.jsx("span",{style:{width:8}}),e.jsx("span",{style:Q.woundsKind,children:"M"}),Array.from({length:2}).map((n,i)=>{var f;return e.jsx("input",{type:"checkbox",checked:(((f=t.sheet.wounds)==null?void 0:f.moderate)??0)>i,onChange:()=>a("moderate",i)},`wm_${i}`)}),e.jsx("span",{style:{width:8}}),e.jsx("span",{style:Q.woundsKind,children:"H"}),Array.from({length:1}).map((n,i)=>{var f;return e.jsx("input",{type:"checkbox",checked:(((f=t.sheet.wounds)==null?void 0:f.heavy)??0)>i,onChange:()=>a("heavy",i)},`wh_${i}`)})]})]}),e.jsxs("label",{style:{display:"flex",alignItems:"center",gap:6},children:[e.jsx("input",{type:"checkbox",checked:!!t.sheet.indomitable,onChange:n=>B(i=>({...i,indomitable:n.target.checked}))}),e.jsx("span",{style:{fontSize:12,opacity:.9},children:"Indomitable"})]}),(((o=t.sheet.stress)==null?void 0:o.current)??0)>(((l=(W??t.sheet).stress)==null?void 0:l.cuf)??0)&&e.jsx("div",{style:Q.warning,children:"Stress > CUF: make all rolls with +1 Penalty Die"}),e.jsxs("div",{style:{fontSize:12,opacity:.85},children:["Bulk: ",H," / ",G]}),A&&e.jsx("div",{style:Q.warning,children:A})]}),e.jsxs("div",{style:Q.statusRight,children:[p&&p.status==="pending"&&e.jsxs("div",{style:Q.crucibleBox,children:[e.jsx("div",{style:{fontWeight:700},children:"Crucible Test!"}),e.jsxs("div",{style:{fontSize:12,opacity:.85},children:["Incoming stress: ",p.incoming," • DC ",p.dc," • Roll CUF (no bonus/penalty dice)"]}),e.jsx("button",{style:Q.buttonSecondary,onClick:()=>void te(p.incoming),children:"Roll Crucible"})]}),p&&p.status==="success"&&e.jsxs("div",{style:Q.crucibleBox,children:[e.jsx("div",{style:{fontWeight:700},children:"Crucible succeeded!"}),e.jsx("div",{style:{fontSize:12,opacity:.85},children:"Choose an Indomitable effect. (Indomitable checked automatically.)"})]}),p&&p.status==="fail"&&e.jsxs("div",{style:Q.crucibleBox,children:[e.jsx("div",{style:{fontWeight:700},children:"Crucible failed"}),e.jsx("div",{style:{fontSize:12,opacity:.85},children:"You’ve entered PTSD range (6–8 stress)."}),e.jsx("button",{style:Q.buttonSecondary,onClick:s,children:"Spend 1 CUF to pass"})]})]})]}),e.jsxs("div",{style:{display:"flex",gap:8,alignItems:"center",marginBottom:10},children:[e.jsx(pe,{label:"Core",active:v==="core",onClick:()=>b("core")}),e.jsx(pe,{label:"Skills",active:v==="skills",onClick:()=>b("skills")}),e.jsx(pe,{label:"Combat",active:v==="combat",onClick:()=>b("combat")}),e.jsx(pe,{label:"Initiative",active:v==="initiative",onClick:()=>b("initiative")}),e.jsx(pe,{label:"Inventory",active:v==="inventory",onClick:()=>b("inventory")}),e.jsx(pe,{label:"Feats",active:v==="feats",onClick:()=>b("feats")}),e.jsx("div",{style:{marginLeft:"auto",opacity:.8},children:T?"Saving…":"Synced"})]}),e.jsxs("div",{style:{border:"1px solid #888",borderRadius:12,padding:10},children:[v==="core"&&e.jsx(Ot,{sheet:W,onChange:n=>B(i=>({...i,...n}))}),v==="skills"&&e.jsx($t,{sheet:W,skillMods:q,onChange:n=>B(i=>({...i,skills:n})),onMetaChange:n=>B(i=>({...i,...n}))}),v==="combat"&&e.jsx(ea,{sheet:W,tokenId:t.tokenId,skillMods:q,onChange:n=>B(i=>({...i,...n})),onApplyStress:u}),v==="initiative"&&e.jsx(ha,{}),v==="inventory"&&e.jsx(ua,{sheet:W,onChange:n=>B(i=>({...i,...n}))}),v==="feats"&&e.jsx(Gt,{sheet:W,onChange:n=>B(i=>({...i,feats:n}))})]})]})}function pe(t){return e.jsx("button",{onClick:t.onClick,style:{padding:"6px 10px",borderRadius:999,border:"1px solid #777",cursor:"pointer",background:"transparent",fontWeight:t.active?700:400},children:t.label})}const Q={statusBar:{display:"flex",alignItems:"flex-start",justifyContent:"space-between",gap:12,padding:"10px 12px",borderRadius:12,border:"1px solid rgba(255,255,255,0.15)",marginBottom:10},statusLeft:{display:"flex",alignItems:"center",gap:16,flexWrap:"wrap"},statusRight:{display:"flex",alignItems:"center",gap:12},statusGroup:{display:"flex",flexDirection:"column",gap:4},statusLabel:{fontSize:11,opacity:.75,letterSpacing:.2},statusNumber:{width:64,fontSize:16},woundsRow:{display:"flex",alignItems:"center",gap:8,flexWrap:"wrap"},woundsKind:{fontSize:11,opacity:.75,width:14,textAlign:"center"},warning:{marginTop:8,fontSize:12,opacity:.9},crucibleBox:{border:"1px solid rgba(255,255,255,0.18)",borderRadius:12,padding:10,maxWidth:240},buttonSecondary:{padding:"6px 10px",borderRadius:8,border:"1px solid #999",cursor:"pointer",opacity:.9,background:"transparent"}};function fa(t){var Y,D,ae,X,ie,B,te,u;const r=((t==null?void 0:t.mode)??"LIGHT")==="DARK"?"dark":"light",v=((Y=t==null?void 0:t.background)==null?void 0:Y.default)??(r==="dark"?"#121212":"#ffffff"),b=((D=t==null?void 0:t.background)==null?void 0:D.paper)??(r==="dark"?"#1e1e1e":"#f7f7f7"),T=((ae=t==null?void 0:t.text)==null?void 0:ae.primary)??(r==="dark"?"#ffffff":"#111111"),S=((X=t==null?void 0:t.text)==null?void 0:X.secondary)??(r==="dark"?"#bdbdbd":"#444444"),p=((ie=t==null?void 0:t.primary)==null?void 0:ie.main)??"#2f6fed",d=((B=t==null?void 0:t.primary)==null?void 0:B.contrastText)??"#ffffff",k=((te=t==null?void 0:t.secondary)==null?void 0:te.main)??"#7c3aed",L=((u=t==null?void 0:t.secondary)==null?void 0:u.contrastText)??"#ffffff";return Lt({palette:{mode:r,background:{default:v,paper:b},text:{primary:T,secondary:S},primary:{main:p,contrastText:d},secondary:{main:k,contrastText:L}},shape:{borderRadius:12},typography:{fontFamily:"system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif"},components:{MuiPaper:{defaultProps:{elevation:0}}}})}function ga(t){const[r,v]=y.useState(null);y.useEffect(()=>{let T=null;return(async()=>{const S=await $.theme.getTheme();v(S),T=$.theme.onChange(p=>v(p))})(),()=>{T&&T()}},[]);const b=y.useMemo(()=>fa(r),[r]);return e.jsxs(Ft,{theme:b,children:[e.jsx(_t,{}),t.children]})}async function pa(){await $.onReady(async()=>{}),wt.createRoot(document.getElementById("root")).render(e.jsx(Ce.StrictMode,{children:e.jsx(ga,{children:e.jsx(xa,{})})}))}pa();
