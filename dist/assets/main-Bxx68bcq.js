import"./modulepreload-polyfill-B5Qt9EMX.js";import{r as S,j as e,d as Ce,e as kt}from"./vendor_react-XzhcIodj.js";import{O as H}from"./vendor_obr-BLY5dk8V.js";import{r as ot,b as Le,s as xe,c as vt,F as jt,a as Je,o as wt,l as Ee,T as ct,d as Ct,e as St,f as It,g as Mt,h as dt,i as et,j as ze,k as Ge,m as Se,n as Dt,u as Tt,p as At,q as Rt,t as _e,v as qe,w as tt,x as we,y as at,z as Et}from"./statusEffects-FykivXLK.js";import{S as _,B as E,T as D,a as We,b as ee,c as x,d as de,I as ie,C as Ie,R as Nt,A as Me,e as De,E as Te,f as Ae,g as me,h as ut,i as ve,P as Pt,D as Fe,L as nt,j as zt,M as ue,k as mt,l as st,m as Lt,n as Wt,o as Ft,p as Bt,q as _t,r as qt,s as Ot,t as Ut,u as Ht,v as $t,w as ht}from"./vendor_mui-COKFTNWy.js";import{r as Yt,O as Gt}from"./ObrMuiThemeProvider-CSO5qWvQ.js";import"./vendor-CPvQcOsy.js";import"./vendor_zod-CxP395f9.js";import"./vendor_emotion-pcfylbOS.js";async function Kt(){const t=await H.player.getSelection();return Array.isArray(t)?t:[]}async function Jt(){const t=await Kt();return t.length>0?t[0]:null}async function Oe(t){return(await H.scene.items.getItems([t])).length>0}const Vt={PHYS:"Physical prowess, stamina, strength, and overall fitness- Each point in Physique increases your carrying capacity - Every point in Physique increases your movement speed by 5ft - Soldiers and brawlers typically have high PHYS",REF:"Quickness of mind and body sometimes bordering on instinct- Reflex is rolled to determine initiative order in combat - Pilots, Martial Artists, and Spiderman are all known for high REF",SOC:"Empathy, charm, quickness of wit, gravitas, personal magnetism, and picking up on social cues- Diplomats and empaths typically have high SOC",MENT:"Acuity, keenness of mind, learning ability, and mental toughness- Scientists, mechanics, and hackers are likely to want high MENT"},Qt={"Melee (weapons)":"Proficiency with melee weapons (bar stools, katanas)","Melee (unarmed)":"Unarmed fighting","Weapons (light)":"Pistols, SMGs","Weapons (medium)":"Shotguns, rifles","Weapons (heavy)":"Autocannons, mortars","Weapons (exotic)":"Experimental weapons, high-tech weaponry","Power Armour":"Use and abuse of the best armour there is",Explosives:"Make things go boom without going boom yourself",Tactics:"Strategic thinking, setting up ambushes perhaps (or spotting where they may be set up by someone else), and other military-type training that focuses your character on the battlefield","Material Sciences":"Chemistry and geology",Computers:"Hacking, coding",Cryptology:"Encoding and decoding secrets and ciphers",Electronics:"Power grids, computer hardware, cybernetics",Engineering:"Ship maintenance, repairing drones, cutting through locked doors, or designing new mechanical parts","First Aid":"Saving lives in emergencies",Forgery:"Making stuff look like stuff it isn’t. Like signatures.",History:"What happened before you were there to see it and why",Linguistics:"Languages. Lots of languages",Research:"Finding information in databases, scientific journals, data centres, etc","Natural Sciences":"Biology, botany, zoology; study of organic creatures and how they work, flora, and fauna",Gunnery:"Shooting things from ships",Navigation:"Figure out the best way to get where you’re going",Piloting:"Flying ships, driving vehicles","Remote Operation":"Using drones or unmanned ships",Sensors:"Interpreting a whole heap of scan data to find anomalies or things of interest","Systems Interface":"Your ability to operate and interact with digital control systems—whether on a starship bridge, station terminal, outpost console, or emergency override panel. Systems Interface governs real-time manipulation of user-facing systems like power reroutes, system lockdowns, navigational tools, environmental controls, and automated safety features."},Xt={attributes:Vt,skills:Qt},ft=Xt,Zt=ft.attributes??{},gt=ft.skills??{},ea=new Map(Object.entries(gt).map(([t,s])=>[t.toLowerCase(),s]));function Ne(t){return Zt[t]??""}function ta(t){return gt[t]??ea.get(String(t??"").toLowerCase())??""}function aa(t){var o;const s=t.sheet,[y,f]=S.useState(0),C=S.useMemo(()=>s.attributes??{phys:0,ref:0,soc:0,ment:0},[s.attributes]);async function p(i,k){const B=Number(C[i]??0),K=Le({netDice:y,modifier:B,label:k});await ot({diceNotation:K,showResults:!0,rollTarget:"everyone"})}return e.jsxs(_,{spacing:2,children:[e.jsxs(E,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",gap:2,flexWrap:"wrap"},children:[e.jsx(D,{variant:"h6",sx:{m:0},children:"Core"}),e.jsxs(E,{sx:{display:"flex",alignItems:"center",gap:1,flexWrap:"wrap"},children:[e.jsx(D,{variant:"subtitle2",sx:{opacity:.8},children:"Attribute Roll:"}),e.jsxs(We,{size:"small",exclusive:!0,value:y,onChange:(i,k)=>{k!==null&&f(k)},children:[e.jsx(ee,{value:-2,children:"−2"}),e.jsx(ee,{value:-1,children:"−1"}),e.jsx(ee,{value:0,children:"0"}),e.jsx(ee,{value:1,children:"+1"}),e.jsx(ee,{value:2,children:"+2"})]})]})]}),e.jsx(x,{label:"Name",size:"small",value:s.name??"",onChange:i=>t.onChange({name:i.target.value}),fullWidth:!0}),e.jsxs(E,{sx:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:1},children:[e.jsx(Pe,{label:"PHYS",tooltip:Ne("PHYS"),value:C.phys,onRoll:()=>p("phys","PHYS Check")}),e.jsx(Pe,{label:"REF",tooltip:Ne("REF"),value:C.ref,onRoll:()=>p("ref","REF Check")}),e.jsx(Pe,{label:"SOC",tooltip:Ne("SOC"),value:C.soc,onRoll:()=>p("soc","SOC Check")}),e.jsx(Pe,{label:"MENT",tooltip:Ne("MENT"),value:C.ment,onRoll:()=>p("ment","MENT Check")})]}),e.jsxs(E,{sx:{display:"grid",gridTemplateColumns:"repeat(3, 1fr)",gap:2},children:[e.jsx(x,{label:"Cool Under Fire",size:"small",value:((o=t.sheet.stress)==null?void 0:o.cuf)??0,inputProps:{readOnly:!0},fullWidth:!0}),e.jsx(x,{label:"Speed",size:"small",value:30+(C.phys??0)*5,inputProps:{readOnly:!0},fullWidth:!0}),e.jsx(x,{label:"Carrying Capacity",size:"small",value:5+(C.phys??0)*5,inputProps:{readOnly:!0},fullWidth:!0})]}),e.jsx(D,{variant:"body2",sx:{opacity:.75},children:"Attributes are derived automatically from skill ranks (¼ of total ranks under each attribute, rounded up)."})]})}function Pe(t){return e.jsxs(E,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(de,{title:t.tooltip||"",disableHoverListener:!t.tooltip,children:e.jsx(E,{sx:{flex:1},children:e.jsx(x,{label:t.label,size:"small",value:t.value,inputProps:{readOnly:!0},fullWidth:!0})})}),e.jsx(de,{title:"Roll with Dice+",children:e.jsx(ie,{onClick:t.onRoll,"aria-label":`Roll ${t.label}`,children:e.jsx(Ie,{})})})]})}function Ve(){const t=new Map;return Object.keys(xe.learned).forEach(s=>{(xe.learned[s]??[]).forEach(y=>t.set(y.id,{focus:s}))}),t}function xt(t){var i,k;const s=String(t.skillId??""),y=((i=t.sheet.skills)==null?void 0:i[s])??0,f=((k=t.skillMods)==null?void 0:k[s])??0;if(y>0)return y+f;const C=t.sheet.learningFocus??"combat",p=t.learnedInfoById.get(s);return(p&&p.focus===C?0:-1)+f}const na=["phys","ref","soc","ment"],Ue={phys:"PHYSIQUE",ref:"REFLEX",soc:"SOCIAL",ment:"MENTAL"},He={combat:"Combat",education:"Education",vehicles:"Vehicles"},it={combat:"Combat Focus",education:"Education Focus",vehicles:"Vehicles Focus"};function $e(t){const s=yt(t,0,5);return s*(s+1)/2}function sa(t){const[s,y]=S.useState(""),[f,C]=S.useState(0),[p,o]=S.useState(!0),[i,k]=S.useState(!1),[B,K]=S.useState(""),v=t.sheet.skills??{},P=t.sheet.learningFocus??"combat",te=Number(t.sheet.skillPoints??0);S.useEffect(()=>{let c=!1;return(async()=>{const g=await vt();c||(o(g),k(!0))})().catch(()=>{c||(o(!1),k(!0))}),()=>{c=!0}},[]);const re=S.useMemo(()=>Ve(),[]);function le(c){const g=re.get(c.id);return g?g.focus===P?5:2:5}function Z(c){var V;const g=v[c.id]??0,W=((V=t.skillMods)==null?void 0:V[c.id])??0;if(g>0)return g+W;const Y=re.get(c.id);return Y&&Y.focus===P?0+W:-1+W}const m=S.useMemo(()=>{let c=0;for(const g of Object.values(v))c+=$e(g??0);return c},[v]),a=Math.max(0,te-m),n=c=>{const g=Math.max(0,Math.trunc(Number(B)));if(!g)return;const W=te+c*g,Y=Math.max(m,W);t.onMetaChange({skillPoints:Y}),K("")};function T(c){t.onChange(c)}function j(c,g){const W=v[c.id]??0,Y=le(c),V=yt(g,0,Y);if(V===W||$e(V)-$e(W)>a)return;const he={...v};V===0?delete he[c.id]:he[c.id]=V,T(he)}async function A(c){const g=Le({netDice:f,modifier:Z(c),label:c.label});try{await ot({diceNotation:g,showResults:!0,rollTarget:"everyone"})}catch(W){console.error("Dice+ roll request failed:",W)}}const h=S.useMemo(()=>{const c=Object.values(xe.learned).flat();return[...xe.inherent,...c]},[]),L=S.useMemo(()=>{const c=s.trim().toLowerCase();return c?h.filter(g=>g.label.toLowerCase().includes(c)||g.id.toLowerCase().includes(c)):h},[h,s]),J=S.useMemo(()=>ia(xe.inherent),[]),w=S.useMemo(()=>xe.learned,[]),O=s.trim().length>0,X=e.jsxs(E,{sx:{display:"flex",alignItems:"center",gap:2,flexWrap:"wrap"},children:[e.jsx(D,{variant:"subtitle2",sx:{opacity:.8},children:"Learning Focus:"}),Object.keys(it).map(c=>e.jsxs(E,{sx:{display:"flex",alignItems:"center",gap:.5,cursor:"pointer"},onClick:()=>t.onMetaChange({learningFocus:c}),children:[e.jsx(Nt,{checked:P===c,value:c,size:"small"}),e.jsx(D,{variant:"body2",children:He[c]})]},c))]}),$=e.jsx(E,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",gap:2,flexWrap:"wrap"},children:e.jsxs(E,{sx:{display:"flex",alignItems:"center",gap:1,flexWrap:"wrap"},children:[e.jsxs(D,{variant:"subtitle2",sx:{minWidth:170},children:["Skill Points: ",a," ",e.jsxs("span",{style:{opacity:.75},children:["(Total: ",te,")"]})]}),e.jsx(me,{size:"small",variant:"outlined",onClick:()=>n(1),disabled:!Number.isFinite(Number(B))||Math.trunc(Number(B))<=0,children:"+"}),e.jsx(x,{label:"SP",size:"small",type:"number",value:B,onChange:c=>K(c.target.value),sx:{width:110}}),e.jsx(me,{size:"small",variant:"outlined",onClick:()=>n(-1),disabled:!Number.isFinite(Number(B))||Math.trunc(Number(B))<=0,children:"-"}),e.jsx(D,{variant:"subtitle2",sx:{opacity:.8},children:"Roll"}),e.jsxs(We,{size:"small",exclusive:!0,value:f,onChange:(c,g)=>{g!==null&&C(g)},"aria-label":"Bonus / Penalty dice",children:[e.jsx(ee,{value:-2,children:"−2"}),e.jsx(ee,{value:-1,children:"−1"}),e.jsx(ee,{value:0,children:"0"}),e.jsx(ee,{value:1,children:"+1"}),e.jsx(ee,{value:2,children:"+2"})]}),i&&!p&&e.jsx(D,{variant:"caption",sx:{opacity:.8},children:"(Dice+ not detected)"})]})});return e.jsxs(_,{spacing:2,children:[X,e.jsx(x,{label:"Search skills",value:s,onChange:c=>y(c.target.value),placeholder:"stealth, weapons, navigation…",fullWidth:!0}),$,O?e.jsx(_,{spacing:1,children:L.map(c=>{const g=re.get(c.id),W=g?He[g.focus]:Ue[c.attribute];return e.jsx(Ye,{skill:c,rank:v[c.id]??0,modifier:Z(c),maxRank:le(c),onRank:Y=>j(c,Y),rightTag:W,canRoll:p,onRoll:()=>A(c)},c.id)})}):e.jsxs(e.Fragment,{children:[e.jsx(D,{variant:"subtitle1",children:"Inherent Skills"}),na.map(c=>e.jsxs(Me,{defaultExpanded:!0,children:[e.jsx(De,{expandIcon:e.jsx(Te,{}),children:e.jsx(D,{fontWeight:700,children:Ue[c]})}),e.jsx(Ae,{children:e.jsx(_,{spacing:1,children:(J[c]??[]).map(g=>e.jsx(Ye,{skill:g,rank:v[g.id]??0,modifier:Z(g),maxRank:le(g),onRank:W=>j(g,W),rightTag:Ue[g.attribute],canRoll:p,onRoll:()=>A(g)},g.id))})})]},c)),e.jsx(D,{variant:"subtitle1",sx:{mt:1},children:"Learned Skills"}),Object.keys(w).map(c=>e.jsxs(Me,{defaultExpanded:!0,children:[e.jsx(De,{expandIcon:e.jsx(Te,{}),children:e.jsx(D,{fontWeight:700,children:it[c]})}),e.jsx(Ae,{children:e.jsx(_,{spacing:1,children:(w[c]??[]).map(g=>e.jsx(Ye,{skill:g,rank:v[g.id]??0,modifier:Z(g),maxRank:le(g),onRank:W=>j(g,W),rightTag:He[c],canRoll:p,onRoll:()=>A(g)},g.id))})})]},c))]})]})}function Ye(t){const s=t.rank<t.maxRank,y=t.rank>0,f=ta(t.skill.label);return e.jsxs(E,{sx:{display:"grid",gridTemplateColumns:"1fr auto auto auto",gap:1,alignItems:"center",border:"1px solid",borderColor:"divider",borderRadius:2,px:1.25,py:1},children:[e.jsxs(E,{sx:{minWidth:0},children:[e.jsx(de,{title:f,disableHoverListener:!f,children:e.jsx(D,{fontWeight:600,noWrap:!0,children:t.skill.label})}),e.jsx(D,{variant:"caption",sx:{opacity:.7},noWrap:!0,children:t.rightTag??""})]}),e.jsxs(E,{sx:{width:46,textAlign:"center"},children:[e.jsx(D,{variant:"caption",sx:{opacity:.7,lineHeight:1},children:"Mod"}),e.jsx(D,{sx:{fontWeight:700,lineHeight:1.2},children:t.modifier>=0?`+${t.modifier}`:`${t.modifier}`})]}),e.jsxs(E,{sx:{width:40,textAlign:"center"},children:[e.jsx(D,{variant:"caption",sx:{opacity:.7,lineHeight:1},children:"Rank"}),e.jsx(D,{sx:{fontWeight:700,lineHeight:1.2},children:t.rank})]}),e.jsxs(E,{sx:{display:"flex",gap:.5,alignItems:"center",justifyContent:"flex-end"},children:[e.jsx(ie,{size:"small",onClick:()=>t.onRank(t.rank-1),"aria-label":"Decrease rank",disabled:!y,children:e.jsx(ut,{fontSize:"small"})}),e.jsx(ie,{size:"small",onClick:()=>t.onRank(t.rank+1),"aria-label":"Increase rank",disabled:!s,children:e.jsx(ve,{fontSize:"small"})}),e.jsx(E,{sx:{width:6}}),e.jsx(de,{title:t.canRoll?"Roll with Dice+":"Dice+ not detected",children:e.jsx("span",{children:e.jsx(ie,{size:"small",onClick:t.onRoll,"aria-label":`Roll ${t.skill.label}`,disabled:!t.canRoll,children:e.jsx(Ie,{fontSize:"small"})})})})]})]})}function ia(t){return t.reduce((s,y)=>{var f;return(s[f=y.attribute]??(s[f]=[])).push(y),s},{})}function yt(t,s,y){const f=Number.isFinite(t)?Math.trunc(t):s;return Math.max(s,Math.min(y,f))}function ra(t){const s=t.sheet.feats??[];function y(){t.onChange([...s,{name:"New Feat",description:"",statusEffects:""}])}function f(p,o){const i=[...s];i[p]={...i[p],...o},jt.safeParse(i[p]),t.onChange(i)}function C(p){const o=[...s];o.splice(p,1),t.onChange(o)}return e.jsxs(_,{spacing:2,children:[e.jsxs(_,{direction:"row",justifyContent:"space-between",alignItems:"center",children:[e.jsx(D,{variant:"h6",children:"Feats"}),e.jsx(me,{variant:"contained",startIcon:e.jsx(ve,{}),onClick:y,children:"Add Feat"})]}),s.length===0?e.jsx(D,{variant:"body2",sx:{opacity:.75},children:"No feats yet."}):e.jsx(_,{spacing:2,children:s.map((p,o)=>e.jsx(Pt,{sx:{p:2},children:e.jsxs(_,{spacing:1.5,children:[e.jsxs(_,{direction:"row",spacing:1,alignItems:"center",children:[e.jsx(x,{label:"Feat Name",fullWidth:!0,value:p.name,onChange:i=>f(o,{name:i.target.value})}),e.jsx(ie,{"aria-label":"Remove feat",onClick:()=>C(o),children:e.jsx(Fe,{})})]}),e.jsx(x,{label:"Description",fullWidth:!0,multiline:!0,minRows:4,value:p.description,onChange:i=>f(o,{description:i.target.value})}),e.jsx(x,{label:"Status Effects",fullWidth:!0,helperText:'Comma-separated, e.g. "carrying_capacity+5"',value:p.statusEffects??"",onChange:i=>f(o,{statusEffects:i.target.value})})]})},`${p.name}-${o}`))})]})}const la=[{id:"pistol",name:"Pistol",skillId:"weapons_light",useDC:7,damage:2,range:"Med",ammo:10,bulk:1,cost:500},{id:"smart_pistol",name:"SMART Pistol",skillId:"weapons_light",useDC:9,damage:4,range:"Med",ammo:6,bulk:1,cost:900,keywords:["Smart-Linked"]},{id:"toxic_spike",name:"Toxic Spike",skillId:"weapons_light",useDC:10,damage:3,range:"Near",ammo:1,bulk:1,cost:750,keywords:["Toxin (Prax)","Concealable"]},{id:"smg",name:"SMG",skillId:"weapons_medium",useDC:6,damage:3,range:"Med",ammo:8,bulk:2,cost:600,keywords:["Bullet Spray"]},{id:"photon_rifle",name:"Photon Rifle",skillId:"weapons_medium",useDC:8,damage:6,range:"Long",ammo:6,bulk:3,cost:5e3,keywords:["Two-Handed"]},{id:"rifle",name:"Rifle",skillId:"weapons_medium",useDC:8,damage:4,range:"Long",ammo:8,bulk:2,cost:1e3,keywords:["Two-Handed","Piercing 1"]},{id:"shotgun",name:"Shotgun",skillId:"weapons_medium",useDC:8,damage:4,range:"Near",ammo:4,bulk:3,cost:800,req:"PHYS 1",keywords:["Point Blank","Shredding 1"]},{id:"gauss_cannon",name:"Gauss Cannon",skillId:"weapons_heavy",useDC:7,damage:4,range:"Med",ammo:20,bulk:4,cost:900,req:"PHYS 3",keywords:["Bullet Spray"]},{id:"grenade_launcher",name:"Grenade Launcher",skillId:"weapons_heavy",useDC:8,damage:3,range:"Med",ammo:1,bulk:3,cost:2e3,req:"PHYS 2",keywords:["Area (Very Near)","Two-Handed","Slow Load","Grenade"]},{id:"magneton_cannon",name:"Magneton Cannon",skillId:"weapons_exotic",useDC:5,damage:2,range:"Near",ammo:5,bulk:2,cost:8e3,req:"PHYS 1",keywords:["Area (melee)","Slow Load","Shredding 3"]},{id:"tesla_rifle",name:"Tesla Rifle",skillId:"weapons_exotic",useDC:8,damage:5,range:"Med",ammo:6,bulk:2,cost:6e3,keywords:["Two-Handed","Stun 2"]},{id:"stun_baton",name:"Stun Baton",skillId:"melee_weapons",useDC:6,damage:0,range:"Melee",ammo:0,bulk:1,cost:450,keywords:["Stun 1"]},{id:"switchblade",name:"Switchblade",skillId:"melee_weapons",useDC:9,damage:2,range:"Melee",ammo:0,bulk:1,cost:150,keywords:["Concealable","Thrown"]},{id:"fusion_blade",name:"Fusion Blade",skillId:"melee_weapons",useDC:8,damage:3,range:"Melee",ammo:0,bulk:2,cost:1200,req:"REF 2",keywords:["Piercing 2"]},{id:"rocket_maul",name:"Rocket Maul",skillId:"melee_weapons",useDC:10,damage:6,range:"Melee",ammo:2,bulk:3,cost:2500,req:"PHYS 3",keywords:["Two-Handed"]}],oa={weapons:la},rt=oa.weapons??[],ca=[{id:"scrap_armour",name:"Scrap Armour",protection:1,durability:2,bulk:2,cost:500,special:"Cannot be repaired"},{id:"flak_jacket",name:"Flak Jacket",protection:1,durability:4,bulk:1,cost:1250},{id:"kevlar_clothing",name:"Kevlar Clothing",protection:1,durability:3,bulk:1,cost:1500,special:"Appears to be normal clothing"},{id:"streetweave_jacket",name:"Streetweave Jacket",protection:1,durability:5,bulk:1,cost:2500,special:"+1 to Stealth"},{id:"milsec_bodyplate",name:"MilSec Bodyplate",protection:2,durability:6,bulk:2,cost:5e3},{id:"breaching_plate",name:"Breaching plate",protection:2,durability:4,bulk:3,cost:8500,req:"PHYS 2",special:"Frontal Shielding 1"},{id:"heavy_bodyplate",name:"Heavy Bodyplate",protection:3,durability:8,bulk:4,cost:1e4,req:"PHYS 3",special:"+1 penalty die to Stealth"},{id:"basic_power_armour",name:"Basic Power Armour",protection:4,durability:14,bulk:10,cost:4e4,req:"Power Armour 1",special:"Requires Power Armour (DC5) check to activate. Failure: become Immobile; gain +1 penalty die to all PHYS and REF based checks. When activated, reduces its own bulk to 1 and grants +1 bonus die to all PHYS based checks."}],da={armor:ca},lt=da.armor??[],Ke="whisperspace.obr.sheet/combat-log";function ua(t){return t>=9?4:t>=7?3:t>=4?2:0}async function ma(t){const s=Number.isFinite(t.useDC)?Math.trunc(t.useDC):Math.trunc(t.weapon.useDC),y=t.weapon.name||"Attack",f=Le({netDice:t.netDice,modifier:t.modifier,label:y}),C=await Je({diceNotation:f,rollTarget:t.rollTarget??"everyone",showResults:t.showResults??!0}),p=C-s,o=C>=s,i=o?ua(p):0,k=o&&i>0,B=Math.trunc(t.weapon.damage??0),K=o?B+i:0,v=k?1:0;let P;o?k?P=`Extreme success - crit! ${y} rolled ${C} vs DC ${s}. Damage: ${B}+${i}=${K}. (+1 Stress)`:P=`Hit. ${y} rolled ${C} vs DC ${s}. Damage: ${B}.`:P=`Miss. ${y} rolled ${C} vs DC ${s}.`,t.prefix&&(P=`${t.prefix} ${P}`);const te={text:P,ts:Date.now(),kind:"attack",attackerName:t.attackerName,weaponName:y,outcome:{total:C,useDC:s,hit:o,isCrit:k,baseDamage:B,totalDamage:K,stressDelta:v}};return H.broadcast.sendMessage(Ke,te,{destination:"ALL"}),{total:C,useDC:s,margin:p,hit:o,isCrit:k,critExtra:i,baseDamage:B,totalDamage:K,stressDelta:v,message:P}}const bt=ma;function pt(t){var J,w;const s=Number.isFinite(t.incomingDamage)?Math.max(0,Math.trunc(t.incomingDamage)):0;if(s<=0&&!(t.stressDelta&&t.stressDelta>0))return{sheet:t.sheet,stressDelta:0};const y=!!t.unmitigated,f=t.sheet.armor,C=(((J=f==null?void 0:f.durability)==null?void 0:J.current)??0)<=0,p=y||C?0:(f==null?void 0:f.protection)??0,o=Math.max(0,s-p),i=t.sheet.wounds??{light:0,moderate:0,heavy:0};let k=i.light??0,B=i.moderate??0,K=i.heavy??0,v=o,P=0,te=0,re=0;const Z=Math.min(v,Math.max(0,4-k));k+=Z,v-=Z,P=Z;const a=Math.min(v,Math.max(0,2-B));B+=a,v-=a,te=a;const T=Math.min(v,Math.max(0,1-K));K+=T,v-=T,re=T;const j={light:k,moderate:B,heavy:K};let A=0;re>0?A=4:te>0?A=2:P>0&&(A=1),t.stressDelta&&t.stressDelta>0&&(A+=Math.trunc(t.stressDelta));let h=f;!y&&!C&&o>0&&(f!=null&&f.durability)&&(h={...f,durability:{...f.durability,current:Math.max(0,Math.trunc((f.durability.current??0)-1))}});const L=Math.max(0,Math.trunc((((w=t.sheet.stress)==null?void 0:w.current)??0)+A));return{sheet:{...t.sheet,wounds:j,armor:h,stress:{...t.sheet.stress??{current:0,cuf:0,cufLoss:0},current:L}},stressDelta:A}}function pe(t){var f;if(!t)return 0;const s=(f=t.keywordParams)==null?void 0:f.ammoMax,y=typeof s=="number"?s:typeof s=="string"?Number(s):void 0;return Number.isFinite(y)?Number(y):0}function ha(t){const s="#e55353",y="#8b5cf6",f="#5b6bff",C="#26a269",p="#d64040";return e.jsxs(E,{sx:{border:"1px solid",borderColor:"divider",borderRadius:2,p:1.25},children:[e.jsx(D,{variant:"subtitle2",sx:{opacity:.8,mb:.5},children:"Combat Log"}),t.entries.length===0?e.jsx(D,{variant:"body2",sx:{opacity:.7},children:"No recent rolls."}):e.jsx(_,{spacing:.75,children:t.entries.map(o=>{var Z,m,a,n,T;const i=!!((Z=o.outcome)!=null&&Z.hit)&&((((m=o.outcome)==null?void 0:m.totalDamage)??0)>0||(((a=o.outcome)==null?void 0:a.stressDelta)??0)>0)&&!!t.onApply,k=i&&(((n=o.outcome)==null?void 0:n.totalDamage)??0)>0,B=i&&(((T=o.outcome)==null?void 0:T.stressDelta)??0)>0,K=k&&B,v=o.outcome,P=v!=null&&v.hit?"Hit":"Miss",te=v!=null&&v.hit?C:p,re=o.attackerName??"Unknown",le=o.weaponName??"Attack";return e.jsxs(E,{sx:{display:"flex",alignItems:"center",gap:1,flexWrap:"wrap"},children:[e.jsx(D,{variant:"body2",sx:{flex:"1 1 260px"},children:o.kind==="effect"?e.jsxs(e.Fragment,{children:[e.jsx("strong",{children:o.targetName??"Target"})," ",(o.damageApplied??0)>0&&e.jsxs(e.Fragment,{children:["took"," ",e.jsx("strong",{style:{color:s},children:o.damageApplied})," ","damage"]}),(o.damageApplied??0)>0&&(o.stressApplied??0)>0&&" and ",(o.damageApplied??0)<=0&&(o.stressApplied??0)>0&&"took ",(o.stressApplied??0)>0&&e.jsxs(e.Fragment,{children:[e.jsx("strong",{style:{color:y},children:o.stressApplied})," ","stress"]}),"."]}):e.jsxs(e.Fragment,{children:[e.jsx("strong",{children:re}),": ",e.jsx("strong",{children:le})," rolled"," ",(v==null?void 0:v.total)??0," vs DC ",(v==null?void 0:v.useDC)??0,"."," ",v!=null&&v.isCrit?e.jsxs(e.Fragment,{children:[e.jsx("strong",{style:{color:C},children:"Extreme success - "}),e.jsx("strong",{style:{color:f},children:"crit!"})]}):e.jsx("strong",{style:{color:te},children:P}),(v==null?void 0:v.hit)&&e.jsxs(e.Fragment,{children:[". Damage:"," ",e.jsx("strong",{style:{color:s},children:(v==null?void 0:v.totalDamage)??0}),v!=null&&v.stressDelta?e.jsxs(e.Fragment,{children:[" "," (+"," ",e.jsx("strong",{style:{color:y},children:v.stressDelta})," ","Stress)"]}):null]}),"."]})}),k&&e.jsx(me,{size:"small",variant:"outlined",startIcon:e.jsx(nt,{fontSize:"small"}),onClick:()=>{var j,A;return(A=t.onApply)==null?void 0:A.call(t,{...o,kind:"attack",damageApplied:((j=o.outcome)==null?void 0:j.totalDamage)??0,stressApplied:0})},children:"Apply Damage"}),B&&e.jsx(me,{size:"small",variant:"outlined",startIcon:e.jsx(zt,{fontSize:"small"}),onClick:()=>{var j,A;return(A=t.onApply)==null?void 0:A.call(t,{...o,kind:"attack",damageApplied:0,stressApplied:((j=o.outcome)==null?void 0:j.stressDelta)??0})},children:"Apply Stress"}),K&&e.jsx(me,{size:"small",variant:"outlined",startIcon:e.jsx(nt,{fontSize:"small"}),onClick:()=>{var j,A,h;return(h=t.onApply)==null?void 0:h.call(t,{...o,kind:"attack",damageApplied:((j=o.outcome)==null?void 0:j.totalDamage)??0,stressApplied:((A=o.outcome)==null?void 0:A.stressDelta)??0})},children:"Apply Both"})]},o.ts)})})]})}function fa(t){var X,$,c,g,W,Y,V,q,he,ke,Be,ye;const s=t.sheet,[y,f]=S.useState(0),[C,p]=S.useState(null),[o,i]=S.useState(""),[k,B]=S.useState(!1),K=(t.combatLog??[]).slice(-3).reverse(),v=S.useMemo(()=>Ve(),[]),P=S.useMemo(()=>{const l=Object.values(xe.learned).flat();return[...xe.inherent,...l]},[]),te=new Set(["melee_weapons","melee_unarmed","weapons_light","weapons_medium","weapons_heavy","weapons_exotic","explosives"]),re=P.filter(l=>te.has(l.id));S.useMemo(()=>[...P].sort((l,d)=>l.label.localeCompare(d.label)),[P]);function le(){var Q;const l=Number(o),d=Number.isFinite(l)?Math.max(0,Math.trunc(l)):0;if(d<=0)return;const b=pt({sheet:t.sheet,incomingDamage:d,unmitigated:k});t.onChange({wounds:b.sheet.wounds,armor:b.sheet.armor,stress:b.sheet.stress}),b.stressDelta>0&&t.onApplyStress&&t.onApplyStress(((Q=b.sheet.stress)==null?void 0:Q.current)??0),i("")}function Z(l){return xt({learnedInfoById:v,sheet:s,skillId:l,skillMods:t.skillMods})}function m(l,d){const b=[...s.weapons??[]],Q=b[l];if(d.ammo!==void 0&&!pe(Q)&&d.ammo>0){const Re={...Q.keywordParams??{},ammoMax:d.ammo};b[l]={...Q,...d,keywordParams:Re},t.onChange({weapons:b});return}b[l]={...Q,...d},t.onChange({weapons:b})}function a(l,d){if(l===null||l===d)return;const b=t.sheet.weapons??[];if(l<0||l>=b.length||d<0||d>=b.length)return;const Q=[...b],[be]=Q.splice(l,1);Q.splice(d,0,be),t.onChange({weapons:Q}),p(d)}function n(l){const d=rt.find(Q=>Q.id===l);if(!d)return;const b=[...s.weapons??[]];b.push({name:d.name,skillId:d.skillId,useDC:d.useDC,damage:d.damage,range:d.range,ammo:d.ammo,bulk:d.bulk,req:d.req,cost:d.cost,keywords:[...d.keywords??[]],keywordParams:{ammoMax:d.ammo??0,...d.keywordParams??{}}}),t.onChange({weapons:b})}function T(){const l=[...s.weapons??[]];l.push({name:"New Weapon",skillId:"weapons_medium",useDC:8,damage:3,range:"Med",ammo:0,bulk:1,req:"",cost:0,keywords:[],keywordParams:{ammoMax:0}}),t.onChange({weapons:l})}function j(l){const d=[...s.weapons??[]];d.splice(l,1),t.onChange({weapons:d})}async function A(l,d){const b=pe(d),Q=Number.isFinite(d.ammo)?Number(d.ammo):0;if(b>0&&Q<=0){H.notification.show("Out of ammo. Reload first.","WARNING");return}const be=Z(d.skillId);await bt({weapon:d,useDC:Number.isFinite(d.useDC)?Number(d.useDC):0,netDice:y,modifier:be,attackerName:t.sheet.name,rollTarget:"everyone",showResults:!0}),b>0&&m(l,{ammo:Math.max(0,Q-1)})}const[h,L]=S.useState(""),[J,w]=S.useState("");function O(l){const d=lt.find(b=>b.id===l);d&&t.onChange({armor:{name:d.name,keywords:[...d.keywords??[]],keywordParams:{...d.keywordParams??{}},protection:d.protection,durability:{current:d.durability,max:d.durability},bulk:d.bulk,req:d.req,cost:d.cost,special:d.special}})}return e.jsxs(_,{spacing:2,children:[e.jsx(E,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",gap:2,flexWrap:"wrap"},children:e.jsx(D,{variant:"h6",sx:{m:0},children:"Combat"})}),e.jsxs(E,{sx:{display:"flex",alignItems:"center",gap:1,flexWrap:"wrap"},children:[e.jsx(D,{variant:"subtitle2",sx:{opacity:.8},children:"Take Damage:"}),e.jsx(x,{size:"small",type:"number",inputProps:{min:0},value:o,onChange:l=>i(l.target.value),sx:{width:90}}),e.jsx(ee,{size:"small",value:"unmitigated",selected:k,onChange:()=>B(l=>!l),children:"Unmitigated"}),e.jsx(me,{size:"small",variant:"outlined",onClick:le,children:"Apply"})]}),e.jsxs(E,{sx:{display:"flex",alignItems:"center",gap:1,flexWrap:"wrap"},children:[e.jsx(D,{variant:"subtitle2",sx:{opacity:.8},children:"Attack Roll:"}),e.jsxs(We,{size:"small",exclusive:!0,value:y,onChange:(l,d)=>{d!==null&&f(d)},children:[e.jsx(ee,{value:-2,children:"−2"}),e.jsx(ee,{value:-1,children:"−1"}),e.jsx(ee,{value:0,children:"0"}),e.jsx(ee,{value:1,children:"+1"}),e.jsx(ee,{value:2,children:"+2"})]})]}),e.jsx(ha,{entries:K,onApply:t.onApplyCombatLog}),e.jsxs(Me,{defaultExpanded:!0,children:[e.jsx(De,{expandIcon:e.jsx(Te,{}),children:e.jsx(D,{fontWeight:700,children:"Weapons"})}),e.jsx(Ae,{children:e.jsxs(_,{spacing:1.5,children:[e.jsxs(E,{sx:{display:"flex",gap:1,alignItems:"center",flexWrap:"wrap"},children:[e.jsxs(x,{label:"Add prefab weapon",size:"small",select:!0,value:h,onChange:l=>L(l.target.value),sx:{minWidth:240},children:[e.jsx(ue,{value:"",children:"— choose —"}),rt.map(l=>e.jsx(ue,{value:l.id,children:l.name},l.id))]}),e.jsx(ie,{color:"primary",onClick:()=>n(h),"aria-label":"Add prefab weapon",disabled:!h,children:e.jsx(ve,{})}),e.jsx(E,{sx:{flex:1}}),e.jsx(ie,{color:"primary",onClick:T,"aria-label":"Add custom weapon",children:e.jsx(ve,{})}),e.jsx(D,{variant:"body2",sx:{opacity:.75},children:"Add custom weapon"})]}),(s.weapons??[]).length===0?e.jsx(D,{sx:{opacity:.75},children:"No weapons yet."}):(s.weapons??[]).map((l,d)=>e.jsxs(E,{draggable:!0,onDragStart:()=>p(d),onDragEnd:()=>p(null),onDragOver:b=>{b.preventDefault()},onDrop:b=>{b.preventDefault(),a(C,d)},sx:{border:"1px solid",borderColor:"divider",borderRadius:2,p:1.25,cursor:"grab",opacity:C===d?.85:1,display:"grid",gap:1.25},children:[e.jsxs(E,{sx:{display:"flex",gap:1,alignItems:"center"},children:[e.jsx(x,{label:"Name",size:"small",value:l.name,onChange:b=>m(d,{name:b.target.value}),fullWidth:!0}),e.jsx(de,{title:"Roll attack with Dice+",children:e.jsx(ie,{onClick:()=>A(d,l),"aria-label":`Roll attack for ${l.name}`,children:e.jsx(Ie,{})})}),e.jsx(ie,{onClick:()=>j(d),"aria-label":"Remove weapon",children:e.jsx(Fe,{})})]}),e.jsxs(E,{sx:{display:"grid",gridTemplateColumns:"1fr 1fr 1fr 1fr",gap:1},children:[e.jsx(x,{label:"Skill",size:"small",select:!0,value:l.skillId,onChange:b=>m(d,{skillId:b.target.value}),children:re.map(b=>e.jsx(ue,{value:b.id,children:b.label},b.id))}),e.jsx(x,{label:"Use DC",size:"small",type:"number",value:l.useDC,onChange:b=>m(d,{useDC:Number(b.target.value)})}),e.jsx(x,{label:"Damage",size:"small",type:"number",value:l.damage,onChange:b=>m(d,{damage:Number(b.target.value)})}),e.jsx(x,{label:"Range",size:"small",value:l.range??"",onChange:b=>m(d,{range:b.target.value}),placeholder:"Melee / Short / Med / Long"}),e.jsxs(E,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(x,{label:"Ammo",size:"small",type:"number",value:l.ammo??0,onChange:b=>m(d,{ammo:Number(b.target.value)}),sx:{width:110}}),e.jsxs(D,{variant:"body2",sx:{opacity:.8},children:["/ ",pe(l)||0]}),e.jsx(de,{title:"Reload",children:e.jsx("span",{children:e.jsx(ie,{size:"small",onClick:()=>m(d,{ammo:pe(l)||0}),disabled:(pe(l)||0)<=0,children:e.jsx(mt,{fontSize:"small"})})})})]}),e.jsx(x,{label:"Bulk",size:"small",type:"number",value:l.bulk??0,onChange:b=>m(d,{bulk:Number(b.target.value)})}),e.jsx(x,{label:"Req.",size:"small",value:l.req??"",onChange:b=>m(d,{req:b.target.value}),placeholder:"PHYS 1 / REF 2 / etc"}),e.jsx(x,{label:"Keywords (comma)",size:"small",value:(l.keywords??[]).join(", "),onChange:b=>m(d,{keywords:b.target.value.split(",").map(Q=>Q.trim()).filter(Boolean)}),placeholder:"Two-Handed, Piercing 1",sx:{gridColumn:"1 / -1"}}),(l.keywords??[]).length>0&&e.jsx(E,{sx:{gridColumn:"1 / -1",display:"flex",flexWrap:"wrap",gap:.5},children:(l.keywords??[]).map((b,Q)=>{const be=Yt(b);return be?e.jsx(de,{title:be.description,children:e.jsx("span",{children:e.jsx(st,{label:b,size:"small",variant:"outlined"})})},`${b}-${Q}`):e.jsx(st,{label:b,size:"small",variant:"outlined"},`${b}-${Q}`)})})]})]},l.id??`${l.name}-${d}`))]})})]}),e.jsxs(Me,{defaultExpanded:!0,children:[e.jsx(De,{expandIcon:e.jsx(Te,{}),children:e.jsx(D,{fontWeight:700,children:"Armor"})}),e.jsx(Ae,{children:e.jsxs(_,{spacing:1.5,children:[e.jsxs(E,{sx:{display:"flex",gap:1,alignItems:"center",flexWrap:"wrap"},children:[e.jsxs(x,{label:"Set prefab armor",size:"small",select:!0,value:J,onChange:l=>w(l.target.value),sx:{minWidth:240},children:[e.jsx(ue,{value:"",children:"— choose —"}),lt.map(l=>e.jsx(ue,{value:l.id,children:l.name},l.id))]}),e.jsx(ie,{color:"primary",onClick:()=>O(J),"aria-label":"Set prefab armor",disabled:!J,children:e.jsx(ve,{})})]}),e.jsxs(E,{sx:{border:"1px solid",borderColor:"divider",borderRadius:2,p:1.25},children:[e.jsxs(E,{sx:{display:"grid",gridTemplateColumns:"2fr 1fr 1fr 1fr",gap:1},children:[e.jsx(x,{label:"Name",size:"small",value:((X=s.armor)==null?void 0:X.name)??"",onChange:l=>t.onChange({armor:{...s.armor??{durability:{current:0,max:0},protection:0,keywords:[],keywordParams:{ammoMax:0}},name:l.target.value}})}),e.jsx(x,{label:"Protection",size:"small",type:"number",value:(($=s.armor)==null?void 0:$.protection)??0,onChange:l=>t.onChange({armor:{...s.armor??{name:"",durability:{current:0,max:0},keywords:[],keywordParams:{}},protection:Number(l.target.value)}})}),e.jsx(x,{label:"Durability (cur)",size:"small",type:"number",value:((c=s.armor)==null?void 0:c.durability.current)??0,onChange:l=>{var d;return t.onChange({armor:{...s.armor??{name:"",durability:{current:0,max:0},protection:0,keywords:[],keywordParams:{}},durability:{...((d=s.armor)==null?void 0:d.durability)??{current:0,max:0},current:Number(l.target.value)}}})}}),e.jsx(x,{label:"Durability (max)",size:"small",type:"number",value:((g=s.armor)==null?void 0:g.durability.max)??0,onChange:l=>{var d;return t.onChange({armor:{...s.armor??{name:"",durability:{current:0,max:0},protection:0,keywords:[],keywordParams:{}},durability:{...((d=s.armor)==null?void 0:d.durability)??{current:0,max:0},max:Number(l.target.value)}}})}})]}),(((Y=(W=s.armor)==null?void 0:W.durability)==null?void 0:Y.max)??0)>0&&(((q=(V=s.armor)==null?void 0:V.durability)==null?void 0:q.current)??0)<=0&&e.jsx(D,{sx:{mt:1},color:"error",variant:"body2",children:"Broken: armor provides no Protection until repaired."}),e.jsxs(E,{sx:{display:"grid",gridTemplateColumns:"1fr 1fr 1fr 2fr",gap:1,mt:1},children:[e.jsx(x,{label:"Bulk",size:"small",type:"number",value:((he=s.armor)==null?void 0:he.bulk)??0,onChange:l=>t.onChange({armor:{...s.armor??{name:"",durability:{current:0,max:0},protection:0,keywords:[],keywordParams:{}},bulk:Number(l.target.value)}})}),e.jsx(x,{label:"Req.",size:"small",value:((ke=s.armor)==null?void 0:ke.req)??"",onChange:l=>t.onChange({armor:{...s.armor??{name:"",durability:{current:0,max:0},protection:0,keywords:[],keywordParams:{}},req:l.target.value}})}),e.jsx(x,{label:"Special",size:"small",value:((Be=s.armor)==null?void 0:Be.special)??"",onChange:l=>t.onChange({armor:{...s.armor??{name:"",durability:{current:0,max:0},protection:0,keywords:[],keywordParams:{}},special:l.target.value}})})]}),e.jsx(E,{sx:{mt:1},children:e.jsx(x,{label:"Keywords (comma)",size:"small",fullWidth:!0,value:(((ye=s.armor)==null?void 0:ye.keywords)??[]).join(", "),onChange:l=>t.onChange({armor:{...s.armor??{name:"",durability:{current:0,max:0},protection:0,keywords:[],keywordParams:{}},keywords:l.target.value.split(",").map(d=>d.trim()).filter(Boolean)}}),placeholder:"Frontal Shielding 1"})})]})]})})]})]})}const ga=[{name:"Flashbang Grenade",effect:"Applies Stun 1 to everyone within Very Near range, Thrown",uses:"1 use",bulk:1,cost:200},{name:"Frag Grenade",effect:"Deals 2 area (Very Near range) damage (DC8 to Evade half), Thrown",uses:"1 use",bulk:1,cost:250},{name:"EMP Grenade",effect:"Applies EMP 2 to everything within range, Thrown",uses:"1 use",bulk:1,cost:300},{name:"Combat Stim Injector",effect:"Gain +1 action & -1 Stress; take 1 wound after effect ends",uses:"1 use",bulk:1,cost:200},{name:"Basic Medkit",effect:"Right tool for the job: First Aid checks",uses:"3 uses",bulk:1,cost:350},{name:"Multitool",effect:"Allows engineering checks to repair, bypass, scrap, etc.",uses:"Permanent",bulk:1,cost:750},{name:"Repair Kit",effect:"Provides materials and tools for repairs",uses:"10 uses",bulk:1,cost:500},{name:"Tracker",effect:"While within 10km, always know location of this device",uses:"1 use",bulk:1,cost:250},{name:"Portable Scanner",effect:"Right tool for the job: Observe (tech, lifeforms)",uses:"Permanent",bulk:1,cost:400},{name:"Weapon Scope",effect:"Simple Modification. Grants +1 bonus die to called shots at medium range and farther; inflicts +1 penalty die to attacks at Near range or nearer",uses:"Permanent",bulk:1,cost:750},{name:"Weapon Silencer",effect:"Simple Modification. Weapon makes reduced sound when fired; deals -1 damage",uses:"Permanent",bulk:1,cost:500},{name:"Compact Backpack",effect:"+5 Inventory Slots when worn",uses:"Permanent",bulk:0,cost:150},{name:"Ammo (Flechette)",effect:"Deals +2 damage to unarmoured targets.",uses:"10 rounds",bulk:1,cost:500},{name:"Ammo (SMART)",effect:"Required for Smart-Linked weapons.",uses:"10",bulk:1,cost:1250},{name:"Ammo (Armour Piercing)",effect:"Adds Piercing 1 to attacks.",uses:"10",bulk:1,cost:750},{name:"Ammo (Explosive)",effect:"Adds Shredding 1 to attacks.",uses:"10",bulk:1,cost:750}],xa={items:ga},ya=xa.items,ba=[{name:"Reflex Booster",tier:1,effect:"Once per round, gain +1 bonus die to an Evade check.",installationDifficulty:2,requirements:"REF 1",physicalImpact:"Low; spine",bulk:1,cost:4e3},{name:"Targeting Link",tier:1,effect:"Once per round, ignore 1 level of cover when attacking an enemy you can see.",installationDifficulty:2,requirements:"-",physicalImpact:"Medium; eyes",bulk:1,cost:6e3},{name:"Low-Light Optics",tier:1,effect:"Ignore penalty dice caused by darkness within medium range.",installationDifficulty:1,requirements:"-",physicalImpact:"Medium; eyes",bulk:1,cost:4e3},{name:"EMP Shielding",tier:1,effect:"Ignore the effects of EMP once per day.",installationDifficulty:2,requirements:"MENT 1",physicalImpact:"None; torso",bulk:1,cost:5500},{name:"Metabolic Filter",tier:1,effect:"Gain +1 bonus die on checks to resist toxins or narcotics.",installationDifficulty:1,requirements:"PHYS 1",physicalImpact:"Minor; liver",bulk:1,cost:2e3},{name:"Internal Communicator",tier:1,effect:"Gain the ability to send and receive messages mentally just as if you were using a regular comms device.",installationDifficulty:0,requirements:"-",physicalImpact:"Medium; jaw, ear",bulk:1,cost:2500},{name:"Skull Popper",tier:1,effect:"Highly illegal; when installed, is given a mandate such as “don’t go to the police”. If the host violates this mandate, the Skull Popper explodes, killing the host. The more specific the mandate, the better the implant functions.",installationDifficulty:2,requirements:"-",physicalImpact:"None; brain",bulk:1,cost:12e3},{name:"Databank",tier:2,effect:"You gain an internal information storage device. You may store information upon it (thinking you want to record what you see, for example), and access information from it at will. You may also load external information onto it, though the GM determines how long that takes and how much may be stored on it.",installationDifficulty:2,requirements:"MENT 1",physicalImpact:"Medium; cranium",bulk:1,cost:7500},{name:"Invisible Databank",tier:2,effect:"You gain an internal information storage device. You may store information upon it (thinking you want to record what you see, for example), and access information from it at will. This device cannot be seen or accessed externally without removing it and is shielded to avoid electronic detection.",installationDifficulty:3,requirements:"-",physicalImpact:"None; cranium",bulk:1,cost:15e3},{name:"Neural Accelerator",tier:2,effect:"Once per day, activate to gain 2 additional actions on your turn. At the end of your turn, gain +2 stress.",installationDifficulty:4,requirements:"Ment 2",physicalImpact:"Obvious; spine",bulk:1,cost:1e4},{name:"Reaction Governor Matrix",tier:2,effect:"Gain +1 reaction per round.",installationDifficulty:2,requirements:"REF 2",physicalImpact:"None; brain",bulk:1,cost:8e3},{name:"Threat Awareness Suite",tier:2,effect:"Gain +1 bonus die to Observe or Instinct checks to detect ambushes or imminent danger. Additionally, you may not be Surprised.",installationDifficulty:2,requirements:"-",physicalImpact:"None; brain",bulk:1,cost:5500},{name:"Synthetic Musculature",tier:2,effect:"Gain +1 bonus die on Powerlifting or Athletics checks involving lifting, pushing, or breaking objects. Unarmed attacks deal damage equal to your full PHYS.",installationDifficulty:4,requirements:"PHYS 3",physicalImpact:"Obvious; arms, legs, torso",bulk:1,cost:1e4},{name:"Stability Gyros",tier:2,effect:"Ignore penalty dice from unstable environments (moving vehicles, zero-G, poor footing)",installationDifficulty:2,requirements:"REF 2",physicalImpact:"Minor; ear",bulk:1,cost:6e3},{name:"Adrenal Boost",tier:2,effect:"Activate to ignore stress penalties for 1 round. At the end of this round, take 1 damage.",installationDifficulty:2,requirements:"PHYS 1",physicalImpact:"None; adrenal glands",bulk:1,cost:5e3},{name:"Mantis Claws (retractable)",tier:3,effect:"Your unarmed attacks deal damage equal to your REF and have Piercing 3. Additionally, gain +1 bonus die to climbing related checks.",installationDifficulty:3,requirements:"REF 2 or PHYS 2",physicalImpact:"Obvious; forearms and hands",bulk:1,cost:1e4},{name:"Neuro Regulator",tier:3,effect:"Ignore up to 3 stress per day from up to 3 sources of stress. Make all SOC based rolls with +1 penalty die.",installationDifficulty:3,requirements:"MENT 2",physicalImpact:"None; brain",bulk:1,cost:12e3},{name:"Synthetic Antibodies",tier:3,effect:"Become immune to nanites targeting your body (including positive effects). Does not stop things from being thrown at you with nanites.",installationDifficulty:4,requirements:"PHYS 1 and MENT 1",physicalImpact:"Minor; nervous system",bulk:1,cost:17500},{name:"Bio-Stabilizer",tier:3,effect:`When you would take a Medium or Heavy wound, roll Cybernetics (DC8).- Extreme success: ignore the wound.
- Success: ignore the wound; this cyberware effect cannot be used for 1 day.
- Failure: suffer the wound as normal; this cyberware effect cannot be used for 1 day.
This effect may only trigger once per instance of damage.`,installationDifficulty:4,requirements:"-",physicalImpact:"Medium; chest and back",bulk:1,cost:15e3}],pa={cyberware:ba},ka=pa.cyberware,va=[{name:"Space Dust",effect:"Grants +1 bonus die to Observe and Piloting checks for 6 hours",uses:5,addictionScore:1,legality:"Legal",bulk:1,cost:500},{name:"Tranquility",effect:"Reduces stress by 1; penalty die to all REF checks for 6 hours.",uses:2,addictionScore:5,legality:"Legal",bulk:1,cost:5e3},{name:"Smoothe",effect:"Reduces stress by 1d4; increases Cool Under Fire by 2 and grants +1 bonus die to all Mental skill checks for 1 hour",uses:1,addictionScore:8,legality:"Illegal",bulk:1,cost:2e4},{name:"Chemical Strength",effect:"+1 bonus die to all PHYS checks for 1 hour; +1 movement bonus for 1 hour. After 1 hour, gain +1 penalty die to all PHYS checks and gain +1 movement penalty until sleep.",uses:1,addictionScore:3,legality:"Illegal",bulk:1,cost:8e3}],ja={narcotics:va},wa=ja.narcotics;function Ca(){return`inv_${Date.now()}_${Math.random().toString(36).slice(2,9)}`}function Sa(t){const s=t.sheet.inventory??[],y=a=>{t.onChange({inventory:a})},[f,C]=S.useState("item"),[p,o]=S.useState(null),[i,k]=S.useState({}),[B,K]=S.useState(null),[v,P]=S.useState(null),te=S.useMemo(()=>f==="item"?ya.map(a=>({type:"item",...a})):f==="cyberware"?ka.map(a=>({type:"cyberware",...a})):wa.map(a=>({type:"narcotics",...a})),[f]);function re(a){o(a);const n=te.find(T=>T.name===a);if(!n){k({type:f,name:"",quantity:1,bulk:f==="item"?0:1,effect:"",cost:0,statusEffects:""});return}k(f==="item"?{type:"item",name:n.name,quantity:1,uses:n.uses??"",bulk:n.bulk??0,effect:n.effect??"",cost:n.cost??0,statusEffects:n.statusEffects??""}:f==="cyberware"?{type:"cyberware",name:n.name,quantity:1,bulk:n.bulk??1,tier:n.tier??1,installationDifficulty:n.installationDifficulty??0,requirements:n.requirements??"",physicalImpact:n.physicalImpact??"",effect:n.effect??"",cost:n.cost??0,statusEffects:n.statusEffects??""}:{type:"narcotics",name:n.name,quantity:1,bulk:n.bulk??1,uses:n.uses??1,addictionScore:n.addictionScore??0,legality:n.legality??"",effect:n.effect??"",cost:n.cost??0,statusEffects:n.statusEffects??""})}function le(){const a=[...s,{id:Ca(),...i}];t.onChange({inventory:a}),o(null),k({type:f,name:"",quantity:1,bulk:f==="item"?0:1,effect:"",cost:0,statusEffects:""})}function Z(a){t.onChange({inventory:s.filter(n=>n.id!==a)})}function m(a,n){t.onChange({inventory:s.map(T=>T.id===a?{...T,...n}:T)})}return e.jsxs(_,{spacing:2,children:[e.jsx(x,{label:"Credits",type:"number",value:t.sheet.credits??0,onChange:a=>t.onChange({credits:Number(a.target.value)}),size:"small"}),e.jsxs(E,{children:[e.jsx(D,{variant:"subtitle2",sx:{mb:1},children:"Add Inventory"}),e.jsxs(_,{direction:{xs:"column",sm:"row"},spacing:1,alignItems:"center",children:[e.jsxs(x,{select:!0,size:"small",label:"Type",value:f,onChange:a=>{const n=a.target.value;C(n),o(null),k(n==="item"?{type:n,name:"",quantity:1,bulk:0,uses:"",effect:"",cost:0,statusEffects:""}:n==="cyberware"?{type:n,name:"",quantity:1,bulk:1,tier:1,installationDifficulty:0,requirements:"",physicalImpact:"",effect:"",cost:0,statusEffects:""}:{type:n,name:"",quantity:1,bulk:1,uses:1,addictionScore:0,legality:"",effect:"",cost:0,statusEffects:""})},sx:{minWidth:160},children:[e.jsx(ue,{value:"item",children:"Item"}),e.jsx(ue,{value:"cyberware",children:"Cyberware"}),e.jsx(ue,{value:"narcotics",children:"Narcotics"})]}),e.jsx(Lt,{size:"small",sx:{flex:1,minWidth:220},options:te.map(a=>a.name),value:p,onChange:(a,n)=>re(n),renderInput:a=>e.jsx(x,{...a,label:"Template (optional)"})}),e.jsx(me,{variant:"contained",startIcon:e.jsx(ve,{}),onClick:le,disabled:!(i!=null&&i.name),children:"Add"})]}),e.jsx(E,{sx:{mt:1},children:e.jsxs(_,{spacing:1,children:[e.jsxs(_,{direction:{xs:"column",sm:"row"},spacing:1,children:[e.jsx(x,{size:"small",label:"Name",value:(i==null?void 0:i.name)??"",onChange:a=>k(n=>({...n,name:a.target.value})),sx:{flex:1}}),e.jsx(x,{size:"small",type:"number",label:"Bulk",value:(i==null?void 0:i.bulk)??0,onChange:a=>k(n=>({...n,bulk:Number(a.target.value)})),sx:{width:120}}),e.jsx(x,{size:"small",type:"number",label:"Quantity",value:(i==null?void 0:i.quantity)??1,onChange:a=>{const n=Number(a.target.value);Number.isFinite(n)&&k(T=>({...T,quantity:n}))},sx:{width:120}}),e.jsx(x,{size:"small",type:"number",label:"Cost",value:(i==null?void 0:i.cost)??0,onChange:a=>k(n=>({...n,cost:Number(a.target.value)})),sx:{width:140}})]}),f==="item"&&e.jsx(x,{size:"small",label:"Uses",value:(i==null?void 0:i.uses)??"",onChange:a=>k(n=>({...n,uses:a.target.value}))}),f==="cyberware"&&e.jsxs(_,{direction:{xs:"column",sm:"row"},spacing:1,children:[e.jsx(x,{size:"small",type:"number",label:"Tier",value:(i==null?void 0:i.tier)??1,onChange:a=>k(n=>({...n,tier:Number(a.target.value)})),sx:{width:120}}),e.jsx(x,{size:"small",type:"number",label:"Installation Difficulty",value:(i==null?void 0:i.installationDifficulty)??0,onChange:a=>k(n=>({...n,installationDifficulty:Number(a.target.value)})),sx:{width:220}}),e.jsx(x,{size:"small",label:"Requirements",value:(i==null?void 0:i.requirements)??"",onChange:a=>k(n=>({...n,requirements:a.target.value})),sx:{flex:1}})]}),f==="cyberware"&&e.jsx(x,{size:"small",label:"Physical Impact",value:(i==null?void 0:i.physicalImpact)??"",onChange:a=>k(n=>({...n,physicalImpact:a.target.value}))}),f==="narcotics"&&e.jsxs(_,{direction:{xs:"column",sm:"row"},spacing:1,children:[e.jsx(x,{size:"small",type:"number",label:"Uses",value:(i==null?void 0:i.uses)??1,onChange:a=>k(n=>({...n,uses:Number(a.target.value)})),sx:{width:120}}),e.jsx(x,{size:"small",type:"number",label:"Addiction Score",value:(i==null?void 0:i.addictionScore)??0,onChange:a=>k(n=>({...n,addictionScore:Number(a.target.value)})),sx:{width:160}}),e.jsx(x,{size:"small",label:"Legality",value:(i==null?void 0:i.legality)??"",onChange:a=>k(n=>({...n,legality:a.target.value})),sx:{flex:1}})]}),e.jsx(x,{size:"small",label:"Effect",value:(i==null?void 0:i.effect)??"",onChange:a=>k(n=>({...n,effect:a.target.value})),multiline:!0,minRows:2}),e.jsx(x,{size:"small",label:"Status Effects (comma-separated)",value:(i==null?void 0:i.statusEffects)??"",onChange:a=>k(n=>({...n,statusEffects:a.target.value})),placeholder:'e.g. "carrying_capacity+5"'})]})})]}),e.jsxs(E,{children:[e.jsx(D,{variant:"subtitle2",sx:{mb:1},children:"Inventory"}),s.length===0&&e.jsx(D,{variant:"body2",children:"No inventory items yet."}),s.map(a=>{const n=a.quantity??1,j=(a.bulk??0)*n,A=`${a.name} (${a.type}) • bulk ${j}`;return e.jsxs(Me,{disableGutters:!0,children:[e.jsx(De,{expandIcon:e.jsx(Te,{}),draggable:!0,onDragStart:h=>{K(a.id??null);try{h.dataTransfer.effectAllowed="move",h.dataTransfer.setData("text/plain",a.id??"")}catch{}},onDragOver:h=>{h.preventDefault(),P(a.id??null)},onDragLeave:()=>P(null),onDrop:h=>{h.preventDefault();const L=B??h.dataTransfer.getData("text/plain"),J=a.id;if(L&&J&&L!==J){const w=t.sheet.inventory??[],O=w.findIndex($=>$.id===L),X=w.findIndex($=>$.id===J);if(O>=0&&X>=0){const $=[...w],[c]=$.splice(O,1);$.splice(X,0,c),y($)}}K(null),P(null)},sx:v===a.id?{outline:"2px dashed rgba(255,255,255,0.35)",borderRadius:1}:void 0,children:e.jsxs(_,{direction:"row",spacing:1,alignItems:"center",sx:{width:"100%"},children:[e.jsx(Wt,{fontSize:"small",sx:{opacity:.5}}),e.jsx(D,{variant:"body2",sx:{flex:1},children:A}),e.jsxs(_,{direction:"row",spacing:.5,alignItems:"center",children:[e.jsx(ie,{size:"small",onClick:h=>{h.stopPropagation();const L=(a.quantity??1)-1;L<=0?Z(a.id):m(a.id,{quantity:L})},children:e.jsx(ut,{fontSize:"small"})}),e.jsx(D,{variant:"caption",sx:{minWidth:18,textAlign:"center"},children:a.quantity??1}),e.jsx(ie,{size:"small",onClick:h=>{h.stopPropagation(),m(a.id,{quantity:(a.quantity??1)+1})},children:e.jsx(ve,{fontSize:"small"})})]}),e.jsx(de,{title:"Remove",children:e.jsx(ie,{size:"small",onClick:h=>(h.stopPropagation(),Z(a.id)),children:e.jsx(Fe,{fontSize:"small"})})})]})}),e.jsx(Ae,{children:e.jsxs(_,{spacing:1,children:[e.jsxs(_,{direction:{xs:"column",sm:"row"},spacing:1,children:[e.jsx(x,{size:"small",label:"Name",value:a.name??"",onChange:h=>m(a.id,{name:h.target.value}),sx:{flex:1}}),e.jsxs(x,{select:!0,size:"small",label:"Type",value:a.type,onChange:h=>m(a.id,{type:h.target.value}),sx:{width:160},children:[e.jsx(ue,{value:"item",children:"Item"}),e.jsx(ue,{value:"cyberware",children:"Cyberware"}),e.jsx(ue,{value:"narcotics",children:"Narcotics"})]}),e.jsx(x,{size:"small",type:"number",label:"Bulk",value:a.bulk??0,onChange:h=>m(a.id,{bulk:Number(h.target.value)}),sx:{width:120}}),e.jsx(x,{size:"small",type:"number",label:"Quantity",value:a.quantity??1,onChange:h=>{const L=Number(h.target.value);Number.isFinite(L)&&(L<=0?Z(a.id):m(a.id,{quantity:L}))},sx:{width:120}}),e.jsx(x,{size:"small",type:"number",label:"Cost",value:a.cost??0,onChange:h=>m(a.id,{cost:Number(h.target.value)}),sx:{width:140}})]}),a.type==="item"&&e.jsx(x,{size:"small",label:"Uses",value:a.uses??"",onChange:h=>m(a.id,{uses:h.target.value})}),a.type==="cyberware"&&e.jsxs(_,{direction:{xs:"column",sm:"row"},spacing:1,children:[e.jsx(x,{size:"small",type:"number",label:"Tier",value:a.tier??1,onChange:h=>m(a.id,{tier:Number(h.target.value)}),sx:{width:120}}),e.jsx(x,{size:"small",type:"number",label:"Installation Difficulty",value:a.installationDifficulty??0,onChange:h=>m(a.id,{installationDifficulty:Number(h.target.value)}),sx:{width:220}}),e.jsx(x,{size:"small",label:"Requirements",value:a.requirements??"",onChange:h=>m(a.id,{requirements:h.target.value}),sx:{flex:1}})]}),a.type==="cyberware"&&e.jsx(x,{size:"small",label:"Physical Impact",value:a.physicalImpact??"",onChange:h=>m(a.id,{physicalImpact:h.target.value})}),a.type==="narcotics"&&e.jsxs(_,{direction:{xs:"column",sm:"row"},spacing:1,children:[e.jsx(x,{size:"small",type:"number",label:"Uses",value:a.uses??1,onChange:h=>m(a.id,{uses:Number(h.target.value)}),sx:{width:120}}),e.jsx(x,{size:"small",type:"number",label:"Addiction Score",value:a.addictionScore??0,onChange:h=>m(a.id,{addictionScore:Number(h.target.value)}),sx:{width:160}}),e.jsx(x,{size:"small",label:"Legality",value:a.legality??"",onChange:h=>m(a.id,{legality:h.target.value}),sx:{flex:1}})]}),e.jsx(x,{size:"small",label:"Effect",value:a.effect??"",onChange:h=>m(a.id,{effect:h.target.value}),multiline:!0,minRows:2}),e.jsx(x,{size:"small",label:"Status Effects (comma-separated)",value:a.statusEffects??"",onChange:h=>m(a.id,{statusEffects:h.target.value}),placeholder:'e.g. "carrying_capacity+5"'})]})})]},a.id)})]})]})}function Ia(){const[t,s]=S.useState({entries:[],activeTokenId:void 0,updatedAt:Date.now()}),[y,f]=S.useState({}),[C,p]=S.useState(""),[o,i]=S.useState(!1),[k,B]=S.useState(0),K=m=>Math.max(-3,Math.min(3,m)),v=S.useMemo(()=>Ve(),[]);S.useEffect(()=>{const m=wt(a=>s(a));return()=>m==null?void 0:m()},[]),S.useEffect(()=>{let m=!0;return(async()=>{var a,n,T,j;try{const[A,h]=await Promise.all([((n=(a=H.player).getId)==null?void 0:n.call(a))??Promise.resolve(""),((j=(T=H.player).getRole)==null?void 0:j.call(T))??Promise.resolve("")]);if(!m)return;p(String(A??"")),i(String(h).toUpperCase()==="GM")}catch{}})(),()=>{m=!1}},[]);const P=S.useMemo(()=>{const m=[...t.entries??[]];return m.sort((a,n)=>(n.initiative??0)-(a.initiative??0)),m},[t.entries]);S.useEffect(()=>{let m=!0;return(async()=>{var a,n,T,j,A,h,L;try{const J=P.map(X=>X.tokenId);if(!J.length){m&&f({});return}const w=await H.scene.items.getItems(J),O={};for(const X of w){const $=X.id,c=await Ee($),g=c==null?void 0:c.armor,W=((a=g==null?void 0:g.durability)==null?void 0:a.current)??0,Y=!!g&&W<=0,V=Y?0:(g==null?void 0:g.protection)??0,q=(n=c==null?void 0:c.weapons)==null?void 0:n[0],he=pe(q),ke=Number.isFinite(q==null?void 0:q.ammo)?Number(q==null?void 0:q.ammo):0;O[$]={tokenId:$,name:((A=(j=(T=X.text)==null?void 0:T.plainText)==null?void 0:j.trim)==null?void 0:A.call(j))||(c==null?void 0:c.name)||"(Unnamed)",thumbUrl:(h=X.image)==null?void 0:h.url,ownerPlayerId:String(((L=X.metadata)==null?void 0:L[ct])??""),prot:V,armorBroken:Y,topWeaponName:q==null?void 0:q.name,topWeaponUseDC:q==null?void 0:q.useDC,topWeaponDamage:q==null?void 0:q.damage,topWeaponSkillId:q==null?void 0:q.skillId,topWeaponAmmo:ke,topWeaponAmmoMax:he}}m&&f(O)}catch{}})(),()=>{m=!1}},[P]);async function te(m){var c,g,W,Y,V;const[a]=await H.scene.items.getItems([m]);if(!a)return;const n=await Ee(m);if(!n)return;const T=et([...(n.feats??[]).map(q=>q.statusEffects??"").filter(Boolean),...(n.inventory??[]).map(q=>q.statusEffects??"").filter(Boolean)]).deltas,j=Se(n.skills??{}),A=((c=n.stress)==null?void 0:c.current)??0,h=Math.max(0,(ze(n.skills??{})||0)-(((g=n.stress)==null?void 0:g.cufLoss)??0)),L=Dt({attributes:j,stress:{current:A,cuf:h}},T),J=L.stress.cuf??h,w=L.attributes.ref??j.ref??0,O=A>J,X=Le({netDice:O?-1:0,modifier:w,label:`${((W=a.text)==null?void 0:W.plainText)??n.name??"Token"} Initiative`}),$=await Je({diceNotation:X,rollTarget:"everyone",showResults:!0});await Tt({tokenId:m,initiative:$,name:((Y=a.text)==null?void 0:Y.plainText)??n.name??"Token",thumbUrl:(V=a.image)==null?void 0:V.url})}async function re(){var j,A;const m=await((A=(j=H.player).getSelection)==null?void 0:A.call(j))??[],a=m==null?void 0:m[0],n=await dt()??void 0,T=a||n;if(!T){H.notification.show("Select a token (or set your character) to roll initiative.","WARNING");return}await te(T)}async function le(m){var c,g,W;const a=await Ee(m);if(!a)return;const n=(c=a.weapons)==null?void 0:c[0];if(!n){H.notification.show("No weapon in the top slot.","WARNING");return}const T=et([...(a.feats??[]).map(Y=>Y.statusEffects??"").filter(Boolean),...(a.inventory??[]).map(Y=>Y.statusEffects??"").filter(Boolean)]).deltas,A=(ze(a.skills??{})-(((g=a.stress)==null?void 0:g.cufLoss)??0)||0)+(T.cool_under_fire??0),L=(((W=a.stress)==null?void 0:W.current)??0)>A,J=String(n.skillId??""),w=xt({learnedInfoById:v,sheet:a,skillId:J,skillMods:T}),O=pe(n),X=Number.isFinite(n==null?void 0:n.ammo)?Number(n==null?void 0:n.ammo):0;if(O>0&&X<=0){H.notification.show("Out of ammo. Reload first.","WARNING");return}const $=K(k-(L?1:0));if(await bt({weapon:n,netDice:$,modifier:w,attackerName:a.name,rollTarget:"everyone",showResults:!0}),O>0){const Y=Math.max(0,X-1),V=[...a.weapons??[]];V[0]={...V[0],ammo:Y},await Ge(m,{...a,weapons:V})}}async function Z(m){var A;const a=await Ee(m);if(!a)return;const n=(A=a.weapons)==null?void 0:A[0];if(!n)return;const T=pe(n);if(T<=0)return;const j=[...a.weapons??[]];j[0]={...j[0],ammo:T},await Ge(m,{...a,weapons:j})}return e.jsxs(_,{spacing:2,children:[e.jsxs(E,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",gap:1,flexWrap:"wrap"},children:[e.jsx(D,{variant:"h6",sx:{m:0},children:"Initiative"}),e.jsxs(_,{direction:"row",spacing:1,alignItems:"center",children:[e.jsx(me,{size:"small",variant:"contained",onClick:()=>void re(),startIcon:e.jsx(Ie,{}),children:"Roll Initiative"}),e.jsxs(E,{sx:{display:"flex",alignItems:"center",gap:1,flexWrap:"wrap",pl:1},children:[e.jsx(D,{variant:"body2",sx:{opacity:.8},children:"Attack Roll:"}),e.jsxs(We,{size:"small",exclusive:!0,value:k,onChange:(m,a)=>{a!==null&&B(a)},children:[e.jsx(ee,{value:-2,children:"−2"}),e.jsx(ee,{value:-1,children:"−1"}),e.jsx(ee,{value:0,children:"0"}),e.jsx(ee,{value:1,children:"+1"}),e.jsx(ee,{value:2,children:"+2"})]})]}),o&&e.jsxs(e.Fragment,{children:[e.jsx(me,{size:"small",variant:"outlined",onClick:()=>Ct(),children:"Clear"}),e.jsx(me,{size:"small",variant:"outlined",onClick:()=>St(),children:"Advance"})]})]})]}),e.jsx(Ft,{}),P.length===0?e.jsx(D,{variant:"body2",sx:{opacity:.75},children:"No initiative rolls yet."}):e.jsx(Bt,{dense:!0,disablePadding:!0,children:P.map(m=>{const a=y[m.tokenId],n=a==null?void 0:a.ownerPlayerId,T=o||!!n&&n===C,j=t.activeTokenId===m.tokenId,A=j&&T&&!o,h=!!m.surprised,L=(a==null?void 0:a.topWeaponAmmoMax)??0,J=(a==null?void 0:a.topWeaponAmmo)??0,w=L>0&&J<=0;return e.jsxs(_t,{sx:{borderRadius:1,mb:.5,bgcolor:j?"rgba(255,255,255,0.06)":"transparent",opacity:h?.55:1},secondaryAction:e.jsxs(_,{direction:"row",spacing:.5,alignItems:"center",children:[e.jsx(de,{title:a!=null&&a.armorBroken?"Armor broken":"Protection",children:e.jsxs(E,{sx:{display:"inline-flex",alignItems:"center",gap:.5,px:1,py:.5,borderRadius:1,bgcolor:"rgba(0,0,0,0.25)"},children:[e.jsx($t,{fontSize:"small",sx:{color:a!=null&&a.armorBroken?"error.main":"inherit"}}),e.jsx(D,{variant:"caption",children:(a==null?void 0:a.prot)??0})]})}),(o||T)&&e.jsx(de,{title:a!=null&&a.topWeaponName?w?`Out of ammo: ${a.topWeaponName}`:`Attack: ${a.topWeaponName}`:"No top weapon",children:e.jsx("span",{children:e.jsx(ie,{size:"small",disabled:!(a!=null&&a.topWeaponName)||w,onClick:()=>void le(m.tokenId),children:e.jsx(Ie,{fontSize:"small"})})})}),(o||T)&&e.jsx(de,{title:a!=null&&a.topWeaponName?L<=0?"No ammo to reload":`Reload: ${a.topWeaponName}`:"No top weapon",children:e.jsx("span",{children:e.jsx(ie,{size:"small",disabled:!(a!=null&&a.topWeaponName)||L<=0,onClick:()=>void Z(m.tokenId),children:e.jsx(mt,{fontSize:"small"})})})}),e.jsx(de,{title:T||o?"Remove":"Only the owner or GM can remove",children:e.jsx("span",{children:e.jsx(ie,{size:"small",disabled:!T&&!o,onClick:()=>Mt(m.tokenId),children:e.jsx(Fe,{fontSize:"small"})})})})]}),children:[e.jsx(qt,{children:e.jsx(Ot,{src:a==null?void 0:a.thumbUrl,variant:"rounded",sx:{width:32,height:32,mr:1,cursor:"pointer"}})}),e.jsx(Ut,{primary:e.jsxs(E,{sx:{display:"flex",alignItems:"center",gap:1,flexWrap:"wrap"},children:[e.jsx(D,{variant:"body2",sx:{fontWeight:600},children:(a==null?void 0:a.name)??m.name??"Token"}),e.jsx(D,{variant:"caption",sx:{opacity:.75},children:m.initiative}),A&&e.jsx(D,{variant:"caption",sx:{px:1,py:.25,borderRadius:1,bgcolor:"rgba(0,128,255,0.2)"},children:"Your Turn"})]}),secondary:e.jsxs(E,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(Ht,{size:"small",checked:h,disabled:!o,onChange:O=>It(m.tokenId,O.target.checked)}),e.jsx(D,{variant:"caption",sx:{opacity:.75},children:"Surprised"})]})})]},m.tokenId)})})]})}function Ma(t){return e.jsxs("div",{style:{display:"flex",alignItems:"flex-start",gap:12,justifyContent:"space-between",marginBottom:10},children:[e.jsxs("div",{style:{display:"flex",gap:10,alignItems:"flex-start"},children:[t.thumbUrl?e.jsx("img",{src:t.thumbUrl,alt:"Token thumbnail",style:{width:44,height:44,borderRadius:10,objectFit:"cover",border:"1px solid rgba(0,0,0,0.2)"}}):e.jsx("div",{style:{width:44,height:44,borderRadius:10,border:"1px solid rgba(0,0,0,0.2)",opacity:.4}}),e.jsxs("div",{children:[e.jsxs("div",{style:{fontSize:18,fontWeight:700},children:[t.title," ",e.jsxs("span",{style:{fontSize:12,opacity:.75},children:["(",t.ownerLabel,")"]})]}),e.jsxs("div",{style:{fontSize:12,opacity:.8},children:["Token: ",e.jsx("code",{style:{fontSize:11},children:t.tokenId})]})]})]}),e.jsxs("div",{style:{display:"flex",gap:8},children:[t.showBackButton&&e.jsx("button",{style:{padding:"8px 10px",borderRadius:8,border:"1px solid #999",cursor:"pointer",opacity:.9},onClick:t.onBack,children:"Back to My Sheet"}),t.showUnsetButton&&e.jsx("button",{style:{padding:"8px 10px",borderRadius:8,border:"1px solid #999",cursor:"pointer",opacity:.9},onClick:t.onUnset,children:"Unset “My Character”"})]})]})}function Da(t){var s,y,f;return e.jsxs("div",{style:se.statusBar,children:[e.jsxs("div",{style:se.statusLeft,children:[e.jsxs("div",{style:se.statusGroup,children:[e.jsx("div",{style:se.statusLabel,children:"Stress"}),e.jsx("input",{type:"number",min:0,value:((s=t.sheet.stress)==null?void 0:s.current)??0,onChange:C=>t.applyStress(Number(C.target.value)),style:se.statusNumber})]}),e.jsxs("div",{style:se.statusGroup,children:[e.jsx("div",{style:se.statusLabel,children:"Wounds"}),e.jsxs("div",{style:se.woundsRow,children:[e.jsx("span",{style:se.woundsKind,children:"L"}),Array.from({length:4}).map((C,p)=>{var o;return e.jsx("input",{type:"checkbox",checked:(((o=t.sheet.wounds)==null?void 0:o.light)??0)>p,onChange:()=>t.toggleWound("light",p)},`wl_${p}`)}),e.jsx("span",{style:{width:8}}),e.jsx("span",{style:se.woundsKind,children:"M"}),Array.from({length:2}).map((C,p)=>{var o;return e.jsx("input",{type:"checkbox",checked:(((o=t.sheet.wounds)==null?void 0:o.moderate)??0)>p,onChange:()=>t.toggleWound("moderate",p)},`wm_${p}`)}),e.jsx("span",{style:{width:8}}),e.jsx("span",{style:se.woundsKind,children:"H"}),Array.from({length:1}).map((C,p)=>{var o;return e.jsx("input",{type:"checkbox",checked:(((o=t.sheet.wounds)==null?void 0:o.heavy)??0)>p,onChange:()=>t.toggleWound("heavy",p)},`wh_${p}`)})]})]}),e.jsxs("label",{style:{display:"flex",alignItems:"center",gap:6},children:[e.jsx("input",{type:"checkbox",checked:!!t.sheet.indomitable,onChange:C=>t.setIndomitable(C.target.checked)}),e.jsx("span",{style:{fontSize:12,opacity:.9},children:"Indomitable"})]}),(((y=t.sheet.stress)==null?void 0:y.current)??0)>(((f=t.sheetForView.stress)==null?void 0:f.cuf)??0)&&e.jsx("div",{style:se.warning,children:"Stress > CUF: make all rolls with +1 Penalty Die"}),e.jsxs("div",{style:{fontSize:12,opacity:.85},children:["Bulk: ",t.totalBulk," / ",t.effectiveCarryingCapacity]}),t.encumbranceLabel&&e.jsx("div",{style:se.warning,children:t.encumbranceLabel})]}),e.jsxs("div",{style:se.statusRight,children:[t.crucible&&t.crucible.status==="pending"&&e.jsxs("div",{style:se.crucibleBox,children:[e.jsx("div",{style:{fontWeight:700},children:"Crucible Test!"}),e.jsxs("div",{style:{fontSize:12,opacity:.85},children:["Incoming stress: ",t.crucible.incoming," • DC ",t.crucible.dc," • Roll CUF (no bonus/penalty dice)"]}),e.jsx("button",{style:se.buttonSecondary,onClick:()=>t.rollCrucibleTest(t.crucible.incoming),children:"Roll Crucible"})]}),t.crucible&&t.crucible.status==="success"&&e.jsxs("div",{style:se.crucibleBox,children:[e.jsx("div",{style:{fontWeight:700},children:"Crucible succeeded!"}),e.jsx("div",{style:{fontSize:12,opacity:.85},children:"Choose an Indomitable effect. (Indomitable checked automatically.)"})]}),t.crucible&&t.crucible.status==="fail"&&e.jsxs("div",{style:se.crucibleBox,children:[e.jsx("div",{style:{fontWeight:700},children:"Crucible failed"}),e.jsx("div",{style:{fontSize:12,opacity:.85},children:"You’ve entered PTSD range (6–8 stress)."}),e.jsx("button",{style:se.buttonSecondary,onClick:t.burnCufToPass,children:"Spend 1 CUF to pass"})]})]})]})}const se={statusBar:{display:"flex",alignItems:"flex-start",justifyContent:"space-between",gap:12,padding:"10px 12px",borderRadius:12,border:"1px solid rgba(255,255,255,0.15)",marginBottom:10},statusLeft:{display:"flex",alignItems:"center",gap:16,flexWrap:"wrap"},statusRight:{display:"flex",alignItems:"center",gap:12},statusGroup:{display:"flex",flexDirection:"column",gap:4},statusLabel:{fontSize:11,opacity:.75,letterSpacing:.2},statusNumber:{width:64,fontSize:16},woundsRow:{display:"flex",alignItems:"center",gap:8,flexWrap:"wrap"},woundsKind:{fontSize:11,opacity:.75,width:14,textAlign:"center"},warning:{marginTop:8,fontSize:12,opacity:.9},crucibleBox:{border:"1px solid rgba(255,255,255,0.18)",borderRadius:12,padding:10,maxWidth:240},buttonSecondary:{padding:"6px 10px",borderRadius:8,border:"1px solid #999",cursor:"pointer",opacity:.9,background:"transparent"}};function Ta(t){const s=ht(),y=s.palette.text.primary,f=s.palette.mode==="dark"?"rgba(255,255,255,0.25)":"#777",C=s.palette.mode==="dark"?"rgba(255,255,255,0.12)":"transparent";return e.jsxs("div",{style:{display:"flex",gap:8,alignItems:"center",marginBottom:10},children:[e.jsx(je,{label:"Core",active:t.activeTab==="core",onClick:()=>t.onTab("core"),color:y,borderColor:f,activeBg:C}),e.jsx(je,{label:"Skills",active:t.activeTab==="skills",onClick:()=>t.onTab("skills"),color:y,borderColor:f,activeBg:C}),e.jsx(je,{label:"Combat",active:t.activeTab==="combat",onClick:()=>t.onTab("combat"),color:y,borderColor:f,activeBg:C}),e.jsx(je,{label:"Initiative",active:t.activeTab==="initiative",onClick:()=>t.onTab("initiative"),color:y,borderColor:f,activeBg:C}),e.jsx(je,{label:"Inventory",active:t.activeTab==="inventory",onClick:()=>t.onTab("inventory"),color:y,borderColor:f,activeBg:C}),e.jsx(je,{label:"Feats",active:t.activeTab==="feats",onClick:()=>t.onTab("feats"),color:y,borderColor:f,activeBg:C}),e.jsx("div",{style:{marginLeft:"auto",opacity:.8},children:t.isSaving?"Saving…":"Synced"})]})}function je(t){return ht().palette.mode,e.jsx("button",{onClick:t.onClick,style:{padding:"6px 10px",borderRadius:999,border:`1px solid ${t.borderColor}`,cursor:"pointer",background:t.active?t.activeBg:"transparent",fontWeight:t.active?700:400,color:t.color,outline:"none",boxShadow:"none",appearance:"none"},children:t.label})}function Aa(){var Re,Qe,Xe,Ze;const[t,s]=S.useState({kind:"loading"}),[y,f]=S.useState("core"),[C,p]=S.useState(!1),[o,i]=S.useState(null),[k,B]=S.useState(!1),[K,v]=S.useState([]);async function P(u){var r,M,I,R,z,F;try{const G=await H.scene.items.getItems([u]),N=G==null?void 0:G[0];if(!N)return{ownerLabel:"unowned",thumbUrl:null};const ae=((r=N==null?void 0:N.image)==null?void 0:r.url)??((M=N==null?void 0:N.image)==null?void 0:M.href)??(N==null?void 0:N.imageUrl)??(N==null?void 0:N.image)??((I=N==null?void 0:N.thumbnail)==null?void 0:I.url)??null,ne=(R=N==null?void 0:N.metadata)==null?void 0:R[ct];if(typeof ne!="string"||ne.length===0)return{ownerLabel:"unowned",thumbUrl:ae,ownerPlayerId:null,isOwnedByMe:!1};const ce=await H.player.getId();if(ne===ce)return{ownerLabel:"owned by you",thumbUrl:ae,ownerPlayerId:ne,isOwnedByMe:!0};try{const U=(await((F=(z=H.party).getPlayers)==null?void 0:F.call(z))??[]).find(ge=>(ge==null?void 0:ge.id)===ne);return{ownerLabel:`owned by ${typeof(U==null?void 0:U.name)=="string"&&U.name.length>0?U.name:ne}`,thumbUrl:ae,ownerPlayerId:ne,isOwnedByMe:!1}}catch{return{ownerLabel:`owned by ${ne}`,thumbUrl:ae,ownerPlayerId:ne,isOwnedByMe:!1}}}catch{return{ownerLabel:"unowned",thumbUrl:null,ownerPlayerId:null,isOwnedByMe:!1}}}async function te(u){const r=u!=null&&u.ignoreOpenOverride?null:await Rt();if(r)if(await Oe(r)){const ne=await _e(r);if(!ne)throw new Error("Could not load sheet from token.");const ce=Se(ne.skills??{}),fe={...ne,attributes:ce},U=await P(r);s({kind:"ready",tokenId:r,sheet:fe,mode:"view",suppressUnset:!0,...U});return}else await qe(null);let I=await dt();if(I||(I=await tt(),I&&await we(I)),!I){s({kind:"need-token"});return}let R=await Oe(I);if(!R){const ae=await tt();ae&&(I=ae,await we(I),R=await Oe(I))}if(!R){await we(null),s({kind:"need-token"});return}const z=await _e(I);if(!z)throw new Error("Could not load sheet from token.");try{await at(I)}catch{}const F=Se(z.skills??{}),G={...z,attributes:F},N=await P(I);s({kind:"ready",tokenId:I,sheet:G,mode:"my",suppressUnset:!!(u!=null&&u.suppressUnset),...N})}S.useEffect(()=>{let u=!1;return H.onReady(async()=>{try{const r=await H.player.getRole();u||B(String(r).toUpperCase()==="GM"),await te()}catch(r){u||s({kind:"error",message:r.message??"Unknown error"})}}),()=>{u=!0}},[]),S.useEffect(()=>{let u=null,r=!1;return H.onReady(()=>{r||(u=H.broadcast.onMessage(Ke,M=>{const I=M.data;I!=null&&I.text&&v(R=>[...R,I].slice(-3))}))}),()=>{if(r=!0,typeof u=="function")try{u()}catch{}}},[]),S.useEffect(()=>{let u=null,r=null,M=!1;const I="whisperspace.combatLogLeader",R=2e3,z=6e3,F=`${Date.now()}-${Math.random().toString(36).slice(2,10)}`,G=()=>{try{const U=localStorage.getItem(I);return U?JSON.parse(U):null}catch{return null}},N=U=>{try{localStorage.setItem(I,JSON.stringify({id:F,ts:U??Date.now()}))}catch{}},ae=()=>{const U=G();return U&&U.id===F},ne=()=>{const U=Date.now(),oe=G();(!oe||U-(oe.ts??0)>z||oe.id===F)&&N(U)},ce=()=>{const U=ae();if(U&&!u)u=H.broadcast.onMessage(Ke,oe=>{const ge=oe.data;ge!=null&&ge.text&&H.notification.show(String(ge.text),"INFO")});else if(!U&&u){try{u()}catch{}u=null}},fe=U=>{U.key===I&&ce()};return H.onReady(()=>{if(!M){try{window.addEventListener("storage",fe)}catch{}ne(),ce(),r=window.setInterval(()=>{M||(ne(),ce())},R)}}),()=>{M=!0;try{window.removeEventListener("storage",fe)}catch{}if(r!==null&&clearInterval(r),ae())try{localStorage.removeItem(I)}catch{}if(typeof u=="function")try{u()}catch{}}},[]);function re(u,r,M){const I={text:`${u} took ${r} damage${M?` and +${M} stress`:""}.`,ts:Date.now(),kind:"effect",targetName:u,damageApplied:r,stressApplied:M};v(R=>[...R,I].slice(-3))}function le(u){if(t.kind!=="ready"||t.mode!=="my")return;const r=Math.max(0,Math.trunc(u.damageApplied??0)),M=Math.max(0,Math.trunc(u.stressApplied??0));r<=0&&M<=0||j(I=>{var z;const R=pt({sheet:I,incomingDamage:r,stressDelta:M});return R.stressDelta>0&&h(((z=R.sheet.stress)==null?void 0:z.current)??0),re(t.sheet.name||"Target",r,M),R.sheet})}S.useEffect(()=>{var R,z,F,G;if(t.kind!=="ready")return;const u=t.tokenId;let r=!1;const M=async()=>{var N,ae;try{const ne=await H.scene.items.getItems([u]),ce=ne==null?void 0:ne[0],fe=String(((N=ce==null?void 0:ce.text)==null?void 0:N.plainText)??"").trim(),U=(ae=ce==null?void 0:ce.image)==null?void 0:ae.url;if(r||!fe&&!U)return;s(oe=>{if(oe.kind!=="ready"||oe.tokenId!==u)return oe;const ge=fe&&oe.sheet.name!==fe?{...oe.sheet,name:fe}:oe.sheet;return{...oe,sheet:ge,thumbUrl:U??oe.thumbUrl}})}catch{}};M();const I=(G=(F=(z=(R=H)==null?void 0:R.scene)==null?void 0:z.items)==null?void 0:F.onChange)==null?void 0:G.call(F,N=>{Array.isArray(N)&&N.some(ae=>(ae==null?void 0:ae.id)===u)&&M()});return()=>{r=!0,typeof I=="function"&&I()}},[t.kind,t.kind==="ready"?t.tokenId:null]);const Z=S.useMemo(()=>t.kind==="ready"&&t.sheet.name||"Whisperspace Character Sheet",[t]);async function m(){const u=await Jt();if(!u){s({kind:"error",message:"No token selected. Select a token on the map first."});return}const r=await _e(u);if(!r){s({kind:"error",message:"Could not attach a sheet to the selected token."});return}const M=Se(r.skills??{}),I={...r,attributes:M};await we(u);try{await at(u)}catch{}await qe(null);const R=await P(u);s({kind:"ready",tokenId:u,sheet:I,mode:"my",suppressUnset:!1,...R})}async function a(){await we(null);try{await Et()}catch{}s({kind:"need-token"})}async function n(){await qe(null),s({kind:"loading"});try{await te({ignoreOpenOverride:!0,suppressUnset:!0})}catch(u){s({kind:"error",message:u.message??"Unknown error"})}}async function T(u,r){p(!0);try{await Ge(u,r)}finally{p(!1)}}function j(u){s(r=>{if(r.kind!=="ready")return r;let M=u(r.sheet);try{const I=Se(M.skills??{});M={...M,attributes:{...M.attributes,...I},stress:{...M.stress??{current:0,cuf:0,cufLoss:0},cuf:ze(M.skills??{})}}}catch{}return T(r.tokenId,M),{...r,sheet:M}})}async function A(u){var G;if(t.kind!=="ready")return;const r=8+u,M=Math.max(0,Math.trunc(((G=t.sheet.stress)==null?void 0:G.cuf)??0)),I=`Crucible Test (DC ${r})`,R=M===0?"":` +${M}`,z=`1d12 # ${I}${R}`;let F;try{F=await Je({diceNotation:z,rollTarget:"everyone",showResults:!0,timeoutMs:6e3})}catch{H.notification.show("Dice+ roll failed or timed out.","WARNING");return}F>=r?(j(N=>({...N,stress:{...N.stress??{current:0,cuf:0,cufLoss:0},current:5},indomitable:!0})),i({incoming:u,dc:r,status:"success",total:F})):i({incoming:u,dc:r,status:"fail",total:F})}function h(u){var I;if(t.kind!=="ready")return;const r=Math.max(0,Math.trunc(((I=t.sheet.stress)==null?void 0:I.current)??0)),M=Math.max(0,Math.trunc(u));if(r<=5&&M>5){const R=M-r;i({incoming:R,dc:8+R,status:"pending"})}else i(null);j(R=>({...R,stress:{...R.stress??{current:0,cuf:0,cufLoss:0},current:M}}))}function L(u,r){var F;if(t.kind!=="ready")return;const I={light:4,moderate:2,heavy:1}[u],R=Math.max(0,Math.trunc(((F=t.sheet.wounds)==null?void 0:F[u])??0)),z=r<R?r:r+1;j(G=>({...G,wounds:{...G.wounds,[u]:Math.min(I,Math.max(0,z))}}))}function J(){var r;if(t.kind!=="ready"||!o||o.status!=="fail")return;const u=Math.max(0,Math.trunc(((r=t.sheet.stress)==null?void 0:r.cufLoss)??0));j(M=>({...M,stress:{...M.stress??{current:0,cuf:0,cufLoss:0},cufLoss:u+1,current:5},indomitable:!0})),i({...o,status:"success"})}const w=t.kind==="ready"?t.sheet:null,O=Ce.useMemo(()=>{if(!w)return{};const u=[];return(w.feats??[]).forEach(r=>{typeof(r==null?void 0:r.statusEffects)=="string"&&r.statusEffects.trim()&&u.push(r.statusEffects)}),(w.inventory??[]).forEach(r=>{typeof(r==null?void 0:r.statusEffects)=="string"&&r.statusEffects.trim()&&u.push(r.statusEffects)}),At(u)},[w]),X=Ce.useMemo(()=>{const u={},r=new Map,M=R=>{const z=String(R.id),F=String(R.name??R.label??"").toLowerCase().replace(/\s+/g,"_").replace(/[^a-z0-9_\-()]/g,"");z&&(r.set(z.toLowerCase(),z),F&&r.set(F,z))};(xe.inherent??[]).forEach(M),Object.values(xe.learned??{}).forEach(R=>{(R??[]).forEach(M)});const I=new Set(["phys","ref","soc","ment","carrying_capacity","cool_under_fire","speed","cuf","carry","capacity","spd"]);return Object.entries(O??{}).forEach(([R,z])=>{const F=String(R).toLowerCase();if(I.has(F))return;const G=r.get(F);G&&(u[G]=(u[G]??0)+(Number.isFinite(z)?z:0))}),u},[O]),$=Math.max(0,(((Re=w==null?void 0:w.attributes)==null?void 0:Re.phys)??0)+(O.phys??0)),c=Math.max(0,(((Qe=w==null?void 0:w.attributes)==null?void 0:Qe.ref)??0)+(O.ref??0)),g=Math.max(0,(((Xe=w==null?void 0:w.attributes)==null?void 0:Xe.soc)??0)+(O.soc??0)),W=Math.max(0,(((Ze=w==null?void 0:w.attributes)==null?void 0:Ze.ment)??0)+(O.ment??0)),V=5+$*5+(O.carrying_capacity??0);30+$*5+(O.speed??0);const he=w?ze(w.skills??{}):0,ke=Math.max(0,he+(O.cool_under_fire??0)),ye=Ce.useMemo(()=>w?{...w,attributes:{...w.attributes,phys:$,ref:c,soc:g,ment:W},stress:{...w.stress??{current:0,cuf:0,cufLoss:0},cuf:ke}}:null,[w,$,c,g,W,ke])??w,l=Ce.useMemo(()=>{var I;if(!w)return 0;const u=(w.weapons??[]).reduce((R,z)=>R+(z.bulk??0),0),r=((I=w.armor)==null?void 0:I.bulk)??0,M=(w.inventory??[]).reduce((R,z)=>{const F=z.quantity??1,G=z.bulk??0,N=Number.isFinite(G)?G:0,ae=Number.isFinite(F)?F:1;return R+N*ae},0);return u+r+M},[w]),d=w&&l>V*2?"Heavily Encumbered":w&&l>V?"Encumbered":"";if(t.kind==="loading")return e.jsx("div",{style:{padding:12},children:"Loading…"});if(t.kind==="need-token")return e.jsxs("div",{style:{padding:12},children:[e.jsx("h2",{style:{margin:"0 0 8px 0"},children:"Whisperspace Character Sheet"}),e.jsx("p",{style:{margin:"0 0 10px 0",lineHeight:1.35},children:"Select your character token on the map, then click:"}),e.jsx("button",{style:{padding:"8px 10px",borderRadius:8,border:"1px solid #666",cursor:"pointer"},onClick:m,children:"Set Selected Token as My Character"})]});if(t.kind==="error")return e.jsxs("div",{style:{padding:12},children:[e.jsx("h2",{style:{margin:"0 0 8px 0"},children:"Error"}),e.jsx("p",{style:{margin:"0 0 10px 0",lineHeight:1.35},children:t.message}),e.jsx("button",{style:{padding:"8px 10px",borderRadius:8,border:"1px solid #666",cursor:"pointer"},onClick:()=>s({kind:"need-token"}),children:"Back"})]});const b=t.ownerLabel??(t.mode==="view"?"Viewing token":"My Character"),Q=t.mode==="view"&&!t.isOwnedByMe,be=t.mode==="my"&&!t.suppressUnset;return e.jsxs("div",{style:{padding:12},children:[e.jsx(Ma,{title:Z,ownerLabel:b,tokenId:t.tokenId,thumbUrl:t.thumbUrl??null,showBackButton:Q,onBack:n,showUnsetButton:be,onUnset:a}),e.jsxs(e.Fragment,{children:[e.jsx(Da,{sheet:t.sheet,sheetForView:ye,totalBulk:l,effectiveCarryingCapacity:V,encumbranceLabel:d,crucible:o,applyStress:h,toggleWound:L,setIndomitable:u=>j(r=>({...r,indomitable:u})),rollCrucibleTest:A,burnCufToPass:J}),e.jsx(Ta,{activeTab:y,onTab:f,isSaving:C}),e.jsxs("div",{style:{border:"1px solid #888",borderRadius:12,padding:10},children:[y==="core"&&e.jsx(aa,{sheet:ye,onChange:u=>j(r=>({...r,...u}))}),y==="skills"&&e.jsx(sa,{sheet:ye,skillMods:X,onChange:u=>j(r=>({...r,skills:u})),onMetaChange:u=>j(r=>({...r,...u}))}),y==="combat"&&e.jsx(fa,{sheet:ye,tokenId:t.tokenId,skillMods:X,onChange:u=>j(r=>({...r,...u})),onApplyStress:h,combatLog:K,onApplyCombatLog:t.mode==="my"?le:void 0,isGM:k}),y==="initiative"&&e.jsx(Ia,{}),y==="inventory"&&e.jsx(Sa,{sheet:ye,onChange:u=>j(r=>({...r,...u}))}),y==="feats"&&e.jsx(ra,{sheet:ye,onChange:u=>j(r=>({...r,feats:u}))})]})]})]})}async function Ra(){await H.onReady(async()=>{}),kt.createRoot(document.getElementById("root")).render(e.jsx(Ce.StrictMode,{children:e.jsx(Gt,{children:e.jsx(Aa,{})})}))}Ra();
