import{r as it,b as ze,s as xe,c as gt,F as yt,a as Ke,o as bt,l as Ee,T as lt,d as pt,e as kt,f as vt,g as jt,h as ot,i as Ze,j as Pe,k as Ge,m as Ce,n as wt,u as Ct,p as St,q as It,t as Be,v as _e,w as et,x as we,y as tt,z as Mt}from"./statusEffects-BG_oMj9Y.js";import{r as w,j as e,d as Se,e as Dt}from"./vendor_react-XzhcIodj.js";import{O as _}from"./vendor_obr-BLY5dk8V.js";import{S as O,B as E,T as D,a as We,b as ee,c as y,d as ye,I as le,C as Ie,R as Tt,A as Me,e as De,E as Te,f as Ae,g as ue,h as ct,i as ke,P as At,D as Le,L as at,j as Rt,M as de,k as dt,l as Et,m as Nt,n as Pt,o as zt,p as Wt,q as Lt,r as Ft,s as Bt,t as _t,u as Ot,v as ut,w as qt,x as Ut,y as $t}from"./vendor_mui-C1cVQ6D4.js";import"./vendor_zod-CxP395f9.js";import"./vendor-CPvQcOsy.js";import"./vendor_emotion-pcfylbOS.js";async function Ht(){const t=await _.player.getSelection();return Array.isArray(t)?t:[]}async function Gt(){const t=await Ht();return t.length>0?t[0]:null}async function Oe(t){return(await _.scene.items.getItems([t])).length>0}function Yt(t){var i;const n=t.sheet,[x,h]=w.useState(0),p=w.useMemo(()=>n.attributes??{phys:0,ref:0,soc:0,ment:0},[n.attributes]);async function b(r,v){const z=Number(p[r]??0),U=ze({netDice:x,modifier:z,label:v});await it({diceNotation:U,showResults:!0,rollTarget:"everyone"})}return e.jsxs(O,{spacing:2,children:[e.jsxs(E,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",gap:2,flexWrap:"wrap"},children:[e.jsx(D,{variant:"h6",sx:{m:0},children:"Core"}),e.jsxs(E,{sx:{display:"flex",alignItems:"center",gap:1,flexWrap:"wrap"},children:[e.jsx(D,{variant:"subtitle2",sx:{opacity:.8},children:"Attribute Roll:"}),e.jsxs(We,{size:"small",exclusive:!0,value:x,onChange:(r,v)=>{v!==null&&h(v)},children:[e.jsx(ee,{value:-2,children:"−2"}),e.jsx(ee,{value:-1,children:"−1"}),e.jsx(ee,{value:0,children:"0"}),e.jsx(ee,{value:1,children:"+1"}),e.jsx(ee,{value:2,children:"+2"})]})]})]}),e.jsx(y,{label:"Name",size:"small",value:n.name??"",onChange:r=>t.onChange({name:r.target.value}),fullWidth:!0}),e.jsxs(E,{sx:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:1},children:[e.jsx(Ne,{label:"PHYS",value:p.phys,onRoll:()=>b("phys","PHYS Check")}),e.jsx(Ne,{label:"REF",value:p.ref,onRoll:()=>b("ref","REF Check")}),e.jsx(Ne,{label:"SOC",value:p.soc,onRoll:()=>b("soc","SOC Check")}),e.jsx(Ne,{label:"MENT",value:p.ment,onRoll:()=>b("ment","MENT Check")})]}),e.jsxs(E,{sx:{display:"grid",gridTemplateColumns:"repeat(3, 1fr)",gap:2},children:[e.jsx(y,{label:"Cool Under Fire",size:"small",value:((i=t.sheet.stress)==null?void 0:i.cuf)??0,inputProps:{readOnly:!0},fullWidth:!0}),e.jsx(y,{label:"Speed",size:"small",value:30+(p.phys??0)*5,inputProps:{readOnly:!0},fullWidth:!0}),e.jsx(y,{label:"Carrying Capacity",size:"small",value:5+(p.phys??0)*5,inputProps:{readOnly:!0},fullWidth:!0})]}),e.jsx(D,{variant:"body2",sx:{opacity:.75},children:"Attributes are derived automatically from skill ranks (¼ of total ranks under each attribute, rounded up)."})]})}function Ne(t){return e.jsxs(E,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(y,{label:t.label,size:"small",value:t.value,inputProps:{readOnly:!0},fullWidth:!0}),e.jsx(ye,{title:"Roll with Dice+",children:e.jsx(le,{onClick:t.onRoll,"aria-label":`Roll ${t.label}`,children:e.jsx(Ie,{})})})]})}function Je(){const t=new Map;return Object.keys(xe.learned).forEach(n=>{(xe.learned[n]??[]).forEach(x=>t.set(x.id,{focus:n}))}),t}function mt(t){var r,v;const n=String(t.skillId??""),x=((r=t.sheet.skills)==null?void 0:r[n])??0,h=((v=t.skillMods)==null?void 0:v[n])??0;if(x>0)return x+h;const p=t.sheet.learningFocus??"combat",b=t.learnedInfoById.get(n);return(b&&b.focus===p?0:-1)+h}const Kt=["phys","ref","soc","ment"],qe={phys:"PHYSIQUE",ref:"REFLEX",soc:"SOCIAL",ment:"MENTAL"},Ue={combat:"Combat",education:"Education",vehicles:"Vehicles"},nt={combat:"Combat Focus",education:"Education Focus",vehicles:"Vehicles Focus"};function $e(t){const n=ht(t,0,5);return n*(n+1)/2}function Jt(t){const[n,x]=w.useState(""),[h,p]=w.useState(0),[b,i]=w.useState(!0),[r,v]=w.useState(!1),[z,U]=w.useState(""),k=t.sheet.skills??{},N=t.sheet.learningFocus??"combat",V=Number(t.sheet.skillPoints??0);w.useEffect(()=>{let c=!1;return(async()=>{const g=await gt();c||(i(g),v(!0))})().catch(()=>{c||(i(!1),v(!0))}),()=>{c=!0}},[]);const se=w.useMemo(()=>Je(),[]);function ie(c){const g=se.get(c.id);return g?g.focus===N?5:2:5}function Y(c){var X;const g=k[c.id]??0,F=((X=t.skillMods)==null?void 0:X[c.id])??0;if(g>0)return g+F;const K=se.get(c.id);return K&&K.focus===N?0+F:-1+F}const d=w.useMemo(()=>{let c=0;for(const g of Object.values(k))c+=$e(g??0);return c},[k]),a=Math.max(0,V-d),s=c=>{const g=Math.max(0,Math.trunc(Number(z)));if(!g)return;const F=V+c*g,K=Math.max(d,F);t.onMetaChange({skillPoints:K}),U("")};function T(c){t.onChange(c)}function j(c,g){const F=k[c.id]??0,K=ie(c),X=ht(g,0,K);if(X===F||$e(X)-$e(F)>a)return;const me={...k};X===0?delete me[c.id]:me[c.id]=X,T(me)}async function A(c){const g=ze({netDice:h,modifier:Y(c),label:c.label});try{await it({diceNotation:g,showResults:!0,rollTarget:"everyone"})}catch(F){console.error("Dice+ roll request failed:",F)}}const f=w.useMemo(()=>{const c=Object.values(xe.learned).flat();return[...xe.inherent,...c]},[]),L=w.useMemo(()=>{const c=n.trim().toLowerCase();return c?f.filter(g=>g.label.toLowerCase().includes(c)||g.id.toLowerCase().includes(c)):f},[f,n]),Q=w.useMemo(()=>Vt(xe.inherent),[]),C=w.useMemo(()=>xe.learned,[]),$=n.trim().length>0,Z=e.jsxs(E,{sx:{display:"flex",alignItems:"center",gap:2,flexWrap:"wrap"},children:[e.jsx(D,{variant:"subtitle2",sx:{opacity:.8},children:"Learning Focus:"}),Object.keys(nt).map(c=>e.jsxs(E,{sx:{display:"flex",alignItems:"center",gap:.5,cursor:"pointer"},onClick:()=>t.onMetaChange({learningFocus:c}),children:[e.jsx(Tt,{checked:N===c,value:c,size:"small"}),e.jsx(D,{variant:"body2",children:Ue[c]})]},c))]}),G=e.jsx(E,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",gap:2,flexWrap:"wrap"},children:e.jsxs(E,{sx:{display:"flex",alignItems:"center",gap:1,flexWrap:"wrap"},children:[e.jsxs(D,{variant:"subtitle2",sx:{minWidth:170},children:["Skill Points: ",a," ",e.jsxs("span",{style:{opacity:.75},children:["(Total: ",V,")"]})]}),e.jsx(ue,{size:"small",variant:"outlined",onClick:()=>s(1),disabled:!Number.isFinite(Number(z))||Math.trunc(Number(z))<=0,children:"+"}),e.jsx(y,{label:"SP",size:"small",type:"number",value:z,onChange:c=>U(c.target.value),sx:{width:110}}),e.jsx(ue,{size:"small",variant:"outlined",onClick:()=>s(-1),disabled:!Number.isFinite(Number(z))||Math.trunc(Number(z))<=0,children:"-"}),e.jsx(D,{variant:"subtitle2",sx:{opacity:.8},children:"Roll"}),e.jsxs(We,{size:"small",exclusive:!0,value:h,onChange:(c,g)=>{g!==null&&p(g)},"aria-label":"Bonus / Penalty dice",children:[e.jsx(ee,{value:-2,children:"−2"}),e.jsx(ee,{value:-1,children:"−1"}),e.jsx(ee,{value:0,children:"0"}),e.jsx(ee,{value:1,children:"+1"}),e.jsx(ee,{value:2,children:"+2"})]}),r&&!b&&e.jsx(D,{variant:"caption",sx:{opacity:.8},children:"(Dice+ not detected)"})]})});return e.jsxs(O,{spacing:2,children:[Z,e.jsx(y,{label:"Search skills",value:n,onChange:c=>x(c.target.value),placeholder:"stealth, weapons, navigation…",fullWidth:!0}),G,$?e.jsx(O,{spacing:1,children:L.map(c=>{const g=se.get(c.id),F=g?Ue[g.focus]:qe[c.attribute];return e.jsx(He,{skill:c,rank:k[c.id]??0,modifier:Y(c),maxRank:ie(c),onRank:K=>j(c,K),rightTag:F,canRoll:b,onRoll:()=>A(c)},c.id)})}):e.jsxs(e.Fragment,{children:[e.jsx(D,{variant:"subtitle1",children:"Inherent Skills"}),Kt.map(c=>e.jsxs(Me,{defaultExpanded:!0,children:[e.jsx(De,{expandIcon:e.jsx(Te,{}),children:e.jsx(D,{fontWeight:700,children:qe[c]})}),e.jsx(Ae,{children:e.jsx(O,{spacing:1,children:(Q[c]??[]).map(g=>e.jsx(He,{skill:g,rank:k[g.id]??0,modifier:Y(g),maxRank:ie(g),onRank:F=>j(g,F),rightTag:qe[g.attribute],canRoll:b,onRoll:()=>A(g)},g.id))})})]},c)),e.jsx(D,{variant:"subtitle1",sx:{mt:1},children:"Learned Skills"}),Object.keys(C).map(c=>e.jsxs(Me,{defaultExpanded:!0,children:[e.jsx(De,{expandIcon:e.jsx(Te,{}),children:e.jsx(D,{fontWeight:700,children:nt[c]})}),e.jsx(Ae,{children:e.jsx(O,{spacing:1,children:(C[c]??[]).map(g=>e.jsx(He,{skill:g,rank:k[g.id]??0,modifier:Y(g),maxRank:ie(g),onRank:F=>j(g,F),rightTag:Ue[c],canRoll:b,onRoll:()=>A(g)},g.id))})})]},c))]})]})}function He(t){const n=t.rank<t.maxRank,x=t.rank>0;return e.jsxs(E,{sx:{display:"grid",gridTemplateColumns:"1fr auto auto auto",gap:1,alignItems:"center",border:"1px solid",borderColor:"divider",borderRadius:2,px:1.25,py:1},children:[e.jsxs(E,{sx:{minWidth:0},children:[e.jsx(D,{fontWeight:600,noWrap:!0,children:t.skill.label}),e.jsx(D,{variant:"caption",sx:{opacity:.7},noWrap:!0,children:t.rightTag??""})]}),e.jsxs(E,{sx:{width:46,textAlign:"center"},children:[e.jsx(D,{variant:"caption",sx:{opacity:.7,lineHeight:1},children:"Mod"}),e.jsx(D,{sx:{fontWeight:700,lineHeight:1.2},children:t.modifier>=0?`+${t.modifier}`:`${t.modifier}`})]}),e.jsxs(E,{sx:{width:40,textAlign:"center"},children:[e.jsx(D,{variant:"caption",sx:{opacity:.7,lineHeight:1},children:"Rank"}),e.jsx(D,{sx:{fontWeight:700,lineHeight:1.2},children:t.rank})]}),e.jsxs(E,{sx:{display:"flex",gap:.5,alignItems:"center",justifyContent:"flex-end"},children:[e.jsx(le,{size:"small",onClick:()=>t.onRank(t.rank-1),"aria-label":"Decrease rank",disabled:!x,children:e.jsx(ct,{fontSize:"small"})}),e.jsx(le,{size:"small",onClick:()=>t.onRank(t.rank+1),"aria-label":"Increase rank",disabled:!n,children:e.jsx(ke,{fontSize:"small"})}),e.jsx(E,{sx:{width:6}}),e.jsx(ye,{title:t.canRoll?"Roll with Dice+":"Dice+ not detected",children:e.jsx("span",{children:e.jsx(le,{size:"small",onClick:t.onRoll,"aria-label":`Roll ${t.skill.label}`,disabled:!t.canRoll,children:e.jsx(Ie,{fontSize:"small"})})})})]})]})}function Vt(t){return t.reduce((n,x)=>{var h;return(n[h=x.attribute]??(n[h]=[])).push(x),n},{})}function ht(t,n,x){const h=Number.isFinite(t)?Math.trunc(t):n;return Math.max(n,Math.min(x,h))}function Qt(t){const n=t.sheet.feats??[];function x(){t.onChange([...n,{name:"New Feat",description:"",statusEffects:""}])}function h(b,i){const r=[...n];r[b]={...r[b],...i},yt.safeParse(r[b]),t.onChange(r)}function p(b){const i=[...n];i.splice(b,1),t.onChange(i)}return e.jsxs(O,{spacing:2,children:[e.jsxs(O,{direction:"row",justifyContent:"space-between",alignItems:"center",children:[e.jsx(D,{variant:"h6",children:"Feats"}),e.jsx(ue,{variant:"contained",startIcon:e.jsx(ke,{}),onClick:x,children:"Add Feat"})]}),n.length===0?e.jsx(D,{variant:"body2",sx:{opacity:.75},children:"No feats yet."}):e.jsx(O,{spacing:2,children:n.map((b,i)=>e.jsx(At,{sx:{p:2},children:e.jsxs(O,{spacing:1.5,children:[e.jsxs(O,{direction:"row",spacing:1,alignItems:"center",children:[e.jsx(y,{label:"Feat Name",fullWidth:!0,value:b.name,onChange:r=>h(i,{name:r.target.value})}),e.jsx(le,{"aria-label":"Remove feat",onClick:()=>p(i),children:e.jsx(Le,{})})]}),e.jsx(y,{label:"Description",fullWidth:!0,multiline:!0,minRows:4,value:b.description,onChange:r=>h(i,{description:r.target.value})}),e.jsx(y,{label:"Status Effects",fullWidth:!0,helperText:'Comma-separated, e.g. "carrying_capacity+5"',value:b.statusEffects??"",onChange:r=>h(i,{statusEffects:r.target.value})})]})},`${b.name}-${i}`))})]})}const Xt=[{id:"pistol",name:"Pistol",skillId:"weapons_light",useDC:7,damage:2,range:"Med",ammo:10,bulk:1,cost:500},{id:"smart_pistol",name:"SMART Pistol",skillId:"weapons_light",useDC:9,damage:4,range:"Med",ammo:6,bulk:1,keywords:["Smart-Linked"],cost:900},{id:"toxic_spike",name:"Toxic Spike",skillId:"weapons_light",useDC:10,damage:3,range:"Short",ammo:1,bulk:1,keywords:["Toxin (Prax)","Concealable"],cost:750},{id:"smg",name:"SMG",skillId:"weapons_medium",useDC:6,damage:3,range:"Med",ammo:8,bulk:2,keywords:["Bullet Spray"],cost:600},{id:"photon_rifle",name:"Photon Rifle",skillId:"weapons_medium",useDC:8,damage:6,range:"Long",ammo:6,bulk:3,keywords:["Two-Handed"],cost:5e3},{id:"rifle",name:"Rifle",skillId:"weapons_medium",useDC:8,damage:4,range:"Long",ammo:8,bulk:2,keywords:["Two-Handed","Piercing 1"],cost:1e3},{id:"shotgun",name:"Shotgun",skillId:"weapons_medium",useDC:8,damage:4,range:"Short",ammo:4,bulk:3,req:"PHYS 1",keywords:["Point Blank","Shredding 1"],cost:800},{id:"gauss_cannon",name:"Gauss Cannon",skillId:"weapons_heavy",useDC:7,damage:4,range:"Med",ammo:20,bulk:4,req:"PHYS 3",keywords:["Bullet Spray"],cost:900},{id:"grenade_launcher",name:"Grenade Launcher",skillId:"weapons_heavy",useDC:8,damage:3,range:"Med",ammo:1,bulk:3,req:"PHYS 2",keywords:["Area (near)","Two-Handed","Slow Load","Grenade"],cost:2e3},{id:"magneton_cannon",name:"Magneton Cannon",skillId:"weapons_exotic",useDC:5,damage:2,range:"Short",ammo:5,bulk:2,req:"PHYS 1",keywords:["Area (melee)","Slow Load","Shredding 3"],cost:8e3},{id:"tesla_rifle",name:"Tesla Rifle",skillId:"weapons_exotic",useDC:8,damage:5,range:"Med",ammo:6,bulk:2,keywords:["Two-Handed","Stun 2"],cost:6e3},{id:"stun_baton",name:"Stun Baton",skillId:"melee_weapons",useDC:6,damage:0,range:"Melee",bulk:1,keywords:["Stun 1"],cost:450},{id:"switchblade",name:"Switchblade",skillId:"melee_weapons",useDC:9,damage:2,range:"Melee",bulk:1,keywords:["Concealable","Thrown"],cost:150},{id:"fusion_blade",name:"Fusion Blade",skillId:"melee_weapons",useDC:8,damage:3,range:"Melee",bulk:2,req:"REF 2",keywords:["Piercing 2"],cost:1200},{id:"rocket_maul",name:"Rocket Maul",skillId:"melee_weapons",useDC:10,damage:6,range:"Melee",ammo:2,bulk:3,req:"PHYS 3",keywords:["Two-Handed"],cost:2500}],Zt={weapons:Xt},st=Zt.weapons??[],ea=[{id:"scrap_armour",name:"Scrap Armour",protection:1,durability:2,bulk:2,special:"Cannot be repaired",cost:500},{id:"flak_jacket",name:"Flak Jacket",protection:1,durability:4,bulk:1,cost:1250},{id:"kevlar_clothing",name:"Kevlar Clothing",protection:1,durability:3,bulk:1,special:"Appears to be normal clothing",cost:1500},{id:"streetweave_jacket",name:"Streetweave Jacket",protection:1,durability:5,bulk:1,special:"+1 to Stealth",cost:2500},{id:"milsec_bodyplate",name:"MilSec Bodyplate",protection:2,durability:6,bulk:2,cost:5e3},{id:"breaching_plate",name:"Breaching plate",protection:2,durability:4,bulk:3,req:"PHYS 2",special:"Frontal Shielding 1",cost:8500},{id:"heavy_bodyplate",name:"Heavy Bodyplate",protection:3,durability:8,bulk:4,req:"PHYS 3",special:"+1 penalty die to Stealth",cost:1e4},{id:"basic_power_armour",name:"Basic Power Armour",protection:4,durability:14,bulk:10,req:"Power Armour 1",special:`Requires Power Armour (DC5) check to activate. Failure: become Immobile; gain +1 penalty die to all PHYS and REF based checks. When activated, reduces its own bulk to 1 and grants +1 bonus die to all PHYS based checks.
`,cost:4e4}],ta={armor:ea},rt=ta.armor??[],Ye="whisperspace.obr.sheet/combat-log";function aa(t){return t>=9?4:t>=7?3:t>=4?2:0}async function na(t){const n=Number.isFinite(t.useDC)?Math.trunc(t.useDC):Math.trunc(t.weapon.useDC),x=t.weapon.name||"Attack",h=ze({netDice:t.netDice,modifier:t.modifier,label:x}),p=await Ke({diceNotation:h,rollTarget:t.rollTarget??"everyone",showResults:t.showResults??!0}),b=p-n,i=p>=n,r=i?aa(b):0,v=i&&r>0,z=Math.trunc(t.weapon.damage??0),U=i?z+r:0,k=v?1:0;let N;i?v?N=`Extreme success - crit! ${x} rolled ${p} vs DC ${n}. Damage: ${z}+${r}=${U}. (+1 Stress)`:N=`Hit. ${x} rolled ${p} vs DC ${n}. Damage: ${z}.`:N=`Miss. ${x} rolled ${p} vs DC ${n}.`,t.prefix&&(N=`${t.prefix} ${N}`);const V={text:N,ts:Date.now(),kind:"attack",attackerName:t.attackerName,weaponName:x,outcome:{total:p,useDC:n,hit:i,isCrit:v,baseDamage:z,totalDamage:U,stressDelta:k}};return _.broadcast.sendMessage(Ye,V,{destination:"ALL"}),{total:p,useDC:n,margin:b,hit:i,isCrit:v,critExtra:r,baseDamage:z,totalDamage:U,stressDelta:k,message:N}}const ft=na;function xt(t){var Q,C;const n=Number.isFinite(t.incomingDamage)?Math.max(0,Math.trunc(t.incomingDamage)):0;if(n<=0&&!(t.stressDelta&&t.stressDelta>0))return{sheet:t.sheet,stressDelta:0};const x=!!t.unmitigated,h=t.sheet.armor,p=(((Q=h==null?void 0:h.durability)==null?void 0:Q.current)??0)<=0,b=x||p?0:(h==null?void 0:h.protection)??0,i=Math.max(0,n-b),r=t.sheet.wounds??{light:0,moderate:0,heavy:0};let v=r.light??0,z=r.moderate??0,U=r.heavy??0,k=i,N=0,V=0,se=0;const Y=Math.min(k,Math.max(0,4-v));v+=Y,k-=Y,N=Y;const a=Math.min(k,Math.max(0,2-z));z+=a,k-=a,V=a;const T=Math.min(k,Math.max(0,1-U));U+=T,k-=T,se=T;const j={light:v,moderate:z,heavy:U};let A=0;se>0?A=4:V>0?A=2:N>0&&(A=1),t.stressDelta&&t.stressDelta>0&&(A+=Math.trunc(t.stressDelta));let f=h;!x&&!p&&i>0&&(h!=null&&h.durability)&&(f={...h,durability:{...h.durability,current:Math.max(0,Math.trunc((h.durability.current??0)-1))}});const L=Math.max(0,Math.trunc((((C=t.sheet.stress)==null?void 0:C.current)??0)+A));return{sheet:{...t.sheet,wounds:j,armor:f,stress:{...t.sheet.stress??{current:0,cuf:0,cufLoss:0},current:L}},stressDelta:A}}function be(t){var h;if(!t)return 0;const n=(h=t.keywordParams)==null?void 0:h.ammoMax,x=typeof n=="number"?n:typeof n=="string"?Number(n):void 0;return Number.isFinite(x)?Number(x):0}function sa(t){const n="#e55353",x="#8b5cf6",h="#5b6bff",p="#26a269",b="#d64040";return e.jsxs(E,{sx:{border:"1px solid",borderColor:"divider",borderRadius:2,p:1.25},children:[e.jsx(D,{variant:"subtitle2",sx:{opacity:.8,mb:.5},children:"Combat Log"}),t.entries.length===0?e.jsx(D,{variant:"body2",sx:{opacity:.7},children:"No recent rolls."}):e.jsx(O,{spacing:.75,children:t.entries.map(i=>{var Y,d,a,s,T;const r=!!((Y=i.outcome)!=null&&Y.hit)&&((((d=i.outcome)==null?void 0:d.totalDamage)??0)>0||(((a=i.outcome)==null?void 0:a.stressDelta)??0)>0)&&!!t.onApply,v=r&&(((s=i.outcome)==null?void 0:s.totalDamage)??0)>0,z=r&&(((T=i.outcome)==null?void 0:T.stressDelta)??0)>0,U=v&&z,k=i.outcome,N=k!=null&&k.hit?"Hit":"Miss",V=k!=null&&k.hit?p:b,se=i.attackerName??"Unknown",ie=i.weaponName??"Attack";return e.jsxs(E,{sx:{display:"flex",alignItems:"center",gap:1,flexWrap:"wrap"},children:[e.jsx(D,{variant:"body2",sx:{flex:"1 1 260px"},children:i.kind==="effect"?e.jsxs(e.Fragment,{children:[e.jsx("strong",{children:i.targetName??"Target"})," ",(i.damageApplied??0)>0&&e.jsxs(e.Fragment,{children:["took"," ",e.jsx("strong",{style:{color:n},children:i.damageApplied})," ","damage"]}),(i.damageApplied??0)>0&&(i.stressApplied??0)>0&&" and ",(i.damageApplied??0)<=0&&(i.stressApplied??0)>0&&"took ",(i.stressApplied??0)>0&&e.jsxs(e.Fragment,{children:[e.jsx("strong",{style:{color:x},children:i.stressApplied})," ","stress"]}),"."]}):e.jsxs(e.Fragment,{children:[e.jsx("strong",{children:se}),": ",e.jsx("strong",{children:ie})," rolled"," ",(k==null?void 0:k.total)??0," vs DC ",(k==null?void 0:k.useDC)??0,"."," ",k!=null&&k.isCrit?e.jsxs(e.Fragment,{children:[e.jsx("strong",{style:{color:p},children:"Extreme success - "}),e.jsx("strong",{style:{color:h},children:"crit!"})]}):e.jsx("strong",{style:{color:V},children:N}),(k==null?void 0:k.hit)&&e.jsxs(e.Fragment,{children:[". Damage:"," ",e.jsx("strong",{style:{color:n},children:(k==null?void 0:k.totalDamage)??0}),k!=null&&k.stressDelta?e.jsxs(e.Fragment,{children:[" "," (+"," ",e.jsx("strong",{style:{color:x},children:k.stressDelta})," ","Stress)"]}):null]}),"."]})}),v&&e.jsx(ue,{size:"small",variant:"outlined",startIcon:e.jsx(at,{fontSize:"small"}),onClick:()=>{var j,A;return(A=t.onApply)==null?void 0:A.call(t,{...i,kind:"attack",damageApplied:((j=i.outcome)==null?void 0:j.totalDamage)??0,stressApplied:0})},children:"Apply Damage"}),z&&e.jsx(ue,{size:"small",variant:"outlined",startIcon:e.jsx(Rt,{fontSize:"small"}),onClick:()=>{var j,A;return(A=t.onApply)==null?void 0:A.call(t,{...i,kind:"attack",damageApplied:0,stressApplied:((j=i.outcome)==null?void 0:j.stressDelta)??0})},children:"Apply Stress"}),U&&e.jsx(ue,{size:"small",variant:"outlined",startIcon:e.jsx(at,{fontSize:"small"}),onClick:()=>{var j,A,f;return(f=t.onApply)==null?void 0:f.call(t,{...i,kind:"attack",damageApplied:((j=i.outcome)==null?void 0:j.totalDamage)??0,stressApplied:((A=i.outcome)==null?void 0:A.stressDelta)??0})},children:"Apply Both"})]},i.ts)})})]})}function ra(t){var Z,G,c,g,F,K,X,q,me,pe,Fe,ge;const n=t.sheet,[x,h]=w.useState(0),[p,b]=w.useState(null),[i,r]=w.useState(""),[v,z]=w.useState(!1),U=(t.combatLog??[]).slice(-3).reverse(),k=w.useMemo(()=>Je(),[]),N=w.useMemo(()=>{const o=Object.values(xe.learned).flat();return[...xe.inherent,...o]},[]),V=new Set(["melee_weapons","melee_unarmed","weapons_light","weapons_medium","weapons_heavy","weapons_exotic","explosives"]),se=N.filter(o=>V.has(o.id));w.useMemo(()=>[...N].sort((o,u)=>o.label.localeCompare(u.label)),[N]);function ie(){var te;const o=Number(i),u=Number.isFinite(o)?Math.max(0,Math.trunc(o)):0;if(u<=0)return;const S=xt({sheet:t.sheet,incomingDamage:u,unmitigated:v});t.onChange({wounds:S.sheet.wounds,armor:S.sheet.armor,stress:S.sheet.stress}),S.stressDelta>0&&t.onApplyStress&&t.onApplyStress(((te=S.sheet.stress)==null?void 0:te.current)??0),r("")}function Y(o){return mt({learnedInfoById:k,sheet:n,skillId:o,skillMods:t.skillMods})}function d(o,u){const S=[...n.weapons??[]],te=S[o];if(u.ammo!==void 0&&!be(te)&&u.ammo>0){const Re={...te.keywordParams??{},ammoMax:u.ammo};S[o]={...te,...u,keywordParams:Re},t.onChange({weapons:S});return}S[o]={...te,...u},t.onChange({weapons:S})}function a(o,u){if(o===null||o===u)return;const S=t.sheet.weapons??[];if(o<0||o>=S.length||u<0||u>=S.length)return;const te=[...S],[ve]=te.splice(o,1);te.splice(u,0,ve),t.onChange({weapons:te}),b(u)}function s(o){const u=st.find(te=>te.id===o);if(!u)return;const S=[...n.weapons??[]];S.push({name:u.name,skillId:u.skillId,useDC:u.useDC,damage:u.damage,range:u.range,ammo:u.ammo,bulk:u.bulk,req:u.req,cost:u.cost,keywords:[...u.keywords??[]],keywordParams:{ammoMax:u.ammo??0,...u.keywordParams??{}}}),t.onChange({weapons:S})}function T(){const o=[...n.weapons??[]];o.push({name:"New Weapon",skillId:"weapons_medium",useDC:8,damage:3,range:"Med",ammo:0,bulk:1,req:"",cost:0,keywords:[],keywordParams:{ammoMax:0}}),t.onChange({weapons:o})}function j(o){const u=[...n.weapons??[]];u.splice(o,1),t.onChange({weapons:u})}async function A(o,u){const S=be(u),te=Number.isFinite(u.ammo)?Number(u.ammo):0;if(S>0&&te<=0){_.notification.show("Out of ammo. Reload first.","WARNING");return}const ve=Y(u.skillId);await ft({weapon:u,useDC:Number.isFinite(u.useDC)?Number(u.useDC):0,netDice:x,modifier:ve,attackerName:t.sheet.name,rollTarget:"everyone",showResults:!0}),S>0&&d(o,{ammo:Math.max(0,te-1)})}const[f,L]=w.useState(""),[Q,C]=w.useState("");function $(o){const u=rt.find(S=>S.id===o);u&&t.onChange({armor:{name:u.name,keywords:[...u.keywords??[]],keywordParams:{...u.keywordParams??{}},protection:u.protection,durability:{current:u.durability,max:u.durability},bulk:u.bulk,req:u.req,cost:u.cost,special:u.special}})}return e.jsxs(O,{spacing:2,children:[e.jsx(E,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",gap:2,flexWrap:"wrap"},children:e.jsx(D,{variant:"h6",sx:{m:0},children:"Combat"})}),e.jsxs(E,{sx:{display:"flex",alignItems:"center",gap:1,flexWrap:"wrap"},children:[e.jsx(D,{variant:"subtitle2",sx:{opacity:.8},children:"Take Damage:"}),e.jsx(y,{size:"small",type:"number",inputProps:{min:0},value:i,onChange:o=>r(o.target.value),sx:{width:90}}),e.jsx(ee,{size:"small",value:"unmitigated",selected:v,onChange:()=>z(o=>!o),children:"Unmitigated"}),e.jsx(ue,{size:"small",variant:"outlined",onClick:ie,children:"Apply"})]}),e.jsxs(E,{sx:{display:"flex",alignItems:"center",gap:1,flexWrap:"wrap"},children:[e.jsx(D,{variant:"subtitle2",sx:{opacity:.8},children:"Attack Roll:"}),e.jsxs(We,{size:"small",exclusive:!0,value:x,onChange:(o,u)=>{u!==null&&h(u)},children:[e.jsx(ee,{value:-2,children:"−2"}),e.jsx(ee,{value:-1,children:"−1"}),e.jsx(ee,{value:0,children:"0"}),e.jsx(ee,{value:1,children:"+1"}),e.jsx(ee,{value:2,children:"+2"})]})]}),e.jsx(sa,{entries:U,onApply:t.onApplyCombatLog}),e.jsxs(Me,{defaultExpanded:!0,children:[e.jsx(De,{expandIcon:e.jsx(Te,{}),children:e.jsx(D,{fontWeight:700,children:"Weapons"})}),e.jsx(Ae,{children:e.jsxs(O,{spacing:1.5,children:[e.jsxs(E,{sx:{display:"flex",gap:1,alignItems:"center",flexWrap:"wrap"},children:[e.jsxs(y,{label:"Add prefab weapon",size:"small",select:!0,value:f,onChange:o=>L(o.target.value),sx:{minWidth:240},children:[e.jsx(de,{value:"",children:"— choose —"}),st.map(o=>e.jsx(de,{value:o.id,children:o.name},o.id))]}),e.jsx(le,{color:"primary",onClick:()=>s(f),"aria-label":"Add prefab weapon",disabled:!f,children:e.jsx(ke,{})}),e.jsx(E,{sx:{flex:1}}),e.jsx(le,{color:"primary",onClick:T,"aria-label":"Add custom weapon",children:e.jsx(ke,{})}),e.jsx(D,{variant:"body2",sx:{opacity:.75},children:"Add custom weapon"})]}),(n.weapons??[]).length===0?e.jsx(D,{sx:{opacity:.75},children:"No weapons yet."}):(n.weapons??[]).map((o,u)=>e.jsxs(E,{draggable:!0,onDragStart:()=>b(u),onDragEnd:()=>b(null),onDragOver:S=>{S.preventDefault()},onDrop:S=>{S.preventDefault(),a(p,u)},sx:{border:"1px solid",borderColor:"divider",borderRadius:2,p:1.25,cursor:"grab",opacity:p===u?.85:1,display:"grid",gap:1.25},children:[e.jsxs(E,{sx:{display:"flex",gap:1,alignItems:"center"},children:[e.jsx(y,{label:"Name",size:"small",value:o.name,onChange:S=>d(u,{name:S.target.value}),fullWidth:!0}),e.jsx(ye,{title:"Roll attack with Dice+",children:e.jsx(le,{onClick:()=>A(u,o),"aria-label":`Roll attack for ${o.name}`,children:e.jsx(Ie,{})})}),e.jsx(le,{onClick:()=>j(u),"aria-label":"Remove weapon",children:e.jsx(Le,{})})]}),e.jsxs(E,{sx:{display:"grid",gridTemplateColumns:"1fr 1fr 1fr 1fr",gap:1},children:[e.jsx(y,{label:"Skill",size:"small",select:!0,value:o.skillId,onChange:S=>d(u,{skillId:S.target.value}),children:se.map(S=>e.jsx(de,{value:S.id,children:S.label},S.id))}),e.jsx(y,{label:"Use DC",size:"small",type:"number",value:o.useDC,onChange:S=>d(u,{useDC:Number(S.target.value)})}),e.jsx(y,{label:"Damage",size:"small",type:"number",value:o.damage,onChange:S=>d(u,{damage:Number(S.target.value)})}),e.jsx(y,{label:"Range",size:"small",value:o.range??"",onChange:S=>d(u,{range:S.target.value}),placeholder:"Melee / Short / Med / Long"}),e.jsxs(E,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(y,{label:"Ammo",size:"small",type:"number",value:o.ammo??0,onChange:S=>d(u,{ammo:Number(S.target.value)}),sx:{width:110}}),e.jsxs(D,{variant:"body2",sx:{opacity:.8},children:["/ ",be(o)||0]}),e.jsx(ye,{title:"Reload",children:e.jsx("span",{children:e.jsx(le,{size:"small",onClick:()=>d(u,{ammo:be(o)||0}),disabled:(be(o)||0)<=0,children:e.jsx(dt,{fontSize:"small"})})})})]}),e.jsx(y,{label:"Bulk",size:"small",type:"number",value:o.bulk??0,onChange:S=>d(u,{bulk:Number(S.target.value)})}),e.jsx(y,{label:"Req.",size:"small",value:o.req??"",onChange:S=>d(u,{req:S.target.value}),placeholder:"PHYS 1 / REF 2 / etc"}),e.jsx(y,{label:"Keywords (comma)",size:"small",value:(o.keywords??[]).join(", "),onChange:S=>d(u,{keywords:S.target.value.split(",").map(te=>te.trim()).filter(Boolean)}),placeholder:"Two-Handed, Piercing 1",sx:{gridColumn:"1 / -1"}})]})]},o.id??`${o.name}-${u}`))]})})]}),e.jsxs(Me,{defaultExpanded:!0,children:[e.jsx(De,{expandIcon:e.jsx(Te,{}),children:e.jsx(D,{fontWeight:700,children:"Armor"})}),e.jsx(Ae,{children:e.jsxs(O,{spacing:1.5,children:[e.jsxs(E,{sx:{display:"flex",gap:1,alignItems:"center",flexWrap:"wrap"},children:[e.jsxs(y,{label:"Set prefab armor",size:"small",select:!0,value:Q,onChange:o=>C(o.target.value),sx:{minWidth:240},children:[e.jsx(de,{value:"",children:"— choose —"}),rt.map(o=>e.jsx(de,{value:o.id,children:o.name},o.id))]}),e.jsx(le,{color:"primary",onClick:()=>$(Q),"aria-label":"Set prefab armor",disabled:!Q,children:e.jsx(ke,{})})]}),e.jsxs(E,{sx:{border:"1px solid",borderColor:"divider",borderRadius:2,p:1.25},children:[e.jsxs(E,{sx:{display:"grid",gridTemplateColumns:"2fr 1fr 1fr 1fr",gap:1},children:[e.jsx(y,{label:"Name",size:"small",value:((Z=n.armor)==null?void 0:Z.name)??"",onChange:o=>t.onChange({armor:{...n.armor??{durability:{current:0,max:0},protection:0,keywords:[],keywordParams:{ammoMax:0}},name:o.target.value}})}),e.jsx(y,{label:"Protection",size:"small",type:"number",value:((G=n.armor)==null?void 0:G.protection)??0,onChange:o=>t.onChange({armor:{...n.armor??{name:"",durability:{current:0,max:0},keywords:[],keywordParams:{}},protection:Number(o.target.value)}})}),e.jsx(y,{label:"Durability (cur)",size:"small",type:"number",value:((c=n.armor)==null?void 0:c.durability.current)??0,onChange:o=>{var u;return t.onChange({armor:{...n.armor??{name:"",durability:{current:0,max:0},protection:0,keywords:[],keywordParams:{}},durability:{...((u=n.armor)==null?void 0:u.durability)??{current:0,max:0},current:Number(o.target.value)}}})}}),e.jsx(y,{label:"Durability (max)",size:"small",type:"number",value:((g=n.armor)==null?void 0:g.durability.max)??0,onChange:o=>{var u;return t.onChange({armor:{...n.armor??{name:"",durability:{current:0,max:0},protection:0,keywords:[],keywordParams:{}},durability:{...((u=n.armor)==null?void 0:u.durability)??{current:0,max:0},max:Number(o.target.value)}}})}})]}),(((K=(F=n.armor)==null?void 0:F.durability)==null?void 0:K.max)??0)>0&&(((q=(X=n.armor)==null?void 0:X.durability)==null?void 0:q.current)??0)<=0&&e.jsx(D,{sx:{mt:1},color:"error",variant:"body2",children:"Broken: armor provides no Protection until repaired."}),e.jsxs(E,{sx:{display:"grid",gridTemplateColumns:"1fr 1fr 1fr 2fr",gap:1,mt:1},children:[e.jsx(y,{label:"Bulk",size:"small",type:"number",value:((me=n.armor)==null?void 0:me.bulk)??0,onChange:o=>t.onChange({armor:{...n.armor??{name:"",durability:{current:0,max:0},protection:0,keywords:[],keywordParams:{}},bulk:Number(o.target.value)}})}),e.jsx(y,{label:"Req.",size:"small",value:((pe=n.armor)==null?void 0:pe.req)??"",onChange:o=>t.onChange({armor:{...n.armor??{name:"",durability:{current:0,max:0},protection:0,keywords:[],keywordParams:{}},req:o.target.value}})}),e.jsx(y,{label:"Special",size:"small",value:((Fe=n.armor)==null?void 0:Fe.special)??"",onChange:o=>t.onChange({armor:{...n.armor??{name:"",durability:{current:0,max:0},protection:0,keywords:[],keywordParams:{}},special:o.target.value}})})]}),e.jsx(E,{sx:{mt:1},children:e.jsx(y,{label:"Keywords (comma)",size:"small",fullWidth:!0,value:(((ge=n.armor)==null?void 0:ge.keywords)??[]).join(", "),onChange:o=>t.onChange({armor:{...n.armor??{name:"",durability:{current:0,max:0},protection:0,keywords:[],keywordParams:{}},keywords:o.target.value.split(",").map(u=>u.trim()).filter(Boolean)}}),placeholder:"Frontal Shielding 1"})})]})]})})]})]})}const ia=[{name:"Flashbang Grenade",effect:"Applies Stun 1 to everyone within near range, Thrown",uses:"1 use",bulk:1,cost:200},{name:"Frag Grenade",effect:"Deals 2 area (near range) damage (DC8 to Evade half), Thrown",uses:"1 use",bulk:1,cost:250},{name:"EMP Grenade",effect:"Applies EMP 2 to everything within range, Thrown",uses:"1 use",bulk:1,cost:300},{name:"Combat Stim Injector",effect:"Gain +1 action & -1 Stress; take 1 wound after effect ends",uses:"1 use",bulk:1,cost:200},{name:"Basic Medkit",effect:"Right tool for the job: First Aid checks",uses:"3 uses",bulk:1,cost:350},{name:"Multitool",effect:"Allows engineering checks to repair, bypass, scrap, etc.",uses:"Permanent",bulk:1,cost:750},{name:"Repair Kit",effect:"Provides materials and tools for repairs",uses:"10 uses",bulk:1,cost:500},{name:"Tracker",effect:"While within 10km, always know location of this device",uses:"1 use",bulk:1,cost:250},{name:"Portable Scanner",effect:"Right tool for the job: Observe (tech, lifeforms)",uses:"Permanent",bulk:1,cost:400},{name:"Weapon Scope",effect:"Simple Modification. Grants +1 bonus die to called shots at medium range and farther; inflicts +1 penalty die to attacks at close range or nearer",uses:"Permanent",bulk:1,cost:750},{name:"Weapon Silencer",effect:"Simple Modification. Weapon makes reduced sound when fired; deals -1 damage",uses:"Permanent",bulk:1,cost:500},{name:"Compact Backpack",effect:"+5 Inventory Slots when worn",uses:"Permanent",bulk:0,cost:150,statusEffects:"carrying_capacity+5"},{name:"Ammo (Flechette)",effect:"Deals +2 damage to unarmoured targets.",uses:"10 rounds",bulk:1,cost:500},{name:"Ammo (SMART)",effect:"Required for Smart-Linked weapons.",uses:"10",bulk:1,cost:1250},{name:"Ammo (Armour Piercing)",effect:"Adds Piercing 1 to attacks.",uses:"10",bulk:1,cost:750},{name:"Ammo (Explosive)",effect:"Adds Shredding 1 to attacks.",uses:"10",bulk:1,cost:750}],la={items:ia},oa=la.items,ca=[{name:"Reflex Booster",tier:1,effect:"Once per round, gain +1 bonus die to an Evade check.",installationDifficulty:2,requirements:"REF 1",physicalImpact:"Low; spine",bulk:1,cost:3e3},{name:"Targeting Link",tier:1,effect:"Once per round, ignore 1 level of cover when attacking an enemy you can see.",installationDifficulty:2,requirements:"-",physicalImpact:"Medium; eyes",bulk:1,cost:4e3},{name:"Low-Light Optics",tier:1,effect:"Ignore penalty dice caused by darkness within medium range.",installationDifficulty:1,requirements:"-",physicalImpact:"Medium; eyes",bulk:1,cost:2e3},{name:"EMP Shielding",tier:1,effect:"Ignore the effects of EMP once per day.",installationDifficulty:2,requirements:"MENT 1",physicalImpact:"None; torso",bulk:1,cost:3500},{name:"Metabolic Filter",tier:1,effect:"Gain +1 bonus die on checks to resist toxins or narcotics.",installationDifficulty:1,requirements:"PHYS 1",physicalImpact:"Minor; liver",bulk:1,cost:1500},{name:"Compact Databank",tier:2,effect:"Internal information storage device; store/access info at will.",installationDifficulty:2,requirements:"MENT 1",physicalImpact:"Medium; cranium",bulk:1,cost:5e3}],da={cyberware:ca},ua=da.cyberware,ma=[{name:"Space Dust",effect:"Grants +1 bonus die to Observe and Piloting checks for 6 hours",uses:5,addictionScore:1,legality:"Legal",bulk:1,cost:500},{name:"Tranquility",effect:"Reduces stress by 1; penalty die to all REF checks for 6 hours.",uses:2,addictionScore:5,legality:"Legal",bulk:1,cost:5e3},{name:"Smoothe",effect:"Reduces stress by 1d4; increases Cool Under Fire by 2 and grants +1 bonus die to all Mental skill checks for 1 hour",uses:1,addictionScore:8,legality:"Illegal",bulk:1,cost:2e4},{name:"Chemical Strength",effect:"+1 bonus die to all PHYS checks for 1 hour; +1 movement bonus for 1 hour. After 1 hour, +1 penalty die to all PHYS checks and +1 movement penalty until sleep.",uses:1,addictionScore:3,legality:"Illegal",bulk:1,cost:8e3}],ha={narcotics:ma},fa=ha.narcotics;function xa(){return`inv_${Date.now()}_${Math.random().toString(36).slice(2,9)}`}function ga(t){const n=t.sheet.inventory??[],x=a=>{t.onChange({inventory:a})},[h,p]=w.useState("item"),[b,i]=w.useState(null),[r,v]=w.useState({}),[z,U]=w.useState(null),[k,N]=w.useState(null),V=w.useMemo(()=>h==="item"?oa.map(a=>({type:"item",...a})):h==="cyberware"?ua.map(a=>({type:"cyberware",...a})):fa.map(a=>({type:"narcotics",...a})),[h]);function se(a){i(a);const s=V.find(T=>T.name===a);if(!s){v({type:h,name:"",quantity:1,bulk:h==="item"?0:1,effect:"",cost:0,statusEffects:""});return}v(h==="item"?{type:"item",name:s.name,quantity:1,uses:s.uses??"",bulk:s.bulk??0,effect:s.effect??"",cost:s.cost??0,statusEffects:s.statusEffects??""}:h==="cyberware"?{type:"cyberware",name:s.name,quantity:1,bulk:s.bulk??1,tier:s.tier??1,installationDifficulty:s.installationDifficulty??0,requirements:s.requirements??"",physicalImpact:s.physicalImpact??"",effect:s.effect??"",cost:s.cost??0,statusEffects:s.statusEffects??""}:{type:"narcotics",name:s.name,quantity:1,bulk:s.bulk??1,uses:s.uses??1,addictionScore:s.addictionScore??0,legality:s.legality??"",effect:s.effect??"",cost:s.cost??0,statusEffects:s.statusEffects??""})}function ie(){const a=[...n,{id:xa(),...r}];t.onChange({inventory:a}),i(null),v({type:h,name:"",quantity:1,bulk:h==="item"?0:1,effect:"",cost:0,statusEffects:""})}function Y(a){t.onChange({inventory:n.filter(s=>s.id!==a)})}function d(a,s){t.onChange({inventory:n.map(T=>T.id===a?{...T,...s}:T)})}return e.jsxs(O,{spacing:2,children:[e.jsx(y,{label:"Credits",type:"number",value:t.sheet.credits??0,onChange:a=>t.onChange({credits:Number(a.target.value)}),size:"small"}),e.jsxs(E,{children:[e.jsx(D,{variant:"subtitle2",sx:{mb:1},children:"Add Inventory"}),e.jsxs(O,{direction:{xs:"column",sm:"row"},spacing:1,alignItems:"center",children:[e.jsxs(y,{select:!0,size:"small",label:"Type",value:h,onChange:a=>{const s=a.target.value;p(s),i(null),v(s==="item"?{type:s,name:"",quantity:1,bulk:0,uses:"",effect:"",cost:0,statusEffects:""}:s==="cyberware"?{type:s,name:"",quantity:1,bulk:1,tier:1,installationDifficulty:0,requirements:"",physicalImpact:"",effect:"",cost:0,statusEffects:""}:{type:s,name:"",quantity:1,bulk:1,uses:1,addictionScore:0,legality:"",effect:"",cost:0,statusEffects:""})},sx:{minWidth:160},children:[e.jsx(de,{value:"item",children:"Item"}),e.jsx(de,{value:"cyberware",children:"Cyberware"}),e.jsx(de,{value:"narcotics",children:"Narcotics"})]}),e.jsx(Et,{size:"small",sx:{flex:1,minWidth:220},options:V.map(a=>a.name),value:b,onChange:(a,s)=>se(s),renderInput:a=>e.jsx(y,{...a,label:"Template (optional)"})}),e.jsx(ue,{variant:"contained",startIcon:e.jsx(ke,{}),onClick:ie,disabled:!(r!=null&&r.name),children:"Add"})]}),e.jsx(E,{sx:{mt:1},children:e.jsxs(O,{spacing:1,children:[e.jsxs(O,{direction:{xs:"column",sm:"row"},spacing:1,children:[e.jsx(y,{size:"small",label:"Name",value:(r==null?void 0:r.name)??"",onChange:a=>v(s=>({...s,name:a.target.value})),sx:{flex:1}}),e.jsx(y,{size:"small",type:"number",label:"Bulk",value:(r==null?void 0:r.bulk)??0,onChange:a=>v(s=>({...s,bulk:Number(a.target.value)})),sx:{width:120}}),e.jsx(y,{size:"small",type:"number",label:"Quantity",value:(r==null?void 0:r.quantity)??1,onChange:a=>{const s=Number(a.target.value);Number.isFinite(s)&&v(T=>({...T,quantity:s}))},sx:{width:120}}),e.jsx(y,{size:"small",type:"number",label:"Cost",value:(r==null?void 0:r.cost)??0,onChange:a=>v(s=>({...s,cost:Number(a.target.value)})),sx:{width:140}})]}),h==="item"&&e.jsx(y,{size:"small",label:"Uses",value:(r==null?void 0:r.uses)??"",onChange:a=>v(s=>({...s,uses:a.target.value}))}),h==="cyberware"&&e.jsxs(O,{direction:{xs:"column",sm:"row"},spacing:1,children:[e.jsx(y,{size:"small",type:"number",label:"Tier",value:(r==null?void 0:r.tier)??1,onChange:a=>v(s=>({...s,tier:Number(a.target.value)})),sx:{width:120}}),e.jsx(y,{size:"small",type:"number",label:"Installation Difficulty",value:(r==null?void 0:r.installationDifficulty)??0,onChange:a=>v(s=>({...s,installationDifficulty:Number(a.target.value)})),sx:{width:220}}),e.jsx(y,{size:"small",label:"Requirements",value:(r==null?void 0:r.requirements)??"",onChange:a=>v(s=>({...s,requirements:a.target.value})),sx:{flex:1}})]}),h==="cyberware"&&e.jsx(y,{size:"small",label:"Physical Impact",value:(r==null?void 0:r.physicalImpact)??"",onChange:a=>v(s=>({...s,physicalImpact:a.target.value}))}),h==="narcotics"&&e.jsxs(O,{direction:{xs:"column",sm:"row"},spacing:1,children:[e.jsx(y,{size:"small",type:"number",label:"Uses",value:(r==null?void 0:r.uses)??1,onChange:a=>v(s=>({...s,uses:Number(a.target.value)})),sx:{width:120}}),e.jsx(y,{size:"small",type:"number",label:"Addiction Score",value:(r==null?void 0:r.addictionScore)??0,onChange:a=>v(s=>({...s,addictionScore:Number(a.target.value)})),sx:{width:160}}),e.jsx(y,{size:"small",label:"Legality",value:(r==null?void 0:r.legality)??"",onChange:a=>v(s=>({...s,legality:a.target.value})),sx:{flex:1}})]}),e.jsx(y,{size:"small",label:"Effect",value:(r==null?void 0:r.effect)??"",onChange:a=>v(s=>({...s,effect:a.target.value})),multiline:!0,minRows:2}),e.jsx(y,{size:"small",label:"Status Effects (comma-separated)",value:(r==null?void 0:r.statusEffects)??"",onChange:a=>v(s=>({...s,statusEffects:a.target.value})),placeholder:'e.g. "carrying_capacity+5"'})]})})]}),e.jsxs(E,{children:[e.jsx(D,{variant:"subtitle2",sx:{mb:1},children:"Inventory"}),n.length===0&&e.jsx(D,{variant:"body2",children:"No inventory items yet."}),n.map(a=>{const s=a.quantity??1,j=(a.bulk??0)*s,A=`${a.name} (${a.type}) • bulk ${j}`;return e.jsxs(Me,{disableGutters:!0,children:[e.jsx(De,{expandIcon:e.jsx(Te,{}),draggable:!0,onDragStart:f=>{U(a.id??null);try{f.dataTransfer.effectAllowed="move",f.dataTransfer.setData("text/plain",a.id??"")}catch{}},onDragOver:f=>{f.preventDefault(),N(a.id??null)},onDragLeave:()=>N(null),onDrop:f=>{f.preventDefault();const L=z??f.dataTransfer.getData("text/plain"),Q=a.id;if(L&&Q&&L!==Q){const C=t.sheet.inventory??[],$=C.findIndex(G=>G.id===L),Z=C.findIndex(G=>G.id===Q);if($>=0&&Z>=0){const G=[...C],[c]=G.splice($,1);G.splice(Z,0,c),x(G)}}U(null),N(null)},sx:k===a.id?{outline:"2px dashed rgba(255,255,255,0.35)",borderRadius:1}:void 0,children:e.jsxs(O,{direction:"row",spacing:1,alignItems:"center",sx:{width:"100%"},children:[e.jsx(Nt,{fontSize:"small",sx:{opacity:.5}}),e.jsx(D,{variant:"body2",sx:{flex:1},children:A}),e.jsxs(O,{direction:"row",spacing:.5,alignItems:"center",children:[e.jsx(le,{size:"small",onClick:f=>{f.stopPropagation();const L=(a.quantity??1)-1;L<=0?Y(a.id):d(a.id,{quantity:L})},children:e.jsx(ct,{fontSize:"small"})}),e.jsx(D,{variant:"caption",sx:{minWidth:18,textAlign:"center"},children:a.quantity??1}),e.jsx(le,{size:"small",onClick:f=>{f.stopPropagation(),d(a.id,{quantity:(a.quantity??1)+1})},children:e.jsx(ke,{fontSize:"small"})})]}),e.jsx(ye,{title:"Remove",children:e.jsx(le,{size:"small",onClick:f=>(f.stopPropagation(),Y(a.id)),children:e.jsx(Le,{fontSize:"small"})})})]})}),e.jsx(Ae,{children:e.jsxs(O,{spacing:1,children:[e.jsxs(O,{direction:{xs:"column",sm:"row"},spacing:1,children:[e.jsx(y,{size:"small",label:"Name",value:a.name??"",onChange:f=>d(a.id,{name:f.target.value}),sx:{flex:1}}),e.jsxs(y,{select:!0,size:"small",label:"Type",value:a.type,onChange:f=>d(a.id,{type:f.target.value}),sx:{width:160},children:[e.jsx(de,{value:"item",children:"Item"}),e.jsx(de,{value:"cyberware",children:"Cyberware"}),e.jsx(de,{value:"narcotics",children:"Narcotics"})]}),e.jsx(y,{size:"small",type:"number",label:"Bulk",value:a.bulk??0,onChange:f=>d(a.id,{bulk:Number(f.target.value)}),sx:{width:120}}),e.jsx(y,{size:"small",type:"number",label:"Quantity",value:a.quantity??1,onChange:f=>{const L=Number(f.target.value);Number.isFinite(L)&&(L<=0?Y(a.id):d(a.id,{quantity:L}))},sx:{width:120}}),e.jsx(y,{size:"small",type:"number",label:"Cost",value:a.cost??0,onChange:f=>d(a.id,{cost:Number(f.target.value)}),sx:{width:140}})]}),a.type==="item"&&e.jsx(y,{size:"small",label:"Uses",value:a.uses??"",onChange:f=>d(a.id,{uses:f.target.value})}),a.type==="cyberware"&&e.jsxs(O,{direction:{xs:"column",sm:"row"},spacing:1,children:[e.jsx(y,{size:"small",type:"number",label:"Tier",value:a.tier??1,onChange:f=>d(a.id,{tier:Number(f.target.value)}),sx:{width:120}}),e.jsx(y,{size:"small",type:"number",label:"Installation Difficulty",value:a.installationDifficulty??0,onChange:f=>d(a.id,{installationDifficulty:Number(f.target.value)}),sx:{width:220}}),e.jsx(y,{size:"small",label:"Requirements",value:a.requirements??"",onChange:f=>d(a.id,{requirements:f.target.value}),sx:{flex:1}})]}),a.type==="cyberware"&&e.jsx(y,{size:"small",label:"Physical Impact",value:a.physicalImpact??"",onChange:f=>d(a.id,{physicalImpact:f.target.value})}),a.type==="narcotics"&&e.jsxs(O,{direction:{xs:"column",sm:"row"},spacing:1,children:[e.jsx(y,{size:"small",type:"number",label:"Uses",value:a.uses??1,onChange:f=>d(a.id,{uses:Number(f.target.value)}),sx:{width:120}}),e.jsx(y,{size:"small",type:"number",label:"Addiction Score",value:a.addictionScore??0,onChange:f=>d(a.id,{addictionScore:Number(f.target.value)}),sx:{width:160}}),e.jsx(y,{size:"small",label:"Legality",value:a.legality??"",onChange:f=>d(a.id,{legality:f.target.value}),sx:{flex:1}})]}),e.jsx(y,{size:"small",label:"Effect",value:a.effect??"",onChange:f=>d(a.id,{effect:f.target.value}),multiline:!0,minRows:2}),e.jsx(y,{size:"small",label:"Status Effects (comma-separated)",value:a.statusEffects??"",onChange:f=>d(a.id,{statusEffects:f.target.value}),placeholder:'e.g. "carrying_capacity+5"'})]})})]},a.id)})]})]})}function ya(){const[t,n]=w.useState({entries:[],activeTokenId:void 0,updatedAt:Date.now()}),[x,h]=w.useState({}),[p,b]=w.useState(""),[i,r]=w.useState(!1),[v,z]=w.useState(0),U=d=>Math.max(-3,Math.min(3,d)),k=w.useMemo(()=>Je(),[]);w.useEffect(()=>{const d=bt(a=>n(a));return()=>d==null?void 0:d()},[]),w.useEffect(()=>{let d=!0;return(async()=>{var a,s,T,j;try{const[A,f]=await Promise.all([((s=(a=_.player).getId)==null?void 0:s.call(a))??Promise.resolve(""),((j=(T=_.player).getRole)==null?void 0:j.call(T))??Promise.resolve("")]);if(!d)return;b(String(A??"")),r(String(f).toUpperCase()==="GM")}catch{}})(),()=>{d=!1}},[]);const N=w.useMemo(()=>{const d=[...t.entries??[]];return d.sort((a,s)=>(s.initiative??0)-(a.initiative??0)),d},[t.entries]);w.useEffect(()=>{let d=!0;return(async()=>{var a,s,T,j,A,f,L;try{const Q=N.map(Z=>Z.tokenId);if(!Q.length){d&&h({});return}const C=await _.scene.items.getItems(Q),$={};for(const Z of C){const G=Z.id,c=await Ee(G),g=c==null?void 0:c.armor,F=((a=g==null?void 0:g.durability)==null?void 0:a.current)??0,K=!!g&&F<=0,X=K?0:(g==null?void 0:g.protection)??0,q=(s=c==null?void 0:c.weapons)==null?void 0:s[0],me=be(q),pe=Number.isFinite(q==null?void 0:q.ammo)?Number(q==null?void 0:q.ammo):0;$[G]={tokenId:G,name:((A=(j=(T=Z.text)==null?void 0:T.plainText)==null?void 0:j.trim)==null?void 0:A.call(j))||(c==null?void 0:c.name)||"(Unnamed)",thumbUrl:(f=Z.image)==null?void 0:f.url,ownerPlayerId:String(((L=Z.metadata)==null?void 0:L[lt])??""),prot:X,armorBroken:K,topWeaponName:q==null?void 0:q.name,topWeaponUseDC:q==null?void 0:q.useDC,topWeaponDamage:q==null?void 0:q.damage,topWeaponSkillId:q==null?void 0:q.skillId,topWeaponAmmo:pe,topWeaponAmmoMax:me}}d&&h($)}catch{}})(),()=>{d=!1}},[N]);async function V(d){var c,g,F,K,X;const[a]=await _.scene.items.getItems([d]);if(!a)return;const s=await Ee(d);if(!s)return;const T=Ze([...(s.feats??[]).map(q=>q.statusEffects??"").filter(Boolean),...(s.inventory??[]).map(q=>q.statusEffects??"").filter(Boolean)]).deltas,j=Ce(s.skills??{}),A=((c=s.stress)==null?void 0:c.current)??0,f=Math.max(0,(Pe(s.skills??{})||0)-(((g=s.stress)==null?void 0:g.cufLoss)??0)),L=wt({attributes:j,stress:{current:A,cuf:f}},T),Q=L.stress.cuf??f,C=L.attributes.ref??j.ref??0,$=A>Q,Z=ze({netDice:$?-1:0,modifier:C,label:`${((F=a.text)==null?void 0:F.plainText)??s.name??"Token"} Initiative`}),G=await Ke({diceNotation:Z,rollTarget:"everyone",showResults:!0});await Ct({tokenId:d,initiative:G,name:((K=a.text)==null?void 0:K.plainText)??s.name??"Token",thumbUrl:(X=a.image)==null?void 0:X.url})}async function se(){var j,A;const d=await((A=(j=_.player).getSelection)==null?void 0:A.call(j))??[],a=d==null?void 0:d[0],s=await ot()??void 0,T=a||s;if(!T){_.notification.show("Select a token (or set your character) to roll initiative.","WARNING");return}await V(T)}async function ie(d){var c,g,F;const a=await Ee(d);if(!a)return;const s=(c=a.weapons)==null?void 0:c[0];if(!s){_.notification.show("No weapon in the top slot.","WARNING");return}const T=Ze([...(a.feats??[]).map(K=>K.statusEffects??"").filter(Boolean),...(a.inventory??[]).map(K=>K.statusEffects??"").filter(Boolean)]).deltas,A=(Pe(a.skills??{})-(((g=a.stress)==null?void 0:g.cufLoss)??0)||0)+(T.cool_under_fire??0),L=(((F=a.stress)==null?void 0:F.current)??0)>A,Q=String(s.skillId??""),C=mt({learnedInfoById:k,sheet:a,skillId:Q,skillMods:T}),$=be(s),Z=Number.isFinite(s==null?void 0:s.ammo)?Number(s==null?void 0:s.ammo):0;if($>0&&Z<=0){_.notification.show("Out of ammo. Reload first.","WARNING");return}const G=U(v-(L?1:0));if(await ft({weapon:s,netDice:G,modifier:C,attackerName:a.name,rollTarget:"everyone",showResults:!0}),$>0){const K=Math.max(0,Z-1),X=[...a.weapons??[]];X[0]={...X[0],ammo:K},await Ge(d,{...a,weapons:X})}}async function Y(d){var A;const a=await Ee(d);if(!a)return;const s=(A=a.weapons)==null?void 0:A[0];if(!s)return;const T=be(s);if(T<=0)return;const j=[...a.weapons??[]];j[0]={...j[0],ammo:T},await Ge(d,{...a,weapons:j})}return e.jsxs(O,{spacing:2,children:[e.jsxs(E,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",gap:1,flexWrap:"wrap"},children:[e.jsx(D,{variant:"h6",sx:{m:0},children:"Initiative"}),e.jsxs(O,{direction:"row",spacing:1,alignItems:"center",children:[e.jsx(ue,{size:"small",variant:"contained",onClick:()=>void se(),startIcon:e.jsx(Ie,{}),children:"Roll Initiative"}),e.jsxs(E,{sx:{display:"flex",alignItems:"center",gap:1,flexWrap:"wrap",pl:1},children:[e.jsx(D,{variant:"body2",sx:{opacity:.8},children:"Attack Roll:"}),e.jsxs(We,{size:"small",exclusive:!0,value:v,onChange:(d,a)=>{a!==null&&z(a)},children:[e.jsx(ee,{value:-2,children:"−2"}),e.jsx(ee,{value:-1,children:"−1"}),e.jsx(ee,{value:0,children:"0"}),e.jsx(ee,{value:1,children:"+1"}),e.jsx(ee,{value:2,children:"+2"})]})]}),i&&e.jsxs(e.Fragment,{children:[e.jsx(ue,{size:"small",variant:"outlined",onClick:()=>pt(),children:"Clear"}),e.jsx(ue,{size:"small",variant:"outlined",onClick:()=>kt(),children:"Advance"})]})]})]}),e.jsx(Pt,{}),N.length===0?e.jsx(D,{variant:"body2",sx:{opacity:.75},children:"No initiative rolls yet."}):e.jsx(zt,{dense:!0,disablePadding:!0,children:N.map(d=>{const a=x[d.tokenId],s=a==null?void 0:a.ownerPlayerId,T=i||!!s&&s===p,j=t.activeTokenId===d.tokenId,A=j&&T&&!i,f=!!d.surprised,L=(a==null?void 0:a.topWeaponAmmoMax)??0,Q=(a==null?void 0:a.topWeaponAmmo)??0,C=L>0&&Q<=0;return e.jsxs(Wt,{sx:{borderRadius:1,mb:.5,bgcolor:j?"rgba(255,255,255,0.06)":"transparent",opacity:f?.55:1},secondaryAction:e.jsxs(O,{direction:"row",spacing:.5,alignItems:"center",children:[e.jsx(ye,{title:a!=null&&a.armorBroken?"Armor broken":"Protection",children:e.jsxs(E,{sx:{display:"inline-flex",alignItems:"center",gap:.5,px:1,py:.5,borderRadius:1,bgcolor:"rgba(0,0,0,0.25)"},children:[e.jsx(Ot,{fontSize:"small",sx:{color:a!=null&&a.armorBroken?"error.main":"inherit"}}),e.jsx(D,{variant:"caption",children:(a==null?void 0:a.prot)??0})]})}),(i||T)&&e.jsx(ye,{title:a!=null&&a.topWeaponName?C?`Out of ammo: ${a.topWeaponName}`:`Attack: ${a.topWeaponName}`:"No top weapon",children:e.jsx("span",{children:e.jsx(le,{size:"small",disabled:!(a!=null&&a.topWeaponName)||C,onClick:()=>void ie(d.tokenId),children:e.jsx(Ie,{fontSize:"small"})})})}),(i||T)&&e.jsx(ye,{title:a!=null&&a.topWeaponName?L<=0?"No ammo to reload":`Reload: ${a.topWeaponName}`:"No top weapon",children:e.jsx("span",{children:e.jsx(le,{size:"small",disabled:!(a!=null&&a.topWeaponName)||L<=0,onClick:()=>void Y(d.tokenId),children:e.jsx(dt,{fontSize:"small"})})})}),e.jsx(ye,{title:T||i?"Remove":"Only the owner or GM can remove",children:e.jsx("span",{children:e.jsx(le,{size:"small",disabled:!T&&!i,onClick:()=>jt(d.tokenId),children:e.jsx(Le,{fontSize:"small"})})})})]}),children:[e.jsx(Lt,{children:e.jsx(Ft,{src:a==null?void 0:a.thumbUrl,variant:"rounded",sx:{width:32,height:32,mr:1,cursor:"pointer"}})}),e.jsx(Bt,{primary:e.jsxs(E,{sx:{display:"flex",alignItems:"center",gap:1,flexWrap:"wrap"},children:[e.jsx(D,{variant:"body2",sx:{fontWeight:600},children:(a==null?void 0:a.name)??d.name??"Token"}),e.jsx(D,{variant:"caption",sx:{opacity:.75},children:d.initiative}),A&&e.jsx(D,{variant:"caption",sx:{px:1,py:.25,borderRadius:1,bgcolor:"rgba(0,128,255,0.2)"},children:"Your Turn"})]}),secondary:e.jsxs(E,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(_t,{size:"small",checked:f,disabled:!i,onChange:$=>vt(d.tokenId,$.target.checked)}),e.jsx(D,{variant:"caption",sx:{opacity:.75},children:"Surprised"})]})})]},d.tokenId)})})]})}function ba(t){return e.jsxs("div",{style:{display:"flex",alignItems:"flex-start",gap:12,justifyContent:"space-between",marginBottom:10},children:[e.jsxs("div",{style:{display:"flex",gap:10,alignItems:"flex-start"},children:[t.thumbUrl?e.jsx("img",{src:t.thumbUrl,alt:"Token thumbnail",style:{width:44,height:44,borderRadius:10,objectFit:"cover",border:"1px solid rgba(0,0,0,0.2)"}}):e.jsx("div",{style:{width:44,height:44,borderRadius:10,border:"1px solid rgba(0,0,0,0.2)",opacity:.4}}),e.jsxs("div",{children:[e.jsxs("div",{style:{fontSize:18,fontWeight:700},children:[t.title," ",e.jsxs("span",{style:{fontSize:12,opacity:.75},children:["(",t.ownerLabel,")"]})]}),e.jsxs("div",{style:{fontSize:12,opacity:.8},children:["Token: ",e.jsx("code",{style:{fontSize:11},children:t.tokenId})]})]})]}),e.jsxs("div",{style:{display:"flex",gap:8},children:[t.showBackButton&&e.jsx("button",{style:{padding:"8px 10px",borderRadius:8,border:"1px solid #999",cursor:"pointer",opacity:.9},onClick:t.onBack,children:"Back to My Sheet"}),t.showUnsetButton&&e.jsx("button",{style:{padding:"8px 10px",borderRadius:8,border:"1px solid #999",cursor:"pointer",opacity:.9},onClick:t.onUnset,children:"Unset “My Character”"})]})]})}function pa(t){var n,x,h;return e.jsxs("div",{style:re.statusBar,children:[e.jsxs("div",{style:re.statusLeft,children:[e.jsxs("div",{style:re.statusGroup,children:[e.jsx("div",{style:re.statusLabel,children:"Stress"}),e.jsx("input",{type:"number",min:0,value:((n=t.sheet.stress)==null?void 0:n.current)??0,onChange:p=>t.applyStress(Number(p.target.value)),style:re.statusNumber})]}),e.jsxs("div",{style:re.statusGroup,children:[e.jsx("div",{style:re.statusLabel,children:"Wounds"}),e.jsxs("div",{style:re.woundsRow,children:[e.jsx("span",{style:re.woundsKind,children:"L"}),Array.from({length:4}).map((p,b)=>{var i;return e.jsx("input",{type:"checkbox",checked:(((i=t.sheet.wounds)==null?void 0:i.light)??0)>b,onChange:()=>t.toggleWound("light",b)},`wl_${b}`)}),e.jsx("span",{style:{width:8}}),e.jsx("span",{style:re.woundsKind,children:"M"}),Array.from({length:2}).map((p,b)=>{var i;return e.jsx("input",{type:"checkbox",checked:(((i=t.sheet.wounds)==null?void 0:i.moderate)??0)>b,onChange:()=>t.toggleWound("moderate",b)},`wm_${b}`)}),e.jsx("span",{style:{width:8}}),e.jsx("span",{style:re.woundsKind,children:"H"}),Array.from({length:1}).map((p,b)=>{var i;return e.jsx("input",{type:"checkbox",checked:(((i=t.sheet.wounds)==null?void 0:i.heavy)??0)>b,onChange:()=>t.toggleWound("heavy",b)},`wh_${b}`)})]})]}),e.jsxs("label",{style:{display:"flex",alignItems:"center",gap:6},children:[e.jsx("input",{type:"checkbox",checked:!!t.sheet.indomitable,onChange:p=>t.setIndomitable(p.target.checked)}),e.jsx("span",{style:{fontSize:12,opacity:.9},children:"Indomitable"})]}),(((x=t.sheet.stress)==null?void 0:x.current)??0)>(((h=t.sheetForView.stress)==null?void 0:h.cuf)??0)&&e.jsx("div",{style:re.warning,children:"Stress > CUF: make all rolls with +1 Penalty Die"}),e.jsxs("div",{style:{fontSize:12,opacity:.85},children:["Bulk: ",t.totalBulk," / ",t.effectiveCarryingCapacity]}),t.encumbranceLabel&&e.jsx("div",{style:re.warning,children:t.encumbranceLabel})]}),e.jsxs("div",{style:re.statusRight,children:[t.crucible&&t.crucible.status==="pending"&&e.jsxs("div",{style:re.crucibleBox,children:[e.jsx("div",{style:{fontWeight:700},children:"Crucible Test!"}),e.jsxs("div",{style:{fontSize:12,opacity:.85},children:["Incoming stress: ",t.crucible.incoming," • DC ",t.crucible.dc," • Roll CUF (no bonus/penalty dice)"]}),e.jsx("button",{style:re.buttonSecondary,onClick:()=>t.rollCrucibleTest(t.crucible.incoming),children:"Roll Crucible"})]}),t.crucible&&t.crucible.status==="success"&&e.jsxs("div",{style:re.crucibleBox,children:[e.jsx("div",{style:{fontWeight:700},children:"Crucible succeeded!"}),e.jsx("div",{style:{fontSize:12,opacity:.85},children:"Choose an Indomitable effect. (Indomitable checked automatically.)"})]}),t.crucible&&t.crucible.status==="fail"&&e.jsxs("div",{style:re.crucibleBox,children:[e.jsx("div",{style:{fontWeight:700},children:"Crucible failed"}),e.jsx("div",{style:{fontSize:12,opacity:.85},children:"You’ve entered PTSD range (6–8 stress)."}),e.jsx("button",{style:re.buttonSecondary,onClick:t.burnCufToPass,children:"Spend 1 CUF to pass"})]})]})]})}const re={statusBar:{display:"flex",alignItems:"flex-start",justifyContent:"space-between",gap:12,padding:"10px 12px",borderRadius:12,border:"1px solid rgba(255,255,255,0.15)",marginBottom:10},statusLeft:{display:"flex",alignItems:"center",gap:16,flexWrap:"wrap"},statusRight:{display:"flex",alignItems:"center",gap:12},statusGroup:{display:"flex",flexDirection:"column",gap:4},statusLabel:{fontSize:11,opacity:.75,letterSpacing:.2},statusNumber:{width:64,fontSize:16},woundsRow:{display:"flex",alignItems:"center",gap:8,flexWrap:"wrap"},woundsKind:{fontSize:11,opacity:.75,width:14,textAlign:"center"},warning:{marginTop:8,fontSize:12,opacity:.9},crucibleBox:{border:"1px solid rgba(255,255,255,0.18)",borderRadius:12,padding:10,maxWidth:240},buttonSecondary:{padding:"6px 10px",borderRadius:8,border:"1px solid #999",cursor:"pointer",opacity:.9,background:"transparent"}};function ka(t){const n=ut(),x=n.palette.text.primary,h=n.palette.mode==="dark"?"rgba(255,255,255,0.25)":"#777",p=n.palette.mode==="dark"?"rgba(255,255,255,0.12)":"transparent";return e.jsxs("div",{style:{display:"flex",gap:8,alignItems:"center",marginBottom:10},children:[e.jsx(je,{label:"Core",active:t.activeTab==="core",onClick:()=>t.onTab("core"),color:x,borderColor:h,activeBg:p}),e.jsx(je,{label:"Skills",active:t.activeTab==="skills",onClick:()=>t.onTab("skills"),color:x,borderColor:h,activeBg:p}),e.jsx(je,{label:"Combat",active:t.activeTab==="combat",onClick:()=>t.onTab("combat"),color:x,borderColor:h,activeBg:p}),e.jsx(je,{label:"Initiative",active:t.activeTab==="initiative",onClick:()=>t.onTab("initiative"),color:x,borderColor:h,activeBg:p}),e.jsx(je,{label:"Inventory",active:t.activeTab==="inventory",onClick:()=>t.onTab("inventory"),color:x,borderColor:h,activeBg:p}),e.jsx(je,{label:"Feats",active:t.activeTab==="feats",onClick:()=>t.onTab("feats"),color:x,borderColor:h,activeBg:p}),e.jsx("div",{style:{marginLeft:"auto",opacity:.8},children:t.isSaving?"Saving…":"Synced"})]})}function je(t){return ut().palette.mode,e.jsx("button",{onClick:t.onClick,style:{padding:"6px 10px",borderRadius:999,border:`1px solid ${t.borderColor}`,cursor:"pointer",background:t.active?t.activeBg:"transparent",fontWeight:t.active?700:400,color:t.color,outline:"none",boxShadow:"none",appearance:"none"},children:t.label})}function va(){var Re,Ve,Qe,Xe;const[t,n]=w.useState({kind:"loading"}),[x,h]=w.useState("core"),[p,b]=w.useState(!1),[i,r]=w.useState(null),[v,z]=w.useState(!1),[U,k]=w.useState([]);async function N(m){var l,M,I,R,W,B;try{const J=await _.scene.items.getItems([m]),P=J==null?void 0:J[0];if(!P)return{ownerLabel:"unowned",thumbUrl:null};const ae=((l=P==null?void 0:P.image)==null?void 0:l.url)??((M=P==null?void 0:P.image)==null?void 0:M.href)??(P==null?void 0:P.imageUrl)??(P==null?void 0:P.image)??((I=P==null?void 0:P.thumbnail)==null?void 0:I.url)??null,ne=(R=P==null?void 0:P.metadata)==null?void 0:R[lt];if(typeof ne!="string"||ne.length===0)return{ownerLabel:"unowned",thumbUrl:ae,ownerPlayerId:null,isOwnedByMe:!1};const ce=await _.player.getId();if(ne===ce)return{ownerLabel:"owned by you",thumbUrl:ae,ownerPlayerId:ne,isOwnedByMe:!0};try{const H=(await((B=(W=_.party).getPlayers)==null?void 0:B.call(W))??[]).find(fe=>(fe==null?void 0:fe.id)===ne);return{ownerLabel:`owned by ${typeof(H==null?void 0:H.name)=="string"&&H.name.length>0?H.name:ne}`,thumbUrl:ae,ownerPlayerId:ne,isOwnedByMe:!1}}catch{return{ownerLabel:`owned by ${ne}`,thumbUrl:ae,ownerPlayerId:ne,isOwnedByMe:!1}}}catch{return{ownerLabel:"unowned",thumbUrl:null,ownerPlayerId:null,isOwnedByMe:!1}}}async function V(m){const l=m!=null&&m.ignoreOpenOverride?null:await It();if(l)if(await Oe(l)){const ne=await Be(l);if(!ne)throw new Error("Could not load sheet from token.");const ce=Ce(ne.skills??{}),he={...ne,attributes:ce},H=await N(l);n({kind:"ready",tokenId:l,sheet:he,mode:"view",suppressUnset:!0,...H});return}else await _e(null);let I=await ot();if(I||(I=await et(),I&&await we(I)),!I){n({kind:"need-token"});return}let R=await Oe(I);if(!R){const ae=await et();ae&&(I=ae,await we(I),R=await Oe(I))}if(!R){await we(null),n({kind:"need-token"});return}const W=await Be(I);if(!W)throw new Error("Could not load sheet from token.");try{await tt(I)}catch{}const B=Ce(W.skills??{}),J={...W,attributes:B},P=await N(I);n({kind:"ready",tokenId:I,sheet:J,mode:"my",suppressUnset:!!(m!=null&&m.suppressUnset),...P})}w.useEffect(()=>{let m=!1;return _.onReady(async()=>{try{const l=await _.player.getRole();m||z(String(l).toUpperCase()==="GM"),await V()}catch(l){m||n({kind:"error",message:l.message??"Unknown error"})}}),()=>{m=!0}},[]),w.useEffect(()=>{let m=null,l=!1;return _.onReady(()=>{l||(m=_.broadcast.onMessage(Ye,M=>{const I=M.data;I!=null&&I.text&&k(R=>[...R,I].slice(-3))}))}),()=>{if(l=!0,typeof m=="function")try{m()}catch{}}},[]),w.useEffect(()=>{let m=null,l=null,M=!1;const I="whisperspace.combatLogLeader",R=2e3,W=6e3,B=`${Date.now()}-${Math.random().toString(36).slice(2,10)}`,J=()=>{try{const H=localStorage.getItem(I);return H?JSON.parse(H):null}catch{return null}},P=H=>{try{localStorage.setItem(I,JSON.stringify({id:B,ts:H??Date.now()}))}catch{}},ae=()=>{const H=J();return H&&H.id===B},ne=()=>{const H=Date.now(),oe=J();(!oe||H-(oe.ts??0)>W||oe.id===B)&&P(H)},ce=()=>{const H=ae();if(H&&!m)m=_.broadcast.onMessage(Ye,oe=>{const fe=oe.data;fe!=null&&fe.text&&_.notification.show(String(fe.text),"INFO")});else if(!H&&m){try{m()}catch{}m=null}},he=H=>{H.key===I&&ce()};return _.onReady(()=>{if(!M){try{window.addEventListener("storage",he)}catch{}ne(),ce(),l=window.setInterval(()=>{M||(ne(),ce())},R)}}),()=>{M=!0;try{window.removeEventListener("storage",he)}catch{}if(l!==null&&clearInterval(l),ae())try{localStorage.removeItem(I)}catch{}if(typeof m=="function")try{m()}catch{}}},[]);function se(m,l,M){const I={text:`${m} took ${l} damage${M?` and +${M} stress`:""}.`,ts:Date.now(),kind:"effect",targetName:m,damageApplied:l,stressApplied:M};k(R=>[...R,I].slice(-3))}function ie(m){if(t.kind!=="ready"||t.mode!=="my")return;const l=Math.max(0,Math.trunc(m.damageApplied??0)),M=Math.max(0,Math.trunc(m.stressApplied??0));l<=0&&M<=0||j(I=>{var W;const R=xt({sheet:I,incomingDamage:l,stressDelta:M});return R.stressDelta>0&&f(((W=R.sheet.stress)==null?void 0:W.current)??0),se(t.sheet.name||"Target",l,M),R.sheet})}w.useEffect(()=>{var R,W,B,J;if(t.kind!=="ready")return;const m=t.tokenId;let l=!1;const M=async()=>{var P,ae;try{const ne=await _.scene.items.getItems([m]),ce=ne==null?void 0:ne[0],he=String(((P=ce==null?void 0:ce.text)==null?void 0:P.plainText)??"").trim(),H=(ae=ce==null?void 0:ce.image)==null?void 0:ae.url;if(l||!he&&!H)return;n(oe=>{if(oe.kind!=="ready"||oe.tokenId!==m)return oe;const fe=he&&oe.sheet.name!==he?{...oe.sheet,name:he}:oe.sheet;return{...oe,sheet:fe,thumbUrl:H??oe.thumbUrl}})}catch{}};M();const I=(J=(B=(W=(R=_)==null?void 0:R.scene)==null?void 0:W.items)==null?void 0:B.onChange)==null?void 0:J.call(B,P=>{Array.isArray(P)&&P.some(ae=>(ae==null?void 0:ae.id)===m)&&M()});return()=>{l=!0,typeof I=="function"&&I()}},[t.kind,t.kind==="ready"?t.tokenId:null]);const Y=w.useMemo(()=>t.kind==="ready"&&t.sheet.name||"Whisperspace Character Sheet",[t]);async function d(){const m=await Gt();if(!m){n({kind:"error",message:"No token selected. Select a token on the map first."});return}const l=await Be(m);if(!l){n({kind:"error",message:"Could not attach a sheet to the selected token."});return}const M=Ce(l.skills??{}),I={...l,attributes:M};await we(m);try{await tt(m)}catch{}await _e(null);const R=await N(m);n({kind:"ready",tokenId:m,sheet:I,mode:"my",suppressUnset:!1,...R})}async function a(){await we(null);try{await Mt()}catch{}n({kind:"need-token"})}async function s(){await _e(null),n({kind:"loading"});try{await V({ignoreOpenOverride:!0,suppressUnset:!0})}catch(m){n({kind:"error",message:m.message??"Unknown error"})}}async function T(m,l){b(!0);try{await Ge(m,l)}finally{b(!1)}}function j(m){n(l=>{if(l.kind!=="ready")return l;let M=m(l.sheet);try{const I=Ce(M.skills??{});M={...M,attributes:{...M.attributes,...I},stress:{...M.stress??{current:0,cuf:0,cufLoss:0},cuf:Pe(M.skills??{})}}}catch{}return T(l.tokenId,M),{...l,sheet:M}})}async function A(m){var J;if(t.kind!=="ready")return;const l=8+m,M=Math.max(0,Math.trunc(((J=t.sheet.stress)==null?void 0:J.cuf)??0)),I=`Crucible Test (DC ${l})`,R=M===0?"":` +${M}`,W=`1d12 # ${I}${R}`;let B;try{B=await Ke({diceNotation:W,rollTarget:"everyone",showResults:!0,timeoutMs:6e3})}catch{_.notification.show("Dice+ roll failed or timed out.","WARNING");return}B>=l?(j(P=>({...P,stress:{...P.stress??{current:0,cuf:0,cufLoss:0},current:5},indomitable:!0})),r({incoming:m,dc:l,status:"success",total:B})):r({incoming:m,dc:l,status:"fail",total:B})}function f(m){var I;if(t.kind!=="ready")return;const l=Math.max(0,Math.trunc(((I=t.sheet.stress)==null?void 0:I.current)??0)),M=Math.max(0,Math.trunc(m));if(l<=5&&M>5){const R=M-l;r({incoming:R,dc:8+R,status:"pending"})}else r(null);j(R=>({...R,stress:{...R.stress??{current:0,cuf:0,cufLoss:0},current:M}}))}function L(m,l){var B;if(t.kind!=="ready")return;const I={light:4,moderate:2,heavy:1}[m],R=Math.max(0,Math.trunc(((B=t.sheet.wounds)==null?void 0:B[m])??0)),W=l<R?l:l+1;j(J=>({...J,wounds:{...J.wounds,[m]:Math.min(I,Math.max(0,W))}}))}function Q(){var l;if(t.kind!=="ready"||!i||i.status!=="fail")return;const m=Math.max(0,Math.trunc(((l=t.sheet.stress)==null?void 0:l.cufLoss)??0));j(M=>({...M,stress:{...M.stress??{current:0,cuf:0,cufLoss:0},cufLoss:m+1,current:5},indomitable:!0})),r({...i,status:"success"})}const C=t.kind==="ready"?t.sheet:null,$=Se.useMemo(()=>{if(!C)return{};const m=[];return(C.feats??[]).forEach(l=>{typeof(l==null?void 0:l.statusEffects)=="string"&&l.statusEffects.trim()&&m.push(l.statusEffects)}),(C.inventory??[]).forEach(l=>{typeof(l==null?void 0:l.statusEffects)=="string"&&l.statusEffects.trim()&&m.push(l.statusEffects)}),St(m)},[C]),Z=Se.useMemo(()=>{const m={},l=new Map,M=R=>{const W=String(R.id),B=String(R.name??R.label??"").toLowerCase().replace(/\s+/g,"_").replace(/[^a-z0-9_\-()]/g,"");W&&(l.set(W.toLowerCase(),W),B&&l.set(B,W))};(xe.inherent??[]).forEach(M),Object.values(xe.learned??{}).forEach(R=>{(R??[]).forEach(M)});const I=new Set(["phys","ref","soc","ment","carrying_capacity","cool_under_fire","speed","cuf","carry","capacity","spd"]);return Object.entries($??{}).forEach(([R,W])=>{const B=String(R).toLowerCase();if(I.has(B))return;const J=l.get(B);J&&(m[J]=(m[J]??0)+(Number.isFinite(W)?W:0))}),m},[$]),G=Math.max(0,(((Re=C==null?void 0:C.attributes)==null?void 0:Re.phys)??0)+($.phys??0)),c=Math.max(0,(((Ve=C==null?void 0:C.attributes)==null?void 0:Ve.ref)??0)+($.ref??0)),g=Math.max(0,(((Qe=C==null?void 0:C.attributes)==null?void 0:Qe.soc)??0)+($.soc??0)),F=Math.max(0,(((Xe=C==null?void 0:C.attributes)==null?void 0:Xe.ment)??0)+($.ment??0)),X=5+G*5+($.carrying_capacity??0);30+G*5+($.speed??0);const me=C?Pe(C.skills??{}):0,pe=Math.max(0,me+($.cool_under_fire??0)),ge=Se.useMemo(()=>C?{...C,attributes:{...C.attributes,phys:G,ref:c,soc:g,ment:F},stress:{...C.stress??{current:0,cuf:0,cufLoss:0},cuf:pe}}:null,[C,G,c,g,F,pe])??C,o=Se.useMemo(()=>{var I;if(!C)return 0;const m=(C.weapons??[]).reduce((R,W)=>R+(W.bulk??0),0),l=((I=C.armor)==null?void 0:I.bulk)??0,M=(C.inventory??[]).reduce((R,W)=>{const B=W.quantity??1,J=W.bulk??0,P=Number.isFinite(J)?J:0,ae=Number.isFinite(B)?B:1;return R+P*ae},0);return m+l+M},[C]),u=C&&o>X*2?"Heavily Encumbered":C&&o>X?"Encumbered":"";if(t.kind==="loading")return e.jsx("div",{style:{padding:12},children:"Loading…"});if(t.kind==="need-token")return e.jsxs("div",{style:{padding:12},children:[e.jsx("h2",{style:{margin:"0 0 8px 0"},children:"Whisperspace Character Sheet"}),e.jsx("p",{style:{margin:"0 0 10px 0",lineHeight:1.35},children:"Select your character token on the map, then click:"}),e.jsx("button",{style:{padding:"8px 10px",borderRadius:8,border:"1px solid #666",cursor:"pointer"},onClick:d,children:"Set Selected Token as My Character"})]});if(t.kind==="error")return e.jsxs("div",{style:{padding:12},children:[e.jsx("h2",{style:{margin:"0 0 8px 0"},children:"Error"}),e.jsx("p",{style:{margin:"0 0 10px 0",lineHeight:1.35},children:t.message}),e.jsx("button",{style:{padding:"8px 10px",borderRadius:8,border:"1px solid #666",cursor:"pointer"},onClick:()=>n({kind:"need-token"}),children:"Back"})]});const S=t.ownerLabel??(t.mode==="view"?"Viewing token":"My Character"),te=t.mode==="view"&&!t.isOwnedByMe,ve=t.mode==="my"&&!t.suppressUnset;return e.jsxs("div",{style:{padding:12},children:[e.jsx(ba,{title:Y,ownerLabel:S,tokenId:t.tokenId,thumbUrl:t.thumbUrl??null,showBackButton:te,onBack:s,showUnsetButton:ve,onUnset:a}),e.jsxs(e.Fragment,{children:[e.jsx(pa,{sheet:t.sheet,sheetForView:ge,totalBulk:o,effectiveCarryingCapacity:X,encumbranceLabel:u,crucible:i,applyStress:f,toggleWound:L,setIndomitable:m=>j(l=>({...l,indomitable:m})),rollCrucibleTest:A,burnCufToPass:Q}),e.jsx(ka,{activeTab:x,onTab:h,isSaving:p}),e.jsxs("div",{style:{border:"1px solid #888",borderRadius:12,padding:10},children:[x==="core"&&e.jsx(Yt,{sheet:ge,onChange:m=>j(l=>({...l,...m}))}),x==="skills"&&e.jsx(Jt,{sheet:ge,skillMods:Z,onChange:m=>j(l=>({...l,skills:m})),onMetaChange:m=>j(l=>({...l,...m}))}),x==="combat"&&e.jsx(ra,{sheet:ge,tokenId:t.tokenId,skillMods:Z,onChange:m=>j(l=>({...l,...m})),onApplyStress:f,combatLog:U,onApplyCombatLog:t.mode==="my"?ie:void 0,isGM:v}),x==="initiative"&&e.jsx(ya,{}),x==="inventory"&&e.jsx(ga,{sheet:ge,onChange:m=>j(l=>({...l,...m}))}),x==="feats"&&e.jsx(Qt,{sheet:ge,onChange:m=>j(l=>({...l,feats:m}))})]})]})]})}function ja(t){var U,k,N,V,se,ie,Y,d;const n=((t==null?void 0:t.mode)??"LIGHT")==="DARK"?"dark":"light",x=((U=t==null?void 0:t.background)==null?void 0:U.default)??(n==="dark"?"#121212":"#ffffff"),h=((k=t==null?void 0:t.background)==null?void 0:k.paper)??(n==="dark"?"#1e1e1e":"#f7f7f7"),p=((N=t==null?void 0:t.text)==null?void 0:N.primary)??(n==="dark"?"#ffffff":"#111111"),b=((V=t==null?void 0:t.text)==null?void 0:V.secondary)??(n==="dark"?"#bdbdbd":"#444444"),i=((se=t==null?void 0:t.primary)==null?void 0:se.main)??"#2f6fed",r=((ie=t==null?void 0:t.primary)==null?void 0:ie.contrastText)??"#ffffff",v=((Y=t==null?void 0:t.secondary)==null?void 0:Y.main)??"#7c3aed",z=((d=t==null?void 0:t.secondary)==null?void 0:d.contrastText)??"#ffffff";return $t({palette:{mode:n,background:{default:x,paper:h},text:{primary:p,secondary:b},primary:{main:i,contrastText:r},secondary:{main:v,contrastText:z}},shape:{borderRadius:12},typography:{fontFamily:"system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif"},components:{MuiPaper:{defaultProps:{elevation:0}},MuiButton:{styleOverrides:{root:{color:p,...n==="dark"?{borderColor:"rgba(255,255,255,0.25)","&:hover":{backgroundColor:"rgba(255,255,255,0.08)",borderColor:"rgba(255,255,255,0.45)"}}:{}},containedPrimary:{color:r},containedSecondary:{color:z}}},MuiButtonBase:{styleOverrides:{root:n==="dark"?{"&:hover":{backgroundColor:"rgba(255,255,255,0.06)"}}:{}}}}})}function wa(t){const[n,x]=w.useState(null);w.useEffect(()=>{let p=null,b=!1;return _.onReady(async()=>{if(!b)try{const i=await _.theme.getTheme();b||x(i),p=_.theme.onChange(r=>x(r))}catch{}}),()=>{b=!0,p&&p()}},[]);const h=w.useMemo(()=>ja(n),[n]);return e.jsxs(qt,{theme:h,children:[e.jsx(Ut,{}),t.children]})}async function Ca(){await _.onReady(async()=>{}),Dt.createRoot(document.getElementById("root")).render(e.jsx(Se.StrictMode,{children:e.jsx(wa,{children:e.jsx(va,{})})}))}Ca();
