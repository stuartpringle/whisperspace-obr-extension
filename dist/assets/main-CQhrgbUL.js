import{r as rt,b as Le,c as ht,s as me,F as ft,a as Qe,o as xt,l as Pe,T as it,d as gt,e as pt,f as yt,g as bt,h as lt,i as Xe,j as We,k as Je,m as Me,n as kt,u as vt,p as jt,q as wt,t as Oe,v as qe,w as Ze,x as Ie,y as et,z as Ct}from"./statusEffects-BG_oMj9Y.js";import{r as k,j as e,d as De,e as St}from"./vendor_react-XzhcIodj.js";import{O as U}from"./vendor_obr-BLY5dk8V.js";import{S as $,B as A,T as S,a as Fe,b as se,c as x,d as ke,I as oe,C as Te,R as It,A as Ae,e as Re,E as Ee,f as Ne,g as ge,h as ot,i as je,P as Mt,D as _e,L as tt,j as Dt,M as xe,k as ct,l as Tt,m as At,n as Rt,o as Et,p as Nt,q as Pt,r as zt,s as Wt,t as Lt,u as Ft,v as _t,w as Bt,x as Ot}from"./vendor_mui-Cp94TW_k.js";import"./vendor_zod-CxP395f9.js";import"./vendor-CPvQcOsy.js";import"./vendor_emotion-pcfylbOS.js";async function qt(){const t=await U.player.getSelection();return Array.isArray(t)?t:[]}async function Ut(){const t=await qt();return t.length>0?t[0]:null}async function Ue(t){return(await U.scene.items.getItems([t])).length>0}function $t(t){var g;const r=t.sheet,[b,h]=k.useState(0),M=k.useMemo(()=>r.attributes??{phys:0,ref:0,soc:0,ment:0},[r.attributes]);async function C(c,w){const O=Number(M[c]??0),J=Le({netDice:b,modifier:O,label:w});await rt({diceNotation:J,showResults:!0,rollTarget:"everyone"})}return e.jsxs($,{spacing:2,children:[e.jsxs(A,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",gap:2,flexWrap:"wrap"},children:[e.jsx(S,{variant:"h6",sx:{m:0},children:"Core"}),e.jsxs(A,{sx:{display:"flex",alignItems:"center",gap:1,flexWrap:"wrap"},children:[e.jsx(S,{variant:"subtitle2",sx:{opacity:.8},children:"Attribute Roll:"}),e.jsxs(Fe,{size:"small",exclusive:!0,value:b,onChange:(c,w)=>{w!==null&&h(w)},children:[e.jsx(se,{value:-2,children:"−2"}),e.jsx(se,{value:-1,children:"−1"}),e.jsx(se,{value:0,children:"0"}),e.jsx(se,{value:1,children:"+1"}),e.jsx(se,{value:2,children:"+2"})]})]})]}),e.jsx(x,{label:"Name",size:"small",value:r.name??"",onChange:c=>t.onChange({name:c.target.value}),fullWidth:!0}),e.jsxs(A,{sx:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:1},children:[e.jsx(ze,{label:"PHYS",value:M.phys,onRoll:()=>C("phys","PHYS Check")}),e.jsx(ze,{label:"REF",value:M.ref,onRoll:()=>C("ref","REF Check")}),e.jsx(ze,{label:"SOC",value:M.soc,onRoll:()=>C("soc","SOC Check")}),e.jsx(ze,{label:"MENT",value:M.ment,onRoll:()=>C("ment","MENT Check")})]}),e.jsxs(A,{sx:{display:"grid",gridTemplateColumns:"repeat(3, 1fr)",gap:2},children:[e.jsx(x,{label:"Cool Under Fire",size:"small",value:((g=t.sheet.stress)==null?void 0:g.cuf)??0,inputProps:{readOnly:!0},fullWidth:!0}),e.jsx(x,{label:"Speed",size:"small",value:30+(M.phys??0)*5,inputProps:{readOnly:!0},fullWidth:!0}),e.jsx(x,{label:"Carrying Capacity",size:"small",value:5+(M.phys??0)*5,inputProps:{readOnly:!0},fullWidth:!0})]}),e.jsx(S,{variant:"body2",sx:{opacity:.75},children:"Attributes are derived automatically from skill ranks (¼ of total ranks under each attribute, rounded up)."})]})}function ze(t){return e.jsxs(A,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(x,{label:t.label,size:"small",value:t.value,inputProps:{readOnly:!0},fullWidth:!0}),e.jsx(ke,{title:"Roll with Dice+",children:e.jsx(oe,{onClick:t.onRoll,"aria-label":`Roll ${t.label}`,children:e.jsx(Te,{})})})]})}const Ht=["phys","ref","soc","ment"],$e={phys:"PHYSIQUE",ref:"REFLEX",soc:"SOCIAL",ment:"MENTAL"},He={combat:"Combat",education:"Education",vehicles:"Vehicles"},at={combat:"Combat Focus",education:"Education Focus",vehicles:"Vehicles Focus"};function Ge(t){const r=dt(t,0,5);return r*(r+1)/2}function Gt(t){const[r,b]=k.useState(""),[h,M]=k.useState(0),[C,g]=k.useState(!0),[c,w]=k.useState(!1),[O,J]=k.useState(""),B=t.sheet.skills??{},N=t.sheet.learningFocus??"combat",te=Number(t.sheet.skillPoints??0);k.useEffect(()=>{let d=!1;return(async()=>{const f=await ht();d||(g(f),w(!0))})().catch(()=>{d||(g(!1),w(!0))}),()=>{d=!0}},[]);const le=k.useMemo(()=>{const d=new Map;return Object.keys(me.learned).forEach(f=>{(me.learned[f]??[]).forEach(L=>d.set(L.id,{focus:f}))}),d},[]);function ce(d){const f=le.get(d.id);return f?f.focus===N?5:2:5}function ae(d){var ee;const f=B[d.id]??0,L=((ee=t.skillMods)==null?void 0:ee[d.id])??0;if(f>0)return f+L;const ne=le.get(d.id);return ne&&ne.focus===N?0+L:-1+L}const u=k.useMemo(()=>{let d=0;for(const f of Object.values(B))d+=Ge(f??0);return d},[B]),a=Math.max(0,te-u),n=d=>{const f=Math.max(0,Math.trunc(Number(O)));if(!f)return;const L=te+d*f,ne=Math.max(u,L);t.onMetaChange({skillPoints:ne}),J("")};function D(d){t.onChange(d)}function I(d,f){const L=B[d.id]??0,ne=ce(d),ee=dt(f,0,ne);if(ee===L||Ge(ee)-Ge(L)>a)return;const de={...B};ee===0?delete de[d.id]:de[d.id]=ee,D(de)}async function P(d){const f=Le({netDice:h,modifier:ae(d),label:d.label});try{await rt({diceNotation:f,showResults:!0,rollTarget:"everyone"})}catch(L){console.error("Dice+ roll request failed:",L)}}const m=k.useMemo(()=>{const d=Object.values(me.learned).flat();return[...me.inherent,...d]},[]),W=k.useMemo(()=>{const d=r.trim().toLowerCase();return d?m.filter(f=>f.label.toLowerCase().includes(d)||f.id.toLowerCase().includes(d)):m},[m,r]),V=k.useMemo(()=>Yt(me.inherent),[]),v=k.useMemo(()=>me.learned,[]),H=r.trim().length>0,re=e.jsxs(A,{sx:{display:"flex",alignItems:"center",gap:2,flexWrap:"wrap"},children:[e.jsx(S,{variant:"subtitle2",sx:{opacity:.8},children:"Learning Focus:"}),Object.keys(at).map(d=>e.jsxs(A,{sx:{display:"flex",alignItems:"center",gap:.5,cursor:"pointer"},onClick:()=>t.onMetaChange({learningFocus:d}),children:[e.jsx(It,{checked:N===d,value:d,size:"small"}),e.jsx(S,{variant:"body2",children:He[d]})]},d))]}),Q=e.jsx(A,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",gap:2,flexWrap:"wrap"},children:e.jsxs(A,{sx:{display:"flex",alignItems:"center",gap:1,flexWrap:"wrap"},children:[e.jsxs(S,{variant:"subtitle2",sx:{minWidth:170},children:["Skill Points: ",a," ",e.jsxs("span",{style:{opacity:.75},children:["(Total: ",te,")"]})]}),e.jsx(ge,{size:"small",variant:"outlined",onClick:()=>n(1),disabled:!Number.isFinite(Number(O))||Math.trunc(Number(O))<=0,children:"+"}),e.jsx(x,{label:"SP",size:"small",type:"number",value:O,onChange:d=>J(d.target.value),sx:{width:110}}),e.jsx(ge,{size:"small",variant:"outlined",onClick:()=>n(-1),disabled:!Number.isFinite(Number(O))||Math.trunc(Number(O))<=0,children:"-"}),e.jsx(S,{variant:"subtitle2",sx:{opacity:.8},children:"Roll"}),e.jsxs(Fe,{size:"small",exclusive:!0,value:h,onChange:(d,f)=>{f!==null&&M(f)},"aria-label":"Bonus / Penalty dice",children:[e.jsx(se,{value:-2,children:"−2"}),e.jsx(se,{value:-1,children:"−1"}),e.jsx(se,{value:0,children:"0"}),e.jsx(se,{value:1,children:"+1"}),e.jsx(se,{value:2,children:"+2"})]}),c&&!C&&e.jsx(S,{variant:"caption",sx:{opacity:.8},children:"(Dice+ not detected)"})]})});return e.jsxs($,{spacing:2,children:[re,e.jsx(x,{label:"Search skills",value:r,onChange:d=>b(d.target.value),placeholder:"stealth, weapons, navigation…",fullWidth:!0}),Q,H?e.jsx($,{spacing:1,children:W.map(d=>{const f=le.get(d.id),L=f?He[f.focus]:$e[d.attribute];return e.jsx(Ye,{skill:d,rank:B[d.id]??0,modifier:ae(d),maxRank:ce(d),onRank:ne=>I(d,ne),rightTag:L,canRoll:C,onRoll:()=>P(d)},d.id)})}):e.jsxs(e.Fragment,{children:[e.jsx(S,{variant:"subtitle1",children:"Inherent Skills"}),Ht.map(d=>e.jsxs(Ae,{defaultExpanded:!0,children:[e.jsx(Re,{expandIcon:e.jsx(Ee,{}),children:e.jsx(S,{fontWeight:700,children:$e[d]})}),e.jsx(Ne,{children:e.jsx($,{spacing:1,children:(V[d]??[]).map(f=>e.jsx(Ye,{skill:f,rank:B[f.id]??0,modifier:ae(f),maxRank:ce(f),onRank:L=>I(f,L),rightTag:$e[f.attribute],canRoll:C,onRoll:()=>P(f)},f.id))})})]},d)),e.jsx(S,{variant:"subtitle1",sx:{mt:1},children:"Learned Skills"}),Object.keys(v).map(d=>e.jsxs(Ae,{defaultExpanded:!0,children:[e.jsx(Re,{expandIcon:e.jsx(Ee,{}),children:e.jsx(S,{fontWeight:700,children:at[d]})}),e.jsx(Ne,{children:e.jsx($,{spacing:1,children:(v[d]??[]).map(f=>e.jsx(Ye,{skill:f,rank:B[f.id]??0,modifier:ae(f),maxRank:ce(f),onRank:L=>I(f,L),rightTag:He[d],canRoll:C,onRoll:()=>P(f)},f.id))})})]},d))]})]})}function Ye(t){const r=t.rank<t.maxRank,b=t.rank>0;return e.jsxs(A,{sx:{display:"grid",gridTemplateColumns:"1fr auto auto auto",gap:1,alignItems:"center",border:"1px solid",borderColor:"divider",borderRadius:2,px:1.25,py:1},children:[e.jsxs(A,{sx:{minWidth:0},children:[e.jsx(S,{fontWeight:600,noWrap:!0,children:t.skill.label}),e.jsx(S,{variant:"caption",sx:{opacity:.7},noWrap:!0,children:t.rightTag??""})]}),e.jsxs(A,{sx:{width:46,textAlign:"center"},children:[e.jsx(S,{variant:"caption",sx:{opacity:.7,lineHeight:1},children:"Mod"}),e.jsx(S,{sx:{fontWeight:700,lineHeight:1.2},children:t.modifier>=0?`+${t.modifier}`:`${t.modifier}`})]}),e.jsxs(A,{sx:{width:40,textAlign:"center"},children:[e.jsx(S,{variant:"caption",sx:{opacity:.7,lineHeight:1},children:"Rank"}),e.jsx(S,{sx:{fontWeight:700,lineHeight:1.2},children:t.rank})]}),e.jsxs(A,{sx:{display:"flex",gap:.5,alignItems:"center",justifyContent:"flex-end"},children:[e.jsx(oe,{size:"small",onClick:()=>t.onRank(t.rank-1),"aria-label":"Decrease rank",disabled:!b,children:e.jsx(ot,{fontSize:"small"})}),e.jsx(oe,{size:"small",onClick:()=>t.onRank(t.rank+1),"aria-label":"Increase rank",disabled:!r,children:e.jsx(je,{fontSize:"small"})}),e.jsx(A,{sx:{width:6}}),e.jsx(ke,{title:t.canRoll?"Roll with Dice+":"Dice+ not detected",children:e.jsx("span",{children:e.jsx(oe,{size:"small",onClick:t.onRoll,"aria-label":`Roll ${t.skill.label}`,disabled:!t.canRoll,children:e.jsx(Te,{fontSize:"small"})})})})]})]})}function Yt(t){return t.reduce((r,b)=>{var h;return(r[h=b.attribute]??(r[h]=[])).push(b),r},{})}function dt(t,r,b){const h=Number.isFinite(t)?Math.trunc(t):r;return Math.max(r,Math.min(b,h))}function Kt(t){const r=t.sheet.feats??[];function b(){t.onChange([...r,{name:"New Feat",description:"",statusEffects:""}])}function h(C,g){const c=[...r];c[C]={...c[C],...g},ft.safeParse(c[C]),t.onChange(c)}function M(C){const g=[...r];g.splice(C,1),t.onChange(g)}return e.jsxs($,{spacing:2,children:[e.jsxs($,{direction:"row",justifyContent:"space-between",alignItems:"center",children:[e.jsx(S,{variant:"h6",children:"Feats"}),e.jsx(ge,{variant:"contained",startIcon:e.jsx(je,{}),onClick:b,children:"Add Feat"})]}),r.length===0?e.jsx(S,{variant:"body2",sx:{opacity:.75},children:"No feats yet."}):e.jsx($,{spacing:2,children:r.map((C,g)=>e.jsx(Mt,{sx:{p:2},children:e.jsxs($,{spacing:1.5,children:[e.jsxs($,{direction:"row",spacing:1,alignItems:"center",children:[e.jsx(x,{label:"Feat Name",fullWidth:!0,value:C.name,onChange:c=>h(g,{name:c.target.value})}),e.jsx(oe,{"aria-label":"Remove feat",onClick:()=>M(g),children:e.jsx(_e,{})})]}),e.jsx(x,{label:"Description",fullWidth:!0,multiline:!0,minRows:4,value:C.description,onChange:c=>h(g,{description:c.target.value})}),e.jsx(x,{label:"Status Effects",fullWidth:!0,helperText:'Comma-separated, e.g. "carrying_capacity+5"',value:C.statusEffects??"",onChange:c=>h(g,{statusEffects:c.target.value})})]})},`${C.name}-${g}`))})]})}const Jt=[{id:"pistol",name:"Pistol",skillId:"weapons_light",useDC:7,damage:2,range:"Med",ammo:10,bulk:1,cost:500},{id:"smart_pistol",name:"SMART Pistol",skillId:"weapons_light",useDC:9,damage:4,range:"Med",ammo:6,bulk:1,keywords:["Smart-Linked"],cost:900},{id:"toxic_spike",name:"Toxic Spike",skillId:"weapons_light",useDC:10,damage:3,range:"Short",ammo:1,bulk:1,keywords:["Toxin (Prax)","Concealable"],cost:750},{id:"smg",name:"SMG",skillId:"weapons_medium",useDC:6,damage:3,range:"Med",ammo:8,bulk:2,keywords:["Bullet Spray"],cost:600},{id:"photon_rifle",name:"Photon Rifle",skillId:"weapons_medium",useDC:8,damage:6,range:"Long",ammo:6,bulk:3,keywords:["Two-Handed"],cost:5e3},{id:"rifle",name:"Rifle",skillId:"weapons_medium",useDC:8,damage:4,range:"Long",ammo:8,bulk:2,keywords:["Two-Handed","Piercing 1"],cost:1e3},{id:"shotgun",name:"Shotgun",skillId:"weapons_medium",useDC:8,damage:4,range:"Short",ammo:4,bulk:3,req:"PHYS 1",keywords:["Point Blank","Shredding 1"],cost:800},{id:"gauss_cannon",name:"Gauss Cannon",skillId:"weapons_heavy",useDC:7,damage:4,range:"Med",ammo:20,bulk:4,req:"PHYS 3",keywords:["Bullet Spray"],cost:900},{id:"grenade_launcher",name:"Grenade Launcher",skillId:"weapons_heavy",useDC:8,damage:3,range:"Med",ammo:1,bulk:3,req:"PHYS 2",keywords:["Area (near)","Two-Handed","Slow Load","Grenade"],cost:2e3},{id:"magneton_cannon",name:"Magneton Cannon",skillId:"weapons_exotic",useDC:5,damage:2,range:"Short",ammo:5,bulk:2,req:"PHYS 1",keywords:["Area (melee)","Slow Load","Shredding 3"],cost:8e3},{id:"tesla_rifle",name:"Tesla Rifle",skillId:"weapons_exotic",useDC:8,damage:5,range:"Med",ammo:6,bulk:2,keywords:["Two-Handed","Stun 2"],cost:6e3},{id:"stun_baton",name:"Stun Baton",skillId:"melee_weapons",useDC:6,damage:0,range:"Melee",bulk:1,keywords:["Stun 1"],cost:450},{id:"switchblade",name:"Switchblade",skillId:"melee_weapons",useDC:9,damage:2,range:"Melee",bulk:1,keywords:["Concealable","Thrown"],cost:150},{id:"fusion_blade",name:"Fusion Blade",skillId:"melee_weapons",useDC:8,damage:3,range:"Melee",bulk:2,req:"REF 2",keywords:["Piercing 2"],cost:1200},{id:"rocket_maul",name:"Rocket Maul",skillId:"melee_weapons",useDC:10,damage:6,range:"Melee",ammo:2,bulk:3,req:"PHYS 3",keywords:["Two-Handed"],cost:2500}],Vt={weapons:Jt},nt=Vt.weapons??[],Qt=[{id:"scrap_armour",name:"Scrap Armour",protection:1,durability:2,bulk:2,special:"Cannot be repaired",cost:500},{id:"flak_jacket",name:"Flak Jacket",protection:1,durability:4,bulk:1,cost:1250},{id:"kevlar_clothing",name:"Kevlar Clothing",protection:1,durability:3,bulk:1,special:"Appears to be normal clothing",cost:1500},{id:"streetweave_jacket",name:"Streetweave Jacket",protection:1,durability:5,bulk:1,special:"+1 to Stealth",cost:2500},{id:"milsec_bodyplate",name:"MilSec Bodyplate",protection:2,durability:6,bulk:2,cost:5e3},{id:"breaching_plate",name:"Breaching plate",protection:2,durability:4,bulk:3,req:"PHYS 2",special:"Frontal Shielding 1",cost:8500},{id:"heavy_bodyplate",name:"Heavy Bodyplate",protection:3,durability:8,bulk:4,req:"PHYS 3",special:"+1 penalty die to Stealth",cost:1e4},{id:"basic_power_armour",name:"Basic Power Armour",protection:4,durability:14,bulk:10,req:"Power Armour 1",special:`Requires Power Armour (DC5) check to activate. Failure: become Immobile; gain +1 penalty die to all PHYS and REF based checks. When activated, reduces its own bulk to 1 and grants +1 bonus die to all PHYS based checks.
`,cost:4e4}],Xt={armor:Qt},st=Xt.armor??[],Ve="whisperspace.obr.sheet/combat-log";function Zt(t){return t>=9?4:t>=7?3:t>=4?2:0}async function ea(t){const r=Number.isFinite(t.useDC)?Math.trunc(t.useDC):Math.trunc(t.weapon.useDC),b=t.weapon.name||"Attack",h=Le({netDice:t.netDice,modifier:t.modifier,label:b}),M=await Qe({diceNotation:h,rollTarget:t.rollTarget??"everyone",showResults:t.showResults??!0}),C=M-r,g=M>=r,c=g?Zt(C):0,w=g&&c>0,O=Math.trunc(t.weapon.damage??0),J=g?O+c:0,B=w?1:0;let N;g?w?N=`Extreme success - crit! ${b} rolled ${M} vs DC ${r}. Damage: ${O}+${c}=${J}. (+1 Stress)`:N=`Hit. ${b} rolled ${M} vs DC ${r}. Damage: ${O}.`:N=`Miss. ${b} rolled ${M} vs DC ${r}.`,t.prefix&&(N=`${t.prefix} ${N}`);const te={text:N,ts:Date.now(),kind:"attack",attackerName:t.attackerName,weaponName:b,outcome:{total:M,useDC:r,hit:g,isCrit:w,baseDamage:O,totalDamage:J,stressDelta:B}};return U.broadcast.sendMessage(Ve,te,{destination:"ALL"}),{total:M,useDC:r,margin:C,hit:g,isCrit:w,critExtra:c,baseDamage:O,totalDamage:J,stressDelta:B,message:N}}const ut=ea;function mt(t){var V,v;const r=Number.isFinite(t.incomingDamage)?Math.max(0,Math.trunc(t.incomingDamage)):0;if(r<=0&&!(t.stressDelta&&t.stressDelta>0))return t.sheet;const b=!!t.unmitigated,h=t.sheet.armor,M=(((V=h==null?void 0:h.durability)==null?void 0:V.current)??0)<=0,C=b||M?0:(h==null?void 0:h.protection)??0,g=Math.max(0,r-C),c=t.sheet.wounds??{light:0,moderate:0,heavy:0};let w=c.light??0,O=c.moderate??0,J=c.heavy??0,B=g,N=0,te=0,le=0;const ae=Math.min(B,Math.max(0,4-w));w+=ae,B-=ae,N=ae;const a=Math.min(B,Math.max(0,2-O));O+=a,B-=a,te=a;const D=Math.min(B,Math.max(0,1-J));J+=D,B-=D,le=D;const I={light:w,moderate:O,heavy:J};let P=0;le>0?P=4:te>0?P=2:N>0&&(P=1),t.stressDelta&&t.stressDelta>0&&(P+=Math.trunc(t.stressDelta));let m=h;!b&&!M&&g>0&&(h!=null&&h.durability)&&(m={...h,durability:{...h.durability,current:Math.max(0,Math.trunc((h.durability.current??0)-1))}});const W=Math.max(0,Math.trunc((((v=t.sheet.stress)==null?void 0:v.current)??0)+P));return{...t.sheet,wounds:I,armor:m,stress:{...t.sheet.stress??{current:0,cuf:0,cufLoss:0},current:W}}}function ta(){const t=new Map;return Object.keys(me.learned).forEach(r=>{(me.learned[r]??[]).forEach(b=>t.set(b.id,{focus:r}))}),t}function aa(t){var d,f,L,ne,ee,_,de,fe,Be,be,we,Se;const r=t.sheet,[b,h]=k.useState(0),[M,C]=k.useState(null),[g,c]=k.useState(""),[w,O]=k.useState(!1),J=(t.combatLog??[]).slice(-3).reverse(),B=k.useMemo(()=>ta(),[]),N=k.useMemo(()=>{const s=Object.values(me.learned).flat();return[...me.inherent,...s]},[]),te=new Set(["melee_weapons","melee_unarmed","weapons_light","weapons_medium","weapons_heavy","weapons_exotic","explosives"]),le=N.filter(s=>te.has(s.id));k.useMemo(()=>[...N].sort((s,l)=>s.label.localeCompare(l.label)),[N]);const ce=r.learningFocus??"combat";function ae(){const s=Number(g),l=Number.isFinite(s)?Math.max(0,Math.trunc(s)):0;if(l<=0)return;const p=mt({sheet:t.sheet,incomingDamage:l,unmitigated:w});t.onChange({wounds:p.wounds,armor:p.armor,stress:p.stress}),c("")}function u(s){var E,ve;const l=((E=r.skills)==null?void 0:E[s])??0,p=((ve=t.skillMods)==null?void 0:ve[s])??0;if(l>0)return l+p;const G=B.get(s);return(G&&G.focus===ce?0:-1)+p}function a(s){var G;const l=(G=s.keywordParams)==null?void 0:G.ammoMax,p=typeof l=="number"?l:typeof l=="string"?Number(l):void 0;return Number.isFinite(p)?Number(p):0}function n(s,l){const p=[...r.weapons??[]],G=p[s];if(l.ammo!==void 0&&!a(G)&&l.ammo>0){const E={...G.keywordParams??{},ammoMax:l.ammo};p[s]={...G,...l,keywordParams:E},t.onChange({weapons:p});return}p[s]={...G,...l},t.onChange({weapons:p})}function D(s,l){if(s===null||s===l)return;const p=t.sheet.weapons??[];if(s<0||s>=p.length||l<0||l>=p.length)return;const G=[...p],[pe]=G.splice(s,1);G.splice(l,0,pe),t.onChange({weapons:G}),C(l)}function I(s){const l=nt.find(G=>G.id===s);if(!l)return;const p=[...r.weapons??[]];p.push({name:l.name,skillId:l.skillId,useDC:l.useDC,damage:l.damage,range:l.range,ammo:l.ammo,bulk:l.bulk,req:l.req,cost:l.cost,keywords:[...l.keywords??[]],keywordParams:{ammoMax:l.ammo??0,...l.keywordParams??{}}}),t.onChange({weapons:p})}function P(){const s=[...r.weapons??[]];s.push({name:"New Weapon",skillId:"weapons_medium",useDC:8,damage:3,range:"Med",ammo:0,bulk:1,req:"",cost:0,keywords:[],keywordParams:{ammoMax:0}}),t.onChange({weapons:s})}function m(s){const l=[...r.weapons??[]];l.splice(s,1),t.onChange({weapons:l})}async function W(s,l){const p=a(l),G=Number.isFinite(l.ammo)?Number(l.ammo):0;if(p>0&&G<=0){U.notification.show("Out of ammo. Reload first.","WARNING");return}const pe=u(l.skillId);await ut({weapon:l,useDC:Number.isFinite(l.useDC)?Number(l.useDC):0,netDice:b,modifier:pe,attackerName:t.sheet.name,rollTarget:"everyone",showResults:!0}),p>0&&n(s,{ammo:Math.max(0,G-1)})}const[V,v]=k.useState(""),[H,re]=k.useState("");function Q(s){const l=st.find(p=>p.id===s);l&&t.onChange({armor:{name:l.name,keywords:[...l.keywords??[]],keywordParams:{...l.keywordParams??{}},protection:l.protection,durability:{current:l.durability,max:l.durability},bulk:l.bulk,req:l.req,cost:l.cost,special:l.special}})}return e.jsxs($,{spacing:2,children:[e.jsx(A,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",gap:2,flexWrap:"wrap"},children:e.jsx(S,{variant:"h6",sx:{m:0},children:"Combat"})}),e.jsxs(A,{sx:{display:"flex",alignItems:"center",gap:1,flexWrap:"wrap"},children:[e.jsx(S,{variant:"subtitle2",sx:{opacity:.8},children:"Take Damage:"}),e.jsx(x,{size:"small",type:"number",inputProps:{min:0},value:g,onChange:s=>c(s.target.value),sx:{width:90}}),e.jsx(se,{size:"small",value:"unmitigated",selected:w,onChange:()=>O(s=>!s),children:"Unmitigated"}),e.jsx(ge,{size:"small",variant:"outlined",onClick:ae,children:"Apply"})]}),e.jsxs(A,{sx:{display:"flex",alignItems:"center",gap:1,flexWrap:"wrap"},children:[e.jsx(S,{variant:"subtitle2",sx:{opacity:.8},children:"Attack Roll:"}),e.jsxs(Fe,{size:"small",exclusive:!0,value:b,onChange:(s,l)=>{l!==null&&h(l)},children:[e.jsx(se,{value:-2,children:"−2"}),e.jsx(se,{value:-1,children:"−1"}),e.jsx(se,{value:0,children:"0"}),e.jsx(se,{value:1,children:"+1"}),e.jsx(se,{value:2,children:"+2"})]})]}),e.jsxs(A,{sx:{border:"1px solid",borderColor:"divider",borderRadius:2,p:1.25},children:[e.jsx(S,{variant:"subtitle2",sx:{opacity:.8,mb:.5},children:"Combat Log"}),J.length===0?e.jsx(S,{variant:"body2",sx:{opacity:.7},children:"No recent rolls."}):e.jsx($,{spacing:.75,children:J.map(s=>{var F,z,Y,R,X;const l=!!((F=s.outcome)!=null&&F.hit)&&((((z=s.outcome)==null?void 0:z.totalDamage)??0)>0||(((Y=s.outcome)==null?void 0:Y.stressDelta)??0)>0)&&!!t.onApplyCombatLog,p=l&&(((R=s.outcome)==null?void 0:R.totalDamage)??0)>0,G=l&&(((X=s.outcome)==null?void 0:X.stressDelta)??0)>0,pe=p&&G,E=s.outcome,ve=E!=null&&E.isCrit?"Extreme success - crit!":E!=null&&E.hit?"Hit":"Miss",o=E!=null&&E.isCrit?"#5b6bff":E!=null&&E.hit?"#26a269":"#d64040",i="#e55353",y="#8b5cf6",j=s.attackerName??"Unknown",T=s.weaponName??"Attack";return e.jsxs(A,{sx:{display:"flex",alignItems:"center",gap:1,flexWrap:"wrap"},children:[e.jsx(S,{variant:"body2",sx:{flex:"1 1 260px"},children:s.kind==="effect"?e.jsxs(e.Fragment,{children:[e.jsx("strong",{children:s.targetName??"Target"})," ",(s.damageApplied??0)>0&&e.jsxs(e.Fragment,{children:["took"," ",e.jsx("strong",{style:{color:i},children:s.damageApplied})," ","damage"]}),(s.damageApplied??0)>0&&(s.stressApplied??0)>0&&" and ",(s.damageApplied??0)<=0&&(s.stressApplied??0)>0&&"took ",(s.stressApplied??0)>0&&e.jsxs(e.Fragment,{children:[e.jsx("strong",{style:{color:y},children:s.stressApplied})," ","stress"]}),"."]}):e.jsxs(e.Fragment,{children:[e.jsx("strong",{children:j}),": ",e.jsx("strong",{children:T})," rolled"," ",(E==null?void 0:E.total)??0," vs DC ",(E==null?void 0:E.useDC)??0,"."," ",e.jsx("strong",{style:{color:o},children:ve}),(E==null?void 0:E.hit)&&e.jsxs(e.Fragment,{children:[". Damage:"," ",e.jsx("strong",{style:{color:i},children:(E==null?void 0:E.totalDamage)??0}),E!=null&&E.stressDelta?e.jsxs(e.Fragment,{children:[" "," (+"," ",e.jsx("strong",{style:{color:y},children:E.stressDelta})," ","Stress)"]}):null]}),"."]})}),p&&e.jsx(ge,{size:"small",variant:"outlined",startIcon:e.jsx(tt,{fontSize:"small"}),onClick:()=>{var q,Z;return(Z=t.onApplyCombatLog)==null?void 0:Z.call(t,{...s,kind:"attack",damageApplied:((q=s.outcome)==null?void 0:q.totalDamage)??0,stressApplied:0})},children:"Apply Damage"}),G&&e.jsx(ge,{size:"small",variant:"outlined",startIcon:e.jsx(Dt,{fontSize:"small"}),onClick:()=>{var q,Z;return(Z=t.onApplyCombatLog)==null?void 0:Z.call(t,{...s,kind:"attack",damageApplied:0,stressApplied:((q=s.outcome)==null?void 0:q.stressDelta)??0})},children:"Apply Stress"}),pe&&e.jsx(ge,{size:"small",variant:"outlined",startIcon:e.jsx(tt,{fontSize:"small"}),onClick:()=>{var q,Z,he;return(he=t.onApplyCombatLog)==null?void 0:he.call(t,{...s,kind:"attack",damageApplied:((q=s.outcome)==null?void 0:q.totalDamage)??0,stressApplied:((Z=s.outcome)==null?void 0:Z.stressDelta)??0})},children:"Apply Both"})]},s.ts)})})]}),e.jsxs(Ae,{defaultExpanded:!0,children:[e.jsx(Re,{expandIcon:e.jsx(Ee,{}),children:e.jsx(S,{fontWeight:700,children:"Weapons"})}),e.jsx(Ne,{children:e.jsxs($,{spacing:1.5,children:[e.jsxs(A,{sx:{display:"flex",gap:1,alignItems:"center",flexWrap:"wrap"},children:[e.jsxs(x,{label:"Add prefab weapon",size:"small",select:!0,value:V,onChange:s=>v(s.target.value),sx:{minWidth:240},children:[e.jsx(xe,{value:"",children:"— choose —"}),nt.map(s=>e.jsx(xe,{value:s.id,children:s.name},s.id))]}),e.jsx(oe,{color:"primary",onClick:()=>I(V),"aria-label":"Add prefab weapon",disabled:!V,children:e.jsx(je,{})}),e.jsx(A,{sx:{flex:1}}),e.jsx(oe,{color:"primary",onClick:P,"aria-label":"Add custom weapon",children:e.jsx(je,{})}),e.jsx(S,{variant:"body2",sx:{opacity:.75},children:"Add custom weapon"})]}),(r.weapons??[]).length===0?e.jsx(S,{sx:{opacity:.75},children:"No weapons yet."}):(r.weapons??[]).map((s,l)=>e.jsxs(A,{draggable:!0,onDragStart:()=>C(l),onDragEnd:()=>C(null),onDragOver:p=>{p.preventDefault()},onDrop:p=>{p.preventDefault(),D(M,l)},sx:{border:"1px solid",borderColor:"divider",borderRadius:2,p:1.25,cursor:"grab",opacity:M===l?.85:1,display:"grid",gap:1.25},children:[e.jsxs(A,{sx:{display:"flex",gap:1,alignItems:"center"},children:[e.jsx(x,{label:"Name",size:"small",value:s.name,onChange:p=>n(l,{name:p.target.value}),fullWidth:!0}),e.jsx(ke,{title:"Roll attack with Dice+",children:e.jsx(oe,{onClick:()=>W(l,s),"aria-label":`Roll attack for ${s.name}`,children:e.jsx(Te,{})})}),e.jsx(oe,{onClick:()=>m(l),"aria-label":"Remove weapon",children:e.jsx(_e,{})})]}),e.jsxs(A,{sx:{display:"grid",gridTemplateColumns:"1fr 1fr 1fr 1fr",gap:1},children:[e.jsx(x,{label:"Skill",size:"small",select:!0,value:s.skillId,onChange:p=>n(l,{skillId:p.target.value}),children:le.map(p=>e.jsx(xe,{value:p.id,children:p.label},p.id))}),e.jsx(x,{label:"Use DC",size:"small",type:"number",value:s.useDC,onChange:p=>n(l,{useDC:Number(p.target.value)})}),e.jsx(x,{label:"Damage",size:"small",type:"number",value:s.damage,onChange:p=>n(l,{damage:Number(p.target.value)})}),e.jsx(x,{label:"Range",size:"small",value:s.range??"",onChange:p=>n(l,{range:p.target.value}),placeholder:"Melee / Short / Med / Long"}),e.jsxs(A,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(x,{label:"Ammo",size:"small",type:"number",value:s.ammo??0,onChange:p=>n(l,{ammo:Number(p.target.value)}),sx:{width:110}}),e.jsxs(S,{variant:"body2",sx:{opacity:.8},children:["/ ",a(s)||0]}),e.jsx(ke,{title:"Reload",children:e.jsx("span",{children:e.jsx(oe,{size:"small",onClick:()=>n(l,{ammo:a(s)||0}),disabled:(a(s)||0)<=0,children:e.jsx(ct,{fontSize:"small"})})})})]}),e.jsx(x,{label:"Bulk",size:"small",type:"number",value:s.bulk??0,onChange:p=>n(l,{bulk:Number(p.target.value)})}),e.jsx(x,{label:"Req.",size:"small",value:s.req??"",onChange:p=>n(l,{req:p.target.value}),placeholder:"PHYS 1 / REF 2 / etc"}),e.jsx(x,{label:"Keywords (comma)",size:"small",value:(s.keywords??[]).join(", "),onChange:p=>n(l,{keywords:p.target.value.split(",").map(G=>G.trim()).filter(Boolean)}),placeholder:"Two-Handed, Piercing 1",sx:{gridColumn:"1 / -1"}})]})]},s.id??`${s.name}-${l}`))]})})]}),e.jsxs(Ae,{defaultExpanded:!0,children:[e.jsx(Re,{expandIcon:e.jsx(Ee,{}),children:e.jsx(S,{fontWeight:700,children:"Armor"})}),e.jsx(Ne,{children:e.jsxs($,{spacing:1.5,children:[e.jsxs(A,{sx:{display:"flex",gap:1,alignItems:"center",flexWrap:"wrap"},children:[e.jsxs(x,{label:"Set prefab armor",size:"small",select:!0,value:H,onChange:s=>re(s.target.value),sx:{minWidth:240},children:[e.jsx(xe,{value:"",children:"— choose —"}),st.map(s=>e.jsx(xe,{value:s.id,children:s.name},s.id))]}),e.jsx(oe,{color:"primary",onClick:()=>Q(H),"aria-label":"Set prefab armor",disabled:!H,children:e.jsx(je,{})})]}),e.jsxs(A,{sx:{border:"1px solid",borderColor:"divider",borderRadius:2,p:1.25},children:[e.jsxs(A,{sx:{display:"grid",gridTemplateColumns:"2fr 1fr 1fr 1fr",gap:1},children:[e.jsx(x,{label:"Name",size:"small",value:((d=r.armor)==null?void 0:d.name)??"",onChange:s=>t.onChange({armor:{...r.armor??{durability:{current:0,max:0},protection:0,keywords:[],keywordParams:{ammoMax:0}},name:s.target.value}})}),e.jsx(x,{label:"Protection",size:"small",type:"number",value:((f=r.armor)==null?void 0:f.protection)??0,onChange:s=>t.onChange({armor:{...r.armor??{name:"",durability:{current:0,max:0},keywords:[],keywordParams:{}},protection:Number(s.target.value)}})}),e.jsx(x,{label:"Durability (cur)",size:"small",type:"number",value:((L=r.armor)==null?void 0:L.durability.current)??0,onChange:s=>{var l;return t.onChange({armor:{...r.armor??{name:"",durability:{current:0,max:0},protection:0,keywords:[],keywordParams:{}},durability:{...((l=r.armor)==null?void 0:l.durability)??{current:0,max:0},current:Number(s.target.value)}}})}}),e.jsx(x,{label:"Durability (max)",size:"small",type:"number",value:((ne=r.armor)==null?void 0:ne.durability.max)??0,onChange:s=>{var l;return t.onChange({armor:{...r.armor??{name:"",durability:{current:0,max:0},protection:0,keywords:[],keywordParams:{}},durability:{...((l=r.armor)==null?void 0:l.durability)??{current:0,max:0},max:Number(s.target.value)}}})}})]}),(((_=(ee=r.armor)==null?void 0:ee.durability)==null?void 0:_.max)??0)>0&&(((fe=(de=r.armor)==null?void 0:de.durability)==null?void 0:fe.current)??0)<=0&&e.jsx(S,{sx:{mt:1},color:"error",variant:"body2",children:"Broken: armor provides no Protection until repaired."}),e.jsxs(A,{sx:{display:"grid",gridTemplateColumns:"1fr 1fr 1fr 2fr",gap:1,mt:1},children:[e.jsx(x,{label:"Bulk",size:"small",type:"number",value:((Be=r.armor)==null?void 0:Be.bulk)??0,onChange:s=>t.onChange({armor:{...r.armor??{name:"",durability:{current:0,max:0},protection:0,keywords:[],keywordParams:{}},bulk:Number(s.target.value)}})}),e.jsx(x,{label:"Req.",size:"small",value:((be=r.armor)==null?void 0:be.req)??"",onChange:s=>t.onChange({armor:{...r.armor??{name:"",durability:{current:0,max:0},protection:0,keywords:[],keywordParams:{}},req:s.target.value}})}),e.jsx(x,{label:"Special",size:"small",value:((we=r.armor)==null?void 0:we.special)??"",onChange:s=>t.onChange({armor:{...r.armor??{name:"",durability:{current:0,max:0},protection:0,keywords:[],keywordParams:{}},special:s.target.value}})})]}),e.jsx(A,{sx:{mt:1},children:e.jsx(x,{label:"Keywords (comma)",size:"small",fullWidth:!0,value:(((Se=r.armor)==null?void 0:Se.keywords)??[]).join(", "),onChange:s=>t.onChange({armor:{...r.armor??{name:"",durability:{current:0,max:0},protection:0,keywords:[],keywordParams:{}},keywords:s.target.value.split(",").map(l=>l.trim()).filter(Boolean)}}),placeholder:"Frontal Shielding 1"})})]})]})})]})]})}const na=[{name:"Flashbang Grenade",effect:"Applies Stun 1 to everyone within near range, Thrown",uses:"1 use",bulk:1,cost:200},{name:"Frag Grenade",effect:"Deals 2 area (near range) damage (DC8 to Evade half), Thrown",uses:"1 use",bulk:1,cost:250},{name:"EMP Grenade",effect:"Applies EMP 2 to everything within range, Thrown",uses:"1 use",bulk:1,cost:300},{name:"Combat Stim Injector",effect:"Gain +1 action & -1 Stress; take 1 wound after effect ends",uses:"1 use",bulk:1,cost:200},{name:"Basic Medkit",effect:"Right tool for the job: First Aid checks",uses:"3 uses",bulk:1,cost:350},{name:"Multitool",effect:"Allows engineering checks to repair, bypass, scrap, etc.",uses:"Permanent",bulk:1,cost:750},{name:"Repair Kit",effect:"Provides materials and tools for repairs",uses:"10 uses",bulk:1,cost:500},{name:"Tracker",effect:"While within 10km, always know location of this device",uses:"1 use",bulk:1,cost:250},{name:"Portable Scanner",effect:"Right tool for the job: Observe (tech, lifeforms)",uses:"Permanent",bulk:1,cost:400},{name:"Weapon Scope",effect:"Simple Modification. Grants +1 bonus die to called shots at medium range and farther; inflicts +1 penalty die to attacks at close range or nearer",uses:"Permanent",bulk:1,cost:750},{name:"Weapon Silencer",effect:"Simple Modification. Weapon makes reduced sound when fired; deals -1 damage",uses:"Permanent",bulk:1,cost:500},{name:"Compact Backpack",effect:"+5 Inventory Slots when worn",uses:"Permanent",bulk:0,cost:150,statusEffects:"carrying_capacity+5"},{name:"Ammo (Flechette)",effect:"Deals +2 damage to unarmoured targets.",uses:"10 rounds",bulk:1,cost:500},{name:"Ammo (SMART)",effect:"Required for Smart-Linked weapons.",uses:"10",bulk:1,cost:1250},{name:"Ammo (Armour Piercing)",effect:"Adds Piercing 1 to attacks.",uses:"10",bulk:1,cost:750},{name:"Ammo (Explosive)",effect:"Adds Shredding 1 to attacks.",uses:"10",bulk:1,cost:750}],sa={items:na},ra=sa.items,ia=[{name:"Reflex Booster",tier:1,effect:"Once per round, gain +1 bonus die to an Evade check.",installationDifficulty:2,requirements:"REF 1",physicalImpact:"Low; spine",bulk:1,cost:3e3},{name:"Targeting Link",tier:1,effect:"Once per round, ignore 1 level of cover when attacking an enemy you can see.",installationDifficulty:2,requirements:"-",physicalImpact:"Medium; eyes",bulk:1,cost:4e3},{name:"Low-Light Optics",tier:1,effect:"Ignore penalty dice caused by darkness within medium range.",installationDifficulty:1,requirements:"-",physicalImpact:"Medium; eyes",bulk:1,cost:2e3},{name:"EMP Shielding",tier:1,effect:"Ignore the effects of EMP once per day.",installationDifficulty:2,requirements:"MENT 1",physicalImpact:"None; torso",bulk:1,cost:3500},{name:"Metabolic Filter",tier:1,effect:"Gain +1 bonus die on checks to resist toxins or narcotics.",installationDifficulty:1,requirements:"PHYS 1",physicalImpact:"Minor; liver",bulk:1,cost:1500},{name:"Compact Databank",tier:2,effect:"Internal information storage device; store/access info at will.",installationDifficulty:2,requirements:"MENT 1",physicalImpact:"Medium; cranium",bulk:1,cost:5e3}],la={cyberware:ia},oa=la.cyberware,ca=[{name:"Space Dust",effect:"Grants +1 bonus die to Observe and Piloting checks for 6 hours",uses:5,addictionScore:1,legality:"Legal",bulk:1,cost:500},{name:"Tranquility",effect:"Reduces stress by 1; penalty die to all REF checks for 6 hours.",uses:2,addictionScore:5,legality:"Legal",bulk:1,cost:5e3},{name:"Smoothe",effect:"Reduces stress by 1d4; increases Cool Under Fire by 2 and grants +1 bonus die to all Mental skill checks for 1 hour",uses:1,addictionScore:8,legality:"Illegal",bulk:1,cost:2e4},{name:"Chemical Strength",effect:"+1 bonus die to all PHYS checks for 1 hour; +1 movement bonus for 1 hour. After 1 hour, +1 penalty die to all PHYS checks and +1 movement penalty until sleep.",uses:1,addictionScore:3,legality:"Illegal",bulk:1,cost:8e3}],da={narcotics:ca},ua=da.narcotics;function ma(){return`inv_${Date.now()}_${Math.random().toString(36).slice(2,9)}`}function ha(t){const r=t.sheet.inventory??[],b=a=>{t.onChange({inventory:a})},[h,M]=k.useState("item"),[C,g]=k.useState(null),[c,w]=k.useState({}),[O,J]=k.useState(null),[B,N]=k.useState(null),te=k.useMemo(()=>h==="item"?ra.map(a=>({type:"item",...a})):h==="cyberware"?oa.map(a=>({type:"cyberware",...a})):ua.map(a=>({type:"narcotics",...a})),[h]);function le(a){g(a);const n=te.find(D=>D.name===a);if(!n){w({type:h,name:"",quantity:1,bulk:h==="item"?0:1,effect:"",cost:0,statusEffects:""});return}w(h==="item"?{type:"item",name:n.name,quantity:1,uses:n.uses??"",bulk:n.bulk??0,effect:n.effect??"",cost:n.cost??0,statusEffects:n.statusEffects??""}:h==="cyberware"?{type:"cyberware",name:n.name,quantity:1,bulk:n.bulk??1,tier:n.tier??1,installationDifficulty:n.installationDifficulty??0,requirements:n.requirements??"",physicalImpact:n.physicalImpact??"",effect:n.effect??"",cost:n.cost??0,statusEffects:n.statusEffects??""}:{type:"narcotics",name:n.name,quantity:1,bulk:n.bulk??1,uses:n.uses??1,addictionScore:n.addictionScore??0,legality:n.legality??"",effect:n.effect??"",cost:n.cost??0,statusEffects:n.statusEffects??""})}function ce(){const a=[...r,{id:ma(),...c}];t.onChange({inventory:a}),g(null),w({type:h,name:"",quantity:1,bulk:h==="item"?0:1,effect:"",cost:0,statusEffects:""})}function ae(a){t.onChange({inventory:r.filter(n=>n.id!==a)})}function u(a,n){t.onChange({inventory:r.map(D=>D.id===a?{...D,...n}:D)})}return e.jsxs($,{spacing:2,children:[e.jsx(x,{label:"Credits",type:"number",value:t.sheet.credits??0,onChange:a=>t.onChange({credits:Number(a.target.value)}),size:"small"}),e.jsxs(A,{children:[e.jsx(S,{variant:"subtitle2",sx:{mb:1},children:"Add Inventory"}),e.jsxs($,{direction:{xs:"column",sm:"row"},spacing:1,alignItems:"center",children:[e.jsxs(x,{select:!0,size:"small",label:"Type",value:h,onChange:a=>{const n=a.target.value;M(n),g(null),w(n==="item"?{type:n,name:"",quantity:1,bulk:0,uses:"",effect:"",cost:0,statusEffects:""}:n==="cyberware"?{type:n,name:"",quantity:1,bulk:1,tier:1,installationDifficulty:0,requirements:"",physicalImpact:"",effect:"",cost:0,statusEffects:""}:{type:n,name:"",quantity:1,bulk:1,uses:1,addictionScore:0,legality:"",effect:"",cost:0,statusEffects:""})},sx:{minWidth:160},children:[e.jsx(xe,{value:"item",children:"Item"}),e.jsx(xe,{value:"cyberware",children:"Cyberware"}),e.jsx(xe,{value:"narcotics",children:"Narcotics"})]}),e.jsx(Tt,{size:"small",sx:{flex:1,minWidth:220},options:te.map(a=>a.name),value:C,onChange:(a,n)=>le(n),renderInput:a=>e.jsx(x,{...a,label:"Template (optional)"})}),e.jsx(ge,{variant:"contained",startIcon:e.jsx(je,{}),onClick:ce,disabled:!(c!=null&&c.name),children:"Add"})]}),e.jsx(A,{sx:{mt:1},children:e.jsxs($,{spacing:1,children:[e.jsxs($,{direction:{xs:"column",sm:"row"},spacing:1,children:[e.jsx(x,{size:"small",label:"Name",value:(c==null?void 0:c.name)??"",onChange:a=>w(n=>({...n,name:a.target.value})),sx:{flex:1}}),e.jsx(x,{size:"small",type:"number",label:"Bulk",value:(c==null?void 0:c.bulk)??0,onChange:a=>w(n=>({...n,bulk:Number(a.target.value)})),sx:{width:120}}),e.jsx(x,{size:"small",type:"number",label:"Quantity",value:(c==null?void 0:c.quantity)??1,onChange:a=>{const n=Number(a.target.value);Number.isFinite(n)&&w(D=>({...D,quantity:n}))},sx:{width:120}}),e.jsx(x,{size:"small",type:"number",label:"Cost",value:(c==null?void 0:c.cost)??0,onChange:a=>w(n=>({...n,cost:Number(a.target.value)})),sx:{width:140}})]}),h==="item"&&e.jsx(x,{size:"small",label:"Uses",value:(c==null?void 0:c.uses)??"",onChange:a=>w(n=>({...n,uses:a.target.value}))}),h==="cyberware"&&e.jsxs($,{direction:{xs:"column",sm:"row"},spacing:1,children:[e.jsx(x,{size:"small",type:"number",label:"Tier",value:(c==null?void 0:c.tier)??1,onChange:a=>w(n=>({...n,tier:Number(a.target.value)})),sx:{width:120}}),e.jsx(x,{size:"small",type:"number",label:"Installation Difficulty",value:(c==null?void 0:c.installationDifficulty)??0,onChange:a=>w(n=>({...n,installationDifficulty:Number(a.target.value)})),sx:{width:220}}),e.jsx(x,{size:"small",label:"Requirements",value:(c==null?void 0:c.requirements)??"",onChange:a=>w(n=>({...n,requirements:a.target.value})),sx:{flex:1}})]}),h==="cyberware"&&e.jsx(x,{size:"small",label:"Physical Impact",value:(c==null?void 0:c.physicalImpact)??"",onChange:a=>w(n=>({...n,physicalImpact:a.target.value}))}),h==="narcotics"&&e.jsxs($,{direction:{xs:"column",sm:"row"},spacing:1,children:[e.jsx(x,{size:"small",type:"number",label:"Uses",value:(c==null?void 0:c.uses)??1,onChange:a=>w(n=>({...n,uses:Number(a.target.value)})),sx:{width:120}}),e.jsx(x,{size:"small",type:"number",label:"Addiction Score",value:(c==null?void 0:c.addictionScore)??0,onChange:a=>w(n=>({...n,addictionScore:Number(a.target.value)})),sx:{width:160}}),e.jsx(x,{size:"small",label:"Legality",value:(c==null?void 0:c.legality)??"",onChange:a=>w(n=>({...n,legality:a.target.value})),sx:{flex:1}})]}),e.jsx(x,{size:"small",label:"Effect",value:(c==null?void 0:c.effect)??"",onChange:a=>w(n=>({...n,effect:a.target.value})),multiline:!0,minRows:2}),e.jsx(x,{size:"small",label:"Status Effects (comma-separated)",value:(c==null?void 0:c.statusEffects)??"",onChange:a=>w(n=>({...n,statusEffects:a.target.value})),placeholder:'e.g. "carrying_capacity+5"'})]})})]}),e.jsxs(A,{children:[e.jsx(S,{variant:"subtitle2",sx:{mb:1},children:"Inventory"}),r.length===0&&e.jsx(S,{variant:"body2",children:"No inventory items yet."}),r.map(a=>{const n=a.quantity??1,I=(a.bulk??0)*n,P=`${a.name} (${a.type}) • bulk ${I}`;return e.jsxs(Ae,{disableGutters:!0,children:[e.jsx(Re,{expandIcon:e.jsx(Ee,{}),draggable:!0,onDragStart:m=>{J(a.id??null);try{m.dataTransfer.effectAllowed="move",m.dataTransfer.setData("text/plain",a.id??"")}catch{}},onDragOver:m=>{m.preventDefault(),N(a.id??null)},onDragLeave:()=>N(null),onDrop:m=>{m.preventDefault();const W=O??m.dataTransfer.getData("text/plain"),V=a.id;if(W&&V&&W!==V){const v=t.sheet.inventory??[],H=v.findIndex(Q=>Q.id===W),re=v.findIndex(Q=>Q.id===V);if(H>=0&&re>=0){const Q=[...v],[d]=Q.splice(H,1);Q.splice(re,0,d),b(Q)}}J(null),N(null)},sx:B===a.id?{outline:"2px dashed rgba(255,255,255,0.35)",borderRadius:1}:void 0,children:e.jsxs($,{direction:"row",spacing:1,alignItems:"center",sx:{width:"100%"},children:[e.jsx(At,{fontSize:"small",sx:{opacity:.5}}),e.jsx(S,{variant:"body2",sx:{flex:1},children:P}),e.jsxs($,{direction:"row",spacing:.5,alignItems:"center",children:[e.jsx(oe,{size:"small",onClick:m=>{m.stopPropagation();const W=(a.quantity??1)-1;W<=0?ae(a.id):u(a.id,{quantity:W})},children:e.jsx(ot,{fontSize:"small"})}),e.jsx(S,{variant:"caption",sx:{minWidth:18,textAlign:"center"},children:a.quantity??1}),e.jsx(oe,{size:"small",onClick:m=>{m.stopPropagation(),u(a.id,{quantity:(a.quantity??1)+1})},children:e.jsx(je,{fontSize:"small"})})]}),e.jsx(ke,{title:"Remove",children:e.jsx(oe,{size:"small",onClick:m=>(m.stopPropagation(),ae(a.id)),children:e.jsx(_e,{fontSize:"small"})})})]})}),e.jsx(Ne,{children:e.jsxs($,{spacing:1,children:[e.jsxs($,{direction:{xs:"column",sm:"row"},spacing:1,children:[e.jsx(x,{size:"small",label:"Name",value:a.name??"",onChange:m=>u(a.id,{name:m.target.value}),sx:{flex:1}}),e.jsxs(x,{select:!0,size:"small",label:"Type",value:a.type,onChange:m=>u(a.id,{type:m.target.value}),sx:{width:160},children:[e.jsx(xe,{value:"item",children:"Item"}),e.jsx(xe,{value:"cyberware",children:"Cyberware"}),e.jsx(xe,{value:"narcotics",children:"Narcotics"})]}),e.jsx(x,{size:"small",type:"number",label:"Bulk",value:a.bulk??0,onChange:m=>u(a.id,{bulk:Number(m.target.value)}),sx:{width:120}}),e.jsx(x,{size:"small",type:"number",label:"Quantity",value:a.quantity??1,onChange:m=>{const W=Number(m.target.value);Number.isFinite(W)&&(W<=0?ae(a.id):u(a.id,{quantity:W}))},sx:{width:120}}),e.jsx(x,{size:"small",type:"number",label:"Cost",value:a.cost??0,onChange:m=>u(a.id,{cost:Number(m.target.value)}),sx:{width:140}})]}),a.type==="item"&&e.jsx(x,{size:"small",label:"Uses",value:a.uses??"",onChange:m=>u(a.id,{uses:m.target.value})}),a.type==="cyberware"&&e.jsxs($,{direction:{xs:"column",sm:"row"},spacing:1,children:[e.jsx(x,{size:"small",type:"number",label:"Tier",value:a.tier??1,onChange:m=>u(a.id,{tier:Number(m.target.value)}),sx:{width:120}}),e.jsx(x,{size:"small",type:"number",label:"Installation Difficulty",value:a.installationDifficulty??0,onChange:m=>u(a.id,{installationDifficulty:Number(m.target.value)}),sx:{width:220}}),e.jsx(x,{size:"small",label:"Requirements",value:a.requirements??"",onChange:m=>u(a.id,{requirements:m.target.value}),sx:{flex:1}})]}),a.type==="cyberware"&&e.jsx(x,{size:"small",label:"Physical Impact",value:a.physicalImpact??"",onChange:m=>u(a.id,{physicalImpact:m.target.value})}),a.type==="narcotics"&&e.jsxs($,{direction:{xs:"column",sm:"row"},spacing:1,children:[e.jsx(x,{size:"small",type:"number",label:"Uses",value:a.uses??1,onChange:m=>u(a.id,{uses:Number(m.target.value)}),sx:{width:120}}),e.jsx(x,{size:"small",type:"number",label:"Addiction Score",value:a.addictionScore??0,onChange:m=>u(a.id,{addictionScore:Number(m.target.value)}),sx:{width:160}}),e.jsx(x,{size:"small",label:"Legality",value:a.legality??"",onChange:m=>u(a.id,{legality:m.target.value}),sx:{flex:1}})]}),e.jsx(x,{size:"small",label:"Effect",value:a.effect??"",onChange:m=>u(a.id,{effect:m.target.value}),multiline:!0,minRows:2}),e.jsx(x,{size:"small",label:"Status Effects (comma-separated)",value:a.statusEffects??"",onChange:m=>u(a.id,{statusEffects:m.target.value}),placeholder:'e.g. "carrying_capacity+5"'})]})})]},a.id)})]})]})}function fa(){const t=new Map;return Object.keys(me.learned).forEach(r=>{(me.learned[r]??[]).forEach(b=>t.set(b.id,{focus:r}))}),t}function Ke(t){var h;if(!t)return 0;const r=(h=t.keywordParams)==null?void 0:h.ammoMax,b=typeof r=="number"?r:typeof r=="string"?Number(r):void 0;return Number.isFinite(b)?Number(b):0}function xa(t,r,b,h,M){if(h>0)return h+M;const C=t.get(r);return(C&&C.focus===b?0:-1)+M}function ga(){const[t,r]=k.useState({entries:[],activeTokenId:void 0,updatedAt:Date.now()}),[b,h]=k.useState({}),[M,C]=k.useState(""),[g,c]=k.useState(!1),[w,O]=k.useState(0),J=u=>Math.max(-3,Math.min(3,u)),B=k.useMemo(()=>fa(),[]);k.useEffect(()=>{const u=xt(a=>r(a));return()=>u==null?void 0:u()},[]),k.useEffect(()=>{let u=!0;return(async()=>{var a,n,D,I;try{const[P,m]=await Promise.all([((n=(a=U.player).getId)==null?void 0:n.call(a))??Promise.resolve(""),((I=(D=U.player).getRole)==null?void 0:I.call(D))??Promise.resolve("")]);if(!u)return;C(String(P??"")),c(String(m).toUpperCase()==="GM")}catch{}})(),()=>{u=!1}},[]);const N=k.useMemo(()=>{const u=[...t.entries??[]];return u.sort((a,n)=>(n.initiative??0)-(a.initiative??0)),u},[t.entries]);k.useEffect(()=>{let u=!0;return(async()=>{var a,n,D,I,P,m,W;try{const V=N.map(re=>re.tokenId);if(!V.length){u&&h({});return}const v=await U.scene.items.getItems(V),H={};for(const re of v){const Q=re.id,d=await Pe(Q),f=d==null?void 0:d.armor,L=((a=f==null?void 0:f.durability)==null?void 0:a.current)??0,ne=!!f&&L<=0,ee=ne?0:(f==null?void 0:f.protection)??0,_=(n=d==null?void 0:d.weapons)==null?void 0:n[0],de=Ke(_),fe=Number.isFinite(_==null?void 0:_.ammo)?Number(_==null?void 0:_.ammo):0;H[Q]={tokenId:Q,name:((P=(I=(D=re.text)==null?void 0:D.plainText)==null?void 0:I.trim)==null?void 0:P.call(I))||(d==null?void 0:d.name)||"(Unnamed)",thumbUrl:(m=re.image)==null?void 0:m.url,ownerPlayerId:String(((W=re.metadata)==null?void 0:W[it])??""),prot:ee,armorBroken:ne,topWeaponName:_==null?void 0:_.name,topWeaponUseDC:_==null?void 0:_.useDC,topWeaponDamage:_==null?void 0:_.damage,topWeaponSkillId:_==null?void 0:_.skillId,topWeaponAmmo:fe,topWeaponAmmoMax:de}}u&&h(H)}catch{}})(),()=>{u=!1}},[N]);async function te(u){var d,f,L,ne,ee;const[a]=await U.scene.items.getItems([u]);if(!a)return;const n=await Pe(u);if(!n)return;const D=Xe([...(n.feats??[]).map(_=>_.statusEffects??"").filter(Boolean),...(n.inventory??[]).map(_=>_.statusEffects??"").filter(Boolean)]).deltas,I=Me(n.skills??{}),P=((d=n.stress)==null?void 0:d.current)??0,m=Math.max(0,(We(n.skills??{})||0)-(((f=n.stress)==null?void 0:f.cufLoss)??0)),W=kt({attributes:I,stress:{current:P,cuf:m}},D),V=W.stress.cuf??m,v=W.attributes.ref??I.ref??0,H=P>V,re=Le({netDice:H?-1:0,modifier:v,label:`${((L=a.text)==null?void 0:L.plainText)??n.name??"Token"} Initiative`}),Q=await Qe({diceNotation:re,rollTarget:"everyone",showResults:!0});await vt({tokenId:u,initiative:Q,name:((ne=a.text)==null?void 0:ne.plainText)??n.name??"Token",thumbUrl:(ee=a.image)==null?void 0:ee.url})}async function le(){var I,P;const u=await((P=(I=U.player).getSelection)==null?void 0:P.call(I))??[],a=u==null?void 0:u[0],n=await lt()??void 0,D=a||n;if(!D){U.notification.show("Select a token (or set your character) to roll initiative.","WARNING");return}await te(D)}async function ce(u){var L,ne,ee,_;const a=await Pe(u);if(!a)return;const n=(L=a.weapons)==null?void 0:L[0];if(!n){U.notification.show("No weapon in the top slot.","WARNING");return}const D=Xe([...(a.feats??[]).map(de=>de.statusEffects??"").filter(Boolean),...(a.inventory??[]).map(de=>de.statusEffects??"").filter(Boolean)]).deltas,P=(We(a.skills??{})-(((ne=a.stress)==null?void 0:ne.cufLoss)??0)||0)+(D.cool_under_fire??0),W=(((ee=a.stress)==null?void 0:ee.current)??0)>P,V=String(n.skillId??""),v=((_=a.skills)==null?void 0:_[V])??0,H=a.learningFocus??"combat",re=xa(B,V,H,v,D[V]??0),Q=Ke(n),d=Number.isFinite(n==null?void 0:n.ammo)?Number(n==null?void 0:n.ammo):0;if(Q>0&&d<=0){U.notification.show("Out of ammo. Reload first.","WARNING");return}const f=J(w-(W?1:0));if(await ut({weapon:n,netDice:f,modifier:re,attackerName:a.name,rollTarget:"everyone",showResults:!0}),Q>0){const de=Math.max(0,d-1),fe=[...a.weapons??[]];fe[0]={...fe[0],ammo:de},await Je(u,{...a,weapons:fe})}}async function ae(u){var P;const a=await Pe(u);if(!a)return;const n=(P=a.weapons)==null?void 0:P[0];if(!n)return;const D=Ke(n);if(D<=0)return;const I=[...a.weapons??[]];I[0]={...I[0],ammo:D},await Je(u,{...a,weapons:I})}return e.jsxs($,{spacing:2,children:[e.jsxs(A,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",gap:1,flexWrap:"wrap"},children:[e.jsx(S,{variant:"h6",sx:{m:0},children:"Initiative"}),e.jsxs($,{direction:"row",spacing:1,alignItems:"center",children:[e.jsx(ge,{size:"small",variant:"contained",onClick:()=>void le(),startIcon:e.jsx(Te,{}),children:"Roll Initiative"}),e.jsxs(A,{sx:{display:"flex",alignItems:"center",gap:1,flexWrap:"wrap",pl:1},children:[e.jsx(S,{variant:"body2",sx:{opacity:.8},children:"Attack Roll:"}),e.jsxs(Fe,{size:"small",exclusive:!0,value:w,onChange:(u,a)=>{a!==null&&O(a)},children:[e.jsx(se,{value:-2,children:"−2"}),e.jsx(se,{value:-1,children:"−1"}),e.jsx(se,{value:0,children:"0"}),e.jsx(se,{value:1,children:"+1"}),e.jsx(se,{value:2,children:"+2"})]})]}),g&&e.jsxs(e.Fragment,{children:[e.jsx(ge,{size:"small",variant:"outlined",onClick:()=>gt(),children:"Clear"}),e.jsx(ge,{size:"small",variant:"outlined",onClick:()=>pt(),children:"Advance"})]})]})]}),e.jsx(Rt,{}),N.length===0?e.jsx(S,{variant:"body2",sx:{opacity:.75},children:"No initiative rolls yet."}):e.jsx(Et,{dense:!0,disablePadding:!0,children:N.map(u=>{const a=b[u.tokenId],n=a==null?void 0:a.ownerPlayerId,D=g||!!n&&n===M,I=t.activeTokenId===u.tokenId,P=I&&D&&!g,m=!!u.surprised,W=(a==null?void 0:a.topWeaponAmmoMax)??0,V=(a==null?void 0:a.topWeaponAmmo)??0,v=W>0&&V<=0;return e.jsxs(Nt,{sx:{borderRadius:1,mb:.5,bgcolor:I?"rgba(255,255,255,0.06)":"transparent",opacity:m?.55:1},secondaryAction:e.jsxs($,{direction:"row",spacing:.5,alignItems:"center",children:[e.jsx(ke,{title:a!=null&&a.armorBroken?"Armor broken":"Protection",children:e.jsxs(A,{sx:{display:"inline-flex",alignItems:"center",gap:.5,px:1,py:.5,borderRadius:1,bgcolor:"rgba(0,0,0,0.25)"},children:[e.jsx(Ft,{fontSize:"small",sx:{color:a!=null&&a.armorBroken?"error.main":"inherit"}}),e.jsx(S,{variant:"caption",children:(a==null?void 0:a.prot)??0})]})}),(g||D)&&e.jsx(ke,{title:a!=null&&a.topWeaponName?v?`Out of ammo: ${a.topWeaponName}`:`Attack: ${a.topWeaponName}`:"No top weapon",children:e.jsx("span",{children:e.jsx(oe,{size:"small",disabled:!(a!=null&&a.topWeaponName)||v,onClick:()=>void ce(u.tokenId),children:e.jsx(Te,{fontSize:"small"})})})}),(g||D)&&e.jsx(ke,{title:a!=null&&a.topWeaponName?W<=0?"No ammo to reload":`Reload: ${a.topWeaponName}`:"No top weapon",children:e.jsx("span",{children:e.jsx(oe,{size:"small",disabled:!(a!=null&&a.topWeaponName)||W<=0,onClick:()=>void ae(u.tokenId),children:e.jsx(ct,{fontSize:"small"})})})}),e.jsx(ke,{title:D||g?"Remove":"Only the owner or GM can remove",children:e.jsx("span",{children:e.jsx(oe,{size:"small",disabled:!D&&!g,onClick:()=>bt(u.tokenId),children:e.jsx(_e,{fontSize:"small"})})})})]}),children:[e.jsx(Pt,{children:e.jsx(zt,{src:a==null?void 0:a.thumbUrl,variant:"rounded",sx:{width:32,height:32,mr:1,cursor:"pointer"}})}),e.jsx(Wt,{primary:e.jsxs(A,{sx:{display:"flex",alignItems:"center",gap:1,flexWrap:"wrap"},children:[e.jsx(S,{variant:"body2",sx:{fontWeight:600},children:(a==null?void 0:a.name)??u.name??"Token"}),e.jsx(S,{variant:"caption",sx:{opacity:.75},children:u.initiative}),P&&e.jsx(S,{variant:"caption",sx:{px:1,py:.25,borderRadius:1,bgcolor:"rgba(0,128,255,0.2)"},children:"Your Turn"})]}),secondary:e.jsxs(A,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(Lt,{size:"small",checked:m,disabled:!g,onChange:H=>yt(u.tokenId,H.target.checked)}),e.jsx(S,{variant:"caption",sx:{opacity:.75},children:"Surprised"})]})})]},u.tokenId)})})]})}function pa(){var s,l,p,G,pe,E,ve;const[t,r]=k.useState({kind:"loading"}),[b,h]=k.useState("core"),[M,C]=k.useState(!1),[g,c]=k.useState(null),[w,O]=k.useState(!1),[J,B]=k.useState([]);async function N(o){var i,y,j,T,F,z;try{const Y=await U.scene.items.getItems([o]),R=Y==null?void 0:Y[0];if(!R)return{ownerLabel:"unowned",thumbUrl:null};const X=((i=R==null?void 0:R.image)==null?void 0:i.url)??((y=R==null?void 0:R.image)==null?void 0:y.href)??(R==null?void 0:R.imageUrl)??(R==null?void 0:R.image)??((j=R==null?void 0:R.thumbnail)==null?void 0:j.url)??null,q=(T=R==null?void 0:R.metadata)==null?void 0:T[it];if(typeof q!="string"||q.length===0)return{ownerLabel:"unowned",thumbUrl:X,ownerPlayerId:null,isOwnedByMe:!1};const Z=await U.player.getId();if(q===Z)return{ownerLabel:"owned by you",thumbUrl:X,ownerPlayerId:q,isOwnedByMe:!0};try{const K=(await((z=(F=U.party).getPlayers)==null?void 0:z.call(F))??[]).find(ye=>(ye==null?void 0:ye.id)===q);return{ownerLabel:`owned by ${typeof(K==null?void 0:K.name)=="string"&&K.name.length>0?K.name:q}`,thumbUrl:X,ownerPlayerId:q,isOwnedByMe:!1}}catch{return{ownerLabel:`owned by ${q}`,thumbUrl:X,ownerPlayerId:q,isOwnedByMe:!1}}}catch{return{ownerLabel:"unowned",thumbUrl:null,ownerPlayerId:null,isOwnedByMe:!1}}}async function te(o){const i=o!=null&&o.ignoreOpenOverride?null:await wt();if(i)if(await Ue(i)){const q=await Oe(i);if(!q)throw new Error("Could not load sheet from token.");const Z=Me(q.skills??{}),he={...q,attributes:Z},K=await N(i);r({kind:"ready",tokenId:i,sheet:he,mode:"view",suppressUnset:!0,...K});return}else await qe(null);let j=await lt();if(j||(j=await Ze(),j&&await Ie(j)),!j){r({kind:"need-token"});return}let T=await Ue(j);if(!T){const X=await Ze();X&&(j=X,await Ie(j),T=await Ue(j))}if(!T){await Ie(null),r({kind:"need-token"});return}const F=await Oe(j);if(!F)throw new Error("Could not load sheet from token.");try{await et(j)}catch{}const z=Me(F.skills??{}),Y={...F,attributes:z},R=await N(j);r({kind:"ready",tokenId:j,sheet:Y,mode:"my",suppressUnset:!!(o!=null&&o.suppressUnset),...R})}k.useEffect(()=>{let o=!1;return U.onReady(async()=>{try{const i=await U.player.getRole();o||O(String(i).toUpperCase()==="GM"),await te()}catch(i){o||r({kind:"error",message:i.message??"Unknown error"})}}),()=>{o=!0}},[]),k.useEffect(()=>{let o=null,i=!1;return U.onReady(()=>{i||(o=U.broadcast.onMessage(Ve,y=>{const j=y.data;j!=null&&j.text&&B(T=>[...T,j].slice(-3))}))}),()=>{if(i=!0,typeof o=="function")try{o()}catch{}}},[]),k.useEffect(()=>{let o=null,i=null,y=!1;const j="whisperspace.combatLogLeader",T=2e3,F=6e3,z=`${Date.now()}-${Math.random().toString(36).slice(2,10)}`,Y=()=>{try{const K=localStorage.getItem(j);return K?JSON.parse(K):null}catch{return null}},R=K=>{try{localStorage.setItem(j,JSON.stringify({id:z,ts:K??Date.now()}))}catch{}},X=()=>{const K=Y();return K&&K.id===z},q=()=>{const K=Date.now(),ue=Y();(!ue||K-(ue.ts??0)>F||ue.id===z)&&R(K)},Z=()=>{const K=X();if(K&&!o)o=U.broadcast.onMessage(Ve,ue=>{const ye=ue.data;ye!=null&&ye.text&&U.notification.show(String(ye.text),"INFO")});else if(!K&&o){try{o()}catch{}o=null}},he=K=>{K.key===j&&Z()};return U.onReady(()=>{if(!y){try{window.addEventListener("storage",he)}catch{}q(),Z(),i=window.setInterval(()=>{y||(q(),Z())},T)}}),()=>{y=!0;try{window.removeEventListener("storage",he)}catch{}if(i!==null&&clearInterval(i),X())try{localStorage.removeItem(j)}catch{}if(typeof o=="function")try{o()}catch{}}},[]);function le(o,i,y){const j={text:`${o} took ${i} damage${y?` and +${y} stress`:""}.`,ts:Date.now(),kind:"effect",targetName:o,damageApplied:i,stressApplied:y};B(T=>[...T,j].slice(-3))}function ce(o){if(t.kind!=="ready"||t.mode!=="my")return;const i=Math.max(0,Math.trunc(o.damageApplied??0)),y=Math.max(0,Math.trunc(o.stressApplied??0));i<=0&&y<=0||(I(j=>mt({sheet:j,incomingDamage:i,stressDelta:y})),le(t.sheet.name||"Target",i,y))}k.useEffect(()=>{var T,F,z,Y;if(t.kind!=="ready")return;const o=t.tokenId;let i=!1;const y=async()=>{var R,X;try{const q=await U.scene.items.getItems([o]),Z=q==null?void 0:q[0],he=String(((R=Z==null?void 0:Z.text)==null?void 0:R.plainText)??"").trim(),K=(X=Z==null?void 0:Z.image)==null?void 0:X.url;if(i||!he&&!K)return;r(ue=>{if(ue.kind!=="ready"||ue.tokenId!==o)return ue;const ye=he&&ue.sheet.name!==he?{...ue.sheet,name:he}:ue.sheet;return{...ue,sheet:ye,thumbUrl:K??ue.thumbUrl}})}catch{}};y();const j=(Y=(z=(F=(T=U)==null?void 0:T.scene)==null?void 0:F.items)==null?void 0:z.onChange)==null?void 0:Y.call(z,R=>{Array.isArray(R)&&R.some(X=>(X==null?void 0:X.id)===o)&&y()});return()=>{i=!0,typeof j=="function"&&j()}},[t.kind,t.kind==="ready"?t.tokenId:null]);const ae=k.useMemo(()=>t.kind==="ready"&&t.sheet.name||"Whisperspace Sheet",[t]);async function u(){const o=await Ut();if(!o){r({kind:"error",message:"No token selected. Select a token on the map first."});return}const i=await Oe(o);if(!i){r({kind:"error",message:"Could not attach a sheet to the selected token."});return}const y=Me(i.skills??{}),j={...i,attributes:y};await Ie(o);try{await et(o)}catch{}await qe(null);const T=await N(o);r({kind:"ready",tokenId:o,sheet:j,mode:"my",suppressUnset:!1,...T})}async function a(){await Ie(null);try{await Ct()}catch{}r({kind:"need-token"})}async function n(){await qe(null),r({kind:"loading"});try{await te({ignoreOpenOverride:!0,suppressUnset:!0})}catch(o){r({kind:"error",message:o.message??"Unknown error"})}}async function D(o,i){C(!0);try{await Je(o,i)}finally{C(!1)}}function I(o){r(i=>{if(i.kind!=="ready")return i;let y=o(i.sheet);try{const j=Me(y.skills??{});y={...y,attributes:{...y.attributes,...j},stress:{...y.stress??{current:0,cuf:0,cufLoss:0},cuf:We(y.skills??{})}}}catch{}return D(i.tokenId,y),{...i,sheet:y}})}async function P(o){var Y;if(t.kind!=="ready")return;const i=8+o,y=Math.max(0,Math.trunc(((Y=t.sheet.stress)==null?void 0:Y.cuf)??0)),j=`Crucible Test (DC ${i})`,T=y===0?"":` +${y}`,F=`1d12 # ${j}${T}`;let z;try{z=await Qe({diceNotation:F,rollTarget:"everyone",showResults:!0,timeoutMs:6e3})}catch{U.notification.show("Dice+ roll failed or timed out.","WARNING");return}z>=i?(I(R=>({...R,stress:{...R.stress??{current:0,cuf:0,cufLoss:0},current:5},indomitable:!0})),c({incoming:o,dc:i,status:"success",total:z})):c({incoming:o,dc:i,status:"fail",total:z})}function m(o){var j;if(t.kind!=="ready")return;const i=Math.max(0,Math.trunc(((j=t.sheet.stress)==null?void 0:j.current)??0)),y=Math.max(0,Math.trunc(o));if(i<=5&&y>5){const T=y-i;c({incoming:T,dc:8+T,status:"pending"})}else c(null);I(T=>({...T,stress:{...T.stress??{current:0,cuf:0,cufLoss:0},current:y}}))}function W(o,i){var z;if(t.kind!=="ready")return;const j={light:4,moderate:2,heavy:1}[o],T=Math.max(0,Math.trunc(((z=t.sheet.wounds)==null?void 0:z[o])??0)),F=i<T?i:i+1;I(Y=>({...Y,wounds:{...Y.wounds,[o]:Math.min(j,Math.max(0,F))}}))}function V(){var i;if(t.kind!=="ready"||!g||g.status!=="fail")return;const o=Math.max(0,Math.trunc(((i=t.sheet.stress)==null?void 0:i.cufLoss)??0));I(y=>({...y,stress:{...y.stress??{current:0,cuf:0,cufLoss:0},cufLoss:o+1,current:5},indomitable:!0})),c({...g,status:"success"})}const v=t.kind==="ready"?t.sheet:null,H=De.useMemo(()=>{if(!v)return{};const o=[];return(v.feats??[]).forEach(i=>{typeof(i==null?void 0:i.statusEffects)=="string"&&i.statusEffects.trim()&&o.push(i.statusEffects)}),(v.inventory??[]).forEach(i=>{typeof(i==null?void 0:i.statusEffects)=="string"&&i.statusEffects.trim()&&o.push(i.statusEffects)}),jt(o)},[v]),re=De.useMemo(()=>{const o={},i=new Map,y=T=>{const F=String(T.id),z=String(T.name??T.label??"").toLowerCase().replace(/\s+/g,"_").replace(/[^a-z0-9_\-()]/g,"");F&&(i.set(F.toLowerCase(),F),z&&i.set(z,F))};(me.inherent??[]).forEach(y),Object.values(me.learned??{}).forEach(T=>{(T??[]).forEach(y)});const j=new Set(["phys","ref","soc","ment","carrying_capacity","cool_under_fire","speed","cuf","carry","capacity","spd"]);return Object.entries(H??{}).forEach(([T,F])=>{const z=String(T).toLowerCase();if(j.has(z))return;const Y=i.get(z);Y&&(o[Y]=(o[Y]??0)+(Number.isFinite(F)?F:0))}),o},[H]),Q=Math.max(0,(((s=v==null?void 0:v.attributes)==null?void 0:s.phys)??0)+(H.phys??0)),d=Math.max(0,(((l=v==null?void 0:v.attributes)==null?void 0:l.ref)??0)+(H.ref??0)),f=Math.max(0,(((p=v==null?void 0:v.attributes)==null?void 0:p.soc)??0)+(H.soc??0)),L=Math.max(0,(((G=v==null?void 0:v.attributes)==null?void 0:G.ment)??0)+(H.ment??0)),ee=5+Q*5+(H.carrying_capacity??0);30+Q*5+(H.speed??0);const de=v?We(v.skills??{}):0,fe=Math.max(0,de+(H.cool_under_fire??0)),be=De.useMemo(()=>v?{...v,attributes:{...v.attributes,phys:Q,ref:d,soc:f,ment:L},stress:{...v.stress??{current:0,cuf:0,cufLoss:0},cuf:fe}}:null,[v,Q,d,f,L,fe])??v,we=De.useMemo(()=>{var j;if(!v)return 0;const o=(v.weapons??[]).reduce((T,F)=>T+(F.bulk??0),0),i=((j=v.armor)==null?void 0:j.bulk)??0,y=(v.inventory??[]).reduce((T,F)=>{const z=F.quantity??1,Y=F.bulk??0,R=Number.isFinite(Y)?Y:0,X=Number.isFinite(z)?z:1;return T+R*X},0);return o+i+y},[v]),Se=v&&we>ee*2?"Heavily Encumbered":v&&we>ee?"Encumbered":"";return t.kind==="loading"?e.jsx("div",{style:{padding:12},children:"Loading…"}):t.kind==="need-token"?e.jsxs("div",{style:{padding:12},children:[e.jsx("h2",{style:{margin:"0 0 8px 0"},children:"My Sheet"}),e.jsx("p",{style:{margin:"0 0 10px 0",lineHeight:1.35},children:"Select your character token on the map, then click:"}),e.jsx("button",{style:{padding:"8px 10px",borderRadius:8,border:"1px solid #666",cursor:"pointer"},onClick:u,children:"Set Selected Token as My Character"})]}):t.kind==="error"?e.jsxs("div",{style:{padding:12},children:[e.jsx("h2",{style:{margin:"0 0 8px 0"},children:"Error"}),e.jsx("p",{style:{margin:"0 0 10px 0",lineHeight:1.35},children:t.message}),e.jsx("button",{style:{padding:"8px 10px",borderRadius:8,border:"1px solid #666",cursor:"pointer"},onClick:()=>r({kind:"need-token"}),children:"Back"})]}):e.jsxs("div",{style:{padding:12},children:[e.jsxs("div",{style:{display:"flex",alignItems:"flex-start",gap:12,justifyContent:"space-between",marginBottom:10},children:[e.jsxs("div",{style:{display:"flex",gap:10,alignItems:"flex-start"},children:[t.thumbUrl?e.jsx("img",{src:t.thumbUrl,alt:"Token thumbnail",style:{width:44,height:44,borderRadius:10,objectFit:"cover",border:"1px solid rgba(0,0,0,0.2)"}}):e.jsx("div",{style:{width:44,height:44,borderRadius:10,border:"1px solid rgba(0,0,0,0.2)",opacity:.4}}),e.jsxs("div",{children:[e.jsxs("div",{style:{fontSize:18,fontWeight:700},children:[ae," ",e.jsxs("span",{style:{fontSize:12,opacity:.75},children:["(",t.ownerLabel??(t.mode==="view"?"Viewing token":"My Character"),")"]})]}),e.jsxs("div",{style:{fontSize:12,opacity:.8},children:["Token: ",e.jsx("code",{style:{fontSize:11},children:t.tokenId})]})]})]}),e.jsx("div",{style:{display:"flex",gap:8},children:t.mode==="view"?!t.isOwnedByMe&&e.jsx("button",{style:{padding:"8px 10px",borderRadius:8,border:"1px solid #999",cursor:"pointer",opacity:.9},onClick:n,children:"Back to My Sheet"}):t.suppressUnset?null:e.jsx("button",{style:{padding:"8px 10px",borderRadius:8,border:"1px solid #999",cursor:"pointer",opacity:.9},onClick:a,children:"Unset “My Character”"})})]}),e.jsxs(e.Fragment,{children:[e.jsxs("div",{style:ie.statusBar,children:[e.jsxs("div",{style:ie.statusLeft,children:[e.jsxs("div",{style:ie.statusGroup,children:[e.jsx("div",{style:ie.statusLabel,children:"Stress"}),e.jsx("input",{type:"number",min:0,value:((pe=t.sheet.stress)==null?void 0:pe.current)??0,onChange:o=>m(Number(o.target.value)),style:ie.statusNumber})]}),e.jsxs("div",{style:ie.statusGroup,children:[e.jsx("div",{style:ie.statusLabel,children:"Wounds"}),e.jsxs("div",{style:ie.woundsRow,children:[e.jsx("span",{style:ie.woundsKind,children:"L"}),Array.from({length:4}).map((o,i)=>{var y;return e.jsx("input",{type:"checkbox",checked:(((y=t.sheet.wounds)==null?void 0:y.light)??0)>i,onChange:()=>W("light",i)},`wl_${i}`)}),e.jsx("span",{style:{width:8}}),e.jsx("span",{style:ie.woundsKind,children:"M"}),Array.from({length:2}).map((o,i)=>{var y;return e.jsx("input",{type:"checkbox",checked:(((y=t.sheet.wounds)==null?void 0:y.moderate)??0)>i,onChange:()=>W("moderate",i)},`wm_${i}`)}),e.jsx("span",{style:{width:8}}),e.jsx("span",{style:ie.woundsKind,children:"H"}),Array.from({length:1}).map((o,i)=>{var y;return e.jsx("input",{type:"checkbox",checked:(((y=t.sheet.wounds)==null?void 0:y.heavy)??0)>i,onChange:()=>W("heavy",i)},`wh_${i}`)})]})]}),e.jsxs("label",{style:{display:"flex",alignItems:"center",gap:6},children:[e.jsx("input",{type:"checkbox",checked:!!t.sheet.indomitable,onChange:o=>I(i=>({...i,indomitable:o.target.checked}))}),e.jsx("span",{style:{fontSize:12,opacity:.9},children:"Indomitable"})]}),(((E=t.sheet.stress)==null?void 0:E.current)??0)>(((ve=(be??t.sheet).stress)==null?void 0:ve.cuf)??0)&&e.jsx("div",{style:ie.warning,children:"Stress > CUF: make all rolls with +1 Penalty Die"}),e.jsxs("div",{style:{fontSize:12,opacity:.85},children:["Bulk: ",we," / ",ee]}),Se&&e.jsx("div",{style:ie.warning,children:Se})]}),e.jsxs("div",{style:ie.statusRight,children:[g&&g.status==="pending"&&e.jsxs("div",{style:ie.crucibleBox,children:[e.jsx("div",{style:{fontWeight:700},children:"Crucible Test!"}),e.jsxs("div",{style:{fontSize:12,opacity:.85},children:["Incoming stress: ",g.incoming," • DC ",g.dc," • Roll CUF (no bonus/penalty dice)"]}),e.jsx("button",{style:ie.buttonSecondary,onClick:()=>void P(g.incoming),children:"Roll Crucible"})]}),g&&g.status==="success"&&e.jsxs("div",{style:ie.crucibleBox,children:[e.jsx("div",{style:{fontWeight:700},children:"Crucible succeeded!"}),e.jsx("div",{style:{fontSize:12,opacity:.85},children:"Choose an Indomitable effect. (Indomitable checked automatically.)"})]}),g&&g.status==="fail"&&e.jsxs("div",{style:ie.crucibleBox,children:[e.jsx("div",{style:{fontWeight:700},children:"Crucible failed"}),e.jsx("div",{style:{fontSize:12,opacity:.85},children:"You’ve entered PTSD range (6–8 stress)."}),e.jsx("button",{style:ie.buttonSecondary,onClick:V,children:"Spend 1 CUF to pass"})]})]})]}),e.jsxs("div",{style:{display:"flex",gap:8,alignItems:"center",marginBottom:10},children:[e.jsx(Ce,{label:"Core",active:b==="core",onClick:()=>h("core")}),e.jsx(Ce,{label:"Skills",active:b==="skills",onClick:()=>h("skills")}),e.jsx(Ce,{label:"Combat",active:b==="combat",onClick:()=>h("combat")}),e.jsx(Ce,{label:"Initiative",active:b==="initiative",onClick:()=>h("initiative")}),e.jsx(Ce,{label:"Inventory",active:b==="inventory",onClick:()=>h("inventory")}),e.jsx(Ce,{label:"Feats",active:b==="feats",onClick:()=>h("feats")}),e.jsx("div",{style:{marginLeft:"auto",opacity:.8},children:M?"Saving…":"Synced"})]}),e.jsxs("div",{style:{border:"1px solid #888",borderRadius:12,padding:10},children:[b==="core"&&e.jsx($t,{sheet:be,onChange:o=>I(i=>({...i,...o}))}),b==="skills"&&e.jsx(Gt,{sheet:be,skillMods:re,onChange:o=>I(i=>({...i,skills:o})),onMetaChange:o=>I(i=>({...i,...o}))}),b==="combat"&&e.jsx(aa,{sheet:be,tokenId:t.tokenId,skillMods:re,onChange:o=>I(i=>({...i,...o})),onApplyStress:m,combatLog:J,onApplyCombatLog:t.mode==="my"?ce:void 0,isGM:w}),b==="initiative"&&e.jsx(ga,{}),b==="inventory"&&e.jsx(ha,{sheet:be,onChange:o=>I(i=>({...i,...o}))}),b==="feats"&&e.jsx(Kt,{sheet:be,onChange:o=>I(i=>({...i,feats:o}))})]})]})]})}function Ce(t){return e.jsx("button",{onClick:t.onClick,style:{padding:"6px 10px",borderRadius:999,border:"1px solid #777",cursor:"pointer",background:"transparent",fontWeight:t.active?700:400},children:t.label})}const ie={statusBar:{display:"flex",alignItems:"flex-start",justifyContent:"space-between",gap:12,padding:"10px 12px",borderRadius:12,border:"1px solid rgba(255,255,255,0.15)",marginBottom:10},statusLeft:{display:"flex",alignItems:"center",gap:16,flexWrap:"wrap"},statusRight:{display:"flex",alignItems:"center",gap:12},statusGroup:{display:"flex",flexDirection:"column",gap:4},statusLabel:{fontSize:11,opacity:.75,letterSpacing:.2},statusNumber:{width:64,fontSize:16},woundsRow:{display:"flex",alignItems:"center",gap:8,flexWrap:"wrap"},woundsKind:{fontSize:11,opacity:.75,width:14,textAlign:"center"},warning:{marginTop:8,fontSize:12,opacity:.9},crucibleBox:{border:"1px solid rgba(255,255,255,0.18)",borderRadius:12,padding:10,maxWidth:240},buttonSecondary:{padding:"6px 10px",borderRadius:8,border:"1px solid #999",cursor:"pointer",opacity:.9,background:"transparent"}};function ya(t){var J,B,N,te,le,ce,ae,u;const r=((t==null?void 0:t.mode)??"LIGHT")==="DARK"?"dark":"light",b=((J=t==null?void 0:t.background)==null?void 0:J.default)??(r==="dark"?"#121212":"#ffffff"),h=((B=t==null?void 0:t.background)==null?void 0:B.paper)??(r==="dark"?"#1e1e1e":"#f7f7f7"),M=((N=t==null?void 0:t.text)==null?void 0:N.primary)??(r==="dark"?"#ffffff":"#111111"),C=((te=t==null?void 0:t.text)==null?void 0:te.secondary)??(r==="dark"?"#bdbdbd":"#444444"),g=((le=t==null?void 0:t.primary)==null?void 0:le.main)??"#2f6fed",c=((ce=t==null?void 0:t.primary)==null?void 0:ce.contrastText)??"#ffffff",w=((ae=t==null?void 0:t.secondary)==null?void 0:ae.main)??"#7c3aed",O=((u=t==null?void 0:t.secondary)==null?void 0:u.contrastText)??"#ffffff";return Ot({palette:{mode:r,background:{default:b,paper:h},text:{primary:M,secondary:C},primary:{main:g,contrastText:c},secondary:{main:w,contrastText:O}},shape:{borderRadius:12},typography:{fontFamily:"system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif"},components:{MuiPaper:{defaultProps:{elevation:0}},MuiButton:{styleOverrides:{root:{color:M},containedPrimary:{color:c},containedSecondary:{color:O}}}}})}function ba(t){const[r,b]=k.useState(null);k.useEffect(()=>{let M=null,C=!1;return U.onReady(async()=>{if(!C)try{const g=await U.theme.getTheme();C||b(g),M=U.theme.onChange(c=>b(c))}catch{}}),()=>{C=!0,M&&M()}},[]);const h=k.useMemo(()=>ya(r),[r]);return e.jsxs(_t,{theme:h,children:[e.jsx(Bt,{}),t.children]})}async function ka(){await U.onReady(async()=>{}),St.createRoot(document.getElementById("root")).render(e.jsx(De.StrictMode,{children:e.jsx(ba,{children:e.jsx(pa,{})})}))}ka();
