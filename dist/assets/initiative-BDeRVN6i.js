import{O as c}from"./vendor_obr-BLY5dk8V.js";import{o as m,s as r,n as o,r as D,u as K,b as P,a as g,d as J,l as k,e as z}from"./vendor_zod-CxP395f9.js";import{C as G}from"./config-BSaTKKvG.js";const R="whisperspace.sheet.v1",Q=m({name:r().default(""),description:r().default(""),statusEffects:r().default("")}),X=m({name:r().default(""),keywords:g(r()).default([]),keywordParams:D(K([r(),o(),P()])).default({}),protection:o().int().nonnegative().default(0),durability:m({current:o().int().nonnegative().default(0),max:o().int().nonnegative().default(0)}).default({current:0,max:0}),bulk:o().int().nonnegative().optional(),req:r().optional(),cost:o().int().nonnegative().optional(),special:r().optional()}),Z=m({id:r().optional(),name:r().default(""),skillId:r().default(""),useDC:o().int().default(8),damage:o().int().default(0),keywords:g(r()).default([]),keywordParams:D(K([r(),o(),P()])).default({}),range:r().optional(),ammo:o().int().nonnegative().optional(),bulk:o().int().nonnegative().optional(),req:r().optional(),cost:o().int().nonnegative().optional()}),Y=m({schemaVersion:k(1).default(1),name:r().default(""),attributes:m({phys:o().int().nonnegative().default(0),ref:o().int().nonnegative().default(0),soc:o().int().nonnegative().default(0),ment:o().int().nonnegative().default(0)}).default({phys:0,ref:0,soc:0,ment:0}),stress:m({current:o().int().nonnegative().default(0),cuf:o().int().nonnegative().default(0),cufLoss:o().int().nonnegative().default(0)}).default({current:0,cuf:0,cufLoss:0}),wounds:m({light:o().int().nonnegative().default(0),moderate:o().int().nonnegative().default(0),heavy:o().int().nonnegative().default(0)}).default({light:0,moderate:0,heavy:0}),skills:D(o().int()).default({}),learningFocus:z(["combat","education","vehicles"]).optional(),skillPoints:o().int().nonnegative().optional(),weapons:g(Z).default([]),armor:X.optional(),credits:o().int().nonnegative().default(0),inventory:g(J("type",[m({id:r().optional(),type:k("item"),name:r().default(""),quantity:o().int().default(1),uses:r().default(""),bulk:o().int().default(0),effect:r().default(""),cost:o().int().default(0),statusEffects:r().default("")}),m({id:r().optional(),type:k("cyberware"),name:r().default(""),quantity:o().int().default(1),bulk:o().int().default(1),tier:o().int().default(1),installationDifficulty:o().int().default(0),requirements:r().default(""),physicalImpact:r().default(""),effect:r().default(""),cost:o().int().default(0),statusEffects:r().default("")}),m({id:r().optional(),type:k("narcotics"),name:r().default(""),bulk:o().int().default(1),quantity:o().int().default(1),uses:o().int().default(1),addictionScore:o().int().default(0),legality:r().default(""),effect:r().default(""),cost:o().int().default(0),statusEffects:r().default("")})])).default([]),indomitable:P().default(!1),feats:g(Q).default([]),notes:r().optional()}),U=Y;function q(t){const n=Y.parse({});return typeof t=="string"&&t.trim().length>0?{...n,name:t.trim()}:n}function $(t){const n=U.safeParse(t);if(n.success)return n.data;const e=q(typeof(t==null?void 0:t.name)=="string"?t.name:void 0),i=t==null?void 0:t.skills,s=et(nt(i)?i:{}),a={...e,...T(t,["name","archetype","background","motivation","notes"]),attributes:{...e.attributes,...T(t==null?void 0:t.attributes,["phys","ref","soc","ment"])},stress:{...e.stress,...T(t==null?void 0:t.stress,["current","cuf"])},wounds:{...e.wounds,...T(t==null?void 0:t.wounds,["light","moderate","heavy"])},skills:s,feats:Array.isArray(t==null?void 0:t.feats)?t.feats:e.feats,weapons:Array.isArray(t==null?void 0:t.weapons)?t.weapons:e.weapons,armor:(t==null?void 0:t.armor)??e.armor,schemaVersion:1},l=U.safeParse(a);return l.success?l.data:e}const bt=$,tt={powerlifting:"powerlift",light_weapons:"weapons_light",medium_weapons:"weapons_medium",heavy_weapons:"weapons_heavy",exotic_weapons:"weapons_exotic",melee_blunt:"melee_weapons",melee_sharp:"melee_weapons"};function et(t){const n={};for(const[e,i]of Object.entries(t??{})){const s=tt[e]??e,a=typeof i=="number"?i:0;n[s]=Math.max(n[s]??0,a)}for(const[e,i]of Object.entries(n))i||delete n[e];return n}function T(t,n){const e={};if(!t||typeof t!="object")return e;for(const i of n)t[i]!==void 0&&(e[i]=t[i]);return e}function nt(t){if(!t||typeof t!="object")return!1;for(const n of Object.values(t))if(typeof n!="number")return!1;return!0}const C="com.whisperspace.sheet",M=`${C}/myCharacterTokenId`,x=`${C}/openTokenId`,_=`${C}/ownerPlayerId`;function W(t){return typeof t=="string"&&t.length>0}async function gt(){const n=(await c.player.getMetadata())[M];return W(n)?n:null}async function ht(t){const e={...await c.player.getMetadata()};t?e[M]=t:delete e[M],await c.player.setMetadata(e)}async function vt(){const n=(await c.player.getMetadata())[x];return W(n)?n:null}async function It(t){const e={...await c.player.getMetadata()};t?e[x]=t:delete e[x],await c.player.setMetadata(e)}async function at(t){var f,I;const e=(await c.scene.items.getItems([t]))[0];if(!e)return null;const i=(f=e==null?void 0:e.text)==null?void 0:f.plainText,s=i&&i.trim().length>0?i:e.name??"Unnamed",a=(I=e.metadata)==null?void 0:I[R];if(!a)return q(s);const l=$(a);return!l.name||l.name==="Unnamed"?{...l,name:s}:l}async function it(t,n){await c.scene.items.updateItems([t],e=>{const i=e[0];if(i){i.metadata[R]=n;try{const s=i.text??{};i.text={...s,plainText:n.name}}catch{}}})}async function st(t){var i;const e=(await c.scene.items.getItems([t]))[0];return e?!!((i=e.metadata)!=null&&i[R]):!1}async function wt(t){const n=await at(t);return n?(await st(t)||await it(t,n),n):null}async function kt(t){const n=await c.player.getId();(await c.scene.items.getItems([t]))[0]&&await c.scene.items.updateItems([t],i=>{const s=i[0];s&&(s.metadata[_]=n)})}async function Tt(){const t=await c.player.getId(),e=(await c.scene.items.getItems()).find(i=>{var s;return((s=i.metadata)==null?void 0:s[_])===t});return(e==null?void 0:e.id)??null}async function Et(){const t=await c.player.getId(),e=(await c.scene.items.getItems()).filter(s=>{var a;return((a=s.metadata)==null?void 0:a[_])===t});if(e.length===0)return;const i=e.map(s=>s.id);await c.scene.items.updateItems(i,s=>{s.forEach(a=>{a&&delete a.metadata[_]})})}const N="__whisperspace_hooks";function B(){const t=globalThis;if(t[N])return t[N];const n=new Map,e={on(i,s){const a=n.get(i)??new Set;return a.add(s),n.set(i,a),()=>{a.delete(s)}},emit(i,s){const a=n.get(i);if(a)for(const l of Array.from(a))try{l(s)}catch(f){console.warn(`[hooks] handler failed for ${i}`,f)}}};return t[N]=e,e}const F="dice-plus/isReady",H="dice-plus/roll-request",E="whisperspace.obr.sheet";async function ot(t=1e3){const n=crypto.randomUUID();return new Promise(e=>{const i=c.broadcast.onMessage(F,s=>{const a=s.data;(a==null?void 0:a.requestId)===n&&a.ready===!0&&(i(),e(!0))});c.broadcast.sendMessage(F,{requestId:n,timestamp:Date.now()},{destination:"ALL"}),setTimeout(()=>{i(),e(!1)},t)})}async function _t(t){const n=crypto.randomUUID();return B().emit("dice:roll",{diceNotation:t.diceNotation,rollTarget:t.rollTarget,showResults:t.showResults,rollId:n}),await c.broadcast.sendMessage(H,{rollId:n,playerId:await c.player.getId(),playerName:await c.player.getName(),rollTarget:t.rollTarget??"everyone",diceNotation:t.diceNotation,showResults:t.showResults??!0,timestamp:Date.now(),source:E},{destination:"ALL"}),n}async function At(t){if(!await ot())throw new Error("Dice+ is not available");const e=crypto.randomUUID(),i=t.timeoutMs??5e3;return B().emit("dice:roll",{diceNotation:t.diceNotation,rollTarget:t.rollTarget,showResults:t.showResults,rollId:e}),new Promise(async(s,a)=>{const l=u=>{var b,O;const d=[u==null?void 0:u.total,u==null?void 0:u.value,(b=u==null?void 0:u.result)==null?void 0:b.total,(O=u==null?void 0:u.result)==null?void 0:O.totalValue];for(const w of d){const L=typeof w=="number"?w:typeof w=="string"?Number(w):NaN;if(Number.isFinite(L))return Math.trunc(L)}return NaN},f=c.broadcast.onMessage(`${E}/roll-result`,u=>{const d=u.data;if((d==null?void 0:d.rollId)===e){const b=l(d);if(!Number.isFinite(b))return;S(),s(b)}}),I=c.broadcast.onMessage(`${E}/roll-error`,u=>{const d=u.data;(d==null?void 0:d.rollId)===e&&(S(),a(new Error((d==null?void 0:d.error)||"Dice+ roll failed")))}),S=()=>{f(),I()};await c.broadcast.sendMessage(H,{rollId:e,playerId:await c.player.getId(),playerName:await c.player.getName(),rollTarget:t.rollTarget??"everyone",diceNotation:t.diceNotation,showResults:t.showResults??!0,timestamp:Date.now(),source:E},{destination:"ALL"}),setTimeout(()=>{S(),a(new Error("Dice+ roll timed out (no roll-result received)"))},i)})}async function p(t,n){const e=await fetch(`${G}${t}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n??{})});if(!e.ok){const i=await e.text().catch(()=>"");throw new Error(`Calc API error ${e.status}: ${i||e.statusText}`)}return await e.json()}async function St(t){return p("/attack",t)}async function Nt(t){return p("/damage",t)}async function Mt(t){return p("/derive-attributes",t)}async function xt(t){return p("/derive-cuf",t)}async function Dt(t){return p("/skill-notation",t)}async function Pt(t){return p("/skill-mod",t)}async function Rt(t){return p("/status-deltas",t)}const rt=2,ct=[{id:"athletics",label:"Athletics",attribute:"phys"},{id:"cybernetics",label:"Cybernetics",attribute:"phys"},{id:"powerlift",label:"Powerlift",attribute:"phys"},{id:"endurance",label:"Endurance",attribute:"phys"},{id:"toughness",label:"Toughness",attribute:"phys"},{id:"balance",label:"Balance",attribute:"ref"},{id:"evade",label:"Evade",attribute:"ref"},{id:"finesse",label:"Finesse",attribute:"ref"},{id:"instinct",label:"Instinct",attribute:"ref"},{id:"stealth",label:"Stealth",attribute:"ref"},{id:"subterfuge",label:"Subterfuge",attribute:"soc"},{id:"bearing",label:"Bearing",attribute:"soc"},{id:"negotiate",label:"Negotiate",attribute:"soc"},{id:"persuade",label:"Persuade",attribute:"soc"},{id:"streetwise",label:"Streetwise",attribute:"soc"},{id:"composure",label:"Composure",attribute:"ment"},{id:"psychology",label:"Psychology",attribute:"ment"},{id:"observe",label:"Observe",attribute:"ment"},{id:"recall",label:"Recall",attribute:"ment"},{id:"willpower",label:"Willpower",attribute:"ment"}],lt={combat:[{id:"melee_weapons",label:"Melee (weapons)",attribute:"phys"},{id:"melee_unarmed",label:"Melee (unarmed)",attribute:"phys"},{id:"weapons_light",label:"Weapons (light)",attribute:"ref"},{id:"weapons_medium",label:"Weapons (medium)",attribute:"ref"},{id:"weapons_heavy",label:"Weapons (heavy)",attribute:"phys"},{id:"weapons_exotic",label:"Weapons (exotic)",attribute:"ment"},{id:"power_armour",label:"Power Armour",attribute:"phys"},{id:"explosives",label:"Explosives",attribute:"ment"},{id:"tactics",label:"Tactics",attribute:"ment"}],education:[{id:"material_sciences",label:"Material Sciences",attribute:"ment"},{id:"computers",label:"Computers",attribute:"ment"},{id:"cryptology",label:"Cryptology",attribute:"ment"},{id:"electronics",label:"Electronics",attribute:"ment"},{id:"engineering",label:"Engineering",attribute:"ment"},{id:"first_aid",label:"First Aid",attribute:"ment"},{id:"forgery",label:"Forgery",attribute:"soc"},{id:"history",label:"History",attribute:"ment"},{id:"linguistics",label:"Linguistics",attribute:"ment"},{id:"research",label:"Research",attribute:"ment"},{id:"natural_sciences",label:"Natural Sciences",attribute:"ment"}],vehicles:[{id:"gunnery",label:"Gunnery",attribute:"ref"},{id:"navigation",label:"Navigation",attribute:"ment"},{id:"piloting",label:"Piloting",attribute:"ref"},{id:"remote_operation",label:"Remote Operation",attribute:"ment"},{id:"sensors",label:"Sensors",attribute:"ment"},{id:"systems_interface",label:"Systems Interface",attribute:"ment"}]},ut={version:rt,inherent:ct,learned:lt},Ct=ut,j="whisperspace.obr.sheet/initiativeTracker",dt="whisperspace.obr.sheet/initActive",V=()=>({entries:[],updatedAt:Date.now()});function h(t){return[...t].sort((n,e)=>e.initiative!==n.initiative?e.initiative-n.initiative:(e.updatedAt??0)-(n.updatedAt??0))}async function y(){const t=await c.scene.getMetadata(),n=t==null?void 0:t[j];if(!n||typeof n!="object")return V();const i=(Array.isArray(n.entries)?n.entries:[]).filter(a=>a&&typeof a.tokenId=="string").map(a=>({tokenId:String(a.tokenId),name:typeof a.name=="string"?a.name:"Unnamed",thumbUrl:typeof a.thumbUrl=="string"?a.thumbUrl:void 0,initiative:Number.isFinite(a.initiative)?Math.trunc(a.initiative):0,surprised:typeof a.surprised=="boolean"?a.surprised:!1,updatedAt:Number.isFinite(a.updatedAt)?Math.trunc(a.updatedAt):0})),s={entries:h(i),activeTokenId:typeof n.activeTokenId=="string"?n.activeTokenId:void 0,updatedAt:Number.isFinite(n.updatedAt)?Math.trunc(n.updatedAt):Date.now()};return s.entries.length>0&&(!s.activeTokenId||!s.entries.some(a=>a.tokenId===s.activeTokenId))&&(s.activeTokenId=s.entries[0].tokenId),s}async function v(t){await c.scene.setMetadata({[j]:t})}async function A(t,n=[]){if(!n.length)return;const e=Array.from(new Set(n));try{await c.scene.items.updateItems(e,i=>{for(const s of i){const a={...s.metadata??{}};a[dt]=t?s.id===t:!1,s.metadata=a}})}catch{}}async function Ot(t){const n=await y(),e=t.updatedAt??Date.now(),i=n.entries.filter(l=>l.tokenId!==t.tokenId);i.push({tokenId:t.tokenId,name:t.name,thumbUrl:t.thumbUrl,initiative:Math.trunc(t.initiative),updatedAt:e});const s=h(i),a={entries:s,activeTokenId:n.activeTokenId,updatedAt:Date.now()};return s.length>0&&(!a.activeTokenId||!s.some(l=>l.tokenId===a.activeTokenId))&&(a.activeTokenId=s[0].tokenId),await v(a),await A(a.activeTokenId,s.map(l=>l.tokenId)),a}async function Lt(){const t=V();await v(t)}async function ft(t){const n=await y(),e=(n.entries??[]).filter(a=>a.tokenId!==t);let i=n.activeTokenId;if(i===t){const a=h(e);i=a.length?a[0].tokenId:void 0}const s={entries:e,activeTokenId:i,updatedAt:Date.now()};return await v(s),await A(s.activeTokenId,e.map(a=>a.tokenId)),s}const Ut=ft;async function Ft(t,n){const e=await y(),i=(e.entries??[]).map(a=>a.tokenId===t?{...a,surprised:!!n}:a),s={entries:h(i),activeTokenId:e.activeTokenId,updatedAt:Date.now()};return await v(s),await A(s.activeTokenId,i.map(a=>a.tokenId)),s}async function Kt(){const t=await y(),n=h(t.entries);if(n.length===0)return t;const e=t.activeTokenId?n.findIndex(f=>f.tokenId===t.activeTokenId):-1,i=e>=0?(e+1)%n.length:0,a=e>=0&&i===0?n.map(f=>({...f,surprised:!1})):n,l={entries:a,activeTokenId:a[i].tokenId,updatedAt:Date.now()};return await v(l),await A(l.activeTokenId,a.map(f=>f.tokenId)),l}function Yt(t){const n=c.scene.onMetadataChange(()=>{y().then(t)});return y().then(t),n}export{kt as A,Et as B,y as C,ft as D,bt as E,Q as F,R as M,_ as T,ot as a,At as b,Dt as c,St as d,Nt as e,Pt as f,B as g,Lt as h,Kt as i,Ft as j,Ut as k,at as l,gt as m,Rt as n,Yt as o,xt as p,it as q,_t as r,Ct as s,Mt as t,Ot as u,vt as v,wt as w,It as x,Tt as y,ht as z};
