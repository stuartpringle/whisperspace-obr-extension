import{r as it,b as Fe,s as ge,c as xt,F as gt,a as Qe,o as pt,l as ze,T as lt,d as yt,e as bt,f as kt,g as vt,h as ot,i as Ze,j as Le,k as Je,m as Ie,n as jt,u as wt,p as Ct,q as St,t as qe,v as Ue,w as et,x as Se,y as tt,z as It}from"./statusEffects-BG_oMj9Y.js";import{r as k,j as e,d as Me,e as Mt}from"./vendor_react-XzhcIodj.js";import{O as q}from"./vendor_obr-BLY5dk8V.js";import{S as U,B as R,T as I,a as _e,b as ne,c as x,d as be,I as le,C as De,R as Dt,A as Ae,e as Te,E as Re,f as Ee,g as me,h as ct,i as je,P as At,D as Be,L as at,j as Tt,M as ue,k as dt,l as Rt,m as Et,n as Nt,o as Pt,p as zt,q as Wt,r as Lt,s as Ft,t as _t,u as Bt,v as Ot,w as qt,x as Ut}from"./vendor_mui-Cp94TW_k.js";import"./vendor_zod-CxP395f9.js";import"./vendor-CPvQcOsy.js";import"./vendor_emotion-pcfylbOS.js";async function $t(){const t=await q.player.getSelection();return Array.isArray(t)?t:[]}async function Ht(){const t=await $t();return t.length>0?t[0]:null}async function $e(t){return(await q.scene.items.getItems([t])).length>0}function Gt(t){var g;const r=t.sheet,[y,h]=k.useState(0),T=k.useMemo(()=>r.attributes??{phys:0,ref:0,soc:0,ment:0},[r.attributes]);async function S(l,v){const B=Number(T[l]??0),K=Fe({netDice:y,modifier:B,label:v});await it({diceNotation:K,showResults:!0,rollTarget:"everyone"})}return e.jsxs(U,{spacing:2,children:[e.jsxs(R,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",gap:2,flexWrap:"wrap"},children:[e.jsx(I,{variant:"h6",sx:{m:0},children:"Core"}),e.jsxs(R,{sx:{display:"flex",alignItems:"center",gap:1,flexWrap:"wrap"},children:[e.jsx(I,{variant:"subtitle2",sx:{opacity:.8},children:"Attribute Roll:"}),e.jsxs(_e,{size:"small",exclusive:!0,value:y,onChange:(l,v)=>{v!==null&&h(v)},children:[e.jsx(ne,{value:-2,children:"−2"}),e.jsx(ne,{value:-1,children:"−1"}),e.jsx(ne,{value:0,children:"0"}),e.jsx(ne,{value:1,children:"+1"}),e.jsx(ne,{value:2,children:"+2"})]})]})]}),e.jsx(x,{label:"Name",size:"small",value:r.name??"",onChange:l=>t.onChange({name:l.target.value}),fullWidth:!0}),e.jsxs(R,{sx:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:1},children:[e.jsx(We,{label:"PHYS",value:T.phys,onRoll:()=>S("phys","PHYS Check")}),e.jsx(We,{label:"REF",value:T.ref,onRoll:()=>S("ref","REF Check")}),e.jsx(We,{label:"SOC",value:T.soc,onRoll:()=>S("soc","SOC Check")}),e.jsx(We,{label:"MENT",value:T.ment,onRoll:()=>S("ment","MENT Check")})]}),e.jsxs(R,{sx:{display:"grid",gridTemplateColumns:"repeat(3, 1fr)",gap:2},children:[e.jsx(x,{label:"Cool Under Fire",size:"small",value:((g=t.sheet.stress)==null?void 0:g.cuf)??0,inputProps:{readOnly:!0},fullWidth:!0}),e.jsx(x,{label:"Speed",size:"small",value:30+(T.phys??0)*5,inputProps:{readOnly:!0},fullWidth:!0}),e.jsx(x,{label:"Carrying Capacity",size:"small",value:5+(T.phys??0)*5,inputProps:{readOnly:!0},fullWidth:!0})]}),e.jsx(I,{variant:"body2",sx:{opacity:.75},children:"Attributes are derived automatically from skill ranks (¼ of total ranks under each attribute, rounded up)."})]})}function We(t){return e.jsxs(R,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(x,{label:t.label,size:"small",value:t.value,inputProps:{readOnly:!0},fullWidth:!0}),e.jsx(be,{title:"Roll with Dice+",children:e.jsx(le,{onClick:t.onRoll,"aria-label":`Roll ${t.label}`,children:e.jsx(De,{})})})]})}function Xe(){const t=new Map;return Object.keys(ge.learned).forEach(r=>{(ge.learned[r]??[]).forEach(y=>t.set(y.id,{focus:r}))}),t}function ut(t){var l,v;const r=String(t.skillId??""),y=((l=t.sheet.skills)==null?void 0:l[r])??0,h=((v=t.skillMods)==null?void 0:v[r])??0;if(y>0)return y+h;const T=t.sheet.learningFocus??"combat",S=t.learnedInfoById.get(r);return(S&&S.focus===T?0:-1)+h}const Yt=["phys","ref","soc","ment"],He={phys:"PHYSIQUE",ref:"REFLEX",soc:"SOCIAL",ment:"MENTAL"},Ge={combat:"Combat",education:"Education",vehicles:"Vehicles"},st={combat:"Combat Focus",education:"Education Focus",vehicles:"Vehicles Focus"};function Ye(t){const r=mt(t,0,5);return r*(r+1)/2}function Kt(t){const[r,y]=k.useState(""),[h,T]=k.useState(0),[S,g]=k.useState(!0),[l,v]=k.useState(!1),[B,K]=k.useState(""),F=t.sheet.skills??{},N=t.sheet.learningFocus??"combat",ae=Number(t.sheet.skillPoints??0);k.useEffect(()=>{let d=!1;return(async()=>{const f=await xt();d||(g(f),v(!0))})().catch(()=>{d||(g(!1),v(!0))}),()=>{d=!0}},[]);const ie=k.useMemo(()=>Xe(),[]);function oe(d){const f=ie.get(d.id);return f?f.focus===N?5:2:5}function se(d){var Z;const f=F[d.id]??0,_=((Z=t.skillMods)==null?void 0:Z[d.id])??0;if(f>0)return f+_;const V=ie.get(d.id);return V&&V.focus===N?0+_:-1+_}const u=k.useMemo(()=>{let d=0;for(const f of Object.values(F))d+=Ye(f??0);return d},[F]),a=Math.max(0,ae-u),s=d=>{const f=Math.max(0,Math.trunc(Number(B)));if(!f)return;const _=ae+d*f,V=Math.max(u,_);t.onMetaChange({skillPoints:V}),K("")};function A(d){t.onChange(d)}function M(d,f){const _=F[d.id]??0,V=oe(d),Z=mt(f,0,V);if(Z===_||Ye(Z)-Ye(_)>a)return;const he={...F};Z===0?delete he[d.id]:he[d.id]=Z,A(he)}async function P(d){const f=Fe({netDice:h,modifier:se(d),label:d.label});try{await it({diceNotation:f,showResults:!0,rollTarget:"everyone"})}catch(_){console.error("Dice+ roll request failed:",_)}}const m=k.useMemo(()=>{const d=Object.values(ge.learned).flat();return[...ge.inherent,...d]},[]),L=k.useMemo(()=>{const d=r.trim().toLowerCase();return d?m.filter(f=>f.label.toLowerCase().includes(d)||f.id.toLowerCase().includes(d)):m},[m,r]),X=k.useMemo(()=>Jt(ge.inherent),[]),j=k.useMemo(()=>ge.learned,[]),G=r.trim().length>0,te=e.jsxs(R,{sx:{display:"flex",alignItems:"center",gap:2,flexWrap:"wrap"},children:[e.jsx(I,{variant:"subtitle2",sx:{opacity:.8},children:"Learning Focus:"}),Object.keys(st).map(d=>e.jsxs(R,{sx:{display:"flex",alignItems:"center",gap:.5,cursor:"pointer"},onClick:()=>t.onMetaChange({learningFocus:d}),children:[e.jsx(Dt,{checked:N===d,value:d,size:"small"}),e.jsx(I,{variant:"body2",children:Ge[d]})]},d))]}),J=e.jsx(R,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",gap:2,flexWrap:"wrap"},children:e.jsxs(R,{sx:{display:"flex",alignItems:"center",gap:1,flexWrap:"wrap"},children:[e.jsxs(I,{variant:"subtitle2",sx:{minWidth:170},children:["Skill Points: ",a," ",e.jsxs("span",{style:{opacity:.75},children:["(Total: ",ae,")"]})]}),e.jsx(me,{size:"small",variant:"outlined",onClick:()=>s(1),disabled:!Number.isFinite(Number(B))||Math.trunc(Number(B))<=0,children:"+"}),e.jsx(x,{label:"SP",size:"small",type:"number",value:B,onChange:d=>K(d.target.value),sx:{width:110}}),e.jsx(me,{size:"small",variant:"outlined",onClick:()=>s(-1),disabled:!Number.isFinite(Number(B))||Math.trunc(Number(B))<=0,children:"-"}),e.jsx(I,{variant:"subtitle2",sx:{opacity:.8},children:"Roll"}),e.jsxs(_e,{size:"small",exclusive:!0,value:h,onChange:(d,f)=>{f!==null&&T(f)},"aria-label":"Bonus / Penalty dice",children:[e.jsx(ne,{value:-2,children:"−2"}),e.jsx(ne,{value:-1,children:"−1"}),e.jsx(ne,{value:0,children:"0"}),e.jsx(ne,{value:1,children:"+1"}),e.jsx(ne,{value:2,children:"+2"})]}),l&&!S&&e.jsx(I,{variant:"caption",sx:{opacity:.8},children:"(Dice+ not detected)"})]})});return e.jsxs(U,{spacing:2,children:[te,e.jsx(x,{label:"Search skills",value:r,onChange:d=>y(d.target.value),placeholder:"stealth, weapons, navigation…",fullWidth:!0}),J,G?e.jsx(U,{spacing:1,children:L.map(d=>{const f=ie.get(d.id),_=f?Ge[f.focus]:He[d.attribute];return e.jsx(Ke,{skill:d,rank:F[d.id]??0,modifier:se(d),maxRank:oe(d),onRank:V=>M(d,V),rightTag:_,canRoll:S,onRoll:()=>P(d)},d.id)})}):e.jsxs(e.Fragment,{children:[e.jsx(I,{variant:"subtitle1",children:"Inherent Skills"}),Yt.map(d=>e.jsxs(Ae,{defaultExpanded:!0,children:[e.jsx(Te,{expandIcon:e.jsx(Re,{}),children:e.jsx(I,{fontWeight:700,children:He[d]})}),e.jsx(Ee,{children:e.jsx(U,{spacing:1,children:(X[d]??[]).map(f=>e.jsx(Ke,{skill:f,rank:F[f.id]??0,modifier:se(f),maxRank:oe(f),onRank:_=>M(f,_),rightTag:He[f.attribute],canRoll:S,onRoll:()=>P(f)},f.id))})})]},d)),e.jsx(I,{variant:"subtitle1",sx:{mt:1},children:"Learned Skills"}),Object.keys(j).map(d=>e.jsxs(Ae,{defaultExpanded:!0,children:[e.jsx(Te,{expandIcon:e.jsx(Re,{}),children:e.jsx(I,{fontWeight:700,children:st[d]})}),e.jsx(Ee,{children:e.jsx(U,{spacing:1,children:(j[d]??[]).map(f=>e.jsx(Ke,{skill:f,rank:F[f.id]??0,modifier:se(f),maxRank:oe(f),onRank:_=>M(f,_),rightTag:Ge[d],canRoll:S,onRoll:()=>P(f)},f.id))})})]},d))]})]})}function Ke(t){const r=t.rank<t.maxRank,y=t.rank>0;return e.jsxs(R,{sx:{display:"grid",gridTemplateColumns:"1fr auto auto auto",gap:1,alignItems:"center",border:"1px solid",borderColor:"divider",borderRadius:2,px:1.25,py:1},children:[e.jsxs(R,{sx:{minWidth:0},children:[e.jsx(I,{fontWeight:600,noWrap:!0,children:t.skill.label}),e.jsx(I,{variant:"caption",sx:{opacity:.7},noWrap:!0,children:t.rightTag??""})]}),e.jsxs(R,{sx:{width:46,textAlign:"center"},children:[e.jsx(I,{variant:"caption",sx:{opacity:.7,lineHeight:1},children:"Mod"}),e.jsx(I,{sx:{fontWeight:700,lineHeight:1.2},children:t.modifier>=0?`+${t.modifier}`:`${t.modifier}`})]}),e.jsxs(R,{sx:{width:40,textAlign:"center"},children:[e.jsx(I,{variant:"caption",sx:{opacity:.7,lineHeight:1},children:"Rank"}),e.jsx(I,{sx:{fontWeight:700,lineHeight:1.2},children:t.rank})]}),e.jsxs(R,{sx:{display:"flex",gap:.5,alignItems:"center",justifyContent:"flex-end"},children:[e.jsx(le,{size:"small",onClick:()=>t.onRank(t.rank-1),"aria-label":"Decrease rank",disabled:!y,children:e.jsx(ct,{fontSize:"small"})}),e.jsx(le,{size:"small",onClick:()=>t.onRank(t.rank+1),"aria-label":"Increase rank",disabled:!r,children:e.jsx(je,{fontSize:"small"})}),e.jsx(R,{sx:{width:6}}),e.jsx(be,{title:t.canRoll?"Roll with Dice+":"Dice+ not detected",children:e.jsx("span",{children:e.jsx(le,{size:"small",onClick:t.onRoll,"aria-label":`Roll ${t.skill.label}`,disabled:!t.canRoll,children:e.jsx(De,{fontSize:"small"})})})})]})]})}function Jt(t){return t.reduce((r,y)=>{var h;return(r[h=y.attribute]??(r[h]=[])).push(y),r},{})}function mt(t,r,y){const h=Number.isFinite(t)?Math.trunc(t):r;return Math.max(r,Math.min(y,h))}function Vt(t){const r=t.sheet.feats??[];function y(){t.onChange([...r,{name:"New Feat",description:"",statusEffects:""}])}function h(S,g){const l=[...r];l[S]={...l[S],...g},gt.safeParse(l[S]),t.onChange(l)}function T(S){const g=[...r];g.splice(S,1),t.onChange(g)}return e.jsxs(U,{spacing:2,children:[e.jsxs(U,{direction:"row",justifyContent:"space-between",alignItems:"center",children:[e.jsx(I,{variant:"h6",children:"Feats"}),e.jsx(me,{variant:"contained",startIcon:e.jsx(je,{}),onClick:y,children:"Add Feat"})]}),r.length===0?e.jsx(I,{variant:"body2",sx:{opacity:.75},children:"No feats yet."}):e.jsx(U,{spacing:2,children:r.map((S,g)=>e.jsx(At,{sx:{p:2},children:e.jsxs(U,{spacing:1.5,children:[e.jsxs(U,{direction:"row",spacing:1,alignItems:"center",children:[e.jsx(x,{label:"Feat Name",fullWidth:!0,value:S.name,onChange:l=>h(g,{name:l.target.value})}),e.jsx(le,{"aria-label":"Remove feat",onClick:()=>T(g),children:e.jsx(Be,{})})]}),e.jsx(x,{label:"Description",fullWidth:!0,multiline:!0,minRows:4,value:S.description,onChange:l=>h(g,{description:l.target.value})}),e.jsx(x,{label:"Status Effects",fullWidth:!0,helperText:'Comma-separated, e.g. "carrying_capacity+5"',value:S.statusEffects??"",onChange:l=>h(g,{statusEffects:l.target.value})})]})},`${S.name}-${g}`))})]})}const Qt=[{id:"pistol",name:"Pistol",skillId:"weapons_light",useDC:7,damage:2,range:"Med",ammo:10,bulk:1,cost:500},{id:"smart_pistol",name:"SMART Pistol",skillId:"weapons_light",useDC:9,damage:4,range:"Med",ammo:6,bulk:1,keywords:["Smart-Linked"],cost:900},{id:"toxic_spike",name:"Toxic Spike",skillId:"weapons_light",useDC:10,damage:3,range:"Short",ammo:1,bulk:1,keywords:["Toxin (Prax)","Concealable"],cost:750},{id:"smg",name:"SMG",skillId:"weapons_medium",useDC:6,damage:3,range:"Med",ammo:8,bulk:2,keywords:["Bullet Spray"],cost:600},{id:"photon_rifle",name:"Photon Rifle",skillId:"weapons_medium",useDC:8,damage:6,range:"Long",ammo:6,bulk:3,keywords:["Two-Handed"],cost:5e3},{id:"rifle",name:"Rifle",skillId:"weapons_medium",useDC:8,damage:4,range:"Long",ammo:8,bulk:2,keywords:["Two-Handed","Piercing 1"],cost:1e3},{id:"shotgun",name:"Shotgun",skillId:"weapons_medium",useDC:8,damage:4,range:"Short",ammo:4,bulk:3,req:"PHYS 1",keywords:["Point Blank","Shredding 1"],cost:800},{id:"gauss_cannon",name:"Gauss Cannon",skillId:"weapons_heavy",useDC:7,damage:4,range:"Med",ammo:20,bulk:4,req:"PHYS 3",keywords:["Bullet Spray"],cost:900},{id:"grenade_launcher",name:"Grenade Launcher",skillId:"weapons_heavy",useDC:8,damage:3,range:"Med",ammo:1,bulk:3,req:"PHYS 2",keywords:["Area (near)","Two-Handed","Slow Load","Grenade"],cost:2e3},{id:"magneton_cannon",name:"Magneton Cannon",skillId:"weapons_exotic",useDC:5,damage:2,range:"Short",ammo:5,bulk:2,req:"PHYS 1",keywords:["Area (melee)","Slow Load","Shredding 3"],cost:8e3},{id:"tesla_rifle",name:"Tesla Rifle",skillId:"weapons_exotic",useDC:8,damage:5,range:"Med",ammo:6,bulk:2,keywords:["Two-Handed","Stun 2"],cost:6e3},{id:"stun_baton",name:"Stun Baton",skillId:"melee_weapons",useDC:6,damage:0,range:"Melee",bulk:1,keywords:["Stun 1"],cost:450},{id:"switchblade",name:"Switchblade",skillId:"melee_weapons",useDC:9,damage:2,range:"Melee",bulk:1,keywords:["Concealable","Thrown"],cost:150},{id:"fusion_blade",name:"Fusion Blade",skillId:"melee_weapons",useDC:8,damage:3,range:"Melee",bulk:2,req:"REF 2",keywords:["Piercing 2"],cost:1200},{id:"rocket_maul",name:"Rocket Maul",skillId:"melee_weapons",useDC:10,damage:6,range:"Melee",ammo:2,bulk:3,req:"PHYS 3",keywords:["Two-Handed"],cost:2500}],Xt={weapons:Qt},nt=Xt.weapons??[],Zt=[{id:"scrap_armour",name:"Scrap Armour",protection:1,durability:2,bulk:2,special:"Cannot be repaired",cost:500},{id:"flak_jacket",name:"Flak Jacket",protection:1,durability:4,bulk:1,cost:1250},{id:"kevlar_clothing",name:"Kevlar Clothing",protection:1,durability:3,bulk:1,special:"Appears to be normal clothing",cost:1500},{id:"streetweave_jacket",name:"Streetweave Jacket",protection:1,durability:5,bulk:1,special:"+1 to Stealth",cost:2500},{id:"milsec_bodyplate",name:"MilSec Bodyplate",protection:2,durability:6,bulk:2,cost:5e3},{id:"breaching_plate",name:"Breaching plate",protection:2,durability:4,bulk:3,req:"PHYS 2",special:"Frontal Shielding 1",cost:8500},{id:"heavy_bodyplate",name:"Heavy Bodyplate",protection:3,durability:8,bulk:4,req:"PHYS 3",special:"+1 penalty die to Stealth",cost:1e4},{id:"basic_power_armour",name:"Basic Power Armour",protection:4,durability:14,bulk:10,req:"Power Armour 1",special:`Requires Power Armour (DC5) check to activate. Failure: become Immobile; gain +1 penalty die to all PHYS and REF based checks. When activated, reduces its own bulk to 1 and grants +1 bonus die to all PHYS based checks.
`,cost:4e4}],ea={armor:Zt},rt=ea.armor??[],Ve="whisperspace.obr.sheet/combat-log";function ta(t){return t>=9?4:t>=7?3:t>=4?2:0}async function aa(t){const r=Number.isFinite(t.useDC)?Math.trunc(t.useDC):Math.trunc(t.weapon.useDC),y=t.weapon.name||"Attack",h=Fe({netDice:t.netDice,modifier:t.modifier,label:y}),T=await Qe({diceNotation:h,rollTarget:t.rollTarget??"everyone",showResults:t.showResults??!0}),S=T-r,g=T>=r,l=g?ta(S):0,v=g&&l>0,B=Math.trunc(t.weapon.damage??0),K=g?B+l:0,F=v?1:0;let N;g?v?N=`Extreme success - crit! ${y} rolled ${T} vs DC ${r}. Damage: ${B}+${l}=${K}. (+1 Stress)`:N=`Hit. ${y} rolled ${T} vs DC ${r}. Damage: ${B}.`:N=`Miss. ${y} rolled ${T} vs DC ${r}.`,t.prefix&&(N=`${t.prefix} ${N}`);const ae={text:N,ts:Date.now(),kind:"attack",attackerName:t.attackerName,weaponName:y,outcome:{total:T,useDC:r,hit:g,isCrit:v,baseDamage:B,totalDamage:K,stressDelta:F}};return q.broadcast.sendMessage(Ve,ae,{destination:"ALL"}),{total:T,useDC:r,margin:S,hit:g,isCrit:v,critExtra:l,baseDamage:B,totalDamage:K,stressDelta:F,message:N}}const ht=aa;function ft(t){var X,j;const r=Number.isFinite(t.incomingDamage)?Math.max(0,Math.trunc(t.incomingDamage)):0;if(r<=0&&!(t.stressDelta&&t.stressDelta>0))return{sheet:t.sheet,stressDelta:0};const y=!!t.unmitigated,h=t.sheet.armor,T=(((X=h==null?void 0:h.durability)==null?void 0:X.current)??0)<=0,S=y||T?0:(h==null?void 0:h.protection)??0,g=Math.max(0,r-S),l=t.sheet.wounds??{light:0,moderate:0,heavy:0};let v=l.light??0,B=l.moderate??0,K=l.heavy??0,F=g,N=0,ae=0,ie=0;const se=Math.min(F,Math.max(0,4-v));v+=se,F-=se,N=se;const a=Math.min(F,Math.max(0,2-B));B+=a,F-=a,ae=a;const A=Math.min(F,Math.max(0,1-K));K+=A,F-=A,ie=A;const M={light:v,moderate:B,heavy:K};let P=0;ie>0?P=4:ae>0?P=2:N>0&&(P=1),t.stressDelta&&t.stressDelta>0&&(P+=Math.trunc(t.stressDelta));let m=h;!y&&!T&&g>0&&(h!=null&&h.durability)&&(m={...h,durability:{...h.durability,current:Math.max(0,Math.trunc((h.durability.current??0)-1))}});const L=Math.max(0,Math.trunc((((j=t.sheet.stress)==null?void 0:j.current)??0)+P));return{sheet:{...t.sheet,wounds:M,armor:m,stress:{...t.sheet.stress??{current:0,cuf:0,cufLoss:0},current:L}},stressDelta:P}}function ke(t){var h;if(!t)return 0;const r=(h=t.keywordParams)==null?void 0:h.ammoMax,y=typeof r=="number"?r:typeof r=="string"?Number(r):void 0;return Number.isFinite(y)?Number(y):0}function sa(t){var te,J,d,f,_,V,Z,$,he,ve,Oe,pe;const r=t.sheet,[y,h]=k.useState(0),[T,S]=k.useState(null),[g,l]=k.useState(""),[v,B]=k.useState(!1),K=(t.combatLog??[]).slice(-3).reverse(),F=k.useMemo(()=>Xe(),[]),N=k.useMemo(()=>{const n=Object.values(ge.learned).flat();return[...ge.inherent,...n]},[]),ae=new Set(["melee_weapons","melee_unarmed","weapons_light","weapons_medium","weapons_heavy","weapons_exotic","explosives"]),ie=N.filter(n=>ae.has(n.id));k.useMemo(()=>[...N].sort((n,c)=>n.label.localeCompare(c.label)),[N]);function oe(){var Q;const n=Number(g),c=Number.isFinite(n)?Math.max(0,Math.trunc(n)):0;if(c<=0)return;const b=ft({sheet:t.sheet,incomingDamage:c,unmitigated:v});t.onChange({wounds:b.sheet.wounds,armor:b.sheet.armor,stress:b.sheet.stress}),b.stressDelta>0&&t.onApplyStress&&t.onApplyStress(((Q=b.sheet.stress)==null?void 0:Q.current)??0),l("")}function se(n){return ut({learnedInfoById:F,sheet:r,skillId:n,skillMods:t.skillMods})}function u(n,c){const b=[...r.weapons??[]],Q=b[n];if(c.ammo!==void 0&&!ke(Q)&&c.ammo>0){const z={...Q.keywordParams??{},ammoMax:c.ammo};b[n]={...Q,...c,keywordParams:z},t.onChange({weapons:b});return}b[n]={...Q,...c},t.onChange({weapons:b})}function a(n,c){if(n===null||n===c)return;const b=t.sheet.weapons??[];if(n<0||n>=b.length||c<0||c>=b.length)return;const Q=[...b],[ye]=Q.splice(n,1);Q.splice(c,0,ye),t.onChange({weapons:Q}),S(c)}function s(n){const c=nt.find(Q=>Q.id===n);if(!c)return;const b=[...r.weapons??[]];b.push({name:c.name,skillId:c.skillId,useDC:c.useDC,damage:c.damage,range:c.range,ammo:c.ammo,bulk:c.bulk,req:c.req,cost:c.cost,keywords:[...c.keywords??[]],keywordParams:{ammoMax:c.ammo??0,...c.keywordParams??{}}}),t.onChange({weapons:b})}function A(){const n=[...r.weapons??[]];n.push({name:"New Weapon",skillId:"weapons_medium",useDC:8,damage:3,range:"Med",ammo:0,bulk:1,req:"",cost:0,keywords:[],keywordParams:{ammoMax:0}}),t.onChange({weapons:n})}function M(n){const c=[...r.weapons??[]];c.splice(n,1),t.onChange({weapons:c})}async function P(n,c){const b=ke(c),Q=Number.isFinite(c.ammo)?Number(c.ammo):0;if(b>0&&Q<=0){q.notification.show("Out of ammo. Reload first.","WARNING");return}const ye=se(c.skillId);await ht({weapon:c,useDC:Number.isFinite(c.useDC)?Number(c.useDC):0,netDice:y,modifier:ye,attackerName:t.sheet.name,rollTarget:"everyone",showResults:!0}),b>0&&u(n,{ammo:Math.max(0,Q-1)})}const[m,L]=k.useState(""),[X,j]=k.useState("");function G(n){const c=rt.find(b=>b.id===n);c&&t.onChange({armor:{name:c.name,keywords:[...c.keywords??[]],keywordParams:{...c.keywordParams??{}},protection:c.protection,durability:{current:c.durability,max:c.durability},bulk:c.bulk,req:c.req,cost:c.cost,special:c.special}})}return e.jsxs(U,{spacing:2,children:[e.jsx(R,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",gap:2,flexWrap:"wrap"},children:e.jsx(I,{variant:"h6",sx:{m:0},children:"Combat"})}),e.jsxs(R,{sx:{display:"flex",alignItems:"center",gap:1,flexWrap:"wrap"},children:[e.jsx(I,{variant:"subtitle2",sx:{opacity:.8},children:"Take Damage:"}),e.jsx(x,{size:"small",type:"number",inputProps:{min:0},value:g,onChange:n=>l(n.target.value),sx:{width:90}}),e.jsx(ne,{size:"small",value:"unmitigated",selected:v,onChange:()=>B(n=>!n),children:"Unmitigated"}),e.jsx(me,{size:"small",variant:"outlined",onClick:oe,children:"Apply"})]}),e.jsxs(R,{sx:{display:"flex",alignItems:"center",gap:1,flexWrap:"wrap"},children:[e.jsx(I,{variant:"subtitle2",sx:{opacity:.8},children:"Attack Roll:"}),e.jsxs(_e,{size:"small",exclusive:!0,value:y,onChange:(n,c)=>{c!==null&&h(c)},children:[e.jsx(ne,{value:-2,children:"−2"}),e.jsx(ne,{value:-1,children:"−1"}),e.jsx(ne,{value:0,children:"0"}),e.jsx(ne,{value:1,children:"+1"}),e.jsx(ne,{value:2,children:"+2"})]})]}),e.jsxs(R,{sx:{border:"1px solid",borderColor:"divider",borderRadius:2,p:1.25},children:[e.jsx(I,{variant:"subtitle2",sx:{opacity:.8,mb:.5},children:"Combat Log"}),K.length===0?e.jsx(I,{variant:"body2",sx:{opacity:.7},children:"No recent rolls."}):e.jsx(U,{spacing:.75,children:K.map(n=>{var w,C,E,W,H;const c=!!((w=n.outcome)!=null&&w.hit)&&((((C=n.outcome)==null?void 0:C.totalDamage)??0)>0||(((E=n.outcome)==null?void 0:E.stressDelta)??0)>0)&&!!t.onApplyCombatLog,b=c&&(((W=n.outcome)==null?void 0:W.totalDamage)??0)>0,Q=c&&(((H=n.outcome)==null?void 0:H.stressDelta)??0)>0,ye=b&&Q,z=n.outcome,Ne=z!=null&&z.isCrit?"Extreme success - crit!":z!=null&&z.hit?"Hit":"Miss",Pe=z!=null&&z.isCrit?"#5b6bff":z!=null&&z.hit?"#26a269":"#d64040",Ce="#e55353",o="#8b5cf6",i=n.attackerName??"Unknown",p=n.weaponName??"Attack";return e.jsxs(R,{sx:{display:"flex",alignItems:"center",gap:1,flexWrap:"wrap"},children:[e.jsx(I,{variant:"body2",sx:{flex:"1 1 260px"},children:n.kind==="effect"?e.jsxs(e.Fragment,{children:[e.jsx("strong",{children:n.targetName??"Target"})," ",(n.damageApplied??0)>0&&e.jsxs(e.Fragment,{children:["took"," ",e.jsx("strong",{style:{color:Ce},children:n.damageApplied})," ","damage"]}),(n.damageApplied??0)>0&&(n.stressApplied??0)>0&&" and ",(n.damageApplied??0)<=0&&(n.stressApplied??0)>0&&"took ",(n.stressApplied??0)>0&&e.jsxs(e.Fragment,{children:[e.jsx("strong",{style:{color:o},children:n.stressApplied})," ","stress"]}),"."]}):e.jsxs(e.Fragment,{children:[e.jsx("strong",{children:i}),": ",e.jsx("strong",{children:p})," rolled"," ",(z==null?void 0:z.total)??0," vs DC ",(z==null?void 0:z.useDC)??0,"."," ",e.jsx("strong",{style:{color:Pe},children:Ne}),(z==null?void 0:z.hit)&&e.jsxs(e.Fragment,{children:[". Damage:"," ",e.jsx("strong",{style:{color:Ce},children:(z==null?void 0:z.totalDamage)??0}),z!=null&&z.stressDelta?e.jsxs(e.Fragment,{children:[" "," (+"," ",e.jsx("strong",{style:{color:o},children:z.stressDelta})," ","Stress)"]}):null]}),"."]})}),b&&e.jsx(me,{size:"small",variant:"outlined",startIcon:e.jsx(at,{fontSize:"small"}),onClick:()=>{var D,O;return(O=t.onApplyCombatLog)==null?void 0:O.call(t,{...n,kind:"attack",damageApplied:((D=n.outcome)==null?void 0:D.totalDamage)??0,stressApplied:0})},children:"Apply Damage"}),Q&&e.jsx(me,{size:"small",variant:"outlined",startIcon:e.jsx(Tt,{fontSize:"small"}),onClick:()=>{var D,O;return(O=t.onApplyCombatLog)==null?void 0:O.call(t,{...n,kind:"attack",damageApplied:0,stressApplied:((D=n.outcome)==null?void 0:D.stressDelta)??0})},children:"Apply Stress"}),ye&&e.jsx(me,{size:"small",variant:"outlined",startIcon:e.jsx(at,{fontSize:"small"}),onClick:()=>{var D,O,ee;return(ee=t.onApplyCombatLog)==null?void 0:ee.call(t,{...n,kind:"attack",damageApplied:((D=n.outcome)==null?void 0:D.totalDamage)??0,stressApplied:((O=n.outcome)==null?void 0:O.stressDelta)??0})},children:"Apply Both"})]},n.ts)})})]}),e.jsxs(Ae,{defaultExpanded:!0,children:[e.jsx(Te,{expandIcon:e.jsx(Re,{}),children:e.jsx(I,{fontWeight:700,children:"Weapons"})}),e.jsx(Ee,{children:e.jsxs(U,{spacing:1.5,children:[e.jsxs(R,{sx:{display:"flex",gap:1,alignItems:"center",flexWrap:"wrap"},children:[e.jsxs(x,{label:"Add prefab weapon",size:"small",select:!0,value:m,onChange:n=>L(n.target.value),sx:{minWidth:240},children:[e.jsx(ue,{value:"",children:"— choose —"}),nt.map(n=>e.jsx(ue,{value:n.id,children:n.name},n.id))]}),e.jsx(le,{color:"primary",onClick:()=>s(m),"aria-label":"Add prefab weapon",disabled:!m,children:e.jsx(je,{})}),e.jsx(R,{sx:{flex:1}}),e.jsx(le,{color:"primary",onClick:A,"aria-label":"Add custom weapon",children:e.jsx(je,{})}),e.jsx(I,{variant:"body2",sx:{opacity:.75},children:"Add custom weapon"})]}),(r.weapons??[]).length===0?e.jsx(I,{sx:{opacity:.75},children:"No weapons yet."}):(r.weapons??[]).map((n,c)=>e.jsxs(R,{draggable:!0,onDragStart:()=>S(c),onDragEnd:()=>S(null),onDragOver:b=>{b.preventDefault()},onDrop:b=>{b.preventDefault(),a(T,c)},sx:{border:"1px solid",borderColor:"divider",borderRadius:2,p:1.25,cursor:"grab",opacity:T===c?.85:1,display:"grid",gap:1.25},children:[e.jsxs(R,{sx:{display:"flex",gap:1,alignItems:"center"},children:[e.jsx(x,{label:"Name",size:"small",value:n.name,onChange:b=>u(c,{name:b.target.value}),fullWidth:!0}),e.jsx(be,{title:"Roll attack with Dice+",children:e.jsx(le,{onClick:()=>P(c,n),"aria-label":`Roll attack for ${n.name}`,children:e.jsx(De,{})})}),e.jsx(le,{onClick:()=>M(c),"aria-label":"Remove weapon",children:e.jsx(Be,{})})]}),e.jsxs(R,{sx:{display:"grid",gridTemplateColumns:"1fr 1fr 1fr 1fr",gap:1},children:[e.jsx(x,{label:"Skill",size:"small",select:!0,value:n.skillId,onChange:b=>u(c,{skillId:b.target.value}),children:ie.map(b=>e.jsx(ue,{value:b.id,children:b.label},b.id))}),e.jsx(x,{label:"Use DC",size:"small",type:"number",value:n.useDC,onChange:b=>u(c,{useDC:Number(b.target.value)})}),e.jsx(x,{label:"Damage",size:"small",type:"number",value:n.damage,onChange:b=>u(c,{damage:Number(b.target.value)})}),e.jsx(x,{label:"Range",size:"small",value:n.range??"",onChange:b=>u(c,{range:b.target.value}),placeholder:"Melee / Short / Med / Long"}),e.jsxs(R,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(x,{label:"Ammo",size:"small",type:"number",value:n.ammo??0,onChange:b=>u(c,{ammo:Number(b.target.value)}),sx:{width:110}}),e.jsxs(I,{variant:"body2",sx:{opacity:.8},children:["/ ",ke(n)||0]}),e.jsx(be,{title:"Reload",children:e.jsx("span",{children:e.jsx(le,{size:"small",onClick:()=>u(c,{ammo:ke(n)||0}),disabled:(ke(n)||0)<=0,children:e.jsx(dt,{fontSize:"small"})})})})]}),e.jsx(x,{label:"Bulk",size:"small",type:"number",value:n.bulk??0,onChange:b=>u(c,{bulk:Number(b.target.value)})}),e.jsx(x,{label:"Req.",size:"small",value:n.req??"",onChange:b=>u(c,{req:b.target.value}),placeholder:"PHYS 1 / REF 2 / etc"}),e.jsx(x,{label:"Keywords (comma)",size:"small",value:(n.keywords??[]).join(", "),onChange:b=>u(c,{keywords:b.target.value.split(",").map(Q=>Q.trim()).filter(Boolean)}),placeholder:"Two-Handed, Piercing 1",sx:{gridColumn:"1 / -1"}})]})]},n.id??`${n.name}-${c}`))]})})]}),e.jsxs(Ae,{defaultExpanded:!0,children:[e.jsx(Te,{expandIcon:e.jsx(Re,{}),children:e.jsx(I,{fontWeight:700,children:"Armor"})}),e.jsx(Ee,{children:e.jsxs(U,{spacing:1.5,children:[e.jsxs(R,{sx:{display:"flex",gap:1,alignItems:"center",flexWrap:"wrap"},children:[e.jsxs(x,{label:"Set prefab armor",size:"small",select:!0,value:X,onChange:n=>j(n.target.value),sx:{minWidth:240},children:[e.jsx(ue,{value:"",children:"— choose —"}),rt.map(n=>e.jsx(ue,{value:n.id,children:n.name},n.id))]}),e.jsx(le,{color:"primary",onClick:()=>G(X),"aria-label":"Set prefab armor",disabled:!X,children:e.jsx(je,{})})]}),e.jsxs(R,{sx:{border:"1px solid",borderColor:"divider",borderRadius:2,p:1.25},children:[e.jsxs(R,{sx:{display:"grid",gridTemplateColumns:"2fr 1fr 1fr 1fr",gap:1},children:[e.jsx(x,{label:"Name",size:"small",value:((te=r.armor)==null?void 0:te.name)??"",onChange:n=>t.onChange({armor:{...r.armor??{durability:{current:0,max:0},protection:0,keywords:[],keywordParams:{ammoMax:0}},name:n.target.value}})}),e.jsx(x,{label:"Protection",size:"small",type:"number",value:((J=r.armor)==null?void 0:J.protection)??0,onChange:n=>t.onChange({armor:{...r.armor??{name:"",durability:{current:0,max:0},keywords:[],keywordParams:{}},protection:Number(n.target.value)}})}),e.jsx(x,{label:"Durability (cur)",size:"small",type:"number",value:((d=r.armor)==null?void 0:d.durability.current)??0,onChange:n=>{var c;return t.onChange({armor:{...r.armor??{name:"",durability:{current:0,max:0},protection:0,keywords:[],keywordParams:{}},durability:{...((c=r.armor)==null?void 0:c.durability)??{current:0,max:0},current:Number(n.target.value)}}})}}),e.jsx(x,{label:"Durability (max)",size:"small",type:"number",value:((f=r.armor)==null?void 0:f.durability.max)??0,onChange:n=>{var c;return t.onChange({armor:{...r.armor??{name:"",durability:{current:0,max:0},protection:0,keywords:[],keywordParams:{}},durability:{...((c=r.armor)==null?void 0:c.durability)??{current:0,max:0},max:Number(n.target.value)}}})}})]}),(((V=(_=r.armor)==null?void 0:_.durability)==null?void 0:V.max)??0)>0&&((($=(Z=r.armor)==null?void 0:Z.durability)==null?void 0:$.current)??0)<=0&&e.jsx(I,{sx:{mt:1},color:"error",variant:"body2",children:"Broken: armor provides no Protection until repaired."}),e.jsxs(R,{sx:{display:"grid",gridTemplateColumns:"1fr 1fr 1fr 2fr",gap:1,mt:1},children:[e.jsx(x,{label:"Bulk",size:"small",type:"number",value:((he=r.armor)==null?void 0:he.bulk)??0,onChange:n=>t.onChange({armor:{...r.armor??{name:"",durability:{current:0,max:0},protection:0,keywords:[],keywordParams:{}},bulk:Number(n.target.value)}})}),e.jsx(x,{label:"Req.",size:"small",value:((ve=r.armor)==null?void 0:ve.req)??"",onChange:n=>t.onChange({armor:{...r.armor??{name:"",durability:{current:0,max:0},protection:0,keywords:[],keywordParams:{}},req:n.target.value}})}),e.jsx(x,{label:"Special",size:"small",value:((Oe=r.armor)==null?void 0:Oe.special)??"",onChange:n=>t.onChange({armor:{...r.armor??{name:"",durability:{current:0,max:0},protection:0,keywords:[],keywordParams:{}},special:n.target.value}})})]}),e.jsx(R,{sx:{mt:1},children:e.jsx(x,{label:"Keywords (comma)",size:"small",fullWidth:!0,value:(((pe=r.armor)==null?void 0:pe.keywords)??[]).join(", "),onChange:n=>t.onChange({armor:{...r.armor??{name:"",durability:{current:0,max:0},protection:0,keywords:[],keywordParams:{}},keywords:n.target.value.split(",").map(c=>c.trim()).filter(Boolean)}}),placeholder:"Frontal Shielding 1"})})]})]})})]})]})}const na=[{name:"Flashbang Grenade",effect:"Applies Stun 1 to everyone within near range, Thrown",uses:"1 use",bulk:1,cost:200},{name:"Frag Grenade",effect:"Deals 2 area (near range) damage (DC8 to Evade half), Thrown",uses:"1 use",bulk:1,cost:250},{name:"EMP Grenade",effect:"Applies EMP 2 to everything within range, Thrown",uses:"1 use",bulk:1,cost:300},{name:"Combat Stim Injector",effect:"Gain +1 action & -1 Stress; take 1 wound after effect ends",uses:"1 use",bulk:1,cost:200},{name:"Basic Medkit",effect:"Right tool for the job: First Aid checks",uses:"3 uses",bulk:1,cost:350},{name:"Multitool",effect:"Allows engineering checks to repair, bypass, scrap, etc.",uses:"Permanent",bulk:1,cost:750},{name:"Repair Kit",effect:"Provides materials and tools for repairs",uses:"10 uses",bulk:1,cost:500},{name:"Tracker",effect:"While within 10km, always know location of this device",uses:"1 use",bulk:1,cost:250},{name:"Portable Scanner",effect:"Right tool for the job: Observe (tech, lifeforms)",uses:"Permanent",bulk:1,cost:400},{name:"Weapon Scope",effect:"Simple Modification. Grants +1 bonus die to called shots at medium range and farther; inflicts +1 penalty die to attacks at close range or nearer",uses:"Permanent",bulk:1,cost:750},{name:"Weapon Silencer",effect:"Simple Modification. Weapon makes reduced sound when fired; deals -1 damage",uses:"Permanent",bulk:1,cost:500},{name:"Compact Backpack",effect:"+5 Inventory Slots when worn",uses:"Permanent",bulk:0,cost:150,statusEffects:"carrying_capacity+5"},{name:"Ammo (Flechette)",effect:"Deals +2 damage to unarmoured targets.",uses:"10 rounds",bulk:1,cost:500},{name:"Ammo (SMART)",effect:"Required for Smart-Linked weapons.",uses:"10",bulk:1,cost:1250},{name:"Ammo (Armour Piercing)",effect:"Adds Piercing 1 to attacks.",uses:"10",bulk:1,cost:750},{name:"Ammo (Explosive)",effect:"Adds Shredding 1 to attacks.",uses:"10",bulk:1,cost:750}],ra={items:na},ia=ra.items,la=[{name:"Reflex Booster",tier:1,effect:"Once per round, gain +1 bonus die to an Evade check.",installationDifficulty:2,requirements:"REF 1",physicalImpact:"Low; spine",bulk:1,cost:3e3},{name:"Targeting Link",tier:1,effect:"Once per round, ignore 1 level of cover when attacking an enemy you can see.",installationDifficulty:2,requirements:"-",physicalImpact:"Medium; eyes",bulk:1,cost:4e3},{name:"Low-Light Optics",tier:1,effect:"Ignore penalty dice caused by darkness within medium range.",installationDifficulty:1,requirements:"-",physicalImpact:"Medium; eyes",bulk:1,cost:2e3},{name:"EMP Shielding",tier:1,effect:"Ignore the effects of EMP once per day.",installationDifficulty:2,requirements:"MENT 1",physicalImpact:"None; torso",bulk:1,cost:3500},{name:"Metabolic Filter",tier:1,effect:"Gain +1 bonus die on checks to resist toxins or narcotics.",installationDifficulty:1,requirements:"PHYS 1",physicalImpact:"Minor; liver",bulk:1,cost:1500},{name:"Compact Databank",tier:2,effect:"Internal information storage device; store/access info at will.",installationDifficulty:2,requirements:"MENT 1",physicalImpact:"Medium; cranium",bulk:1,cost:5e3}],oa={cyberware:la},ca=oa.cyberware,da=[{name:"Space Dust",effect:"Grants +1 bonus die to Observe and Piloting checks for 6 hours",uses:5,addictionScore:1,legality:"Legal",bulk:1,cost:500},{name:"Tranquility",effect:"Reduces stress by 1; penalty die to all REF checks for 6 hours.",uses:2,addictionScore:5,legality:"Legal",bulk:1,cost:5e3},{name:"Smoothe",effect:"Reduces stress by 1d4; increases Cool Under Fire by 2 and grants +1 bonus die to all Mental skill checks for 1 hour",uses:1,addictionScore:8,legality:"Illegal",bulk:1,cost:2e4},{name:"Chemical Strength",effect:"+1 bonus die to all PHYS checks for 1 hour; +1 movement bonus for 1 hour. After 1 hour, +1 penalty die to all PHYS checks and +1 movement penalty until sleep.",uses:1,addictionScore:3,legality:"Illegal",bulk:1,cost:8e3}],ua={narcotics:da},ma=ua.narcotics;function ha(){return`inv_${Date.now()}_${Math.random().toString(36).slice(2,9)}`}function fa(t){const r=t.sheet.inventory??[],y=a=>{t.onChange({inventory:a})},[h,T]=k.useState("item"),[S,g]=k.useState(null),[l,v]=k.useState({}),[B,K]=k.useState(null),[F,N]=k.useState(null),ae=k.useMemo(()=>h==="item"?ia.map(a=>({type:"item",...a})):h==="cyberware"?ca.map(a=>({type:"cyberware",...a})):ma.map(a=>({type:"narcotics",...a})),[h]);function ie(a){g(a);const s=ae.find(A=>A.name===a);if(!s){v({type:h,name:"",quantity:1,bulk:h==="item"?0:1,effect:"",cost:0,statusEffects:""});return}v(h==="item"?{type:"item",name:s.name,quantity:1,uses:s.uses??"",bulk:s.bulk??0,effect:s.effect??"",cost:s.cost??0,statusEffects:s.statusEffects??""}:h==="cyberware"?{type:"cyberware",name:s.name,quantity:1,bulk:s.bulk??1,tier:s.tier??1,installationDifficulty:s.installationDifficulty??0,requirements:s.requirements??"",physicalImpact:s.physicalImpact??"",effect:s.effect??"",cost:s.cost??0,statusEffects:s.statusEffects??""}:{type:"narcotics",name:s.name,quantity:1,bulk:s.bulk??1,uses:s.uses??1,addictionScore:s.addictionScore??0,legality:s.legality??"",effect:s.effect??"",cost:s.cost??0,statusEffects:s.statusEffects??""})}function oe(){const a=[...r,{id:ha(),...l}];t.onChange({inventory:a}),g(null),v({type:h,name:"",quantity:1,bulk:h==="item"?0:1,effect:"",cost:0,statusEffects:""})}function se(a){t.onChange({inventory:r.filter(s=>s.id!==a)})}function u(a,s){t.onChange({inventory:r.map(A=>A.id===a?{...A,...s}:A)})}return e.jsxs(U,{spacing:2,children:[e.jsx(x,{label:"Credits",type:"number",value:t.sheet.credits??0,onChange:a=>t.onChange({credits:Number(a.target.value)}),size:"small"}),e.jsxs(R,{children:[e.jsx(I,{variant:"subtitle2",sx:{mb:1},children:"Add Inventory"}),e.jsxs(U,{direction:{xs:"column",sm:"row"},spacing:1,alignItems:"center",children:[e.jsxs(x,{select:!0,size:"small",label:"Type",value:h,onChange:a=>{const s=a.target.value;T(s),g(null),v(s==="item"?{type:s,name:"",quantity:1,bulk:0,uses:"",effect:"",cost:0,statusEffects:""}:s==="cyberware"?{type:s,name:"",quantity:1,bulk:1,tier:1,installationDifficulty:0,requirements:"",physicalImpact:"",effect:"",cost:0,statusEffects:""}:{type:s,name:"",quantity:1,bulk:1,uses:1,addictionScore:0,legality:"",effect:"",cost:0,statusEffects:""})},sx:{minWidth:160},children:[e.jsx(ue,{value:"item",children:"Item"}),e.jsx(ue,{value:"cyberware",children:"Cyberware"}),e.jsx(ue,{value:"narcotics",children:"Narcotics"})]}),e.jsx(Rt,{size:"small",sx:{flex:1,minWidth:220},options:ae.map(a=>a.name),value:S,onChange:(a,s)=>ie(s),renderInput:a=>e.jsx(x,{...a,label:"Template (optional)"})}),e.jsx(me,{variant:"contained",startIcon:e.jsx(je,{}),onClick:oe,disabled:!(l!=null&&l.name),children:"Add"})]}),e.jsx(R,{sx:{mt:1},children:e.jsxs(U,{spacing:1,children:[e.jsxs(U,{direction:{xs:"column",sm:"row"},spacing:1,children:[e.jsx(x,{size:"small",label:"Name",value:(l==null?void 0:l.name)??"",onChange:a=>v(s=>({...s,name:a.target.value})),sx:{flex:1}}),e.jsx(x,{size:"small",type:"number",label:"Bulk",value:(l==null?void 0:l.bulk)??0,onChange:a=>v(s=>({...s,bulk:Number(a.target.value)})),sx:{width:120}}),e.jsx(x,{size:"small",type:"number",label:"Quantity",value:(l==null?void 0:l.quantity)??1,onChange:a=>{const s=Number(a.target.value);Number.isFinite(s)&&v(A=>({...A,quantity:s}))},sx:{width:120}}),e.jsx(x,{size:"small",type:"number",label:"Cost",value:(l==null?void 0:l.cost)??0,onChange:a=>v(s=>({...s,cost:Number(a.target.value)})),sx:{width:140}})]}),h==="item"&&e.jsx(x,{size:"small",label:"Uses",value:(l==null?void 0:l.uses)??"",onChange:a=>v(s=>({...s,uses:a.target.value}))}),h==="cyberware"&&e.jsxs(U,{direction:{xs:"column",sm:"row"},spacing:1,children:[e.jsx(x,{size:"small",type:"number",label:"Tier",value:(l==null?void 0:l.tier)??1,onChange:a=>v(s=>({...s,tier:Number(a.target.value)})),sx:{width:120}}),e.jsx(x,{size:"small",type:"number",label:"Installation Difficulty",value:(l==null?void 0:l.installationDifficulty)??0,onChange:a=>v(s=>({...s,installationDifficulty:Number(a.target.value)})),sx:{width:220}}),e.jsx(x,{size:"small",label:"Requirements",value:(l==null?void 0:l.requirements)??"",onChange:a=>v(s=>({...s,requirements:a.target.value})),sx:{flex:1}})]}),h==="cyberware"&&e.jsx(x,{size:"small",label:"Physical Impact",value:(l==null?void 0:l.physicalImpact)??"",onChange:a=>v(s=>({...s,physicalImpact:a.target.value}))}),h==="narcotics"&&e.jsxs(U,{direction:{xs:"column",sm:"row"},spacing:1,children:[e.jsx(x,{size:"small",type:"number",label:"Uses",value:(l==null?void 0:l.uses)??1,onChange:a=>v(s=>({...s,uses:Number(a.target.value)})),sx:{width:120}}),e.jsx(x,{size:"small",type:"number",label:"Addiction Score",value:(l==null?void 0:l.addictionScore)??0,onChange:a=>v(s=>({...s,addictionScore:Number(a.target.value)})),sx:{width:160}}),e.jsx(x,{size:"small",label:"Legality",value:(l==null?void 0:l.legality)??"",onChange:a=>v(s=>({...s,legality:a.target.value})),sx:{flex:1}})]}),e.jsx(x,{size:"small",label:"Effect",value:(l==null?void 0:l.effect)??"",onChange:a=>v(s=>({...s,effect:a.target.value})),multiline:!0,minRows:2}),e.jsx(x,{size:"small",label:"Status Effects (comma-separated)",value:(l==null?void 0:l.statusEffects)??"",onChange:a=>v(s=>({...s,statusEffects:a.target.value})),placeholder:'e.g. "carrying_capacity+5"'})]})})]}),e.jsxs(R,{children:[e.jsx(I,{variant:"subtitle2",sx:{mb:1},children:"Inventory"}),r.length===0&&e.jsx(I,{variant:"body2",children:"No inventory items yet."}),r.map(a=>{const s=a.quantity??1,M=(a.bulk??0)*s,P=`${a.name} (${a.type}) • bulk ${M}`;return e.jsxs(Ae,{disableGutters:!0,children:[e.jsx(Te,{expandIcon:e.jsx(Re,{}),draggable:!0,onDragStart:m=>{K(a.id??null);try{m.dataTransfer.effectAllowed="move",m.dataTransfer.setData("text/plain",a.id??"")}catch{}},onDragOver:m=>{m.preventDefault(),N(a.id??null)},onDragLeave:()=>N(null),onDrop:m=>{m.preventDefault();const L=B??m.dataTransfer.getData("text/plain"),X=a.id;if(L&&X&&L!==X){const j=t.sheet.inventory??[],G=j.findIndex(J=>J.id===L),te=j.findIndex(J=>J.id===X);if(G>=0&&te>=0){const J=[...j],[d]=J.splice(G,1);J.splice(te,0,d),y(J)}}K(null),N(null)},sx:F===a.id?{outline:"2px dashed rgba(255,255,255,0.35)",borderRadius:1}:void 0,children:e.jsxs(U,{direction:"row",spacing:1,alignItems:"center",sx:{width:"100%"},children:[e.jsx(Et,{fontSize:"small",sx:{opacity:.5}}),e.jsx(I,{variant:"body2",sx:{flex:1},children:P}),e.jsxs(U,{direction:"row",spacing:.5,alignItems:"center",children:[e.jsx(le,{size:"small",onClick:m=>{m.stopPropagation();const L=(a.quantity??1)-1;L<=0?se(a.id):u(a.id,{quantity:L})},children:e.jsx(ct,{fontSize:"small"})}),e.jsx(I,{variant:"caption",sx:{minWidth:18,textAlign:"center"},children:a.quantity??1}),e.jsx(le,{size:"small",onClick:m=>{m.stopPropagation(),u(a.id,{quantity:(a.quantity??1)+1})},children:e.jsx(je,{fontSize:"small"})})]}),e.jsx(be,{title:"Remove",children:e.jsx(le,{size:"small",onClick:m=>(m.stopPropagation(),se(a.id)),children:e.jsx(Be,{fontSize:"small"})})})]})}),e.jsx(Ee,{children:e.jsxs(U,{spacing:1,children:[e.jsxs(U,{direction:{xs:"column",sm:"row"},spacing:1,children:[e.jsx(x,{size:"small",label:"Name",value:a.name??"",onChange:m=>u(a.id,{name:m.target.value}),sx:{flex:1}}),e.jsxs(x,{select:!0,size:"small",label:"Type",value:a.type,onChange:m=>u(a.id,{type:m.target.value}),sx:{width:160},children:[e.jsx(ue,{value:"item",children:"Item"}),e.jsx(ue,{value:"cyberware",children:"Cyberware"}),e.jsx(ue,{value:"narcotics",children:"Narcotics"})]}),e.jsx(x,{size:"small",type:"number",label:"Bulk",value:a.bulk??0,onChange:m=>u(a.id,{bulk:Number(m.target.value)}),sx:{width:120}}),e.jsx(x,{size:"small",type:"number",label:"Quantity",value:a.quantity??1,onChange:m=>{const L=Number(m.target.value);Number.isFinite(L)&&(L<=0?se(a.id):u(a.id,{quantity:L}))},sx:{width:120}}),e.jsx(x,{size:"small",type:"number",label:"Cost",value:a.cost??0,onChange:m=>u(a.id,{cost:Number(m.target.value)}),sx:{width:140}})]}),a.type==="item"&&e.jsx(x,{size:"small",label:"Uses",value:a.uses??"",onChange:m=>u(a.id,{uses:m.target.value})}),a.type==="cyberware"&&e.jsxs(U,{direction:{xs:"column",sm:"row"},spacing:1,children:[e.jsx(x,{size:"small",type:"number",label:"Tier",value:a.tier??1,onChange:m=>u(a.id,{tier:Number(m.target.value)}),sx:{width:120}}),e.jsx(x,{size:"small",type:"number",label:"Installation Difficulty",value:a.installationDifficulty??0,onChange:m=>u(a.id,{installationDifficulty:Number(m.target.value)}),sx:{width:220}}),e.jsx(x,{size:"small",label:"Requirements",value:a.requirements??"",onChange:m=>u(a.id,{requirements:m.target.value}),sx:{flex:1}})]}),a.type==="cyberware"&&e.jsx(x,{size:"small",label:"Physical Impact",value:a.physicalImpact??"",onChange:m=>u(a.id,{physicalImpact:m.target.value})}),a.type==="narcotics"&&e.jsxs(U,{direction:{xs:"column",sm:"row"},spacing:1,children:[e.jsx(x,{size:"small",type:"number",label:"Uses",value:a.uses??1,onChange:m=>u(a.id,{uses:Number(m.target.value)}),sx:{width:120}}),e.jsx(x,{size:"small",type:"number",label:"Addiction Score",value:a.addictionScore??0,onChange:m=>u(a.id,{addictionScore:Number(m.target.value)}),sx:{width:160}}),e.jsx(x,{size:"small",label:"Legality",value:a.legality??"",onChange:m=>u(a.id,{legality:m.target.value}),sx:{flex:1}})]}),e.jsx(x,{size:"small",label:"Effect",value:a.effect??"",onChange:m=>u(a.id,{effect:m.target.value}),multiline:!0,minRows:2}),e.jsx(x,{size:"small",label:"Status Effects (comma-separated)",value:a.statusEffects??"",onChange:m=>u(a.id,{statusEffects:m.target.value}),placeholder:'e.g. "carrying_capacity+5"'})]})})]},a.id)})]})]})}function xa(){const[t,r]=k.useState({entries:[],activeTokenId:void 0,updatedAt:Date.now()}),[y,h]=k.useState({}),[T,S]=k.useState(""),[g,l]=k.useState(!1),[v,B]=k.useState(0),K=u=>Math.max(-3,Math.min(3,u)),F=k.useMemo(()=>Xe(),[]);k.useEffect(()=>{const u=pt(a=>r(a));return()=>u==null?void 0:u()},[]),k.useEffect(()=>{let u=!0;return(async()=>{var a,s,A,M;try{const[P,m]=await Promise.all([((s=(a=q.player).getId)==null?void 0:s.call(a))??Promise.resolve(""),((M=(A=q.player).getRole)==null?void 0:M.call(A))??Promise.resolve("")]);if(!u)return;S(String(P??"")),l(String(m).toUpperCase()==="GM")}catch{}})(),()=>{u=!1}},[]);const N=k.useMemo(()=>{const u=[...t.entries??[]];return u.sort((a,s)=>(s.initiative??0)-(a.initiative??0)),u},[t.entries]);k.useEffect(()=>{let u=!0;return(async()=>{var a,s,A,M,P,m,L;try{const X=N.map(te=>te.tokenId);if(!X.length){u&&h({});return}const j=await q.scene.items.getItems(X),G={};for(const te of j){const J=te.id,d=await ze(J),f=d==null?void 0:d.armor,_=((a=f==null?void 0:f.durability)==null?void 0:a.current)??0,V=!!f&&_<=0,Z=V?0:(f==null?void 0:f.protection)??0,$=(s=d==null?void 0:d.weapons)==null?void 0:s[0],he=ke($),ve=Number.isFinite($==null?void 0:$.ammo)?Number($==null?void 0:$.ammo):0;G[J]={tokenId:J,name:((P=(M=(A=te.text)==null?void 0:A.plainText)==null?void 0:M.trim)==null?void 0:P.call(M))||(d==null?void 0:d.name)||"(Unnamed)",thumbUrl:(m=te.image)==null?void 0:m.url,ownerPlayerId:String(((L=te.metadata)==null?void 0:L[lt])??""),prot:Z,armorBroken:V,topWeaponName:$==null?void 0:$.name,topWeaponUseDC:$==null?void 0:$.useDC,topWeaponDamage:$==null?void 0:$.damage,topWeaponSkillId:$==null?void 0:$.skillId,topWeaponAmmo:ve,topWeaponAmmoMax:he}}u&&h(G)}catch{}})(),()=>{u=!1}},[N]);async function ae(u){var d,f,_,V,Z;const[a]=await q.scene.items.getItems([u]);if(!a)return;const s=await ze(u);if(!s)return;const A=Ze([...(s.feats??[]).map($=>$.statusEffects??"").filter(Boolean),...(s.inventory??[]).map($=>$.statusEffects??"").filter(Boolean)]).deltas,M=Ie(s.skills??{}),P=((d=s.stress)==null?void 0:d.current)??0,m=Math.max(0,(Le(s.skills??{})||0)-(((f=s.stress)==null?void 0:f.cufLoss)??0)),L=jt({attributes:M,stress:{current:P,cuf:m}},A),X=L.stress.cuf??m,j=L.attributes.ref??M.ref??0,G=P>X,te=Fe({netDice:G?-1:0,modifier:j,label:`${((_=a.text)==null?void 0:_.plainText)??s.name??"Token"} Initiative`}),J=await Qe({diceNotation:te,rollTarget:"everyone",showResults:!0});await wt({tokenId:u,initiative:J,name:((V=a.text)==null?void 0:V.plainText)??s.name??"Token",thumbUrl:(Z=a.image)==null?void 0:Z.url})}async function ie(){var M,P;const u=await((P=(M=q.player).getSelection)==null?void 0:P.call(M))??[],a=u==null?void 0:u[0],s=await ot()??void 0,A=a||s;if(!A){q.notification.show("Select a token (or set your character) to roll initiative.","WARNING");return}await ae(A)}async function oe(u){var d,f,_;const a=await ze(u);if(!a)return;const s=(d=a.weapons)==null?void 0:d[0];if(!s){q.notification.show("No weapon in the top slot.","WARNING");return}const A=Ze([...(a.feats??[]).map(V=>V.statusEffects??"").filter(Boolean),...(a.inventory??[]).map(V=>V.statusEffects??"").filter(Boolean)]).deltas,P=(Le(a.skills??{})-(((f=a.stress)==null?void 0:f.cufLoss)??0)||0)+(A.cool_under_fire??0),L=(((_=a.stress)==null?void 0:_.current)??0)>P,X=String(s.skillId??""),j=ut({learnedInfoById:F,sheet:a,skillId:X,skillMods:A}),G=ke(s),te=Number.isFinite(s==null?void 0:s.ammo)?Number(s==null?void 0:s.ammo):0;if(G>0&&te<=0){q.notification.show("Out of ammo. Reload first.","WARNING");return}const J=K(v-(L?1:0));if(await ht({weapon:s,netDice:J,modifier:j,attackerName:a.name,rollTarget:"everyone",showResults:!0}),G>0){const V=Math.max(0,te-1),Z=[...a.weapons??[]];Z[0]={...Z[0],ammo:V},await Je(u,{...a,weapons:Z})}}async function se(u){var P;const a=await ze(u);if(!a)return;const s=(P=a.weapons)==null?void 0:P[0];if(!s)return;const A=ke(s);if(A<=0)return;const M=[...a.weapons??[]];M[0]={...M[0],ammo:A},await Je(u,{...a,weapons:M})}return e.jsxs(U,{spacing:2,children:[e.jsxs(R,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",gap:1,flexWrap:"wrap"},children:[e.jsx(I,{variant:"h6",sx:{m:0},children:"Initiative"}),e.jsxs(U,{direction:"row",spacing:1,alignItems:"center",children:[e.jsx(me,{size:"small",variant:"contained",onClick:()=>void ie(),startIcon:e.jsx(De,{}),children:"Roll Initiative"}),e.jsxs(R,{sx:{display:"flex",alignItems:"center",gap:1,flexWrap:"wrap",pl:1},children:[e.jsx(I,{variant:"body2",sx:{opacity:.8},children:"Attack Roll:"}),e.jsxs(_e,{size:"small",exclusive:!0,value:v,onChange:(u,a)=>{a!==null&&B(a)},children:[e.jsx(ne,{value:-2,children:"−2"}),e.jsx(ne,{value:-1,children:"−1"}),e.jsx(ne,{value:0,children:"0"}),e.jsx(ne,{value:1,children:"+1"}),e.jsx(ne,{value:2,children:"+2"})]})]}),g&&e.jsxs(e.Fragment,{children:[e.jsx(me,{size:"small",variant:"outlined",onClick:()=>yt(),children:"Clear"}),e.jsx(me,{size:"small",variant:"outlined",onClick:()=>bt(),children:"Advance"})]})]})]}),e.jsx(Nt,{}),N.length===0?e.jsx(I,{variant:"body2",sx:{opacity:.75},children:"No initiative rolls yet."}):e.jsx(Pt,{dense:!0,disablePadding:!0,children:N.map(u=>{const a=y[u.tokenId],s=a==null?void 0:a.ownerPlayerId,A=g||!!s&&s===T,M=t.activeTokenId===u.tokenId,P=M&&A&&!g,m=!!u.surprised,L=(a==null?void 0:a.topWeaponAmmoMax)??0,X=(a==null?void 0:a.topWeaponAmmo)??0,j=L>0&&X<=0;return e.jsxs(zt,{sx:{borderRadius:1,mb:.5,bgcolor:M?"rgba(255,255,255,0.06)":"transparent",opacity:m?.55:1},secondaryAction:e.jsxs(U,{direction:"row",spacing:.5,alignItems:"center",children:[e.jsx(be,{title:a!=null&&a.armorBroken?"Armor broken":"Protection",children:e.jsxs(R,{sx:{display:"inline-flex",alignItems:"center",gap:.5,px:1,py:.5,borderRadius:1,bgcolor:"rgba(0,0,0,0.25)"},children:[e.jsx(Bt,{fontSize:"small",sx:{color:a!=null&&a.armorBroken?"error.main":"inherit"}}),e.jsx(I,{variant:"caption",children:(a==null?void 0:a.prot)??0})]})}),(g||A)&&e.jsx(be,{title:a!=null&&a.topWeaponName?j?`Out of ammo: ${a.topWeaponName}`:`Attack: ${a.topWeaponName}`:"No top weapon",children:e.jsx("span",{children:e.jsx(le,{size:"small",disabled:!(a!=null&&a.topWeaponName)||j,onClick:()=>void oe(u.tokenId),children:e.jsx(De,{fontSize:"small"})})})}),(g||A)&&e.jsx(be,{title:a!=null&&a.topWeaponName?L<=0?"No ammo to reload":`Reload: ${a.topWeaponName}`:"No top weapon",children:e.jsx("span",{children:e.jsx(le,{size:"small",disabled:!(a!=null&&a.topWeaponName)||L<=0,onClick:()=>void se(u.tokenId),children:e.jsx(dt,{fontSize:"small"})})})}),e.jsx(be,{title:A||g?"Remove":"Only the owner or GM can remove",children:e.jsx("span",{children:e.jsx(le,{size:"small",disabled:!A&&!g,onClick:()=>vt(u.tokenId),children:e.jsx(Be,{fontSize:"small"})})})})]}),children:[e.jsx(Wt,{children:e.jsx(Lt,{src:a==null?void 0:a.thumbUrl,variant:"rounded",sx:{width:32,height:32,mr:1,cursor:"pointer"}})}),e.jsx(Ft,{primary:e.jsxs(R,{sx:{display:"flex",alignItems:"center",gap:1,flexWrap:"wrap"},children:[e.jsx(I,{variant:"body2",sx:{fontWeight:600},children:(a==null?void 0:a.name)??u.name??"Token"}),e.jsx(I,{variant:"caption",sx:{opacity:.75},children:u.initiative}),P&&e.jsx(I,{variant:"caption",sx:{px:1,py:.25,borderRadius:1,bgcolor:"rgba(0,128,255,0.2)"},children:"Your Turn"})]}),secondary:e.jsxs(R,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(_t,{size:"small",checked:m,disabled:!g,onChange:G=>kt(u.tokenId,G.target.checked)}),e.jsx(I,{variant:"caption",sx:{opacity:.75},children:"Surprised"})]})})]},u.tokenId)})})]})}function ga(){var b,Q,ye,z,Ne,Pe,Ce;const[t,r]=k.useState({kind:"loading"}),[y,h]=k.useState("core"),[T,S]=k.useState(!1),[g,l]=k.useState(null),[v,B]=k.useState(!1),[K,F]=k.useState([]);async function N(o){var i,p,w,C,E,W;try{const H=await q.scene.items.getItems([o]),D=H==null?void 0:H[0];if(!D)return{ownerLabel:"unowned",thumbUrl:null};const O=((i=D==null?void 0:D.image)==null?void 0:i.url)??((p=D==null?void 0:D.image)==null?void 0:p.href)??(D==null?void 0:D.imageUrl)??(D==null?void 0:D.image)??((w=D==null?void 0:D.thumbnail)==null?void 0:w.url)??null,ee=(C=D==null?void 0:D.metadata)==null?void 0:C[lt];if(typeof ee!="string"||ee.length===0)return{ownerLabel:"unowned",thumbUrl:O,ownerPlayerId:null,isOwnedByMe:!1};const de=await q.player.getId();if(ee===de)return{ownerLabel:"owned by you",thumbUrl:O,ownerPlayerId:ee,isOwnedByMe:!0};try{const Y=(await((W=(E=q.party).getPlayers)==null?void 0:W.call(E))??[]).find(xe=>(xe==null?void 0:xe.id)===ee);return{ownerLabel:`owned by ${typeof(Y==null?void 0:Y.name)=="string"&&Y.name.length>0?Y.name:ee}`,thumbUrl:O,ownerPlayerId:ee,isOwnedByMe:!1}}catch{return{ownerLabel:`owned by ${ee}`,thumbUrl:O,ownerPlayerId:ee,isOwnedByMe:!1}}}catch{return{ownerLabel:"unowned",thumbUrl:null,ownerPlayerId:null,isOwnedByMe:!1}}}async function ae(o){const i=o!=null&&o.ignoreOpenOverride?null:await St();if(i)if(await $e(i)){const ee=await qe(i);if(!ee)throw new Error("Could not load sheet from token.");const de=Ie(ee.skills??{}),fe={...ee,attributes:de},Y=await N(i);r({kind:"ready",tokenId:i,sheet:fe,mode:"view",suppressUnset:!0,...Y});return}else await Ue(null);let w=await ot();if(w||(w=await et(),w&&await Se(w)),!w){r({kind:"need-token"});return}let C=await $e(w);if(!C){const O=await et();O&&(w=O,await Se(w),C=await $e(w))}if(!C){await Se(null),r({kind:"need-token"});return}const E=await qe(w);if(!E)throw new Error("Could not load sheet from token.");try{await tt(w)}catch{}const W=Ie(E.skills??{}),H={...E,attributes:W},D=await N(w);r({kind:"ready",tokenId:w,sheet:H,mode:"my",suppressUnset:!!(o!=null&&o.suppressUnset),...D})}k.useEffect(()=>{let o=!1;return q.onReady(async()=>{try{const i=await q.player.getRole();o||B(String(i).toUpperCase()==="GM"),await ae()}catch(i){o||r({kind:"error",message:i.message??"Unknown error"})}}),()=>{o=!0}},[]),k.useEffect(()=>{let o=null,i=!1;return q.onReady(()=>{i||(o=q.broadcast.onMessage(Ve,p=>{const w=p.data;w!=null&&w.text&&F(C=>[...C,w].slice(-3))}))}),()=>{if(i=!0,typeof o=="function")try{o()}catch{}}},[]),k.useEffect(()=>{let o=null,i=null,p=!1;const w="whisperspace.combatLogLeader",C=2e3,E=6e3,W=`${Date.now()}-${Math.random().toString(36).slice(2,10)}`,H=()=>{try{const Y=localStorage.getItem(w);return Y?JSON.parse(Y):null}catch{return null}},D=Y=>{try{localStorage.setItem(w,JSON.stringify({id:W,ts:Y??Date.now()}))}catch{}},O=()=>{const Y=H();return Y&&Y.id===W},ee=()=>{const Y=Date.now(),ce=H();(!ce||Y-(ce.ts??0)>E||ce.id===W)&&D(Y)},de=()=>{const Y=O();if(Y&&!o)o=q.broadcast.onMessage(Ve,ce=>{const xe=ce.data;xe!=null&&xe.text&&q.notification.show(String(xe.text),"INFO")});else if(!Y&&o){try{o()}catch{}o=null}},fe=Y=>{Y.key===w&&de()};return q.onReady(()=>{if(!p){try{window.addEventListener("storage",fe)}catch{}ee(),de(),i=window.setInterval(()=>{p||(ee(),de())},C)}}),()=>{p=!0;try{window.removeEventListener("storage",fe)}catch{}if(i!==null&&clearInterval(i),O())try{localStorage.removeItem(w)}catch{}if(typeof o=="function")try{o()}catch{}}},[]);function ie(o,i,p){const w={text:`${o} took ${i} damage${p?` and +${p} stress`:""}.`,ts:Date.now(),kind:"effect",targetName:o,damageApplied:i,stressApplied:p};F(C=>[...C,w].slice(-3))}function oe(o){if(t.kind!=="ready"||t.mode!=="my")return;const i=Math.max(0,Math.trunc(o.damageApplied??0)),p=Math.max(0,Math.trunc(o.stressApplied??0));i<=0&&p<=0||M(w=>{var E;const C=ft({sheet:w,incomingDamage:i,stressDelta:p});return C.stressDelta>0&&m(((E=C.sheet.stress)==null?void 0:E.current)??0),ie(t.sheet.name||"Target",i,p),C.sheet})}k.useEffect(()=>{var C,E,W,H;if(t.kind!=="ready")return;const o=t.tokenId;let i=!1;const p=async()=>{var D,O;try{const ee=await q.scene.items.getItems([o]),de=ee==null?void 0:ee[0],fe=String(((D=de==null?void 0:de.text)==null?void 0:D.plainText)??"").trim(),Y=(O=de==null?void 0:de.image)==null?void 0:O.url;if(i||!fe&&!Y)return;r(ce=>{if(ce.kind!=="ready"||ce.tokenId!==o)return ce;const xe=fe&&ce.sheet.name!==fe?{...ce.sheet,name:fe}:ce.sheet;return{...ce,sheet:xe,thumbUrl:Y??ce.thumbUrl}})}catch{}};p();const w=(H=(W=(E=(C=q)==null?void 0:C.scene)==null?void 0:E.items)==null?void 0:W.onChange)==null?void 0:H.call(W,D=>{Array.isArray(D)&&D.some(O=>(O==null?void 0:O.id)===o)&&p()});return()=>{i=!0,typeof w=="function"&&w()}},[t.kind,t.kind==="ready"?t.tokenId:null]);const se=k.useMemo(()=>t.kind==="ready"&&t.sheet.name||"Whisperspace Sheet",[t]);async function u(){const o=await Ht();if(!o){r({kind:"error",message:"No token selected. Select a token on the map first."});return}const i=await qe(o);if(!i){r({kind:"error",message:"Could not attach a sheet to the selected token."});return}const p=Ie(i.skills??{}),w={...i,attributes:p};await Se(o);try{await tt(o)}catch{}await Ue(null);const C=await N(o);r({kind:"ready",tokenId:o,sheet:w,mode:"my",suppressUnset:!1,...C})}async function a(){await Se(null);try{await It()}catch{}r({kind:"need-token"})}async function s(){await Ue(null),r({kind:"loading"});try{await ae({ignoreOpenOverride:!0,suppressUnset:!0})}catch(o){r({kind:"error",message:o.message??"Unknown error"})}}async function A(o,i){S(!0);try{await Je(o,i)}finally{S(!1)}}function M(o){r(i=>{if(i.kind!=="ready")return i;let p=o(i.sheet);try{const w=Ie(p.skills??{});p={...p,attributes:{...p.attributes,...w},stress:{...p.stress??{current:0,cuf:0,cufLoss:0},cuf:Le(p.skills??{})}}}catch{}return A(i.tokenId,p),{...i,sheet:p}})}async function P(o){var H;if(t.kind!=="ready")return;const i=8+o,p=Math.max(0,Math.trunc(((H=t.sheet.stress)==null?void 0:H.cuf)??0)),w=`Crucible Test (DC ${i})`,C=p===0?"":` +${p}`,E=`1d12 # ${w}${C}`;let W;try{W=await Qe({diceNotation:E,rollTarget:"everyone",showResults:!0,timeoutMs:6e3})}catch{q.notification.show("Dice+ roll failed or timed out.","WARNING");return}W>=i?(M(D=>({...D,stress:{...D.stress??{current:0,cuf:0,cufLoss:0},current:5},indomitable:!0})),l({incoming:o,dc:i,status:"success",total:W})):l({incoming:o,dc:i,status:"fail",total:W})}function m(o){var w;if(t.kind!=="ready")return;const i=Math.max(0,Math.trunc(((w=t.sheet.stress)==null?void 0:w.current)??0)),p=Math.max(0,Math.trunc(o));if(i<=5&&p>5){const C=p-i;l({incoming:C,dc:8+C,status:"pending"})}else l(null);M(C=>({...C,stress:{...C.stress??{current:0,cuf:0,cufLoss:0},current:p}}))}function L(o,i){var W;if(t.kind!=="ready")return;const w={light:4,moderate:2,heavy:1}[o],C=Math.max(0,Math.trunc(((W=t.sheet.wounds)==null?void 0:W[o])??0)),E=i<C?i:i+1;M(H=>({...H,wounds:{...H.wounds,[o]:Math.min(w,Math.max(0,E))}}))}function X(){var i;if(t.kind!=="ready"||!g||g.status!=="fail")return;const o=Math.max(0,Math.trunc(((i=t.sheet.stress)==null?void 0:i.cufLoss)??0));M(p=>({...p,stress:{...p.stress??{current:0,cuf:0,cufLoss:0},cufLoss:o+1,current:5},indomitable:!0})),l({...g,status:"success"})}const j=t.kind==="ready"?t.sheet:null,G=Me.useMemo(()=>{if(!j)return{};const o=[];return(j.feats??[]).forEach(i=>{typeof(i==null?void 0:i.statusEffects)=="string"&&i.statusEffects.trim()&&o.push(i.statusEffects)}),(j.inventory??[]).forEach(i=>{typeof(i==null?void 0:i.statusEffects)=="string"&&i.statusEffects.trim()&&o.push(i.statusEffects)}),Ct(o)},[j]),te=Me.useMemo(()=>{const o={},i=new Map,p=C=>{const E=String(C.id),W=String(C.name??C.label??"").toLowerCase().replace(/\s+/g,"_").replace(/[^a-z0-9_\-()]/g,"");E&&(i.set(E.toLowerCase(),E),W&&i.set(W,E))};(ge.inherent??[]).forEach(p),Object.values(ge.learned??{}).forEach(C=>{(C??[]).forEach(p)});const w=new Set(["phys","ref","soc","ment","carrying_capacity","cool_under_fire","speed","cuf","carry","capacity","spd"]);return Object.entries(G??{}).forEach(([C,E])=>{const W=String(C).toLowerCase();if(w.has(W))return;const H=i.get(W);H&&(o[H]=(o[H]??0)+(Number.isFinite(E)?E:0))}),o},[G]),J=Math.max(0,(((b=j==null?void 0:j.attributes)==null?void 0:b.phys)??0)+(G.phys??0)),d=Math.max(0,(((Q=j==null?void 0:j.attributes)==null?void 0:Q.ref)??0)+(G.ref??0)),f=Math.max(0,(((ye=j==null?void 0:j.attributes)==null?void 0:ye.soc)??0)+(G.soc??0)),_=Math.max(0,(((z=j==null?void 0:j.attributes)==null?void 0:z.ment)??0)+(G.ment??0)),Z=5+J*5+(G.carrying_capacity??0);30+J*5+(G.speed??0);const he=j?Le(j.skills??{}):0,ve=Math.max(0,he+(G.cool_under_fire??0)),pe=Me.useMemo(()=>j?{...j,attributes:{...j.attributes,phys:J,ref:d,soc:f,ment:_},stress:{...j.stress??{current:0,cuf:0,cufLoss:0},cuf:ve}}:null,[j,J,d,f,_,ve])??j,n=Me.useMemo(()=>{var w;if(!j)return 0;const o=(j.weapons??[]).reduce((C,E)=>C+(E.bulk??0),0),i=((w=j.armor)==null?void 0:w.bulk)??0,p=(j.inventory??[]).reduce((C,E)=>{const W=E.quantity??1,H=E.bulk??0,D=Number.isFinite(H)?H:0,O=Number.isFinite(W)?W:1;return C+D*O},0);return o+i+p},[j]),c=j&&n>Z*2?"Heavily Encumbered":j&&n>Z?"Encumbered":"";return t.kind==="loading"?e.jsx("div",{style:{padding:12},children:"Loading…"}):t.kind==="need-token"?e.jsxs("div",{style:{padding:12},children:[e.jsx("h2",{style:{margin:"0 0 8px 0"},children:"My Sheet"}),e.jsx("p",{style:{margin:"0 0 10px 0",lineHeight:1.35},children:"Select your character token on the map, then click:"}),e.jsx("button",{style:{padding:"8px 10px",borderRadius:8,border:"1px solid #666",cursor:"pointer"},onClick:u,children:"Set Selected Token as My Character"})]}):t.kind==="error"?e.jsxs("div",{style:{padding:12},children:[e.jsx("h2",{style:{margin:"0 0 8px 0"},children:"Error"}),e.jsx("p",{style:{margin:"0 0 10px 0",lineHeight:1.35},children:t.message}),e.jsx("button",{style:{padding:"8px 10px",borderRadius:8,border:"1px solid #666",cursor:"pointer"},onClick:()=>r({kind:"need-token"}),children:"Back"})]}):e.jsxs("div",{style:{padding:12},children:[e.jsxs("div",{style:{display:"flex",alignItems:"flex-start",gap:12,justifyContent:"space-between",marginBottom:10},children:[e.jsxs("div",{style:{display:"flex",gap:10,alignItems:"flex-start"},children:[t.thumbUrl?e.jsx("img",{src:t.thumbUrl,alt:"Token thumbnail",style:{width:44,height:44,borderRadius:10,objectFit:"cover",border:"1px solid rgba(0,0,0,0.2)"}}):e.jsx("div",{style:{width:44,height:44,borderRadius:10,border:"1px solid rgba(0,0,0,0.2)",opacity:.4}}),e.jsxs("div",{children:[e.jsxs("div",{style:{fontSize:18,fontWeight:700},children:[se," ",e.jsxs("span",{style:{fontSize:12,opacity:.75},children:["(",t.ownerLabel??(t.mode==="view"?"Viewing token":"My Character"),")"]})]}),e.jsxs("div",{style:{fontSize:12,opacity:.8},children:["Token: ",e.jsx("code",{style:{fontSize:11},children:t.tokenId})]})]})]}),e.jsx("div",{style:{display:"flex",gap:8},children:t.mode==="view"?!t.isOwnedByMe&&e.jsx("button",{style:{padding:"8px 10px",borderRadius:8,border:"1px solid #999",cursor:"pointer",opacity:.9},onClick:s,children:"Back to My Sheet"}):t.suppressUnset?null:e.jsx("button",{style:{padding:"8px 10px",borderRadius:8,border:"1px solid #999",cursor:"pointer",opacity:.9},onClick:a,children:"Unset “My Character”"})})]}),e.jsxs(e.Fragment,{children:[e.jsxs("div",{style:re.statusBar,children:[e.jsxs("div",{style:re.statusLeft,children:[e.jsxs("div",{style:re.statusGroup,children:[e.jsx("div",{style:re.statusLabel,children:"Stress"}),e.jsx("input",{type:"number",min:0,value:((Ne=t.sheet.stress)==null?void 0:Ne.current)??0,onChange:o=>m(Number(o.target.value)),style:re.statusNumber})]}),e.jsxs("div",{style:re.statusGroup,children:[e.jsx("div",{style:re.statusLabel,children:"Wounds"}),e.jsxs("div",{style:re.woundsRow,children:[e.jsx("span",{style:re.woundsKind,children:"L"}),Array.from({length:4}).map((o,i)=>{var p;return e.jsx("input",{type:"checkbox",checked:(((p=t.sheet.wounds)==null?void 0:p.light)??0)>i,onChange:()=>L("light",i)},`wl_${i}`)}),e.jsx("span",{style:{width:8}}),e.jsx("span",{style:re.woundsKind,children:"M"}),Array.from({length:2}).map((o,i)=>{var p;return e.jsx("input",{type:"checkbox",checked:(((p=t.sheet.wounds)==null?void 0:p.moderate)??0)>i,onChange:()=>L("moderate",i)},`wm_${i}`)}),e.jsx("span",{style:{width:8}}),e.jsx("span",{style:re.woundsKind,children:"H"}),Array.from({length:1}).map((o,i)=>{var p;return e.jsx("input",{type:"checkbox",checked:(((p=t.sheet.wounds)==null?void 0:p.heavy)??0)>i,onChange:()=>L("heavy",i)},`wh_${i}`)})]})]}),e.jsxs("label",{style:{display:"flex",alignItems:"center",gap:6},children:[e.jsx("input",{type:"checkbox",checked:!!t.sheet.indomitable,onChange:o=>M(i=>({...i,indomitable:o.target.checked}))}),e.jsx("span",{style:{fontSize:12,opacity:.9},children:"Indomitable"})]}),(((Pe=t.sheet.stress)==null?void 0:Pe.current)??0)>(((Ce=(pe??t.sheet).stress)==null?void 0:Ce.cuf)??0)&&e.jsx("div",{style:re.warning,children:"Stress > CUF: make all rolls with +1 Penalty Die"}),e.jsxs("div",{style:{fontSize:12,opacity:.85},children:["Bulk: ",n," / ",Z]}),c&&e.jsx("div",{style:re.warning,children:c})]}),e.jsxs("div",{style:re.statusRight,children:[g&&g.status==="pending"&&e.jsxs("div",{style:re.crucibleBox,children:[e.jsx("div",{style:{fontWeight:700},children:"Crucible Test!"}),e.jsxs("div",{style:{fontSize:12,opacity:.85},children:["Incoming stress: ",g.incoming," • DC ",g.dc," • Roll CUF (no bonus/penalty dice)"]}),e.jsx("button",{style:re.buttonSecondary,onClick:()=>void P(g.incoming),children:"Roll Crucible"})]}),g&&g.status==="success"&&e.jsxs("div",{style:re.crucibleBox,children:[e.jsx("div",{style:{fontWeight:700},children:"Crucible succeeded!"}),e.jsx("div",{style:{fontSize:12,opacity:.85},children:"Choose an Indomitable effect. (Indomitable checked automatically.)"})]}),g&&g.status==="fail"&&e.jsxs("div",{style:re.crucibleBox,children:[e.jsx("div",{style:{fontWeight:700},children:"Crucible failed"}),e.jsx("div",{style:{fontSize:12,opacity:.85},children:"You’ve entered PTSD range (6–8 stress)."}),e.jsx("button",{style:re.buttonSecondary,onClick:X,children:"Spend 1 CUF to pass"})]})]})]}),e.jsxs("div",{style:{display:"flex",gap:8,alignItems:"center",marginBottom:10},children:[e.jsx(we,{label:"Core",active:y==="core",onClick:()=>h("core")}),e.jsx(we,{label:"Skills",active:y==="skills",onClick:()=>h("skills")}),e.jsx(we,{label:"Combat",active:y==="combat",onClick:()=>h("combat")}),e.jsx(we,{label:"Initiative",active:y==="initiative",onClick:()=>h("initiative")}),e.jsx(we,{label:"Inventory",active:y==="inventory",onClick:()=>h("inventory")}),e.jsx(we,{label:"Feats",active:y==="feats",onClick:()=>h("feats")}),e.jsx("div",{style:{marginLeft:"auto",opacity:.8},children:T?"Saving…":"Synced"})]}),e.jsxs("div",{style:{border:"1px solid #888",borderRadius:12,padding:10},children:[y==="core"&&e.jsx(Gt,{sheet:pe,onChange:o=>M(i=>({...i,...o}))}),y==="skills"&&e.jsx(Kt,{sheet:pe,skillMods:te,onChange:o=>M(i=>({...i,skills:o})),onMetaChange:o=>M(i=>({...i,...o}))}),y==="combat"&&e.jsx(sa,{sheet:pe,tokenId:t.tokenId,skillMods:te,onChange:o=>M(i=>({...i,...o})),onApplyStress:m,combatLog:K,onApplyCombatLog:t.mode==="my"?oe:void 0,isGM:v}),y==="initiative"&&e.jsx(xa,{}),y==="inventory"&&e.jsx(fa,{sheet:pe,onChange:o=>M(i=>({...i,...o}))}),y==="feats"&&e.jsx(Vt,{sheet:pe,onChange:o=>M(i=>({...i,feats:o}))})]})]})]})}function we(t){return e.jsx("button",{onClick:t.onClick,style:{padding:"6px 10px",borderRadius:999,border:"1px solid #777",cursor:"pointer",background:"transparent",fontWeight:t.active?700:400},children:t.label})}const re={statusBar:{display:"flex",alignItems:"flex-start",justifyContent:"space-between",gap:12,padding:"10px 12px",borderRadius:12,border:"1px solid rgba(255,255,255,0.15)",marginBottom:10},statusLeft:{display:"flex",alignItems:"center",gap:16,flexWrap:"wrap"},statusRight:{display:"flex",alignItems:"center",gap:12},statusGroup:{display:"flex",flexDirection:"column",gap:4},statusLabel:{fontSize:11,opacity:.75,letterSpacing:.2},statusNumber:{width:64,fontSize:16},woundsRow:{display:"flex",alignItems:"center",gap:8,flexWrap:"wrap"},woundsKind:{fontSize:11,opacity:.75,width:14,textAlign:"center"},warning:{marginTop:8,fontSize:12,opacity:.9},crucibleBox:{border:"1px solid rgba(255,255,255,0.18)",borderRadius:12,padding:10,maxWidth:240},buttonSecondary:{padding:"6px 10px",borderRadius:8,border:"1px solid #999",cursor:"pointer",opacity:.9,background:"transparent"}};function pa(t){var K,F,N,ae,ie,oe,se,u;const r=((t==null?void 0:t.mode)??"LIGHT")==="DARK"?"dark":"light",y=((K=t==null?void 0:t.background)==null?void 0:K.default)??(r==="dark"?"#121212":"#ffffff"),h=((F=t==null?void 0:t.background)==null?void 0:F.paper)??(r==="dark"?"#1e1e1e":"#f7f7f7"),T=((N=t==null?void 0:t.text)==null?void 0:N.primary)??(r==="dark"?"#ffffff":"#111111"),S=((ae=t==null?void 0:t.text)==null?void 0:ae.secondary)??(r==="dark"?"#bdbdbd":"#444444"),g=((ie=t==null?void 0:t.primary)==null?void 0:ie.main)??"#2f6fed",l=((oe=t==null?void 0:t.primary)==null?void 0:oe.contrastText)??"#ffffff",v=((se=t==null?void 0:t.secondary)==null?void 0:se.main)??"#7c3aed",B=((u=t==null?void 0:t.secondary)==null?void 0:u.contrastText)??"#ffffff";return Ut({palette:{mode:r,background:{default:y,paper:h},text:{primary:T,secondary:S},primary:{main:g,contrastText:l},secondary:{main:v,contrastText:B}},shape:{borderRadius:12},typography:{fontFamily:"system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif"},components:{MuiPaper:{defaultProps:{elevation:0}},MuiButton:{styleOverrides:{root:{color:T},containedPrimary:{color:l},containedSecondary:{color:B}}}}})}function ya(t){const[r,y]=k.useState(null);k.useEffect(()=>{let T=null,S=!1;return q.onReady(async()=>{if(!S)try{const g=await q.theme.getTheme();S||y(g),T=q.theme.onChange(l=>y(l))}catch{}}),()=>{S=!0,T&&T()}},[]);const h=k.useMemo(()=>pa(r),[r]);return e.jsxs(Ot,{theme:h,children:[e.jsx(qt,{}),t.children]})}async function ba(){await q.onReady(async()=>{}),Mt.createRoot(document.getElementById("root")).render(e.jsx(Me.StrictMode,{children:e.jsx(ya,{children:e.jsx(ga,{})})}))}ba();
