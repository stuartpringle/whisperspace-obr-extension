import{r as Ye,b as Ae,c as ht,s as ue,F as ft,a as st,o as xt,l as De,T as rt,d as pt,e as yt,f as gt,g as bt,h as it,i as Xe,j as Pe,k as Ge,m as we,n as kt,u as vt,p as jt,q as wt,t as Le,v as _e,w as Ze,x as je,y as et,z as Ct,D as St}from"./statusEffects-BW_hrCqQ.js";import{r as k,j as e,d as Ce,e as It}from"./vendor_react-XzhcIodj.js";import{O as U}from"./vendor_obr-BLY5dk8V.js";import{S as O,B as R,T as S,a as Ne,b as X,c as x,d as fe,I as ie,C as Se,R as Mt,A as Ie,e as Me,E as Te,f as Re,g as xe,h as lt,i as pe,P as Tt,D as ze,M as he,j as ot,k as Rt,l as Dt,m as Et,L as Pt,n as At,o as Nt,p as zt,q as Wt,r as Ft,s as Lt,t as _t,u as Bt,v as Ot}from"./vendor_mui-TXCeMNq_.js";import"./vendor_zod-CxP395f9.js";import"./vendor-CPvQcOsy.js";import"./vendor_emotion-pcfylbOS.js";async function qt(){const a=await U.player.getSelection();return Array.isArray(a)?a:[]}async function $t(){const a=await qt();return a.length>0?a[0]:null}async function Be(a){return(await U.scene.items.getItems([a])).length>0}function Ut(a){var p;const i=a.sheet,[g,b]=k.useState(0),T=k.useMemo(()=>i.attributes??{phys:0,ref:0,soc:0,ment:0},[i.attributes]);async function w(d,j){const H=Number(T[d]??0),Z=Ae({netDice:g,modifier:H,label:j});await Ye({diceNotation:Z,showResults:!0,rollTarget:"everyone"})}return e.jsxs(O,{spacing:2,children:[e.jsxs(R,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",gap:2,flexWrap:"wrap"},children:[e.jsx(S,{variant:"h6",sx:{m:0},children:"Core"}),e.jsxs(R,{sx:{display:"flex",alignItems:"center",gap:1,flexWrap:"wrap"},children:[e.jsx(S,{variant:"subtitle2",sx:{opacity:.8},children:"Attribute Roll:"}),e.jsxs(Ne,{size:"small",exclusive:!0,value:g,onChange:(d,j)=>{j!==null&&b(j)},children:[e.jsx(X,{value:-2,children:"−2"}),e.jsx(X,{value:-1,children:"−1"}),e.jsx(X,{value:0,children:"0"}),e.jsx(X,{value:1,children:"+1"}),e.jsx(X,{value:2,children:"+2"})]})]})]}),e.jsx(x,{label:"Name",size:"small",value:i.name??"",onChange:d=>a.onChange({name:d.target.value}),fullWidth:!0}),e.jsxs(R,{sx:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:1},children:[e.jsx(Ee,{label:"PHYS",value:T.phys,onRoll:()=>w("phys","PHYS Check")}),e.jsx(Ee,{label:"REF",value:T.ref,onRoll:()=>w("ref","REF Check")}),e.jsx(Ee,{label:"SOC",value:T.soc,onRoll:()=>w("soc","SOC Check")}),e.jsx(Ee,{label:"MENT",value:T.ment,onRoll:()=>w("ment","MENT Check")})]}),e.jsxs(R,{sx:{display:"grid",gridTemplateColumns:"repeat(3, 1fr)",gap:2},children:[e.jsx(x,{label:"Cool Under Fire",size:"small",value:((p=a.sheet.stress)==null?void 0:p.cuf)??0,inputProps:{readOnly:!0},fullWidth:!0}),e.jsx(x,{label:"Speed",size:"small",value:30+(T.phys??0)*5,inputProps:{readOnly:!0},fullWidth:!0}),e.jsx(x,{label:"Carrying Capacity",size:"small",value:5+(T.phys??0)*5,inputProps:{readOnly:!0},fullWidth:!0})]}),e.jsx(S,{variant:"body2",sx:{opacity:.75},children:"Attributes are derived automatically from skill ranks (¼ of total ranks under each attribute, rounded up)."})]})}function Ee(a){return e.jsxs(R,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(x,{label:a.label,size:"small",value:a.value,inputProps:{readOnly:!0},fullWidth:!0}),e.jsx(fe,{title:"Roll with Dice+",children:e.jsx(ie,{onClick:a.onRoll,"aria-label":`Roll ${a.label}`,children:e.jsx(Se,{})})})]})}const Ht=["phys","ref","soc","ment"],Oe={phys:"PHYSIQUE",ref:"REFLEX",soc:"SOCIAL",ment:"MENTAL"},qe={combat:"Combat",education:"Education",vehicles:"Vehicles"},tt={combat:"Combat Focus",education:"Education Focus",vehicles:"Vehicles Focus"};function $e(a){const i=ct(a,0,5);return i*(i+1)/2}function Gt(a){const[i,g]=k.useState(""),[b,T]=k.useState(0),[w,p]=k.useState(!0),[d,j]=k.useState(!1),[H,Z]=k.useState(""),W=a.sheet.skills??{},ee=a.sheet.learningFocus??"combat",oe=Number(a.sheet.skillPoints??0);k.useEffect(()=>{let c=!1;return(async()=>{const f=await ht();c||(p(f),j(!0))})().catch(()=>{c||(p(!1),j(!0))}),()=>{c=!0}},[]);const ce=k.useMemo(()=>{const c=new Map;return Object.keys(ue.learned).forEach(f=>{(ue.learned[f]??[]).forEach(z=>c.set(z.id,{focus:f}))}),c},[]);function G(c){const f=ce.get(c.id);return f?f.focus===ee?5:2:5}function ne(c){var J;const f=W[c.id]??0,z=((J=a.skillMods)==null?void 0:J[c.id])??0;if(f>0)return f+z;const q=ce.get(c.id);return q&&q.focus===ee?0+z:-1+z}const u=k.useMemo(()=>{let c=0;for(const f of Object.values(W))c+=$e(f??0);return c},[W]),t=Math.max(0,oe-u),r=c=>{const f=Math.max(0,Math.trunc(Number(H)));if(!f)return;const z=oe+c*f,q=Math.max(u,z);a.onMetaChange({skillPoints:q}),Z("")};function m(c){a.onChange(c)}function M(c,f){const z=W[c.id]??0,q=G(c),J=ct(f,0,q);if(J===z||$e(J)-$e(z)>t)return;const se={...W};J===0?delete se[c.id]:se[c.id]=J,m(se)}async function _(c){const f=Ae({netDice:b,modifier:ne(c),label:c.label});try{await Ye({diceNotation:f,showResults:!0,rollTarget:"everyone"})}catch(z){console.error("Dice+ roll request failed:",z)}}const h=k.useMemo(()=>{const c=Object.values(ue.learned).flat();return[...ue.inherent,...c]},[]),A=k.useMemo(()=>{const c=i.trim().toLowerCase();return c?h.filter(f=>f.label.toLowerCase().includes(c)||f.id.toLowerCase().includes(c)):h},[h,i]),V=k.useMemo(()=>Yt(ue.inherent),[]),Y=k.useMemo(()=>ue.learned,[]),le=i.trim().length>0,Q=e.jsxs(R,{sx:{display:"flex",alignItems:"center",gap:2,flexWrap:"wrap"},children:[e.jsx(S,{variant:"subtitle2",sx:{opacity:.8},children:"Learning Focus:"}),Object.keys(tt).map(c=>e.jsxs(R,{sx:{display:"flex",alignItems:"center",gap:.5,cursor:"pointer"},onClick:()=>a.onMetaChange({learningFocus:c}),children:[e.jsx(Mt,{checked:ee===c,value:c,size:"small"}),e.jsx(S,{variant:"body2",children:qe[c]})]},c))]}),K=e.jsx(R,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",gap:2,flexWrap:"wrap"},children:e.jsxs(R,{sx:{display:"flex",alignItems:"center",gap:1,flexWrap:"wrap"},children:[e.jsxs(S,{variant:"subtitle2",sx:{minWidth:170},children:["Skill Points: ",t," ",e.jsxs("span",{style:{opacity:.75},children:["(Total: ",oe,")"]})]}),e.jsx(xe,{size:"small",variant:"outlined",onClick:()=>r(1),disabled:!Number.isFinite(Number(H))||Math.trunc(Number(H))<=0,children:"+"}),e.jsx(x,{label:"SP",size:"small",type:"number",value:H,onChange:c=>Z(c.target.value),sx:{width:110}}),e.jsx(xe,{size:"small",variant:"outlined",onClick:()=>r(-1),disabled:!Number.isFinite(Number(H))||Math.trunc(Number(H))<=0,children:"-"}),e.jsx(S,{variant:"subtitle2",sx:{opacity:.8},children:"Roll"}),e.jsxs(Ne,{size:"small",exclusive:!0,value:b,onChange:(c,f)=>{f!==null&&T(f)},"aria-label":"Bonus / Penalty dice",children:[e.jsx(X,{value:-2,children:"−2"}),e.jsx(X,{value:-1,children:"−1"}),e.jsx(X,{value:0,children:"0"}),e.jsx(X,{value:1,children:"+1"}),e.jsx(X,{value:2,children:"+2"})]}),d&&!w&&e.jsx(S,{variant:"caption",sx:{opacity:.8},children:"(Dice+ not detected)"})]})});return e.jsxs(O,{spacing:2,children:[Q,e.jsx(x,{label:"Search skills",value:i,onChange:c=>g(c.target.value),placeholder:"stealth, weapons, navigation…",fullWidth:!0}),K,le?e.jsx(O,{spacing:1,children:A.map(c=>{const f=ce.get(c.id),z=f?qe[f.focus]:Oe[c.attribute];return e.jsx(Ue,{skill:c,rank:W[c.id]??0,modifier:ne(c),maxRank:G(c),onRank:q=>M(c,q),rightTag:z,canRoll:w,onRoll:()=>_(c)},c.id)})}):e.jsxs(e.Fragment,{children:[e.jsx(S,{variant:"subtitle1",children:"Inherent Skills"}),Ht.map(c=>e.jsxs(Ie,{defaultExpanded:!0,children:[e.jsx(Me,{expandIcon:e.jsx(Te,{}),children:e.jsx(S,{fontWeight:700,children:Oe[c]})}),e.jsx(Re,{children:e.jsx(O,{spacing:1,children:(V[c]??[]).map(f=>e.jsx(Ue,{skill:f,rank:W[f.id]??0,modifier:ne(f),maxRank:G(f),onRank:z=>M(f,z),rightTag:Oe[f.attribute],canRoll:w,onRoll:()=>_(f)},f.id))})})]},c)),e.jsx(S,{variant:"subtitle1",sx:{mt:1},children:"Learned Skills"}),Object.keys(Y).map(c=>e.jsxs(Ie,{defaultExpanded:!0,children:[e.jsx(Me,{expandIcon:e.jsx(Te,{}),children:e.jsx(S,{fontWeight:700,children:tt[c]})}),e.jsx(Re,{children:e.jsx(O,{spacing:1,children:(Y[c]??[]).map(f=>e.jsx(Ue,{skill:f,rank:W[f.id]??0,modifier:ne(f),maxRank:G(f),onRank:z=>M(f,z),rightTag:qe[c],canRoll:w,onRoll:()=>_(f)},f.id))})})]},c))]})]})}function Ue(a){const i=a.rank<a.maxRank,g=a.rank>0;return e.jsxs(R,{sx:{display:"grid",gridTemplateColumns:"1fr auto auto auto",gap:1,alignItems:"center",border:"1px solid",borderColor:"divider",borderRadius:2,px:1.25,py:1},children:[e.jsxs(R,{sx:{minWidth:0},children:[e.jsx(S,{fontWeight:600,noWrap:!0,children:a.skill.label}),e.jsx(S,{variant:"caption",sx:{opacity:.7},noWrap:!0,children:a.rightTag??""})]}),e.jsxs(R,{sx:{width:46,textAlign:"center"},children:[e.jsx(S,{variant:"caption",sx:{opacity:.7,lineHeight:1},children:"Mod"}),e.jsx(S,{sx:{fontWeight:700,lineHeight:1.2},children:a.modifier>=0?`+${a.modifier}`:`${a.modifier}`})]}),e.jsxs(R,{sx:{width:40,textAlign:"center"},children:[e.jsx(S,{variant:"caption",sx:{opacity:.7,lineHeight:1},children:"Rank"}),e.jsx(S,{sx:{fontWeight:700,lineHeight:1.2},children:a.rank})]}),e.jsxs(R,{sx:{display:"flex",gap:.5,alignItems:"center",justifyContent:"flex-end"},children:[e.jsx(ie,{size:"small",onClick:()=>a.onRank(a.rank-1),"aria-label":"Decrease rank",disabled:!g,children:e.jsx(lt,{fontSize:"small"})}),e.jsx(ie,{size:"small",onClick:()=>a.onRank(a.rank+1),"aria-label":"Increase rank",disabled:!i,children:e.jsx(pe,{fontSize:"small"})}),e.jsx(R,{sx:{width:6}}),e.jsx(fe,{title:a.canRoll?"Roll with Dice+":"Dice+ not detected",children:e.jsx("span",{children:e.jsx(ie,{size:"small",onClick:a.onRoll,"aria-label":`Roll ${a.skill.label}`,disabled:!a.canRoll,children:e.jsx(Se,{fontSize:"small"})})})})]})]})}function Yt(a){return a.reduce((i,g)=>{var b;return(i[b=g.attribute]??(i[b]=[])).push(g),i},{})}function ct(a,i,g){const b=Number.isFinite(a)?Math.trunc(a):i;return Math.max(i,Math.min(g,b))}function Kt(a){const i=a.sheet.feats??[];function g(){a.onChange([...i,{name:"New Feat",description:"",statusEffects:""}])}function b(w,p){const d=[...i];d[w]={...d[w],...p},ft.safeParse(d[w]),a.onChange(d)}function T(w){const p=[...i];p.splice(w,1),a.onChange(p)}return e.jsxs(O,{spacing:2,children:[e.jsxs(O,{direction:"row",justifyContent:"space-between",alignItems:"center",children:[e.jsx(S,{variant:"h6",children:"Feats"}),e.jsx(xe,{variant:"contained",startIcon:e.jsx(pe,{}),onClick:g,children:"Add Feat"})]}),i.length===0?e.jsx(S,{variant:"body2",sx:{opacity:.75},children:"No feats yet."}):e.jsx(O,{spacing:2,children:i.map((w,p)=>e.jsx(Tt,{sx:{p:2},children:e.jsxs(O,{spacing:1.5,children:[e.jsxs(O,{direction:"row",spacing:1,alignItems:"center",children:[e.jsx(x,{label:"Feat Name",fullWidth:!0,value:w.name,onChange:d=>b(p,{name:d.target.value})}),e.jsx(ie,{"aria-label":"Remove feat",onClick:()=>T(p),children:e.jsx(ze,{})})]}),e.jsx(x,{label:"Description",fullWidth:!0,multiline:!0,minRows:4,value:w.description,onChange:d=>b(p,{description:d.target.value})}),e.jsx(x,{label:"Status Effects",fullWidth:!0,helperText:'Comma-separated, e.g. "carrying_capacity+5"',value:w.statusEffects??"",onChange:d=>b(p,{statusEffects:d.target.value})})]})},`${w.name}-${p}`))})]})}const Jt=[{id:"pistol",name:"Pistol",skillId:"weapons_light",useDC:7,damage:2,range:"Med",ammo:10,bulk:1,cost:500},{id:"smart_pistol",name:"SMART Pistol",skillId:"weapons_light",useDC:9,damage:4,range:"Med",ammo:6,bulk:1,keywords:["Smart-Linked"],cost:900},{id:"toxic_spike",name:"Toxic Spike",skillId:"weapons_light",useDC:10,damage:3,range:"Short",ammo:1,bulk:1,keywords:["Toxin (Prax)","Concealable"],cost:750},{id:"smg",name:"SMG",skillId:"weapons_medium",useDC:6,damage:3,range:"Med",ammo:8,bulk:2,keywords:["Bullet Spray"],cost:600},{id:"photon_rifle",name:"Photon Rifle",skillId:"weapons_medium",useDC:8,damage:6,range:"Long",ammo:6,bulk:3,keywords:["Two-Handed"],cost:5e3},{id:"rifle",name:"Rifle",skillId:"weapons_medium",useDC:8,damage:4,range:"Long",ammo:8,bulk:2,keywords:["Two-Handed","Piercing 1"],cost:1e3},{id:"shotgun",name:"Shotgun",skillId:"weapons_medium",useDC:8,damage:4,range:"Short",ammo:4,bulk:3,req:"PHYS 1",keywords:["Point Blank","Shredding 1"],cost:800},{id:"gauss_cannon",name:"Gauss Cannon",skillId:"weapons_heavy",useDC:7,damage:4,range:"Med",ammo:20,bulk:4,req:"PHYS 3",keywords:["Bullet Spray"],cost:900},{id:"grenade_launcher",name:"Grenade Launcher",skillId:"weapons_heavy",useDC:8,damage:3,range:"Med",ammo:1,bulk:3,req:"PHYS 2",keywords:["Area (near)","Two-Handed","Slow Load","Grenade"],cost:2e3},{id:"magneton_cannon",name:"Magneton Cannon",skillId:"weapons_exotic",useDC:5,damage:2,range:"Short",ammo:5,bulk:2,req:"PHYS 1",keywords:["Area (melee)","Slow Load","Shredding 3"],cost:8e3},{id:"tesla_rifle",name:"Tesla Rifle",skillId:"weapons_exotic",useDC:8,damage:5,range:"Med",ammo:6,bulk:2,keywords:["Two-Handed","Stun 2"],cost:6e3},{id:"stun_baton",name:"Stun Baton",skillId:"melee_weapons",useDC:6,damage:0,range:"Melee",bulk:1,keywords:["Stun 1"],cost:450},{id:"switchblade",name:"Switchblade",skillId:"melee_weapons",useDC:9,damage:2,range:"Melee",bulk:1,keywords:["Concealable","Thrown"],cost:150},{id:"fusion_blade",name:"Fusion Blade",skillId:"melee_weapons",useDC:8,damage:3,range:"Melee",bulk:2,req:"REF 2",keywords:["Piercing 2"],cost:1200},{id:"rocket_maul",name:"Rocket Maul",skillId:"melee_weapons",useDC:10,damage:6,range:"Melee",ammo:2,bulk:3,req:"PHYS 3",keywords:["Two-Handed"],cost:2500}],Vt={weapons:Jt},at=Vt.weapons??[],Qt=[{id:"scrap_armour",name:"Scrap Armour",protection:1,durability:2,bulk:2,special:"Cannot be repaired",cost:500},{id:"flak_jacket",name:"Flak Jacket",protection:1,durability:4,bulk:1,cost:1250},{id:"kevlar_clothing",name:"Kevlar Clothing",protection:1,durability:3,bulk:1,special:"Appears to be normal clothing",cost:1500},{id:"streetweave_jacket",name:"Streetweave Jacket",protection:1,durability:5,bulk:1,special:"+1 to Stealth",cost:2500},{id:"milsec_bodyplate",name:"MilSec Bodyplate",protection:2,durability:6,bulk:2,cost:5e3},{id:"breaching_plate",name:"Breaching plate",protection:2,durability:4,bulk:3,req:"PHYS 2",special:"Frontal Shielding 1",cost:8500},{id:"heavy_bodyplate",name:"Heavy Bodyplate",protection:3,durability:8,bulk:4,req:"PHYS 3",special:"+1 penalty die to Stealth",cost:1e4},{id:"basic_power_armour",name:"Basic Power Armour",protection:4,durability:14,bulk:10,req:"Power Armour 1",special:`Requires Power Armour (DC5) check to activate. Failure: become Immobile; gain +1 penalty die to all PHYS and REF based checks. When activated, reduces its own bulk to 1 and grants +1 bonus die to all PHYS based checks.
`,cost:4e4}],Xt={armor:Qt},nt=Xt.armor??[],dt="whisperspace.obr.sheet/combat-log";function Zt(a){return a>=9?4:a>=7?3:a>=4?2:0}async function ea(a){const i=Number.isFinite(a.useDC)?Math.trunc(a.useDC):Math.trunc(a.weapon.useDC),g=a.weapon.name||"Attack",b=Ae({netDice:a.netDice,modifier:a.modifier,label:g}),T=await st({diceNotation:b,rollTarget:a.rollTarget??"everyone",showResults:a.showResults??!0}),w=T-i,p=T>=i,d=p?Zt(w):0,j=p&&d>0,H=Math.trunc(a.weapon.damage??0),Z=p?H+d:0;let W;return p?j?W=`Extreme success - crit! ${g} rolled ${T} vs DC ${i}. Damage: ${H}+${d}=${Z}. (+1 Stress)`:W=`Hit. ${g} rolled ${T} vs DC ${i}. Damage: ${H}.`:W=`Miss. ${g} rolled ${T} vs DC ${i}.`,a.prefix&&(W=`${a.prefix} ${W}`),U.broadcast.sendMessage(dt,{text:W,ts:Date.now()},{destination:"ALL"}),{total:T,useDC:i,margin:w,hit:p,isCrit:j,critExtra:d,baseDamage:H,totalDamage:Z,message:W}}const ut=ea;function ta(){const a=new Map;return Object.keys(ue.learned).forEach(i=>{(ue.learned[i]??[]).forEach(g=>a.set(g.id,{focus:i}))}),a}function aa(a){var K,c,f,z,q,J,D,se,me,ge,be,ke;const i=a.sheet,[g,b]=k.useState(0),[T,w]=k.useState(null),[p,d]=k.useState(""),[j,H]=k.useState(!1),Z=k.useMemo(()=>ta(),[]),W=k.useMemo(()=>{const o=Object.values(ue.learned).flat();return[...ue.inherent,...o]},[]),ee=new Set(["melee_weapons","melee_unarmed","weapons_light","weapons_medium","weapons_heavy","weapons_exotic","explosives"]),oe=W.filter(o=>ee.has(o.id));k.useMemo(()=>[...W].sort((o,l)=>o.label.localeCompare(l.label)),[W]);const ce=i.learningFocus??"combat";function G(){var Je,Ve;const o=Number(p),l=Number.isFinite(o)?Math.max(0,Math.trunc(o)):0;if(l<=0)return;const n=a.sheet.armor,s=(((Je=n==null?void 0:n.durability)==null?void 0:Je.current)??0)<=0,y=j||s?0:(n==null?void 0:n.protection)??0,v=Math.max(0,l-y),C=a.sheet.wounds??{light:0,moderate:0,heavy:0};let E=C.light??0,N=C.moderate??0,F=C.heavy??0,I=v,B=0,$=0,te=0;const P=Math.min(I,Math.max(0,4-E));E+=P,I-=P,B=P;const re=Math.min(I,Math.max(0,2-N));N+=re,I-=re,$=re;const Fe=Math.min(I,Math.max(0,1-F));F+=Fe,I-=Fe,te=Fe;const mt={light:E,moderate:N,heavy:F};let ve=0;te>0?ve=4:$>0?ve=2:B>0&&(ve=1);let Ke=n;if(!j&&!s&&v>0&&(n!=null&&n.durability)&&(Ke={...n,durability:{...n.durability,current:Math.max(0,Math.trunc((n.durability.current??0)-1))}}),a.onChange({wounds:mt,armor:Ke}),ve>0){const Qe=(((Ve=a.sheet.stress)==null?void 0:Ve.current)??0)+ve;a.onApplyStress?a.onApplyStress(Qe):a.onChange({stress:{...a.sheet.stress,current:Qe}})}d("")}function ne(o){var v,C;const l=((v=i.skills)==null?void 0:v[o])??0,n=((C=a.skillMods)==null?void 0:C[o])??0;if(l>0)return l+n;const s=Z.get(o);return(s&&s.focus===ce?0:-1)+n}function u(o){var s;const l=(s=o.keywordParams)==null?void 0:s.ammoMax,n=typeof l=="number"?l:typeof l=="string"?Number(l):void 0;return Number.isFinite(n)?Number(n):0}function t(o,l){const n=[...i.weapons??[]],s=n[o];if(l.ammo!==void 0&&!u(s)&&l.ammo>0){const v={...s.keywordParams??{},ammoMax:l.ammo};n[o]={...s,...l,keywordParams:v},a.onChange({weapons:n});return}n[o]={...s,...l},a.onChange({weapons:n})}function r(o,l){if(o===null||o===l)return;const n=a.sheet.weapons??[];if(o<0||o>=n.length||l<0||l>=n.length)return;const s=[...n],[y]=s.splice(o,1);s.splice(l,0,y),a.onChange({weapons:s}),w(l)}function m(o){const l=at.find(s=>s.id===o);if(!l)return;const n=[...i.weapons??[]];n.push({name:l.name,skillId:l.skillId,useDC:l.useDC,damage:l.damage,range:l.range,ammo:l.ammo,bulk:l.bulk,req:l.req,cost:l.cost,keywords:[...l.keywords??[]],keywordParams:{ammoMax:l.ammo??0,...l.keywordParams??{}}}),a.onChange({weapons:n})}function M(){const o=[...i.weapons??[]];o.push({name:"New Weapon",skillId:"weapons_medium",useDC:8,damage:3,range:"Med",ammo:0,bulk:1,req:"",cost:0,keywords:[],keywordParams:{ammoMax:0}}),a.onChange({weapons:o})}function _(o){const l=[...i.weapons??[]];l.splice(o,1),a.onChange({weapons:l})}async function h(o,l){const n=u(l),s=Number.isFinite(l.ammo)?Number(l.ammo):0;if(n>0&&s<=0){U.notification.show("Out of ammo. Reload first.","WARNING");return}const y=ne(l.skillId);await ut({weapon:l,useDC:Number.isFinite(l.useDC)?Number(l.useDC):0,netDice:g,modifier:y,rollTarget:"everyone",showResults:!0}),n>0&&t(o,{ammo:Math.max(0,s-1)})}const[A,V]=k.useState(""),[Y,le]=k.useState("");function Q(o){const l=nt.find(n=>n.id===o);l&&a.onChange({armor:{name:l.name,keywords:[...l.keywords??[]],keywordParams:{...l.keywordParams??{}},protection:l.protection,durability:{current:l.durability,max:l.durability},bulk:l.bulk,req:l.req,cost:l.cost,special:l.special}})}return e.jsxs(O,{spacing:2,children:[e.jsx(R,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",gap:2,flexWrap:"wrap"},children:e.jsx(S,{variant:"h6",sx:{m:0},children:"Combat"})}),e.jsxs(R,{sx:{display:"flex",alignItems:"center",gap:1,flexWrap:"wrap"},children:[e.jsx(S,{variant:"subtitle2",sx:{opacity:.8},children:"Take Damage:"}),e.jsx(x,{size:"small",type:"number",inputProps:{min:0},value:p,onChange:o=>d(o.target.value),sx:{width:90}}),e.jsx(X,{size:"small",value:"unmitigated",selected:j,onChange:()=>H(o=>!o),children:"Unmitigated"}),e.jsx(xe,{size:"small",variant:"outlined",onClick:G,children:"Apply"})]}),e.jsxs(R,{sx:{display:"flex",alignItems:"center",gap:1,flexWrap:"wrap"},children:[e.jsx(S,{variant:"subtitle2",sx:{opacity:.8},children:"Attack Roll:"}),e.jsxs(Ne,{size:"small",exclusive:!0,value:g,onChange:(o,l)=>{l!==null&&b(l)},children:[e.jsx(X,{value:-2,children:"−2"}),e.jsx(X,{value:-1,children:"−1"}),e.jsx(X,{value:0,children:"0"}),e.jsx(X,{value:1,children:"+1"}),e.jsx(X,{value:2,children:"+2"})]})]}),e.jsxs(Ie,{defaultExpanded:!0,children:[e.jsx(Me,{expandIcon:e.jsx(Te,{}),children:e.jsx(S,{fontWeight:700,children:"Weapons"})}),e.jsx(Re,{children:e.jsxs(O,{spacing:1.5,children:[e.jsxs(R,{sx:{display:"flex",gap:1,alignItems:"center",flexWrap:"wrap"},children:[e.jsxs(x,{label:"Add prefab weapon",size:"small",select:!0,value:A,onChange:o=>V(o.target.value),sx:{minWidth:240},children:[e.jsx(he,{value:"",children:"— choose —"}),at.map(o=>e.jsx(he,{value:o.id,children:o.name},o.id))]}),e.jsx(ie,{color:"primary",onClick:()=>m(A),"aria-label":"Add prefab weapon",disabled:!A,children:e.jsx(pe,{})}),e.jsx(R,{sx:{flex:1}}),e.jsx(ie,{color:"primary",onClick:M,"aria-label":"Add custom weapon",children:e.jsx(pe,{})}),e.jsx(S,{variant:"body2",sx:{opacity:.75},children:"Add custom weapon"})]}),(i.weapons??[]).length===0?e.jsx(S,{sx:{opacity:.75},children:"No weapons yet."}):(i.weapons??[]).map((o,l)=>e.jsxs(R,{draggable:!0,onDragStart:()=>w(l),onDragEnd:()=>w(null),onDragOver:n=>{n.preventDefault()},onDrop:n=>{n.preventDefault(),r(T,l)},sx:{border:"1px solid",borderColor:"divider",borderRadius:2,p:1.25,cursor:"grab",opacity:T===l?.85:1,display:"grid",gap:1.25},children:[e.jsxs(R,{sx:{display:"flex",gap:1,alignItems:"center"},children:[e.jsx(x,{label:"Name",size:"small",value:o.name,onChange:n=>t(l,{name:n.target.value}),fullWidth:!0}),e.jsx(fe,{title:"Roll attack with Dice+",children:e.jsx(ie,{onClick:()=>h(l,o),"aria-label":`Roll attack for ${o.name}`,children:e.jsx(Se,{})})}),e.jsx(ie,{onClick:()=>_(l),"aria-label":"Remove weapon",children:e.jsx(ze,{})})]}),e.jsxs(R,{sx:{display:"grid",gridTemplateColumns:"1fr 1fr 1fr 1fr",gap:1},children:[e.jsx(x,{label:"Skill",size:"small",select:!0,value:o.skillId,onChange:n=>t(l,{skillId:n.target.value}),children:oe.map(n=>e.jsx(he,{value:n.id,children:n.label},n.id))}),e.jsx(x,{label:"Use DC",size:"small",type:"number",value:o.useDC,onChange:n=>t(l,{useDC:Number(n.target.value)})}),e.jsx(x,{label:"Damage",size:"small",type:"number",value:o.damage,onChange:n=>t(l,{damage:Number(n.target.value)})}),e.jsx(x,{label:"Range",size:"small",value:o.range??"",onChange:n=>t(l,{range:n.target.value}),placeholder:"Melee / Short / Med / Long"}),e.jsxs(R,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(x,{label:"Ammo",size:"small",type:"number",value:o.ammo??0,onChange:n=>t(l,{ammo:Number(n.target.value)}),sx:{width:110}}),e.jsxs(S,{variant:"body2",sx:{opacity:.8},children:["/ ",u(o)||0]}),e.jsx(fe,{title:"Reload",children:e.jsx("span",{children:e.jsx(ie,{size:"small",onClick:()=>t(l,{ammo:u(o)||0}),disabled:(u(o)||0)<=0,children:e.jsx(ot,{fontSize:"small"})})})})]}),e.jsx(x,{label:"Bulk",size:"small",type:"number",value:o.bulk??0,onChange:n=>t(l,{bulk:Number(n.target.value)})}),e.jsx(x,{label:"Req.",size:"small",value:o.req??"",onChange:n=>t(l,{req:n.target.value}),placeholder:"PHYS 1 / REF 2 / etc"}),e.jsx(x,{label:"Keywords (comma)",size:"small",value:(o.keywords??[]).join(", "),onChange:n=>t(l,{keywords:n.target.value.split(",").map(s=>s.trim()).filter(Boolean)}),placeholder:"Two-Handed, Piercing 1",sx:{gridColumn:"1 / -1"}})]})]},o.id??`${o.name}-${l}`))]})})]}),e.jsxs(Ie,{defaultExpanded:!0,children:[e.jsx(Me,{expandIcon:e.jsx(Te,{}),children:e.jsx(S,{fontWeight:700,children:"Armor"})}),e.jsx(Re,{children:e.jsxs(O,{spacing:1.5,children:[e.jsxs(R,{sx:{display:"flex",gap:1,alignItems:"center",flexWrap:"wrap"},children:[e.jsxs(x,{label:"Set prefab armor",size:"small",select:!0,value:Y,onChange:o=>le(o.target.value),sx:{minWidth:240},children:[e.jsx(he,{value:"",children:"— choose —"}),nt.map(o=>e.jsx(he,{value:o.id,children:o.name},o.id))]}),e.jsx(ie,{color:"primary",onClick:()=>Q(Y),"aria-label":"Set prefab armor",disabled:!Y,children:e.jsx(pe,{})})]}),e.jsxs(R,{sx:{border:"1px solid",borderColor:"divider",borderRadius:2,p:1.25},children:[e.jsxs(R,{sx:{display:"grid",gridTemplateColumns:"2fr 1fr 1fr 1fr",gap:1},children:[e.jsx(x,{label:"Name",size:"small",value:((K=i.armor)==null?void 0:K.name)??"",onChange:o=>a.onChange({armor:{...i.armor??{durability:{current:0,max:0},protection:0,keywords:[],keywordParams:{ammoMax:0}},name:o.target.value}})}),e.jsx(x,{label:"Protection",size:"small",type:"number",value:((c=i.armor)==null?void 0:c.protection)??0,onChange:o=>a.onChange({armor:{...i.armor??{name:"",durability:{current:0,max:0},keywords:[],keywordParams:{}},protection:Number(o.target.value)}})}),e.jsx(x,{label:"Durability (cur)",size:"small",type:"number",value:((f=i.armor)==null?void 0:f.durability.current)??0,onChange:o=>{var l;return a.onChange({armor:{...i.armor??{name:"",durability:{current:0,max:0},protection:0,keywords:[],keywordParams:{}},durability:{...((l=i.armor)==null?void 0:l.durability)??{current:0,max:0},current:Number(o.target.value)}}})}}),e.jsx(x,{label:"Durability (max)",size:"small",type:"number",value:((z=i.armor)==null?void 0:z.durability.max)??0,onChange:o=>{var l;return a.onChange({armor:{...i.armor??{name:"",durability:{current:0,max:0},protection:0,keywords:[],keywordParams:{}},durability:{...((l=i.armor)==null?void 0:l.durability)??{current:0,max:0},max:Number(o.target.value)}}})}})]}),(((J=(q=i.armor)==null?void 0:q.durability)==null?void 0:J.max)??0)>0&&(((se=(D=i.armor)==null?void 0:D.durability)==null?void 0:se.current)??0)<=0&&e.jsx(S,{sx:{mt:1},color:"error",variant:"body2",children:"Broken: armor provides no Protection until repaired."}),e.jsxs(R,{sx:{display:"grid",gridTemplateColumns:"1fr 1fr 1fr 2fr",gap:1,mt:1},children:[e.jsx(x,{label:"Bulk",size:"small",type:"number",value:((me=i.armor)==null?void 0:me.bulk)??0,onChange:o=>a.onChange({armor:{...i.armor??{name:"",durability:{current:0,max:0},protection:0,keywords:[],keywordParams:{}},bulk:Number(o.target.value)}})}),e.jsx(x,{label:"Req.",size:"small",value:((ge=i.armor)==null?void 0:ge.req)??"",onChange:o=>a.onChange({armor:{...i.armor??{name:"",durability:{current:0,max:0},protection:0,keywords:[],keywordParams:{}},req:o.target.value}})}),e.jsx(x,{label:"Special",size:"small",value:((be=i.armor)==null?void 0:be.special)??"",onChange:o=>a.onChange({armor:{...i.armor??{name:"",durability:{current:0,max:0},protection:0,keywords:[],keywordParams:{}},special:o.target.value}})})]}),e.jsx(R,{sx:{mt:1},children:e.jsx(x,{label:"Keywords (comma)",size:"small",fullWidth:!0,value:(((ke=i.armor)==null?void 0:ke.keywords)??[]).join(", "),onChange:o=>a.onChange({armor:{...i.armor??{name:"",durability:{current:0,max:0},protection:0,keywords:[],keywordParams:{}},keywords:o.target.value.split(",").map(l=>l.trim()).filter(Boolean)}}),placeholder:"Frontal Shielding 1"})})]})]})})]})]})}const na=[{name:"Flashbang Grenade",effect:"Applies Stun 1 to everyone within near range, Thrown",uses:"1 use",bulk:1,cost:200},{name:"Frag Grenade",effect:"Deals 2 area (near range) damage (DC8 to Evade half), Thrown",uses:"1 use",bulk:1,cost:250},{name:"EMP Grenade",effect:"Applies EMP 2 to everything within range, Thrown",uses:"1 use",bulk:1,cost:300},{name:"Combat Stim Injector",effect:"Gain +1 action & -1 Stress; take 1 wound after effect ends",uses:"1 use",bulk:1,cost:200},{name:"Basic Medkit",effect:"Right tool for the job: First Aid checks",uses:"3 uses",bulk:1,cost:350},{name:"Multitool",effect:"Allows engineering checks to repair, bypass, scrap, etc.",uses:"Permanent",bulk:1,cost:750},{name:"Repair Kit",effect:"Provides materials and tools for repairs",uses:"10 uses",bulk:1,cost:500},{name:"Tracker",effect:"While within 10km, always know location of this device",uses:"1 use",bulk:1,cost:250},{name:"Portable Scanner",effect:"Right tool for the job: Observe (tech, lifeforms)",uses:"Permanent",bulk:1,cost:400},{name:"Weapon Scope",effect:"Simple Modification. Grants +1 bonus die to called shots at medium range and farther; inflicts +1 penalty die to attacks at close range or nearer",uses:"Permanent",bulk:1,cost:750},{name:"Weapon Silencer",effect:"Simple Modification. Weapon makes reduced sound when fired; deals -1 damage",uses:"Permanent",bulk:1,cost:500},{name:"Compact Backpack",effect:"+5 Inventory Slots when worn",uses:"Permanent",bulk:0,cost:150,statusEffects:"carrying_capacity+5"},{name:"Ammo (Flechette)",effect:"Deals +2 damage to unarmoured targets.",uses:"10 rounds",bulk:1,cost:500},{name:"Ammo (SMART)",effect:"Required for Smart-Linked weapons.",uses:"10",bulk:1,cost:1250},{name:"Ammo (Armour Piercing)",effect:"Adds Piercing 1 to attacks.",uses:"10",bulk:1,cost:750},{name:"Ammo (Explosive)",effect:"Adds Shredding 1 to attacks.",uses:"10",bulk:1,cost:750}],sa={items:na},ra=sa.items,ia=[{name:"Reflex Booster",tier:1,effect:"Once per round, gain +1 bonus die to an Evade check.",installationDifficulty:2,requirements:"REF 1",physicalImpact:"Low; spine",bulk:1,cost:3e3},{name:"Targeting Link",tier:1,effect:"Once per round, ignore 1 level of cover when attacking an enemy you can see.",installationDifficulty:2,requirements:"-",physicalImpact:"Medium; eyes",bulk:1,cost:4e3},{name:"Low-Light Optics",tier:1,effect:"Ignore penalty dice caused by darkness within medium range.",installationDifficulty:1,requirements:"-",physicalImpact:"Medium; eyes",bulk:1,cost:2e3},{name:"EMP Shielding",tier:1,effect:"Ignore the effects of EMP once per day.",installationDifficulty:2,requirements:"MENT 1",physicalImpact:"None; torso",bulk:1,cost:3500},{name:"Metabolic Filter",tier:1,effect:"Gain +1 bonus die on checks to resist toxins or narcotics.",installationDifficulty:1,requirements:"PHYS 1",physicalImpact:"Minor; liver",bulk:1,cost:1500},{name:"Compact Databank",tier:2,effect:"Internal information storage device; store/access info at will.",installationDifficulty:2,requirements:"MENT 1",physicalImpact:"Medium; cranium",bulk:1,cost:5e3}],la={cyberware:ia},oa=la.cyberware,ca=[{name:"Space Dust",effect:"Grants +1 bonus die to Observe and Piloting checks for 6 hours",uses:5,addictionScore:1,legality:"Legal",bulk:1,cost:500},{name:"Tranquility",effect:"Reduces stress by 1; penalty die to all REF checks for 6 hours.",uses:2,addictionScore:5,legality:"Legal",bulk:1,cost:5e3},{name:"Smoothe",effect:"Reduces stress by 1d4; increases Cool Under Fire by 2 and grants +1 bonus die to all Mental skill checks for 1 hour",uses:1,addictionScore:8,legality:"Illegal",bulk:1,cost:2e4},{name:"Chemical Strength",effect:"+1 bonus die to all PHYS checks for 1 hour; +1 movement bonus for 1 hour. After 1 hour, +1 penalty die to all PHYS checks and +1 movement penalty until sleep.",uses:1,addictionScore:3,legality:"Illegal",bulk:1,cost:8e3}],da={narcotics:ca},ua=da.narcotics;function ma(){return`inv_${Date.now()}_${Math.random().toString(36).slice(2,9)}`}function ha(a){const i=a.sheet.inventory??[],g=t=>{a.onChange({inventory:t})},[b,T]=k.useState("item"),[w,p]=k.useState(null),[d,j]=k.useState({}),[H,Z]=k.useState(null),[W,ee]=k.useState(null),oe=k.useMemo(()=>b==="item"?ra.map(t=>({type:"item",...t})):b==="cyberware"?oa.map(t=>({type:"cyberware",...t})):ua.map(t=>({type:"narcotics",...t})),[b]);function ce(t){p(t);const r=oe.find(m=>m.name===t);if(!r){j({type:b,name:"",quantity:1,bulk:b==="item"?0:1,effect:"",cost:0,statusEffects:""});return}j(b==="item"?{type:"item",name:r.name,quantity:1,uses:r.uses??"",bulk:r.bulk??0,effect:r.effect??"",cost:r.cost??0,statusEffects:r.statusEffects??""}:b==="cyberware"?{type:"cyberware",name:r.name,quantity:1,bulk:r.bulk??1,tier:r.tier??1,installationDifficulty:r.installationDifficulty??0,requirements:r.requirements??"",physicalImpact:r.physicalImpact??"",effect:r.effect??"",cost:r.cost??0,statusEffects:r.statusEffects??""}:{type:"narcotics",name:r.name,quantity:1,bulk:r.bulk??1,uses:r.uses??1,addictionScore:r.addictionScore??0,legality:r.legality??"",effect:r.effect??"",cost:r.cost??0,statusEffects:r.statusEffects??""})}function G(){const t=[...i,{id:ma(),...d}];a.onChange({inventory:t}),p(null),j({type:b,name:"",quantity:1,bulk:b==="item"?0:1,effect:"",cost:0,statusEffects:""})}function ne(t){a.onChange({inventory:i.filter(r=>r.id!==t)})}function u(t,r){a.onChange({inventory:i.map(m=>m.id===t?{...m,...r}:m)})}return e.jsxs(O,{spacing:2,children:[e.jsx(x,{label:"Credits",type:"number",value:a.sheet.credits??0,onChange:t=>a.onChange({credits:Number(t.target.value)}),size:"small"}),e.jsxs(R,{children:[e.jsx(S,{variant:"subtitle2",sx:{mb:1},children:"Add Inventory"}),e.jsxs(O,{direction:{xs:"column",sm:"row"},spacing:1,alignItems:"center",children:[e.jsxs(x,{select:!0,size:"small",label:"Type",value:b,onChange:t=>{const r=t.target.value;T(r),p(null),j(r==="item"?{type:r,name:"",quantity:1,bulk:0,uses:"",effect:"",cost:0,statusEffects:""}:r==="cyberware"?{type:r,name:"",quantity:1,bulk:1,tier:1,installationDifficulty:0,requirements:"",physicalImpact:"",effect:"",cost:0,statusEffects:""}:{type:r,name:"",quantity:1,bulk:1,uses:1,addictionScore:0,legality:"",effect:"",cost:0,statusEffects:""})},sx:{minWidth:160},children:[e.jsx(he,{value:"item",children:"Item"}),e.jsx(he,{value:"cyberware",children:"Cyberware"}),e.jsx(he,{value:"narcotics",children:"Narcotics"})]}),e.jsx(Rt,{size:"small",sx:{flex:1,minWidth:220},options:oe.map(t=>t.name),value:w,onChange:(t,r)=>ce(r),renderInput:t=>e.jsx(x,{...t,label:"Template (optional)"})}),e.jsx(xe,{variant:"contained",startIcon:e.jsx(pe,{}),onClick:G,disabled:!(d!=null&&d.name),children:"Add"})]}),e.jsx(R,{sx:{mt:1},children:e.jsxs(O,{spacing:1,children:[e.jsxs(O,{direction:{xs:"column",sm:"row"},spacing:1,children:[e.jsx(x,{size:"small",label:"Name",value:(d==null?void 0:d.name)??"",onChange:t=>j(r=>({...r,name:t.target.value})),sx:{flex:1}}),e.jsx(x,{size:"small",type:"number",label:"Bulk",value:(d==null?void 0:d.bulk)??0,onChange:t=>j(r=>({...r,bulk:Number(t.target.value)})),sx:{width:120}}),e.jsx(x,{size:"small",type:"number",label:"Quantity",value:(d==null?void 0:d.quantity)??1,onChange:t=>{const r=Number(t.target.value);Number.isFinite(r)&&j(m=>({...m,quantity:r}))},sx:{width:120}}),e.jsx(x,{size:"small",type:"number",label:"Cost",value:(d==null?void 0:d.cost)??0,onChange:t=>j(r=>({...r,cost:Number(t.target.value)})),sx:{width:140}})]}),b==="item"&&e.jsx(x,{size:"small",label:"Uses",value:(d==null?void 0:d.uses)??"",onChange:t=>j(r=>({...r,uses:t.target.value}))}),b==="cyberware"&&e.jsxs(O,{direction:{xs:"column",sm:"row"},spacing:1,children:[e.jsx(x,{size:"small",type:"number",label:"Tier",value:(d==null?void 0:d.tier)??1,onChange:t=>j(r=>({...r,tier:Number(t.target.value)})),sx:{width:120}}),e.jsx(x,{size:"small",type:"number",label:"Installation Difficulty",value:(d==null?void 0:d.installationDifficulty)??0,onChange:t=>j(r=>({...r,installationDifficulty:Number(t.target.value)})),sx:{width:220}}),e.jsx(x,{size:"small",label:"Requirements",value:(d==null?void 0:d.requirements)??"",onChange:t=>j(r=>({...r,requirements:t.target.value})),sx:{flex:1}})]}),b==="cyberware"&&e.jsx(x,{size:"small",label:"Physical Impact",value:(d==null?void 0:d.physicalImpact)??"",onChange:t=>j(r=>({...r,physicalImpact:t.target.value}))}),b==="narcotics"&&e.jsxs(O,{direction:{xs:"column",sm:"row"},spacing:1,children:[e.jsx(x,{size:"small",type:"number",label:"Uses",value:(d==null?void 0:d.uses)??1,onChange:t=>j(r=>({...r,uses:Number(t.target.value)})),sx:{width:120}}),e.jsx(x,{size:"small",type:"number",label:"Addiction Score",value:(d==null?void 0:d.addictionScore)??0,onChange:t=>j(r=>({...r,addictionScore:Number(t.target.value)})),sx:{width:160}}),e.jsx(x,{size:"small",label:"Legality",value:(d==null?void 0:d.legality)??"",onChange:t=>j(r=>({...r,legality:t.target.value})),sx:{flex:1}})]}),e.jsx(x,{size:"small",label:"Effect",value:(d==null?void 0:d.effect)??"",onChange:t=>j(r=>({...r,effect:t.target.value})),multiline:!0,minRows:2}),e.jsx(x,{size:"small",label:"Status Effects (comma-separated)",value:(d==null?void 0:d.statusEffects)??"",onChange:t=>j(r=>({...r,statusEffects:t.target.value})),placeholder:'e.g. "carrying_capacity+5"'})]})})]}),e.jsxs(R,{children:[e.jsx(S,{variant:"subtitle2",sx:{mb:1},children:"Inventory"}),i.length===0&&e.jsx(S,{variant:"body2",children:"No inventory items yet."}),i.map(t=>{const r=t.quantity??1,M=(t.bulk??0)*r,_=`${t.name} (${t.type}) • bulk ${M}`;return e.jsxs(Ie,{disableGutters:!0,children:[e.jsx(Me,{expandIcon:e.jsx(Te,{}),draggable:!0,onDragStart:h=>{Z(t.id??null);try{h.dataTransfer.effectAllowed="move",h.dataTransfer.setData("text/plain",t.id??"")}catch{}},onDragOver:h=>{h.preventDefault(),ee(t.id??null)},onDragLeave:()=>ee(null),onDrop:h=>{h.preventDefault();const A=H??h.dataTransfer.getData("text/plain"),V=t.id;if(A&&V&&A!==V){const Y=a.sheet.inventory??[],le=Y.findIndex(K=>K.id===A),Q=Y.findIndex(K=>K.id===V);if(le>=0&&Q>=0){const K=[...Y],[c]=K.splice(le,1);K.splice(Q,0,c),g(K)}}Z(null),ee(null)},sx:W===t.id?{outline:"2px dashed rgba(255,255,255,0.35)",borderRadius:1}:void 0,children:e.jsxs(O,{direction:"row",spacing:1,alignItems:"center",sx:{width:"100%"},children:[e.jsx(Dt,{fontSize:"small",sx:{opacity:.5}}),e.jsx(S,{variant:"body2",sx:{flex:1},children:_}),e.jsxs(O,{direction:"row",spacing:.5,alignItems:"center",children:[e.jsx(ie,{size:"small",onClick:h=>{h.stopPropagation();const A=(t.quantity??1)-1;A<=0?ne(t.id):u(t.id,{quantity:A})},children:e.jsx(lt,{fontSize:"small"})}),e.jsx(S,{variant:"caption",sx:{minWidth:18,textAlign:"center"},children:t.quantity??1}),e.jsx(ie,{size:"small",onClick:h=>{h.stopPropagation(),u(t.id,{quantity:(t.quantity??1)+1})},children:e.jsx(pe,{fontSize:"small"})})]}),e.jsx(fe,{title:"Remove",children:e.jsx(ie,{size:"small",onClick:h=>(h.stopPropagation(),ne(t.id)),children:e.jsx(ze,{fontSize:"small"})})})]})}),e.jsx(Re,{children:e.jsxs(O,{spacing:1,children:[e.jsxs(O,{direction:{xs:"column",sm:"row"},spacing:1,children:[e.jsx(x,{size:"small",label:"Name",value:t.name??"",onChange:h=>u(t.id,{name:h.target.value}),sx:{flex:1}}),e.jsxs(x,{select:!0,size:"small",label:"Type",value:t.type,onChange:h=>u(t.id,{type:h.target.value}),sx:{width:160},children:[e.jsx(he,{value:"item",children:"Item"}),e.jsx(he,{value:"cyberware",children:"Cyberware"}),e.jsx(he,{value:"narcotics",children:"Narcotics"})]}),e.jsx(x,{size:"small",type:"number",label:"Bulk",value:t.bulk??0,onChange:h=>u(t.id,{bulk:Number(h.target.value)}),sx:{width:120}}),e.jsx(x,{size:"small",type:"number",label:"Quantity",value:t.quantity??1,onChange:h=>{const A=Number(h.target.value);Number.isFinite(A)&&(A<=0?ne(t.id):u(t.id,{quantity:A}))},sx:{width:120}}),e.jsx(x,{size:"small",type:"number",label:"Cost",value:t.cost??0,onChange:h=>u(t.id,{cost:Number(h.target.value)}),sx:{width:140}})]}),t.type==="item"&&e.jsx(x,{size:"small",label:"Uses",value:t.uses??"",onChange:h=>u(t.id,{uses:h.target.value})}),t.type==="cyberware"&&e.jsxs(O,{direction:{xs:"column",sm:"row"},spacing:1,children:[e.jsx(x,{size:"small",type:"number",label:"Tier",value:t.tier??1,onChange:h=>u(t.id,{tier:Number(h.target.value)}),sx:{width:120}}),e.jsx(x,{size:"small",type:"number",label:"Installation Difficulty",value:t.installationDifficulty??0,onChange:h=>u(t.id,{installationDifficulty:Number(h.target.value)}),sx:{width:220}}),e.jsx(x,{size:"small",label:"Requirements",value:t.requirements??"",onChange:h=>u(t.id,{requirements:h.target.value}),sx:{flex:1}})]}),t.type==="cyberware"&&e.jsx(x,{size:"small",label:"Physical Impact",value:t.physicalImpact??"",onChange:h=>u(t.id,{physicalImpact:h.target.value})}),t.type==="narcotics"&&e.jsxs(O,{direction:{xs:"column",sm:"row"},spacing:1,children:[e.jsx(x,{size:"small",type:"number",label:"Uses",value:t.uses??1,onChange:h=>u(t.id,{uses:Number(h.target.value)}),sx:{width:120}}),e.jsx(x,{size:"small",type:"number",label:"Addiction Score",value:t.addictionScore??0,onChange:h=>u(t.id,{addictionScore:Number(h.target.value)}),sx:{width:160}}),e.jsx(x,{size:"small",label:"Legality",value:t.legality??"",onChange:h=>u(t.id,{legality:h.target.value}),sx:{flex:1}})]}),e.jsx(x,{size:"small",label:"Effect",value:t.effect??"",onChange:h=>u(t.id,{effect:h.target.value}),multiline:!0,minRows:2}),e.jsx(x,{size:"small",label:"Status Effects (comma-separated)",value:t.statusEffects??"",onChange:h=>u(t.id,{statusEffects:h.target.value}),placeholder:'e.g. "carrying_capacity+5"'})]})})]},t.id)})]})]})}function fa(){const a=new Map;return Object.keys(ue.learned).forEach(i=>{(ue.learned[i]??[]).forEach(g=>a.set(g.id,{focus:i}))}),a}function He(a){var b;if(!a)return 0;const i=(b=a.keywordParams)==null?void 0:b.ammoMax,g=typeof i=="number"?i:typeof i=="string"?Number(i):void 0;return Number.isFinite(g)?Number(g):0}function xa(a,i,g,b,T){if(b>0)return b+T;const w=a.get(i);return(w&&w.focus===g?0:-1)+T}function pa(){const[a,i]=k.useState({entries:[],activeTokenId:void 0,updatedAt:Date.now()}),[g,b]=k.useState({}),[T,w]=k.useState(""),[p,d]=k.useState(!1),[j,H]=k.useState(0),Z=u=>Math.max(-3,Math.min(3,u)),W=k.useMemo(()=>fa(),[]);k.useEffect(()=>{const u=xt(t=>i(t));return()=>u==null?void 0:u()},[]),k.useEffect(()=>{let u=!0;return(async()=>{var t,r,m,M;try{const[_,h]=await Promise.all([((r=(t=U.player).getId)==null?void 0:r.call(t))??Promise.resolve(""),((M=(m=U.player).getRole)==null?void 0:M.call(m))??Promise.resolve("")]);if(!u)return;w(String(_??"")),d(String(h).toUpperCase()==="GM")}catch{}})(),()=>{u=!1}},[]);const ee=k.useMemo(()=>{const u=[...a.entries??[]];return u.sort((t,r)=>(r.initiative??0)-(t.initiative??0)),u},[a.entries]);k.useEffect(()=>{let u=!0;return(async()=>{var t,r,m,M,_,h,A;try{const V=ee.map(Q=>Q.tokenId);if(!V.length){u&&b({});return}const Y=await U.scene.items.getItems(V),le={};for(const Q of Y){const K=Q.id,c=await De(K),f=c==null?void 0:c.armor,z=((t=f==null?void 0:f.durability)==null?void 0:t.current)??0,q=!!f&&z<=0,J=q?0:(f==null?void 0:f.protection)??0,D=(r=c==null?void 0:c.weapons)==null?void 0:r[0],se=He(D),me=Number.isFinite(D==null?void 0:D.ammo)?Number(D==null?void 0:D.ammo):0;le[K]={tokenId:K,name:((_=(M=(m=Q.text)==null?void 0:m.plainText)==null?void 0:M.trim)==null?void 0:_.call(M))||(c==null?void 0:c.name)||"(Unnamed)",thumbUrl:(h=Q.image)==null?void 0:h.url,ownerPlayerId:String(((A=Q.metadata)==null?void 0:A[rt])??""),prot:J,armorBroken:q,topWeaponName:D==null?void 0:D.name,topWeaponUseDC:D==null?void 0:D.useDC,topWeaponDamage:D==null?void 0:D.damage,topWeaponSkillId:D==null?void 0:D.skillId,topWeaponAmmo:me,topWeaponAmmoMax:se}}u&&b(le)}catch{}})(),()=>{u=!1}},[ee]);async function oe(u){var c,f,z,q,J;const[t]=await U.scene.items.getItems([u]);if(!t)return;const r=await De(u);if(!r)return;const m=Xe([...(r.feats??[]).map(D=>D.statusEffects??"").filter(Boolean),...(r.inventory??[]).map(D=>D.statusEffects??"").filter(Boolean)]).deltas,M=we(r.skills??{}),_=((c=r.stress)==null?void 0:c.current)??0,h=Math.max(0,(Pe(r.skills??{})||0)-(((f=r.stress)==null?void 0:f.cufLoss)??0)),A=kt({attributes:M,stress:{current:_,cuf:h}},m),V=A.stress.cuf??h,Y=A.attributes.ref??M.ref??0,le=_>V,Q=Ae({netDice:le?-1:0,modifier:Y,label:`${((z=t.text)==null?void 0:z.plainText)??r.name??"Token"} Initiative`}),K=await st({diceNotation:Q,rollTarget:"everyone",showResults:!0});await vt({tokenId:u,initiative:K,name:((q=t.text)==null?void 0:q.plainText)??r.name??"Token",thumbUrl:(J=t.image)==null?void 0:J.url})}async function ce(){var M,_;const u=await((_=(M=U.player).getSelection)==null?void 0:_.call(M))??[],t=u==null?void 0:u[0],r=await it()??void 0,m=t||r;if(!m){U.notification.show("Select a token (or set your character) to roll initiative.","WARNING");return}await oe(m)}async function G(u){var z,q,J,D;const t=await De(u);if(!t)return;const r=(z=t.weapons)==null?void 0:z[0];if(!r){U.notification.show("No weapon in the top slot.","WARNING");return}const m=Xe([...(t.feats??[]).map(se=>se.statusEffects??"").filter(Boolean),...(t.inventory??[]).map(se=>se.statusEffects??"").filter(Boolean)]).deltas,_=(Pe(t.skills??{})-(((q=t.stress)==null?void 0:q.cufLoss)??0)||0)+(m.cool_under_fire??0),A=(((J=t.stress)==null?void 0:J.current)??0)>_,V=String(r.skillId??""),Y=((D=t.skills)==null?void 0:D[V])??0,le=t.learningFocus??"combat",Q=xa(W,V,le,Y,m[V]??0),K=He(r),c=Number.isFinite(r==null?void 0:r.ammo)?Number(r==null?void 0:r.ammo):0;if(K>0&&c<=0){U.notification.show("Out of ammo. Reload first.","WARNING");return}const f=Z(j-(A?1:0));if(await ut({weapon:r,netDice:f,modifier:Q,rollTarget:"everyone",showResults:!0}),K>0){const se=Math.max(0,c-1),me=[...t.weapons??[]];me[0]={...me[0],ammo:se},await Ge(u,{...t,weapons:me})}}async function ne(u){var _;const t=await De(u);if(!t)return;const r=(_=t.weapons)==null?void 0:_[0];if(!r)return;const m=He(r);if(m<=0)return;const M=[...t.weapons??[]];M[0]={...M[0],ammo:m},await Ge(u,{...t,weapons:M})}return e.jsxs(O,{spacing:2,children:[e.jsxs(R,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",gap:1,flexWrap:"wrap"},children:[e.jsx(S,{variant:"h6",sx:{m:0},children:"Initiative"}),e.jsxs(O,{direction:"row",spacing:1,alignItems:"center",children:[e.jsx(xe,{size:"small",variant:"contained",onClick:()=>void ce(),startIcon:e.jsx(Se,{}),children:"Roll Initiative"}),e.jsxs(R,{sx:{display:"flex",alignItems:"center",gap:1,flexWrap:"wrap",pl:1},children:[e.jsx(S,{variant:"body2",sx:{opacity:.8},children:"Attack Roll:"}),e.jsxs(Ne,{size:"small",exclusive:!0,value:j,onChange:(u,t)=>{t!==null&&H(t)},children:[e.jsx(X,{value:-2,children:"−2"}),e.jsx(X,{value:-1,children:"−1"}),e.jsx(X,{value:0,children:"0"}),e.jsx(X,{value:1,children:"+1"}),e.jsx(X,{value:2,children:"+2"})]})]}),p&&e.jsxs(e.Fragment,{children:[e.jsx(xe,{size:"small",variant:"outlined",onClick:()=>pt(),children:"Clear"}),e.jsx(xe,{size:"small",variant:"outlined",onClick:()=>yt(),children:"Advance"})]})]})]}),e.jsx(Et,{}),ee.length===0?e.jsx(S,{variant:"body2",sx:{opacity:.75},children:"No initiative rolls yet."}):e.jsx(Pt,{dense:!0,disablePadding:!0,children:ee.map(u=>{const t=g[u.tokenId],r=t==null?void 0:t.ownerPlayerId,m=p||!!r&&r===T,M=a.activeTokenId===u.tokenId,_=M&&m&&!p,h=!!u.surprised,A=(t==null?void 0:t.topWeaponAmmoMax)??0,V=(t==null?void 0:t.topWeaponAmmo)??0,Y=A>0&&V<=0;return e.jsxs(At,{sx:{borderRadius:1,mb:.5,bgcolor:M?"rgba(255,255,255,0.06)":"transparent",opacity:h?.55:1},secondaryAction:e.jsxs(O,{direction:"row",spacing:.5,alignItems:"center",children:[e.jsx(fe,{title:t!=null&&t.armorBroken?"Armor broken":"Protection",children:e.jsxs(R,{sx:{display:"inline-flex",alignItems:"center",gap:.5,px:1,py:.5,borderRadius:1,bgcolor:"rgba(0,0,0,0.25)"},children:[e.jsx(Lt,{fontSize:"small",sx:{color:t!=null&&t.armorBroken?"error.main":"inherit"}}),e.jsx(S,{variant:"caption",children:(t==null?void 0:t.prot)??0})]})}),(p||m)&&e.jsx(fe,{title:t!=null&&t.topWeaponName?Y?`Out of ammo: ${t.topWeaponName}`:`Attack: ${t.topWeaponName}`:"No top weapon",children:e.jsx("span",{children:e.jsx(ie,{size:"small",disabled:!(t!=null&&t.topWeaponName)||Y,onClick:()=>void G(u.tokenId),children:e.jsx(Se,{fontSize:"small"})})})}),(p||m)&&e.jsx(fe,{title:t!=null&&t.topWeaponName?A<=0?"No ammo to reload":`Reload: ${t.topWeaponName}`:"No top weapon",children:e.jsx("span",{children:e.jsx(ie,{size:"small",disabled:!(t!=null&&t.topWeaponName)||A<=0,onClick:()=>void ne(u.tokenId),children:e.jsx(ot,{fontSize:"small"})})})}),e.jsx(fe,{title:m||p?"Remove":"Only the owner or GM can remove",children:e.jsx("span",{children:e.jsx(ie,{size:"small",disabled:!m&&!p,onClick:()=>bt(u.tokenId),children:e.jsx(ze,{fontSize:"small"})})})})]}),children:[e.jsx(Nt,{children:e.jsx(zt,{src:t==null?void 0:t.thumbUrl,variant:"rounded",sx:{width:32,height:32,mr:1,cursor:"pointer"}})}),e.jsx(Wt,{primary:e.jsxs(R,{sx:{display:"flex",alignItems:"center",gap:1,flexWrap:"wrap"},children:[e.jsx(S,{variant:"body2",sx:{fontWeight:600},children:(t==null?void 0:t.name)??u.name??"Token"}),e.jsx(S,{variant:"caption",sx:{opacity:.75},children:u.initiative}),_&&e.jsx(S,{variant:"caption",sx:{px:1,py:.25,borderRadius:1,bgcolor:"rgba(0,128,255,0.2)"},children:"Your Turn"})]}),secondary:e.jsxs(R,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(Ft,{size:"small",checked:h,disabled:!p,onChange:le=>gt(u.tokenId,le.target.checked)}),e.jsx(S,{variant:"caption",sx:{opacity:.75},children:"Surprised"})]})})]},u.tokenId)})})]})}function ya(){var se,me,ge,be,ke,o,l;const[a,i]=k.useState({kind:"loading"}),[g,b]=k.useState("core"),[T,w]=k.useState(!1),[p,d]=k.useState(null);async function j(n){var s,y,v,C,E,N;try{const F=await U.scene.items.getItems([n]),I=F==null?void 0:F[0];if(!I)return{ownerLabel:"unowned",thumbUrl:null};const B=((s=I==null?void 0:I.image)==null?void 0:s.url)??((y=I==null?void 0:I.image)==null?void 0:y.href)??(I==null?void 0:I.imageUrl)??(I==null?void 0:I.image)??((v=I==null?void 0:I.thumbnail)==null?void 0:v.url)??null,$=(C=I==null?void 0:I.metadata)==null?void 0:C[rt];if(typeof $!="string"||$.length===0)return{ownerLabel:"unowned",thumbUrl:B,ownerPlayerId:null,isOwnedByMe:!1};const te=await U.player.getId();if($===te)return{ownerLabel:"owned by you",thumbUrl:B,ownerPlayerId:$,isOwnedByMe:!0};try{const P=(await((N=(E=U.party).getPlayers)==null?void 0:N.call(E))??[]).find(re=>(re==null?void 0:re.id)===$);return{ownerLabel:`owned by ${typeof(P==null?void 0:P.name)=="string"&&P.name.length>0?P.name:$}`,thumbUrl:B,ownerPlayerId:$,isOwnedByMe:!1}}catch{return{ownerLabel:`owned by ${$}`,thumbUrl:B,ownerPlayerId:$,isOwnedByMe:!1}}}catch{return{ownerLabel:"unowned",thumbUrl:null,ownerPlayerId:null,isOwnedByMe:!1}}}async function H(n){const s=n!=null&&n.ignoreOpenOverride?null:await wt();if(s)if(await Be(s)){const $=await Le(s);if(!$)throw new Error("Could not load sheet from token.");const te=we($.skills??{}),de={...$,attributes:te},P=await j(s);i({kind:"ready",tokenId:s,sheet:de,mode:"view",...P});return}else await _e(null);let v=await it();if(v||(v=await Ze(),v&&await je(v)),!v){i({kind:"need-token"});return}let C=await Be(v);if(!C){const B=await Ze();B&&(v=B,await je(v),C=await Be(v))}if(!C){await je(null),i({kind:"need-token"});return}const E=await Le(v);if(!E)throw new Error("Could not load sheet from token.");try{await et(v)}catch{}const N=we(E.skills??{}),F={...E,attributes:N},I=await j(v);i({kind:"ready",tokenId:v,sheet:F,mode:"my",...I})}k.useEffect(()=>{let n=!1;return U.onReady(async()=>{try{await H()}catch(s){n||i({kind:"error",message:s.message??"Unknown error"})}}),()=>{n=!0}},[]),k.useEffect(()=>{let n=null,s=null,y=!1;const v="whisperspace.combatLogLeader",C=2e3,E=6e3,N=`${Date.now()}-${Math.random().toString(36).slice(2,10)}`,F=()=>{try{const P=localStorage.getItem(v);return P?JSON.parse(P):null}catch{return null}},I=P=>{try{localStorage.setItem(v,JSON.stringify({id:N,ts:P??Date.now()}))}catch{}},B=()=>{const P=F();return P&&P.id===N},$=()=>{const P=Date.now(),L=F();(!L||P-(L.ts??0)>E||L.id===N)&&I(P)},te=()=>{const P=B();if(P&&!n)n=U.broadcast.onMessage(dt,L=>{const re=L.data;re!=null&&re.text&&U.notification.show(String(re.text),"INFO")});else if(!P&&n){try{n()}catch{}n=null}},de=P=>{P.key===v&&te()};return U.onReady(()=>{if(!y){try{window.addEventListener("storage",de)}catch{}$(),te(),s=window.setInterval(()=>{y||($(),te())},C)}}),()=>{y=!0;try{window.removeEventListener("storage",de)}catch{}if(s!==null&&clearInterval(s),B())try{localStorage.removeItem(v)}catch{}if(typeof n=="function")try{n()}catch{}}},[]),k.useEffect(()=>{var C,E,N,F;if(a.kind!=="ready")return;const n=a.tokenId;let s=!1;const y=async()=>{var I,B;try{const $=await U.scene.items.getItems([n]),te=$==null?void 0:$[0],de=String(((I=te==null?void 0:te.text)==null?void 0:I.plainText)??"").trim(),P=(B=te==null?void 0:te.image)==null?void 0:B.url;if(s||!de&&!P)return;i(L=>{if(L.kind!=="ready"||L.tokenId!==n)return L;const re=de&&L.sheet.name!==de?{...L.sheet,name:de}:L.sheet;return{...L,sheet:re,thumbUrl:P??L.thumbUrl}})}catch{}};y();const v=(F=(N=(E=(C=U)==null?void 0:C.scene)==null?void 0:E.items)==null?void 0:N.onChange)==null?void 0:F.call(N,I=>{Array.isArray(I)&&I.some(B=>(B==null?void 0:B.id)===n)&&y()});return()=>{s=!0,typeof v=="function"&&v()}},[a.kind,a.kind==="ready"?a.tokenId:null]);const Z=k.useMemo(()=>a.kind==="ready"&&a.sheet.name||"Whisperspace Sheet",[a]);async function W(){const n=await $t();if(!n){i({kind:"error",message:"No token selected. Select a token on the map first."});return}const s=await Le(n);if(!s){i({kind:"error",message:"Could not attach a sheet to the selected token."});return}const y=we(s.skills??{}),v={...s,attributes:y};await je(n);try{await et(n)}catch{}await _e(null);const C=await j(n);i({kind:"ready",tokenId:n,sheet:v,mode:"my",...C})}async function ee(){await je(null);try{await Ct()}catch{}i({kind:"need-token"})}async function oe(){await _e(null),i({kind:"loading"});try{await H({ignoreOpenOverride:!0})}catch(n){i({kind:"error",message:n.message??"Unknown error"})}}async function ce(n,s){w(!0);try{await Ge(n,s)}finally{w(!1)}}function G(n){i(s=>{if(s.kind!=="ready")return s;let y=n(s.sheet);try{const v=we(y.skills??{});y={...y,attributes:{...y.attributes,...v},stress:{...y.stress??{current:0,cuf:0,cufLoss:0},cuf:Pe(y.skills??{})}}}catch{}return ce(s.tokenId,y),{...s,sheet:y}})}async function ne(n){var I;if(a.kind!=="ready")return;const s=8+n,y=Math.max(0,Math.trunc(((I=a.sheet.stress)==null?void 0:I.cuf)??0)),v=`Crucible Test (DC ${s})`,C=y===0?"":` +${y}`,E=`1d12 # ${v}${C}`,N=await Ye({diceNotation:E,rollTarget:"everyone",showResults:!0}),F=await new Promise((B,$)=>{const te=setTimeout(()=>{de(),$(new Error("Dice+ roll timed out (no roll-result received)"))},4e3),de=U.broadcast.onMessage(`${St}/roll-result`,P=>{var We;const L=P.data;if(!L||L.rollId!==N)return;clearTimeout(te),de();const re=typeof L.total=="number"?L.total:typeof((We=L==null?void 0:L.result)==null?void 0:We.total)=="number"?L.result.total:typeof(L==null?void 0:L.value)=="number"?L.value:NaN;if(!Number.isFinite(re)){$(new Error("Dice+ roll-result received, but total was missing/invalid."));return}B(Math.trunc(re))})});F>=s?(G(B=>({...B,stress:{...B.stress??{current:0,cuf:0,cufLoss:0},current:5},indomitable:!0})),d({incoming:n,dc:s,status:"success",total:F})):d({incoming:n,dc:s,status:"fail",total:F})}function u(n){var v;if(a.kind!=="ready")return;const s=Math.max(0,Math.trunc(((v=a.sheet.stress)==null?void 0:v.current)??0)),y=Math.max(0,Math.trunc(n));if(s<=5&&y>5){const C=y-s;d({incoming:C,dc:8+C,status:"pending"})}else d(null);G(C=>({...C,stress:{...C.stress??{current:0,cuf:0,cufLoss:0},current:y}}))}function t(n,s){var N;if(a.kind!=="ready")return;const v={light:4,moderate:2,heavy:1}[n],C=Math.max(0,Math.trunc(((N=a.sheet.wounds)==null?void 0:N[n])??0)),E=s<C?s:s+1;G(F=>({...F,wounds:{...F.wounds,[n]:Math.min(v,Math.max(0,E))}}))}function r(){var s;if(a.kind!=="ready"||!p||p.status!=="fail")return;const n=Math.max(0,Math.trunc(((s=a.sheet.stress)==null?void 0:s.cufLoss)??0));G(y=>({...y,stress:{...y.stress??{current:0,cuf:0,cufLoss:0},cufLoss:n+1,current:5},indomitable:!0})),d({...p,status:"success"})}const m=a.kind==="ready"?a.sheet:null,M=Ce.useMemo(()=>{if(!m)return{};const n=[];return(m.feats??[]).forEach(s=>{typeof(s==null?void 0:s.statusEffects)=="string"&&s.statusEffects.trim()&&n.push(s.statusEffects)}),(m.inventory??[]).forEach(s=>{typeof(s==null?void 0:s.statusEffects)=="string"&&s.statusEffects.trim()&&n.push(s.statusEffects)}),jt(n)},[m]),_=Ce.useMemo(()=>{const n={},s=new Map,y=C=>{const E=String(C.id),N=String(C.name??C.label??"").toLowerCase().replace(/\s+/g,"_").replace(/[^a-z0-9_\-()]/g,"");E&&(s.set(E.toLowerCase(),E),N&&s.set(N,E))};(ue.inherent??[]).forEach(y),Object.values(ue.learned??{}).forEach(C=>{(C??[]).forEach(y)});const v=new Set(["phys","ref","soc","ment","carrying_capacity","cool_under_fire","speed","cuf","carry","capacity","spd"]);return Object.entries(M??{}).forEach(([C,E])=>{const N=String(C).toLowerCase();if(v.has(N))return;const F=s.get(N);F&&(n[F]=(n[F]??0)+(Number.isFinite(E)?E:0))}),n},[M]),h=Math.max(0,(((se=m==null?void 0:m.attributes)==null?void 0:se.phys)??0)+(M.phys??0)),A=Math.max(0,(((me=m==null?void 0:m.attributes)==null?void 0:me.ref)??0)+(M.ref??0)),V=Math.max(0,(((ge=m==null?void 0:m.attributes)==null?void 0:ge.soc)??0)+(M.soc??0)),Y=Math.max(0,(((be=m==null?void 0:m.attributes)==null?void 0:be.ment)??0)+(M.ment??0)),Q=5+h*5+(M.carrying_capacity??0);30+h*5+(M.speed??0);const c=m?Pe(m.skills??{}):0,f=Math.max(0,c+(M.cool_under_fire??0)),q=Ce.useMemo(()=>m?{...m,attributes:{...m.attributes,phys:h,ref:A,soc:V,ment:Y},stress:{...m.stress??{current:0,cuf:0,cufLoss:0},cuf:f}}:null,[m,h,A,V,Y,f])??m,J=Ce.useMemo(()=>{var v;if(!m)return 0;const n=(m.weapons??[]).reduce((C,E)=>C+(E.bulk??0),0),s=((v=m.armor)==null?void 0:v.bulk)??0,y=(m.inventory??[]).reduce((C,E)=>{const N=E.quantity??1,F=E.bulk??0,I=Number.isFinite(F)?F:0,B=Number.isFinite(N)?N:1;return C+I*B},0);return n+s+y},[m]),D=m&&J>Q*2?"Heavily Encumbered":m&&J>Q?"Encumbered":"";return a.kind==="loading"?e.jsx("div",{style:{padding:12},children:"Loading…"}):a.kind==="need-token"?e.jsxs("div",{style:{padding:12},children:[e.jsx("h2",{style:{margin:"0 0 8px 0"},children:"My Sheet"}),e.jsx("p",{style:{margin:"0 0 10px 0",lineHeight:1.35},children:"Select your character token on the map, then click:"}),e.jsx("button",{style:{padding:"8px 10px",borderRadius:8,border:"1px solid #666",cursor:"pointer"},onClick:W,children:"Set Selected Token as My Character"})]}):a.kind==="error"?e.jsxs("div",{style:{padding:12},children:[e.jsx("h2",{style:{margin:"0 0 8px 0"},children:"Error"}),e.jsx("p",{style:{margin:"0 0 10px 0",lineHeight:1.35},children:a.message}),e.jsx("button",{style:{padding:"8px 10px",borderRadius:8,border:"1px solid #666",cursor:"pointer"},onClick:()=>i({kind:"need-token"}),children:"Back"})]}):e.jsxs("div",{style:{padding:12},children:[e.jsxs("div",{style:{display:"flex",alignItems:"flex-start",gap:12,justifyContent:"space-between",marginBottom:10},children:[e.jsxs("div",{style:{display:"flex",gap:10,alignItems:"flex-start"},children:[a.thumbUrl?e.jsx("img",{src:a.thumbUrl,alt:"Token thumbnail",style:{width:44,height:44,borderRadius:10,objectFit:"cover",border:"1px solid rgba(0,0,0,0.2)"}}):e.jsx("div",{style:{width:44,height:44,borderRadius:10,border:"1px solid rgba(0,0,0,0.2)",opacity:.4}}),e.jsxs("div",{children:[e.jsxs("div",{style:{fontSize:18,fontWeight:700},children:[Z," ",e.jsxs("span",{style:{fontSize:12,opacity:.75},children:["(",a.ownerLabel??(a.mode==="view"?"Viewing token":"My Character"),")"]})]}),e.jsxs("div",{style:{fontSize:12,opacity:.8},children:["Token: ",e.jsx("code",{style:{fontSize:11},children:a.tokenId})]})]})]}),e.jsx("div",{style:{display:"flex",gap:8},children:a.mode==="view"?!a.isOwnedByMe&&e.jsx("button",{style:{padding:"8px 10px",borderRadius:8,border:"1px solid #999",cursor:"pointer",opacity:.9},onClick:oe,children:"Back to My Sheet"}):e.jsx("button",{style:{padding:"8px 10px",borderRadius:8,border:"1px solid #999",cursor:"pointer",opacity:.9},onClick:ee,children:"Unset “My Character”"})})]}),e.jsxs(e.Fragment,{children:[e.jsxs("div",{style:ae.statusBar,children:[e.jsxs("div",{style:ae.statusLeft,children:[e.jsxs("div",{style:ae.statusGroup,children:[e.jsx("div",{style:ae.statusLabel,children:"Stress"}),e.jsx("input",{type:"number",min:0,value:((ke=a.sheet.stress)==null?void 0:ke.current)??0,onChange:n=>u(Number(n.target.value)),style:ae.statusNumber})]}),e.jsxs("div",{style:ae.statusGroup,children:[e.jsx("div",{style:ae.statusLabel,children:"Wounds"}),e.jsxs("div",{style:ae.woundsRow,children:[e.jsx("span",{style:ae.woundsKind,children:"L"}),Array.from({length:4}).map((n,s)=>{var y;return e.jsx("input",{type:"checkbox",checked:(((y=a.sheet.wounds)==null?void 0:y.light)??0)>s,onChange:()=>t("light",s)},`wl_${s}`)}),e.jsx("span",{style:{width:8}}),e.jsx("span",{style:ae.woundsKind,children:"M"}),Array.from({length:2}).map((n,s)=>{var y;return e.jsx("input",{type:"checkbox",checked:(((y=a.sheet.wounds)==null?void 0:y.moderate)??0)>s,onChange:()=>t("moderate",s)},`wm_${s}`)}),e.jsx("span",{style:{width:8}}),e.jsx("span",{style:ae.woundsKind,children:"H"}),Array.from({length:1}).map((n,s)=>{var y;return e.jsx("input",{type:"checkbox",checked:(((y=a.sheet.wounds)==null?void 0:y.heavy)??0)>s,onChange:()=>t("heavy",s)},`wh_${s}`)})]})]}),e.jsxs("label",{style:{display:"flex",alignItems:"center",gap:6},children:[e.jsx("input",{type:"checkbox",checked:!!a.sheet.indomitable,onChange:n=>G(s=>({...s,indomitable:n.target.checked}))}),e.jsx("span",{style:{fontSize:12,opacity:.9},children:"Indomitable"})]}),(((o=a.sheet.stress)==null?void 0:o.current)??0)>(((l=(q??a.sheet).stress)==null?void 0:l.cuf)??0)&&e.jsx("div",{style:ae.warning,children:"Stress > CUF: make all rolls with +1 Penalty Die"}),e.jsxs("div",{style:{fontSize:12,opacity:.85},children:["Bulk: ",J," / ",Q]}),D&&e.jsx("div",{style:ae.warning,children:D})]}),e.jsxs("div",{style:ae.statusRight,children:[p&&p.status==="pending"&&e.jsxs("div",{style:ae.crucibleBox,children:[e.jsx("div",{style:{fontWeight:700},children:"Crucible Test!"}),e.jsxs("div",{style:{fontSize:12,opacity:.85},children:["Incoming stress: ",p.incoming," • DC ",p.dc," • Roll CUF (no bonus/penalty dice)"]}),e.jsx("button",{style:ae.buttonSecondary,onClick:()=>void ne(p.incoming),children:"Roll Crucible"})]}),p&&p.status==="success"&&e.jsxs("div",{style:ae.crucibleBox,children:[e.jsx("div",{style:{fontWeight:700},children:"Crucible succeeded!"}),e.jsx("div",{style:{fontSize:12,opacity:.85},children:"Choose an Indomitable effect. (Indomitable checked automatically.)"})]}),p&&p.status==="fail"&&e.jsxs("div",{style:ae.crucibleBox,children:[e.jsx("div",{style:{fontWeight:700},children:"Crucible failed"}),e.jsx("div",{style:{fontSize:12,opacity:.85},children:"You’ve entered PTSD range (6–8 stress)."}),e.jsx("button",{style:ae.buttonSecondary,onClick:r,children:"Spend 1 CUF to pass"})]})]})]}),e.jsxs("div",{style:{display:"flex",gap:8,alignItems:"center",marginBottom:10},children:[e.jsx(ye,{label:"Core",active:g==="core",onClick:()=>b("core")}),e.jsx(ye,{label:"Skills",active:g==="skills",onClick:()=>b("skills")}),e.jsx(ye,{label:"Combat",active:g==="combat",onClick:()=>b("combat")}),e.jsx(ye,{label:"Initiative",active:g==="initiative",onClick:()=>b("initiative")}),e.jsx(ye,{label:"Inventory",active:g==="inventory",onClick:()=>b("inventory")}),e.jsx(ye,{label:"Feats",active:g==="feats",onClick:()=>b("feats")}),e.jsx("div",{style:{marginLeft:"auto",opacity:.8},children:T?"Saving…":"Synced"})]}),e.jsxs("div",{style:{border:"1px solid #888",borderRadius:12,padding:10},children:[g==="core"&&e.jsx(Ut,{sheet:q,onChange:n=>G(s=>({...s,...n}))}),g==="skills"&&e.jsx(Gt,{sheet:q,skillMods:_,onChange:n=>G(s=>({...s,skills:n})),onMetaChange:n=>G(s=>({...s,...n}))}),g==="combat"&&e.jsx(aa,{sheet:q,tokenId:a.tokenId,skillMods:_,onChange:n=>G(s=>({...s,...n})),onApplyStress:u}),g==="initiative"&&e.jsx(pa,{}),g==="inventory"&&e.jsx(ha,{sheet:q,onChange:n=>G(s=>({...s,...n}))}),g==="feats"&&e.jsx(Kt,{sheet:q,onChange:n=>G(s=>({...s,feats:n}))})]})]})]})}function ye(a){return e.jsx("button",{onClick:a.onClick,style:{padding:"6px 10px",borderRadius:999,border:"1px solid #777",cursor:"pointer",background:"transparent",fontWeight:a.active?700:400},children:a.label})}const ae={statusBar:{display:"flex",alignItems:"flex-start",justifyContent:"space-between",gap:12,padding:"10px 12px",borderRadius:12,border:"1px solid rgba(255,255,255,0.15)",marginBottom:10},statusLeft:{display:"flex",alignItems:"center",gap:16,flexWrap:"wrap"},statusRight:{display:"flex",alignItems:"center",gap:12},statusGroup:{display:"flex",flexDirection:"column",gap:4},statusLabel:{fontSize:11,opacity:.75,letterSpacing:.2},statusNumber:{width:64,fontSize:16},woundsRow:{display:"flex",alignItems:"center",gap:8,flexWrap:"wrap"},woundsKind:{fontSize:11,opacity:.75,width:14,textAlign:"center"},warning:{marginTop:8,fontSize:12,opacity:.9},crucibleBox:{border:"1px solid rgba(255,255,255,0.18)",borderRadius:12,padding:10,maxWidth:240},buttonSecondary:{padding:"6px 10px",borderRadius:8,border:"1px solid #999",cursor:"pointer",opacity:.9,background:"transparent"}};function ga(a){var Z,W,ee,oe,ce,G,ne,u;const i=((a==null?void 0:a.mode)??"LIGHT")==="DARK"?"dark":"light",g=((Z=a==null?void 0:a.background)==null?void 0:Z.default)??(i==="dark"?"#121212":"#ffffff"),b=((W=a==null?void 0:a.background)==null?void 0:W.paper)??(i==="dark"?"#1e1e1e":"#f7f7f7"),T=((ee=a==null?void 0:a.text)==null?void 0:ee.primary)??(i==="dark"?"#ffffff":"#111111"),w=((oe=a==null?void 0:a.text)==null?void 0:oe.secondary)??(i==="dark"?"#bdbdbd":"#444444"),p=((ce=a==null?void 0:a.primary)==null?void 0:ce.main)??"#2f6fed",d=((G=a==null?void 0:a.primary)==null?void 0:G.contrastText)??"#ffffff",j=((ne=a==null?void 0:a.secondary)==null?void 0:ne.main)??"#7c3aed",H=((u=a==null?void 0:a.secondary)==null?void 0:u.contrastText)??"#ffffff";return Ot({palette:{mode:i,background:{default:g,paper:b},text:{primary:T,secondary:w},primary:{main:p,contrastText:d},secondary:{main:j,contrastText:H}},shape:{borderRadius:12},typography:{fontFamily:"system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif"},components:{MuiPaper:{defaultProps:{elevation:0}},MuiButton:{styleOverrides:{root:{color:T},containedPrimary:{color:d},containedSecondary:{color:H}}}}})}function ba(a){const[i,g]=k.useState(null);k.useEffect(()=>{let T=null,w=!1;return U.onReady(async()=>{if(!w)try{const p=await U.theme.getTheme();w||g(p),T=U.theme.onChange(d=>g(d))}catch{}}),()=>{w=!0,T&&T()}},[]);const b=k.useMemo(()=>ga(i),[i]);return e.jsxs(_t,{theme:b,children:[e.jsx(Bt,{}),a.children]})}async function ka(){await U.onReady(async()=>{}),It.createRoot(document.getElementById("root")).render(e.jsx(Ce.StrictMode,{children:e.jsx(ba,{children:e.jsx(ya,{})})}))}ka();
