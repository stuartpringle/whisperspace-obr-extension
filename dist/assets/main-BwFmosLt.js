import{r as Qe,b as _e,c as ft,s as fe,F as xt,a as rt,o as pt,l as We,T as ve,d as yt,e as gt,f as bt,g as kt,h as lt,i as et,j as Le,k as Ve,m as Re,n as vt,u as jt,P as wt,p as je,q as Ct,t as St,v as qe,w as $e,x as tt,y as at,D as It}from"./statusEffects-duy3L8v5.js";import{r as k,j as e,d as De,e as Mt}from"./vendor_react-XzhcIodj.js";import{O as W}from"./vendor_obr-BLY5dk8V.js";import{S as q,B as I,T as j,a as Be,b as ne,c as p,d as ke,I as de,C as Ee,R as Tt,A as Pe,e as Ae,E as Ne,f as ze,g as xe,h as ot,i as we,P as Rt,D as Oe,M as pe,j as ct,k as Dt,l as Et,m as dt,L as Pt,n as At,o as Nt,p as zt,q as Wt,r as Ft,s as Lt,t as _t,u as Bt,v as Ot}from"./vendor_mui-TXCeMNq_.js";import"./vendor_zod-CxP395f9.js";import"./vendor-CPvQcOsy.js";import"./vendor_emotion-pcfylbOS.js";async function qt(){const a=await W.player.getSelection();return Array.isArray(a)?a:[]}async function $t(){const a=await qt();return a.length>0?a[0]:null}async function Ue(a){return(await W.scene.items.getItems([a])).length>0}function Ut(a){var b;const s=a.sheet,[v,g]=k.useState(0),E=k.useMemo(()=>s.attributes??{phys:0,ref:0,soc:0,ment:0},[s.attributes]);async function M(d,S){const V=Number(E[d]??0),te=_e({netDice:v,modifier:V,label:S});await Qe({diceNotation:te,showResults:!0,rollTarget:"everyone"})}return e.jsxs(q,{spacing:2,children:[e.jsxs(I,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",gap:2,flexWrap:"wrap"},children:[e.jsx(j,{variant:"h6",sx:{m:0},children:"Core"}),e.jsxs(I,{sx:{display:"flex",alignItems:"center",gap:1,flexWrap:"wrap"},children:[e.jsx(j,{variant:"subtitle2",sx:{opacity:.8},children:"Attribute Roll:"}),e.jsxs(Be,{size:"small",exclusive:!0,value:v,onChange:(d,S)=>{S!==null&&g(S)},children:[e.jsx(ne,{value:-2,children:"−2"}),e.jsx(ne,{value:-1,children:"−1"}),e.jsx(ne,{value:0,children:"0"}),e.jsx(ne,{value:1,children:"+1"}),e.jsx(ne,{value:2,children:"+2"})]})]})]}),e.jsx(p,{label:"Name",size:"small",value:s.name??"",onChange:d=>a.onChange({name:d.target.value}),fullWidth:!0}),e.jsxs(I,{sx:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:1},children:[e.jsx(Fe,{label:"PHYS",value:E.phys,onRoll:()=>M("phys","PHYS Check")}),e.jsx(Fe,{label:"REF",value:E.ref,onRoll:()=>M("ref","REF Check")}),e.jsx(Fe,{label:"SOC",value:E.soc,onRoll:()=>M("soc","SOC Check")}),e.jsx(Fe,{label:"MENT",value:E.ment,onRoll:()=>M("ment","MENT Check")})]}),e.jsxs(I,{sx:{display:"grid",gridTemplateColumns:"repeat(3, 1fr)",gap:2},children:[e.jsx(p,{label:"Cool Under Fire",size:"small",value:((b=a.sheet.stress)==null?void 0:b.cuf)??0,inputProps:{readOnly:!0},fullWidth:!0}),e.jsx(p,{label:"Speed",size:"small",value:30+(E.phys??0)*5,inputProps:{readOnly:!0},fullWidth:!0}),e.jsx(p,{label:"Carrying Capacity",size:"small",value:5+(E.phys??0)*5,inputProps:{readOnly:!0},fullWidth:!0})]}),e.jsx(j,{variant:"body2",sx:{opacity:.75},children:"Attributes are derived automatically from skill ranks (¼ of total ranks under each attribute, rounded up)."})]})}function Fe(a){return e.jsxs(I,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(p,{label:a.label,size:"small",value:a.value,inputProps:{readOnly:!0},fullWidth:!0}),e.jsx(ke,{title:"Roll with Dice+",children:e.jsx(de,{onClick:a.onRoll,"aria-label":`Roll ${a.label}`,children:e.jsx(Ee,{})})})]})}const Ht=["phys","ref","soc","ment"],He={phys:"PHYSIQUE",ref:"REFLEX",soc:"SOCIAL",ment:"MENTAL"},Ge={combat:"Combat",education:"Education",vehicles:"Vehicles"},nt={combat:"Combat Focus",education:"Education Focus",vehicles:"Vehicles Focus"};function Ye(a){const s=ut(a,0,5);return s*(s+1)/2}function Gt(a){const[s,v]=k.useState(""),[g,E]=k.useState(0),[M,b]=k.useState(!0),[d,S]=k.useState(!1),[V,te]=k.useState(""),O=a.sheet.skills??{},X=a.sheet.learningFocus??"combat",w=Number(a.sheet.skillPoints??0);k.useEffect(()=>{let c=!1;return(async()=>{const x=await ft();c||(b(x),S(!0))})().catch(()=>{c||(b(!1),S(!0))}),()=>{c=!0}},[]);const F=k.useMemo(()=>{const c=new Map;return Object.keys(fe.learned).forEach(x=>{(fe.learned[x]??[]).forEach(_=>c.set(_.id,{focus:x}))}),c},[]);function R(c){const x=F.get(c.id);return x?x.focus===X?5:2:5}function T(c){var re;const x=O[c.id]??0,_=((re=a.skillMods)==null?void 0:re[c.id])??0;if(x>0)return x+_;const ae=F.get(c.id);return ae&&ae.focus===X?0+_:-1+_}const i=k.useMemo(()=>{let c=0;for(const x of Object.values(O))c+=Ye(x??0);return c},[O]),t=Math.max(0,w-i),n=c=>{const x=Math.max(0,Math.trunc(Number(V)));if(!x)return;const _=w+c*x,ae=Math.max(i,_);a.onMetaChange({skillPoints:ae}),te("")};function C(c){a.onChange(c)}function P(c,x){const _=O[c.id]??0,ae=R(c),re=ut(x,0,ae);if(re===_||Ye(re)-Ye(_)>t)return;const me={...O};re===0?delete me[c.id]:me[c.id]=re,C(me)}async function N(c){const x=_e({netDice:g,modifier:T(c),label:c.label});try{await Qe({diceNotation:x,showResults:!0,rollTarget:"everyone"})}catch(_){console.error("Dice+ roll request failed:",_)}}const m=k.useMemo(()=>{const c=Object.values(fe.learned).flat();return[...fe.inherent,...c]},[]),y=k.useMemo(()=>{const c=s.trim().toLowerCase();return c?m.filter(x=>x.label.toLowerCase().includes(c)||x.id.toLowerCase().includes(c)):m},[m,s]),H=k.useMemo(()=>Yt(fe.inherent),[]),Z=k.useMemo(()=>fe.learned,[]),se=s.trim().length>0,ie=e.jsxs(I,{sx:{display:"flex",alignItems:"center",gap:2,flexWrap:"wrap"},children:[e.jsx(j,{variant:"subtitle2",sx:{opacity:.8},children:"Learning Focus:"}),Object.keys(nt).map(c=>e.jsxs(I,{sx:{display:"flex",alignItems:"center",gap:.5,cursor:"pointer"},onClick:()=>a.onMetaChange({learningFocus:c}),children:[e.jsx(Tt,{checked:X===c,value:c,size:"small"}),e.jsx(j,{variant:"body2",children:Ge[c]})]},c))]}),Q=e.jsx(I,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",gap:2,flexWrap:"wrap"},children:e.jsxs(I,{sx:{display:"flex",alignItems:"center",gap:1,flexWrap:"wrap"},children:[e.jsxs(j,{variant:"subtitle2",sx:{minWidth:170},children:["Skill Points: ",t," ",e.jsxs("span",{style:{opacity:.75},children:["(Total: ",w,")"]})]}),e.jsx(xe,{size:"small",variant:"outlined",onClick:()=>n(1),disabled:!Number.isFinite(Number(V))||Math.trunc(Number(V))<=0,children:"+"}),e.jsx(p,{label:"SP",size:"small",type:"number",value:V,onChange:c=>te(c.target.value),sx:{width:110}}),e.jsx(xe,{size:"small",variant:"outlined",onClick:()=>n(-1),disabled:!Number.isFinite(Number(V))||Math.trunc(Number(V))<=0,children:"-"}),e.jsx(j,{variant:"subtitle2",sx:{opacity:.8},children:"Roll"}),e.jsxs(Be,{size:"small",exclusive:!0,value:g,onChange:(c,x)=>{x!==null&&E(x)},"aria-label":"Bonus / Penalty dice",children:[e.jsx(ne,{value:-2,children:"−2"}),e.jsx(ne,{value:-1,children:"−1"}),e.jsx(ne,{value:0,children:"0"}),e.jsx(ne,{value:1,children:"+1"}),e.jsx(ne,{value:2,children:"+2"})]}),d&&!M&&e.jsx(j,{variant:"caption",sx:{opacity:.8},children:"(Dice+ not detected)"})]})});return e.jsxs(q,{spacing:2,children:[ie,e.jsx(p,{label:"Search skills",value:s,onChange:c=>v(c.target.value),placeholder:"stealth, weapons, navigation…",fullWidth:!0}),Q,se?e.jsx(q,{spacing:1,children:y.map(c=>{const x=F.get(c.id),_=x?Ge[x.focus]:He[c.attribute];return e.jsx(Ke,{skill:c,rank:O[c.id]??0,modifier:T(c),maxRank:R(c),onRank:ae=>P(c,ae),rightTag:_,canRoll:M,onRoll:()=>N(c)},c.id)})}):e.jsxs(e.Fragment,{children:[e.jsx(j,{variant:"subtitle1",children:"Inherent Skills"}),Ht.map(c=>e.jsxs(Pe,{defaultExpanded:!0,children:[e.jsx(Ae,{expandIcon:e.jsx(Ne,{}),children:e.jsx(j,{fontWeight:700,children:He[c]})}),e.jsx(ze,{children:e.jsx(q,{spacing:1,children:(H[c]??[]).map(x=>e.jsx(Ke,{skill:x,rank:O[x.id]??0,modifier:T(x),maxRank:R(x),onRank:_=>P(x,_),rightTag:He[x.attribute],canRoll:M,onRoll:()=>N(x)},x.id))})})]},c)),e.jsx(j,{variant:"subtitle1",sx:{mt:1},children:"Learned Skills"}),Object.keys(Z).map(c=>e.jsxs(Pe,{defaultExpanded:!0,children:[e.jsx(Ae,{expandIcon:e.jsx(Ne,{}),children:e.jsx(j,{fontWeight:700,children:nt[c]})}),e.jsx(ze,{children:e.jsx(q,{spacing:1,children:(Z[c]??[]).map(x=>e.jsx(Ke,{skill:x,rank:O[x.id]??0,modifier:T(x),maxRank:R(x),onRank:_=>P(x,_),rightTag:Ge[c],canRoll:M,onRoll:()=>N(x)},x.id))})})]},c))]})]})}function Ke(a){const s=a.rank<a.maxRank,v=a.rank>0;return e.jsxs(I,{sx:{display:"grid",gridTemplateColumns:"1fr auto auto auto",gap:1,alignItems:"center",border:"1px solid",borderColor:"divider",borderRadius:2,px:1.25,py:1},children:[e.jsxs(I,{sx:{minWidth:0},children:[e.jsx(j,{fontWeight:600,noWrap:!0,children:a.skill.label}),e.jsx(j,{variant:"caption",sx:{opacity:.7},noWrap:!0,children:a.rightTag??""})]}),e.jsxs(I,{sx:{width:46,textAlign:"center"},children:[e.jsx(j,{variant:"caption",sx:{opacity:.7,lineHeight:1},children:"Mod"}),e.jsx(j,{sx:{fontWeight:700,lineHeight:1.2},children:a.modifier>=0?`+${a.modifier}`:`${a.modifier}`})]}),e.jsxs(I,{sx:{width:40,textAlign:"center"},children:[e.jsx(j,{variant:"caption",sx:{opacity:.7,lineHeight:1},children:"Rank"}),e.jsx(j,{sx:{fontWeight:700,lineHeight:1.2},children:a.rank})]}),e.jsxs(I,{sx:{display:"flex",gap:.5,alignItems:"center",justifyContent:"flex-end"},children:[e.jsx(de,{size:"small",onClick:()=>a.onRank(a.rank-1),"aria-label":"Decrease rank",disabled:!v,children:e.jsx(ot,{fontSize:"small"})}),e.jsx(de,{size:"small",onClick:()=>a.onRank(a.rank+1),"aria-label":"Increase rank",disabled:!s,children:e.jsx(we,{fontSize:"small"})}),e.jsx(I,{sx:{width:6}}),e.jsx(ke,{title:a.canRoll?"Roll with Dice+":"Dice+ not detected",children:e.jsx("span",{children:e.jsx(de,{size:"small",onClick:a.onRoll,"aria-label":`Roll ${a.skill.label}`,disabled:!a.canRoll,children:e.jsx(Ee,{fontSize:"small"})})})})]})]})}function Yt(a){return a.reduce((s,v)=>{var g;return(s[g=v.attribute]??(s[g]=[])).push(v),s},{})}function ut(a,s,v){const g=Number.isFinite(a)?Math.trunc(a):s;return Math.max(s,Math.min(v,g))}function Kt(a){const s=a.sheet.feats??[];function v(){a.onChange([...s,{name:"New Feat",description:"",statusEffects:""}])}function g(M,b){const d=[...s];d[M]={...d[M],...b},xt.safeParse(d[M]),a.onChange(d)}function E(M){const b=[...s];b.splice(M,1),a.onChange(b)}return e.jsxs(q,{spacing:2,children:[e.jsxs(q,{direction:"row",justifyContent:"space-between",alignItems:"center",children:[e.jsx(j,{variant:"h6",children:"Feats"}),e.jsx(xe,{variant:"contained",startIcon:e.jsx(we,{}),onClick:v,children:"Add Feat"})]}),s.length===0?e.jsx(j,{variant:"body2",sx:{opacity:.75},children:"No feats yet."}):e.jsx(q,{spacing:2,children:s.map((M,b)=>e.jsx(Rt,{sx:{p:2},children:e.jsxs(q,{spacing:1.5,children:[e.jsxs(q,{direction:"row",spacing:1,alignItems:"center",children:[e.jsx(p,{label:"Feat Name",fullWidth:!0,value:M.name,onChange:d=>g(b,{name:d.target.value})}),e.jsx(de,{"aria-label":"Remove feat",onClick:()=>E(b),children:e.jsx(Oe,{})})]}),e.jsx(p,{label:"Description",fullWidth:!0,multiline:!0,minRows:4,value:M.description,onChange:d=>g(b,{description:d.target.value})}),e.jsx(p,{label:"Status Effects",fullWidth:!0,helperText:'Comma-separated, e.g. "carrying_capacity+5"',value:M.statusEffects??"",onChange:d=>g(b,{statusEffects:d.target.value})})]})},`${M.name}-${b}`))})]})}const Jt=[{id:"pistol",name:"Pistol",skillId:"weapons_light",useDC:7,damage:2,range:"Med",ammo:10,bulk:1,cost:500},{id:"smart_pistol",name:"SMART Pistol",skillId:"weapons_light",useDC:9,damage:4,range:"Med",ammo:6,bulk:1,keywords:["Smart-Linked"],cost:900},{id:"toxic_spike",name:"Toxic Spike",skillId:"weapons_light",useDC:10,damage:3,range:"Short",ammo:1,bulk:1,keywords:["Toxin (Prax)","Concealable"],cost:750},{id:"smg",name:"SMG",skillId:"weapons_medium",useDC:6,damage:3,range:"Med",ammo:8,bulk:2,keywords:["Bullet Spray"],cost:600},{id:"photon_rifle",name:"Photon Rifle",skillId:"weapons_medium",useDC:8,damage:6,range:"Long",ammo:6,bulk:3,keywords:["Two-Handed"],cost:5e3},{id:"rifle",name:"Rifle",skillId:"weapons_medium",useDC:8,damage:4,range:"Long",ammo:8,bulk:2,keywords:["Two-Handed","Piercing 1"],cost:1e3},{id:"shotgun",name:"Shotgun",skillId:"weapons_medium",useDC:8,damage:4,range:"Short",ammo:4,bulk:3,req:"PHYS 1",keywords:["Point Blank","Shredding 1"],cost:800},{id:"gauss_cannon",name:"Gauss Cannon",skillId:"weapons_heavy",useDC:7,damage:4,range:"Med",ammo:20,bulk:4,req:"PHYS 3",keywords:["Bullet Spray"],cost:900},{id:"grenade_launcher",name:"Grenade Launcher",skillId:"weapons_heavy",useDC:8,damage:3,range:"Med",ammo:1,bulk:3,req:"PHYS 2",keywords:["Area (near)","Two-Handed","Slow Load","Grenade"],cost:2e3},{id:"magneton_cannon",name:"Magneton Cannon",skillId:"weapons_exotic",useDC:5,damage:2,range:"Short",ammo:5,bulk:2,req:"PHYS 1",keywords:["Area (melee)","Slow Load","Shredding 3"],cost:8e3},{id:"tesla_rifle",name:"Tesla Rifle",skillId:"weapons_exotic",useDC:8,damage:5,range:"Med",ammo:6,bulk:2,keywords:["Two-Handed","Stun 2"],cost:6e3},{id:"stun_baton",name:"Stun Baton",skillId:"melee_weapons",useDC:6,damage:0,range:"Melee",bulk:1,keywords:["Stun 1"],cost:450},{id:"switchblade",name:"Switchblade",skillId:"melee_weapons",useDC:9,damage:2,range:"Melee",bulk:1,keywords:["Concealable","Thrown"],cost:150},{id:"fusion_blade",name:"Fusion Blade",skillId:"melee_weapons",useDC:8,damage:3,range:"Melee",bulk:2,req:"REF 2",keywords:["Piercing 2"],cost:1200},{id:"rocket_maul",name:"Rocket Maul",skillId:"melee_weapons",useDC:10,damage:6,range:"Melee",ammo:2,bulk:3,req:"PHYS 3",keywords:["Two-Handed"],cost:2500}],Vt={weapons:Jt},st=Vt.weapons??[],Qt=[{id:"scrap_armour",name:"Scrap Armour",protection:1,durability:2,bulk:2,special:"Cannot be repaired",cost:500},{id:"flak_jacket",name:"Flak Jacket",protection:1,durability:4,bulk:1,cost:1250},{id:"kevlar_clothing",name:"Kevlar Clothing",protection:1,durability:3,bulk:1,special:"Appears to be normal clothing",cost:1500},{id:"streetweave_jacket",name:"Streetweave Jacket",protection:1,durability:5,bulk:1,special:"+1 to Stealth",cost:2500},{id:"milsec_bodyplate",name:"MilSec Bodyplate",protection:2,durability:6,bulk:2,cost:5e3},{id:"breaching_plate",name:"Breaching plate",protection:2,durability:4,bulk:3,req:"PHYS 2",special:"Frontal Shielding 1",cost:8500},{id:"heavy_bodyplate",name:"Heavy Bodyplate",protection:3,durability:8,bulk:4,req:"PHYS 3",special:"+1 penalty die to Stealth",cost:1e4},{id:"basic_power_armour",name:"Basic Power Armour",protection:4,durability:14,bulk:10,req:"Power Armour 1",special:`Requires Power Armour (DC5) check to activate. Failure: become Immobile; gain +1 penalty die to all PHYS and REF based checks. When activated, reduces its own bulk to 1 and grants +1 bonus die to all PHYS based checks.
`,cost:4e4}],Xt={armor:Qt},it=Xt.armor??[],mt="whisperspace.obr.sheet/combat-log";function Zt(a){return a>=9?4:a>=7?3:a>=4?2:0}async function ea(a){const s=Number.isFinite(a.useDC)?Math.trunc(a.useDC):Math.trunc(a.weapon.useDC),v=a.weapon.name||"Attack",g=_e({netDice:a.netDice,modifier:a.modifier,label:v}),E=await rt({diceNotation:g,rollTarget:a.rollTarget??"everyone",showResults:a.showResults??!0}),M=E-s,b=E>=s,d=b?Zt(M):0,S=b&&d>0,V=Math.trunc(a.weapon.damage??0),te=b?V+d:0;let O;return b?S?O=`Extreme success - crit! ${v} rolled ${E} vs DC ${s}. Damage: ${V}+${d}=${te}. (+1 Stress)`:O=`Hit. ${v} rolled ${E} vs DC ${s}. Damage: ${V}.`:O=`Miss. ${v} rolled ${E} vs DC ${s}.`,a.prefix&&(O=`${a.prefix} ${O}`),W.broadcast.sendMessage(mt,{text:O,ts:Date.now()},{destination:"ALL"}),{total:E,useDC:s,margin:M,hit:b,isCrit:S,critExtra:d,baseDamage:V,totalDamage:te,message:O}}const ht=ea;function ta(){const a=new Map;return Object.keys(fe.learned).forEach(s=>{(fe.learned[s]??[]).forEach(v=>a.set(v.id,{focus:s}))}),a}function aa(a){var Q,c,x,_,ae,re,B,me,he,Ce,Me,Se;const s=a.sheet,[v,g]=k.useState(0),[E,M]=k.useState(null),[b,d]=k.useState(""),[S,V]=k.useState(!1),te=k.useMemo(()=>ta(),[]),O=k.useMemo(()=>{const o=Object.values(fe.learned).flat();return[...fe.inherent,...o]},[]),X=new Set(["melee_weapons","melee_unarmed","weapons_light","weapons_medium","weapons_heavy","weapons_exotic","explosives"]),w=O.filter(o=>X.has(o.id));k.useMemo(()=>[...O].sort((o,r)=>o.label.localeCompare(r.label)),[O]);const F=s.learningFocus??"combat";function R(){var Te,Xe;const o=Number(b),r=Number.isFinite(o)?Math.max(0,Math.trunc(o)):0;if(r<=0)return;const h=a.sheet.armor,Y=(((Te=h==null?void 0:h.durability)==null?void 0:Te.current)??0)<=0,ye=S||Y?0:(h==null?void 0:h.protection)??0,ge=Math.max(0,r-ye),be=a.sheet.wounds??{light:0,moderate:0,heavy:0};let u=be.light??0,l=be.moderate??0,f=be.heavy??0,z=ge,A=0,U=0,$=0;const D=Math.min(z,Math.max(0,4-u));u+=D,z-=D,A=D;const ee=Math.min(z,Math.max(0,2-l));l+=ee,z-=ee,U=ee;const ce=Math.min(z,Math.max(0,1-f));f+=ce,z-=ce,$=ce;const G={light:u,moderate:l,heavy:f};let L=0;$>0?L=4:U>0?L=2:A>0&&(L=1);let ue=h;if(!S&&!Y&&ge>0&&(h!=null&&h.durability)&&(ue={...h,durability:{...h.durability,current:Math.max(0,Math.trunc((h.durability.current??0)-1))}}),a.onChange({wounds:G,armor:ue}),L>0){const Ze=(((Xe=a.sheet.stress)==null?void 0:Xe.current)??0)+L;a.onApplyStress?a.onApplyStress(Ze):a.onChange({stress:{...a.sheet.stress,current:Ze}})}d("")}function T(o){var ge,be;const r=((ge=s.skills)==null?void 0:ge[o])??0,h=((be=a.skillMods)==null?void 0:be[o])??0;if(r>0)return r+h;const Y=te.get(o);return(Y&&Y.focus===F?0:-1)+h}function i(o){var Y;const r=(Y=o.keywordParams)==null?void 0:Y.ammoMax,h=typeof r=="number"?r:typeof r=="string"?Number(r):void 0;return Number.isFinite(h)?Number(h):0}function t(o,r){const h=[...s.weapons??[]],Y=h[o];if(r.ammo!==void 0&&!i(Y)&&r.ammo>0){const ge={...Y.keywordParams??{},ammoMax:r.ammo};h[o]={...Y,...r,keywordParams:ge},a.onChange({weapons:h});return}h[o]={...Y,...r},a.onChange({weapons:h})}function n(o,r){if(o===null||o===r)return;const h=a.sheet.weapons??[];if(o<0||o>=h.length||r<0||r>=h.length)return;const Y=[...h],[ye]=Y.splice(o,1);Y.splice(r,0,ye),a.onChange({weapons:Y}),M(r)}function C(o){const r=st.find(Y=>Y.id===o);if(!r)return;const h=[...s.weapons??[]];h.push({name:r.name,skillId:r.skillId,useDC:r.useDC,damage:r.damage,range:r.range,ammo:r.ammo,bulk:r.bulk,req:r.req,cost:r.cost,keywords:[...r.keywords??[]],keywordParams:{ammoMax:r.ammo??0,...r.keywordParams??{}}}),a.onChange({weapons:h})}function P(){const o=[...s.weapons??[]];o.push({name:"New Weapon",skillId:"weapons_medium",useDC:8,damage:3,range:"Med",ammo:0,bulk:1,req:"",cost:0,keywords:[],keywordParams:{ammoMax:0}}),a.onChange({weapons:o})}function N(o){const r=[...s.weapons??[]];r.splice(o,1),a.onChange({weapons:r})}async function m(o,r){const h=i(r),Y=Number.isFinite(r.ammo)?Number(r.ammo):0;if(h>0&&Y<=0){W.notification.show("Out of ammo. Reload first.","WARNING");return}const ye=T(r.skillId);await ht({weapon:r,useDC:Number.isFinite(r.useDC)?Number(r.useDC):0,netDice:v,modifier:ye,rollTarget:"everyone",showResults:!0}),h>0&&t(o,{ammo:Math.max(0,Y-1)})}const[y,H]=k.useState(""),[Z,se]=k.useState("");function ie(o){const r=it.find(h=>h.id===o);r&&a.onChange({armor:{name:r.name,keywords:[...r.keywords??[]],keywordParams:{...r.keywordParams??{}},protection:r.protection,durability:{current:r.durability,max:r.durability},bulk:r.bulk,req:r.req,cost:r.cost,special:r.special}})}return e.jsxs(q,{spacing:2,children:[e.jsx(I,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",gap:2,flexWrap:"wrap"},children:e.jsx(j,{variant:"h6",sx:{m:0},children:"Combat"})}),e.jsxs(I,{sx:{display:"flex",alignItems:"center",gap:1,flexWrap:"wrap"},children:[e.jsx(j,{variant:"subtitle2",sx:{opacity:.8},children:"Take Damage:"}),e.jsx(p,{size:"small",type:"number",inputProps:{min:0},value:b,onChange:o=>d(o.target.value),sx:{width:90}}),e.jsx(ne,{size:"small",value:"unmitigated",selected:S,onChange:()=>V(o=>!o),children:"Unmitigated"}),e.jsx(xe,{size:"small",variant:"outlined",onClick:R,children:"Apply"})]}),e.jsxs(I,{sx:{display:"flex",alignItems:"center",gap:1,flexWrap:"wrap"},children:[e.jsx(j,{variant:"subtitle2",sx:{opacity:.8},children:"Attack Roll:"}),e.jsxs(Be,{size:"small",exclusive:!0,value:v,onChange:(o,r)=>{r!==null&&g(r)},children:[e.jsx(ne,{value:-2,children:"−2"}),e.jsx(ne,{value:-1,children:"−1"}),e.jsx(ne,{value:0,children:"0"}),e.jsx(ne,{value:1,children:"+1"}),e.jsx(ne,{value:2,children:"+2"})]})]}),e.jsxs(Pe,{defaultExpanded:!0,children:[e.jsx(Ae,{expandIcon:e.jsx(Ne,{}),children:e.jsx(j,{fontWeight:700,children:"Weapons"})}),e.jsx(ze,{children:e.jsxs(q,{spacing:1.5,children:[e.jsxs(I,{sx:{display:"flex",gap:1,alignItems:"center",flexWrap:"wrap"},children:[e.jsxs(p,{label:"Add prefab weapon",size:"small",select:!0,value:y,onChange:o=>H(o.target.value),sx:{minWidth:240},children:[e.jsx(pe,{value:"",children:"— choose —"}),st.map(o=>e.jsx(pe,{value:o.id,children:o.name},o.id))]}),e.jsx(de,{color:"primary",onClick:()=>C(y),"aria-label":"Add prefab weapon",disabled:!y,children:e.jsx(we,{})}),e.jsx(I,{sx:{flex:1}}),e.jsx(de,{color:"primary",onClick:P,"aria-label":"Add custom weapon",children:e.jsx(we,{})}),e.jsx(j,{variant:"body2",sx:{opacity:.75},children:"Add custom weapon"})]}),(s.weapons??[]).length===0?e.jsx(j,{sx:{opacity:.75},children:"No weapons yet."}):(s.weapons??[]).map((o,r)=>e.jsxs(I,{draggable:!0,onDragStart:()=>M(r),onDragEnd:()=>M(null),onDragOver:h=>{h.preventDefault()},onDrop:h=>{h.preventDefault(),n(E,r)},sx:{border:"1px solid",borderColor:"divider",borderRadius:2,p:1.25,cursor:"grab",opacity:E===r?.85:1,display:"grid",gap:1.25},children:[e.jsxs(I,{sx:{display:"flex",gap:1,alignItems:"center"},children:[e.jsx(p,{label:"Name",size:"small",value:o.name,onChange:h=>t(r,{name:h.target.value}),fullWidth:!0}),e.jsx(ke,{title:"Roll attack with Dice+",children:e.jsx(de,{onClick:()=>m(r,o),"aria-label":`Roll attack for ${o.name}`,children:e.jsx(Ee,{})})}),e.jsx(de,{onClick:()=>N(r),"aria-label":"Remove weapon",children:e.jsx(Oe,{})})]}),e.jsxs(I,{sx:{display:"grid",gridTemplateColumns:"1fr 1fr 1fr 1fr",gap:1},children:[e.jsx(p,{label:"Skill",size:"small",select:!0,value:o.skillId,onChange:h=>t(r,{skillId:h.target.value}),children:w.map(h=>e.jsx(pe,{value:h.id,children:h.label},h.id))}),e.jsx(p,{label:"Use DC",size:"small",type:"number",value:o.useDC,onChange:h=>t(r,{useDC:Number(h.target.value)})}),e.jsx(p,{label:"Damage",size:"small",type:"number",value:o.damage,onChange:h=>t(r,{damage:Number(h.target.value)})}),e.jsx(p,{label:"Range",size:"small",value:o.range??"",onChange:h=>t(r,{range:h.target.value}),placeholder:"Melee / Short / Med / Long"}),e.jsxs(I,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(p,{label:"Ammo",size:"small",type:"number",value:o.ammo??0,onChange:h=>t(r,{ammo:Number(h.target.value)}),sx:{width:110}}),e.jsxs(j,{variant:"body2",sx:{opacity:.8},children:["/ ",i(o)||0]}),e.jsx(ke,{title:"Reload",children:e.jsx("span",{children:e.jsx(de,{size:"small",onClick:()=>t(r,{ammo:i(o)||0}),disabled:(i(o)||0)<=0,children:e.jsx(ct,{fontSize:"small"})})})})]}),e.jsx(p,{label:"Bulk",size:"small",type:"number",value:o.bulk??0,onChange:h=>t(r,{bulk:Number(h.target.value)})}),e.jsx(p,{label:"Req.",size:"small",value:o.req??"",onChange:h=>t(r,{req:h.target.value}),placeholder:"PHYS 1 / REF 2 / etc"}),e.jsx(p,{label:"Keywords (comma)",size:"small",value:(o.keywords??[]).join(", "),onChange:h=>t(r,{keywords:h.target.value.split(",").map(Y=>Y.trim()).filter(Boolean)}),placeholder:"Two-Handed, Piercing 1",sx:{gridColumn:"1 / -1"}})]})]},o.id??`${o.name}-${r}`))]})})]}),e.jsxs(Pe,{defaultExpanded:!0,children:[e.jsx(Ae,{expandIcon:e.jsx(Ne,{}),children:e.jsx(j,{fontWeight:700,children:"Armor"})}),e.jsx(ze,{children:e.jsxs(q,{spacing:1.5,children:[e.jsxs(I,{sx:{display:"flex",gap:1,alignItems:"center",flexWrap:"wrap"},children:[e.jsxs(p,{label:"Set prefab armor",size:"small",select:!0,value:Z,onChange:o=>se(o.target.value),sx:{minWidth:240},children:[e.jsx(pe,{value:"",children:"— choose —"}),it.map(o=>e.jsx(pe,{value:o.id,children:o.name},o.id))]}),e.jsx(de,{color:"primary",onClick:()=>ie(Z),"aria-label":"Set prefab armor",disabled:!Z,children:e.jsx(we,{})})]}),e.jsxs(I,{sx:{border:"1px solid",borderColor:"divider",borderRadius:2,p:1.25},children:[e.jsxs(I,{sx:{display:"grid",gridTemplateColumns:"2fr 1fr 1fr 1fr",gap:1},children:[e.jsx(p,{label:"Name",size:"small",value:((Q=s.armor)==null?void 0:Q.name)??"",onChange:o=>a.onChange({armor:{...s.armor??{durability:{current:0,max:0},protection:0,keywords:[],keywordParams:{ammoMax:0}},name:o.target.value}})}),e.jsx(p,{label:"Protection",size:"small",type:"number",value:((c=s.armor)==null?void 0:c.protection)??0,onChange:o=>a.onChange({armor:{...s.armor??{name:"",durability:{current:0,max:0},keywords:[],keywordParams:{}},protection:Number(o.target.value)}})}),e.jsx(p,{label:"Durability (cur)",size:"small",type:"number",value:((x=s.armor)==null?void 0:x.durability.current)??0,onChange:o=>{var r;return a.onChange({armor:{...s.armor??{name:"",durability:{current:0,max:0},protection:0,keywords:[],keywordParams:{}},durability:{...((r=s.armor)==null?void 0:r.durability)??{current:0,max:0},current:Number(o.target.value)}}})}}),e.jsx(p,{label:"Durability (max)",size:"small",type:"number",value:((_=s.armor)==null?void 0:_.durability.max)??0,onChange:o=>{var r;return a.onChange({armor:{...s.armor??{name:"",durability:{current:0,max:0},protection:0,keywords:[],keywordParams:{}},durability:{...((r=s.armor)==null?void 0:r.durability)??{current:0,max:0},max:Number(o.target.value)}}})}})]}),(((re=(ae=s.armor)==null?void 0:ae.durability)==null?void 0:re.max)??0)>0&&(((me=(B=s.armor)==null?void 0:B.durability)==null?void 0:me.current)??0)<=0&&e.jsx(j,{sx:{mt:1},color:"error",variant:"body2",children:"Broken: armor provides no Protection until repaired."}),e.jsxs(I,{sx:{display:"grid",gridTemplateColumns:"1fr 1fr 1fr 2fr",gap:1,mt:1},children:[e.jsx(p,{label:"Bulk",size:"small",type:"number",value:((he=s.armor)==null?void 0:he.bulk)??0,onChange:o=>a.onChange({armor:{...s.armor??{name:"",durability:{current:0,max:0},protection:0,keywords:[],keywordParams:{}},bulk:Number(o.target.value)}})}),e.jsx(p,{label:"Req.",size:"small",value:((Ce=s.armor)==null?void 0:Ce.req)??"",onChange:o=>a.onChange({armor:{...s.armor??{name:"",durability:{current:0,max:0},protection:0,keywords:[],keywordParams:{}},req:o.target.value}})}),e.jsx(p,{label:"Special",size:"small",value:((Me=s.armor)==null?void 0:Me.special)??"",onChange:o=>a.onChange({armor:{...s.armor??{name:"",durability:{current:0,max:0},protection:0,keywords:[],keywordParams:{}},special:o.target.value}})})]}),e.jsx(I,{sx:{mt:1},children:e.jsx(p,{label:"Keywords (comma)",size:"small",fullWidth:!0,value:(((Se=s.armor)==null?void 0:Se.keywords)??[]).join(", "),onChange:o=>a.onChange({armor:{...s.armor??{name:"",durability:{current:0,max:0},protection:0,keywords:[],keywordParams:{}},keywords:o.target.value.split(",").map(r=>r.trim()).filter(Boolean)}}),placeholder:"Frontal Shielding 1"})})]})]})})]})]})}const na=[{name:"Flashbang Grenade",effect:"Applies Stun 1 to everyone within near range, Thrown",uses:"1 use",bulk:1,cost:200},{name:"Frag Grenade",effect:"Deals 2 area (near range) damage (DC8 to Evade half), Thrown",uses:"1 use",bulk:1,cost:250},{name:"EMP Grenade",effect:"Applies EMP 2 to everything within range, Thrown",uses:"1 use",bulk:1,cost:300},{name:"Combat Stim Injector",effect:"Gain +1 action & -1 Stress; take 1 wound after effect ends",uses:"1 use",bulk:1,cost:200},{name:"Basic Medkit",effect:"Right tool for the job: First Aid checks",uses:"3 uses",bulk:1,cost:350},{name:"Multitool",effect:"Allows engineering checks to repair, bypass, scrap, etc.",uses:"Permanent",bulk:1,cost:750},{name:"Repair Kit",effect:"Provides materials and tools for repairs",uses:"10 uses",bulk:1,cost:500},{name:"Tracker",effect:"While within 10km, always know location of this device",uses:"1 use",bulk:1,cost:250},{name:"Portable Scanner",effect:"Right tool for the job: Observe (tech, lifeforms)",uses:"Permanent",bulk:1,cost:400},{name:"Weapon Scope",effect:"Simple Modification. Grants +1 bonus die to called shots at medium range and farther; inflicts +1 penalty die to attacks at close range or nearer",uses:"Permanent",bulk:1,cost:750},{name:"Weapon Silencer",effect:"Simple Modification. Weapon makes reduced sound when fired; deals -1 damage",uses:"Permanent",bulk:1,cost:500},{name:"Compact Backpack",effect:"+5 Inventory Slots when worn",uses:"Permanent",bulk:0,cost:150,statusEffects:"carrying_capacity+5"},{name:"Ammo (Flechette)",effect:"Deals +2 damage to unarmoured targets.",uses:"10 rounds",bulk:1,cost:500},{name:"Ammo (SMART)",effect:"Required for Smart-Linked weapons.",uses:"10",bulk:1,cost:1250},{name:"Ammo (Armour Piercing)",effect:"Adds Piercing 1 to attacks.",uses:"10",bulk:1,cost:750},{name:"Ammo (Explosive)",effect:"Adds Shredding 1 to attacks.",uses:"10",bulk:1,cost:750}],sa={items:na},ia=sa.items,ra=[{name:"Reflex Booster",tier:1,effect:"Once per round, gain +1 bonus die to an Evade check.",installationDifficulty:2,requirements:"REF 1",physicalImpact:"Low; spine",bulk:1,cost:3e3},{name:"Targeting Link",tier:1,effect:"Once per round, ignore 1 level of cover when attacking an enemy you can see.",installationDifficulty:2,requirements:"-",physicalImpact:"Medium; eyes",bulk:1,cost:4e3},{name:"Low-Light Optics",tier:1,effect:"Ignore penalty dice caused by darkness within medium range.",installationDifficulty:1,requirements:"-",physicalImpact:"Medium; eyes",bulk:1,cost:2e3},{name:"EMP Shielding",tier:1,effect:"Ignore the effects of EMP once per day.",installationDifficulty:2,requirements:"MENT 1",physicalImpact:"None; torso",bulk:1,cost:3500},{name:"Metabolic Filter",tier:1,effect:"Gain +1 bonus die on checks to resist toxins or narcotics.",installationDifficulty:1,requirements:"PHYS 1",physicalImpact:"Minor; liver",bulk:1,cost:1500},{name:"Compact Databank",tier:2,effect:"Internal information storage device; store/access info at will.",installationDifficulty:2,requirements:"MENT 1",physicalImpact:"Medium; cranium",bulk:1,cost:5e3}],la={cyberware:ra},oa=la.cyberware,ca=[{name:"Space Dust",effect:"Grants +1 bonus die to Observe and Piloting checks for 6 hours",uses:5,addictionScore:1,legality:"Legal",bulk:1,cost:500},{name:"Tranquility",effect:"Reduces stress by 1; penalty die to all REF checks for 6 hours.",uses:2,addictionScore:5,legality:"Legal",bulk:1,cost:5e3},{name:"Smoothe",effect:"Reduces stress by 1d4; increases Cool Under Fire by 2 and grants +1 bonus die to all Mental skill checks for 1 hour",uses:1,addictionScore:8,legality:"Illegal",bulk:1,cost:2e4},{name:"Chemical Strength",effect:"+1 bonus die to all PHYS checks for 1 hour; +1 movement bonus for 1 hour. After 1 hour, +1 penalty die to all PHYS checks and +1 movement penalty until sleep.",uses:1,addictionScore:3,legality:"Illegal",bulk:1,cost:8e3}],da={narcotics:ca},ua=da.narcotics;function ma(){return`inv_${Date.now()}_${Math.random().toString(36).slice(2,9)}`}function ha(a){const s=a.sheet.inventory??[],v=t=>{a.onChange({inventory:t})},[g,E]=k.useState("item"),[M,b]=k.useState(null),[d,S]=k.useState({}),[V,te]=k.useState(null),[O,X]=k.useState(null),w=k.useMemo(()=>g==="item"?ia.map(t=>({type:"item",...t})):g==="cyberware"?oa.map(t=>({type:"cyberware",...t})):ua.map(t=>({type:"narcotics",...t})),[g]);function F(t){b(t);const n=w.find(C=>C.name===t);if(!n){S({type:g,name:"",quantity:1,bulk:g==="item"?0:1,effect:"",cost:0,statusEffects:""});return}S(g==="item"?{type:"item",name:n.name,quantity:1,uses:n.uses??"",bulk:n.bulk??0,effect:n.effect??"",cost:n.cost??0,statusEffects:n.statusEffects??""}:g==="cyberware"?{type:"cyberware",name:n.name,quantity:1,bulk:n.bulk??1,tier:n.tier??1,installationDifficulty:n.installationDifficulty??0,requirements:n.requirements??"",physicalImpact:n.physicalImpact??"",effect:n.effect??"",cost:n.cost??0,statusEffects:n.statusEffects??""}:{type:"narcotics",name:n.name,quantity:1,bulk:n.bulk??1,uses:n.uses??1,addictionScore:n.addictionScore??0,legality:n.legality??"",effect:n.effect??"",cost:n.cost??0,statusEffects:n.statusEffects??""})}function R(){const t=[...s,{id:ma(),...d}];a.onChange({inventory:t}),b(null),S({type:g,name:"",quantity:1,bulk:g==="item"?0:1,effect:"",cost:0,statusEffects:""})}function T(t){a.onChange({inventory:s.filter(n=>n.id!==t)})}function i(t,n){a.onChange({inventory:s.map(C=>C.id===t?{...C,...n}:C)})}return e.jsxs(q,{spacing:2,children:[e.jsx(p,{label:"Credits",type:"number",value:a.sheet.credits??0,onChange:t=>a.onChange({credits:Number(t.target.value)}),size:"small"}),e.jsxs(I,{children:[e.jsx(j,{variant:"subtitle2",sx:{mb:1},children:"Add Inventory"}),e.jsxs(q,{direction:{xs:"column",sm:"row"},spacing:1,alignItems:"center",children:[e.jsxs(p,{select:!0,size:"small",label:"Type",value:g,onChange:t=>{const n=t.target.value;E(n),b(null),S(n==="item"?{type:n,name:"",quantity:1,bulk:0,uses:"",effect:"",cost:0,statusEffects:""}:n==="cyberware"?{type:n,name:"",quantity:1,bulk:1,tier:1,installationDifficulty:0,requirements:"",physicalImpact:"",effect:"",cost:0,statusEffects:""}:{type:n,name:"",quantity:1,bulk:1,uses:1,addictionScore:0,legality:"",effect:"",cost:0,statusEffects:""})},sx:{minWidth:160},children:[e.jsx(pe,{value:"item",children:"Item"}),e.jsx(pe,{value:"cyberware",children:"Cyberware"}),e.jsx(pe,{value:"narcotics",children:"Narcotics"})]}),e.jsx(Dt,{size:"small",sx:{flex:1,minWidth:220},options:w.map(t=>t.name),value:M,onChange:(t,n)=>F(n),renderInput:t=>e.jsx(p,{...t,label:"Template (optional)"})}),e.jsx(xe,{variant:"contained",startIcon:e.jsx(we,{}),onClick:R,disabled:!(d!=null&&d.name),children:"Add"})]}),e.jsx(I,{sx:{mt:1},children:e.jsxs(q,{spacing:1,children:[e.jsxs(q,{direction:{xs:"column",sm:"row"},spacing:1,children:[e.jsx(p,{size:"small",label:"Name",value:(d==null?void 0:d.name)??"",onChange:t=>S(n=>({...n,name:t.target.value})),sx:{flex:1}}),e.jsx(p,{size:"small",type:"number",label:"Bulk",value:(d==null?void 0:d.bulk)??0,onChange:t=>S(n=>({...n,bulk:Number(t.target.value)})),sx:{width:120}}),e.jsx(p,{size:"small",type:"number",label:"Quantity",value:(d==null?void 0:d.quantity)??1,onChange:t=>{const n=Number(t.target.value);Number.isFinite(n)&&S(C=>({...C,quantity:n}))},sx:{width:120}}),e.jsx(p,{size:"small",type:"number",label:"Cost",value:(d==null?void 0:d.cost)??0,onChange:t=>S(n=>({...n,cost:Number(t.target.value)})),sx:{width:140}})]}),g==="item"&&e.jsx(p,{size:"small",label:"Uses",value:(d==null?void 0:d.uses)??"",onChange:t=>S(n=>({...n,uses:t.target.value}))}),g==="cyberware"&&e.jsxs(q,{direction:{xs:"column",sm:"row"},spacing:1,children:[e.jsx(p,{size:"small",type:"number",label:"Tier",value:(d==null?void 0:d.tier)??1,onChange:t=>S(n=>({...n,tier:Number(t.target.value)})),sx:{width:120}}),e.jsx(p,{size:"small",type:"number",label:"Installation Difficulty",value:(d==null?void 0:d.installationDifficulty)??0,onChange:t=>S(n=>({...n,installationDifficulty:Number(t.target.value)})),sx:{width:220}}),e.jsx(p,{size:"small",label:"Requirements",value:(d==null?void 0:d.requirements)??"",onChange:t=>S(n=>({...n,requirements:t.target.value})),sx:{flex:1}})]}),g==="cyberware"&&e.jsx(p,{size:"small",label:"Physical Impact",value:(d==null?void 0:d.physicalImpact)??"",onChange:t=>S(n=>({...n,physicalImpact:t.target.value}))}),g==="narcotics"&&e.jsxs(q,{direction:{xs:"column",sm:"row"},spacing:1,children:[e.jsx(p,{size:"small",type:"number",label:"Uses",value:(d==null?void 0:d.uses)??1,onChange:t=>S(n=>({...n,uses:Number(t.target.value)})),sx:{width:120}}),e.jsx(p,{size:"small",type:"number",label:"Addiction Score",value:(d==null?void 0:d.addictionScore)??0,onChange:t=>S(n=>({...n,addictionScore:Number(t.target.value)})),sx:{width:160}}),e.jsx(p,{size:"small",label:"Legality",value:(d==null?void 0:d.legality)??"",onChange:t=>S(n=>({...n,legality:t.target.value})),sx:{flex:1}})]}),e.jsx(p,{size:"small",label:"Effect",value:(d==null?void 0:d.effect)??"",onChange:t=>S(n=>({...n,effect:t.target.value})),multiline:!0,minRows:2}),e.jsx(p,{size:"small",label:"Status Effects (comma-separated)",value:(d==null?void 0:d.statusEffects)??"",onChange:t=>S(n=>({...n,statusEffects:t.target.value})),placeholder:'e.g. "carrying_capacity+5"'})]})})]}),e.jsxs(I,{children:[e.jsx(j,{variant:"subtitle2",sx:{mb:1},children:"Inventory"}),s.length===0&&e.jsx(j,{variant:"body2",children:"No inventory items yet."}),s.map(t=>{const n=t.quantity??1,P=(t.bulk??0)*n,N=`${t.name} (${t.type}) • bulk ${P}`;return e.jsxs(Pe,{disableGutters:!0,children:[e.jsx(Ae,{expandIcon:e.jsx(Ne,{}),draggable:!0,onDragStart:m=>{te(t.id??null);try{m.dataTransfer.effectAllowed="move",m.dataTransfer.setData("text/plain",t.id??"")}catch{}},onDragOver:m=>{m.preventDefault(),X(t.id??null)},onDragLeave:()=>X(null),onDrop:m=>{m.preventDefault();const y=V??m.dataTransfer.getData("text/plain"),H=t.id;if(y&&H&&y!==H){const Z=a.sheet.inventory??[],se=Z.findIndex(Q=>Q.id===y),ie=Z.findIndex(Q=>Q.id===H);if(se>=0&&ie>=0){const Q=[...Z],[c]=Q.splice(se,1);Q.splice(ie,0,c),v(Q)}}te(null),X(null)},sx:O===t.id?{outline:"2px dashed rgba(255,255,255,0.35)",borderRadius:1}:void 0,children:e.jsxs(q,{direction:"row",spacing:1,alignItems:"center",sx:{width:"100%"},children:[e.jsx(Et,{fontSize:"small",sx:{opacity:.5}}),e.jsx(j,{variant:"body2",sx:{flex:1},children:N}),e.jsxs(q,{direction:"row",spacing:.5,alignItems:"center",children:[e.jsx(de,{size:"small",onClick:m=>{m.stopPropagation();const y=(t.quantity??1)-1;y<=0?T(t.id):i(t.id,{quantity:y})},children:e.jsx(ot,{fontSize:"small"})}),e.jsx(j,{variant:"caption",sx:{minWidth:18,textAlign:"center"},children:t.quantity??1}),e.jsx(de,{size:"small",onClick:m=>{m.stopPropagation(),i(t.id,{quantity:(t.quantity??1)+1})},children:e.jsx(we,{fontSize:"small"})})]}),e.jsx(ke,{title:"Remove",children:e.jsx(de,{size:"small",onClick:m=>(m.stopPropagation(),T(t.id)),children:e.jsx(Oe,{fontSize:"small"})})})]})}),e.jsx(ze,{children:e.jsxs(q,{spacing:1,children:[e.jsxs(q,{direction:{xs:"column",sm:"row"},spacing:1,children:[e.jsx(p,{size:"small",label:"Name",value:t.name??"",onChange:m=>i(t.id,{name:m.target.value}),sx:{flex:1}}),e.jsxs(p,{select:!0,size:"small",label:"Type",value:t.type,onChange:m=>i(t.id,{type:m.target.value}),sx:{width:160},children:[e.jsx(pe,{value:"item",children:"Item"}),e.jsx(pe,{value:"cyberware",children:"Cyberware"}),e.jsx(pe,{value:"narcotics",children:"Narcotics"})]}),e.jsx(p,{size:"small",type:"number",label:"Bulk",value:t.bulk??0,onChange:m=>i(t.id,{bulk:Number(m.target.value)}),sx:{width:120}}),e.jsx(p,{size:"small",type:"number",label:"Quantity",value:t.quantity??1,onChange:m=>{const y=Number(m.target.value);Number.isFinite(y)&&(y<=0?T(t.id):i(t.id,{quantity:y}))},sx:{width:120}}),e.jsx(p,{size:"small",type:"number",label:"Cost",value:t.cost??0,onChange:m=>i(t.id,{cost:Number(m.target.value)}),sx:{width:140}})]}),t.type==="item"&&e.jsx(p,{size:"small",label:"Uses",value:t.uses??"",onChange:m=>i(t.id,{uses:m.target.value})}),t.type==="cyberware"&&e.jsxs(q,{direction:{xs:"column",sm:"row"},spacing:1,children:[e.jsx(p,{size:"small",type:"number",label:"Tier",value:t.tier??1,onChange:m=>i(t.id,{tier:Number(m.target.value)}),sx:{width:120}}),e.jsx(p,{size:"small",type:"number",label:"Installation Difficulty",value:t.installationDifficulty??0,onChange:m=>i(t.id,{installationDifficulty:Number(m.target.value)}),sx:{width:220}}),e.jsx(p,{size:"small",label:"Requirements",value:t.requirements??"",onChange:m=>i(t.id,{requirements:m.target.value}),sx:{flex:1}})]}),t.type==="cyberware"&&e.jsx(p,{size:"small",label:"Physical Impact",value:t.physicalImpact??"",onChange:m=>i(t.id,{physicalImpact:m.target.value})}),t.type==="narcotics"&&e.jsxs(q,{direction:{xs:"column",sm:"row"},spacing:1,children:[e.jsx(p,{size:"small",type:"number",label:"Uses",value:t.uses??1,onChange:m=>i(t.id,{uses:Number(m.target.value)}),sx:{width:120}}),e.jsx(p,{size:"small",type:"number",label:"Addiction Score",value:t.addictionScore??0,onChange:m=>i(t.id,{addictionScore:Number(m.target.value)}),sx:{width:160}}),e.jsx(p,{size:"small",label:"Legality",value:t.legality??"",onChange:m=>i(t.id,{legality:m.target.value}),sx:{flex:1}})]}),e.jsx(p,{size:"small",label:"Effect",value:t.effect??"",onChange:m=>i(t.id,{effect:m.target.value}),multiline:!0,minRows:2}),e.jsx(p,{size:"small",label:"Status Effects (comma-separated)",value:t.statusEffects??"",onChange:m=>i(t.id,{statusEffects:m.target.value}),placeholder:'e.g. "carrying_capacity+5"'})]})})]},t.id)})]})]})}function fa(){const a=new Map;return Object.keys(fe.learned).forEach(s=>{(fe.learned[s]??[]).forEach(v=>a.set(v.id,{focus:s}))}),a}function Je(a){var g;if(!a)return 0;const s=(g=a.keywordParams)==null?void 0:g.ammoMax,v=typeof s=="number"?s:typeof s=="string"?Number(s):void 0;return Number.isFinite(v)?Number(v):0}function xa(a,s,v,g,E){if(g>0)return g+E;const M=a.get(s);return(M&&M.focus===v?0:-1)+E}function pa(){const[a,s]=k.useState({entries:[],activeTokenId:void 0,updatedAt:Date.now()}),[v,g]=k.useState({}),[E,M]=k.useState(""),[b,d]=k.useState(!1),[S,V]=k.useState(0),te=i=>Math.max(-3,Math.min(3,i)),O=k.useMemo(()=>fa(),[]);k.useEffect(()=>{const i=pt(t=>s(t));return()=>i==null?void 0:i()},[]),k.useEffect(()=>{let i=!0;return(async()=>{var t,n,C,P;try{const[N,m]=await Promise.all([((n=(t=W.player).getId)==null?void 0:n.call(t))??Promise.resolve(""),((P=(C=W.player).getRole)==null?void 0:P.call(C))??Promise.resolve("")]);if(!i)return;M(String(N??"")),d(String(m).toUpperCase()==="GM")}catch{}})(),()=>{i=!1}},[]);const X=k.useMemo(()=>{const i=[...a.entries??[]];return i.sort((t,n)=>(n.initiative??0)-(t.initiative??0)),i},[a.entries]);k.useEffect(()=>{let i=!0;return(async()=>{var t,n,C,P,N,m,y;try{const H=X.map(ie=>ie.tokenId);if(!H.length){i&&g({});return}const Z=await W.scene.items.getItems(H),se={};for(const ie of Z){const Q=ie.id,c=await We(Q),x=c==null?void 0:c.armor,_=((t=x==null?void 0:x.durability)==null?void 0:t.current)??0,ae=!!x&&_<=0,re=ae?0:(x==null?void 0:x.protection)??0,B=(n=c==null?void 0:c.weapons)==null?void 0:n[0],me=Je(B),he=Number.isFinite(B==null?void 0:B.ammo)?Number(B==null?void 0:B.ammo):0;se[Q]={tokenId:Q,name:((N=(P=(C=ie.text)==null?void 0:C.plainText)==null?void 0:P.trim)==null?void 0:N.call(P))||(c==null?void 0:c.name)||"(Unnamed)",thumbUrl:(m=ie.image)==null?void 0:m.url,ownerPlayerId:String(((y=ie.metadata)==null?void 0:y[ve])??""),prot:re,armorBroken:ae,topWeaponName:B==null?void 0:B.name,topWeaponUseDC:B==null?void 0:B.useDC,topWeaponDamage:B==null?void 0:B.damage,topWeaponSkillId:B==null?void 0:B.skillId,topWeaponAmmo:he,topWeaponAmmoMax:me}}i&&g(se)}catch{}})(),()=>{i=!1}},[X]);async function w(i){var c,x,_,ae,re;const[t]=await W.scene.items.getItems([i]);if(!t)return;const n=await We(i);if(!n)return;const C=et([...(n.feats??[]).map(B=>B.statusEffects??"").filter(Boolean),...(n.inventory??[]).map(B=>B.statusEffects??"").filter(Boolean)]).deltas,P=Re(n.skills??{}),N=((c=n.stress)==null?void 0:c.current)??0,m=Math.max(0,(Le(n.skills??{})||0)-(((x=n.stress)==null?void 0:x.cufLoss)??0)),y=vt({attributes:P,stress:{current:N,cuf:m}},C),H=y.stress.cuf??m,Z=y.attributes.ref??P.ref??0,se=N>H,ie=_e({netDice:se?-1:0,modifier:Z,label:`${((_=t.text)==null?void 0:_.plainText)??n.name??"Token"} Initiative`}),Q=await rt({diceNotation:ie,rollTarget:"everyone",showResults:!0});await jt({tokenId:i,initiative:Q,name:((ae=t.text)==null?void 0:ae.plainText)??n.name??"Token",thumbUrl:(re=t.image)==null?void 0:re.url})}async function F(){var P,N;const i=await((N=(P=W.player).getSelection)==null?void 0:N.call(P))??[],t=i==null?void 0:i[0],n=await lt()??void 0,C=t||n;if(!C){W.notification.show("Select a token (or set your character) to roll initiative.","WARNING");return}await w(C)}async function R(i){var _,ae,re,B;const t=await We(i);if(!t)return;const n=(_=t.weapons)==null?void 0:_[0];if(!n){W.notification.show("No weapon in the top slot.","WARNING");return}const C=et([...(t.feats??[]).map(me=>me.statusEffects??"").filter(Boolean),...(t.inventory??[]).map(me=>me.statusEffects??"").filter(Boolean)]).deltas,N=(Le(t.skills??{})-(((ae=t.stress)==null?void 0:ae.cufLoss)??0)||0)+(C.cool_under_fire??0),y=(((re=t.stress)==null?void 0:re.current)??0)>N,H=String(n.skillId??""),Z=((B=t.skills)==null?void 0:B[H])??0,se=t.learningFocus??"combat",ie=xa(O,H,se,Z,C[H]??0),Q=Je(n),c=Number.isFinite(n==null?void 0:n.ammo)?Number(n==null?void 0:n.ammo):0;if(Q>0&&c<=0){W.notification.show("Out of ammo. Reload first.","WARNING");return}const x=te(S-(y?1:0));if(await ht({weapon:n,netDice:x,modifier:ie,rollTarget:"everyone",showResults:!0}),Q>0){const me=Math.max(0,c-1),he=[...t.weapons??[]];he[0]={...he[0],ammo:me},await Ve(i,{...t,weapons:he})}}async function T(i){var N;const t=await We(i);if(!t)return;const n=(N=t.weapons)==null?void 0:N[0];if(!n)return;const C=Je(n);if(C<=0)return;const P=[...t.weapons??[]];P[0]={...P[0],ammo:C},await Ve(i,{...t,weapons:P})}return e.jsxs(q,{spacing:2,children:[e.jsxs(I,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",gap:1,flexWrap:"wrap"},children:[e.jsx(j,{variant:"h6",sx:{m:0},children:"Initiative"}),e.jsxs(q,{direction:"row",spacing:1,alignItems:"center",children:[e.jsx(xe,{size:"small",variant:"contained",onClick:()=>void F(),startIcon:e.jsx(Ee,{}),children:"Roll Initiative"}),e.jsxs(I,{sx:{display:"flex",alignItems:"center",gap:1,flexWrap:"wrap",pl:1},children:[e.jsx(j,{variant:"body2",sx:{opacity:.8},children:"Attack Roll:"}),e.jsxs(Be,{size:"small",exclusive:!0,value:S,onChange:(i,t)=>{t!==null&&V(t)},children:[e.jsx(ne,{value:-2,children:"−2"}),e.jsx(ne,{value:-1,children:"−1"}),e.jsx(ne,{value:0,children:"0"}),e.jsx(ne,{value:1,children:"+1"}),e.jsx(ne,{value:2,children:"+2"})]})]}),b&&e.jsxs(e.Fragment,{children:[e.jsx(xe,{size:"small",variant:"outlined",onClick:()=>yt(),children:"Clear"}),e.jsx(xe,{size:"small",variant:"outlined",onClick:()=>gt(),children:"Advance"})]})]})]}),e.jsx(dt,{}),X.length===0?e.jsx(j,{variant:"body2",sx:{opacity:.75},children:"No initiative rolls yet."}):e.jsx(Pt,{dense:!0,disablePadding:!0,children:X.map(i=>{const t=v[i.tokenId],n=t==null?void 0:t.ownerPlayerId,C=b||!!n&&n===E,P=a.activeTokenId===i.tokenId,N=P&&C&&!b,m=!!i.surprised,y=(t==null?void 0:t.topWeaponAmmoMax)??0,H=(t==null?void 0:t.topWeaponAmmo)??0,Z=y>0&&H<=0;return e.jsxs(At,{sx:{borderRadius:1,mb:.5,bgcolor:P?"rgba(255,255,255,0.06)":"transparent",opacity:m?.55:1},secondaryAction:e.jsxs(q,{direction:"row",spacing:.5,alignItems:"center",children:[e.jsx(ke,{title:t!=null&&t.armorBroken?"Armor broken":"Protection",children:e.jsxs(I,{sx:{display:"inline-flex",alignItems:"center",gap:.5,px:1,py:.5,borderRadius:1,bgcolor:"rgba(0,0,0,0.25)"},children:[e.jsx(Lt,{fontSize:"small",sx:{color:t!=null&&t.armorBroken?"error.main":"inherit"}}),e.jsx(j,{variant:"caption",children:(t==null?void 0:t.prot)??0})]})}),(b||C)&&e.jsx(ke,{title:t!=null&&t.topWeaponName?Z?`Out of ammo: ${t.topWeaponName}`:`Attack: ${t.topWeaponName}`:"No top weapon",children:e.jsx("span",{children:e.jsx(de,{size:"small",disabled:!(t!=null&&t.topWeaponName)||Z,onClick:()=>void R(i.tokenId),children:e.jsx(Ee,{fontSize:"small"})})})}),(b||C)&&e.jsx(ke,{title:t!=null&&t.topWeaponName?y<=0?"No ammo to reload":`Reload: ${t.topWeaponName}`:"No top weapon",children:e.jsx("span",{children:e.jsx(de,{size:"small",disabled:!(t!=null&&t.topWeaponName)||y<=0,onClick:()=>void T(i.tokenId),children:e.jsx(ct,{fontSize:"small"})})})}),e.jsx(ke,{title:C||b?"Remove":"Only the owner or GM can remove",children:e.jsx("span",{children:e.jsx(de,{size:"small",disabled:!C&&!b,onClick:()=>kt(i.tokenId),children:e.jsx(Oe,{fontSize:"small"})})})})]}),children:[e.jsx(Nt,{children:e.jsx(zt,{src:t==null?void 0:t.thumbUrl,variant:"rounded",sx:{width:32,height:32,mr:1,cursor:"pointer"}})}),e.jsx(Wt,{primary:e.jsxs(I,{sx:{display:"flex",alignItems:"center",gap:1,flexWrap:"wrap"},children:[e.jsx(j,{variant:"body2",sx:{fontWeight:600},children:(t==null?void 0:t.name)??i.name??"Token"}),e.jsx(j,{variant:"caption",sx:{opacity:.75},children:i.initiative}),N&&e.jsx(j,{variant:"caption",sx:{px:1,py:.25,borderRadius:1,bgcolor:"rgba(0,128,255,0.2)"},children:"Your Turn"})]}),secondary:e.jsxs(I,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(Ft,{size:"small",checked:m,disabled:!b,onChange:se=>bt(i.tokenId,se.target.checked)}),e.jsx(j,{variant:"caption",sx:{opacity:.75},children:"Surprised"})]})})]},i.tokenId)})})]})}function ya(a){const[s,v]=k.useState([]),[g,E]=k.useState([]),[M,b]=k.useState("");k.useEffect(()=>{let w=!0,F=null,R=null;return W.onReady(async()=>{var t,n,C,P;if(!w)return;try{const N=await W.player.getId();w&&b(N)}catch{}const T=async()=>{try{const N=await W.party.getPlayers();if(!w)return;v((N??[]).map(m=>({id:m.id,name:m.name,role:m.role,metadata:m.metadata??{}})))}catch{w&&v([])}},i=async()=>{try{const N=await W.scene.items.getItems();if(!w)return;E(N??[])}catch{w&&E([])}};await Promise.all([T(),i()]),F=W.party.onChange(N=>{v((N??[]).map(m=>({id:m.id,name:m.name,role:m.role,metadata:m.metadata??{}})))}),R=(P=(C=(n=(t=W)==null?void 0:t.scene)==null?void 0:n.items)==null?void 0:C.onChange)==null?void 0:P.call(C,()=>{i()})}),()=>{w=!1,typeof F=="function"&&F(),typeof R=="function"&&R()}},[]);const d=k.useMemo(()=>{var F,R,T;const w=new Map;for(const i of g){const t=((T=(R=(F=i==null?void 0:i.text)==null?void 0:F.plainText)==null?void 0:R.trim)==null?void 0:T.call(R))||(i==null?void 0:i.name)||"Token";w.set(i.id,{name:t})}return w},[g]),S=k.useMemo(()=>{var F;const w=new Map;for(const R of g){const T=(F=R==null?void 0:R.metadata)==null?void 0:F[ve];if(!T)continue;const i=w.get(T)??[];i.push(R.id),w.set(T,i)}return w},[g]);async function V(w){const F=await W.player.getSelection()??[],R=F==null?void 0:F[0];if(!R){W.notification.show("Select a token to assign.","WARNING");return}await W.scene.items.updateItems([R],T=>{const i=T[0];i&&(i.metadata[ve]=w)}),w===M&&await je(R)}async function te(w){const F=g.filter(T=>{var i;return((i=T==null?void 0:T.metadata)==null?void 0:i[ve])===w});if(F.length===0)return;const R=F.map(T=>T.id);await W.scene.items.updateItems(R,T=>{T.forEach(i=>{i&&delete i.metadata[ve]})})}async function O(w){await W.scene.items.updateItems([w],F=>{const R=F[0];R&&delete R.metadata[ve]})}async function X(w){w===M&&await je(null)}return a.isGM?e.jsxs(q,{spacing:2,children:[e.jsxs(I,{children:[e.jsx(j,{variant:"h6",sx:{m:0},children:"Ownership"}),e.jsx(j,{variant:"body2",sx:{opacity:.8},children:"Assign tokens to players via selection. Ownership uses token metadata; player metadata is shown for reference."})]}),e.jsx(dt,{}),s.length===0?e.jsx(j,{sx:{opacity:.75},children:"No players found."}):e.jsx(q,{spacing:1.5,children:s.map(w=>{var t,n;const R=(S.get(w.id)??[]).map(C=>{var P;return{id:C,name:((P=d.get(C))==null?void 0:P.name)??C}}),T=(t=w.metadata)==null?void 0:t[wt],i=T?(n=d.get(T))==null?void 0:n.name:void 0;return e.jsxs(I,{sx:{border:"1px solid",borderColor:"divider",borderRadius:2,p:1.25},children:[e.jsxs(I,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",gap:1,flexWrap:"wrap"},children:[e.jsxs(I,{children:[e.jsx(j,{fontWeight:700,children:w.name}),e.jsxs(j,{variant:"caption",sx:{opacity:.7},children:[w.role," • ",w.id]})]}),e.jsxs(I,{sx:{display:"flex",gap:1,flexWrap:"wrap"},children:[e.jsx(xe,{size:"small",variant:"outlined",onClick:()=>void V(w.id),children:"Assign Selected Token"}),e.jsx(xe,{size:"small",variant:"outlined",onClick:()=>void te(w.id),children:"Clear Token Ownership"})]})]}),e.jsxs(I,{sx:{mt:1},children:[e.jsx(j,{variant:"caption",sx:{opacity:.7},children:"Token Metadata Ownership:"}),R.length?e.jsx(q,{spacing:.5,sx:{mt:.5},children:R.map(C=>e.jsxs(I,{sx:{display:"flex",alignItems:"center",gap:1,flexWrap:"wrap"},children:[e.jsx(j,{variant:"body2",children:C.name}),e.jsx(xe,{size:"small",variant:"outlined",onClick:()=>void O(C.id),children:"Unassign"})]},C.id))}):e.jsx(j,{variant:"body2",sx:{mt:.25},children:"—"})]}),e.jsxs(I,{sx:{mt:.75},children:[e.jsx(j,{variant:"caption",sx:{opacity:.7},children:"Player Metadata (myCharacterTokenId):"}),e.jsxs(I,{sx:{display:"flex",alignItems:"center",gap:1,flexWrap:"wrap",mt:.25},children:[e.jsx(j,{variant:"body2",children:T?`${i??"Unknown token"} (${T})`:"—"}),T&&e.jsx(xe,{size:"small",variant:"outlined",onClick:()=>void X(w.id),disabled:w.id!==M,children:"Clear"})]})]})]},w.id)})})]}):e.jsxs(I,{sx:{p:1},children:[e.jsx(j,{variant:"h6",sx:{m:0},children:"Ownership"}),e.jsx(j,{sx:{opacity:.8,mt:1},children:"GM only."})]})}function ga(){var o,r,h,Y,ye,ge,be;const[a,s]=k.useState({kind:"loading"}),[v,g]=k.useState("core"),[E,M]=k.useState(!1),[b,d]=k.useState(null),[S,V]=k.useState(!1),[te,O]=k.useState("sheet");async function X(u){var l,f,z,A,U,$;try{const K=await W.scene.items.getItems([u]),D=K==null?void 0:K[0];if(!D)return{ownerLabel:"unowned",thumbUrl:null};const J=((l=D==null?void 0:D.image)==null?void 0:l.url)??((f=D==null?void 0:D.image)==null?void 0:f.href)??(D==null?void 0:D.imageUrl)??(D==null?void 0:D.image)??((z=D==null?void 0:D.thumbnail)==null?void 0:z.url)??null,ee=(A=D==null?void 0:D.metadata)==null?void 0:A[ve];if(typeof ee!="string"||ee.length===0)return{ownerLabel:"unowned",thumbUrl:J};const oe=await W.player.getId();if(ee===oe)return{ownerLabel:"owned by you",thumbUrl:J};try{const G=(await(($=(U=W.party).getPlayers)==null?void 0:$.call(U))??[]).find(ue=>(ue==null?void 0:ue.id)===ee);return{ownerLabel:`owned by ${typeof(G==null?void 0:G.name)=="string"&&G.name.length>0?G.name:ee}`,thumbUrl:J}}catch{return{ownerLabel:`owned by ${ee}`,thumbUrl:J}}}catch{return{ownerLabel:"unowned",thumbUrl:null}}}async function w(){const u=await St();if(u)if(await Ue(u)){const J=await qe(u);if(!J)throw new Error("Could not load sheet from token.");const ee=Re(J.skills??{}),oe={...J,attributes:ee},ce=await X(u);s({kind:"ready",tokenId:u,sheet:oe,mode:"view",...ce});return}else await $e(null);let f=await lt();if(f||(f=await tt(),f&&await je(f)),!f){s({kind:"need-token"});return}let z=await Ue(f);if(!z){const D=await tt();D&&(f=D,await je(f),z=await Ue(f))}if(!z){await je(null),s({kind:"need-token"});return}const A=await qe(f);if(!A)throw new Error("Could not load sheet from token.");try{await at(f)}catch{}const U=Re(A.skills??{}),$={...A,attributes:U},K=await X(f);s({kind:"ready",tokenId:f,sheet:$,mode:"my",...K})}k.useEffect(()=>{let u=!1;return W.onReady(async()=>{try{const l=await W.player.getRole();u||V(String(l).toUpperCase()==="GM"),await w()}catch(l){u||s({kind:"error",message:l.message??"Unknown error"})}}),()=>{u=!0}},[]),k.useEffect(()=>{let u=null,l=null,f=!1;const z="whisperspace.combatLogLeader",A=2e3,U=6e3,$=`${Date.now()}-${Math.random().toString(36).slice(2,10)}`,K=()=>{try{const G=localStorage.getItem(z);return G?JSON.parse(G):null}catch{return null}},D=G=>{try{localStorage.setItem(z,JSON.stringify({id:$,ts:G??Date.now()}))}catch{}},J=()=>{const G=K();return G&&G.id===$},ee=()=>{const G=Date.now(),L=K();(!L||G-(L.ts??0)>U||L.id===$)&&D(G)},oe=()=>{const G=J();if(G&&!u)u=W.broadcast.onMessage(mt,L=>{const ue=L.data;ue!=null&&ue.text&&W.notification.show(String(ue.text),"INFO")});else if(!G&&u){try{u()}catch{}u=null}},ce=G=>{G.key===z&&oe()};return W.onReady(()=>{if(!f){try{window.addEventListener("storage",ce)}catch{}ee(),oe(),l=window.setInterval(()=>{f||(ee(),oe())},A)}}),()=>{f=!0;try{window.removeEventListener("storage",ce)}catch{}if(l!==null&&clearInterval(l),J())try{localStorage.removeItem(z)}catch{}if(typeof u=="function")try{u()}catch{}}},[]),k.useEffect(()=>{var A,U,$,K;if(a.kind!=="ready")return;const u=a.tokenId;let l=!1;const f=async()=>{var D,J;try{const ee=await W.scene.items.getItems([u]),oe=ee==null?void 0:ee[0],ce=String(((D=oe==null?void 0:oe.text)==null?void 0:D.plainText)??"").trim(),G=(J=oe==null?void 0:oe.image)==null?void 0:J.url;if(l||!ce&&!G)return;s(L=>{if(L.kind!=="ready"||L.tokenId!==u)return L;const ue=ce&&L.sheet.name!==ce?{...L.sheet,name:ce}:L.sheet;return{...L,sheet:ue,thumbUrl:G??L.thumbUrl}})}catch{}};f();const z=(K=($=(U=(A=W)==null?void 0:A.scene)==null?void 0:U.items)==null?void 0:$.onChange)==null?void 0:K.call($,D=>{Array.isArray(D)&&D.some(J=>(J==null?void 0:J.id)===u)&&f()});return()=>{l=!0,typeof z=="function"&&z()}},[a.kind,a.kind==="ready"?a.tokenId:null]);const F=k.useMemo(()=>a.kind==="ready"&&a.sheet.name||"Whisperspace Sheet",[a]);async function R(){const u=await $t();if(!u){s({kind:"error",message:"No token selected. Select a token on the map first."});return}const l=await qe(u);if(!l){s({kind:"error",message:"Could not attach a sheet to the selected token."});return}const f=Re(l.skills??{}),z={...l,attributes:f};await je(u);try{await at(u)}catch{}await $e(null);const A=await X(u);s({kind:"ready",tokenId:u,sheet:z,mode:"my",...A})}async function T(){await je(null),s({kind:"need-token"})}async function i(){await $e(null),s({kind:"loading"});try{await w()}catch(u){s({kind:"error",message:u.message??"Unknown error"})}}async function t(u,l){M(!0);try{await Ve(u,l)}finally{M(!1)}}function n(u){s(l=>{if(l.kind!=="ready")return l;let f=u(l.sheet);try{const z=Re(f.skills??{});f={...f,attributes:{...f.attributes,...z},stress:{...f.stress??{current:0,cuf:0,cufLoss:0},cuf:Le(f.skills??{})}}}catch{}return t(l.tokenId,f),{...l,sheet:f}})}async function C(u){var D;if(a.kind!=="ready")return;const l=8+u,f=Math.max(0,Math.trunc(((D=a.sheet.stress)==null?void 0:D.cuf)??0)),z=`Crucible Test (DC ${l})`,A=f===0?"":` +${f}`,U=`1d12 # ${z}${A}`,$=await Qe({diceNotation:U,rollTarget:"everyone",showResults:!0}),K=await new Promise((J,ee)=>{const oe=setTimeout(()=>{ce(),ee(new Error("Dice+ roll timed out (no roll-result received)"))},4e3),ce=W.broadcast.onMessage(`${It}/roll-result`,G=>{var Te;const L=G.data;if(!L||L.rollId!==$)return;clearTimeout(oe),ce();const ue=typeof L.total=="number"?L.total:typeof((Te=L==null?void 0:L.result)==null?void 0:Te.total)=="number"?L.result.total:typeof(L==null?void 0:L.value)=="number"?L.value:NaN;if(!Number.isFinite(ue)){ee(new Error("Dice+ roll-result received, but total was missing/invalid."));return}J(Math.trunc(ue))})});K>=l?(n(J=>({...J,stress:{...J.stress??{current:0,cuf:0,cufLoss:0},current:5},indomitable:!0})),d({incoming:u,dc:l,status:"success",total:K})):d({incoming:u,dc:l,status:"fail",total:K})}function P(u){var z;if(a.kind!=="ready")return;const l=Math.max(0,Math.trunc(((z=a.sheet.stress)==null?void 0:z.current)??0)),f=Math.max(0,Math.trunc(u));if(l<=5&&f>5){const A=f-l;d({incoming:A,dc:8+A,status:"pending"})}else d(null);n(A=>({...A,stress:{...A.stress??{current:0,cuf:0,cufLoss:0},current:f}}))}function N(u,l){var $;if(a.kind!=="ready")return;const z={light:4,moderate:2,heavy:1}[u],A=Math.max(0,Math.trunc((($=a.sheet.wounds)==null?void 0:$[u])??0)),U=l<A?l:l+1;n(K=>({...K,wounds:{...K.wounds,[u]:Math.min(z,Math.max(0,U))}}))}function m(){var l;if(a.kind!=="ready"||!b||b.status!=="fail")return;const u=Math.max(0,Math.trunc(((l=a.sheet.stress)==null?void 0:l.cufLoss)??0));n(f=>({...f,stress:{...f.stress??{current:0,cuf:0,cufLoss:0},cufLoss:u+1,current:5},indomitable:!0})),d({...b,status:"success"})}const y=a.kind==="ready"?a.sheet:null,H=De.useMemo(()=>{if(!y)return{};const u=[];return(y.feats??[]).forEach(l=>{typeof(l==null?void 0:l.statusEffects)=="string"&&l.statusEffects.trim()&&u.push(l.statusEffects)}),(y.inventory??[]).forEach(l=>{typeof(l==null?void 0:l.statusEffects)=="string"&&l.statusEffects.trim()&&u.push(l.statusEffects)}),Ct(u)},[y]),Z=De.useMemo(()=>{const u={},l=new Map,f=A=>{const U=String(A.id),$=String(A.name??A.label??"").toLowerCase().replace(/\s+/g,"_").replace(/[^a-z0-9_\-()]/g,"");U&&(l.set(U.toLowerCase(),U),$&&l.set($,U))};(fe.inherent??[]).forEach(f),Object.values(fe.learned??{}).forEach(A=>{(A??[]).forEach(f)});const z=new Set(["phys","ref","soc","ment","carrying_capacity","cool_under_fire","speed","cuf","carry","capacity","spd"]);return Object.entries(H??{}).forEach(([A,U])=>{const $=String(A).toLowerCase();if(z.has($))return;const K=l.get($);K&&(u[K]=(u[K]??0)+(Number.isFinite(U)?U:0))}),u},[H]),se=Math.max(0,(((o=y==null?void 0:y.attributes)==null?void 0:o.phys)??0)+(H.phys??0)),ie=Math.max(0,(((r=y==null?void 0:y.attributes)==null?void 0:r.ref)??0)+(H.ref??0)),Q=Math.max(0,(((h=y==null?void 0:y.attributes)==null?void 0:h.soc)??0)+(H.soc??0)),c=Math.max(0,(((Y=y==null?void 0:y.attributes)==null?void 0:Y.ment)??0)+(H.ment??0)),_=5+se*5+(H.carrying_capacity??0);30+se*5+(H.speed??0);const re=y?Le(y.skills??{}):0,B=Math.max(0,re+(H.cool_under_fire??0)),he=De.useMemo(()=>y?{...y,attributes:{...y.attributes,phys:se,ref:ie,soc:Q,ment:c},stress:{...y.stress??{current:0,cuf:0,cufLoss:0},cuf:B}}:null,[y,se,ie,Q,c,B])??y,Ce=De.useMemo(()=>{var z;if(!y)return 0;const u=(y.weapons??[]).reduce((A,U)=>A+(U.bulk??0),0),l=((z=y.armor)==null?void 0:z.bulk)??0,f=(y.inventory??[]).reduce((A,U)=>{const $=U.quantity??1,K=U.bulk??0,D=Number.isFinite(K)?K:0,J=Number.isFinite($)?$:1;return A+D*J},0);return u+l+f},[y]),Me=y&&Ce>_*2?"Heavily Encumbered":y&&Ce>_?"Encumbered":"";if(a.kind==="loading")return e.jsx("div",{style:{padding:12},children:"Loading…"});if(a.kind==="need-token")return e.jsxs("div",{style:{padding:12},children:[e.jsx("h2",{style:{margin:"0 0 8px 0"},children:"My Sheet"}),e.jsx("p",{style:{margin:"0 0 10px 0",lineHeight:1.35},children:"Select your character token on the map, then click:"}),e.jsx("button",{style:{padding:"8px 10px",borderRadius:8,border:"1px solid #666",cursor:"pointer"},onClick:R,children:"Set Selected Token as My Character"})]});if(a.kind==="error")return e.jsxs("div",{style:{padding:12},children:[e.jsx("h2",{style:{margin:"0 0 8px 0"},children:"Error"}),e.jsx("p",{style:{margin:"0 0 10px 0",lineHeight:1.35},children:a.message}),e.jsx("button",{style:{padding:"8px 10px",borderRadius:8,border:"1px solid #666",cursor:"pointer"},onClick:()=>s({kind:"need-token"}),children:"Back"})]});const Se=te==="sheet";return e.jsxs("div",{style:{padding:12},children:[e.jsxs("div",{style:{display:"flex",alignItems:"flex-start",gap:12,justifyContent:"space-between",marginBottom:10},children:[e.jsxs("div",{style:{display:"flex",gap:10,alignItems:"flex-start"},children:[a.thumbUrl?e.jsx("img",{src:a.thumbUrl,alt:"Token thumbnail",style:{width:44,height:44,borderRadius:10,objectFit:"cover",border:"1px solid rgba(0,0,0,0.2)"}}):e.jsx("div",{style:{width:44,height:44,borderRadius:10,border:"1px solid rgba(0,0,0,0.2)",opacity:.4}}),e.jsxs("div",{children:[e.jsxs("div",{style:{fontSize:18,fontWeight:700},children:[F," ",e.jsxs("span",{style:{fontSize:12,opacity:.75},children:["(",a.ownerLabel??(a.mode==="view"?"Viewing token":"My Character"),")"]})]}),e.jsxs("div",{style:{fontSize:12,opacity:.8},children:["Token: ",e.jsx("code",{style:{fontSize:11},children:a.tokenId})]})]})]}),e.jsxs("div",{style:{display:"flex",gap:8},children:[S&&e.jsx("button",{style:{padding:"8px 10px",borderRadius:8,border:"1px solid #999",cursor:"pointer",opacity:.9},onClick:()=>O(u=>u==="sheet"?"ownership":"sheet"),children:Se?"Ownership":"Back to Sheet"}),a.mode==="view"?e.jsx("button",{style:{padding:"8px 10px",borderRadius:8,border:"1px solid #999",cursor:"pointer",opacity:.9},onClick:i,children:"Back to My Sheet"}):e.jsx("button",{style:{padding:"8px 10px",borderRadius:8,border:"1px solid #999",cursor:"pointer",opacity:.9},onClick:T,children:"Unset “My Character”"})]})]}),Se&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{style:le.statusBar,children:[e.jsxs("div",{style:le.statusLeft,children:[e.jsxs("div",{style:le.statusGroup,children:[e.jsx("div",{style:le.statusLabel,children:"Stress"}),e.jsx("input",{type:"number",min:0,value:((ye=a.sheet.stress)==null?void 0:ye.current)??0,onChange:u=>P(Number(u.target.value)),style:le.statusNumber})]}),e.jsxs("div",{style:le.statusGroup,children:[e.jsx("div",{style:le.statusLabel,children:"Wounds"}),e.jsxs("div",{style:le.woundsRow,children:[e.jsx("span",{style:le.woundsKind,children:"L"}),Array.from({length:4}).map((u,l)=>{var f;return e.jsx("input",{type:"checkbox",checked:(((f=a.sheet.wounds)==null?void 0:f.light)??0)>l,onChange:()=>N("light",l)},`wl_${l}`)}),e.jsx("span",{style:{width:8}}),e.jsx("span",{style:le.woundsKind,children:"M"}),Array.from({length:2}).map((u,l)=>{var f;return e.jsx("input",{type:"checkbox",checked:(((f=a.sheet.wounds)==null?void 0:f.moderate)??0)>l,onChange:()=>N("moderate",l)},`wm_${l}`)}),e.jsx("span",{style:{width:8}}),e.jsx("span",{style:le.woundsKind,children:"H"}),Array.from({length:1}).map((u,l)=>{var f;return e.jsx("input",{type:"checkbox",checked:(((f=a.sheet.wounds)==null?void 0:f.heavy)??0)>l,onChange:()=>N("heavy",l)},`wh_${l}`)})]})]}),e.jsxs("label",{style:{display:"flex",alignItems:"center",gap:6},children:[e.jsx("input",{type:"checkbox",checked:!!a.sheet.indomitable,onChange:u=>n(l=>({...l,indomitable:u.target.checked}))}),e.jsx("span",{style:{fontSize:12,opacity:.9},children:"Indomitable"})]}),(((ge=a.sheet.stress)==null?void 0:ge.current)??0)>(((be=(he??a.sheet).stress)==null?void 0:be.cuf)??0)&&e.jsx("div",{style:le.warning,children:"Stress > CUF: make all rolls with +1 Penalty Die"}),e.jsxs("div",{style:{fontSize:12,opacity:.85},children:["Bulk: ",Ce," / ",_]}),Me&&e.jsx("div",{style:le.warning,children:Me})]}),e.jsxs("div",{style:le.statusRight,children:[b&&b.status==="pending"&&e.jsxs("div",{style:le.crucibleBox,children:[e.jsx("div",{style:{fontWeight:700},children:"Crucible Test!"}),e.jsxs("div",{style:{fontSize:12,opacity:.85},children:["Incoming stress: ",b.incoming," • DC ",b.dc," • Roll CUF (no bonus/penalty dice)"]}),e.jsx("button",{style:le.buttonSecondary,onClick:()=>void C(b.incoming),children:"Roll Crucible"})]}),b&&b.status==="success"&&e.jsxs("div",{style:le.crucibleBox,children:[e.jsx("div",{style:{fontWeight:700},children:"Crucible succeeded!"}),e.jsx("div",{style:{fontSize:12,opacity:.85},children:"Choose an Indomitable effect. (Indomitable checked automatically.)"})]}),b&&b.status==="fail"&&e.jsxs("div",{style:le.crucibleBox,children:[e.jsx("div",{style:{fontWeight:700},children:"Crucible failed"}),e.jsx("div",{style:{fontSize:12,opacity:.85},children:"You’ve entered PTSD range (6–8 stress)."}),e.jsx("button",{style:le.buttonSecondary,onClick:m,children:"Spend 1 CUF to pass"})]})]})]}),e.jsxs("div",{style:{display:"flex",gap:8,alignItems:"center",marginBottom:10},children:[e.jsx(Ie,{label:"Core",active:v==="core",onClick:()=>g("core")}),e.jsx(Ie,{label:"Skills",active:v==="skills",onClick:()=>g("skills")}),e.jsx(Ie,{label:"Combat",active:v==="combat",onClick:()=>g("combat")}),e.jsx(Ie,{label:"Initiative",active:v==="initiative",onClick:()=>g("initiative")}),e.jsx(Ie,{label:"Inventory",active:v==="inventory",onClick:()=>g("inventory")}),e.jsx(Ie,{label:"Feats",active:v==="feats",onClick:()=>g("feats")}),e.jsx("div",{style:{marginLeft:"auto",opacity:.8},children:E?"Saving…":"Synced"})]}),e.jsxs("div",{style:{border:"1px solid #888",borderRadius:12,padding:10},children:[v==="core"&&e.jsx(Ut,{sheet:he,onChange:u=>n(l=>({...l,...u}))}),v==="skills"&&e.jsx(Gt,{sheet:he,skillMods:Z,onChange:u=>n(l=>({...l,skills:u})),onMetaChange:u=>n(l=>({...l,...u}))}),v==="combat"&&e.jsx(aa,{sheet:he,tokenId:a.tokenId,skillMods:Z,onChange:u=>n(l=>({...l,...u})),onApplyStress:P}),v==="initiative"&&e.jsx(pa,{}),v==="inventory"&&e.jsx(ha,{sheet:he,onChange:u=>n(l=>({...l,...u}))}),v==="feats"&&e.jsx(Kt,{sheet:he,onChange:u=>n(l=>({...l,feats:u}))})]})]}),!Se&&e.jsx("div",{style:{border:"1px solid #888",borderRadius:12,padding:10},children:e.jsx(ya,{isGM:S})})]})}function Ie(a){return e.jsx("button",{onClick:a.onClick,style:{padding:"6px 10px",borderRadius:999,border:"1px solid #777",cursor:"pointer",background:"transparent",fontWeight:a.active?700:400},children:a.label})}const le={statusBar:{display:"flex",alignItems:"flex-start",justifyContent:"space-between",gap:12,padding:"10px 12px",borderRadius:12,border:"1px solid rgba(255,255,255,0.15)",marginBottom:10},statusLeft:{display:"flex",alignItems:"center",gap:16,flexWrap:"wrap"},statusRight:{display:"flex",alignItems:"center",gap:12},statusGroup:{display:"flex",flexDirection:"column",gap:4},statusLabel:{fontSize:11,opacity:.75,letterSpacing:.2},statusNumber:{width:64,fontSize:16},woundsRow:{display:"flex",alignItems:"center",gap:8,flexWrap:"wrap"},woundsKind:{fontSize:11,opacity:.75,width:14,textAlign:"center"},warning:{marginTop:8,fontSize:12,opacity:.9},crucibleBox:{border:"1px solid rgba(255,255,255,0.18)",borderRadius:12,padding:10,maxWidth:240},buttonSecondary:{padding:"6px 10px",borderRadius:8,border:"1px solid #999",cursor:"pointer",opacity:.9,background:"transparent"}};function ba(a){var te,O,X,w,F,R,T,i;const s=((a==null?void 0:a.mode)??"LIGHT")==="DARK"?"dark":"light",v=((te=a==null?void 0:a.background)==null?void 0:te.default)??(s==="dark"?"#121212":"#ffffff"),g=((O=a==null?void 0:a.background)==null?void 0:O.paper)??(s==="dark"?"#1e1e1e":"#f7f7f7"),E=((X=a==null?void 0:a.text)==null?void 0:X.primary)??(s==="dark"?"#ffffff":"#111111"),M=((w=a==null?void 0:a.text)==null?void 0:w.secondary)??(s==="dark"?"#bdbdbd":"#444444"),b=((F=a==null?void 0:a.primary)==null?void 0:F.main)??"#2f6fed",d=((R=a==null?void 0:a.primary)==null?void 0:R.contrastText)??"#ffffff",S=((T=a==null?void 0:a.secondary)==null?void 0:T.main)??"#7c3aed",V=((i=a==null?void 0:a.secondary)==null?void 0:i.contrastText)??"#ffffff";return Ot({palette:{mode:s,background:{default:v,paper:g},text:{primary:E,secondary:M},primary:{main:b,contrastText:d},secondary:{main:S,contrastText:V}},shape:{borderRadius:12},typography:{fontFamily:"system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif"},components:{MuiPaper:{defaultProps:{elevation:0}}}})}function ka(a){const[s,v]=k.useState(null);k.useEffect(()=>{let E=null;return(async()=>{const M=await W.theme.getTheme();v(M),E=W.theme.onChange(b=>v(b))})(),()=>{E&&E()}},[]);const g=k.useMemo(()=>ba(s),[s]);return e.jsxs(_t,{theme:g,children:[e.jsx(Bt,{}),a.children]})}async function va(){await W.onReady(async()=>{}),Mt.createRoot(document.getElementById("root")).render(e.jsx(De.StrictMode,{children:e.jsx(ka,{children:e.jsx(ga,{})})}))}va();
