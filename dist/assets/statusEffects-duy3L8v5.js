import{O as c}from"./vendor_obr-BLY5dk8V.js";import{o as f,s as r,n as o,r as E,u as P,b as M,a as b,d as q,l as g,e as Y}from"./vendor_zod-CxP395f9.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))s(a);new MutationObserver(a=>{for(const i of a)if(i.type==="childList")for(const u of i.addedNodes)u.tagName==="LINK"&&u.rel==="modulepreload"&&s(u)}).observe(document,{childList:!0,subtree:!0});function n(a){const i={};return a.integrity&&(i.integrity=a.integrity),a.referrerPolicy&&(i.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?i.credentials="include":a.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function s(a){if(a.ep)return;a.ep=!0;const i=n(a);fetch(a.href,i)}})();const S="whisperspace.sheet.v1",W=f({name:r().default(""),description:r().default(""),statusEffects:r().default("")}),j=f({name:r().default(""),keywords:b(r()).default([]),keywordParams:E(P([r(),o(),M()])).default({}),protection:o().int().nonnegative().default(0),durability:f({current:o().int().nonnegative().default(0),max:o().int().nonnegative().default(0)}).default({current:0,max:0}),bulk:o().int().nonnegative().optional(),req:r().optional(),cost:o().int().nonnegative().optional(),special:r().optional()}),B=f({id:r().optional(),name:r().default(""),skillId:r().default(""),useDC:o().int().default(8),damage:o().int().default(0),keywords:b(r()).default([]),keywordParams:E(P([r(),o(),M()])).default({}),range:r().optional(),ammo:o().int().nonnegative().optional(),bulk:o().int().nonnegative().optional(),req:r().optional(),cost:o().int().nonnegative().optional()}),O=f({schemaVersion:g(1).default(1),name:r().default(""),attributes:f({phys:o().int().nonnegative().default(0),ref:o().int().nonnegative().default(0),soc:o().int().nonnegative().default(0),ment:o().int().nonnegative().default(0)}).default({phys:0,ref:0,soc:0,ment:0}),stress:f({current:o().int().nonnegative().default(0),cuf:o().int().nonnegative().default(0),cufLoss:o().int().nonnegative().default(0)}).default({current:0,cuf:0,cufLoss:0}),wounds:f({light:o().int().nonnegative().default(0),moderate:o().int().nonnegative().default(0),heavy:o().int().nonnegative().default(0)}).default({light:0,moderate:0,heavy:0}),skills:E(o().int()).default({}),learningFocus:Y(["combat","education","vehicles"]).optional(),skillPoints:o().int().nonnegative().optional(),weapons:b(B).default([]),armor:j.optional(),credits:o().int().nonnegative().default(0),inventory:b(q("type",[f({id:r().optional(),type:g("item"),name:r().default(""),quantity:o().int().default(1),uses:r().default(""),bulk:o().int().default(0),effect:r().default(""),cost:o().int().default(0),statusEffects:r().default("")}),f({id:r().optional(),type:g("cyberware"),name:r().default(""),quantity:o().int().default(1),bulk:o().int().default(1),tier:o().int().default(1),installationDifficulty:o().int().default(0),requirements:r().default(""),physicalImpact:r().default(""),effect:r().default(""),cost:o().int().default(0),statusEffects:r().default("")}),f({id:r().optional(),type:g("narcotics"),name:r().default(""),bulk:o().int().default(1),quantity:o().int().default(1),uses:o().int().default(1),addictionScore:o().int().default(0),legality:r().default(""),effect:r().default(""),cost:o().int().default(0),statusEffects:r().default("")})])).default([]),indomitable:M().default(!1),feats:b(W).default([]),notes:r().optional()}),N=O;function L(e){const t=O.parse({});return typeof e=="string"&&e.trim().length>0?{...t,name:e.trim()}:t}function R(e){const t=N.safeParse(e);if(t.success)return t.data;const n=L(typeof(e==null?void 0:e.name)=="string"?e.name:void 0),s=e==null?void 0:e.skills,a=H(z(s)?s:{}),i={...n,...v(e,["name","archetype","background","motivation","notes"]),attributes:{...n.attributes,...v(e==null?void 0:e.attributes,["phys","ref","soc","ment"])},stress:{...n.stress,...v(e==null?void 0:e.stress,["current","cuf"])},wounds:{...n.wounds,...v(e==null?void 0:e.wounds,["light","moderate","heavy"])},skills:a,feats:Array.isArray(e==null?void 0:e.feats)?e.feats:n.feats,weapons:Array.isArray(e==null?void 0:e.weapons)?e.weapons:n.weapons,armor:(e==null?void 0:e.armor)??n.armor,schemaVersion:1},u=N.safeParse(i);return u.success?u.data:n}const ue=R,V={powerlifting:"powerlift",light_weapons:"weapons_light",medium_weapons:"weapons_medium",heavy_weapons:"weapons_heavy",exotic_weapons:"weapons_exotic",melee_blunt:"melee_weapons",melee_sharp:"melee_weapons"};function H(e){const t={};for(const[n,s]of Object.entries(e??{})){const a=V[n]??n,i=typeof s=="number"?s:0;t[a]=Math.max(t[a]??0,i)}for(const[n,s]of Object.entries(t))s||delete t[n];return t}function v(e,t){const n={};if(!e||typeof e!="object")return n;for(const s of t)e[s]!==void 0&&(n[s]=e[s]);return n}function z(e){if(!e||typeof e!="object")return!1;for(const t of Object.values(e))if(typeof t!="number")return!1;return!0}const A="com.whisperspace.sheet",T=`${A}/myCharacterTokenId`,_=`${A}/openTokenId`,C=`${A}/ownerPlayerId`;function U(e){return typeof e=="string"&&e.length>0}async function le(){const t=(await c.player.getMetadata())[T];return U(t)?t:null}async function de(e){const n={...await c.player.getMetadata()};e?n[T]=e:delete n[T],await c.player.setMetadata(n)}async function fe(){const t=(await c.player.getMetadata())[_];return U(t)?t:null}async function me(e){const n={...await c.player.getMetadata()};e?n[_]=e:delete n[_],await c.player.setMetadata(n)}async function G(e){var l,m;const n=(await c.scene.items.getItems([e]))[0];if(!n)return null;const s=(l=n==null?void 0:n.text)==null?void 0:l.plainText,a=s&&s.trim().length>0?s:n.name??"Unnamed",i=(m=n.metadata)==null?void 0:m[S];if(!i)return L(a);const u=R(i);return!u.name||u.name==="Unnamed"?{...u,name:a}:u}async function J(e,t){await c.scene.items.updateItems([e],n=>{const s=n[0];if(s){s.metadata[S]=t;try{const a=s.text??{};s.text={...a,plainText:t.name}}catch{}}})}async function Q(e){var s;const n=(await c.scene.items.getItems([e]))[0];return n?!!((s=n.metadata)!=null&&s[S]):!1}async function pe(e){const t=await G(e);return t?(await Q(e)||await J(e,t),t):null}async function be(e){const t=await c.player.getId();(await c.scene.items.getItems([e]))[0]&&await c.scene.items.updateItems([e],s=>{const a=s[0];a&&(a.metadata[C]=t)})}async function ye(){const e=await c.player.getId(),n=(await c.scene.items.getItems()).find(s=>{var a;return((a=s.metadata)==null?void 0:a[C])===e});return(n==null?void 0:n.id)??null}const D="dice-plus/isReady",F="dice-plus/roll-request",I="whisperspace.obr.sheet";async function X(e=1e3){const t=crypto.randomUUID();return new Promise(n=>{const s=c.broadcast.onMessage(D,a=>{const i=a.data;(i==null?void 0:i.requestId)===t&&i.ready===!0&&(s(),n(!0))});c.broadcast.sendMessage(D,{requestId:t,timestamp:Date.now()},{destination:"ALL"}),setTimeout(()=>{s(),n(!1)},e)})}function he(e){const t=Math.max(-2,Math.min(2,Math.trunc(e.netDice))),n=1+Math.abs(t);let s="1d12";t>0&&(s=`${n}d12kh1`),t<0&&(s=`${n}d12kl1`);const a=Number.isFinite(e.modifier)?Math.trunc(e.modifier):0,i=a===0?"":a>0?` +${a}`:` ${a}`;return`${s} # ${e.label}${i}`}async function ge(e){const t=crypto.randomUUID();return await c.broadcast.sendMessage(F,{rollId:t,playerId:await c.player.getId(),playerName:await c.player.getName(),rollTarget:e.rollTarget??"everyone",diceNotation:e.diceNotation,showResults:e.showResults??!0,timestamp:Date.now(),source:I},{destination:"ALL"}),t}async function ve(e){if(!await X())throw new Error("Dice+ is not available");const n=crypto.randomUUID(),s=e.timeoutMs??5e3;return new Promise(async(a,i)=>{const u=c.broadcast.onMessage(`${I}/roll-result`,k=>{var x;const d=k.data;(d==null?void 0:d.rollId)===n&&(m(),a(Number(((x=d==null?void 0:d.result)==null?void 0:x.totalValue)??0)))}),l=c.broadcast.onMessage(`${I}/roll-error`,k=>{const d=k.data;(d==null?void 0:d.rollId)===n&&(m(),i(new Error((d==null?void 0:d.error)||"Dice+ roll failed")))}),m=()=>{u(),l()};await c.broadcast.sendMessage(F,{rollId:n,playerId:await c.player.getId(),playerName:await c.player.getName(),rollTarget:e.rollTarget??"everyone",diceNotation:e.diceNotation,showResults:e.showResults??!0,timestamp:Date.now(),source:I},{destination:"ALL"}),setTimeout(()=>{m(),i(new Error("Dice+ roll timed out (no roll-result received)"))},s)})}const Z=[{id:"athletics",label:"Athletics",attribute:"phys"},{id:"cybernetics",label:"Cybernetics",attribute:"phys"},{id:"powerlift",label:"Powerlift",attribute:"phys"},{id:"endurance",label:"Endurance",attribute:"phys"},{id:"toughness",label:"Toughness",attribute:"phys"},{id:"balance",label:"Balance",attribute:"ref"},{id:"evade",label:"Evade",attribute:"ref"},{id:"finesse",label:"Finesse",attribute:"ref"},{id:"instinct",label:"Instinct",attribute:"ref"},{id:"stealth",label:"Stealth",attribute:"ref"},{id:"subterfuge",label:"Subterfuge",attribute:"soc"},{id:"bearing",label:"Bearing",attribute:"soc"},{id:"negotiate",label:"Negotiate",attribute:"soc"},{id:"persuade",label:"Persuade",attribute:"soc"},{id:"streetwise",label:"Streetwise",attribute:"soc"},{id:"composure",label:"Composure",attribute:"ment"},{id:"psychology",label:"Psychology",attribute:"ment"},{id:"observe",label:"Observe",attribute:"ment"},{id:"recall",label:"Recall",attribute:"ment"},{id:"willpower",label:"Willpower",attribute:"ment"}],ee={combat:[{id:"melee_weapons",label:"Melee (weapons)",attribute:"phys"},{id:"melee_unarmed",label:"Melee (unarmed)",attribute:"phys"},{id:"weapons_light",label:"Weapons (light)",attribute:"ref"},{id:"weapons_medium",label:"Weapons (medium)",attribute:"ref"},{id:"weapons_heavy",label:"Weapons (heavy)",attribute:"phys"},{id:"weapons_exotic",label:"Weapons (exotic)",attribute:"ment"},{id:"power_armour",label:"Power Armour",attribute:"phys"},{id:"explosives",label:"Explosives",attribute:"ment"},{id:"tactics",label:"Tactics",attribute:"ment"}],education:[{id:"material_sciences",label:"Material Sciences",attribute:"ment"},{id:"computers",label:"Computers",attribute:"ment"},{id:"cryptology",label:"Cryptology",attribute:"ment"},{id:"electronics",label:"Electronics",attribute:"ment"},{id:"engineering",label:"Engineering",attribute:"ment"},{id:"first_aid",label:"First Aid",attribute:"ment"},{id:"forgery",label:"Forgery",attribute:"soc"},{id:"history",label:"History",attribute:"ment"},{id:"linguistics",label:"Linguistics",attribute:"ment"},{id:"research",label:"Research",attribute:"ment"},{id:"natural_sciences",label:"Natural Sciences",attribute:"ment"}],vehicles:[{id:"gunnery",label:"Gunnery",attribute:"ref"},{id:"navigation",label:"Navigation",attribute:"ment"},{id:"piloting",label:"Piloting",attribute:"ref"},{id:"remote_operation",label:"Remote Operation",attribute:"ment"},{id:"sensors",label:"Sensors",attribute:"ment"},{id:"systems_interface",label:"Systems Interface",attribute:"ment"}]},te={inherent:Z,learned:ee},ne=te,$="whisperspace.obr.sheet/initiativeTracker",ae="whisperspace.obr.sheet/initActive",K=()=>({entries:[],updatedAt:Date.now()});function y(e){return[...e].sort((t,n)=>n.initiative!==t.initiative?n.initiative-t.initiative:(n.updatedAt??0)-(t.updatedAt??0))}async function p(){const e=await c.scene.getMetadata(),t=e==null?void 0:e[$];if(!t||typeof t!="object")return K();const s=(Array.isArray(t.entries)?t.entries:[]).filter(i=>i&&typeof i.tokenId=="string").map(i=>({tokenId:String(i.tokenId),name:typeof i.name=="string"?i.name:"Unnamed",thumbUrl:typeof i.thumbUrl=="string"?i.thumbUrl:void 0,initiative:Number.isFinite(i.initiative)?Math.trunc(i.initiative):0,surprised:typeof i.surprised=="boolean"?i.surprised:!1,updatedAt:Number.isFinite(i.updatedAt)?Math.trunc(i.updatedAt):0})),a={entries:y(s),activeTokenId:typeof t.activeTokenId=="string"?t.activeTokenId:void 0,updatedAt:Number.isFinite(t.updatedAt)?Math.trunc(t.updatedAt):Date.now()};return a.entries.length>0&&(!a.activeTokenId||!a.entries.some(i=>i.tokenId===a.activeTokenId))&&(a.activeTokenId=a.entries[0].tokenId),a}async function h(e){await c.scene.setMetadata({[$]:e})}async function w(e,t=[]){if(!t.length)return;const n=Array.from(new Set(t));try{await c.scene.items.updateItems(n,s=>{for(const a of s){const i={...a.metadata??{}};i[ae]=e?a.id===e:!1,a.metadata=i}})}catch{}}async function Ie(e){const t=await p(),n=e.updatedAt??Date.now(),s=t.entries.filter(u=>u.tokenId!==e.tokenId);s.push({tokenId:e.tokenId,name:e.name,thumbUrl:e.thumbUrl,initiative:Math.trunc(e.initiative),updatedAt:n});const a=y(s),i={entries:a,activeTokenId:t.activeTokenId,updatedAt:Date.now()};return a.length>0&&(!i.activeTokenId||!a.some(u=>u.tokenId===i.activeTokenId))&&(i.activeTokenId=a[0].tokenId),await h(i),await w(i.activeTokenId,a.map(u=>u.tokenId)),i}async function we(){const e=K();await h(e)}async function ie(e){const t=await p(),n=(t.entries??[]).filter(i=>i.tokenId!==e);let s=t.activeTokenId;if(s===e){const i=y(n);s=i.length?i[0].tokenId:void 0}const a={entries:n,activeTokenId:s,updatedAt:Date.now()};return await h(a),await w(a.activeTokenId,n.map(i=>i.tokenId)),a}const ke=ie;async function Te(e,t){const n=await p(),s=(n.entries??[]).map(i=>i.tokenId===e?{...i,surprised:!!t}:i),a={entries:y(s),activeTokenId:n.activeTokenId,updatedAt:Date.now()};return await h(a),await w(a.activeTokenId,s.map(i=>i.tokenId)),a}async function _e(){const e=await p(),t=y(e.entries);if(t.length===0)return e;const n=e.activeTokenId?t.findIndex(l=>l.tokenId===e.activeTokenId):-1,s=n>=0?(n+1)%t.length:0,i=n>=0&&s===0?t.map(l=>({...l,surprised:!1})):t,u={entries:i,activeTokenId:i[s].tokenId,updatedAt:Date.now()};return await h(u),await w(u.activeTokenId,i.map(l=>l.tokenId)),u}function Ee(e){const t=c.scene.onMetadataChange(()=>{p().then(e)});return p().then(e),t}function Me(e){const t=ne.inherent??[],n={phys:0,ref:0,soc:0,ment:0};for(const s of t){const a=Number((e==null?void 0:e[s.id])??0),i=s.attribute;i&&i in n&&(n[i]+=Math.max(0,a))}return{phys:Math.max(0,Math.ceil(n.phys/4)),ref:Math.max(0,Math.ceil(n.ref/4)),soc:Math.max(0,Math.ceil(n.soc/4)),ment:Math.max(0,Math.ceil(n.ment/4))}}function Se(e){const n=["instinct","willpower","bearing","toughness","tactics"].reduce((s,a)=>s+Math.max(0,Math.trunc(Number(e[a]??0))),0);return 1+Math.ceil(n/5)}function se(e){const t={};if(!e)return t;const n=e.split(",").map(s=>s.trim()).filter(Boolean);for(const s of n){const a=s.match(/^([a-zA-Z0-9_\-]+)\s*[:]?\s*([+\-])\s*(\d+)$/);if(!a)continue;const i=String(a[1]).toLowerCase().replace(/\s+/g,"_"),u=a[2]==="-"?-1:1,l=Math.trunc(Number(a[3]));Number.isFinite(l)&&(t[i]=(t[i]??0)+u*l)}return t}function oe(e){const t={};for(const n of e){const s=se(n??"");for(const[a,i]of Object.entries(s))t[a]=(t[a]??0)+i}return t}function Ae(e){return{deltas:oe(e)}}function xe(e,t){const n={...e},s=(a,i)=>{!Number.isFinite(i)||i===0||(n[a]=(Number(n[a])||0)+i)};s("phys",t.phys??0),s("ref",t.ref??0),s("soc",t.soc??0),s("ment",t.ment??0),s("coolUnderFire",t.cool_under_fire??0),s("speed",t.speed??0),s("carryingCapacity",t.carrying_capacity??0);for(const[a,i]of Object.entries(t))a==="phys"||a==="ref"||a==="soc"||a==="ment"||a==="cool_under_fire"||a==="speed"||a==="carrying_capacity"||typeof n[a]=="number"&&(n[a]=n[a]+i);return n}export{ie as A,ue as B,I as D,W as F,S as M,T as P,C as T,ve as a,he as b,X as c,we as d,_e as e,Te as f,ke as g,le as h,Ae as i,Se as j,J as k,G as l,Me as m,xe as n,Ee as o,de as p,oe as q,ge as r,ne as s,fe as t,Ie as u,pe as v,me as w,ye as x,be as y,p as z};
